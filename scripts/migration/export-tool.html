<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>HRM2 Data Export Tool</title>
  <style>
    body { font-family: system-ui, sans-serif; max-width: 800px; margin: 50px auto; padding: 20px; }
    h1 { color: #333; }
    button { background: #4F46E5; color: white; padding: 12px 24px; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; margin: 10px 5px 10px 0; }
    button:hover { background: #4338CA; }
    button:disabled { background: #9CA3AF; cursor: not-allowed; }
    pre { background: #F3F4F6; padding: 15px; border-radius: 8px; overflow-x: auto; max-height: 400px; }
    .success { color: #059669; }
    .error { color: #DC2626; }
    .warning { color: #D97706; }
    #log { white-space: pre-wrap; font-family: monospace; }
  </style>
</head>
<body>
  <h1>üöÄ HRM2 Data Export Tool</h1>
  <p>C√¥ng c·ª• export to√†n b·ªô localStorage data t·ª´ HRM2 sang file JSON.</p>
  
  <div>
    <button id="scanBtn" onclick="scanStorage()">1. Scan localStorage</button>
    <button id="exportBtn" onclick="exportData()" disabled>2. Export to JSON</button>
  </div>
  
  <h3>üìã Log:</h3>
  <pre id="log"></pre>

  <script>
    const logEl = document.getElementById('log');
    const exportBtn = document.getElementById('exportBtn');
    let scannedData = null;

    function log(msg, type = '') {
      const span = document.createElement('span');
      span.className = type;
      span.textContent = msg + '\n';
      logEl.appendChild(span);
      logEl.scrollTop = logEl.scrollHeight;
    }

    function scanStorage() {
      logEl.innerHTML = '';
      log('üîç Scanning localStorage...');
      
      const storeKeys = [
        'employees-storage', 'customers-storage', 'products-storage', 'orders-storage',
        'attendance-storage', 'leaves-storage', 'cashbook-storage', 'payments-storage',
        'receipts-storage', 'stock-locations-storage', 'stock-transfers-storage',
        'stock-history-storage', 'inventory-checks-storage', 'inventory-receipts-storage',
        'cost-adjustments-storage', 'suppliers-storage', 'purchase-orders-storage',
        'purchase-returns-storage', 'sales-returns-storage', 'shipments-storage',
        'tasks-storage', 'complaints-storage', 'warranty-storage', 'warranty-types-storage',
        'wiki-storage', 'audit-log-storage', 'branches-storage', 'departments-storage',
        'job-titles-storage', 'payment-methods-storage', 'payment-types-storage',
        'receipt-types-storage', 'taxes-storage', 'units-storage', 'pricing-storage',
        'shipping-settings-storage', 'printer-settings-storage', 'appearance-storage',
        'provinces-storage', 'sales-channels-storage', 'target-groups-storage',
        'penalties-storage', 'pkgx-storage', 'trendtech-storage', 'store-info-storage',
        'categories-storage', 'brands-storage', 'customer-sla-storage'
      ];

      scannedData = {};
      let foundCount = 0;
      let totalRecords = 0;

      storeKeys.forEach(key => {
        const data = localStorage.getItem(key);
        if (data) {
          try {
            const parsed = JSON.parse(data);
            scannedData[key] = parsed;
            foundCount++;
            
            if (parsed.state?.data && Array.isArray(parsed.state.data)) {
              totalRecords += parsed.state.data.length;
              log(`‚úÖ ${key}: ${parsed.state.data.length} records`, 'success');
            } else if (Array.isArray(parsed)) {
              totalRecords += parsed.length;
              log(`‚úÖ ${key}: ${parsed.length} records`, 'success');
            } else {
              log(`‚úÖ ${key}: found (object)`, 'success');
            }
          } catch (e) {
            log(`‚ùå Error parsing ${key}: ${e.message}`, 'error');
          }
        }
      });

      // Check for additional storage keys
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (!storeKeys.includes(key) && key.includes('storage')) {
          try {
            scannedData[key] = JSON.parse(localStorage.getItem(key));
            log(`üì¶ Additional: ${key}`, 'warning');
            foundCount++;
          } catch (e) {}
        }
      }

      log('');
      log(`üìä Summary: Found ${foundCount} stores with ~${totalRecords} total records`);
      
      if (foundCount > 0) {
        exportBtn.disabled = false;
        log('');
        log('üëÜ Click "Export to JSON" to download the data.', 'success');
      } else {
        log('');
        log('‚ö†Ô∏è No data found! Make sure you have used HRM2 and have data in localStorage.', 'warning');
      }
    }

    function exportData() {
      if (!scannedData) {
        log('‚ùå Please scan first!', 'error');
        return;
      }

      const blob = new Blob([JSON.stringify(scannedData, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `hrm2-data-export-${new Date().toISOString().split('T')[0]}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      log('');
      log('‚úÖ Export completed! Check your Downloads folder.', 'success');
      log(`üìÅ File: hrm2-data-export-${new Date().toISOString().split('T')[0]}.json`);
      log('');
      log('üìå Next step: Move the file to D:\\hrm2\\data-export\\');
    }
  </script>
</body>
</html>
