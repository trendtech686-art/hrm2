/**
 * Audit: List all Template variables not in Mapper
 * Output: Per-mapper list of missing variables that need to be added
 */

const fs = require('fs');
const path = require('path');

const MAPPERS_DIR = path.join(__dirname, '../lib/print-mappers');
const TEMPLATES_DIR = path.join(__dirname, '../features/settings/printer/templates');

const MAPPING = {
  'purchase-order.ts': 'purchase-order.mapper.ts',
  'stock-in.ts': 'stock-in.mapper.ts',
  'stock-transfer.ts': 'stock-transfer.mapper.ts',
  'inventory-check.ts': 'inventory-check.mapper.ts',
  'receipt.ts': 'receipt.mapper.ts',
  'payment.ts': 'payment.mapper.ts',
  'warranty.ts': 'warranty.mapper.ts',
  'supplier-return.ts': 'supplier-return.mapper.ts',
  'packing.ts': 'packing.mapper.ts',
  'refund-confirmation.ts': 'refund-confirmation.mapper.ts',
  'sales-summary.ts': 'sales-summary.mapper.ts',
  'packing-guide.ts': 'packing-guide.mapper.ts',
  'packing-request.ts': 'packing-request.mapper.ts',
  'warranty-request.ts': 'warranty-request.mapper.ts',
  'return-order.ts': 'return-order.mapper.ts',
};

// Store variables (auto-included via getStoreData)
const AUTO_VARS = new Set([
  '{store_logo}', '{store_name}', '{store_address}', '{store_phone_number}',
  '{hotline}', '{store_hotline}', '{store_email}', '{store_fax}',
  '{store_website}', '{store_tax_code}', '{print_date}', '{print_time}',
  '{line_stt}', // auto-generated by line item processing
]);

function extractPlaceholders(content) {
  const regex = /\{[a-z_:()0-9]+\}/gi;
  const matches = content.match(regex) || [];
  return [...new Set(matches)].sort();
}

function extractMapperKeys(content) {
  const regex = /'\{[^}]+\}':/g;
  const matches = content.match(regex) || [];
  return new Set(matches.map(m => m.slice(0, -1).replace(/'/g, '')));
}

console.log('='.repeat(80));
console.log('MAPPER UPDATE NEEDED - Templates â†’ Mappers');
console.log('='.repeat(80));

for (const [templateFile, mapperFile] of Object.entries(MAPPING)) {
  const templatePath = path.join(TEMPLATES_DIR, templateFile);
  const mapperPath = path.join(MAPPERS_DIR, mapperFile);
  
  if (!fs.existsSync(templatePath) || !fs.existsSync(mapperPath)) continue;
  
  const templateContent = fs.readFileSync(templatePath, 'utf-8');
  const mapperContent = fs.readFileSync(mapperPath, 'utf-8');
  
  const templateKeys = extractPlaceholders(templateContent);
  const mapperKeys = extractMapperKeys(mapperContent);
  
  // Find missing (in template but not in mapper, excluding auto vars)
  const missing = templateKeys.filter(k => !mapperKeys.has(k) && !AUTO_VARS.has(k));
  
  if (missing.length > 0) {
    console.log(`\nðŸ“„ ${mapperFile}`);
    console.log(`   Missing ${missing.length} variables:`);
    missing.forEach(v => console.log(`   - ${v}`));
  }
}

console.log('\n' + '='.repeat(80));
