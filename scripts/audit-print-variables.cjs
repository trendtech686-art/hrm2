/**
 * Audit Print Variables vs Mappers vs Templates
 * 
 * Script n√†y ki·ªÉm tra s·ª± ƒë·ªìng b·ªô gi·ªØa 3 layer:
 * 1. Variables (ƒë·ªãnh nghƒ©a placeholders)
 * 2. Mappers (generate PrintData)
 * 3. Templates (HTML s·ª≠ d·ª•ng placeholders)
 */

const fs = require('fs');
const path = require('path');

// Paths
const VARIABLES_DIR = path.join(__dirname, '../features/settings/printer/variables');
const MAPPERS_DIR = path.join(__dirname, '../lib/print-mappers');
const TEMPLATES_DIR = path.join(__dirname, '../features/settings/printer/templates');

// Template type mapping
const TEMPLATE_MAPPING = {
  'order': { variable: 'don-ban-hang.ts', mapper: 'order.mapper.ts', template: 'order.ts' },
  'quote': { variable: 'phieu-don-tam-tinh.ts', mapper: 'quote.mapper.ts', template: 'quote.ts' },
  'sales-return': { variable: 'don-doi-tra-hang.ts', mapper: 'sales-return.mapper.ts', template: 'sales-return.ts' },
  'packing': { variable: 'phieu-dong-goi.ts', mapper: 'packing.mapper.ts', template: 'packing.ts' },
  'delivery': { variable: 'phieu-giao-hang.ts', mapper: 'delivery.mapper.ts', template: 'delivery.ts' },
  'shipping-label': { variable: 'nhan-giao-hang.ts', mapper: 'shipping-label.mapper.ts', template: 'shipping-label.ts' },
  'product-label': { variable: 'tem-phu-san-pham.ts', mapper: 'product-label.mapper.ts', template: 'product-label.ts' },
  'purchase-order': { variable: 'don-dat-hang-nhap.ts', mapper: 'purchase-order.mapper.ts', template: 'purchase-order.ts' },
  'stock-in': { variable: 'phieu-nhap-kho.ts', mapper: 'stock-in.mapper.ts', template: 'stock-in.ts' },
  'stock-transfer': { variable: 'phieu-chuyen-hang.ts', mapper: 'stock-transfer.mapper.ts', template: 'stock-transfer.ts' },
  'inventory-check': { variable: 'phieu-kiem-hang.ts', mapper: 'inventory-check.mapper.ts', template: 'inventory-check.ts' },
  'receipt': { variable: 'phieu-thu.ts', mapper: 'receipt.mapper.ts', template: 'receipt.ts' },
  'payment': { variable: 'phieu-chi.ts', mapper: 'payment.mapper.ts', template: 'payment.ts' },
  'warranty': { variable: 'phieu-bao-hanh.ts', mapper: 'warranty.mapper.ts', template: 'warranty.ts' },
  'supplier-return': { variable: 'phieu-tra-hang-ncc.ts', mapper: 'supplier-return.mapper.ts', template: 'supplier-return.ts' },
  'complaint': { variable: 'phieu-khieu-nai.ts', mapper: 'complaint.mapper.ts', template: 'complaint.ts' },
  'penalty': { variable: 'phieu-phat.ts', mapper: 'penalty.mapper.ts', template: 'penalty.ts' },
  'handover': { variable: 'phieu-ban-giao.ts', mapper: 'handover.mapper.ts', template: 'handover.ts' },
  'refund-confirmation': { variable: 'phieu-xac-nhan-hoan.ts', mapper: 'refund-confirmation.mapper.ts', template: 'refund-confirmation.ts' },
  'sales-summary': { variable: 'phieu-tong-ket-ban-hang.ts', mapper: 'sales-summary.mapper.ts', template: 'sales-summary.ts' },
  'packing-guide': { variable: 'phieu-huong-dan-dong-goi.ts', mapper: 'packing-guide.mapper.ts', template: 'packing-guide.ts' },
  'packing-request': { variable: 'phieu-yeu-cau-dong-goi.ts', mapper: 'packing-request.mapper.ts', template: 'packing-request.ts' },
  'warranty-request': { variable: 'phieu-yeu-cau-bao-hanh.ts', mapper: 'warranty-request.mapper.ts', template: 'warranty-request.ts' },
  'return-order': { variable: 'don-tra-hang.ts', mapper: 'return-order.mapper.ts', template: 'return-order.ts' },
};

// Extract placeholders from file content
function extractPlaceholders(content) {
  const regex = /\{[a-z_:()0-9]+\}/gi;
  const matches = content.match(regex) || [];
  return [...new Set(matches)].sort();
}

// Extract variable keys from variables file
function extractVariableKeys(content) {
  const regex = /key:\s*['"](\{[^}]+\})['"]/g;
  const keys = [];
  let match;
  while ((match = regex.exec(content)) !== null) {
    keys.push(match[1]);
  }
  return [...new Set(keys)].sort();
}

// Extract mapper keys from mapper file
function extractMapperKeys(content) {
  const regex = /'\{[^}]+\}':/g;
  const matches = content.match(regex) || [];
  const keys = [...new Set(matches.map(m => m.slice(0, -1).replace(/'/g, '')))];
  
  // Check if mapper uses getStoreData - if so, add store keys
  if (content.includes('...getStoreData(')) {
    const storeKeys = [
      '{store_logo}',
      '{store_name}',
      '{store_address}',
      '{store_phone_number}',
      '{hotline}',
      '{store_hotline}',
      '{store_email}',
      '{store_fax}',
      '{store_website}',
      '{store_tax_code}',
      '{print_date}',
      '{print_time}',
    ];
    storeKeys.forEach(k => {
      if (!keys.includes(k)) keys.push(k);
    });
  }
  
  // line_stt is auto-generated by generateLineItemsHtml or in line item mappers
  if (!keys.includes('{line_stt}')) {
    keys.push('{line_stt}');
  }
  
  return keys.sort();
}

// Read file safely
function readFileSafe(filePath) {
  try {
    return fs.readFileSync(filePath, 'utf-8');
  } catch (e) {
    return null;
  }
}

// Main audit function
function auditTemplateType(type, mapping) {
  const result = {
    type,
    variableFile: mapping.variable,
    mapperFile: mapping.mapper,
    templateFile: mapping.template,
    variableKeys: [],
    mapperKeys: [],
    templateKeys: [],
    issues: []
  };

  // Read files
  const variableContent = readFileSafe(path.join(VARIABLES_DIR, mapping.variable));
  const mapperContent = readFileSafe(path.join(MAPPERS_DIR, mapping.mapper));
  const templateContent = readFileSafe(path.join(TEMPLATES_DIR, mapping.template));

  // Extract keys
  if (variableContent) {
    result.variableKeys = extractVariableKeys(variableContent);
  } else {
    result.issues.push(`‚ùå Variable file not found: ${mapping.variable}`);
  }

  if (mapperContent) {
    result.mapperKeys = extractMapperKeys(mapperContent);
  } else {
    result.issues.push(`‚ùå Mapper file not found: ${mapping.mapper}`);
  }

  if (templateContent) {
    result.templateKeys = extractPlaceholders(templateContent);
  } else {
    result.issues.push(`‚ùå Template file not found: ${mapping.template}`);
  }

  // Compare: Variables vs Mapper
  if (result.variableKeys.length && result.mapperKeys.length) {
    const inVarNotMapper = result.variableKeys.filter(k => !result.mapperKeys.includes(k));
    const inMapperNotVar = result.mapperKeys.filter(k => !result.variableKeys.includes(k));
    
    if (inVarNotMapper.length) {
      result.issues.push(`‚ö†Ô∏è  In Variables but NOT in Mapper (${inVarNotMapper.length}): ${inVarNotMapper.slice(0, 5).join(', ')}${inVarNotMapper.length > 5 ? '...' : ''}`);
    }
    if (inMapperNotVar.length) {
      result.issues.push(`‚ö†Ô∏è  In Mapper but NOT in Variables (${inMapperNotVar.length}): ${inMapperNotVar.slice(0, 5).join(', ')}${inMapperNotVar.length > 5 ? '...' : ''}`);
    }
  }

  // Compare: Template vs Variables
  if (result.templateKeys.length && result.variableKeys.length) {
    const inTemplateNotVar = result.templateKeys.filter(k => !result.variableKeys.includes(k));
    
    if (inTemplateNotVar.length) {
      result.issues.push(`üî¥ In Template but NOT in Variables (${inTemplateNotVar.length}): ${inTemplateNotVar.join(', ')}`);
    }
  }

  // Compare: Template vs Mapper
  if (result.templateKeys.length && result.mapperKeys.length) {
    const inTemplateNotMapper = result.templateKeys.filter(k => !result.mapperKeys.includes(k));
    
    if (inTemplateNotMapper.length) {
      result.issues.push(`üî¥ In Template but NOT in Mapper (${inTemplateNotMapper.length}): ${inTemplateNotMapper.join(', ')}`);
    }
  }

  return result;
}

// Run audit
console.log('='.repeat(80));
console.log('PRINT SYSTEM AUDIT - Variables vs Mappers vs Templates');
console.log('='.repeat(80));
console.log('');

let totalIssues = 0;
const results = [];

for (const [type, mapping] of Object.entries(TEMPLATE_MAPPING)) {
  const result = auditTemplateType(type, mapping);
  results.push(result);
  
  if (result.issues.length > 0) {
    console.log(`\nüìÑ ${type.toUpperCase()}`);
    console.log(`   Variables: ${result.variableKeys.length} keys | Mapper: ${result.mapperKeys.length} keys | Template: ${result.templateKeys.length} keys`);
    result.issues.forEach(issue => console.log(`   ${issue}`));
    totalIssues += result.issues.length;
  }
}

// Summary
console.log('\n' + '='.repeat(80));
console.log('SUMMARY');
console.log('='.repeat(80));
console.log(`Total template types: ${Object.keys(TEMPLATE_MAPPING).length}`);
console.log(`Template types with issues: ${results.filter(r => r.issues.length > 0).length}`);
console.log(`Total issues found: ${totalIssues}`);

// Detailed stats
const okTypes = results.filter(r => r.issues.length === 0);
if (okTypes.length > 0) {
  console.log(`\n‚úÖ Template types OK (${okTypes.length}): ${okTypes.map(r => r.type).join(', ')}`);
}

const criticalTypes = results.filter(r => r.issues.some(i => i.includes('üî¥')));
if (criticalTypes.length > 0) {
  console.log(`\nüî¥ Template types with CRITICAL issues (template using undefined vars): ${criticalTypes.map(r => r.type).join(', ')}`);
}

console.log('\n' + '='.repeat(80));
console.log('Legend:');
console.log('  üî¥ CRITICAL: Template uses placeholder not defined anywhere');
console.log('  ‚ö†Ô∏è  WARNING: Mismatch between Variables and Mapper definitions');
console.log('  ‚ùå ERROR: File not found');
console.log('='.repeat(80));
