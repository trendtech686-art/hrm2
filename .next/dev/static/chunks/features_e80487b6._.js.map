{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/attendance/store.ts"],"sourcesContent":["import { create } from 'zustand';\r\nimport type { AttendanceDataRow, AttendanceDayKey, DailyRecord } from './types';\r\nimport type { SystemId } from '../../lib/id-types';\r\n\r\n// API sync helper\r\nasync function syncToAPI(action: 'save' | 'lock' | 'unlock', data: any): Promise<boolean> {\r\n  try {\r\n    const endpoint = '/api/attendance';\r\n    const method = action === 'save' ? 'POST' : 'PATCH';\r\n    \r\n    const response = await fetch(endpoint, {\r\n      method,\r\n      headers: { 'Content-Type': 'application/json' },\r\n      body: JSON.stringify({ action, ...data }),\r\n    });\r\n    \r\n    if (!response.ok) {\r\n      console.error(`[Attendance API] ${action} failed:`, await response.text());\r\n      return false;\r\n    }\r\n    return true;\r\n  } catch (error) {\r\n    console.error(`[Attendance API] ${action} error:`, error);\r\n    return false;\r\n  }\r\n}\r\n\r\nasync function fetchFromAPI(monthKey: string): Promise<AttendanceDataRow[] | null> {\r\n  try {\r\n    const [year, month] = monthKey.split('-');\r\n    const fromDate = `${year}-${month}-01`;\r\n    const lastDay = new Date(parseInt(year), parseInt(month), 0).getDate();\r\n    const toDate = `${year}-${month}-${lastDay}`;\r\n    \r\n    // Attendance is filtered by month, so 500 records should cover most cases\r\n    const response = await fetch(`/api/attendance?fromDate=${fromDate}&toDate=${toDate}&limit=500`);\r\n    if (!response.ok) return null;\r\n    \r\n    const json = await response.json();\r\n    return json.data || null;\r\n  } catch (error) {\r\n    console.error('[Attendance API] fetch error:', error);\r\n    return null;\r\n  }\r\n}\r\n\r\ntype AttendanceStoreState = {\r\n  lockedMonths: Record<string, boolean>; // key: \"YYYY-MM\"\r\n  toggleLock: (monthYear: string) => void;\r\n  lockMonth: (monthYear: string) => void;\r\n  unlockMonth: (monthYear: string) => void;\r\n  \r\n  // Data storage\r\n  attendanceData: Record<string, AttendanceDataRow[]>; // key: \"YYYY-MM\"\r\n  saveAttendanceData: (monthKey: string, data: AttendanceDataRow[]) => void;\r\n  getAttendanceData: (monthKey: string) => AttendanceDataRow[] | null;\r\n  updateEmployeeRecord: (\r\n    monthKey: string,\r\n    employeeSystemId: SystemId,\r\n    dayKey: AttendanceDayKey,\r\n    record: DailyRecord\r\n  ) => void;\r\n  \r\n  // API sync\r\n  loadFromAPI: (monthKey: string) => Promise<void>;\r\n  initialized: boolean;\r\n};\r\n\r\nexport const useAttendanceStore = create<AttendanceStoreState>()(\r\n  (set, get) => ({\r\n      lockedMonths: {},\r\n      initialized: false,\r\n      \r\n      lockMonth: (monthYear) => {\r\n        set((state) => ({\r\n          lockedMonths: {\r\n            ...state.lockedMonths,\r\n            [monthYear]: true,\r\n          },\r\n        }));\r\n        // Sync to API\r\n        syncToAPI('lock', { monthYear }).catch(console.error);\r\n      },\r\n      unlockMonth: (monthYear) => {\r\n        set((state) => {\r\n          if (!state.lockedMonths[monthYear]) {\r\n            return state;\r\n          }\r\n          const nextLocked = { ...state.lockedMonths };\r\n          delete nextLocked[monthYear];\r\n          return { lockedMonths: nextLocked };\r\n        });\r\n        // Sync to API\r\n        syncToAPI('unlock', { monthYear }).catch(console.error);\r\n      },\r\n      toggleLock: (monthYear) => {\r\n        const isLocked = Boolean(get().lockedMonths[monthYear]);\r\n        if (isLocked) {\r\n          get().unlockMonth(monthYear);\r\n        } else {\r\n          get().lockMonth(monthYear);\r\n        }\r\n      },\r\n      \r\n      // Data management\r\n      attendanceData: {},\r\n      saveAttendanceData: (monthKey, data) => {\r\n        set((state) => ({\r\n          attendanceData: {\r\n            ...state.attendanceData,\r\n            [monthKey]: data,\r\n          },\r\n        }));\r\n        // Sync to API\r\n        syncToAPI('save', { monthKey, data }).catch(console.error);\r\n      },\r\n      getAttendanceData: (monthKey) => {\r\n        return get().attendanceData[monthKey] || null;\r\n      },\r\n      updateEmployeeRecord: (monthKey, employeeSystemId, dayKey, record) => {\r\n        set((state) => {\r\n          const monthData = state.attendanceData[monthKey];\r\n          if (!monthData) return state;\r\n          \r\n          const updatedData = monthData.map(emp => {\r\n            if (emp.employeeSystemId === employeeSystemId) {\r\n              return { ...emp, [dayKey]: record };\r\n            }\r\n            return emp;\r\n          });\r\n          \r\n          return {\r\n            attendanceData: {\r\n              ...state.attendanceData,\r\n              [monthKey]: updatedData,\r\n            },\r\n          };\r\n        });\r\n        // Sync single record to API\r\n        syncToAPI('save', { monthKey, employeeSystemId, dayKey, record }).catch(console.error);\r\n      },\r\n      \r\n      // Load from API\r\n      loadFromAPI: async (monthKey: string) => {\r\n        const apiData = await fetchFromAPI(monthKey);\r\n        if (apiData && apiData.length > 0) {\r\n          set((state) => ({\r\n            attendanceData: {\r\n              ...state.attendanceData,\r\n              [monthKey]: apiData,\r\n            },\r\n            initialized: true,\r\n          }));\r\n        }\r\n      },\r\n    })\r\n);\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 159, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/attendance/utils.ts"],"sourcesContent":["import { formatDate, formatDateTime, formatDateTimeSeconds, formatDateCustom, parseDate, getCurrentDate, toISODate, isValidDate, isDateAfter, getStartOfDay, getEndOfDay, getDayOfWeek } from '../../lib/date-utils';\r\nimport type { AttendanceDataRow, DailyRecord, AnyAttendanceDataRow } from './types';\r\nimport type { EmployeeSettings } from '../settings/employees/types';\r\nimport type { Employee } from '../employees/types';\r\nimport type { SystemId, BusinessId } from '../../lib/id-types';\r\n\r\n/**\r\n * Initialize empty attendance data for employees\r\n * Creates attendance rows with default status (weekend/absent) based on working days\r\n * NO mock data - just empty structure ready for real data input\r\n */\r\nexport function initializeEmptyAttendance(\r\n  employees: Employee[],\r\n  year: number,\r\n  month: number,\r\n  settings: EmployeeSettings\r\n): AttendanceDataRow[] {\r\n  const daysInMonth = new Date(year, month, 0).getDate();\r\n  \r\n  return employees.map((emp) => {\r\n    const row: AnyAttendanceDataRow = {\r\n      systemId: emp.systemId,\r\n      employeeSystemId: emp.systemId,\r\n      employeeId: emp.id,\r\n      fullName: emp.fullName,\r\n      department: emp.department,\r\n      workDays: 0,\r\n      leaveDays: 0,\r\n      absentDays: 0,\r\n      lateArrivals: 0,\r\n      earlyDepartures: 0,\r\n      otHours: 0,\r\n      otHoursWeekday: 0,\r\n      otHoursWeekend: 0,\r\n      otHoursHoliday: 0,\r\n    };\r\n\r\n    // Initialize each day with default status\r\n    for (let d = 1; d <= daysInMonth; d++) {\r\n      const workDate = new Date(year, month - 1, d);\r\n      const dayOfWeek = getDayOfWeek(workDate);\r\n      const isWorkingDay = dayOfWeek !== null && settings.workingDays.includes(dayOfWeek);\r\n      \r\n      row[`day_${d}`] = {\r\n        status: isWorkingDay ? 'absent' : 'weekend',\r\n      };\r\n    }\r\n\r\n    return row as AttendanceDataRow;\r\n  });\r\n}\r\n\r\n// Function to convert Excel serial time number to HH:mm format\r\nexport function excelSerialToTime(serial: any): string {\r\n    if (typeof serial === 'string') {\r\n        // If it's already a time string, just ensure format\r\n        const parts = serial.split(':');\r\n        if (parts.length >= 2) {\r\n            return `${parts[0].padStart(2, '0')}:${parts[1].padStart(2, '0')}`;\r\n        }\r\n        return '';\r\n    }\r\n    if (typeof serial !== 'number' || serial < 0 || serial > 1) {\r\n        // It might be a Date object from cellDates:true\r\n        if (serial instanceof Date) {\r\n            // Use local time (getHours/getMinutes) for Vietnam timezone GMT+7\r\n            const hours = serial.getHours();\r\n            const minutes = serial.getMinutes();\r\n            return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;\r\n        }\r\n        return ''; // Invalid time serial\r\n    }\r\n    const totalSeconds = Math.round(serial * 86400);\r\n    const hours = Math.floor(totalSeconds / 3600);\r\n    const minutes = Math.floor((totalSeconds % 3600) / 60);\r\n    return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;\r\n}\r\n\r\n\r\nexport function recalculateSummary(\r\n    row: AnyAttendanceDataRow, \r\n    year: number, \r\n    month: number, \r\n    settings: EmployeeSettings\r\n): Pick<AttendanceDataRow, 'workDays' | 'leaveDays' | 'absentDays' | 'lateArrivals' | 'earlyDepartures' | 'otHours' | 'otHoursWeekday' | 'otHoursWeekend' | 'otHoursHoliday'> {\r\n    let totalWorkMinutes = 0; // Tổng phút làm việc trong giờ hành chính (8:30-18:00)\r\n    let leaveDays = 0;\r\n    let absentDays = 0;\r\n    let lateArrivals = 0;\r\n    let earlyDepartures = 0;\r\n    \r\n    // OT theo loại ngày\r\n    let otMinutesWeekday = 0;  // Làm thêm ngày thường (sau 18h)\r\n    let otMinutesWeekend = 0;  // Làm thêm cuối tuần\r\n    let otMinutesHoliday = 0;  // Làm thêm ngày lễ\r\n    \r\n    const daysInMonth = new Date(year, month, 0).getDate();\r\n    \r\n    // Tính số giờ làm việc tiêu chuẩn 1 ngày (trừ nghỉ trưa)\r\n    // VD: 8:30-18:00 = 9.5h, trừ nghỉ trưa 1.5h = 8h\r\n    const workStartParts = settings.workStartTime.split(':').map(Number);\r\n    const workEndParts = settings.workEndTime.split(':').map(Number);\r\n    const workStartMinutes = workStartParts[0] * 60 + workStartParts[1];\r\n    const workEndMinutes = workEndParts[0] * 60 + workEndParts[1];\r\n    const standardDayMinutes = workEndMinutes - workStartMinutes - settings.lunchBreakDuration;\r\n    \r\n    // Lấy giờ nghỉ trưa từ settings (nếu có), fallback về hardcode\r\n    const lunchStartParts = (settings.lunchBreakStart || '12:00').split(':').map(Number);\r\n    const lunchEndParts = (settings.lunchBreakEnd || '13:30').split(':').map(Number);\r\n    const lunchStartMinutes = lunchStartParts[0] * 60 + lunchStartParts[1];\r\n    const lunchEndMinutes = lunchEndParts[0] * 60 + lunchEndParts[1];\r\n\r\n    for (let d = 1; d <= daysInMonth; d++) {\r\n        const record = row[`day_${d}`] as DailyRecord;\r\n        const workDate = new Date(year, month - 1, d);\r\n        const dayOfWeek = getDayOfWeek(workDate);\r\n        const isWorkingDay = dayOfWeek !== null && settings.workingDays.includes(dayOfWeek);\r\n        const isWeekend = dayOfWeek === 0 || dayOfWeek === 6; // CN = 0, T7 = 6\r\n        const isHoliday = record?.status === 'holiday';\r\n\r\n        if (record) {\r\n            // Xử lý cho ngày làm việc (thứ 2-6)\r\n            if (isWorkingDay) {\r\n                // Tính giờ làm việc thực tế từ checkIn/checkOut\r\n                if (record.checkIn && record.checkOut) {\r\n                    const workDateStr = toISODate(workDate);\r\n                    const checkInTime = new Date(`${workDateStr}T${record.checkIn}`);\r\n                    const checkOutTime = new Date(`${workDateStr}T${record.checkOut}`);\r\n                    \r\n                    if (isValidDate(checkInTime) && isValidDate(checkOutTime) && isDateAfter(checkOutTime, checkInTime)) {\r\n                        const checkInMins = checkInTime.getHours() * 60 + checkInTime.getMinutes();\r\n                        const checkOutMins = checkOutTime.getHours() * 60 + checkOutTime.getMinutes();\r\n                        \r\n                        // ===== TÍNH GIỜ CÔNG (trong giờ hành chính 8:30-18:00) =====\r\n                        // Giờ vào tính công = max(checkIn, workStart)\r\n                        const effectiveStartMins = Math.max(checkInMins, workStartMinutes);\r\n                        // Giờ ra tính công = min(checkOut, workEnd)\r\n                        const effectiveEndMins = Math.min(checkOutMins, workEndMinutes);\r\n                        \r\n                        let workedMinutes = effectiveEndMins - effectiveStartMins;\r\n                        \r\n                        // Trừ nghỉ trưa nếu làm qua giờ nghỉ trưa\r\n                        if (effectiveStartMins < lunchStartMinutes && effectiveEndMins > lunchEndMinutes) {\r\n                            workedMinutes -= settings.lunchBreakDuration;\r\n                        } else if (effectiveStartMins < lunchEndMinutes && effectiveEndMins > lunchStartMinutes) {\r\n                            // Nếu chỉ chạm 1 phần giờ nghỉ trưa\r\n                            const overlapStart = Math.max(effectiveStartMins, lunchStartMinutes);\r\n                            const overlapEnd = Math.min(effectiveEndMins, lunchEndMinutes);\r\n                            workedMinutes -= Math.max(0, overlapEnd - overlapStart);\r\n                        }\r\n                        \r\n                        totalWorkMinutes += Math.max(0, workedMinutes);\r\n                        \r\n                        // ===== TÍNH GIỜ LÀM THÊM (sau giờ tan làm 18:00) =====\r\n                        if (checkOutMins > workEndMinutes) {\r\n                            const otMinutes = checkOutMins - workEndMinutes;\r\n                            if (isHoliday) {\r\n                                otMinutesHoliday += otMinutes;\r\n                            } else {\r\n                                otMinutesWeekday += otMinutes;\r\n                            }\r\n                        }\r\n                        \r\n                        // Early departure calculation - ra trước giờ tan làm\r\n                        if (checkOutMins < workEndMinutes) {\r\n                            earlyDepartures++;\r\n                        }\r\n                    }\r\n                }\r\n                \r\n                // Đếm ngày nghỉ phép\r\n                if (record.status === 'leave') {\r\n                    leaveDays += 1;\r\n                }\r\n\r\n                // Late arrival calculation\r\n                if (record.checkIn) {\r\n                    const workDateStr = toISODate(workDate);\r\n                    const checkInTime = new Date(`${workDateStr}T${record.checkIn}`);\r\n                    const workStartTime = new Date(`${workDateStr}T${settings.workStartTime}`);\r\n                    const allowedLateTime = new Date(workStartTime.getTime() + settings.allowedLateMinutes * 60000);\r\n\r\n                    if (isDateAfter(checkInTime, allowedLateTime)) {\r\n                        lateArrivals++;\r\n                    }\r\n                }\r\n            }\r\n            \r\n            // ===== XỬ LÝ LÀM THÊM CUỐI TUẦN / NGÀY LỄ =====\r\n            // Nếu là cuối tuần hoặc ngày lễ mà có checkIn/checkOut → tính toàn bộ là OT\r\n            if ((isWeekend || isHoliday) && record.checkIn && record.checkOut) {\r\n                const workDateStr = toISODate(workDate);\r\n                const checkInTime = new Date(`${workDateStr}T${record.checkIn}`);\r\n                const checkOutTime = new Date(`${workDateStr}T${record.checkOut}`);\r\n                \r\n                if (isValidDate(checkInTime) && isValidDate(checkOutTime) && isDateAfter(checkOutTime, checkInTime)) {\r\n                    let otMinutes = (checkOutTime.getTime() - checkInTime.getTime()) / 60000;\r\n                    \r\n                    // Trừ nghỉ trưa nếu làm qua trưa\r\n                    const checkInMins = checkInTime.getHours() * 60 + checkInTime.getMinutes();\r\n                    const checkOutMins = checkOutTime.getHours() * 60 + checkOutTime.getMinutes();\r\n                    if (checkInMins < lunchStartMinutes && checkOutMins > lunchEndMinutes) {\r\n                        otMinutes -= settings.lunchBreakDuration;\r\n                    }\r\n                    \r\n                    if (isHoliday) {\r\n                        otMinutesHoliday += Math.max(0, otMinutes);\r\n                    } else {\r\n                        otMinutesWeekend += Math.max(0, otMinutes);\r\n                    }\r\n                }\r\n            }\r\n            \r\n            // OT từ cột overtimeCheckIn/overtimeCheckOut riêng (nếu có)\r\n            if (record.overtimeCheckIn && record.overtimeCheckOut) {\r\n                const workDateStr = toISODate(workDate);\r\n                const otStartDate = new Date(`${workDateStr}T${record.overtimeCheckIn}`);\r\n                const otEndDate = new Date(`${workDateStr}T${record.overtimeCheckOut}`);\r\n                if (isValidDate(otStartDate) && isValidDate(otEndDate) && isDateAfter(otEndDate, otStartDate)) {\r\n                    const diffInMinutes = (otEndDate.getTime() - otStartDate.getTime()) / 60000;\r\n                    if (isHoliday) {\r\n                        otMinutesHoliday += diffInMinutes;\r\n                    } else if (isWeekend) {\r\n                        otMinutesWeekend += diffInMinutes;\r\n                    } else {\r\n                        otMinutesWeekday += diffInMinutes;\r\n                    }\r\n                }\r\n            }\r\n        }\r\n    }\r\n    \r\n    // Tính số công = Tổng giờ làm / Giờ tiêu chuẩn 1 ngày (tối đa = số ngày làm việc trong tháng)\r\n    const workDays = standardDayMinutes > 0 \r\n        ? parseFloat((totalWorkMinutes / standardDayMinutes).toFixed(2))\r\n        : 0;\r\n    \r\n    // Tính ngày vắng = Tổng ngày làm việc trong tháng - ngày có công - ngày phép\r\n    const totalWorkingDaysInMonth = Array.from({ length: daysInMonth }, (_, i) => {\r\n        const d = new Date(year, month - 1, i + 1);\r\n        const dow = getDayOfWeek(d);\r\n        return dow !== null && settings.workingDays.includes(dow) ? 1 : 0;\r\n    }).reduce((a, b) => a + b, 0);\r\n    \r\n    absentDays = Math.max(0, totalWorkingDaysInMonth - Math.ceil(workDays) - leaveDays);\r\n    \r\n    // Convert OT từ phút sang giờ\r\n    const otHoursWeekday = parseFloat((otMinutesWeekday / 60).toFixed(2));\r\n    const otHoursWeekend = parseFloat((otMinutesWeekend / 60).toFixed(2));\r\n    const otHoursHoliday = parseFloat((otMinutesHoliday / 60).toFixed(2));\r\n    const otHours = parseFloat((otHoursWeekday + otHoursWeekend + otHoursHoliday).toFixed(2));\r\n    \r\n    return {\r\n        workDays,\r\n        leaveDays,\r\n        absentDays,\r\n        lateArrivals,\r\n        earlyDepartures,\r\n        otHours,\r\n        otHoursWeekday,\r\n        otHoursWeekend,\r\n        otHoursHoliday,\r\n    };\r\n}\r\n\r\n/**\r\n * Tính tiền làm thêm (OT) dựa trên số giờ và cài đặt\r\n * \r\n * Công thức:\r\n * - Ngày thường: otHoursWeekday * otHourlyRate (VNĐ/giờ)\r\n * - Cuối tuần: otHoursWeekend * otHourlyRate * otRateWeekend (hệ số 1.5)\r\n * - Ngày lễ: otHoursHoliday * otHourlyRate * otRateHoliday (hệ số 3)\r\n * \r\n * VD: settings.otHourlyRate = 25000, otRateWeekend = 1.5, otRateHoliday = 3\r\n * - 2 giờ OT ngày thường = 2 * 25000 = 50,000 VNĐ\r\n * - 2 giờ OT cuối tuần = 2 * 25000 * 1.5 = 75,000 VNĐ\r\n * - 2 giờ OT ngày lễ = 2 * 25000 * 3 = 150,000 VNĐ\r\n */\r\nexport function calculateOvertimePay(\r\n    otHoursWeekday: number,\r\n    otHoursWeekend: number,\r\n    otHoursHoliday: number,\r\n    settings: EmployeeSettings\r\n): {\r\n    weekdayPay: number;\r\n    weekendPay: number;\r\n    holidayPay: number;\r\n    totalOtPay: number;\r\n} {\r\n    const hourlyRate = settings.otHourlyRate || 0;\r\n    \r\n    // Ngày thường: tiền/giờ * số giờ\r\n    const weekdayPay = otHoursWeekday * hourlyRate;\r\n    \r\n    // Cuối tuần: tiền/giờ * hệ số cuối tuần * số giờ\r\n    const weekendPay = otHoursWeekend * hourlyRate * (settings.otRateWeekend || 1.5);\r\n    \r\n    // Ngày lễ: tiền/giờ * hệ số ngày lễ * số giờ  \r\n    const holidayPay = otHoursHoliday * hourlyRate * (settings.otRateHoliday || 3);\r\n    \r\n    const totalOtPay = weekdayPay + weekendPay + holidayPay;\r\n    \r\n    return {\r\n        weekdayPay: Math.round(weekdayPay),\r\n        weekendPay: Math.round(weekendPay),\r\n        holidayPay: Math.round(holidayPay),\r\n        totalOtPay: Math.round(totalOtPay),\r\n    };\r\n}\r\n\r\n/**\r\n * Tính tiền OT từ AttendanceDataRow\r\n */\r\nexport function calculateOvertimePayFromRow(\r\n    row: AttendanceDataRow,\r\n    settings: EmployeeSettings\r\n): ReturnType<typeof calculateOvertimePay> {\r\n    return calculateOvertimePay(\r\n        row.otHoursWeekday || 0,\r\n        row.otHoursWeekend || 0,\r\n        row.otHoursHoliday || 0,\r\n        settings\r\n    );\r\n}"],"names":[],"mappings":"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"}},
    {"offset": {"line": 408, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/payroll/payroll-batch-store.ts"],"sourcesContent":["import { create } from 'zustand';\r\nimport type {\r\n  PayrollBatch,\r\n  PayrollBatchStatus,\r\n  PayrollAuditLog,\r\n  PayrollAuditAction,\r\n  Payslip,\r\n  PayrollComponentEntry,\r\n  PayrollTotals,\r\n  PayrollPeriod,\r\n} from '../../lib/payroll-types';\r\nimport { generateSystemId, findNextAvailableBusinessId } from '../../lib/id-utils';\r\nimport { getPrefix, type EntityType } from '../../lib/smart-prefix';\r\nimport { getCurrentUserSystemId } from '../../contexts/auth-context';\r\nimport { useAttendanceStore } from '../attendance/store';\r\nimport { asBusinessId, asSystemId, type BusinessId, type SystemId } from '../../lib/id-types';\r\n\r\n// API sync helpers\r\nasync function syncToAPI(action: 'create' | 'update' | 'delete', entityType: 'batch' | 'payslip', data: any): Promise<boolean> {\r\n  try {\r\n    const basePath = entityType === 'batch' ? '/api/payroll/batches' : '/api/payroll/payslips';\r\n    const endpoint = action === 'create' ? basePath : `${basePath}/${data.systemId}`;\r\n    const method = action === 'create' ? 'POST' : action === 'update' ? 'PATCH' : 'DELETE';\r\n    \r\n    const response = await fetch(endpoint, {\r\n      method,\r\n      headers: { 'Content-Type': 'application/json' },\r\n      body: action !== 'delete' ? JSON.stringify(data) : undefined,\r\n    });\r\n    \r\n    if (!response.ok) {\r\n      console.error(`[Payroll API] ${action} ${entityType} failed:`, await response.text());\r\n      return false;\r\n    }\r\n    return true;\r\n  } catch (error) {\r\n    console.error(`[Payroll API] ${action} ${entityType} error:`, error);\r\n    return false;\r\n  }\r\n}\r\n\r\n// Type for payslip updates\r\nexport type PayslipUpdatePayload = {\r\n  components?: PayrollComponentEntry[];\r\n  totals?: PayrollTotals;\r\n};\r\n\r\nconst AUDIT_ACTION_FOR_STATUS: Record<PayrollBatchStatus, PayrollAuditAction> = {\r\n  draft: 'run',\r\n  reviewed: 'review',\r\n  locked: 'lock',\r\n  cancelled: 'run', // cancelled uses same action as draft\r\n};\r\n\r\nconst resolveActorSystemId = () => asSystemId(getCurrentUserSystemId() || 'SYSTEM00000000');\r\n\r\ntype CounterState = {\r\n  systemId: number;\r\n  businessId: number;\r\n};\r\n\r\ntype CounterMap = {\r\n  payroll: CounterState;\r\n  payslips: CounterState;\r\n  'payroll-audit-log': CounterState;\r\n};\r\n\r\ntype CreateBatchInput = {\r\n  title: string;\r\n  templateSystemId?: SystemId | undefined;\r\n  payPeriod: PayrollPeriod;\r\n  payrollDate: string;\r\n  referenceAttendanceMonthKeys?: string[] | undefined;\r\n  notes?: string | undefined;\r\n};\r\n\r\ntype CreatePayslipInput = {\r\n  employeeSystemId: SystemId;\r\n  employeeId: BusinessId;\r\n  departmentSystemId?: SystemId | undefined;\r\n  periodMonthKey: string;\r\n  components: PayrollComponentEntry[];\r\n  totals: PayrollTotals;\r\n  attendanceSnapshotSystemId?: SystemId | undefined;\r\n  deductedPenaltySystemIds?: SystemId[] | undefined;\r\n};\r\n\r\nexport type GeneratedPayslipPayload = {\r\n  employeeSystemId: SystemId;\r\n  employeeId: BusinessId;\r\n  departmentSystemId?: SystemId | undefined;\r\n  periodMonthKey: string;\r\n  components: PayrollComponentEntry[];\r\n  totals: PayrollTotals;\r\n  attendanceSnapshotSystemId?: SystemId | undefined;\r\n  deductedPenaltySystemIds?: SystemId[] | undefined;\r\n};\r\n\r\ntype LogActionInput = {\r\n  batchSystemId: SystemId;\r\n  action: PayrollAuditAction;\r\n  payload?: Record<string, unknown> | undefined;\r\n  actorSystemId?: SystemId | undefined;\r\n  actorDisplayName?: string | undefined;\r\n};\r\n\r\ntype PayrollBatchStoreState = {\r\n  batches: PayrollBatch[];\r\n  payslips: Payslip[];\r\n  auditLogs: PayrollAuditLog[];\r\n  counters: CounterMap;\r\n  initialized: boolean;\r\n  createBatch: (input: CreateBatchInput) => PayrollBatch;\r\n  createBatchWithResults: (input: CreateBatchInput, payslips: GeneratedPayslipPayload[]) => PayrollBatch;\r\n  updateBatchStatus: (systemId: SystemId, status: PayrollBatchStatus, note?: string) => void;\r\n  addPayslips: (batchSystemId: SystemId, inputs: CreatePayslipInput[]) => void;\r\n  updatePayslip: (payslipSystemId: SystemId, updates: PayslipUpdatePayload) => { success: boolean; error?: string };\r\n  removePayslipFromBatch: (payslipSystemId: SystemId) => { success: boolean; error?: string };\r\n  cancelBatch: (systemId: SystemId, reason?: string) => { success: boolean; error?: string };\r\n  logAction: (input: LogActionInput) => PayrollAuditLog;\r\n  getBatchBySystemId: (systemId: SystemId) => PayrollBatch | undefined;\r\n  getPayslipsByBatch: (batchSystemId: SystemId) => Payslip[];\r\n  getPayslipBySystemId: (systemId: SystemId) => Payslip | undefined;\r\n  loadFromAPI: () => Promise<void>;\r\n};\r\n\r\nconst initialCounters: CounterMap = {\r\n  payroll: { systemId: 0, businessId: 0 },\r\n  payslips: { systemId: 0, businessId: 0 },\r\n  'payroll-audit-log': { systemId: 0, businessId: 0 },\r\n};\r\n\r\nconst collectBusinessIds = (items: { id: string }[]) =>\r\n  items.map((item) => item.id?.toUpperCase()).filter((id): id is string => Boolean(id));\r\n\r\nconst buildDualIds = (\r\n  entityType: EntityType,\r\n  counter: CounterState,\r\n  existingIds: string[]\r\n) => {\r\n  const nextSystemCounter = counter.systemId + 1;\r\n  const systemId = asSystemId(generateSystemId(entityType, nextSystemCounter));\r\n  const { nextId, updatedCounter } = findNextAvailableBusinessId(\r\n    getPrefix(entityType),\r\n    existingIds,\r\n    counter.businessId\r\n  );\r\n\r\n  return {\r\n    systemId,\r\n    id: asBusinessId(nextId),\r\n    counter: {\r\n      systemId: nextSystemCounter,\r\n      businessId: updatedCounter,\r\n    },\r\n  };\r\n};\r\n\r\nexport const usePayrollBatchStore = create<PayrollBatchStoreState>()(\r\n  (set, get) => ({\r\n      batches: [],\r\n      payslips: [],\r\n      auditLogs: [],\r\n      counters: initialCounters,\r\n      getBatchBySystemId: (systemId) => get().batches.find((batch) => batch.systemId === systemId),\r\n      getPayslipsByBatch: (batchSystemId) => get().payslips.filter((payslip) => payslip.batchSystemId === batchSystemId),\r\n      getPayslipBySystemId: (systemId) => get().payslips.find((payslip) => payslip.systemId === systemId),\r\n      createBatch: (input) => {\r\n        set((state) => {\r\n          const actor = resolveActorSystemId();\r\n          const now = new Date().toISOString();\r\n          const dualIds = buildDualIds('payroll', state.counters.payroll, collectBusinessIds(state.batches));\r\n          const batch: PayrollBatch = {\r\n            systemId: dualIds.systemId,\r\n            id: dualIds.id,\r\n            title: input.title,\r\n            status: 'draft',\r\n            templateSystemId: input.templateSystemId,\r\n            payPeriod: input.payPeriod,\r\n            payrollDate: input.payrollDate,\r\n            referenceAttendanceMonthKeys:\r\n              input.referenceAttendanceMonthKeys?.length\r\n                ? input.referenceAttendanceMonthKeys\r\n                : [input.payPeriod.monthKey],\r\n            payslipSystemIds: [],\r\n            totalGross: 0,\r\n            totalNet: 0,\r\n            notes: input.notes,\r\n            createdAt: now,\r\n            updatedAt: now,\r\n            createdBy: actor,\r\n            updatedBy: actor,\r\n          };\r\n\r\n          const countersAfterBatch: CounterMap = {\r\n            ...state.counters,\r\n            payroll: dualIds.counter,\r\n          };\r\n\r\n          const auditResult = createAuditLogEntry({\r\n            batchSystemId: batch.systemId,\r\n            action: 'run',\r\n            payload: { title: batch.title },\r\n            actorSystemId: actor,\r\n          })({ ...state, counters: countersAfterBatch });\r\n\r\n          return {\r\n            ...state,\r\n            batches: [...state.batches, batch],\r\n            auditLogs: auditResult.auditLogs,\r\n            counters: auditResult.counters,\r\n          };\r\n        });\r\n\r\n        const createdBatch = get().batches.at(-1);\r\n        if (!createdBatch) {\r\n          throw new Error('Không thể tạo batch lương mới.');\r\n        }\r\n        return createdBatch;\r\n      },\r\n      createBatchWithResults: (input, generatedPayslips) => {\r\n        const batch = get().createBatch(input);\r\n        if (generatedPayslips.length) {\r\n          get().addPayslips(\r\n            batch.systemId,\r\n            generatedPayslips.map((payload) => ({\r\n              employeeSystemId: payload.employeeSystemId,\r\n              employeeId: payload.employeeId,\r\n              departmentSystemId: payload.departmentSystemId,\r\n              periodMonthKey: payload.periodMonthKey,\r\n              components: payload.components,\r\n              totals: payload.totals,\r\n              attendanceSnapshotSystemId: payload.attendanceSnapshotSystemId,\r\n              deductedPenaltySystemIds: payload.deductedPenaltySystemIds,\r\n            }))\r\n          );\r\n        }\r\n        return get().getBatchBySystemId(batch.systemId) ?? batch;\r\n      },\r\n      updateBatchStatus: (systemId, status, note) => {\r\n        const actor = resolveActorSystemId();\r\n        const now = new Date().toISOString();\r\n        let monthsToLock: string[] = [];\r\n        set((state) => {\r\n          const batches = state.batches.map((batch) => {\r\n            if (batch.systemId !== systemId) return batch;\r\n            if (status === 'locked') {\r\n              monthsToLock = batch.referenceAttendanceMonthKeys;\r\n            }\r\n            return {\r\n              ...batch,\r\n              status,\r\n              reviewedAt: status === 'reviewed' ? now : batch.reviewedAt,\r\n              reviewedBy: status === 'reviewed' ? actor : batch.reviewedBy,\r\n              lockedAt: status === 'locked' ? now : batch.lockedAt,\r\n              lockedBy: status === 'locked' ? actor : batch.lockedBy,\r\n              updatedAt: now,\r\n              updatedBy: actor,\r\n              notes: note ?? batch.notes,\r\n            };\r\n          });\r\n\r\n          const { auditLogs, counters } = createAuditLogEntry({\r\n            batchSystemId: systemId,\r\n            action: AUDIT_ACTION_FOR_STATUS[status],\r\n            payload: note ? { note } : undefined,\r\n            actorSystemId: actor,\r\n          })(state);\r\n\r\n          return {\r\n            ...state,\r\n            batches,\r\n            auditLogs,\r\n            counters,\r\n          };\r\n        });\r\n\r\n        if (status === 'locked' && monthsToLock.length) {\r\n          const attendanceStore = useAttendanceStore.getState();\r\n          monthsToLock.forEach((monthKey) => attendanceStore.lockMonth(monthKey));\r\n        }\r\n      },\r\n      addPayslips: (batchSystemId, inputs) => {\r\n        if (!inputs.length) return;\r\n        set((state) => {\r\n          const actor = resolveActorSystemId();\r\n          const now = new Date().toISOString();\r\n          const batch = state.batches.find((b) => b.systemId === batchSystemId);\r\n          if (!batch) {\r\n            throw new Error('Không tìm thấy batch lương.');\r\n          }\r\n\r\n          let nextCounters = { ...state.counters };\r\n          const existingPayslipIds = collectBusinessIds(state.payslips);\r\n          const newPayslips: Payslip[] = inputs.map((payload) => {\r\n            const ids = buildDualIds('payslips', nextCounters.payslips, existingPayslipIds);\r\n            nextCounters = { ...nextCounters, payslips: ids.counter };\r\n            existingPayslipIds.push(ids.id);\r\n            return {\r\n              systemId: ids.systemId,\r\n              id: ids.id,\r\n              batchSystemId,\r\n              employeeSystemId: payload.employeeSystemId,\r\n              employeeId: payload.employeeId,\r\n              departmentSystemId: payload.departmentSystemId,\r\n              periodMonthKey: payload.periodMonthKey,\r\n              attendanceSnapshotSystemId: payload.attendanceSnapshotSystemId,\r\n              components: payload.components,\r\n              totals: payload.totals,\r\n              deductedPenaltySystemIds: payload.deductedPenaltySystemIds,\r\n              createdAt: now,\r\n              updatedAt: now,\r\n              createdBy: actor,\r\n              updatedBy: actor,\r\n            };\r\n          });\r\n\r\n          const payslips = [...state.payslips, ...newPayslips];\r\n          const payslipSystemIds = [...new Set([...batch.payslipSystemIds, ...newPayslips.map((p) => p.systemId)])];\r\n          const batchPayslips = payslips.filter((slip) => payslipSystemIds.includes(slip.systemId));\r\n          const totalGross = batchPayslips.reduce((sum, slip) => sum + slip.totals.earnings, 0);\r\n          const totalNet = batchPayslips.reduce((sum, slip) => sum + slip.totals.netPay, 0);\r\n\r\n          const batches = state.batches.map((b) =>\r\n            b.systemId === batchSystemId\r\n              ? {\r\n                  ...b,\r\n                  payslipSystemIds,\r\n                  totalGross,\r\n                  totalNet,\r\n                  updatedAt: now,\r\n                  updatedBy: actor,\r\n                }\r\n              : b\r\n          );\r\n\r\n          const { auditLogs, counters } = createAuditLogEntry({\r\n            batchSystemId,\r\n            action: 'recalculate',\r\n            payload: { added: newPayslips.length },\r\n            actorSystemId: actor,\r\n          })({ ...state, counters: nextCounters });\r\n\r\n          return {\r\n            ...state,\r\n            batches,\r\n            payslips,\r\n            auditLogs,\r\n            counters,\r\n          };\r\n        });\r\n      },\r\n      updatePayslip: (payslipSystemId, updates) => {\r\n        const state = get();\r\n        const payslip = state.payslips.find((p) => p.systemId === payslipSystemId);\r\n        \r\n        if (!payslip) {\r\n          return { success: false, error: 'Không tìm thấy phiếu lương.' };\r\n        }\r\n\r\n        const batch = state.batches.find((b) => b.systemId === payslip.batchSystemId);\r\n        if (!batch) {\r\n          return { success: false, error: 'Không tìm thấy bảng lương.' };\r\n        }\r\n\r\n        if (batch.status === 'locked') {\r\n          return { success: false, error: 'Bảng lương đã khóa, không thể sửa.' };\r\n        }\r\n\r\n        const actor = resolveActorSystemId();\r\n        const now = new Date().toISOString();\r\n\r\n        set((state) => {\r\n          // Update the payslip\r\n          const updatedPayslips = state.payslips.map((p) =>\r\n            p.systemId === payslipSystemId\r\n              ? {\r\n                  ...p,\r\n                  components: updates.components ?? p.components,\r\n                  totals: updates.totals ?? p.totals,\r\n                  updatedAt: now,\r\n                  updatedBy: actor,\r\n                }\r\n              : p\r\n          );\r\n\r\n          // Recalculate batch totals\r\n          const batchPayslipIds = batch.payslipSystemIds;\r\n          const batchPayslips = updatedPayslips.filter((p) => batchPayslipIds.includes(p.systemId));\r\n          const totalGross = batchPayslips.reduce((sum, p) => sum + p.totals.earnings, 0);\r\n          const totalNet = batchPayslips.reduce((sum, p) => sum + p.totals.netPay, 0);\r\n\r\n          const updatedBatches = state.batches.map((b) =>\r\n            b.systemId === batch.systemId\r\n              ? { ...b, totalGross, totalNet, updatedAt: now, updatedBy: actor }\r\n              : b\r\n          );\r\n\r\n          // Log the action\r\n          const { auditLogs, counters } = createAuditLogEntry({\r\n            batchSystemId: batch.systemId,\r\n            action: 'recalculate',\r\n            payload: { \r\n              payslipSystemId, \r\n              employeeId: payslip.employeeId,\r\n              previousNet: payslip.totals.netPay,\r\n              newNet: updates.totals?.netPay ?? payslip.totals.netPay,\r\n            },\r\n            actorSystemId: actor,\r\n          })(state);\r\n\r\n          return {\r\n            ...state,\r\n            payslips: updatedPayslips,\r\n            batches: updatedBatches,\r\n            auditLogs,\r\n            counters,\r\n          };\r\n        });\r\n\r\n        return { success: true };\r\n      },\r\n      removePayslipFromBatch: (payslipSystemId) => {\r\n        const state = get();\r\n        const payslip = state.payslips.find((p) => p.systemId === payslipSystemId);\r\n        \r\n        if (!payslip) {\r\n          return { success: false, error: 'Không tìm thấy phiếu lương.' };\r\n        }\r\n\r\n        const batch = state.batches.find((b) => b.systemId === payslip.batchSystemId);\r\n        if (!batch) {\r\n          return { success: false, error: 'Không tìm thấy bảng lương.' };\r\n        }\r\n\r\n        if (batch.status === 'locked') {\r\n          return { success: false, error: 'Bảng lương đã khóa, không thể xóa phiếu lương.' };\r\n        }\r\n\r\n        const actor = resolveActorSystemId();\r\n        const now = new Date().toISOString();\r\n\r\n        set((state) => {\r\n          // Remove from payslips\r\n          const updatedPayslips = state.payslips.filter((p) => p.systemId !== payslipSystemId);\r\n\r\n          // Update batch\r\n          const newPayslipIds = batch.payslipSystemIds.filter((id) => id !== payslipSystemId);\r\n          const batchPayslips = updatedPayslips.filter((p) => newPayslipIds.includes(p.systemId));\r\n          const totalGross = batchPayslips.reduce((sum, p) => sum + p.totals.earnings, 0);\r\n          const totalNet = batchPayslips.reduce((sum, p) => sum + p.totals.netPay, 0);\r\n\r\n          const updatedBatches = state.batches.map((b) =>\r\n            b.systemId === batch.systemId\r\n              ? { \r\n                  ...b, \r\n                  payslipSystemIds: newPayslipIds,\r\n                  totalGross, \r\n                  totalNet, \r\n                  updatedAt: now, \r\n                  updatedBy: actor \r\n                }\r\n              : b\r\n          );\r\n\r\n          // Log the action\r\n          const { auditLogs, counters } = createAuditLogEntry({\r\n            batchSystemId: batch.systemId,\r\n            action: 'recalculate',\r\n            payload: { \r\n              removed: payslipSystemId, \r\n              employeeId: payslip.employeeId,\r\n            },\r\n            actorSystemId: actor,\r\n          })(state);\r\n\r\n          return {\r\n            ...state,\r\n            payslips: updatedPayslips,\r\n            batches: updatedBatches,\r\n            auditLogs,\r\n            counters,\r\n          };\r\n        });\r\n\r\n        return { success: true };\r\n      },\r\n      cancelBatch: (systemId, reason) => {\r\n        const state = get();\r\n        const batch = state.batches.find((b) => b.systemId === systemId);\r\n\r\n        if (!batch) {\r\n          return { success: false, error: 'Không tìm thấy bảng lương.' };\r\n        }\r\n\r\n        if (batch.status === 'locked') {\r\n          return { success: false, error: 'Bảng lương đã khóa, không thể hủy.' };\r\n        }\r\n\r\n        if (batch.status === 'cancelled') {\r\n          return { success: false, error: 'Bảng lương đã được hủy trước đó.' };\r\n        }\r\n\r\n        const actor = resolveActorSystemId();\r\n        const now = new Date().toISOString();\r\n\r\n        set((state) => {\r\n          // Update batch status to cancelled\r\n          const updatedBatches = state.batches.map((b) =>\r\n            b.systemId === systemId\r\n              ? {\r\n                  ...b,\r\n                  status: 'cancelled' as const,\r\n                  notes: reason ? `[Hủy] ${reason}` : b.notes,\r\n                  updatedAt: now,\r\n                  updatedBy: actor,\r\n                }\r\n              : b\r\n          );\r\n\r\n          // Log the action\r\n          const { auditLogs, counters } = createAuditLogEntry({\r\n            batchSystemId: systemId,\r\n            action: 'recalculate', // Using recalculate as closest action type for cancel\r\n            payload: {\r\n              cancelled: true,\r\n              reason: reason,\r\n              title: batch.title,\r\n              payslipCount: batch.payslipSystemIds.length,\r\n            },\r\n            actorSystemId: actor,\r\n          })(state);\r\n\r\n          return {\r\n            ...state,\r\n            batches: updatedBatches,\r\n            auditLogs,\r\n            counters,\r\n          };\r\n        });\r\n\r\n        return { success: true };\r\n      },\r\n      logAction: (input) => {\r\n        let createdLog: PayrollAuditLog | undefined;\r\n        set((state) => {\r\n          const { auditLogs, counters } = createAuditLogEntry(input)(state);\r\n          createdLog = auditLogs[auditLogs.length - 1];\r\n          return {\r\n            ...state,\r\n            auditLogs,\r\n            counters,\r\n          };\r\n        });\r\n        if (!createdLog) {\r\n          throw new Error('Không thể ghi nhật ký payroll.');\r\n        }\r\n        return createdLog;\r\n      },\r\n      \r\n      // Load from API\r\n      loadFromAPI: async () => {\r\n        try {\r\n          // NOTE: Use React Query hooks for paginated payroll data. This only loads initial batch.\r\n          const [batchesRes, payslipsRes] = await Promise.all([\r\n            fetch('/api/payroll/batches?limit=100'),\r\n            fetch('/api/payroll/payslips?limit=100'),\r\n          ]);\r\n          \r\n          if (batchesRes.ok && payslipsRes.ok) {\r\n            const batchesJson = await batchesRes.json();\r\n            const payslipsJson = await payslipsRes.json();\r\n            \r\n            const batches = batchesJson.data || [];\r\n            const payslips = payslipsJson.data || [];\r\n            \r\n            if (batches.length > 0 || payslips.length > 0) {\r\n              set({ batches, payslips, initialized: true });\r\n            } else {\r\n              set({ initialized: true });\r\n            }\r\n          }\r\n        } catch (error) {\r\n          console.error('[Payroll API] loadFromAPI error:', error);\r\n        }\r\n      },\r\n      initialized: false,\r\n    })\r\n);\r\n\r\nconst createAuditLogEntry = (input: LogActionInput) => (state: PayrollBatchStoreState) => {\r\n  const actor = input.actorSystemId ?? resolveActorSystemId();\r\n  const now = new Date().toISOString();\r\n  const ids = buildDualIds(\r\n    'payroll-audit-log',\r\n    state.counters['payroll-audit-log'],\r\n    collectBusinessIds(state.auditLogs)\r\n  );\r\n\r\n  const entry: PayrollAuditLog = {\r\n    systemId: ids.systemId,\r\n    id: ids.id,\r\n    batchSystemId: input.batchSystemId,\r\n    action: input.action,\r\n    actorSystemId: actor ?? asSystemId('SYSTEM00000000'),\r\n    actorDisplayName: input.actorDisplayName,\r\n    payload: input.payload,\r\n    createdAt: now,\r\n  };\r\n\r\n  return {\r\n    auditLogs: [...state.auditLogs, entry],\r\n    counters: {\r\n      ...state.counters,\r\n      'payroll-audit-log': ids.counter,\r\n    },\r\n  };\r\n};\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 948, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/payroll/components/status-badge.tsx"],"sourcesContent":["import * as React from 'react';\r\nimport { Badge } from '../../../components/ui/badge';\r\nimport type { PayrollBatchStatus } from '../../../lib/payroll-types';\r\nimport { cn } from '../../../lib/utils';\r\n\r\ntype PayrollStatusBadgeProps = {\r\n  status: PayrollBatchStatus;\r\n  className?: string;\r\n};\r\n\r\nconst STATUS_LABEL: Record<PayrollBatchStatus, string> = {\r\n  draft: 'Nháp',\r\n  reviewed: 'Đang duyệt',\r\n  locked: 'Đã khóa',\r\n  cancelled: 'Đã hủy',\r\n};\r\n\r\nconst STATUS_VARIANT: Record<PayrollBatchStatus, React.ComponentProps<typeof Badge>['variant']> = {\r\n  draft: 'secondary',\r\n  reviewed: 'warning',\r\n  locked: 'success',\r\n  cancelled: 'destructive',\r\n};\r\n\r\nexport function PayrollStatusBadge({ status, className }: PayrollStatusBadgeProps) {\r\n  return (\r\n    <Badge variant={STATUS_VARIANT[status]} className={cn('text-body-xs font-medium', className)}>\r\n      {STATUS_LABEL[status]}\r\n    </Badge>\r\n  );\r\n}\r\n"],"names":[],"mappings":";;;;;AACA;AAEA;;;;AAOA,MAAM,eAAmD;IACvD,OAAO;IACP,UAAU;IACV,QAAQ;IACR,WAAW;AACb;AAEA,MAAM,iBAA4F;IAChG,OAAO;IACP,UAAU;IACV,QAAQ;IACR,WAAW;AACb;AAEO,SAAS,mBAAmB,EAAE,MAAM,EAAE,SAAS,EAA2B;IAC/E,qBACE,6LAAC,sIAAK;QAAC,SAAS,cAAc,CAAC,OAAO;QAAE,WAAW,IAAA,qHAAE,EAAC,4BAA4B;kBAC/E,YAAY,CAAC,OAAO;;;;;;AAG3B;KANgB"}},
    {"offset": {"line": 991, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/payroll/components/payslip-print-button.tsx"],"sourcesContent":["import * as React from 'react';\r\nimport { Printer } from 'lucide-react';\r\nimport { Button } from '../../../components/ui/button';\r\nimport { toast } from 'sonner';\r\nimport { usePrint } from '../../../lib/use-print';\r\nimport { useStoreInfoStore } from '../../settings/store-info/store-info-store';\r\nimport { usePayrollBatchStore } from '../payroll-batch-store';\r\nimport { useEmployeeStore } from '../../employees/store';\r\nimport { useDepartmentStore } from '../../settings/departments/store';\r\nimport {\r\n  convertPayrollBatchForPrint,\r\n  convertPayslipForPrint,\r\n  mapPayrollBatchToPrintData,\r\n  mapPayrollBatchLineItems,\r\n  mapPayslipToPrintData,\r\n  mapPayslipComponentLineItems,\r\n  createStoreSettings,\r\n} from '../../../lib/print/payroll-print-helper';\r\nimport type { SystemId } from '../../../lib/id-types';\r\nimport type { Payslip, PayrollBatch } from '../../../lib/payroll-types';\r\n\r\n// =============================================\r\n// TYPES\r\n// =============================================\r\n\r\ntype PayslipPrintButtonProps = {\r\n  payslipSystemId?: SystemId;\r\n  /** Truyền trực tiếp payslip data (ưu tiên hơn payslipSystemId) */\r\n  payslipData?: Payslip;\r\n  /** Truyền trực tiếp batch data */\r\n  batchData?: PayrollBatch;\r\n  variant?: 'default' | 'ghost' | 'outline';\r\n  size?: 'default' | 'sm' | 'icon';\r\n  className?: string;\r\n  showText?: boolean;\r\n};\r\n\r\n// =============================================\r\n// COMPONENT\r\n// =============================================\r\n\r\n/**\r\n * PayslipPrintButton - In phiếu lương cá nhân\r\n * \r\n * Sử dụng:\r\n * ```tsx\r\n * <PayslipPrintButton payslipSystemId={payslip.systemId} />\r\n * <PayslipPrintButton payslipData={payslip} batchData={batch} />\r\n * <PayslipPrintButton payslipSystemId={payslip.systemId} variant=\"ghost\" size=\"icon\" />\r\n * ```\r\n */\r\nexport function PayslipPrintButton({\r\n  payslipSystemId,\r\n  payslipData,\r\n  batchData,\r\n  variant = 'outline',\r\n  size = 'sm',\r\n  className,\r\n  showText = true,\r\n}: PayslipPrintButtonProps) {\r\n  // Stores - chỉ query nếu không có data truyền vào\r\n  const storePayslip = usePayrollBatchStore((state) => \r\n    payslipSystemId ? state.payslips.find((p) => p.systemId === payslipSystemId) : undefined\r\n  );\r\n  const storeBatch = usePayrollBatchStore((state) => {\r\n    const slip = payslipData || storePayslip;\r\n    return slip ? state.batches.find((b) => b.systemId === slip.batchSystemId) : undefined;\r\n  });\r\n  \r\n  // Ưu tiên data truyền vào\r\n  const payslip = payslipData || storePayslip;\r\n  const batch = batchData || storeBatch;\r\n  \r\n  const { data: employees } = useEmployeeStore();\r\n  const { data: departments } = useDepartmentStore();\r\n  const { info: storeInfo } = useStoreInfoStore();\r\n  \r\n  // Print hook\r\n  const { print } = usePrint();\r\n\r\n  // Lookups\r\n  const employeeLookup = React.useMemo(() => {\r\n    return employees.reduce<Record<SystemId, (typeof employees)[number]>>(\r\n      (acc, emp) => {\r\n        acc[emp.systemId] = emp;\r\n        return acc;\r\n      },\r\n      {} as Record<SystemId, (typeof employees)[number]>\r\n    );\r\n  }, [employees]);\r\n\r\n  const departmentLookup = React.useMemo(() => {\r\n    return departments.reduce<Record<SystemId, (typeof departments)[number]>>(\r\n      (acc, dept) => {\r\n        acc[dept.systemId] = dept;\r\n        return acc;\r\n      },\r\n      {} as Record<SystemId, (typeof departments)[number]>\r\n    );\r\n  }, [departments]);\r\n\r\n  // Handler\r\n  const handlePrint = React.useCallback(() => {\r\n    if (!payslip || !batch) {\r\n      toast.error('Không thể in', { description: 'Không tìm thấy dữ liệu phiếu lương.' });\r\n      return;\r\n    }\r\n\r\n    // Get employee info\r\n    const employee = employeeLookup[payslip.employeeSystemId];\r\n    const departmentName = payslip.departmentSystemId\r\n      ? departmentLookup[payslip.departmentSystemId as SystemId]?.name\r\n      : employee?.department;\r\n\r\n    const storeSettings = createStoreSettings(storeInfo);\r\n    const payslipForPrint = convertPayslipForPrint(\r\n      payslip,\r\n      batch,\r\n      {\r\n        employee: employee ? {\r\n          fullName: employee.fullName,\r\n          id: employee.id,\r\n          department: employee.department,\r\n          position: employee.positionName,\r\n        } : undefined,\r\n        departmentName,\r\n      }\r\n    );\r\n\r\n    // In phiếu lương cá nhân (template 'payslip')\r\n    print('payslip', {\r\n      data: mapPayslipToPrintData(payslipForPrint, storeSettings),\r\n      lineItems: mapPayslipComponentLineItems(payslipForPrint.components),\r\n    });\r\n\r\n    toast.success('Đang chuẩn bị in...', { description: 'Phiếu lương sẽ được in ra.' });\r\n  }, [payslip, batch, storeInfo, employeeLookup, departmentLookup, print]);\r\n\r\n  if (!payslip) {\r\n    return null;\r\n  }\r\n\r\n  return (\r\n    <Button\r\n      variant={variant}\r\n      size={size}\r\n      className={className}\r\n      onClick={handlePrint}\r\n    >\r\n      <Printer className={showText ? 'h-4 w-4 mr-2' : 'h-4 w-4'} />\r\n      {showText && 'In phiếu lương'}\r\n    </Button>\r\n  );\r\n}\r\n\r\n// =============================================\r\n// BATCH PRINT BUTTON\r\n// =============================================\r\n\r\ntype BatchPrintButtonProps = {\r\n  batchSystemId: SystemId;\r\n  variant?: 'default' | 'ghost' | 'outline';\r\n  size?: 'default' | 'sm' | 'icon';\r\n  className?: string;\r\n  showText?: boolean;\r\n};\r\n\r\n/**\r\n * BatchPrintButton - In toàn bộ bảng lương\r\n */\r\nexport function BatchPrintButton({\r\n  batchSystemId,\r\n  variant = 'outline',\r\n  size = 'sm',\r\n  className,\r\n  showText = true,\r\n}: BatchPrintButtonProps) {\r\n  // Stores\r\n  const batch = usePayrollBatchStore((state) =>\r\n    state.batches.find((b) => b.systemId === batchSystemId)\r\n  );\r\n  const payslips = usePayrollBatchStore((state) =>\r\n    batch ? state.payslips.filter((p) => p.batchSystemId === batch.systemId) : []\r\n  );\r\n  const { data: employees } = useEmployeeStore();\r\n  const { data: departments } = useDepartmentStore();\r\n  const { info: storeInfo } = useStoreInfoStore();\r\n  \r\n  const { print } = usePrint();\r\n\r\n  // Lookups\r\n  const employeeLookup = React.useMemo(() => {\r\n    return employees.reduce<Record<SystemId, (typeof employees)[number]>>(\r\n      (acc, emp) => {\r\n        acc[emp.systemId] = emp;\r\n        return acc;\r\n      },\r\n      {} as Record<SystemId, (typeof employees)[number]>\r\n    );\r\n  }, [employees]);\r\n\r\n  const departmentLookup = React.useMemo(() => {\r\n    return departments.reduce<Record<SystemId, (typeof departments)[number]>>(\r\n      (acc, dept) => {\r\n        acc[dept.systemId] = dept;\r\n        return acc;\r\n      },\r\n      {} as Record<SystemId, (typeof departments)[number]>\r\n    );\r\n  }, [departments]);\r\n\r\n  // Handler\r\n  const handlePrint = React.useCallback(() => {\r\n    if (!batch || payslips.length === 0) {\r\n      toast.error('Không thể in', { description: 'Không tìm thấy dữ liệu bảng lương.' });\r\n      return;\r\n    }\r\n\r\n    const storeSettings = createStoreSettings(storeInfo);\r\n    const batchForPrint = convertPayrollBatchForPrint(\r\n      batch,\r\n      payslips,\r\n      {\r\n        employeeLookup: employeeLookup as Record<SystemId, { fullName?: string; id?: string; department?: string }>,\r\n        departmentLookup: departmentLookup as Record<SystemId, { name?: string }>,\r\n      }\r\n    );\r\n\r\n    print('payroll', {\r\n      data: mapPayrollBatchToPrintData(batchForPrint, storeSettings),\r\n      lineItems: mapPayrollBatchLineItems(batchForPrint.payslips),\r\n    });\r\n\r\n    toast.success('Đang chuẩn bị in...', { description: `In ${payslips.length} phiếu lương.` });\r\n  }, [batch, payslips, storeInfo, employeeLookup, departmentLookup, print]);\r\n\r\n  if (!batch) {\r\n    return null;\r\n  }\r\n\r\n  return (\r\n    <Button\r\n      variant={variant}\r\n      size={size}\r\n      className={className}\r\n      onClick={handlePrint}\r\n      disabled={payslips.length === 0}\r\n    >\r\n      <Printer className={showText ? 'h-4 w-4 mr-2' : 'h-4 w-4'} />\r\n      {showText && `In bảng lương (${payslips.length})`}\r\n    </Button>\r\n  );\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1262, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/leaves/leave-sync-service.ts"],"sourcesContent":["import type { LeaveRequest } from './types';\r\nimport type { AttendanceDayKey, AttendanceDataRow, AnyAttendanceDataRow, DailyRecord } from '../attendance/types';\r\nimport { useAttendanceStore } from '../attendance/store';\r\nimport { useEmployeeSettingsStore } from '../settings/employees/employee-settings-store';\r\nimport { recalculateSummary } from '../attendance/utils';\r\nimport { getCurrentDate } from '../../lib/date-utils';\r\n\r\nconst LEAVE_NOTE_PREFIX = '[LEAVE:';\r\n\r\ntype DayContext = {\r\n  date: Date;\r\n  dayOfMonth: number;\r\n};\r\n\r\ntype MonthDayMap = Map<string, DayContext[]>;\r\n\r\nconst buildMonthKey = (date: Date) => `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;\r\n\r\nconst buildLeaveNote = (leave: LeaveRequest) => {\r\n  const description = `${LEAVE_NOTE_PREFIX}${leave.systemId}] ${leave.leaveTypeName}`;\r\n  return leave.reason ? `${description} - ${leave.reason}` : description;\r\n};\r\n\r\nconst isSameLeaveNote = (record: DailyRecord | undefined, leave: LeaveRequest) => {\r\n  if (!record?.notes) return false;\r\n  return record.notes.includes(`${LEAVE_NOTE_PREFIX}${leave.systemId}]`);\r\n};\r\n\r\nconst cloneDate = (input: Date) => new Date(input.getFullYear(), input.getMonth(), input.getDate());\r\n\r\nconst parseLeaveBoundary = (value: string): Date => {\r\n  const parsed = new Date(`${value}T00:00:00`);\r\n  return Number.isNaN(parsed.getTime()) ? new Date() : parsed;\r\n};\r\n\r\nconst collectWorkingDays = (leave: LeaveRequest): MonthDayMap => {\r\n  const workingDays = new Set(useEmployeeSettingsStore.getState().settings.workingDays);\r\n  if (!leave.startDate || !leave.endDate) return new Map();\r\n\r\n  let start = parseLeaveBoundary(leave.startDate);\r\n  let end = parseLeaveBoundary(leave.endDate);\r\n  if (start > end) {\r\n    const temp = start;\r\n    start = end;\r\n    end = temp;\r\n  }\r\n\r\n  const monthMap: MonthDayMap = new Map();\r\n  for (let cursor = cloneDate(start); cursor <= end; cursor.setDate(cursor.getDate() + 1)) {\r\n    const dayOfWeek = cursor.getDay();\r\n    if (!workingDays.has(dayOfWeek)) {\r\n      continue;\r\n    }\r\n\r\n    const monthKey = buildMonthKey(cursor);\r\n    const entry: DayContext = { date: cloneDate(cursor), dayOfMonth: cursor.getDate() };\r\n    const existing = monthMap.get(monthKey);\r\n    if (existing) {\r\n      existing.push(entry);\r\n    } else {\r\n      monthMap.set(monthKey, [entry]);\r\n    }\r\n  }\r\n\r\n  return monthMap;\r\n};\r\n\r\nconst buildLeaveRecord = (leave: LeaveRequest): DailyRecord => ({\r\n  status: 'leave',\r\n  notes: buildLeaveNote(leave),\r\n});\r\n\r\nconst buildRevertedRecord = (context: DayContext): DailyRecord => {\r\n  const today = getCurrentDate();\r\n  if (context.date > today) {\r\n    return { status: 'future' };\r\n  }\r\n  return { status: 'absent' };\r\n};\r\n\r\nconst applyUpdatesForMonth = (monthKey: string, days: DayContext[], leave: LeaveRequest, mode: 'apply' | 'clear') => {\r\n  if (days.length === 0) return;\r\n\r\n  const attendanceStore = useAttendanceStore.getState();\r\n  const monthData = attendanceStore.getAttendanceData(monthKey);\r\n  if (!monthData?.length) return;\r\n\r\n  const [yearStr, monthStr] = monthKey.split('-');\r\n  const year = Number(yearStr) || new Date().getFullYear();\r\n  const month = Number(monthStr) || new Date().getMonth() + 1;\r\n  const settings = useEmployeeSettingsStore.getState().settings;\r\n\r\n  let didChange = false;\r\n  const updatedRows: AttendanceDataRow[] = monthData.map((row) => {\r\n    if (row.employeeSystemId !== leave.employeeSystemId) {\r\n      return row;\r\n    }\r\n\r\n    let rowChanged = false;\r\n    const mutableRow: AnyAttendanceDataRow = { ...row };\r\n\r\n    days.forEach((ctx) => {\r\n      const dayKey = `day_${ctx.dayOfMonth}` as AttendanceDayKey;\r\n      const currentRecord = mutableRow[dayKey] as DailyRecord | undefined;\r\n\r\n      if (mode === 'apply') {\r\n        mutableRow[dayKey] = buildLeaveRecord(leave);\r\n        rowChanged = true;\r\n        return;\r\n      }\r\n\r\n      if (mode === 'clear' && currentRecord && isSameLeaveNote(currentRecord, leave)) {\r\n        mutableRow[dayKey] = buildRevertedRecord(ctx);\r\n        rowChanged = true;\r\n      }\r\n    });\r\n\r\n    if (!rowChanged) {\r\n      return row;\r\n    }\r\n\r\n    didChange = true;\r\n    const summary = recalculateSummary(mutableRow, year, month, settings);\r\n    return { ...mutableRow, ...summary } as AttendanceDataRow;\r\n  });\r\n\r\n  if (didChange) {\r\n    attendanceStore.saveAttendanceData(monthKey, updatedRows);\r\n  }\r\n};\r\n\r\nexport const leaveAttendanceSync = {\r\n  apply(leave: LeaveRequest) {\r\n    const monthMap = collectWorkingDays(leave);\r\n    monthMap.forEach((days, monthKey) => applyUpdatesForMonth(monthKey, days, leave, 'apply'));\r\n  },\r\n  clear(leave: LeaveRequest) {\r\n    const monthMap = collectWorkingDays(leave);\r\n    monthMap.forEach((days, monthKey) => applyUpdatesForMonth(monthKey, days, leave, 'clear'));\r\n  },\r\n};\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1398, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/leaves/leave-quota-service.ts"],"sourcesContent":["import type { LeaveRequest } from './types';\r\nimport type { LeaveType } from '../settings/employees/types';\r\nimport { useEmployeeStore } from '../employees/store';\r\nimport { useEmployeeSettingsStore } from '../settings/employees/employee-settings-store';\r\nimport { getCurrentDate } from '../../lib/date-utils';\r\n\r\nconst clampNonNegative = (value: number) => (Number.isFinite(value) && value > 0 ? value : 0);\r\n\r\nconst resolveDelta = (leave: LeaveRequest) => {\r\n  const days = Number(leave.numberOfDays) || 0;\r\n  return days > 0 ? days : 0;\r\n};\r\n\r\ntype LeaveTypeMetadata = {\r\n  isPaid: boolean;\r\n  countsTowardsAnnual: boolean;\r\n};\r\n\r\nconst isAnnualLeaveType = (leaveType?: LeaveType | null) => {\r\n  if (!leaveType) return false;\r\n  const normalizedName = leaveType.name?.toLowerCase() ?? '';\r\n  const annualKeywords = ['phép năm', 'phep nam', 'annual'];\r\n  return annualKeywords.some((keyword) => normalizedName.includes(keyword));\r\n};\r\n\r\nconst resolveLeaveTypeMetadata = (leave: LeaveRequest): LeaveTypeMetadata => {\r\n  const settings = useEmployeeSettingsStore.getState().settings;\r\n  const matchedType = settings.leaveTypes.find((type) => {\r\n    if (leave.leaveTypeSystemId && type.systemId === leave.leaveTypeSystemId) return true;\r\n    if (leave.leaveTypeId && type.id === leave.leaveTypeId) return true;\r\n    return false;\r\n  });\r\n\r\n  const isPaid = typeof leave.leaveTypeIsPaid === 'boolean'\r\n    ? leave.leaveTypeIsPaid\r\n    : matchedType?.isPaid ?? true;\r\n\r\n  const countsTowardsAnnual = matchedType\r\n    ? isAnnualLeaveType(matchedType)\r\n    : isPaid;\r\n\r\n  return {\r\n    isPaid,\r\n    countsTowardsAnnual,\r\n  } satisfies LeaveTypeMetadata;\r\n};\r\n\r\nconst getServiceYears = (hireDate?: string) => {\r\n  if (!hireDate) return 0;\r\n  const parsed = new Date(hireDate);\r\n  if (Number.isNaN(parsed.getTime())) return 0;\r\n  const today = getCurrentDate();\r\n  let years = today.getFullYear() - parsed.getFullYear();\r\n  const hasNotReachedAnniversary =\r\n    today.getMonth() < parsed.getMonth() ||\r\n    (today.getMonth() === parsed.getMonth() && today.getDate() < parsed.getDate());\r\n  if (hasNotReachedAnniversary) {\r\n    years -= 1;\r\n  }\r\n  return Math.max(years, 0);\r\n};\r\n\r\nconst computeAnnualQuota = (employeeHireDate?: string) => {\r\n  const { baseAnnualLeaveDays, annualLeaveSeniorityBonus } = useEmployeeSettingsStore.getState().settings;\r\n  const base = baseAnnualLeaveDays ?? 0;\r\n  if (!annualLeaveSeniorityBonus) {\r\n    return clampNonNegative(base);\r\n  }\r\n  const years = getServiceYears(employeeHireDate);\r\n  const bonusInterval = annualLeaveSeniorityBonus.years || 0;\r\n  const bonusValue = annualLeaveSeniorityBonus.additionalDays || 0;\r\n  const bonusMultiplier = bonusInterval > 0 ? Math.floor(years / bonusInterval) : 0;\r\n  const bonus = bonusMultiplier * bonusValue;\r\n  return clampNonNegative(base + bonus);\r\n};\r\n\r\nconst adjustLeaveUsage = (leave: LeaveRequest, delta: number) => {\r\n  if (!delta) return;\r\n  const employeeStore = useEmployeeStore.getState();\r\n  const employee = employeeStore.findById(leave.employeeSystemId);\r\n  if (!employee) return;\r\n\r\n  const { isPaid, countsTowardsAnnual } = resolveLeaveTypeMetadata(leave);\r\n  const totalDelta = delta;\r\n  const paidDelta = isPaid ? delta : 0;\r\n  const unpaidDelta = isPaid ? 0 : delta;\r\n  const annualDelta = countsTowardsAnnual ? delta : 0;\r\n\r\n  const nextLeaveTaken = clampNonNegative((employee.leaveTaken ?? 0) + totalDelta);\r\n  const nextPaid = clampNonNegative((employee.paidLeaveTaken ?? 0) + paidDelta);\r\n  const nextUnpaid = clampNonNegative((employee.unpaidLeaveTaken ?? 0) + unpaidDelta);\r\n  const nextAnnual = clampNonNegative((employee.annualLeaveTaken ?? 0) + annualDelta);\r\n  const quota = computeAnnualQuota(employee.hireDate);\r\n  const nextBalance = clampNonNegative(quota - nextAnnual);\r\n\r\n  const hasChanges =\r\n    nextLeaveTaken !== (employee.leaveTaken ?? 0) ||\r\n    nextPaid !== (employee.paidLeaveTaken ?? 0) ||\r\n    nextUnpaid !== (employee.unpaidLeaveTaken ?? 0) ||\r\n    nextAnnual !== (employee.annualLeaveTaken ?? 0) ||\r\n    nextBalance !== (employee.annualLeaveBalance ?? quota);\r\n\r\n  if (!hasChanges) return;\r\n\r\n  employeeStore.update(leave.employeeSystemId, {\r\n    ...employee,\r\n    leaveTaken: nextLeaveTaken,\r\n    paidLeaveTaken: nextPaid,\r\n    unpaidLeaveTaken: nextUnpaid,\r\n    annualLeaveTaken: nextAnnual,\r\n    annualLeaveBalance: nextBalance,\r\n  });\r\n};\r\n\r\nexport const leaveQuotaSync = {\r\n  apply(leave: LeaveRequest) {\r\n    const delta = resolveDelta(leave);\r\n    if (!delta) return;\r\n    adjustLeaveUsage(leave, delta);\r\n  },\r\n  clear(leave: LeaveRequest) {\r\n    const delta = resolveDelta(leave);\r\n    if (!delta) return;\r\n    adjustLeaveUsage(leave, -delta);\r\n  },\r\n};\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1508, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/leaves/store.ts"],"sourcesContent":["import { createCrudStore, type CrudState } from '../../lib/store-factory';\r\n// REMOVED: import { data as initialData } from './data'; // Mock data no longer used - database is source of truth\r\nimport type { LeaveRequest } from './types';\r\nimport { leaveAttendanceSync } from './leave-sync-service';\r\nimport { leaveQuotaSync } from './leave-quota-service';\r\n\r\nexport type LeaveStoreState = CrudState<LeaveRequest>;\r\n\r\nconst baseStore = createCrudStore<LeaveRequest>([], 'leaves', {\r\n\tbusinessIdField: 'id',\r\n\tapiEndpoint: '/api/leaves',\r\n});\r\n\r\nconst isApproved = (leave?: LeaveRequest | null): leave is LeaveRequest =>\r\n\tBoolean(leave && leave.status === 'Đã duyệt');\r\n\r\nconst snapshotLeave = (leave?: LeaveRequest | null): LeaveRequest | undefined =>\r\n\tleave ? { ...leave } : undefined;\r\n\r\nconst syncApprovedLeave = {\r\n\tapply: (leave: LeaveRequest) => {\r\n\t\tleaveAttendanceSync.apply(leave);\r\n\t\tleaveQuotaSync.apply(leave);\r\n\t},\r\n\tclear: (leave: LeaveRequest) => {\r\n\t\tleaveAttendanceSync.clear(leave);\r\n\t\tleaveQuotaSync.clear(leave);\r\n\t},\r\n};\r\n\r\nconst syncAwareActions: Pick<LeaveStoreState, 'add' | 'update' | 'remove' | 'restore' | 'hardDelete'> = {\r\n\tadd: (payload) => {\r\n\t\tconst created = baseStore.getState().add(payload);\r\n\t\tif (isApproved(created)) {\r\n\t\t\tsyncApprovedLeave.apply(created);\r\n\t\t}\r\n\t\treturn created;\r\n\t},\r\n\tupdate: (systemId, next) => {\r\n\t\tconst store = baseStore.getState();\r\n\t\tconst previous = snapshotLeave(store.findById(systemId));\r\n\t\tstore.update(systemId, next);\r\n\t\tconst updated = snapshotLeave(baseStore.getState().findById(systemId));\r\n\t\tif (isApproved(previous)) {\r\n\t\t\tsyncApprovedLeave.clear(previous);\r\n\t\t}\r\n\t\tif (isApproved(updated)) {\r\n\t\t\tsyncApprovedLeave.apply(updated);\r\n\t\t}\r\n\t},\r\n\tremove: (systemId) => {\r\n\t\tconst store = baseStore.getState();\r\n\t\tconst target = snapshotLeave(store.findById(systemId));\r\n\t\tstore.remove(systemId);\r\n\t\tif (isApproved(target)) {\r\n\t\t\tsyncApprovedLeave.clear(target);\r\n\t\t}\r\n\t},\r\n\trestore: (systemId) => {\r\n\t\tconst store = baseStore.getState();\r\n\t\tstore.restore(systemId);\r\n\t\tconst restored = snapshotLeave(baseStore.getState().findById(systemId));\r\n\t\tif (isApproved(restored)) {\r\n\t\t\tsyncApprovedLeave.apply(restored);\r\n\t\t}\r\n\t},\r\n\thardDelete: (systemId) => {\r\n\t\tconst store = baseStore.getState();\r\n\t\tconst target = snapshotLeave(store.findById(systemId));\r\n\t\tstore.hardDelete(systemId);\r\n\t\tif (isApproved(target)) {\r\n\t\t\tsyncApprovedLeave.clear(target);\r\n\t\t}\r\n\t},\r\n};\r\n\r\nconst withSync = (state: LeaveStoreState): LeaveStoreState => ({\r\n\t...state,\r\n\t...syncAwareActions,\r\n});\r\n\r\nexport const useLeaveStore = () => withSync(baseStore());\r\n\r\nuseLeaveStore.getState = () => withSync(baseStore.getState());\r\n"],"names":[],"mappings":";;;;AAAA;AAGA;AACA;;;;AAIA,MAAM,YAAY,IAAA,6IAAe,EAAe,EAAE,EAAE,UAAU;IAC7D,iBAAiB;IACjB,aAAa;AACd;AAEA,MAAM,aAAa,CAAC,QACnB,QAAQ,SAAS,MAAM,MAAM,KAAK;AAEnC,MAAM,gBAAgB,CAAC,QACtB,QAAQ;QAAE,GAAG,KAAK;IAAC,IAAI;AAExB,MAAM,oBAAoB;IACzB,OAAO,CAAC;QACP,wKAAmB,CAAC,KAAK,CAAC;QAC1B,oKAAc,CAAC,KAAK,CAAC;IACtB;IACA,OAAO,CAAC;QACP,wKAAmB,CAAC,KAAK,CAAC;QAC1B,oKAAc,CAAC,KAAK,CAAC;IACtB;AACD;AAEA,MAAM,mBAAkG;IACvG,KAAK,CAAC;QACL,MAAM,UAAU,UAAU,QAAQ,GAAG,GAAG,CAAC;QACzC,IAAI,WAAW,UAAU;YACxB,kBAAkB,KAAK,CAAC;QACzB;QACA,OAAO;IACR;IACA,QAAQ,CAAC,UAAU;QAClB,MAAM,QAAQ,UAAU,QAAQ;QAChC,MAAM,WAAW,cAAc,MAAM,QAAQ,CAAC;QAC9C,MAAM,MAAM,CAAC,UAAU;QACvB,MAAM,UAAU,cAAc,UAAU,QAAQ,GAAG,QAAQ,CAAC;QAC5D,IAAI,WAAW,WAAW;YACzB,kBAAkB,KAAK,CAAC;QACzB;QACA,IAAI,WAAW,UAAU;YACxB,kBAAkB,KAAK,CAAC;QACzB;IACD;IACA,QAAQ,CAAC;QACR,MAAM,QAAQ,UAAU,QAAQ;QAChC,MAAM,SAAS,cAAc,MAAM,QAAQ,CAAC;QAC5C,MAAM,MAAM,CAAC;QACb,IAAI,WAAW,SAAS;YACvB,kBAAkB,KAAK,CAAC;QACzB;IACD;IACA,SAAS,CAAC;QACT,MAAM,QAAQ,UAAU,QAAQ;QAChC,MAAM,OAAO,CAAC;QACd,MAAM,WAAW,cAAc,UAAU,QAAQ,GAAG,QAAQ,CAAC;QAC7D,IAAI,WAAW,WAAW;YACzB,kBAAkB,KAAK,CAAC;QACzB;IACD;IACA,YAAY,CAAC;QACZ,MAAM,QAAQ,UAAU,QAAQ;QAChC,MAAM,SAAS,cAAc,MAAM,QAAQ,CAAC;QAC5C,MAAM,UAAU,CAAC;QACjB,IAAI,WAAW,SAAS;YACvB,kBAAkB,KAAK,CAAC;QACzB;IACD;AACD;AAEA,MAAM,WAAW,CAAC,QAA4C,CAAC;QAC9D,GAAG,KAAK;QACR,GAAG,gBAAgB;IACpB,CAAC;AAEM,MAAM,gBAAgB,IAAM,SAAS;AAE5C,cAAc,QAAQ,GAAG,IAAM,SAAS,UAAU,QAAQ"}},
    {"offset": {"line": 1594, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/tasks/store.ts"],"sourcesContent":["import { createCrudStore } from '../../lib/store-factory';\r\n// REMOVED: import { data as initialData } from './data'; // Mock data no longer used - database is source of truth\r\nimport type { Task, TaskActivity, TaskStatus, TaskPriority, TaskAssignee, AssigneeRole } from './types';\r\nimport { getCurrentUserInfo } from '../../contexts/auth-context';\r\nimport { asSystemId, type SystemId } from '../../lib/id-types';\r\nimport { saveActiveTimer, removeActiveTimer, getActiveTimerSync } from '../../lib/active-timer-sync';\r\n\r\nconst baseStore = createCrudStore<Task>([], 'internal-tasks', {\r\n  apiEndpoint: '/api/tasks',\r\n});\r\n\r\n// Migrate existing tasks to multiple assignees format\r\nconst migrateTasksToMultipleAssignees = (tasks: Task[]): Task[] => {\r\n  return tasks.map(task => {\r\n    // Ensure startDate exists for all tasks\r\n    const taskWithStartDate = {\r\n      ...task,\r\n      startDate: task.startDate || task.createdAt?.split('T')[0] || new Date().toISOString().split('T')[0],\r\n    };\r\n    \r\n    // Skip if already has assignees array\r\n    if (taskWithStartDate.assignees && taskWithStartDate.assignees.length > 0) {\r\n      return taskWithStartDate;\r\n    }\r\n    \r\n    // Migrate single assignee to array format\r\n    if (taskWithStartDate.assigneeId && taskWithStartDate.assigneeName) {\r\n      const assignee: TaskAssignee = {\r\n        systemId: asSystemId(`assignee-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`),\r\n        employeeSystemId: taskWithStartDate.assigneeId,\r\n        employeeName: taskWithStartDate.assigneeName,\r\n        role: 'owner',\r\n        assignedAt: taskWithStartDate.createdAt || new Date().toISOString(),\r\n        assignedBy: taskWithStartDate.assignerId || taskWithStartDate.createdBy || asSystemId('SYSTEM'),\r\n      };\r\n      \r\n      return {\r\n        ...taskWithStartDate,\r\n        assignees: [assignee],\r\n      };\r\n    }\r\n    \r\n    // No assignee\r\n    return {\r\n      ...taskWithStartDate,\r\n      assignees: [],\r\n    };\r\n  });\r\n};\r\n\r\n// Run migration on store initialization\r\nconst migratedData: Task[] = []; // Database is source of truth\r\n\r\n// Initialize store with migrated data\r\nconst taskStoreInstance = createCrudStore<Task>(migratedData, 'internal-tasks', {\r\n  apiEndpoint: '/api/tasks',\r\n});\r\n\r\n// Helper to create activity log\r\nconst createActivity = (\r\n  taskId: string,\r\n  action: TaskActivity['action'],\r\n  details?: Partial<TaskActivity>\r\n): TaskActivity => {\r\n  const user = getCurrentUserInfo();\r\n  return {\r\n    id: `activity-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,\r\n    taskId,\r\n    userId: user.systemId,\r\n    userName: user.name,\r\n    action,\r\n    timestamp: new Date().toISOString(),\r\n    ...details,\r\n  };\r\n};\r\n\r\n// Helper to generate human-readable description\r\nconst getActivityDescription = (activity: TaskActivity): string => {\r\n  const { action, userName, oldValue, newValue, fieldName } = activity;\r\n  \r\n  switch (action) {\r\n    case 'created':\r\n      return `${userName} đã tạo công việc`;\r\n    case 'assigned':\r\n      return `${userName} đã giao việc cho ${newValue}`;\r\n    case 'assignee_added':\r\n      return `${userName} đã thêm ${newValue} vào công việc`;\r\n    case 'assignee_removed':\r\n      return `${userName} đã xóa ${newValue} khỏi công việc`;\r\n    case 'status_changed':\r\n      return `${userName} đã thay đổi trạng thái từ \"${oldValue}\" sang \"${newValue}\"`;\r\n    case 'priority_changed':\r\n      return `${userName} đã thay đổi độ ưu tiên từ \"${oldValue}\" sang \"${newValue}\"`;\r\n    case 'progress_updated':\r\n      return `${userName} đã cập nhật tiến độ: ${newValue}%`;\r\n    case 'timer_started':\r\n      return `${userName} đã bắt đầu đếm giờ`;\r\n    case 'timer_stopped':\r\n      return `${userName} đã dừng đếm giờ (${newValue})`;\r\n    case 'subtask_completed':\r\n      return `${userName} đã hoàn thành: \"${newValue}\"`;\r\n    case 'subtask_uncompleted':\r\n      return `${userName} đã bỏ hoàn thành: \"${newValue}\"`;\r\n    case 'completed':\r\n      return `${userName} đã hoàn thành công việc`;\r\n    case 'commented':\r\n      return `${userName} đã thêm bình luận`;\r\n    case 'evidence_submitted':\r\n      return `${userName} đã gửi bằng chứng hoàn thành`;\r\n    case 'evidence_approved':\r\n      return `${userName} đã phê duyệt công việc`;\r\n    case 'evidence_rejected':\r\n      return `${userName} đã yêu cầu làm lại`;\r\n    case 'updated':\r\n      return fieldName \r\n        ? `${userName} đã cập nhật ${fieldName}`\r\n        : `${userName} đã cập nhật công việc`;\r\n    default:\r\n      return `${userName} đã thực hiện hành động`;\r\n  }\r\n};\r\n\r\nexport const useTaskStore = () => {\r\n  const store = taskStoreInstance();\r\n  \r\n  // Auto timer management helper\r\n  const autoManageTimer = (task: Task, updates: Partial<Task>) => {\r\n    const newStatus = updates.status || task.status;\r\n    const newSubtasks = updates.subtasks || task.subtasks || [];\r\n    const activities: TaskActivity[] = [...(task.activities || [])];\r\n    \r\n    // Check if all subtasks completed\r\n    const allSubtasksCompleted = newSubtasks.length > 0 && \r\n      newSubtasks.every(s => s.completed);\r\n    \r\n    // Track status change\r\n    if (updates.status && updates.status !== task.status) {\r\n      const activity = createActivity(task.systemId, 'status_changed', {\r\n        oldValue: task.status,\r\n        newValue: updates.status,\r\n      });\r\n      activity.description = getActivityDescription(activity);\r\n      activities.push(activity);\r\n    }\r\n    \r\n    // Track priority change\r\n    if (updates.priority && updates.priority !== task.priority) {\r\n      const activity = createActivity(task.systemId, 'priority_changed', {\r\n        oldValue: task.priority,\r\n        newValue: updates.priority,\r\n      });\r\n      activity.description = getActivityDescription(activity);\r\n      activities.push(activity);\r\n    }\r\n    \r\n    // Track subtask completion\r\n    if (updates.subtasks) {\r\n      const oldSubtasks = task.subtasks || [];\r\n      updates.subtasks.forEach((newSub, idx) => {\r\n        const oldSub = oldSubtasks[idx];\r\n        if (oldSub && newSub.completed !== oldSub.completed) {\r\n          const activity = createActivity(\r\n            task.systemId, \r\n            newSub.completed ? 'subtask_completed' : 'subtask_uncompleted',\r\n            { newValue: newSub.title }\r\n          );\r\n          activity.description = getActivityDescription(activity);\r\n          activities.push(activity);\r\n        }\r\n      });\r\n    }\r\n    \r\n    // Auto start timer: status = \"Đang thực hiện\" và chưa có timer\r\n    if (newStatus === 'Đang thực hiện' && !task.timerRunning) {\r\n      const activity = createActivity(task.systemId, 'timer_started');\r\n      activity.description = getActivityDescription(activity);\r\n      activities.push(activity);\r\n      \r\n      return {\r\n        ...updates,\r\n        timerRunning: true,\r\n        timerStartedAt: new Date().toISOString(),\r\n        activities,\r\n      };\r\n    }\r\n    \r\n    // Auto stop timer: Hoàn thành hết subtasks hoặc status = \"Hoàn thành\"\r\n    if (task.timerRunning && (allSubtasksCompleted || newStatus === 'Hoàn thành')) {\r\n      const elapsed = task.timerStartedAt \r\n        ? Math.floor((Date.now() - new Date(task.timerStartedAt).getTime()) / 1000)\r\n        : 0;\r\n      \r\n      const newTotalSeconds = (task.totalTrackedSeconds || 0) + elapsed;\r\n      const actualHours = (newTotalSeconds / 3600).toFixed(1);\r\n      \r\n      const timerActivity = createActivity(task.systemId, 'timer_stopped', {\r\n        newValue: `${actualHours}h`,\r\n      });\r\n      timerActivity.description = getActivityDescription(timerActivity);\r\n      activities.push(timerActivity);\r\n      \r\n      // Log completion if all subtasks done\r\n      if (allSubtasksCompleted) {\r\n        const completedActivity = createActivity(task.systemId, 'completed');\r\n        completedActivity.description = getActivityDescription(completedActivity);\r\n        activities.push(completedActivity);\r\n      }\r\n      \r\n      return {\r\n        ...updates,\r\n        timerRunning: false,\r\n        timerStartedAt: undefined,\r\n        totalTrackedSeconds: newTotalSeconds,\r\n        actualHours: newTotalSeconds / 3600,\r\n        status: allSubtasksCompleted ? 'Hoàn thành' : newStatus,\r\n        progress: allSubtasksCompleted ? 100 : (updates.progress || task.progress),\r\n        completedDate: allSubtasksCompleted ? new Date().toISOString().split('T')[0] : task.completedDate,\r\n        activities,\r\n      };\r\n    }\r\n    \r\n    return { ...updates, activities };\r\n  };\r\n  \r\n  return {\r\n    ...store,\r\n    // Override add to log creation activity\r\n    add: (newTask: Omit<Task, 'systemId'>) => {\r\n      // Ensure startDate is always set\r\n      const taskWithDefaults = {\r\n        ...newTask,\r\n        startDate: newTask.startDate || new Date().toISOString().split('T')[0],\r\n      };\r\n      \r\n      const result = store.add(taskWithDefaults);\r\n      if (result) {\r\n        const activity = createActivity(result.systemId, 'created');\r\n        activity.description = getActivityDescription(activity);\r\n        \r\n        // Log assignment if assignee exists\r\n        if (result.assigneeName) {\r\n          const assignActivity = createActivity(result.systemId, 'assigned', {\r\n            newValue: result.assigneeName,\r\n          });\r\n          assignActivity.description = getActivityDescription(assignActivity);\r\n          \r\n          store.update(result.systemId as any, {\r\n            ...result,\r\n            activities: [activity, assignActivity],\r\n          });\r\n        } else {\r\n          store.update(result.systemId as any, {\r\n            ...result,\r\n            activities: [activity],\r\n          });\r\n        }\r\n      }\r\n      return result;\r\n    },\r\n    // Override update to include auto timer logic and activity logging\r\n    update: (id: any, updates: Partial<Task>) => {\r\n      console.log('[STORE] Update called with id:', id, 'updates:', updates);\r\n      const task = store.findById(id);\r\n      if (!task) {\r\n        console.log('[STORE] Task not found!');\r\n        return;\r\n      }\r\n      \r\n      const enhancedUpdates = autoManageTimer(task, updates);\r\n      console.log('[STORE] Enhanced updates:', enhancedUpdates);\r\n      store.update(id, { ...task, ...enhancedUpdates });\r\n      console.log('[STORE] Base store.update called');\r\n      \r\n      // Manage active timer - sync with database\r\n      const user = getCurrentUserInfo();\r\n      if (enhancedUpdates.timerRunning && enhancedUpdates.timerStartedAt) {\r\n        // Save to both localStorage (cache) and database\r\n        saveActiveTimer(\r\n          user.systemId,\r\n          task.systemId,\r\n          enhancedUpdates.timerStartedAt,\r\n          task.title\r\n        ).catch(console.error);\r\n      } else if (enhancedUpdates.timerRunning === false) {\r\n        // Remove from both localStorage and database\r\n        removeActiveTimer(user.systemId).catch(console.error);\r\n      }\r\n    },\r\n    // Get tasks assigned to specific user\r\n    getMyTasks: (userId: SystemId) => {\r\n      return store.data.filter(task => \r\n        task.assignees?.some(a => a.employeeSystemId === userId) || \r\n        task.assigneeId === userId // Backward compatibility\r\n      );\r\n    },\r\n    // Get tasks created by specific user (assigner)\r\n    getCreatedByMe: (userId: SystemId) => {\r\n      return store.data.filter(task => task.assignerId === userId);\r\n    },\r\n    // Add assignee to task\r\n    addAssignee: (taskId: string, employeeId: SystemId, employeeName: string, role: AssigneeRole = 'contributor') => {\r\n      const task = store.findById(taskId as any);\r\n      if (!task) return;\r\n      \r\n      const user = getCurrentUserInfo();\r\n      const assignees = task.assignees || [];\r\n      \r\n      // Check if already assigned\r\n      if (assignees.some(a => a.employeeSystemId === employeeId)) {\r\n        return;\r\n      }\r\n      \r\n      const newAssignee: TaskAssignee = {\r\n        systemId: asSystemId(`assignee-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`),\r\n        employeeSystemId: employeeId,\r\n        employeeName,\r\n        role,\r\n        assignedAt: new Date().toISOString(),\r\n        assignedBy: asSystemId(user.systemId),\r\n      };\r\n      \r\n      const updatedAssignees = [...assignees, newAssignee];\r\n      const activities = [...(task.activities || [])];\r\n      \r\n      const activity = createActivity(taskId, 'assignee_added', {\r\n        newValue: `${employeeName} (${role})`,\r\n      });\r\n      activity.description = getActivityDescription(activity);\r\n      activities.push(activity);\r\n      \r\n      // Update backward compatibility fields\r\n      const owner = updatedAssignees.find(a => a.role === 'owner') || updatedAssignees[0];\r\n      \r\n      store.update(taskId as any, {\r\n        ...task,\r\n        assignees: updatedAssignees,\r\n        assigneeId: (owner?.employeeSystemId ?? asSystemId('')),\r\n        assigneeName: owner?.employeeName || '',\r\n        activities,\r\n      });\r\n    },\r\n    // Remove assignee from task\r\n    removeAssignee: (taskId: string, employeeId: SystemId) => {\r\n      const task = store.findById(taskId as any);\r\n      if (!task) return;\r\n      \r\n      const assignees = task.assignees || [];\r\n      const removedAssignee = assignees.find(a => a.employeeSystemId === employeeId);\r\n      \r\n      if (!removedAssignee) return;\r\n      \r\n      const updatedAssignees = assignees.filter(a => a.employeeSystemId !== employeeId);\r\n      const activities = [...(task.activities || [])];\r\n      \r\n      const activity = createActivity(taskId, 'assignee_removed', {\r\n        newValue: removedAssignee.employeeName,\r\n      });\r\n      activity.description = getActivityDescription(activity);\r\n      activities.push(activity);\r\n      \r\n      // Update backward compatibility fields\r\n      const owner = updatedAssignees.find(a => a.role === 'owner') || updatedAssignees[0];\r\n      \r\n      store.update(taskId as any, {\r\n        ...task,\r\n        assignees: updatedAssignees,\r\n        assigneeId: owner?.employeeSystemId || asSystemId(''),\r\n        assigneeName: owner?.employeeName || '',\r\n        activities,\r\n      });\r\n    },\r\n    // Update assignee role\r\n    updateAssigneeRole: (taskId: string, employeeId: SystemId, newRole: AssigneeRole) => {\r\n      const task = store.findById(taskId as any);\r\n      if (!task) return;\r\n      \r\n      const assignees = task.assignees || [];\r\n      const assigneeIndex = assignees.findIndex(a => a.employeeSystemId === employeeId);\r\n      \r\n      if (assigneeIndex === -1) return;\r\n      \r\n      const updatedAssignees = [...assignees];\r\n      updatedAssignees[assigneeIndex] = {\r\n        ...updatedAssignees[assigneeIndex],\r\n        role: newRole,\r\n      };\r\n      \r\n      // Update backward compatibility fields if owner changed\r\n      const owner = updatedAssignees.find(a => a.role === 'owner') || updatedAssignees[0];\r\n      \r\n      store.update(taskId as any, {\r\n        ...task,\r\n        assignees: updatedAssignees,\r\n        assigneeId: owner?.employeeSystemId || asSystemId(''),\r\n        assigneeName: owner?.employeeName || '',\r\n      });\r\n    },\r\n    // Restore running timer on page load\r\n    restoreTimer: () => {\r\n      const stored = getActiveTimerSync();\r\n      if (!stored) return;\r\n      \r\n      try {\r\n        const { taskId, startedAt } = stored;\r\n        const task = store.findById(taskId as any);\r\n        if (!task) {\r\n          // Task not found, clean up\r\n          const user = getCurrentUserInfo();\r\n          removeActiveTimer(user.systemId).catch(console.error);\r\n          return;\r\n        }\r\n        \r\n        // Calculate elapsed time\r\n        const elapsed = Math.floor((Date.now() - new Date(startedAt).getTime()) / 1000);\r\n        \r\n        store.update(taskId as any, {\r\n          ...task,\r\n          timerRunning: true,\r\n          timerStartedAt: startedAt,\r\n          totalTrackedSeconds: (task.totalTrackedSeconds || 0),\r\n        });\r\n      } catch (e) {\r\n        // Clean up on error\r\n        const user = getCurrentUserInfo();\r\n        removeActiveTimer(user.systemId).catch(console.error);\r\n      }\r\n    },\r\n    \r\n    // Approve task completion\r\n    approveTask: (taskId: string) => {\r\n      const task = store.findById(taskId as any);\r\n      if (!task) return;\r\n      \r\n      const user = getCurrentUserInfo();\r\n      const activity = createActivity(taskId, 'evidence_approved', {\r\n        description: `${user.name} đã phê duyệt công việc`,\r\n      });\r\n      \r\n      const approvalRecord = {\r\n        id: `approval-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,\r\n        status: 'approved' as const,\r\n        reviewedBy: user.systemId,\r\n        reviewedByName: user.name,\r\n        reviewedAt: new Date().toISOString(),\r\n      };\r\n      \r\n      store.update(taskId as any, {\r\n        ...task,\r\n        status: 'Hoàn thành',\r\n        completedDate: new Date().toISOString(),\r\n        approvalStatus: 'approved',\r\n        rejectionReason: undefined,\r\n        approvalHistory: [...(task.approvalHistory || []), approvalRecord],\r\n        activities: [...(task.activities || []), activity],\r\n      });\r\n    },\r\n    \r\n    // Reject task completion\r\n    rejectTask: (taskId: string, reason: string) => {\r\n      const task = store.findById(taskId as any);\r\n      if (!task) return;\r\n      \r\n      const user = getCurrentUserInfo();\r\n      const activity = createActivity(taskId, 'evidence_rejected', {\r\n        description: `${user.name} đã yêu cầu làm lại: ${reason}`,\r\n      });\r\n      \r\n      const approvalRecord = {\r\n        id: `approval-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,\r\n        status: 'rejected' as const,\r\n        reviewedBy: user.systemId,\r\n        reviewedByName: user.name,\r\n        reviewedAt: new Date().toISOString(),\r\n        reason,\r\n      };\r\n      \r\n      store.update(taskId as any, {\r\n        ...task,\r\n        status: 'Đang thực hiện',\r\n        approvalStatus: 'rejected',\r\n        rejectionReason: reason,\r\n        approvalHistory: [...(task.approvalHistory || []), approvalRecord],\r\n        activities: [...(task.activities || []), activity],\r\n      });\r\n    },\r\n  };\r\n};\r\n"],"names":[],"mappings":"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"}}]
}