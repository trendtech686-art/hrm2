{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/employees/store.ts"],"sourcesContent":["import { createCrudStore, CrudState } from '../../lib/store-factory';\r\n// REMOVED: import { data as initialData } from './data'; // Mock data no longer used - database is source of truth\r\nimport type { Employee } from './types';\r\nimport type { HistoryEntry } from '../../components/ActivityHistory';\r\nimport Fuse from 'fuse.js';\r\nimport { getCurrentUserSystemId } from '../../contexts/auth-context';\r\nimport { registerBreadcrumbStore } from '../../lib/breadcrumb-generator'; // ✅ NEW\r\nimport { type SystemId } from '../../lib/id-types';\r\nimport { createInMemoryRepository } from '../../repositories/in-memory-repository';\r\nimport { \r\n  createHistoryEntry, \r\n  getCurrentUserInfo,\r\n  appendHistoryEntry \r\n} from '../../lib/activity-history-helper';\r\n\r\ntype EmployeePersistenceAdapter = {\r\n  create: (payload: Omit<Employee, 'systemId'>) => Promise<Employee>;\r\n  update: (systemId: SystemId, payload: Partial<Employee>) => Promise<Employee>;\r\n  softDelete: (systemId: SystemId) => Promise<void>;\r\n  restore: (systemId: SystemId) => Promise<Employee | undefined>;\r\n  hardDelete: (systemId: SystemId) => Promise<void>;\r\n};\r\n\r\nconst baseStore = createCrudStore<Employee>([], 'employees', {\r\n  businessIdField: 'id',\r\n  getCurrentUser: getCurrentUserSystemId, // ✅ Track who creates/updates\r\n  apiEndpoint: '/api/employees',\r\n});\r\n\r\n// ✅ Wrap add method to include activity history\r\nconst originalAdd = baseStore.getState().add;\r\nconst wrappedAdd = (item: Omit<Employee, 'systemId'>): Employee => {\r\n  const userInfo = getCurrentUserInfo();\r\n  const historyEntry = createHistoryEntry(\r\n    'created',\r\n    `${userInfo.name} đã tạo hồ sơ nhân viên ${item.fullName} (${item.id})`,\r\n    userInfo\r\n  );\r\n  \r\n  const newEmployee = originalAdd({\r\n    ...item,\r\n    activityHistory: [historyEntry],\r\n  });\r\n  \r\n  return newEmployee;\r\n};\r\n\r\n// ✅ Wrap update method to include activity history\r\nconst originalUpdate = baseStore.getState().update;\r\nconst wrappedUpdate = (systemId: SystemId, updates: Partial<Employee>): void => {\r\n  const currentEmployee = baseStore.getState().data.find(e => e.systemId === systemId);\r\n  if (!currentEmployee) return;\r\n  \r\n  const userInfo = getCurrentUserInfo();\r\n  const historyEntries: HistoryEntry[] = [];\r\n  \r\n  // Track important field changes\r\n  const trackedFields: { key: keyof Employee; label: string }[] = [\r\n    { key: 'fullName', label: 'họ tên' },\r\n    { key: 'jobTitle', label: 'chức danh' },\r\n    { key: 'department', label: 'phòng ban' },\r\n    { key: 'employmentStatus', label: 'trạng thái làm việc' },\r\n    { key: 'employeeType', label: 'loại nhân viên' },\r\n    { key: 'baseSalary', label: 'lương cơ bản' },\r\n    { key: 'phone', label: 'số điện thoại' },\r\n    { key: 'workEmail', label: 'email công việc' },\r\n    { key: 'role', label: 'vai trò' },\r\n  ];\r\n  \r\n  trackedFields.forEach(({ key, label }) => {\r\n    if (updates[key] !== undefined && updates[key] !== currentEmployee[key]) {\r\n      const oldValue = currentEmployee[key];\r\n      const newValue = updates[key];\r\n      \r\n      // Format values for display\r\n      let oldDisplay = oldValue;\r\n      let newDisplay = newValue;\r\n      \r\n      if (key === 'baseSalary') {\r\n        oldDisplay = new Intl.NumberFormat('vi-VN').format(oldValue as number) + 'đ';\r\n        newDisplay = new Intl.NumberFormat('vi-VN').format(newValue as number) + 'đ';\r\n      }\r\n      \r\n      historyEntries.push(createHistoryEntry(\r\n        'updated',\r\n        `${userInfo.name} đã cập nhật ${label}: \"${oldDisplay || '(trống)'}\" → \"${newDisplay}\"`,\r\n        userInfo,\r\n        { field: key, oldValue, newValue }\r\n      ));\r\n    }\r\n  });\r\n  \r\n  // If status changed specifically\r\n  if (updates.employmentStatus && updates.employmentStatus !== currentEmployee.employmentStatus) {\r\n    historyEntries.push(createHistoryEntry(\r\n      'status_changed',\r\n      `${userInfo.name} đã thay đổi trạng thái làm việc từ \"${currentEmployee.employmentStatus}\" thành \"${updates.employmentStatus}\"`,\r\n      userInfo,\r\n      { field: 'employmentStatus', oldValue: currentEmployee.employmentStatus, newValue: updates.employmentStatus }\r\n    ));\r\n  }\r\n  \r\n  // If no specific changes tracked, add generic update entry\r\n  if (historyEntries.length === 0) {\r\n    historyEntries.push(createHistoryEntry(\r\n      'updated',\r\n      `${userInfo.name} đã cập nhật thông tin nhân viên`,\r\n      userInfo\r\n    ));\r\n  }\r\n  \r\n  const updatedHistory = appendHistoryEntry(currentEmployee.activityHistory, ...historyEntries);\r\n  \r\n  originalUpdate(systemId, {\r\n    ...updates,\r\n    activityHistory: updatedHistory,\r\n  });\r\n};\r\n\r\n// ✅ Override base store methods\r\nbaseStore.setState({\r\n  add: wrappedAdd,\r\n  update: wrappedUpdate,\r\n});\r\n\r\nexport const employeeRepository = createInMemoryRepository<Employee>(() => baseStore.getState());\r\n\r\n// ✅ API-backed persistence adapter - syncs to PostgreSQL\r\nconst API_ENDPOINT = '/api/employees';\r\n\r\nconst persistence: EmployeePersistenceAdapter = {\r\n  create: async (payload) => {\r\n    // First create locally for immediate UI update\r\n    const localResult = await employeeRepository.create(payload);\r\n    \r\n    // Then sync to API (background)\r\n    try {\r\n      const response = await fetch(API_ENDPOINT, {\r\n        method: 'POST',\r\n        credentials: 'include',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({ ...payload, systemId: localResult.systemId }),\r\n      });\r\n      if (!response.ok) {\r\n        console.warn('[Employee API] Create sync failed, data saved locally');\r\n      } else {\r\n        console.log('[Employee API] Created:', localResult.systemId);\r\n      }\r\n    } catch (e) {\r\n      console.warn('[Employee API] Create sync error:', e);\r\n    }\r\n    \r\n    return localResult;\r\n  },\r\n  update: async (systemId, payload) => {\r\n    // First update locally\r\n    const localResult = await employeeRepository.update(systemId, payload);\r\n    \r\n    // Then sync to API\r\n    try {\r\n      const response = await fetch(`${API_ENDPOINT}/${systemId}`, {\r\n        method: 'PATCH',\r\n        credentials: 'include',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify(payload),\r\n      });\r\n      if (!response.ok) {\r\n        console.warn('[Employee API] Update sync failed');\r\n      } else {\r\n        console.log('[Employee API] Updated:', systemId);\r\n      }\r\n    } catch (e) {\r\n      console.warn('[Employee API] Update sync error:', e);\r\n    }\r\n    \r\n    return localResult;\r\n  },\r\n  softDelete: async (systemId) => {\r\n    // First delete locally\r\n    await employeeRepository.softDelete(systemId);\r\n    \r\n    // Then sync to API\r\n    try {\r\n      const response = await fetch(`${API_ENDPOINT}/${systemId}`, {\r\n        method: 'DELETE',\r\n        credentials: 'include',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({ hard: false }),\r\n      });\r\n      if (!response.ok) {\r\n        console.warn('[Employee API] Soft delete sync failed');\r\n      } else {\r\n        console.log('[Employee API] Soft deleted:', systemId);\r\n      }\r\n    } catch (e) {\r\n      console.warn('[Employee API] Soft delete sync error:', e);\r\n    }\r\n  },\r\n  restore: async (systemId) => {\r\n    // First restore locally\r\n    const localResult = await employeeRepository.restore(systemId);\r\n    \r\n    // Then sync to API\r\n    try {\r\n      const response = await fetch(`${API_ENDPOINT}/${systemId}/restore`, {\r\n        method: 'POST',\r\n        credentials: 'include',\r\n        headers: { 'Content-Type': 'application/json' },\r\n      });\r\n      if (!response.ok) {\r\n        console.warn('[Employee API] Restore sync failed');\r\n      } else {\r\n        console.log('[Employee API] Restored:', systemId);\r\n      }\r\n    } catch (e) {\r\n      console.warn('[Employee API] Restore sync error:', e);\r\n    }\r\n    \r\n    return localResult;\r\n  },\r\n  hardDelete: async (systemId) => {\r\n    // First delete locally\r\n    await employeeRepository.hardDelete(systemId);\r\n    \r\n    // Then sync to API\r\n    try {\r\n      const response = await fetch(`${API_ENDPOINT}/${systemId}`, {\r\n        method: 'DELETE',\r\n        credentials: 'include',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({ hard: true }),\r\n      });\r\n      if (!response.ok) {\r\n        console.warn('[Employee API] Hard delete sync failed');\r\n      } else {\r\n        console.log('[Employee API] Hard deleted:', systemId);\r\n      }\r\n    } catch (e) {\r\n      console.warn('[Employee API] Hard delete sync error:', e);\r\n    }\r\n  },\r\n};\r\n\r\n// ✅ Register for breadcrumb auto-generation\r\nregisterBreadcrumbStore('employees', () => baseStore.getState());\r\n\r\n// Define enhanced interface\r\ninterface EmployeeStoreState extends CrudState<Employee> {\r\n  searchEmployees: (query: string, page: number, limit?: number) => Promise<{ items: { value: string; label: string }[], hasNextPage: boolean }>;\r\n  permanentDelete: (systemId: SystemId) => Promise<void>;\r\n  persistence: EmployeePersistenceAdapter;\r\n}\r\n\r\ntype EmployeeStoreHook = (() => EmployeeStoreState) & {\r\n  getState: () => EmployeeStoreState;\r\n  persistence: EmployeePersistenceAdapter;\r\n};\r\n\r\n// Augmented methods\r\nconst augmentedMethods = {\r\n    // FIX: Changed `page: number = 1` to `page: number` to make it a required parameter, matching Combobox prop type.\r\n    // ✅ CRITICAL FIX: Create fresh Fuse instance on each search to avoid stale data\r\n    searchEmployees: async (query: string, page: number, limit: number = 20) => {\r\n        return new Promise<{ items: { value: string; label: string }[], hasNextPage: boolean }>(resolve => {\r\n            setTimeout(() => {\r\n                const allEmployees = baseStore.getState().data;\r\n                \r\n                // ✅ Create fresh Fuse instance with current data\r\n                const fuse = new Fuse(allEmployees, {\r\n                    keys: ['fullName', 'id', 'phone', 'personalEmail', 'workEmail'],\r\n                    threshold: 0.3,\r\n                });\r\n                \r\n                const results = query ? fuse.search(query).map(r => r.item) : allEmployees;\r\n                \r\n                const start = (page - 1) * limit;\r\n                const end = start + limit;\r\n                const paginatedItems = results.slice(start, end);\r\n\r\n                resolve({\r\n                    items: paginatedItems.map(e => ({ value: e.systemId, label: e.fullName })),\r\n                    hasNextPage: end < results.length,\r\n                });\r\n            }, 300);\r\n        });\r\n    },\r\n    permanentDelete: async (systemId: SystemId) => {\r\n        await persistence.hardDelete(systemId);\r\n    }\r\n};\r\n\r\nconst useEmployeeStoreHook = (): EmployeeStoreState => {\r\n  const state = baseStore();\r\n  return {\r\n    ...state,\r\n    ...augmentedMethods, // This includes permanentDelete\r\n    persistence,\r\n  };\r\n};\r\n\r\nexport const useEmployeeStore = useEmployeeStoreHook as EmployeeStoreHook;\r\n\r\n// Export getState for non-hook usage\r\nuseEmployeeStore.getState = (): EmployeeStoreState => {\r\n  const state = baseStore.getState();\r\n  return {\r\n    ...state,\r\n    ...augmentedMethods,\r\n    persistence,\r\n  };\r\n};\r\n\r\nuseEmployeeStore.persistence = persistence;\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 316, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/customers/lifecycle-utils.ts"],"sourcesContent":["import type { Customer, CustomerLifecycleStage } from './types';\r\nimport { formatDate, formatDateTime, formatDateTimeSeconds, formatDateCustom, getCurrentDate, getDaysDiff } from '@/lib/date-utils';\r\n/**\r\n * Tự động tính toán giai đoạn vòng đời khách hàng dựa trên hành vi\r\n */\r\nexport const calculateLifecycleStage = (customer: Customer): CustomerLifecycleStage => {\r\n  const totalOrders = customer.totalOrders || 0;\r\n  const totalSpent = customer.totalSpent || 0;\r\n  const lastPurchaseDate = customer.lastPurchaseDate;\r\n  \r\n  // Nếu chưa mua lần nào\r\n  if (totalOrders === 0) {\r\n    return \"Khách tiềm năng\";\r\n  }\r\n  \r\n  // Tính số ngày từ lần mua cuối\r\n  const daysSinceLastPurchase = lastPurchaseDate \r\n    ? getDaysDiff(getCurrentDate(), new Date(lastPurchaseDate))\r\n    : Infinity;\r\n  \r\n  // Khách đã mất (không mua > 365 ngày)\r\n  if (daysSinceLastPurchase > 365) {\r\n    return \"Mất khách\";\r\n  }\r\n  \r\n  // Không hoạt động (không mua > 180 ngày)\r\n  if (daysSinceLastPurchase > 180) {\r\n    return \"Không hoạt động\";\r\n  }\r\n  \r\n  // Khách VIP: Top 10% spending (>= 50 triệu) và mua >= 5 lần\r\n  if (totalSpent >= 50_000_000 && totalOrders >= 5) {\r\n    return \"Khách VIP\";\r\n  }\r\n  \r\n  // Khách thân thiết: Mua >= 5 lần\r\n  if (totalOrders >= 5) {\r\n    return \"Khách thân thiết\";\r\n  }\r\n  \r\n  // Khách quay lại: Mua 2-4 lần\r\n  if (totalOrders >= 2) {\r\n    return \"Khách quay lại\";\r\n  }\r\n  \r\n  // Khách mới: Mua lần đầu\r\n  return \"Khách mới\";\r\n};\r\n\r\n/**\r\n * Lấy màu badge cho lifecycle stage\r\n */\r\nexport const getLifecycleStageVariant = (stage?: CustomerLifecycleStage): \r\n  'default' | 'secondary' | 'success' | 'warning' | 'destructive' => {\r\n  switch (stage) {\r\n    case \"Khách VIP\":\r\n      return \"success\";\r\n    case \"Khách thân thiết\":\r\n      return \"success\";\r\n    case \"Khách quay lại\":\r\n      return \"default\";\r\n    case \"Khách mới\":\r\n      return \"secondary\";\r\n    case \"Khách tiềm năng\":\r\n      return \"secondary\";\r\n    case \"Không hoạt động\":\r\n      return \"warning\";\r\n    case \"Mất khách\":\r\n      return \"destructive\";\r\n    default:\r\n      return \"secondary\";\r\n  }\r\n};\r\n\r\n/**\r\n * Cập nhật lifecycle stage cho tất cả customers (chạy batch)\r\n */\r\nexport const updateAllCustomerLifecycleStages = (customers: Customer[]): Customer[] => {\r\n  return customers.map(customer => ({\r\n    ...customer,\r\n    lifecycleStage: calculateLifecycleStage(customer)\r\n  }));\r\n};\r\n"],"names":[],"mappings":";;;;;;;;AACA;;AAIO,MAAM,0BAA0B,CAAC;IACtC,MAAM,cAAc,SAAS,WAAW,IAAI;IAC5C,MAAM,aAAa,SAAS,UAAU,IAAI;IAC1C,MAAM,mBAAmB,SAAS,gBAAgB;IAElD,uBAAuB;IACvB,IAAI,gBAAgB,GAAG;QACrB,OAAO;IACT;IAEA,+BAA+B;IAC/B,MAAM,wBAAwB,mBAC1B,IAAA,sIAAW,EAAC,IAAA,yIAAc,KAAI,IAAI,KAAK,qBACvC;IAEJ,sCAAsC;IACtC,IAAI,wBAAwB,KAAK;QAC/B,OAAO;IACT;IAEA,yCAAyC;IACzC,IAAI,wBAAwB,KAAK;QAC/B,OAAO;IACT;IAEA,4DAA4D;IAC5D,IAAI,cAAc,cAAc,eAAe,GAAG;QAChD,OAAO;IACT;IAEA,iCAAiC;IACjC,IAAI,eAAe,GAAG;QACpB,OAAO;IACT;IAEA,8BAA8B;IAC9B,IAAI,eAAe,GAAG;QACpB,OAAO;IACT;IAEA,yBAAyB;IACzB,OAAO;AACT;AAKO,MAAM,2BAA2B,CAAC;IAEvC,OAAQ;QACN,KAAK;YACH,OAAO;QACT,KAAK;YACH,OAAO;QACT,KAAK;YACH,OAAO;QACT,KAAK;YACH,OAAO;QACT,KAAK;YACH,OAAO;QACT,KAAK;YACH,OAAO;QACT,KAAK;YACH,OAAO;QACT;YACE,OAAO;IACX;AACF;AAKO,MAAM,mCAAmC,CAAC;IAC/C,OAAO,UAAU,GAAG,CAAC,CAAA,WAAY,CAAC;YAChC,GAAG,QAAQ;YACX,gBAAgB,wBAAwB;QAC1C,CAAC;AACH"}},
    {"offset": {"line": 392, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/customers/credit-utils.ts"],"sourcesContent":["import type { Customer } from './types';\r\n\r\nexport type CreditAlertLevel = 'safe' | 'warning' | 'danger' | 'exceeded';\r\n\r\n/**\r\n * Tính mức độ cảnh báo công nợ\r\n */\r\nexport const getCreditAlertLevel = (customer: Customer): CreditAlertLevel => {\r\n  const currentDebt = customer.currentDebt || 0;\r\n  const maxDebt = customer.maxDebt || 0;\r\n  \r\n  // Nếu không có hạn mức hoặc hạn mức = 0, không cảnh báo\r\n  if (maxDebt === 0) return 'safe';\r\n  \r\n  const debtRatio = (currentDebt / maxDebt) * 100;\r\n  \r\n  if (debtRatio >= 100) return 'exceeded';  // Vượt hạn mức\r\n  if (debtRatio >= 90) return 'danger';     // >= 90%\r\n  if (debtRatio >= 70) return 'warning';    // >= 70%\r\n  return 'safe';                             // < 70%\r\n};\r\n\r\n/**\r\n * Lấy variant Badge cho credit alert\r\n */\r\nexport const getCreditAlertBadgeVariant = (level: CreditAlertLevel): \r\n  'default' | 'secondary' | 'success' | 'warning' | 'destructive' => {\r\n  switch (level) {\r\n    case 'exceeded':\r\n    case 'danger':\r\n      return 'destructive';\r\n    case 'warning':\r\n      return 'warning';\r\n    case 'safe':\r\n      return 'success';\r\n    default:\r\n      return 'secondary';\r\n  }\r\n};\r\n\r\n/**\r\n * Lấy text cho credit alert\r\n */\r\nexport const getCreditAlertText = (level: CreditAlertLevel): string => {\r\n  switch (level) {\r\n    case 'exceeded':\r\n      return 'Vượt hạn mức';\r\n    case 'danger':\r\n      return 'Sắp vượt hạn';\r\n    case 'warning':\r\n      return 'Cần theo dõi';\r\n    case 'safe':\r\n      return 'An toàn';\r\n    default:\r\n      return '';\r\n  }\r\n};\r\n\r\n/**\r\n * Kiểm tra xem có thể tạo đơn hàng không (dựa vào công nợ)\r\n */\r\nexport const canCreateOrder = (customer: Customer, orderAmount: number): {\r\n  allowed: boolean;\r\n  reason?: string;\r\n} => {\r\n  const currentDebt = customer.currentDebt || 0;\r\n  const maxDebt = customer.maxDebt || 0;\r\n  \r\n  // Nếu không cho phép công nợ và có công nợ hiện tại\r\n  if (!customer.allowCredit && currentDebt > 0) {\r\n    return {\r\n      allowed: false,\r\n      reason: 'Khách hàng không được phép công nợ và còn nợ cũ'\r\n    };\r\n  }\r\n  \r\n  // Nếu có hạn mức công nợ\r\n  if (maxDebt > 0) {\r\n    const newDebt = currentDebt + orderAmount;\r\n    if (newDebt > maxDebt) {\r\n      return {\r\n        allowed: false,\r\n        reason: `Đơn hàng này sẽ vượt hạn mức công nợ (${formatCurrency(newDebt)} / ${formatCurrency(maxDebt)})`\r\n      };\r\n    }\r\n  }\r\n  \r\n  return { allowed: true };\r\n};\r\n\r\n/**\r\n * Lấy danh sách khách hàng có nguy cơ công nợ cao\r\n */\r\nexport const getHighRiskDebtCustomers = (customers: Customer[]): Customer[] => {\r\n  return customers.filter(customer => {\r\n    const level = getCreditAlertLevel(customer);\r\n    return level === 'danger' || level === 'exceeded';\r\n  }).sort((a, b) => {\r\n    const ratioA = ((a.currentDebt || 0) / (a.maxDebt || 1)) * 100;\r\n    const ratioB = ((b.currentDebt || 0) / (b.maxDebt || 1)) * 100;\r\n    return ratioB - ratioA; // Sort by ratio descending\r\n  });\r\n};\r\n\r\n/**\r\n * Helper format currency\r\n */\r\nconst formatCurrency = (value: number): string => {\r\n  return new Intl.NumberFormat('vi-VN', { \r\n    style: 'currency', \r\n    currency: 'VND' \r\n  }).format(value);\r\n};\r\n"],"names":[],"mappings":";;;;;;;;;;;;AAOO,MAAM,sBAAsB,CAAC;IAClC,MAAM,cAAc,SAAS,WAAW,IAAI;IAC5C,MAAM,UAAU,SAAS,OAAO,IAAI;IAEpC,wDAAwD;IACxD,IAAI,YAAY,GAAG,OAAO;IAE1B,MAAM,YAAY,AAAC,cAAc,UAAW;IAE5C,IAAI,aAAa,KAAK,OAAO,YAAa,eAAe;IACzD,IAAI,aAAa,IAAI,OAAO,UAAc,SAAS;IACnD,IAAI,aAAa,IAAI,OAAO,WAAc,SAAS;IACnD,OAAO,QAAoC,QAAQ;AACrD;AAKO,MAAM,6BAA6B,CAAC;IAEzC,OAAQ;QACN,KAAK;QACL,KAAK;YACH,OAAO;QACT,KAAK;YACH,OAAO;QACT,KAAK;YACH,OAAO;QACT;YACE,OAAO;IACX;AACF;AAKO,MAAM,qBAAqB,CAAC;IACjC,OAAQ;QACN,KAAK;YACH,OAAO;QACT,KAAK;YACH,OAAO;QACT,KAAK;YACH,OAAO;QACT,KAAK;YACH,OAAO;QACT;YACE,OAAO;IACX;AACF;AAKO,MAAM,iBAAiB,CAAC,UAAoB;IAIjD,MAAM,cAAc,SAAS,WAAW,IAAI;IAC5C,MAAM,UAAU,SAAS,OAAO,IAAI;IAEpC,oDAAoD;IACpD,IAAI,CAAC,SAAS,WAAW,IAAI,cAAc,GAAG;QAC5C,OAAO;YACL,SAAS;YACT,QAAQ;QACV;IACF;IAEA,yBAAyB;IACzB,IAAI,UAAU,GAAG;QACf,MAAM,UAAU,cAAc;QAC9B,IAAI,UAAU,SAAS;YACrB,OAAO;gBACL,SAAS;gBACT,QAAQ,CAAC,sCAAsC,EAAE,eAAe,SAAS,GAAG,EAAE,eAAe,SAAS,CAAC,CAAC;YAC1G;QACF;IACF;IAEA,OAAO;QAAE,SAAS;IAAK;AACzB;AAKO,MAAM,2BAA2B,CAAC;IACvC,OAAO,UAAU,MAAM,CAAC,CAAA;QACtB,MAAM,QAAQ,oBAAoB;QAClC,OAAO,UAAU,YAAY,UAAU;IACzC,GAAG,IAAI,CAAC,CAAC,GAAG;QACV,MAAM,SAAS,AAAC,CAAC,EAAE,WAAW,IAAI,CAAC,IAAI,CAAC,EAAE,OAAO,IAAI,CAAC,IAAK;QAC3D,MAAM,SAAS,AAAC,CAAC,EAAE,WAAW,IAAI,CAAC,IAAI,CAAC,EAAE,OAAO,IAAI,CAAC,IAAK;QAC3D,OAAO,SAAS,QAAQ,2BAA2B;IACrD;AACF;AAEA;;CAEC,GACD,MAAM,iBAAiB,CAAC;IACtB,OAAO,IAAI,KAAK,YAAY,CAAC,SAAS;QACpC,OAAO;QACP,UAAU;IACZ,GAAG,MAAM,CAAC;AACZ"}},
    {"offset": {"line": 491, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/customers/intelligence-utils.ts"],"sourcesContent":["import type { Customer } from './types';\r\nimport { formatDate, formatDateTime, formatDateTimeSeconds, formatDateCustom, getCurrentDate, getDaysDiff } from '@/lib/date-utils';\r\n// RFM Score types\r\nexport type RFMScore = {\r\n  recency: 1 | 2 | 3 | 4 | 5;      // 5 = Best (mua gần đây)\r\n  frequency: 1 | 2 | 3 | 4 | 5;    // 5 = Best (mua thường xuyên)\r\n  monetary: 1 | 2 | 3 | 4 | 5;     // 5 = Best (chi tiêu nhiều)\r\n};\r\n\r\n// Customer Segment based on RFM\r\nexport type CustomerSegment = \r\n  | 'Champions'           // RFM: 5-5-5, 5-4-5, 4-5-5 - Khách hàng tốt nhất\r\n  | 'Loyal Customers'     // RFM: 4-4-4, 4-5-4, 5-4-4 - Khách thân thiết\r\n  | 'Potential Loyalist'  // RFM: 4-3-*, 3-4-*, 5-3-* - Tiềm năng trở thành thân thiết\r\n  | 'New Customers'       // RFM: 5-1-*, 4-1-* - Khách mới\r\n  | 'Promising'           // RFM: 4-2-*, 3-3-* - Đầy hứa hẹn\r\n  | 'Need Attention'      // RFM: 3-2-*, 2-3-* - Cần chú ý\r\n  | 'About To Sleep'      // RFM: 3-1-*, 2-2-* - Sắp ngủ đông\r\n  | 'At Risk'             // RFM: 2-5-*, 2-4-*, 1-3-* - Có nguy cơ\r\n  | 'Cannot Lose Them'    // RFM: 1-5-5, 1-4-5 - Không thể mất\r\n  | 'Hibernating'         // RFM: 2-1-*, 1-2-* - Ngủ đông\r\n  | 'Lost';               // RFM: 1-1-* - Đã mất\r\n\r\n/**\r\n * Tính RFM scores cho một khách hàng\r\n */\r\nexport const calculateRFMScores = (customer: Customer, allCustomers: Customer[]): RFMScore => {\r\n  // Recency: Số ngày từ lần mua cuối\r\n  const daysSinceLastPurchase = customer.lastPurchaseDate \r\n    ? getDaysDiff(getCurrentDate(), new Date(customer.lastPurchaseDate))\r\n    : 999999;\r\n  \r\n  // Frequency: Tổng số đơn hàng\r\n  const frequency = customer.totalOrders || 0;\r\n  \r\n  // Monetary: Tổng chi tiêu\r\n  const monetary = customer.totalSpent || 0;\r\n\r\n  // Calculate percentiles for scoring\r\n  const allRecencies = allCustomers.map(c => \r\n    c.lastPurchaseDate ? getDaysDiff(getCurrentDate(), new Date(c.lastPurchaseDate)) : 999999\r\n  ).sort((a, b) => a - b);\r\n  \r\n  const allFrequencies = allCustomers.map(c => c.totalOrders || 0).sort((a, b) => b - a);\r\n  const allMonetary = allCustomers.map(c => c.totalSpent || 0).sort((a, b) => b - a);\r\n\r\n  // Score Recency (lower is better, so invert)\r\n  const recencyScore = getScore(daysSinceLastPurchase, allRecencies, true) as RFMScore['recency'];\r\n  \r\n  // Score Frequency (higher is better)\r\n  const frequencyScore = getScore(frequency, allFrequencies, false) as RFMScore['frequency'];\r\n  \r\n  // Score Monetary (higher is better)\r\n  const monetaryScore = getScore(monetary, allMonetary, false) as RFMScore['monetary'];\r\n\r\n  return {\r\n    recency: recencyScore,\r\n    frequency: frequencyScore,\r\n    monetary: monetaryScore\r\n  };\r\n};\r\n\r\n/**\r\n * Helper: Tính score 1-5 dựa trên percentile\r\n */\r\nconst getScore = (value: number, sortedValues: number[], invert: boolean): 1 | 2 | 3 | 4 | 5 => {\r\n  const index = sortedValues.indexOf(value);\r\n  if (index === -1) return 1;\r\n  \r\n  const percentile = (index / sortedValues.length) * 100;\r\n  \r\n  let score: number;\r\n  if (percentile >= 80) score = 5;\r\n  else if (percentile >= 60) score = 4;\r\n  else if (percentile >= 40) score = 3;\r\n  else if (percentile >= 20) score = 2;\r\n  else score = 1;\r\n  \r\n  // Invert for recency (lower days = better)\r\n  if (invert) {\r\n    score = 6 - score;\r\n  }\r\n  \r\n  return score as 1 | 2 | 3 | 4 | 5;\r\n};\r\n\r\n/**\r\n * Phân loại segment dựa trên RFM scores\r\n */\r\nexport const getCustomerSegment = (rfm: RFMScore): CustomerSegment => {\r\n  const { recency: R, frequency: F, monetary: M } = rfm;\r\n  \r\n  // Champions: RFM 5-5-5, 5-4-5, 4-5-5, 5-5-4\r\n  if ((R >= 4 && F >= 4 && M >= 4) && (R === 5 || F === 5)) {\r\n    return 'Champions';\r\n  }\r\n  \r\n  // Loyal Customers: RFM 4-4-4, 4-5-4, 5-4-4, 4-4-5\r\n  if (R >= 4 && F >= 4 && M >= 4) {\r\n    return 'Loyal Customers';\r\n  }\r\n  \r\n  // Potential Loyalist: High frequency, good recency\r\n  if (R >= 3 && F >= 3 && M >= 3) {\r\n    return 'Potential Loyalist';\r\n  }\r\n  \r\n  // New Customers: High recency, low frequency\r\n  if (R >= 4 && F <= 2) {\r\n    return 'New Customers';\r\n  }\r\n  \r\n  // Promising: Good recency, moderate frequency\r\n  if (R >= 3 && F >= 2 && F <= 3) {\r\n    return 'Promising';\r\n  }\r\n  \r\n  // Need Attention: Moderate scores\r\n  if (R === 3 && F === 2) {\r\n    return 'Need Attention';\r\n  }\r\n  \r\n  // About To Sleep: Low frequency, moderate recency\r\n  if ((R === 3 || R === 2) && F <= 2) {\r\n    return 'About To Sleep';\r\n  }\r\n  \r\n  // Cannot Lose Them: Low recency but high value\r\n  if (R === 1 && F >= 4 && M >= 4) {\r\n    return 'Cannot Lose Them';\r\n  }\r\n  \r\n  // At Risk: Low recency, good history\r\n  if (R <= 2 && F >= 3) {\r\n    return 'At Risk';\r\n  }\r\n  \r\n  // Hibernating: Low recency and frequency\r\n  if (R <= 2 && F <= 2 && M >= 2) {\r\n    return 'Hibernating';\r\n  }\r\n  \r\n  // Lost: Lowest scores\r\n  return 'Lost';\r\n};\r\n\r\n/**\r\n * Lấy màu badge cho segment\r\n */\r\nexport const getSegmentBadgeVariant = (segment: CustomerSegment): \r\n  'default' | 'secondary' | 'success' | 'warning' | 'destructive' => {\r\n  switch (segment) {\r\n    case 'Champions':\r\n    case 'Loyal Customers':\r\n      return 'success';\r\n    case 'Potential Loyalist':\r\n    case 'Promising':\r\n      return 'default';\r\n    case 'New Customers':\r\n      return 'secondary';\r\n    case 'Need Attention':\r\n    case 'About To Sleep':\r\n      return 'warning';\r\n    case 'At Risk':\r\n    case 'Cannot Lose Them':\r\n    case 'Hibernating':\r\n    case 'Lost':\r\n      return 'destructive';\r\n    default:\r\n      return 'secondary';\r\n  }\r\n};\r\n\r\n/**\r\n * Dịch segment sang tiếng Việt\r\n */\r\nexport const getSegmentLabel = (segment: CustomerSegment): string => {\r\n  const labels: Record<CustomerSegment, string> = {\r\n    'Champions': 'Xuất sắc',\r\n    'Loyal Customers': 'Trung thành',\r\n    'Potential Loyalist': 'Tiềm năng cao',\r\n    'New Customers': 'Khách mới',\r\n    'Promising': 'Hứa hẹn',\r\n    'Need Attention': 'Cần quan tâm',\r\n    'About To Sleep': 'Sắp ngủ đông',\r\n    'At Risk': 'Có nguy cơ',\r\n    'Cannot Lose Them': 'Không thể mất',\r\n    'Hibernating': 'Ngủ đông',\r\n    'Lost': 'Đã mất'\r\n  };\r\n  return labels[segment];\r\n};\r\n\r\n/**\r\n * Tính Customer Health Score (0-100)\r\n * Dựa trên 4 yếu tố: Recency, Frequency, Monetary, Payment Behavior\r\n */\r\nexport const calculateHealthScore = (customer: Customer): number => {\r\n  let score = 0;\r\n  \r\n  // 1. Recency - Thời gian mua gần nhất (30 points)\r\n  const daysSinceLastPurchase = customer.lastPurchaseDate \r\n    ? getDaysDiff(getCurrentDate(), new Date(customer.lastPurchaseDate))\r\n    : Infinity;\r\n    \r\n  if (daysSinceLastPurchase <= 7) score += 30;\r\n  else if (daysSinceLastPurchase <= 30) score += 25;\r\n  else if (daysSinceLastPurchase <= 60) score += 20;\r\n  else if (daysSinceLastPurchase <= 90) score += 15;\r\n  else if (daysSinceLastPurchase <= 180) score += 10;\r\n  else if (daysSinceLastPurchase <= 365) score += 5;\r\n  \r\n  // 2. Frequency - Tần suất mua (25 points)\r\n  const totalOrders = customer.totalOrders || 0;\r\n  if (totalOrders >= 20) score += 25;\r\n  else if (totalOrders >= 10) score += 20;\r\n  else if (totalOrders >= 5) score += 15;\r\n  else if (totalOrders >= 3) score += 10;\r\n  else if (totalOrders >= 1) score += 5;\r\n  \r\n  // 3. Monetary - Tổng chi tiêu (30 points)\r\n  const totalSpent = customer.totalSpent || 0;\r\n  if (totalSpent >= 500_000_000) score += 30;\r\n  else if (totalSpent >= 200_000_000) score += 25;\r\n  else if (totalSpent >= 100_000_000) score += 20;\r\n  else if (totalSpent >= 50_000_000) score += 15;\r\n  else if (totalSpent >= 20_000_000) score += 10;\r\n  else if (totalSpent >= 5_000_000) score += 5;\r\n  \r\n  // 4. Payment Behavior - Hành vi thanh toán (15 points)\r\n  // Dựa trên tỷ lệ nợ hiện tại so với hạn mức\r\n  if (customer.maxDebt && customer.maxDebt > 0) {\r\n    const debtRatio = (customer.currentDebt || 0) / customer.maxDebt;\r\n    if (debtRatio <= 0.2) score += 15;\r\n    else if (debtRatio <= 0.4) score += 12;\r\n    else if (debtRatio <= 0.6) score += 8;\r\n    else if (debtRatio <= 0.8) score += 4;\r\n    // > 80% = 0 điểm\r\n  } else {\r\n    // Không có hạn mức công nợ → xem như thanh toán tốt\r\n    score += 15;\r\n  }\r\n  \r\n  return Math.min(100, score);\r\n};\r\n\r\n/**\r\n * Lấy health score level\r\n */\r\nexport const getHealthScoreLevel = (score: number): {\r\n  level: 'excellent' | 'good' | 'fair' | 'poor' | 'critical';\r\n  label: string;\r\n  variant: 'success' | 'default' | 'warning' | 'destructive';\r\n} => {\r\n  if (score >= 80) return { level: 'excellent', label: 'Xuất sắc', variant: 'success' };\r\n  if (score >= 60) return { level: 'good', label: 'Tốt', variant: 'default' };\r\n  if (score >= 40) return { level: 'fair', label: 'Trung bình', variant: 'warning' };\r\n  if (score >= 20) return { level: 'poor', label: 'Yếu', variant: 'destructive' };\r\n  return { level: 'critical', label: 'Nguy hiểm', variant: 'destructive' };\r\n};\r\n\r\n/**\r\n * Dự đoán Churn Risk\r\n */\r\nexport const calculateChurnRisk = (customer: Customer): {\r\n  risk: 'low' | 'medium' | 'high';\r\n  label: string;\r\n  variant: 'success' | 'warning' | 'destructive';\r\n  reason: string;\r\n} => {\r\n  const daysSinceLastPurchase = customer.lastPurchaseDate \r\n    ? getDaysDiff(getCurrentDate(), new Date(customer.lastPurchaseDate))\r\n    : Infinity;\r\n  \r\n  const totalOrders = customer.totalOrders || 0;\r\n  \r\n  // Nếu khách mới (chưa có đơn hoặc chỉ 1 đơn), dùng default 30 ngày\r\n  // Nếu khách cũ, tính dựa trên thời gian từ createdAt đến lastPurchaseDate / số đơn\r\n  let avgDaysBetweenOrders = 30; // Default\r\n  if (totalOrders > 1 && customer.createdAt && customer.lastPurchaseDate) {\r\n    const customerAge = getDaysDiff(new Date(customer.lastPurchaseDate), new Date(customer.createdAt));\r\n    avgDaysBetweenOrders = Math.max(7, customerAge / (totalOrders - 1)); // Tối thiểu 7 ngày\r\n  }\r\n  \r\n  // Khách vừa mua hàng gần đây (< 7 ngày) = low risk\r\n  if (daysSinceLastPurchase <= 7) {\r\n    return {\r\n      risk: 'low',\r\n      label: 'Nguy cơ thấp',\r\n      variant: 'success',\r\n      reason: 'Khách hàng đang hoạt động tốt'\r\n    };\r\n  }\r\n  \r\n  // High risk: Không mua > 2x thời gian trung bình hoặc > 365 ngày\r\n  if (daysSinceLastPurchase > avgDaysBetweenOrders * 2 || daysSinceLastPurchase > 365) {\r\n    return {\r\n      risk: 'high',\r\n      label: 'Nguy cơ cao',\r\n      variant: 'destructive',\r\n      reason: `Không mua hàng ${Math.floor(daysSinceLastPurchase)} ngày, vượt quá 2x chu kỳ trung bình`\r\n    };\r\n  }\r\n  \r\n  // Medium risk: Không mua > 1.5x thời gian trung bình hoặc > 180 ngày\r\n  if (daysSinceLastPurchase > avgDaysBetweenOrders * 1.5 || daysSinceLastPurchase > 180) {\r\n    return {\r\n      risk: 'medium',\r\n      label: 'Nguy cơ trung bình',\r\n      variant: 'warning',\r\n      reason: `Không mua hàng ${Math.floor(daysSinceLastPurchase)} ngày, đang giảm tần suất`\r\n    };\r\n  }\r\n  \r\n  // Low risk\r\n  return {\r\n    risk: 'low',\r\n    label: 'Nguy cơ thấp',\r\n    variant: 'success',\r\n    reason: 'Khách hàng đang hoạt động tốt'\r\n  };\r\n};\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 752, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/customers/debt-tracking-utils.ts"],"sourcesContent":["import type { Customer, DebtStatus, DebtTransaction } from './types';\r\nimport { formatDate, formatDateTime, formatDateTimeSeconds, formatDateCustom, getCurrentDate, addDays, getDaysDiff, isDateBefore, toISODate } from '@/lib/date-utils';\r\n/**\r\n * Tính ngày đến hạn dựa trên ngày đơn hàng và payment terms\r\n */\r\nexport const calculateDueDate = (orderDate: string, paymentTermsDays: number): string => {\r\n  return toISODate(addDays(new Date(orderDate), paymentTermsDays));\r\n};\r\n\r\n/**\r\n * Parse payment terms string thành số ngày\r\n * \"NET30\" → 30, \"NET15\" → 15, \"COD\" → 0\r\n */\r\nexport const parsePaymentTerms = (paymentTerms?: string): number => {\r\n  if (!paymentTerms) return 0;\r\n  \r\n  const match = paymentTerms.match(/NET(\\d+)/i);\r\n  if (match) {\r\n    return parseInt(match[1], 10);\r\n  }\r\n  \r\n  if (paymentTerms.toUpperCase() === 'COD') {\r\n    return 0; // COD = thanh toán ngay\r\n  }\r\n  \r\n  return 30; // Default 30 ngày\r\n};\r\n\r\n/**\r\n * Tính số ngày quá hạn (nếu > 0 thì quá hạn)\r\n */\r\nexport const calculateDaysOverdue = (dueDate: string): number => {\r\n  const days = getDaysDiff(getCurrentDate(), new Date(dueDate));\r\n  return days > 0 ? days : 0;\r\n};\r\n\r\n/**\r\n * Tính số ngày còn lại đến hạn (nếu > 0 thì chưa đến hạn)\r\n */\r\nexport const calculateDaysUntilDue = (dueDate: string): number => {\r\n  return getDaysDiff(new Date(dueDate), getCurrentDate());\r\n};\r\n\r\n/**\r\n * Phân loại trạng thái công nợ dựa trên ngày đến hạn\r\n */\r\nexport const getDebtStatus = (dueDate: string, hasDebt: boolean): DebtStatus | null => {\r\n  if (!hasDebt) return null;\r\n  \r\n  const daysUntilDue = calculateDaysUntilDue(dueDate);\r\n  \r\n  // Chưa đến hạn\r\n  if (daysUntilDue > 3) return \"Chưa đến hạn\";\r\n  \r\n  // Sắp đến hạn (1-3 ngày)\r\n  if (daysUntilDue >= 1 && daysUntilDue <= 3) return \"Sắp đến hạn\";\r\n  \r\n  // Đến hạn hôm nay\r\n  if (daysUntilDue === 0) return \"Đến hạn hôm nay\";\r\n  \r\n  // Quá hạn\r\n  const daysOverdue = Math.abs(daysUntilDue);\r\n  \r\n  if (daysOverdue >= 1 && daysOverdue <= 7) return \"Quá hạn 1-7 ngày\";\r\n  if (daysOverdue >= 8 && daysOverdue <= 15) return \"Quá hạn 8-15 ngày\";\r\n  if (daysOverdue >= 16 && daysOverdue <= 30) return \"Quá hạn 16-30 ngày\";\r\n  \r\n  return \"Quá hạn > 30 ngày\";\r\n};\r\n\r\n/**\r\n * Lấy variant cho badge trạng thái công nợ\r\n */\r\nexport const getDebtStatusVariant = (status?: DebtStatus | null): \r\n  'default' | 'secondary' | 'success' | 'warning' | 'destructive' => {\r\n  if (!status) return 'secondary';\r\n  \r\n  switch (status) {\r\n    case \"Chưa đến hạn\":\r\n      return \"secondary\";\r\n    case \"Sắp đến hạn\":\r\n      return \"default\";\r\n    case \"Đến hạn hôm nay\":\r\n      return \"warning\";\r\n    case \"Quá hạn 1-7 ngày\":\r\n      return \"warning\";\r\n    case \"Quá hạn 8-15 ngày\":\r\n    case \"Quá hạn 16-30 ngày\":\r\n    case \"Quá hạn > 30 ngày\":\r\n      return \"destructive\";\r\n    default:\r\n      return \"secondary\";\r\n  }\r\n};\r\n\r\n/**\r\n * Tính toán debt tracking info cho customer\r\n */\r\nexport const calculateDebtTrackingInfo = (customer: Customer): {\r\n  oldestDebtDueDate?: string;\r\n  maxDaysOverdue: number;\r\n  debtStatus?: DebtStatus | null;\r\n} => {\r\n  const debtTransactions = customer.debtTransactions || [];\r\n  const unpaidTransactions = debtTransactions.filter(t => !t.isPaid);\r\n  \r\n  if (unpaidTransactions.length === 0 || !customer.currentDebt || customer.currentDebt === 0) {\r\n    return {\r\n      maxDaysOverdue: 0,\r\n      debtStatus: null\r\n    };\r\n  }\r\n  \r\n  // Tìm giao dịch có dueDate sớm nhất (nợ lâu nhất)\r\n  const oldestTransaction = unpaidTransactions.reduce((oldest, current) => {\r\n    return isDateBefore(new Date(current.dueDate), new Date(oldest.dueDate)) ? current : oldest;\r\n  });\r\n  \r\n  const oldestDebtDueDate = oldestTransaction.dueDate;\r\n  const maxDaysOverdue = calculateDaysOverdue(oldestDebtDueDate);\r\n  const debtStatus = getDebtStatus(oldestDebtDueDate, true);\r\n  \r\n  return {\r\n    oldestDebtDueDate,\r\n    maxDaysOverdue,\r\n    debtStatus\r\n  };\r\n};\r\n\r\n/**\r\n * Lấy danh sách khách hàng có nợ quá hạn, sắp xếp theo mức độ ưu tiên\r\n */\r\nexport const getOverdueDebtCustomers = (customers: Customer[]): Customer[] => {\r\n  return customers\r\n    .filter(c => {\r\n      const info = calculateDebtTrackingInfo(c);\r\n      return info.maxDaysOverdue > 0; // Chỉ lấy KH quá hạn\r\n    })\r\n    .sort((a, b) => {\r\n      const infoA = calculateDebtTrackingInfo(a);\r\n      const infoB = calculateDebtTrackingInfo(b);\r\n      \r\n      // Sắp xếp theo số ngày quá hạn (giảm dần)\r\n      return (infoB.maxDaysOverdue || 0) - (infoA.maxDaysOverdue || 0);\r\n    });\r\n};\r\n\r\n/**\r\n * Lấy danh sách khách hàng sắp đến hạn thanh toán (1-3 ngày)\r\n */\r\nexport const getDueSoonCustomers = (customers: Customer[]): Customer[] => {\r\n  return customers\r\n    .filter(c => {\r\n      const info = calculateDebtTrackingInfo(c);\r\n      if (!info.oldestDebtDueDate) return false;\r\n      \r\n      const daysUntil = calculateDaysUntilDue(info.oldestDebtDueDate);\r\n      return daysUntil >= 1 && daysUntil <= 3;\r\n    })\r\n    .sort((a, b) => {\r\n      const infoA = calculateDebtTrackingInfo(a);\r\n      const infoB = calculateDebtTrackingInfo(b);\r\n      \r\n      const daysA = infoA.oldestDebtDueDate ? calculateDaysUntilDue(infoA.oldestDebtDueDate) : 999;\r\n      const daysB = infoB.oldestDebtDueDate ? calculateDaysUntilDue(infoB.oldestDebtDueDate) : 999;\r\n      \r\n      return daysA - daysB; // Sắp xếp theo ngày đến hạn (tăng dần)\r\n    });\r\n};\r\n\r\n/**\r\n * Tính tổng công nợ quá hạn\r\n */\r\nexport const calculateTotalOverdueDebt = (customers: Customer[]): number => {\r\n  return getOverdueDebtCustomers(customers).reduce((sum, c) => sum + (c.currentDebt || 0), 0);\r\n};\r\n\r\n/**\r\n * Tính tổng công nợ sắp đến hạn\r\n */\r\nexport const calculateTotalDueSoonDebt = (customers: Customer[]): number => {\r\n  return getDueSoonCustomers(customers).reduce((sum, c) => sum + (c.currentDebt || 0), 0);\r\n};\r\n\r\n/**\r\n * Format ngày hiển thị\r\n */\r\nexport const formatDebtDate = (dateString?: string): string => {\r\n  if (!dateString) return '-';\r\n  return formatDate(dateString);\r\n};\r\n\r\n/**\r\n * Helper format currency\r\n */\r\nexport const formatCurrency = (value?: number): string => {\r\n  if (typeof value !== 'number') return '0 ₫';\r\n  return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(value);\r\n};\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 909, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/customers/store.ts"],"sourcesContent":["import { create } from 'zustand';\r\nimport { createCrudStore, CrudState } from '../../lib/store-factory';\r\n// REMOVED: import { data as initialData } from './data'; // Mock data no longer used - database is source of truth\r\nimport type { Customer } from './types';\r\nimport { SystemId, BusinessId } from '../../lib/id-types';\r\nimport { calculateLifecycleStage } from './lifecycle-utils';\r\nimport { getHighRiskDebtCustomers } from './credit-utils';\r\nimport { \r\n  calculateRFMScores, \r\n  getCustomerSegment, \r\n  calculateHealthScore,\r\n  calculateChurnRisk \r\n} from './intelligence-utils';\r\nimport { getOverdueDebtCustomers, getDueSoonCustomers } from './debt-tracking-utils';\r\nimport Fuse from 'fuse.js';\r\nimport { getCurrentUserSystemId } from '../../contexts/auth-context';\r\nimport {\r\n  getCurrentUserInfo,\r\n  createCreatedEntry,\r\n  createUpdatedEntry,\r\n  createStatusChangedEntry,\r\n  appendHistoryEntry,\r\n  type HistoryEntry\r\n} from '../../lib/activity-history-helper';\r\n\r\nconst baseStore = createCrudStore<Customer>([], 'customers', {\r\n  businessIdField: 'id',\r\n  getCurrentUser: getCurrentUserSystemId, // Track who creates/updates\r\n  apiEndpoint: '/api/customers',\r\n});\r\n\r\n// ✅ API Sync helpers\r\nconst API_ENDPOINT = '/api/customers';\r\n\r\nconst syncToApi = {\r\n  create: async (customer: Customer) => {\r\n    try {\r\n      const response = await fetch(API_ENDPOINT, {\r\n        method: 'POST',\r\n        credentials: 'include',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify(customer),\r\n      });\r\n      if (!response.ok) console.warn('[Customer API] Create sync failed');\r\n      else console.log('[Customer API] Created:', customer.systemId);\r\n    } catch (e) {\r\n      console.warn('[Customer API] Create sync error:', e);\r\n    }\r\n  },\r\n  update: async (systemId: SystemId, updates: Partial<Customer>) => {\r\n    try {\r\n      const response = await fetch(`${API_ENDPOINT}/${systemId}`, {\r\n        method: 'PATCH',\r\n        credentials: 'include',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify(updates),\r\n      });\r\n      if (!response.ok) console.warn('[Customer API] Update sync failed');\r\n      else console.log('[Customer API] Updated:', systemId);\r\n    } catch (e) {\r\n      console.warn('[Customer API] Update sync error:', e);\r\n    }\r\n  },\r\n  delete: async (systemId: SystemId, hard = false) => {\r\n    try {\r\n      const response = await fetch(`${API_ENDPOINT}/${systemId}`, {\r\n        method: 'DELETE',\r\n        credentials: 'include',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({ hard }),\r\n      });\r\n      if (!response.ok) console.warn('[Customer API] Delete sync failed');\r\n      else console.log('[Customer API] Deleted:', systemId);\r\n    } catch (e) {\r\n      console.warn('[Customer API] Delete sync error:', e);\r\n    }\r\n  },\r\n  restore: async (systemId: SystemId) => {\r\n    try {\r\n      const response = await fetch(`${API_ENDPOINT}/${systemId}/restore`, {\r\n        method: 'POST',\r\n        credentials: 'include',\r\n        headers: { 'Content-Type': 'application/json' },\r\n      });\r\n      if (!response.ok) console.warn('[Customer API] Restore sync failed');\r\n      else console.log('[Customer API] Restored:', systemId);\r\n    } catch (e) {\r\n      console.warn('[Customer API] Restore sync error:', e);\r\n    }\r\n  },\r\n};\r\n\r\n// ✅ Wrap base store methods with API sync\r\nconst originalAdd = baseStore.getState().add;\r\nconst originalUpdate = baseStore.getState().update;\r\nconst originalRemove = baseStore.getState().remove;\r\nconst originalHardDelete = baseStore.getState().hardDelete;\r\nconst originalRestore = baseStore.getState().restore;\r\n\r\nbaseStore.setState({\r\n  add: (item: Omit<Customer, 'systemId'>) => {\r\n    const result = originalAdd(item);\r\n    syncToApi.create(result);\r\n    return result;\r\n  },\r\n  update: (systemId: SystemId, updates: Partial<Customer>) => {\r\n    originalUpdate(systemId, updates);\r\n    syncToApi.update(systemId, updates);\r\n  },\r\n  remove: (systemId: SystemId) => {\r\n    originalRemove(systemId);\r\n    syncToApi.delete(systemId, false);\r\n  },\r\n  hardDelete: (systemId: SystemId) => {\r\n    originalHardDelete(systemId);\r\n    syncToApi.delete(systemId, true);\r\n  },\r\n  restore: (systemId: SystemId) => {\r\n    originalRestore(systemId);\r\n    syncToApi.restore(systemId);\r\n  },\r\n});\r\n\r\n// Define enhanced interface\r\ninterface CustomerStoreState extends CrudState<Customer> {\r\n  searchCustomers: (query: string, page: number, limit?: number) => Promise<{ items: { value: string; label: string }[], hasNextPage: boolean }>;\r\n  updateDebt: (systemId: SystemId, amountChange: number) => void;\r\n  incrementOrderStats: (systemId: SystemId, orderValue: number) => void;\r\n  decrementOrderStats: (systemId: SystemId, orderValue: number) => void;\r\n  incrementReturnStats: (systemId: SystemId, quantity: number) => void;\r\n  incrementFailedDeliveryStats: (systemId: SystemId) => void;\r\n  addDebtTransaction: (systemId: SystemId, transaction: import('./types').DebtTransaction) => void;\r\n  addDebtReminder: (systemId: SystemId, reminder: import('./types').DebtReminder) => void;\r\n  updateDebtReminder: (systemId: SystemId, reminderId: SystemId, updates: Partial<import('./types').DebtReminder>) => void;\r\n  removeDebtReminder: (systemId: SystemId, reminderId: SystemId) => void;\r\n  updateDebtTransactionPayment: (systemId: SystemId, orderId: BusinessId, amountPaid: number) => void;\r\n  removeDebtTransaction: (systemId: SystemId, orderId: BusinessId) => void;\r\n  getHighRiskDebtCustomers: () => Customer[];\r\n  updateCustomerIntelligence: () => void; // Batch update RFM, health score, churn risk\r\n  getCustomersBySegment: (segment: string) => Customer[];\r\n  getOverdueDebtCustomers: () => Customer[];\r\n  getDueSoonCustomers: () => Customer[];\r\n    removeMany: (systemIds: SystemId[]) => void;\r\n    updateManyStatus: (systemIds: SystemId[], status: Customer['status']) => void;\r\n    restoreMany: (systemIds: SystemId[]) => void;\r\n}\r\n\r\n// Augmented methods\r\nconst augmentedMethods = {\r\n    searchCustomers: async (query: string, page: number, limit: number = 20) => {\r\n        return new Promise<{ items: { value: string; label: string }[], hasNextPage: boolean }>(resolve => {\r\n            setTimeout(() => {\r\n                const allCustomers = baseStore.getState().data;\r\n                \r\n                // Create fresh Fuse instance with current data (avoid stale data)\r\n                const fuse = new Fuse(allCustomers, {\r\n                    keys: ['name', 'id', 'phone'],\r\n                    threshold: 0.3,\r\n                });\r\n                \r\n                const results = query ? fuse.search(query).map(r => r.item) : allCustomers;\r\n                \r\n                const start = (page - 1) * limit;\r\n                const end = start + limit;\r\n                const paginatedItems = results.slice(start, end);\r\n\r\n                resolve({\r\n                    items: paginatedItems.map(c => ({ value: c.systemId, label: c.name })),\r\n                    hasNextPage: end < results.length,\r\n                });\r\n            }, 300);\r\n        });\r\n    },\r\n    updateDebt: (systemId: SystemId, amountChange: number) => {\r\n        baseStore.setState(state => ({\r\n            data: state.data.map(customer => {\r\n                if (customer.systemId === systemId) {\r\n                    const newDebt = (customer.currentDebt || 0) + amountChange;\r\n                    // Sync to API\r\n                    syncToApi.update(systemId, { currentDebt: newDebt });\r\n                    return {\r\n                        ...customer,\r\n                        currentDebt: newDebt,\r\n                    };\r\n                }\r\n                return customer;\r\n            })\r\n        }));\r\n    },\r\n    incrementOrderStats: (systemId: SystemId, orderValue: number) => {\r\n        const allCustomers = baseStore.getState().getActive();\r\n        \r\n        baseStore.setState(state => ({\r\n            data: state.data.map(customer => {\r\n                if (customer.systemId === systemId) {\r\n                    const updatedCustomer = {\r\n                        ...customer,\r\n                        totalOrders: (customer.totalOrders || 0) + 1,\r\n                        totalSpent: (customer.totalSpent || 0) + orderValue,\r\n                        lastPurchaseDate: new Date().toISOString().split('T')[0],\r\n                    };\r\n                    \r\n                    // Auto-update intelligence after order stats change\r\n                    const rfmScores = calculateRFMScores(updatedCustomer, allCustomers);\r\n                    const segment = getCustomerSegment(rfmScores);\r\n                    const healthScore = calculateHealthScore(updatedCustomer);\r\n                    const churnRisk = calculateChurnRisk(updatedCustomer).risk;\r\n                    const lifecycleStage = calculateLifecycleStage(updatedCustomer);\r\n                    \r\n                    return {\r\n                        ...updatedCustomer,\r\n                        rfmScores,\r\n                        segment,\r\n                        healthScore,\r\n                        churnRisk,\r\n                        lifecycleStage,\r\n                    };\r\n                }\r\n                return customer;\r\n            })\r\n        }));\r\n    },\r\n    decrementOrderStats: (systemId: SystemId, orderValue: number) => {\r\n        const allCustomers = baseStore.getState().getActive();\r\n        \r\n        baseStore.setState(state => ({\r\n            data: state.data.map(customer => {\r\n                if (customer.systemId === systemId) {\r\n                    const updatedCustomer = {\r\n                        ...customer,\r\n                        totalOrders: Math.max(0, (customer.totalOrders || 0) - 1),\r\n                        totalSpent: Math.max(0, (customer.totalSpent || 0) - orderValue),\r\n                    };\r\n                    \r\n                    // Auto-update intelligence after order stats change\r\n                    const rfmScores = calculateRFMScores(updatedCustomer, allCustomers);\r\n                    const segment = getCustomerSegment(rfmScores);\r\n                    const healthScore = calculateHealthScore(updatedCustomer);\r\n                    const churnRisk = calculateChurnRisk(updatedCustomer).risk;\r\n                    const lifecycleStage = calculateLifecycleStage(updatedCustomer);\r\n                    \r\n                    return {\r\n                        ...updatedCustomer,\r\n                        rfmScores,\r\n                        segment,\r\n                        healthScore,\r\n                        churnRisk,\r\n                        lifecycleStage,\r\n                    };\r\n                }\r\n                return customer;\r\n            })\r\n        }));\r\n    },\r\n    incrementReturnStats: (systemId: SystemId, quantity: number) => {\r\n        baseStore.setState(state => ({\r\n            data: state.data.map(customer => {\r\n                if (customer.systemId === systemId) {\r\n                    return {\r\n                        ...customer,\r\n                        totalQuantityReturned: (customer.totalQuantityReturned || 0) + quantity,\r\n                    };\r\n                }\r\n                return customer;\r\n            })\r\n        }));\r\n    },\r\n    incrementFailedDeliveryStats: (systemId: SystemId) => {\r\n        baseStore.setState(state => ({\r\n            data: state.data.map(customer => {\r\n                if (customer.systemId === systemId) {\r\n                    return {\r\n                        ...customer,\r\n                        failedDeliveries: (customer.failedDeliveries || 0) + 1,\r\n                    };\r\n                }\r\n                return customer;\r\n            })\r\n        }));\r\n    },\r\n    addDebtTransaction: (systemId: SystemId, transaction: import('./types').DebtTransaction) => {\r\n        baseStore.setState(state => ({\r\n            data: state.data.map(customer => {\r\n                if (customer.systemId === systemId) {\r\n                    const currentTransactions = customer.debtTransactions || [];\r\n                    // Avoid duplicates\r\n                    if (currentTransactions.some(t => t.orderId === transaction.orderId)) {\r\n                        return customer;\r\n                    }\r\n\r\n                    const outstandingAmount = Math.max(transaction.remainingAmount ?? transaction.amount ?? 0, 0);\r\n                    return {\r\n                        ...customer,\r\n                        currentDebt: Math.max(0, (customer.currentDebt || 0) + outstandingAmount),\r\n                        debtTransactions: [...currentTransactions, transaction],\r\n                    };\r\n                }\r\n                return customer;\r\n            })\r\n        }));\r\n    },\r\n    updateDebtTransactionPayment: (systemId: SystemId, orderId: BusinessId, amountPaid: number) => {\r\n        baseStore.setState(state => ({\r\n            data: state.data.map(customer => {\r\n                if (customer.systemId === systemId && customer.debtTransactions) {\r\n                    let debtDelta = 0;\r\n                    const updatedTransactions = customer.debtTransactions.map(t => {\r\n                        if (t.orderId !== orderId) {\r\n                            return t;\r\n                        }\r\n\r\n                        const currentPaid = t.paidAmount || 0;\r\n                        const currentRemaining = t.remainingAmount ?? Math.max(t.amount - currentPaid, 0);\r\n                        let appliedAmount = amountPaid;\r\n\r\n                        if (appliedAmount > 0) {\r\n                            appliedAmount = Math.min(appliedAmount, currentRemaining);\r\n                        } else if (appliedAmount < 0) {\r\n                            appliedAmount = Math.max(appliedAmount, -currentPaid);\r\n                        }\r\n\r\n                        const newPaidAmount = currentPaid + appliedAmount;\r\n                        const recalculatedRemaining = Math.max(t.amount - newPaidAmount, 0);\r\n                        debtDelta -= appliedAmount;\r\n\r\n                        return {\r\n                            ...t,\r\n                            paidAmount: newPaidAmount,\r\n                            remainingAmount: recalculatedRemaining,\r\n                            isPaid: recalculatedRemaining <= 0,\r\n                            paidDate: recalculatedRemaining <= 0 ? new Date().toISOString().split('T')[0] : t.paidDate,\r\n                        };\r\n                    });\r\n\r\n                    return {\r\n                        ...customer,\r\n                        currentDebt: Math.max(0, (customer.currentDebt || 0) + debtDelta),\r\n                        debtTransactions: updatedTransactions,\r\n                    };\r\n                }\r\n                return customer;\r\n            })\r\n        }));\r\n    },\r\n    removeDebtTransaction: (systemId: SystemId, orderId: BusinessId) => {\r\n        baseStore.setState(state => ({\r\n            data: state.data.map(customer => {\r\n                if (customer.systemId === systemId && customer.debtTransactions) {\r\n                    const transaction = customer.debtTransactions.find(t => t.orderId === orderId);\r\n                    const outstanding = transaction\r\n                        ? Math.max(transaction.remainingAmount ?? (transaction.amount - (transaction.paidAmount || 0)), 0)\r\n                        : 0;\r\n                    return {\r\n                        ...customer,\r\n                        currentDebt: Math.max(0, (customer.currentDebt || 0) - outstanding),\r\n                        debtTransactions: customer.debtTransactions.filter(t => t.orderId !== orderId),\r\n                    };\r\n                }\r\n                return customer;\r\n            })\r\n        }));\r\n    },\r\n    // Add debt reminder (3.3)\r\n    addDebtReminder: (systemId: SystemId, reminder: import('./types').DebtReminder) => {\r\n        baseStore.setState(state => ({\r\n            data: state.data.map(customer => {\r\n                if (customer.systemId === systemId) {\r\n                    const currentReminders = customer.debtReminders || [];\r\n                    return {\r\n                        ...customer,\r\n                        debtReminders: [...currentReminders, reminder],\r\n                    };\r\n                }\r\n                return customer;\r\n            })\r\n        }));\r\n    },\r\n    // Update debt reminder (3.3)\r\n    updateDebtReminder: (systemId: SystemId, reminderId: SystemId, updates: Partial<import('./types').DebtReminder>) => {\r\n        baseStore.setState(state => ({\r\n            data: state.data.map(customer => {\r\n                if (customer.systemId === systemId && customer.debtReminders) {\r\n                    return {\r\n                        ...customer,\r\n                        debtReminders: customer.debtReminders.map(r =>\r\n                            r.systemId === reminderId ? { ...r, ...updates } : r\r\n                        ),\r\n                    };\r\n                }\r\n                return customer;\r\n            })\r\n        }));\r\n    },\r\n    // Remove debt reminder (3.3)\r\n    removeDebtReminder: (systemId: SystemId, reminderId: SystemId) => {\r\n        baseStore.setState(state => ({\r\n            data: state.data.map(customer => {\r\n                if (customer.systemId === systemId && customer.debtReminders) {\r\n                    return {\r\n                        ...customer,\r\n                        debtReminders: customer.debtReminders.filter(r => r.systemId !== reminderId),\r\n                    };\r\n                }\r\n                return customer;\r\n            })\r\n        }));\r\n    },\r\n    // Override add to auto-calculate lifecycle stage and log activity\r\n    add: (customer: Omit<Customer, 'systemId'>) => {\r\n        const userInfo = getCurrentUserInfo();\r\n        const customerWithLifecycle = {\r\n            ...customer,\r\n            lifecycleStage: calculateLifecycleStage(customer as Customer)\r\n        };\r\n        const newCustomer = baseStore.getState().add(customerWithLifecycle);\r\n        \r\n        // Add activity history entry\r\n        const historyEntry = createCreatedEntry(\r\n            userInfo,\r\n            `${userInfo.name} đã tạo khách hàng ${newCustomer.name} (${newCustomer.id})`\r\n        );\r\n        baseStore.getState().update(newCustomer.systemId, {\r\n            ...newCustomer,\r\n            activityHistory: [historyEntry]\r\n        });\r\n        \r\n        return newCustomer;\r\n    },\r\n    // Override update to auto-calculate lifecycle stage and log activity\r\n    update: (systemId: SystemId, updatedCustomer: Customer) => {\r\n        console.log('[CustomerStore] update called:', { systemId, updatedCustomer });\r\n        \r\n        const userInfo = getCurrentUserInfo();\r\n        const existingCustomer = baseStore.getState().data.find(c => c.systemId === systemId);\r\n        const historyEntries: HistoryEntry[] = [];\r\n        \r\n        if (existingCustomer) {\r\n            // Track status changes\r\n            if (existingCustomer.status !== updatedCustomer.status) {\r\n                historyEntries.push(createStatusChangedEntry(\r\n                    userInfo,\r\n                    existingCustomer.status,\r\n                    updatedCustomer.status,\r\n                    `${userInfo.name} đã đổi trạng thái từ \"${existingCustomer.status}\" sang \"${updatedCustomer.status}\"`\r\n                ));\r\n            }\r\n            \r\n            // Track field changes\r\n            const fieldsToTrack: Array<{ key: keyof Customer; label: string }> = [\r\n                { key: 'name', label: 'Tên khách hàng' },\r\n                { key: 'email', label: 'Email' },\r\n                { key: 'phone', label: 'Số điện thoại' },\r\n                { key: 'company', label: 'Công ty' },\r\n                { key: 'taxCode', label: 'Mã số thuế' },\r\n                { key: 'representative', label: 'Người đại diện' },\r\n                { key: 'type', label: 'Loại khách hàng' },\r\n                { key: 'customerGroup', label: 'Nhóm khách hàng' },\r\n                { key: 'lifecycleStage', label: 'Giai đoạn vòng đời' },\r\n                { key: 'maxDebt', label: 'Hạn mức công nợ' },\r\n                { key: 'paymentTerms', label: 'Điều khoản thanh toán' },\r\n                { key: 'creditRating', label: 'Xếp hạng tín dụng' },\r\n                { key: 'pricingLevel', label: 'Mức giá' },\r\n                { key: 'defaultDiscount', label: 'Chiết khấu mặc định' },\r\n                { key: 'accountManagerId', label: 'Nhân viên phụ trách' },\r\n            ];\r\n            \r\n            const changes: string[] = [];\r\n            for (const field of fieldsToTrack) {\r\n                const oldVal = existingCustomer[field.key];\r\n                const newVal = updatedCustomer[field.key];\r\n                if (oldVal !== newVal && !(oldVal === undefined && newVal === undefined)) {\r\n                    // Skip if it's the status field (already tracked above)\r\n                    if (field.key === 'status') continue;\r\n                    const oldDisplay = oldVal !== undefined && oldVal !== null && oldVal !== '' ? String(oldVal) : '(trống)';\r\n                    const newDisplay = newVal !== undefined && newVal !== null && newVal !== '' ? String(newVal) : '(trống)';\r\n                    changes.push(`${field.label}: ${oldDisplay} → ${newDisplay}`);\r\n                }\r\n            }\r\n            \r\n            if (changes.length > 0) {\r\n                historyEntries.push(createUpdatedEntry(\r\n                    userInfo,\r\n                    `${userInfo.name} đã cập nhật: ${changes.join(', ')}`\r\n                ));\r\n            }\r\n        }\r\n        \r\n        const customerWithLifecycle = {\r\n            ...updatedCustomer,\r\n            lifecycleStage: calculateLifecycleStage(updatedCustomer),\r\n            activityHistory: appendHistoryEntry(existingCustomer?.activityHistory, ...historyEntries)\r\n        };\r\n        console.log('[CustomerStore] Calling baseStore.update with:', customerWithLifecycle);\r\n        \r\n        // Call the update function from baseStore directly\r\n        baseStore.getState().update(systemId, customerWithLifecycle);\r\n        \r\n        console.log('[CustomerStore] State after update:', baseStore.getState().data.find(c => c.systemId === systemId));\r\n    },\r\n    // Get customers with high debt risk\r\n    getHighRiskDebtCustomers: () => {\r\n        const activeCustomers = baseStore.getState().getActive();\r\n        return getHighRiskDebtCustomers(activeCustomers);\r\n    },\r\n    // Batch update customer intelligence (RFM, health score, churn risk)\r\n    updateCustomerIntelligence: () => {\r\n        const allCustomers = baseStore.getState().getActive();\r\n        \r\n        baseStore.setState(state => ({\r\n            data: state.data.map(customer => {\r\n                if (customer.isDeleted) return customer;\r\n                \r\n                // Calculate RFM\r\n                const rfmScores = calculateRFMScores(customer, allCustomers);\r\n                const segment = getCustomerSegment(rfmScores);\r\n                \r\n                // Calculate health score\r\n                const healthScore = calculateHealthScore(customer);\r\n                \r\n                // Calculate churn risk\r\n                const churnRisk = calculateChurnRisk(customer).risk;\r\n                \r\n                // Calculate lifecycle stage\r\n                const lifecycleStage = calculateLifecycleStage(customer);\r\n                \r\n                return {\r\n                    ...customer,\r\n                    rfmScores,\r\n                    segment,\r\n                    healthScore,\r\n                    churnRisk,\r\n                    lifecycleStage\r\n                };\r\n            })\r\n        }));\r\n    },\r\n    // Get customers by segment\r\n    getCustomersBySegment: (segment: string) => {\r\n        return baseStore.getState().getActive().filter(c => c.segment === segment);\r\n    },\r\n    // Get customers with overdue debt\r\n    getOverdueDebtCustomers: () => {\r\n        const activeCustomers = baseStore.getState().getActive();\r\n        return getOverdueDebtCustomers(activeCustomers);\r\n    },\r\n    // Get customers with debt due soon\r\n    getDueSoonCustomers: () => {\r\n        const activeCustomers = baseStore.getState().getActive();\r\n        return getDueSoonCustomers(activeCustomers);\r\n    },\r\n    removeMany: (systemIds: SystemId[]) => {\r\n        if (!systemIds.length) return;\r\n        const deletedAtTimestamp = new Date().toISOString();\r\n        baseStore.setState(state => ({\r\n            data: state.data.map(customer =>\r\n                systemIds.includes(customer.systemId)\r\n                    ? { ...customer, isDeleted: true, deletedAt: deletedAtTimestamp }\r\n                    : customer\r\n            )\r\n        }));\r\n    },\r\n    updateManyStatus: (systemIds: SystemId[], status: Customer['status']) => {\r\n        if (!systemIds.length) return;\r\n        baseStore.setState(state => ({\r\n            data: state.data.map(customer =>\r\n                systemIds.includes(customer.systemId)\r\n                    ? { ...customer, status }\r\n                    : customer\r\n            )\r\n        }));\r\n    },\r\n    restoreMany: (systemIds: SystemId[]) => {\r\n        if (!systemIds.length) return;\r\n        baseStore.setState(state => ({\r\n            data: state.data.map(customer =>\r\n                systemIds.includes(customer.systemId)\r\n                    ? { ...customer, isDeleted: false, deletedAt: null }\r\n                    : customer\r\n            )\r\n        }));\r\n    }\r\n};\r\n\r\ntype CustomerStoreSelector<T> = (state: CustomerStoreState) => T;\r\n\r\nlet cachedBaseState: CrudState<Customer> | null = null;\r\nlet cachedCombinedState: CustomerStoreState | null = null;\r\n\r\nconst getCombinedState = (state: CrudState<Customer>): CustomerStoreState => {\r\n    if (cachedBaseState !== state || !cachedCombinedState) {\r\n        cachedBaseState = state;\r\n        cachedCombinedState = { ...state, ...augmentedMethods } as CustomerStoreState;\r\n    }\r\n    return cachedCombinedState!;\r\n};\r\n\r\nconst boundStore = baseStore as unknown as {\r\n    <R>(selector: (state: CrudState<Customer>) => R, equalityFn?: (a: R, b: R) => boolean): R;\r\n    (): CustomerStoreState;\r\n};\r\n\r\nexport const useCustomerStore = <T = CustomerStoreState>(\r\n    selector?: CustomerStoreSelector<T>,\r\n    equalityFn?: (a: T, b: T) => boolean\r\n): T => {\r\n    if (selector) {\r\n        if (equalityFn) {\r\n            return boundStore((state) => selector(getCombinedState(state)), equalityFn);\r\n        }\r\n        return boundStore((state) => selector(getCombinedState(state)));\r\n    }\r\n    return boundStore((state) => getCombinedState(state) as unknown as T);\r\n};\r\n\r\nuseCustomerStore.getState = (): CustomerStoreState => {\r\n    return getCombinedState(baseStore.getState());\r\n};\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1519, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/complaints/store.ts"],"sourcesContent":["import { create } from \"zustand\";\r\nimport { ENTITY_PREFIXES } from \"@/lib/smart-prefix\";\r\nimport { asSystemId, asBusinessId, type SystemId, type BusinessId } from \"@/lib/id-types\";\r\nimport type {\r\n  Complaint,\r\n  ComplaintStatus,\r\n  ComplaintType,\r\n  ComplaintResolution,\r\n  ComplaintVerification,\r\n  ComplaintAction,\r\n  ComplaintImage,\r\n} from \"./types\";\r\n\r\nconst complaintSeedData: Complaint[] = [\r\n  {\r\n    systemId: asSystemId(\"COMPLAINT000001\"),\r\n    id: asBusinessId(\"PKN000001\"),\r\n    publicTrackingCode: \"rb5n8xzhrm\",\r\n    orderSystemId: asSystemId(\"ORDER000001\"),\r\n    orderCode: \"DH000001\",\r\n    orderValue: 16550000,\r\n    branchSystemId: asSystemId(\"BRANCH000003\"),\r\n    branchName: \"Chi nhánh Trung tâm\",\r\n    customerSystemId: asSystemId(\"CUST000001\"),\r\n    customerId: \"KH000001\",\r\n    customerName: \"Công ty Cổ phần Bất động sản Hưng Thịnh\",\r\n    customerPhone: \"0901112233\",\r\n    type: \"missing-items\",\r\n    description: \"Khách nhận thiếu adapter USB-C trong hộp laptop Dell Inspiron 15.\",\r\n    images: [\r\n      {\r\n        id: asSystemId(\"CMPIMG000001\"),\r\n        url: \"https://images.unsplash.com/photo-1517336714731-489689fd1ca8?auto=format&fit=crop&w=640&q=80\",\r\n        uploadedBy: asSystemId(\"EMP000002\"),\r\n        uploadedAt: new Date(\"2025-11-14T09:00:00Z\"),\r\n        description: \"Ảnh khách chụp hộp sản phẩm\",\r\n        type: \"initial\",\r\n      },\r\n    ],\r\n    employeeImages: [],\r\n    status: \"investigating\",\r\n    verification: \"pending-verification\",\r\n    createdBy: asSystemId(\"EMP000002\"),\r\n    createdAt: new Date(\"2025-11-14T08:45:00Z\"),\r\n    assignedTo: asSystemId(\"EMP000005\"),\r\n    assigneeName: \"Lê Văn Kho\", // Tên nhân viên xử lý\r\n    assignedAt: new Date(\"2025-11-14T09:15:00Z\"),\r\n    investigationNote: \"Kho xác nhận thiếu phụ kiện trong kiện hàng. Đang kiểm tra tồn kho để gửi bổ sung.\",\r\n    evidenceImages: [],\r\n    proposedSolution: \"Gửi bổ sung adapter trong 24h và tặng voucher 2% cho đơn tiếp theo.\",\r\n    timeline: [\r\n      {\r\n        id: asSystemId(\"CMPACT000001\"),\r\n        actionType: \"created\",\r\n        performedBy: asSystemId(\"EMP000002\"),\r\n        performedAt: new Date(\"2025-11-14T08:45:00Z\"),\r\n        note: \"Tạo phiếu khiếu nại từ khách Hưng Thịnh.\",\r\n      },\r\n      {\r\n        id: asSystemId(\"CMPACT000002\"),\r\n        actionType: \"assigned\",\r\n        performedBy: asSystemId(\"EMP000002\"),\r\n        performedAt: new Date(\"2025-11-14T09:15:00Z\"),\r\n        note: \"Giao cho nhân viên kho kiểm tra.\",\r\n      },\r\n      {\r\n        id: asSystemId(\"CMPACT000003\"),\r\n        actionType: \"investigated\",\r\n        performedBy: asSystemId(\"EMP000005\"),\r\n        performedAt: new Date(\"2025-11-14T11:00:00Z\"),\r\n        note: \"Đang chờ adapter bổ sung từ kho trung tâm.\",\r\n      },\r\n    ],\r\n    priority: \"high\",\r\n    tags: [\"Hưng Thịnh\", \"Thiếu phụ kiện\"],\r\n    updatedAt: new Date(\"2025-11-14T11:15:00Z\"),\r\n    affectedProducts: [\r\n      {\r\n        productSystemId: asSystemId(\"SP000001\"),\r\n        productId: \"SP000001\",\r\n        productName: \"Laptop Dell Inspiron 15\",\r\n        unitPrice: 15000000,\r\n        quantityOrdered: 1,\r\n        quantityReceived: 1,\r\n        quantityMissing: 1,\r\n        quantityDefective: 0,\r\n        quantityExcess: 0,\r\n        issueType: \"missing\",\r\n        note: \"Thiếu adapter USB-C trong hộp\",\r\n        resolutionType: \"replacement\",\r\n      },\r\n    ],\r\n  },\r\n  {\r\n    systemId: asSystemId(\"COMPLAINT000002\"),\r\n    id: asBusinessId(\"PKN000002\"),\r\n    publicTrackingCode: \"m1p9l0sdxz\",\r\n    orderSystemId: asSystemId(\"ORDER000005\"),\r\n    orderCode: \"DH000005\",\r\n    orderValue: 3775000,\r\n    branchSystemId: asSystemId(\"BRANCH000004\"),\r\n    branchName: \"Chi nhánh Quận 3\",\r\n    customerSystemId: asSystemId(\"CUST000001\"),\r\n    customerId: \"KH000001\",\r\n    customerName: \"Công ty Cổ phần Bất động sản Hưng Thịnh\",\r\n    customerPhone: \"0901112233\",\r\n    type: \"product-condition\",\r\n    description: \"Keycap custom bị trầy và 6 switch Gateron không nhận tín hiệu sau khi lắp.\",\r\n    images: [\r\n      {\r\n        id: asSystemId(\"CMPIMG000002\"),\r\n        url: \"https://images.unsplash.com/photo-1503602642458-232111445657?auto=format&fit=crop&w=640&q=80\",\r\n        uploadedBy: asSystemId(\"EMP000003\"),\r\n        uploadedAt: new Date(\"2025-11-19T02:20:00Z\"),\r\n        description: \"Ảnh khách gửi về keycap trầy\",\r\n        type: \"initial\",\r\n      },\r\n      {\r\n        id: asSystemId(\"CMPIMG000003\"),\r\n        url: \"https://images.unsplash.com/photo-1478562853135-c3c9e3ef7905?auto=format&fit=crop&w=640&q=80\",\r\n        uploadedBy: asSystemId(\"EMP000003\"),\r\n        uploadedAt: new Date(\"2025-11-19T02:25:00Z\"),\r\n        description: \"Ảnh switch lỗi\",\r\n        type: \"initial\",\r\n      },\r\n    ],\r\n    employeeImages: [],\r\n    status: \"resolved\",\r\n    verification: \"verified-correct\",\r\n    createdBy: asSystemId(\"EMP000003\"),\r\n    createdAt: new Date(\"2025-11-19T02:10:00Z\"),\r\n    assignedTo: asSystemId(\"EMP000003\"),\r\n    assigneeName: \"Trần Thị Hoa\", // Tên nhân viên xử lý\r\n    assignedAt: new Date(\"2025-11-19T02:15:00Z\"),\r\n    investigationNote: \"Đã test tại cửa hàng, xác nhận 6 switch lỗi. Keycap bị trầy do quá trình đóng gói.\",\r\n    evidenceImages: [\r\n      \"https://images.unsplash.com/photo-1485827404703-89b55fcc595e?auto=format&fit=crop&w=640&q=80\",\r\n    ],\r\n    proposedSolution: \"Hoàn 60.000đ cho switch lỗi và gửi kèm bộ switch mới dự phòng.\",\r\n    timeline: [\r\n      {\r\n        id: asSystemId(\"CMPACT000004\"),\r\n        actionType: \"created\",\r\n        performedBy: asSystemId(\"EMP000003\"),\r\n        performedAt: new Date(\"2025-11-19T02:10:00Z\"),\r\n        note: \"Khách báo switch lỗi và keycap trầy.\",\r\n      },\r\n      {\r\n        id: asSystemId(\"CMPACT000005\"),\r\n        actionType: \"investigated\",\r\n        performedBy: asSystemId(\"EMP000003\"),\r\n        performedAt: new Date(\"2025-11-19T10:30:00Z\"),\r\n        note: \"Đã kiểm tra thực tế, xác nhận lỗi.\",\r\n      },\r\n      {\r\n        id: asSystemId(\"CMPACT000006\"),\r\n        actionType: \"verified\",\r\n        performedBy: asSystemId(\"EMP000003\"),\r\n        performedAt: new Date(\"2025-11-20T04:00:00Z\"),\r\n        note: \"Xác nhận lỗi thuộc về kho đóng gói.\",\r\n      },\r\n      {\r\n        id: asSystemId(\"CMPACT000007\"),\r\n        actionType: \"resolved\",\r\n        performedBy: asSystemId(\"EMP000003\"),\r\n        performedAt: new Date(\"2025-11-20T05:00:00Z\"),\r\n        note: \"Hoàn tiền và tạo voucher xin lỗi khách.\",\r\n      },\r\n    ],\r\n    resolution: \"refund\",\r\n    resolutionNote: \"Hoàn 60.000đ cho switch lỗi, tặng voucher 5% và gửi switch mới.\",\r\n    resolvedBy: asSystemId(\"EMP000003\"),\r\n    resolvedAt: new Date(\"2025-11-20T05:00:00Z\"),\r\n    responsibleUserId: asSystemId(\"EMP000003\"),\r\n    isVerifiedCorrect: true,\r\n    priority: \"medium\",\r\n    tags: [\"Keychron\", \"Switch lỗi\"],\r\n    updatedAt: new Date(\"2025-11-20T05:30:00Z\"),\r\n    affectedProducts: [\r\n      {\r\n        productSystemId: asSystemId(\"SP000008\"),\r\n        productId: \"SP000008\",\r\n        productName: \"Bàn phím cơ Keychron K2\",\r\n        unitPrice: 2500000,\r\n        quantityOrdered: 1,\r\n        quantityReceived: 1,\r\n        quantityMissing: 0,\r\n        quantityDefective: 1,\r\n        quantityExcess: 0,\r\n        issueType: \"defective\",\r\n        note: \"Keycap trầy nhẹ\",\r\n        resolutionType: \"replacement\",\r\n      },\r\n      {\r\n        productSystemId: asSystemId(\"SP000010\"),\r\n        productId: \"SP000010\",\r\n        productName: \"Switch Gateron Yellow\",\r\n        unitPrice: 5000,\r\n        quantityOrdered: 90,\r\n        quantityReceived: 90,\r\n        quantityMissing: 0,\r\n        quantityDefective: 6,\r\n        quantityExcess: 0,\r\n        issueType: \"defective\",\r\n        note: \"6 switch không nhận tín hiệu\",\r\n        resolutionType: \"refund\",\r\n      },\r\n    ],\r\n  },\r\n];\r\n\r\n// =============================================\r\n// HELPER FUNCTIONS\r\n// =============================================\r\n\r\n/**\r\n * Generate random public tracking code (10 chars: a-z, 0-9)\r\n * Example: rb5n8xzhrm\r\n */\r\nfunction generatePublicTrackingCode(): string {\r\n  const chars = 'abcdefghijklmnopqrstuvwxyz0123456789';\r\n  let result = '';\r\n  for (let i = 0; i < 10; i++) {\r\n    result += chars.charAt(Math.floor(Math.random() * chars.length));\r\n  }\r\n  return result;\r\n}\r\n\r\n// =============================================\r\n// STORE STATE INTERFACE\r\n// =============================================\r\n\r\ninterface ComplaintFilters {\r\n  status: ComplaintStatus | \"all\";\r\n  type: ComplaintType | \"all\";\r\n  verification: ComplaintVerification | \"all\";\r\n  assignedTo: SystemId | \"all\";  // Use SystemId for assignedTo\r\n  dateRange?: { from: Date; to: Date };\r\n  priority?: \"low\" | \"medium\" | \"high\" | \"urgent\" | \"all\";\r\n}\r\n\r\ninterface ComplaintStore {\r\n  // State\r\n  complaints: Complaint[];\r\n  filters: ComplaintFilters;\r\n  searchQuery: string;\r\n  selectedComplaintId: SystemId | null;\r\n\r\n  // Actions - CRUD (sử dụng store-factory internally)\r\n  addComplaint: (complaint: Omit<Complaint, \"systemId\" | \"createdAt\" | \"updatedAt\" | \"timeline\" | \"id\"> & { id?: BusinessId }) => SystemId;\r\n  updateComplaint: (systemId: SystemId, updates: Partial<Complaint>) => void;\r\n  deleteComplaint: (systemId: SystemId) => void;\r\n  getComplaintById: (systemId: SystemId) => Complaint | undefined;\r\n\r\n  // Actions - Workflow\r\n  assignComplaint: (id: SystemId, userId: SystemId, userName?: string) => void;\r\n  startInvestigation: (id: SystemId, note: string) => void;\r\n  submitEvidence: (id: SystemId, evidenceImages: string[], investigationNote: string, proposedSolution: string) => void;\r\n  verifyComplaint: (id: SystemId, isCorrect: boolean, note: string) => void;\r\n  resolveComplaint: (\r\n    id: SystemId,\r\n    resolution: ComplaintResolution,\r\n    resolutionNote: string,\r\n    responsibleUserId?: SystemId\r\n  ) => void;\r\n  rejectComplaint: (id: SystemId, reason: string) => void;\r\n\r\n  // Actions - Images\r\n  addComplaintImage: (id: SystemId, image: ComplaintImage) => void;\r\n  removeComplaintImage: (id: SystemId, imageId: SystemId) => void;\r\n\r\n  // Actions - Filters & Search\r\n  setFilters: (filters: Partial<ComplaintFilters>) => void;\r\n  resetFilters: () => void;\r\n  setSearchQuery: (query: string) => void;\r\n  setSelectedComplaint: (id: SystemId | null) => void;\r\n\r\n  // Computed\r\n  getFilteredComplaints: () => Complaint[];\r\n  getComplaintsByStatus: (status: ComplaintStatus) => Complaint[];\r\n  getComplaintsByAssignee: (userId: SystemId) => Complaint[];\r\n  getStats: () => {\r\n    total: number;\r\n    pending: number;\r\n    investigating: number;\r\n    resolved: number;\r\n    rejected: number;\r\n    verifiedCorrect: number;\r\n    verifiedIncorrect: number;\r\n  };\r\n}\r\n\r\n// =============================================\r\n// DEFAULT VALUES\r\n// =============================================\r\n\r\nconst defaultFilters: ComplaintFilters = {\r\n  status: \"all\",\r\n  type: \"all\",\r\n  verification: \"all\",\r\n  assignedTo: \"all\",\r\n  priority: \"all\",\r\n};\r\n\r\n// =============================================\r\n// STORE IMPLEMENTATION\r\n// =============================================\r\n\r\nexport const useComplaintStore = create<ComplaintStore>()(\r\n  (set, get) => ({\r\n      // Initial State - Load sample data if empty\r\n      complaints: complaintSeedData,\r\n      filters: defaultFilters,\r\n      searchQuery: \"\",\r\n      selectedComplaintId: null,\r\n\r\n      // =============================================\r\n      // CRUD ACTIONS (Using store-factory logic)\r\n      // =============================================\r\n\r\n      addComplaint: (complaintData) => {\r\n        const currentComplaints = get().complaints;\r\n        \r\n        const BUSINESS_PREFIX = ENTITY_PREFIXES['complaints']; // 'PKN'\r\n        const SYSTEM_PREFIX = 'COMPLAINT';\r\n        \r\n        // Generate SystemId (6 digits) - COMPLAINT000001, COMPLAINT000002\r\n        const maxSystemIdNumber = currentComplaints.length > 0\r\n          ? Math.max(...currentComplaints.map(c => {\r\n              const match = c.systemId.match(/COMPLAINT(\\d{6})/);\r\n              return match ? parseInt(match[1]) : 0;\r\n            }))\r\n          : 0;\r\n        const systemId = asSystemId(`${SYSTEM_PREFIX}${String(maxSystemIdNumber + 1).padStart(6, '0')}`);\r\n        \r\n        // Generate Business ID (6 digits) - PKN000001, PKN000002 (if not provided)\r\n        let idValue: BusinessId | null = complaintData.id ?? null;\r\n        let id: string = idValue ? String(idValue) : '';\r\n        if (!id) {\r\n          const maxBusinessIdNumber = currentComplaints.length > 0\r\n            ? Math.max(...currentComplaints.map(c => {\r\n                const match = c.id?.match(/PKN(\\d{6})/);\r\n                return match ? parseInt(match[1]) : 0;\r\n              }))\r\n            : 0;\r\n          id = `${BUSINESS_PREFIX}${String(maxBusinessIdNumber + 1).padStart(6, '0')}`;\r\n        } else {\r\n          // Validate unique ID (case-insensitive)\r\n          const existingIds = currentComplaints.map(c => c.id?.toLowerCase());\r\n          if (existingIds.includes(id.toLowerCase())) {\r\n            throw new Error(`Mã \"${id}\" đã tồn tại! Vui lòng sử dụng mã khác.`);\r\n          }\r\n          // Sanitize ID: uppercase + remove spaces\r\n          id = id.toUpperCase().trim().replace(/\\s+/g, '');\r\n        }\r\n        const businessId = asBusinessId(id);\r\n        \r\n        // [NOTE] Generate public tracking code for customer\r\n        const publicTrackingCode = (complaintData as any).publicTrackingCode || generatePublicTrackingCode();\r\n        \r\n        const now = new Date();\r\n\r\n        const initialAction: ComplaintAction = {\r\n          id: asSystemId(`action_${Date.now()}`),\r\n          actionType: \"created\",\r\n          performedBy: complaintData.createdBy,\r\n          performedAt: now,\r\n          note: complaintData.description,\r\n        };\r\n\r\n        const newComplaint: Complaint = {\r\n          ...complaintData,\r\n          systemId,\r\n          id: businessId,\r\n          publicTrackingCode, // [NOTE] Add tracking code\r\n          createdAt: now,\r\n          updatedAt: now,\r\n          status: \"pending\",\r\n          verification: \"pending-verification\",\r\n          timeline: [initialAction],\r\n        };\r\n\r\n        set((state) => ({\r\n          complaints: [newComplaint, ...state.complaints],\r\n        }));\r\n\r\n        return systemId; // Return systemId for internal use\r\n      },\r\n\r\n      updateComplaint: (systemId, updates) => {\r\n        set((state) => ({\r\n          complaints: state.complaints.map((complaint) =>\r\n            complaint.systemId === systemId\r\n              ? { ...complaint, ...updates, updatedAt: new Date() }\r\n              : complaint\r\n          ),\r\n        }));\r\n      },\r\n\r\n      deleteComplaint: (systemId) => {\r\n        set((state) => ({\r\n          complaints: state.complaints.filter((c) => c.systemId !== systemId),\r\n        }));\r\n      },\r\n\r\n      getComplaintById: (systemId) => {\r\n        return get().complaints.find((c) => c.systemId === systemId);\r\n      },\r\n\r\n      // =============================================\r\n      // WORKFLOW ACTIONS\r\n      // =============================================\r\n\r\n      assignComplaint: (id, userId, userName) => {\r\n        const complaint = get().complaints.find((c) => c.systemId === id);\r\n        if (!complaint) return;\r\n\r\n        const action: ComplaintAction = {\r\n          id: asSystemId(`action_${Date.now()}`),\r\n          actionType: \"assigned\",\r\n          performedBy: userId,\r\n          performedAt: new Date(),\r\n          note: userName \r\n            ? `Khiếu nại được giao cho ${userName}` \r\n            : `Khiếu nại được giao cho nhân viên xử lý`,\r\n        };\r\n\r\n        get().updateComplaint(id, {\r\n          assignedTo: userId,\r\n          assigneeName: userName,\r\n          assignedAt: new Date(),\r\n          status: \"investigating\",\r\n          timeline: [...complaint.timeline, action],\r\n        });\r\n      },\r\n\r\n      startInvestigation: (id, note) => {\r\n        const complaint = get().complaints.find((c) => c.systemId === id);\r\n        if (!complaint) return;\r\n\r\n        const action: ComplaintAction = {\r\n          id: asSystemId(`action_${Date.now()}`),\r\n          actionType: \"investigated\",\r\n          performedBy: complaint.assignedTo || complaint.createdBy,\r\n          performedAt: new Date(),\r\n          note,\r\n        };\r\n\r\n        get().updateComplaint(id, {\r\n          status: \"investigating\",\r\n          timeline: [...complaint.timeline, action],\r\n        });\r\n      },\r\n\r\n      submitEvidence: (id, evidenceImages, investigationNote, proposedSolution) => {\r\n        const complaint = get().complaints.find((c) => c.systemId === id);\r\n        if (!complaint) return;\r\n\r\n        const action: ComplaintAction = {\r\n          id: asSystemId(`action_${Date.now()}`),\r\n          actionType: \"investigated\",\r\n          performedBy: complaint.assignedTo || complaint.createdBy,\r\n          performedAt: new Date(),\r\n          note: investigationNote,\r\n          images: evidenceImages,\r\n        };\r\n\r\n        get().updateComplaint(id, {\r\n          evidenceImages,\r\n          investigationNote,\r\n          proposedSolution,\r\n          timeline: [...complaint.timeline, action],\r\n        });\r\n      },\r\n\r\n      verifyComplaint: (id, isCorrect, note) => {\r\n        const complaint = get().complaints.find((c) => c.systemId === id);\r\n        if (!complaint) return;\r\n\r\n        const action: ComplaintAction = {\r\n          id: asSystemId(`action_${Date.now()}`),\r\n          actionType: \"verified\",\r\n          performedBy: complaint.createdBy, // Manager verify\r\n          performedAt: new Date(),\r\n          note,\r\n        };\r\n\r\n        get().updateComplaint(id, {\r\n          verification: isCorrect ? \"verified-correct\" : \"verified-incorrect\",\r\n          isVerifiedCorrect: isCorrect,\r\n          timeline: [...complaint.timeline, action],\r\n        });\r\n      },\r\n\r\n      resolveComplaint: (id, resolution, resolutionNote, responsibleUserId) => {\r\n        const complaint = get().complaints.find((c) => c.systemId === id);\r\n        if (!complaint) return;\r\n\r\n        const action: ComplaintAction = {\r\n          id: asSystemId(`action_${Date.now()}`),\r\n          actionType: \"resolved\",\r\n          performedBy: complaint.createdBy, // Manager resolves\r\n          performedAt: new Date(),\r\n          note: resolutionNote,\r\n        };\r\n\r\n        const updatePayload: Partial<Complaint> = {\r\n          status: \"resolved\",\r\n          resolution,\r\n          resolutionNote,\r\n          resolvedBy: complaint.createdBy,\r\n          resolvedAt: new Date(),\r\n          timeline: [...complaint.timeline, action],\r\n        };\r\n        if (responsibleUserId) {\r\n          updatePayload.responsibleUserId = responsibleUserId;\r\n        }\r\n        get().updateComplaint(id, updatePayload);\r\n      },\r\n\r\n      rejectComplaint: (id, reason) => {\r\n        const complaint = get().complaints.find((c) => c.systemId === id);\r\n        if (!complaint) return;\r\n\r\n        const action: ComplaintAction = {\r\n          id: asSystemId(`action_${Date.now()}`),\r\n          actionType: \"rejected\",\r\n          performedBy: complaint.createdBy,\r\n          performedAt: new Date(),\r\n          note: reason,\r\n        };\r\n\r\n        get().updateComplaint(id, {\r\n          status: \"ended\",\r\n          resolution: \"rejected\",\r\n          resolutionNote: reason,\r\n          resolvedBy: complaint.createdBy,\r\n          resolvedAt: new Date(),\r\n          timeline: [...complaint.timeline, action],\r\n        });\r\n      },\r\n\r\n      // =============================================\r\n      // IMAGE ACTIONS\r\n      // =============================================\r\n\r\n      addComplaintImage: (id, image) => {\r\n        const complaint = get().complaints.find((c) => c.systemId === id);\r\n        if (!complaint) return;\r\n\r\n        get().updateComplaint(id, {\r\n          images: [...complaint.images, image],\r\n        });\r\n      },\r\n\r\n      removeComplaintImage: (id, imageId) => {\r\n        const complaint = get().complaints.find((c) => c.systemId === id);\r\n        if (!complaint) return;\r\n\r\n        get().updateComplaint(id, {\r\n          images: complaint.images.filter((img) => img.id !== imageId),\r\n        });\r\n      },\r\n\r\n      // =============================================\r\n      // FILTER & SEARCH ACTIONS\r\n      // =============================================\r\n\r\n      setFilters: (filters) => {\r\n        set((state) => ({\r\n          filters: { ...state.filters, ...filters },\r\n        }));\r\n      },\r\n\r\n      resetFilters: () => {\r\n        set({ filters: defaultFilters });\r\n      },\r\n\r\n      setSearchQuery: (query) => {\r\n        set({ searchQuery: query });\r\n      },\r\n\r\n      setSelectedComplaint: (id) => {\r\n        set({ selectedComplaintId: id });\r\n      },\r\n\r\n      // =============================================\r\n      // COMPUTED GETTERS\r\n      // =============================================\r\n\r\n      getFilteredComplaints: () => {\r\n        const { complaints, filters, searchQuery } = get();\r\n\r\n        return complaints.filter((complaint) => {\r\n          // Status filter\r\n          if (filters.status !== \"all\" && complaint.status !== filters.status) {\r\n            return false;\r\n          }\r\n\r\n          // Type filter\r\n          if (filters.type !== \"all\" && complaint.type !== filters.type) {\r\n            return false;\r\n          }\r\n\r\n          // Verification filter\r\n          if (filters.verification !== \"all\" && complaint.verification !== filters.verification) {\r\n            return false;\r\n          }\r\n\r\n          // Assignee filter\r\n          if (filters.assignedTo !== \"all\" && complaint.assignedTo !== filters.assignedTo) {\r\n            return false;\r\n          }\r\n\r\n          // Priority filter\r\n          if (filters.priority !== \"all\" && complaint.priority !== filters.priority) {\r\n            return false;\r\n          }\r\n\r\n          // Date range filter\r\n          if (filters.dateRange) {\r\n            const complaintDate = new Date(complaint.createdAt);\r\n            if (complaintDate < filters.dateRange.from || complaintDate > filters.dateRange.to) {\r\n              return false;\r\n            }\r\n          }\r\n\r\n          // Search query\r\n          if (searchQuery) {\r\n            const query = searchQuery.toLowerCase();\r\n            return (\r\n              (complaint.orderCode || complaint.orderSystemId).toLowerCase().includes(query) || // [NOTE] Fallback\r\n              complaint.customerName.toLowerCase().includes(query) ||\r\n              complaint.customerPhone.includes(query) ||\r\n              complaint.description.toLowerCase().includes(query) ||\r\n              complaint.id.toLowerCase().includes(query) // Search by business ID too\r\n            );\r\n          }\r\n\r\n          return true;\r\n        });\r\n      },\r\n\r\n      getComplaintsByStatus: (status) => {\r\n        return get().complaints.filter((c) => c.status === status);\r\n      },\r\n\r\n      getComplaintsByAssignee: (userId) => {\r\n        return get().complaints.filter((c) => c.assignedTo === userId);\r\n      },\r\n\r\n      getStats: () => {\r\n        const complaints = get().complaints;\r\n\r\n        return {\r\n          total: complaints.length,\r\n          pending: complaints.filter((c) => c.status === \"pending\").length,\r\n          investigating: complaints.filter((c) => c.status === \"investigating\").length,\r\n          resolved: complaints.filter((c) => c.status === \"resolved\").length,\r\n          rejected: complaints.filter((c) => c.resolution === \"rejected\").length,\r\n          verifiedCorrect: complaints.filter((c) => c.verification === \"verified-correct\").length,\r\n          verifiedIncorrect: complaints.filter((c) => c.verification === \"verified-incorrect\").length,\r\n        };\r\n      },\r\n    })\r\n);\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 2087, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/warranty/notification-utils.ts"],"sourcesContent":["/**\r\n * Warranty Notification Utilities\r\n * Handle notification settings and events for warranty tickets\r\n * Pattern copied from Complaints notification system\r\n * \r\n * NOTE: Settings are now synced with database via warranty-settings-sync.ts\r\n */\r\n\r\nimport { toast } from \"sonner\";\r\nimport {\r\n  getWarrantyNotificationsSync,\r\n  saveWarrantyNotificationsAsync,\r\n  type WarrantyNotificationSettings,\r\n} from '@/lib/warranty-settings-sync';\r\n\r\n// Re-export interface for backwards compatibility\r\nexport type { WarrantyNotificationSettings } from '@/lib/warranty-settings-sync';\r\n\r\n// Default notification settings\r\nconst defaultNotifications: WarrantyNotificationSettings = {\r\n  emailOnCreate: true,\r\n  emailOnAssign: true,\r\n  emailOnProcessing: false,\r\n  emailOnProcessed: true,\r\n  emailOnReturned: true,\r\n  emailOnOverdue: true,\r\n  smsOnOverdue: false,\r\n  inAppNotifications: true,\r\n  reminderNotifications: true,\r\n};\r\n\r\n/**\r\n * Load notification settings from database (sync version)\r\n * @deprecated Use getWarrantyNotificationsSync from warranty-settings-sync.ts\r\n */\r\nexport function loadWarrantyNotificationSettings(): WarrantyNotificationSettings {\r\n  return getWarrantyNotificationsSync();\r\n}\r\n\r\n/**\r\n * Save notification settings to database\r\n * @deprecated Use saveWarrantyNotificationsAsync from warranty-settings-sync.ts\r\n */\r\nexport function saveWarrantyNotificationSettings(settings: WarrantyNotificationSettings): void {\r\n  // Fire and forget - save to database in background\r\n  saveWarrantyNotificationsAsync(settings).catch(error => {\r\n    console.error('Failed to save warranty notification settings:', error);\r\n  });\r\n}\r\n\r\n/**\r\n * Show toast notification based on settings\r\n */\r\nexport function showWarrantyNotification(\r\n  type: 'success' | 'error' | 'info' | 'warning',\r\n  message: string,\r\n  options?: { id?: string | number; description?: string | undefined; duration?: number }\r\n) {\r\n  const settings = loadWarrantyNotificationSettings();\r\n  \r\n  // Always show if inAppNotifications is enabled\r\n  if (settings.inAppNotifications) {\r\n    switch (type) {\r\n      case 'success':\r\n        toast.success(message, options);\r\n        break;\r\n      case 'error':\r\n        toast.error(message, options);\r\n        break;\r\n      case 'info':\r\n        toast.info(message, options);\r\n        break;\r\n      case 'warning':\r\n        toast.warning(message, options);\r\n        break;\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * Show loading toast (always shown regardless of settings)\r\n */\r\nexport function showWarrantyLoading(message: string) {\r\n  return toast.loading(message);\r\n}\r\n\r\n/**\r\n * Check if a specific notification event is enabled\r\n */\r\nexport function isWarrantyNotificationEnabled(event: keyof WarrantyNotificationSettings): boolean {\r\n  const settings = loadWarrantyNotificationSettings();\r\n  return settings[event] || false;\r\n}\r\n\r\n/**\r\n * Wrapper functions for specific warranty events\r\n */\r\n\r\nexport function notifyWarrantyCreated(ticketId: string) {\r\n  if (isWarrantyNotificationEnabled('emailOnCreate')) {\r\n    showWarrantyNotification('success', `Đã tạo phiếu bảo hành ${ticketId}`, {\r\n      description: 'Phiếu mới đã được tạo thành công',\r\n    });\r\n  }\r\n}\r\n\r\nexport function notifyWarrantyAssigned(ticketId: string, employeeName: string) {\r\n  if (isWarrantyNotificationEnabled('emailOnAssign')) {\r\n    showWarrantyNotification('info', `Phiếu ${ticketId} được gán cho ${employeeName}`, {\r\n      description: 'Đã cập nhật người phụ trách',\r\n    });\r\n  }\r\n}\r\n\r\nexport function notifyWarrantyProcessing(ticketId: string) {\r\n  if (isWarrantyNotificationEnabled('emailOnProcessing')) {\r\n    showWarrantyNotification('info', `Phiếu ${ticketId} đang được xử lý`, {\r\n      description: 'Nhân viên đã bắt đầu xử lý phiếu',\r\n    });\r\n  }\r\n}\r\n\r\nexport function notifyWarrantyProcessed(ticketId: string) {\r\n  if (isWarrantyNotificationEnabled('emailOnProcessed')) {\r\n    showWarrantyNotification('success', `Phiếu ${ticketId} đã xử lý xong`, {\r\n      description: 'Sản phẩm sẵn sàng để trả khách',\r\n    });\r\n  }\r\n}\r\n\r\nexport function notifyWarrantyReturned(ticketId: string, orderId?: string) {\r\n  if (isWarrantyNotificationEnabled('emailOnReturned')) {\r\n    showWarrantyNotification('success', `Phiếu ${ticketId} đã trả hàng`, {\r\n      description: orderId ? `Liên kết với đơn hàng ${orderId}` : 'Đã hoàn tất quy trình',\r\n    });\r\n  }\r\n}\r\n\r\nexport function notifyWarrantyOverdue(ticketId: string, type: 'response' | 'processing' | 'return') {\r\n  if (isWarrantyNotificationEnabled('emailOnOverdue')) {\r\n    const typeLabels = {\r\n      response: 'phản hồi',\r\n      processing: 'xử lý',\r\n      return: 'trả hàng',\r\n    };\r\n    \r\n    showWarrantyNotification('warning', `Phiếu ${ticketId} quá hạn ${typeLabels[type]}`, {\r\n      description: 'Vui lòng kiểm tra và xử lý ngay',\r\n      duration: 10000, // Show longer for overdue warnings\r\n    });\r\n  }\r\n}\r\n\r\nexport function notifyWarrantyReminder(ticketId: string, message: string) {\r\n  if (isWarrantyNotificationEnabled('reminderNotifications')) {\r\n    showWarrantyNotification('info', `Nhắc nhở: ${ticketId}`, {\r\n      description: message,\r\n      duration: 8000,\r\n    });\r\n  }\r\n}\r\n\r\nexport function notifyWarrantyStatusChange(ticketId: string, oldStatus: string, newStatus: string) {\r\n  showWarrantyNotification('info', `Phiếu ${ticketId} đã chuyển trạng thái`, {\r\n    description: `${oldStatus} → ${newStatus}`,\r\n  });\r\n}\r\n\r\n/**\r\n * Batch notification for multiple tickets\r\n */\r\nexport function notifyWarrantyBulkAction(action: string, count: number) {\r\n  showWarrantyNotification('success', `Đã ${action} ${count} phiếu bảo hành`, {\r\n    description: 'Thao tác hàng loạt thành công',\r\n  });\r\n}\r\n\r\n/**\r\n * Error notification\r\n */\r\nexport function notifyWarrantyError(message: string, details?: string) {\r\n  showWarrantyNotification('error', message, {\r\n    description: details,\r\n    duration: 5000,\r\n  });\r\n}\r\n\r\n/**\r\n * Get notification summary for dashboard\r\n */\r\nexport function getWarrantyNotificationSummary() {\r\n  const settings = loadWarrantyNotificationSettings();\r\n  const enabledCount = Object.values(settings).filter(Boolean).length;\r\n  const totalCount = Object.keys(settings).length;\r\n  \r\n  return {\r\n    enabled: enabledCount,\r\n    total: totalCount,\r\n    percentage: Math.round((enabledCount / totalCount) * 100),\r\n  };\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 2268, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/warranty/use-realtime-updates.ts"],"sourcesContent":["/**\r\n * Realtime Updates Hook for Warranty Module\r\n * Uses in-memory versioning - localStorage has been removed\r\n */\r\n\r\nimport * as React from 'react';\r\nimport { toast } from 'sonner';\r\n\r\n// In-memory version tracking\r\nlet warrantyDataVersion = 0;\r\nconst versionListeners = new Set<() => void>();\r\n\r\ninterface UseRealtimeUpdatesOptions {\r\n  onRefresh: () => void;\r\n  dataVersion: number;\r\n  interval?: number;\r\n}\r\n\r\n/**\r\n * Hook for managing realtime updates with polling\r\n */\r\nexport function useRealtimeUpdates({\r\n  onRefresh,\r\n  dataVersion,\r\n  interval = 30000,\r\n}: UseRealtimeUpdatesOptions) {\r\n  const [hasUpdates, setHasUpdates] = React.useState(false);\r\n  const [isPolling, setIsPolling] = React.useState(false);\r\n  const [lastVersion, setLastVersion] = React.useState(dataVersion);\r\n\r\n  // Subscribe to version changes\r\n  React.useEffect(() => {\r\n    const listener = () => {\r\n      setHasUpdates(true);\r\n    };\r\n    versionListeners.add(listener);\r\n    return () => {\r\n      versionListeners.delete(listener);\r\n    };\r\n  }, []);\r\n\r\n  // Polling effect\r\n  React.useEffect(() => {\r\n    if (!isPolling) return;\r\n\r\n    const timer = setInterval(() => {\r\n      if (warrantyDataVersion > lastVersion) {\r\n        setHasUpdates(true);\r\n      }\r\n    }, interval);\r\n\r\n    return () => clearInterval(timer);\r\n  }, [isPolling, interval, lastVersion]);\r\n\r\n  // Check if data version changed\r\n  React.useEffect(() => {\r\n    if (dataVersion !== lastVersion) {\r\n      setHasUpdates(true);\r\n    }\r\n  }, [dataVersion, lastVersion]);\r\n\r\n  const checkForUpdates = (): boolean => {\r\n    return warrantyDataVersion > lastVersion;\r\n  };\r\n\r\n  const showUpdateNotification = () => {\r\n    toast.info('Có cập nhật mới cho bảo hành', {\r\n      duration: 10000,\r\n      position: 'top-right',\r\n      action: {\r\n        label: 'Làm mới',\r\n        onClick: () => {\r\n          handleRefresh();\r\n        },\r\n      },\r\n    });\r\n  };\r\n\r\n  const handleRefresh = React.useCallback(() => {\r\n    setLastVersion(warrantyDataVersion);\r\n    setHasUpdates(false);\r\n    onRefresh();\r\n    toast.success('Đã làm mới dữ liệu bảo hành');\r\n  }, [onRefresh]);\r\n\r\n  const togglePolling = () => {\r\n    setIsPolling(prev => !prev);\r\n    if (!isPolling) {\r\n      toast.info('Đã bật chế độ cập nhật tự động (30s)', { duration: 3000 });\r\n    } else {\r\n      toast.info('Đã tắt chế độ cập nhật tự động', { duration: 3000 });\r\n    }\r\n  };\r\n\r\n  return {\r\n    hasUpdates,\r\n    isPolling,\r\n    refresh: handleRefresh,\r\n    togglePolling,\r\n  };\r\n}\r\n\r\n/**\r\n * Manual trigger for simulating data updates\r\n * Call this when data changes (e.g., after create/update/delete)\r\n */\r\nexport function triggerWarrantyDataUpdate() {\r\n  warrantyDataVersion++;\r\n  versionListeners.forEach(listener => listener());\r\n}\r\n\r\n/**\r\n * Get current data version\r\n */\r\nexport function getWarrantyDataVersion(): number {\r\n  return warrantyDataVersion;\r\n}\r\n"],"names":[],"mappings":";;;;;;;;AAAA;;;CAGC,GAED;AACA;;;;AAEA,6BAA6B;AAC7B,IAAI,sBAAsB;AAC1B,MAAM,mBAAmB,IAAI;AAWtB,SAAS,mBAAmB,EACjC,SAAS,EACT,WAAW,EACX,WAAW,KAAK,EACU;;IAC1B,MAAM,CAAC,YAAY,cAAc,GAAG,yKAAc,CAAC;IACnD,MAAM,CAAC,WAAW,aAAa,GAAG,yKAAc,CAAC;IACjD,MAAM,CAAC,aAAa,eAAe,GAAG,yKAAc,CAAC;IAErD,+BAA+B;IAC/B,0KAAe;wCAAC;YACd,MAAM;yDAAW;oBACf,cAAc;gBAChB;;YACA,iBAAiB,GAAG,CAAC;YACrB;gDAAO;oBACL,iBAAiB,MAAM,CAAC;gBAC1B;;QACF;uCAAG,EAAE;IAEL,iBAAiB;IACjB,0KAAe;wCAAC;YACd,IAAI,CAAC,WAAW;YAEhB,MAAM,QAAQ;sDAAY;oBACxB,IAAI,sBAAsB,aAAa;wBACrC,cAAc;oBAChB;gBACF;qDAAG;YAEH;gDAAO,IAAM,cAAc;;QAC7B;uCAAG;QAAC;QAAW;QAAU;KAAY;IAErC,gCAAgC;IAChC,0KAAe;wCAAC;YACd,IAAI,gBAAgB,aAAa;gBAC/B,cAAc;YAChB;QACF;uCAAG;QAAC;QAAa;KAAY;IAE7B,MAAM,kBAAkB;QACtB,OAAO,sBAAsB;IAC/B;IAEA,MAAM,yBAAyB;QAC7B,oJAAK,CAAC,IAAI,CAAC,gCAAgC;YACzC,UAAU;YACV,UAAU;YACV,QAAQ;gBACN,OAAO;gBACP,SAAS;oBACP;gBACF;YACF;QACF;IACF;IAEA,MAAM,gBAAgB,4KAAiB;yDAAC;YACtC,eAAe;YACf,cAAc;YACd;YACA,oJAAK,CAAC,OAAO,CAAC;QAChB;wDAAG;QAAC;KAAU;IAEd,MAAM,gBAAgB;QACpB,aAAa,CAAA,OAAQ,CAAC;QACtB,IAAI,CAAC,WAAW;YACd,oJAAK,CAAC,IAAI,CAAC,wCAAwC;gBAAE,UAAU;YAAK;QACtE,OAAO;YACL,oJAAK,CAAC,IAAI,CAAC,kCAAkC;gBAAE,UAAU;YAAK;QAChE;IACF;IAEA,OAAO;QACL;QACA;QACA,SAAS;QACT;IACF;AACF;GA/EgB;AAqFT,SAAS;IACd;IACA,iBAAiB,OAAO,CAAC,CAAA,WAAY;AACvC;AAKO,SAAS;IACd,OAAO;AACT"}},
    {"offset": {"line": 2398, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/warranty/initial-data.ts"],"sourcesContent":["import type { WarrantyTicket } from './types';\nimport { asSystemId, asBusinessId } from '../../lib/id-types';\nimport { buildSeedAuditFields } from '@/lib/seed-audit';\n\n/**\n * Initial Warranty Data\n * Empty array - data will be persisted in localStorage by createCrudStore\n * \n * Example of properly typed warranty record:\n * {\n *   systemId: asSystemId('WARRANTY00000001'),\n *   id: asBusinessId('WR001'),\n *   branchSystemId: asSystemId('BRANCH00000001'),\n *   employeeSystemId: asSystemId('NV00000001'),\n *   customerSystemId: asSystemId('CUSTOMER00000001'),\n *   linkedOrderSystemId: asSystemId('ORDER00000123'),\n *   products: [\n *     {\n *       systemId: asSystemId('WARPROD00000001'),\n *       productSystemId: asSystemId('PRODUCT00000045'),\n *       sku: asBusinessId('SKU001'),\n *       ...\n *     }\n *   ],\n *   ...\n * }\n */\nconst seedCustomer = {\n\tsystemId: asSystemId('CUST000001'),\n\tname: 'Công ty Cổ phần Bất động sản Hưng Thịnh',\n\tphone: '0901112233',\n\taddress: '123 Đường ABC, Phường 1, Quận 1, TP.HCM',\n};\n\nconst seedBranch = {\n\tsystemId: asSystemId('BRANCH000003'),\n\tname: 'Chi nhánh Trung tâm',\n};\n\nconst warrantyOwner = {\n\tsystemId: asSystemId('EMP000002'),\n\tname: 'Trần Thị Bình',\n};\n\nexport const warrantyInitialData: WarrantyTicket[] = [\n\t{\n\t\tsystemId: asSystemId('WARRANTY000001'),\n\t\tid: asBusinessId('BH000001'),\n\t\tbranchSystemId: seedBranch.systemId,\n\t\tbranchName: seedBranch.name,\n\t\temployeeSystemId: warrantyOwner.systemId,\n\t\temployeeName: warrantyOwner.name,\n\t\tcustomerSystemId: seedCustomer.systemId,\n\t\tcustomerName: seedCustomer.name,\n\t\tcustomerPhone: seedCustomer.phone,\n\t\tcustomerAddress: seedCustomer.address,\n\t\ttrackingCode: 'GHN-WAR-0001',\n\t\tpublicTrackingCode: 'wh8ut4nz9p',\n\t\tshippingFee: 45000,\n\t\treferenceUrl: 'https://docs.google.com/spreadsheets/d/war-0001',\n\t\tlinkedOrderSystemId: asSystemId('ORDER000001'),\n\t\treceivedImages: [\n\t\t\t'https://images.unsplash.com/photo-1517336714731-489689fd1ca8?auto=format&fit=crop&w=640&q=80',\n\t\t],\n\t\tproducts: [\n\t\t\t{\n\t\t\t\tsystemId: asSystemId('WARPROD000001'),\n\t\t\t\tproductSystemId: asSystemId('SP000001'),\n\t\t\t\tsku: asBusinessId('SP000001'),\n\t\t\t\tproductName: 'Laptop Dell Inspiron 15',\n\t\t\t\tquantity: 1,\n\t\t\t\tunitPrice: 15000000,\n\t\t\t\tissueDescription: 'Máy tự tắt khi sử dụng hơn 30 phút',\n\t\t\t\tresolution: 'replace',\n\t\t\t\tdeductionAmount: 0,\n\t\t\t\tproductImages: [\n\t\t\t\t\t'https://images.unsplash.com/photo-1517336714731-489689fd1ca8?auto=format&fit=crop&w=400&q=80',\n\t\t\t\t],\n\t\t\t\tnotes: 'Cần sao lưu dữ liệu trước khi chuyển hãng',\n\t\t\t},\n\t\t\t{\n\t\t\t\tsystemId: asSystemId('WARPROD000002'),\n\t\t\t\tproductSystemId: asSystemId('SP000002'),\n\t\t\t\tsku: asBusinessId('SP000002'),\n\t\t\t\tproductName: 'Chuột Logitech MX Master 3',\n\t\t\t\tquantity: 1,\n\t\t\t\tunitPrice: 2000000,\n\t\t\t\tissueDescription: 'Con lăn bị kẹt định kỳ',\n\t\t\t\tresolution: 'return',\n\t\t\t\tproductImages: [\n\t\t\t\t\t'https://images.unsplash.com/photo-1481277542470-605612bd2d61?auto=format&fit=crop&w=400&q=80',\n\t\t\t\t],\n\t\t\t\tnotes: 'Đã vệ sinh nhưng lỗi tái diễn',\n\t\t\t},\n\t\t],\n\t\tprocessedImages: [\n\t\t\t'https://images.unsplash.com/photo-1517430816045-df4b7de11d1d?auto=format&fit=crop&w=640&q=80',\n\t\t],\n\t\tstatus: 'processed',\n\t\tsettlementStatus: 'pending',\n\t\tstockDeducted: false,\n\t\tprocessingStartedAt: '2025-11-13T01:30:00Z',\n\t\tprocessedAt: '2025-11-13T09:00:00Z',\n\t\tnotes: 'Đợi xác nhận của khách về phương án đổi mới laptop.',\n\t\tsummary: {\n\t\t\ttotalProducts: 2,\n\t\t\ttotalReplaced: 1,\n\t\t\ttotalReturned: 1,\n\t\t\ttotalDeduction: 0,\n\t\t\ttotalOutOfStock: 0,\n\t\t\ttotalSettlement: 0,\n\t\t},\n\t\thistory: [\n\t\t\t{\n\t\t\t\tsystemId: asSystemId('WARHIST000001'),\n\t\t\t\taction: 'create',\n\t\t\t\tactionLabel: 'Tạo phiếu bảo hành',\n\t\t\t\tperformedBy: warrantyOwner.name,\n\t\t\t\tperformedBySystemId: warrantyOwner.systemId,\n\t\t\t\tperformedAt: '2025-11-12T09:00:00Z',\n\t\t\t\tnote: 'Tiếp nhận phiếu bảo hành từ khách Hưng Thịnh.',\n\t\t\t\tlinkedOrderSystemId: asSystemId('ORDER000001'),\n\t\t\t},\n\t\t\t{\n\t\t\t\tsystemId: asSystemId('WARHIST000002'),\n\t\t\t\taction: 'update_status',\n\t\t\t\tactionLabel: 'Bắt đầu xử lý',\n\t\t\t\tperformedBy: warrantyOwner.name,\n\t\t\t\tperformedBySystemId: warrantyOwner.systemId,\n\t\t\t\tperformedAt: '2025-11-13T01:30:00Z',\n\t\t\t\tnote: 'Chuyển trạng thái sang Đang xử lý và gửi thiết bị sang ASUS.',\n\t\t\t},\n\t\t\t{\n\t\t\t\tsystemId: asSystemId('WARHIST000003'),\n\t\t\t\taction: 'update_status',\n\t\t\t\tactionLabel: 'Hoàn tất xử lý',\n\t\t\t\tperformedBy: warrantyOwner.name,\n\t\t\t\tperformedBySystemId: warrantyOwner.systemId,\n\t\t\t\tperformedAt: '2025-11-13T09:00:00Z',\n\t\t\t\tnote: 'Laptop sẽ đổi máy mới, chuột vệ sinh và trả lại.',\n\t\t\t},\n\t\t],\n\t\tcomments: [],\n\t\tsubtasks: [],\n\t\tcreatedBy: warrantyOwner.name,\n\t\tcreatedBySystemId: warrantyOwner.systemId,\n\t\tcreatedAt: '2025-11-12T09:00:00Z',\n\t\tupdatedAt: '2025-11-13T09:00:00Z',\n\t\tupdatedBySystemId: warrantyOwner.systemId,\n\t},\n\t{\n\t\tsystemId: asSystemId('WARRANTY000002'),\n\t\tid: asBusinessId('BH000002'),\n\t\tbranchSystemId: seedBranch.systemId,\n\t\tbranchName: seedBranch.name,\n\t\temployeeSystemId: warrantyOwner.systemId,\n\t\temployeeName: warrantyOwner.name,\n\t\tcustomerSystemId: seedCustomer.systemId,\n\t\tcustomerName: seedCustomer.name,\n\t\tcustomerPhone: seedCustomer.phone,\n\t\tcustomerAddress: seedCustomer.address,\n\t\ttrackingCode: 'GHTK-WAR-0452',\n\t\tpublicTrackingCode: 'r9bth1e6md',\n\t\tshippingFee: 30000,\n\t\tlinkedOrderSystemId: asSystemId('ORDER000005'),\n\t\treceivedImages: [\n\t\t\t'https://images.unsplash.com/photo-1581291518823-11e99804a128?auto=format&fit=crop&w=640&q=80',\n\t\t],\n\t\tproducts: [\n\t\t\t{\n\t\t\t\tsystemId: asSystemId('WARPROD000003'),\n\t\t\t\tproductSystemId: asSystemId('SP000008'),\n\t\t\t\tsku: asBusinessId('SP000008'),\n\t\t\t\tproductName: 'Bàn phím cơ Keychron K2',\n\t\t\t\tquantity: 1,\n\t\t\t\tunitPrice: 2500000,\n\t\t\t\tissueDescription: 'Phím space bị kẹt sau 1 tuần sử dụng',\n\t\t\t\tresolution: 'replace',\n\t\t\t\tproductImages: [\n\t\t\t\t\t'https://images.unsplash.com/photo-1503602642458-232111445657?auto=format&fit=crop&w=400&q=80',\n\t\t\t\t],\n\t\t\t},\n\t\t\t{\n\t\t\t\tsystemId: asSystemId('WARPROD000004'),\n\t\t\t\tproductSystemId: asSystemId('SP000010'),\n\t\t\t\tsku: asBusinessId('SP000010'),\n\t\t\t\tproductName: 'Switch Gateron Yellow',\n\t\t\t\tquantity: 6,\n\t\t\t\tunitPrice: 5000,\n\t\t\t\tissueDescription: 'Một số switch không nhận tín hiệu sau khi lắp',\n\t\t\t\tresolution: 'deduct',\n\t\t\t\tdeductionAmount: 60000,\n\t\t\t\tproductImages: [],\n\t\t\t\tnotes: 'Khách đề nghị hoàn tiền cho số switch lỗi',\n\t\t\t},\n\t\t],\n\t\tstatus: 'pending',\n\t\tsettlementStatus: 'pending',\n\t\tstockDeducted: false,\n\t\tnotes: 'Đang chờ kỹ thuật kiểm tra bàn phím.',\n\t\tsummary: {\n\t\t\ttotalProducts: 2,\n\t\t\ttotalReplaced: 0,\n\t\t\ttotalReturned: 0,\n\t\t\ttotalDeduction: 60000,\n\t\t\ttotalOutOfStock: 0,\n\t\t\ttotalSettlement: 60000,\n\t\t},\n\t\thistory: [\n\t\t\t{\n\t\t\t\tsystemId: asSystemId('WARHIST000004'),\n\t\t\t\taction: 'create',\n\t\t\t\tactionLabel: 'Tạo phiếu bảo hành',\n\t\t\t\tperformedBy: warrantyOwner.name,\n\t\t\t\tperformedBySystemId: warrantyOwner.systemId,\n\t\t\t\tperformedAt: '2025-11-18T03:00:00Z',\n\t\t\t\tnote: 'Khách gửi bàn phím Keychron cần bảo hành.',\n\t\t\t\tlinkedOrderSystemId: asSystemId('ORDER000005'),\n\t\t\t},\n\t\t],\n\t\tcomments: [],\n\t\tsubtasks: [],\n\t\tcreatedBy: warrantyOwner.name,\n\t\tcreatedBySystemId: warrantyOwner.systemId,\n\t\tcreatedAt: '2025-11-18T03:00:00Z',\n\t\tupdatedAt: '2025-11-18T03:00:00Z',\n\t\tupdatedBySystemId: warrantyOwner.systemId,\n\t},\n];\n\n// Template metadata snippet used when inserting new warranty tickets via seed scripts.\nexport const WARRANTY_SEED_AUDIT_TEMPLATE = buildSeedAuditFields({ createdAt: '2024-02-01T00:00:00Z' });\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 2639, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/warranty/store/base-store.ts"],"sourcesContent":["import { getCurrentDate, toISODateTime } from '../../../lib/date-utils';\r\nimport { createCrudStore } from '../../../lib/store-factory';\r\nimport type { WarrantyTicket } from '../types';\r\nimport { warrantyInitialData } from '../initial-data';\r\nimport { getCurrentUserInfo, getCurrentUserSystemId } from '../../../contexts/auth-context';\r\nimport type { SystemId } from '../../../lib/id-types';\r\n\r\n// Utility: Get Current User Info\r\nexport function getCurrentUserName(): string {\r\n  return getCurrentUserInfo().name;\r\n}\r\n\r\n// Utility: Generate Public Tracking Code\r\nexport function generatePublicTrackingCode(): string {\r\n  const chars = 'abcdefghijklmnopqrstuvwxyz0123456789';\r\n  let result = '';\r\n  for (let i = 0; i < 10; i++) {\r\n    result += chars.charAt(Math.floor(Math.random() * chars.length));\r\n  }\r\n  return result;\r\n}\r\n\r\n// Create Base Store with createCrudStore\r\nexport const baseStore = createCrudStore<WarrantyTicket>(warrantyInitialData, 'warranty', {\r\n  businessIdField: 'id',\r\n  getCurrentUser: getCurrentUserSystemId,\r\n  apiEndpoint: '/api/warranties',\r\n});\r\n\r\n// ✅ API Sync helpers\r\nconst API_ENDPOINT = '/api/warranties';\r\n\r\nconst syncToApi = {\r\n  create: async (warranty: WarrantyTicket) => {\r\n    try {\r\n      const response = await fetch(API_ENDPOINT, {\r\n        method: 'POST',\r\n        credentials: 'include',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify(warranty),\r\n      });\r\n      if (!response.ok) console.warn('[Warranty API] Create sync failed');\r\n      else console.log('[Warranty API] Created:', warranty.systemId);\r\n    } catch (e) {\r\n      console.warn('[Warranty API] Create sync error:', e);\r\n    }\r\n  },\r\n  update: async (systemId: SystemId, updates: Partial<WarrantyTicket>) => {\r\n    try {\r\n      const response = await fetch(`${API_ENDPOINT}/${systemId}`, {\r\n        method: 'PATCH',\r\n        credentials: 'include',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify(updates),\r\n      });\r\n      if (!response.ok) console.warn('[Warranty API] Update sync failed');\r\n      else console.log('[Warranty API] Updated:', systemId);\r\n    } catch (e) {\r\n      console.warn('[Warranty API] Update sync error:', e);\r\n    }\r\n  },\r\n  delete: async (systemId: SystemId, hard = false) => {\r\n    try {\r\n      const response = await fetch(`${API_ENDPOINT}/${systemId}`, {\r\n        method: 'DELETE',\r\n        credentials: 'include',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({ hard }),\r\n      });\r\n      if (!response.ok) console.warn('[Warranty API] Delete sync failed');\r\n      else console.log('[Warranty API] Deleted:', systemId);\r\n    } catch (e) {\r\n      console.warn('[Warranty API] Delete sync error:', e);\r\n    }\r\n  },\r\n  restore: async (systemId: SystemId) => {\r\n    try {\r\n      const response = await fetch(`${API_ENDPOINT}/${systemId}/restore`, {\r\n        method: 'POST',\r\n        credentials: 'include',\r\n        headers: { 'Content-Type': 'application/json' },\r\n      });\r\n      if (!response.ok) console.warn('[Warranty API] Restore sync failed');\r\n      else console.log('[Warranty API] Restored:', systemId);\r\n    } catch (e) {\r\n      console.warn('[Warranty API] Restore sync error:', e);\r\n    }\r\n  },\r\n};\r\n\r\n// Export original CRUD methods for overriding (before wrapping)\r\nexport const originalAdd = baseStore.getState().add;\r\nexport const originalUpdate = baseStore.getState().update;\r\nexport const originalRemove = baseStore.getState().remove;\r\n\r\n// ✅ Wrap base store methods with API sync (for direct usage)\r\nconst originalHardDelete = baseStore.getState().hardDelete;\r\nconst originalRestore = baseStore.getState().restore;\r\n\r\nbaseStore.setState({\r\n  hardDelete: (systemId: SystemId) => {\r\n    originalHardDelete(systemId);\r\n    syncToApi.delete(systemId, true);\r\n  },\r\n  restore: (systemId: SystemId) => {\r\n    originalRestore(systemId);\r\n    syncToApi.restore(systemId);\r\n  },\r\n});\r\n\r\n// Export sync helpers for use in index.ts (where add/update are overridden)\r\nexport { syncToApi };\r\n"],"names":[],"mappings":";;;;;;;;;;;;;;;;AACA;AAEA;AACA;;;;AAIO,SAAS;IACd,OAAO,IAAA,qJAAkB,IAAG,IAAI;AAClC;AAGO,SAAS;IACd,MAAM,QAAQ;IACd,IAAI,SAAS;IACb,IAAK,IAAI,IAAI,GAAG,IAAI,IAAI,IAAK;QAC3B,UAAU,MAAM,MAAM,CAAC,KAAK,KAAK,CAAC,KAAK,MAAM,KAAK,MAAM,MAAM;IAChE;IACA,OAAO;AACT;AAGO,MAAM,YAAY,IAAA,6IAAe,EAAiB,iKAAmB,EAAE,YAAY;IACxF,iBAAiB;IACjB,gBAAgB,yJAAsB;IACtC,aAAa;AACf;AAEA,qBAAqB;AACrB,MAAM,eAAe;AAErB,MAAM,YAAY;IAChB,QAAQ,OAAO;QACb,IAAI;YACF,MAAM,WAAW,MAAM,MAAM,cAAc;gBACzC,QAAQ;gBACR,aAAa;gBACb,SAAS;oBAAE,gBAAgB;gBAAmB;gBAC9C,MAAM,KAAK,SAAS,CAAC;YACvB;YACA,IAAI,CAAC,SAAS,EAAE,EAAE,QAAQ,IAAI,CAAC;iBAC1B,QAAQ,GAAG,CAAC,2BAA2B,SAAS,QAAQ;QAC/D,EAAE,OAAO,GAAG;YACV,QAAQ,IAAI,CAAC,qCAAqC;QACpD;IACF;IACA,QAAQ,OAAO,UAAoB;QACjC,IAAI;YACF,MAAM,WAAW,MAAM,MAAM,GAAG,aAAa,CAAC,EAAE,UAAU,EAAE;gBAC1D,QAAQ;gBACR,aAAa;gBACb,SAAS;oBAAE,gBAAgB;gBAAmB;gBAC9C,MAAM,KAAK,SAAS,CAAC;YACvB;YACA,IAAI,CAAC,SAAS,EAAE,EAAE,QAAQ,IAAI,CAAC;iBAC1B,QAAQ,GAAG,CAAC,2BAA2B;QAC9C,EAAE,OAAO,GAAG;YACV,QAAQ,IAAI,CAAC,qCAAqC;QACpD;IACF;IACA,QAAQ,OAAO,UAAoB,OAAO,KAAK;QAC7C,IAAI;YACF,MAAM,WAAW,MAAM,MAAM,GAAG,aAAa,CAAC,EAAE,UAAU,EAAE;gBAC1D,QAAQ;gBACR,aAAa;gBACb,SAAS;oBAAE,gBAAgB;gBAAmB;gBAC9C,MAAM,KAAK,SAAS,CAAC;oBAAE;gBAAK;YAC9B;YACA,IAAI,CAAC,SAAS,EAAE,EAAE,QAAQ,IAAI,CAAC;iBAC1B,QAAQ,GAAG,CAAC,2BAA2B;QAC9C,EAAE,OAAO,GAAG;YACV,QAAQ,IAAI,CAAC,qCAAqC;QACpD;IACF;IACA,SAAS,OAAO;QACd,IAAI;YACF,MAAM,WAAW,MAAM,MAAM,GAAG,aAAa,CAAC,EAAE,SAAS,QAAQ,CAAC,EAAE;gBAClE,QAAQ;gBACR,aAAa;gBACb,SAAS;oBAAE,gBAAgB;gBAAmB;YAChD;YACA,IAAI,CAAC,SAAS,EAAE,EAAE,QAAQ,IAAI,CAAC;iBAC1B,QAAQ,GAAG,CAAC,4BAA4B;QAC/C,EAAE,OAAO,GAAG;YACV,QAAQ,IAAI,CAAC,sCAAsC;QACrD;IACF;AACF;AAGO,MAAM,cAAc,UAAU,QAAQ,GAAG,GAAG;AAC5C,MAAM,iBAAiB,UAAU,QAAQ,GAAG,MAAM;AAClD,MAAM,iBAAiB,UAAU,QAAQ,GAAG,MAAM;AAEzD,6DAA6D;AAC7D,MAAM,qBAAqB,UAAU,QAAQ,GAAG,UAAU;AAC1D,MAAM,kBAAkB,UAAU,QAAQ,GAAG,OAAO;AAEpD,UAAU,QAAQ,CAAC;IACjB,YAAY,CAAC;QACX,mBAAmB;QACnB,UAAU,MAAM,CAAC,UAAU;IAC7B;IACA,SAAS,CAAC;QACR,gBAAgB;QAChB,UAAU,OAAO,CAAC;IACpB;AACF"}},
    {"offset": {"line": 2770, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/warranty/store/stock-management.ts"],"sourcesContent":["import { getCurrentDate, toISODateTime } from '../../../lib/date-utils';\r\nimport { useProductStore } from '../../products/store';\r\nimport { useStockHistoryStore } from '../../stock-history/store';\r\nimport { toast } from 'sonner';\r\nimport type { WarrantyTicket } from '../types';\r\nimport { getCurrentUserName } from './base-store';\r\n\r\n/**\r\n * Commit stock khi tạo warranty (reserve hàng cho đổi mới)\r\n * Reuse productStore.commitStock()\r\n */\r\nexport function commitWarrantyStock(ticket: WarrantyTicket) {\r\n  const replaceProducts = ticket.products.filter(p => p.resolution === 'replace');\r\n  \r\n  if (replaceProducts.length > 0) {\r\n    const productStore = useProductStore.getState();\r\n    const productCache = new Map<string, any>();\r\n    productStore.data.forEach(p => productCache.set(p.id, p));\r\n    \r\n    replaceProducts.forEach(warrantyProduct => {\r\n      if (!warrantyProduct.sku) {\r\n        console.warn('Sản phẩm thiếu SKU, bỏ qua commit:', warrantyProduct.productName);\r\n        return;\r\n      }\r\n      \r\n      const product = productCache.get(warrantyProduct.sku);\r\n      \r\n      if (!product) {\r\n        console.warn('Không tìm thấy sản phẩm trong kho:', warrantyProduct.sku);\r\n        return;\r\n      }\r\n      \r\n      const quantityToCommit = warrantyProduct.quantity || 1;\r\n      \r\n      // Reuse productStore.commitStock()\r\n      productStore.commitStock(product.systemId as any, ticket.branchSystemId as any, quantityToCommit);\r\n      \r\n      console.log('✅ [COMMIT STOCK] Giữ hàng thay thế:', {\r\n        productId: product.id,\r\n        productName: product.name,\r\n        quantity: quantityToCommit,\r\n        warranty: ticket.id,\r\n        branch: ticket.branchName\r\n      });\r\n    });\r\n  }\r\n}\r\n\r\n/**\r\n * Uncommit stock khi xóa warranty (giải phóng hàng giữ chỗ)\r\n * Reuse productStore.uncommitStock()\r\n */\r\nexport function uncommitWarrantyStock(ticket: WarrantyTicket, options?: { silent?: boolean }) {\r\n  const replaceProducts = ticket.products.filter(p => p.resolution === 'replace');\r\n  \r\n  if (replaceProducts.length > 0) {\r\n    const productStore = useProductStore.getState();\r\n    const productCache = new Map<string, any>();\r\n    productStore.data.forEach(p => productCache.set(p.id, p));\r\n    \r\n    replaceProducts.forEach(warrantyProduct => {\r\n      if (!warrantyProduct.sku) return;\r\n      \r\n      const product = productCache.get(warrantyProduct.sku);\r\n      \r\n      if (product) {\r\n      const quantityToUncommit = warrantyProduct.quantity || 1;\r\n      \r\n      // Reuse productStore.uncommitStock()\r\n      productStore.uncommitStock(product.systemId as any, ticket.branchSystemId as any, quantityToUncommit);        console.log('Đã uncommit stock:', {\r\n          productId: product.id,\r\n          quantity: quantityToUncommit,\r\n          warranty: ticket.id\r\n        });\r\n      }\r\n    });\r\n    \r\n    if (!options?.silent) {\r\n      toast.info('Đã giải phóng hàng giữ chỗ', {\r\n        description: `${replaceProducts.length} sản phẩm đã được trả lại kho có thể bán`,\r\n        duration: 3000\r\n      });\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * Xuất kho khi 'completed' - Dùng dispatchStock giống đơn hàng\r\n * NEW LOGIC: Bước 4 - Kết thúc\r\n */\r\nexport function deductWarrantyStock(ticket: WarrantyTicket) {\r\n  console.log('📤 [DEDUCT FUNCTION CALLED]:', {\r\n    ticketId: ticket.id,\r\n    ticketStatus: ticket.status,\r\n    stockDeducted: ticket.stockDeducted,\r\n    productsCount: ticket.products.length,\r\n    replaceProducts: ticket.products.filter(p => p.resolution === 'replace').length\r\n  });\r\n  \r\n  const replacedProducts = ticket.products.filter(p => p.resolution === 'replace');\r\n  \r\n  if (replacedProducts.length > 0) {\r\n    const productStore = useProductStore.getState();\r\n    const stockHistoryStore = useStockHistoryStore.getState();\r\n    const productCache = new Map<string, any>();\r\n    productStore.data.forEach(p => productCache.set(p.id, p));\r\n    \r\n    const deductionResults: string[] = [];\r\n    let hasErrors = false;\r\n    \r\n    replacedProducts.forEach(warrantyProduct => {\r\n      if (!warrantyProduct.sku) {\r\n        deductionResults.push(`Sản phẩm \"${warrantyProduct.productName}\" không có SKU`);\r\n        hasErrors = true;\r\n        return;\r\n      }\r\n      \r\n      const product = productCache.get(warrantyProduct.sku);\r\n      \r\n      if (!product) {\r\n        deductionResults.push(`Không tìm thấy SP SKU: ${warrantyProduct.sku}`);\r\n        hasErrors = true;\r\n        return;\r\n      }\r\n      \r\n      const currentInventory = product.inventoryByBranch[ticket.branchSystemId] || 0;\r\n      const quantityToDeduct = warrantyProduct.quantity || 1;\r\n      \r\n      console.log('📤 [DEDUCT] Before:', {\r\n        productId: product.id,\r\n        currentInventory,\r\n        quantityToDeduct,\r\n        branchSystemId: ticket.branchSystemId\r\n      });\r\n      \r\n      if (currentInventory < quantityToDeduct) {\r\n        deductionResults.push(`${product.name} (${product.id}): Không đủ hàng (Tồn: ${currentInventory}, Cần: ${quantityToDeduct})`);\r\n        hasErrors = true;\r\n        return;\r\n      }\r\n      \r\n      // ✅ Xuất kho trực tiếp (không dùng dispatchStock vì warranty không có inTransit)\r\n      // -Tồn kho\r\n      productStore.updateInventory(product.systemId as any, ticket.branchSystemId as any, -quantityToDeduct);\r\n      // -Đang giao dịch (uncommit)\r\n      productStore.uncommitStock(product.systemId as any, ticket.branchSystemId as any, quantityToDeduct);\r\n      \r\n      // ✅ Lấy lại product sau khi update\r\n      const freshProductStore = useProductStore.getState();\r\n      const updatedProduct = freshProductStore.data.find(p => p.systemId === product.systemId);\r\n      const newStockLevel = updatedProduct?.inventoryByBranch[ticket.branchSystemId] || currentInventory - quantityToDeduct;\r\n      \r\n      console.log('✅ [DEDUCT] After:', {\r\n        productId: product.id,\r\n        newStockLevel,\r\n        expectedLevel: currentInventory - quantityToDeduct\r\n      });\r\n      \r\n      stockHistoryStore.addEntry({\r\n        productId: product.systemId,\r\n        date: toISODateTime(getCurrentDate()),\r\n        employeeName: getCurrentUserName(),\r\n        action: 'Xuất bảo hành (đổi mới)',\r\n        quantityChange: -quantityToDeduct,\r\n        newStockLevel,\r\n        documentId: ticket.id, // Business ID for display (BH000001)\r\n        branchSystemId: ticket.branchSystemId,\r\n        branch: ticket.branchName,\r\n      });\r\n      \r\n      deductionResults.push(`${product.name} (${product.id}): Trừ ${quantityToDeduct} cái (Còn: ${newStockLevel})`);\r\n    });\r\n    \r\n    if (hasErrors) {\r\n      toast.error('Có lỗi khi xuất kho', {\r\n        description: deductionResults.join('\\n'),\r\n        duration: 6000,\r\n      });\r\n    } else {\r\n      toast.success('Đã xuất kho sản phẩm thay thế', {\r\n        description: `Xuất ${replacedProducts.length} sản phẩm tại chi nhánh ${ticket.branchName}`,\r\n        duration: 4000,\r\n      });\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * Hoàn kho khi hủy warranty - Ngược lại với dispatchStock\r\n * NEW LOGIC: +Tồn kho + +Đang giao dịch\r\n */\r\nexport function rollbackWarrantyStock(ticket: WarrantyTicket) {\r\n  console.log('🔄 [ROLLBACK FUNCTION CALLED]:', {\r\n    ticketId: ticket.id,\r\n    ticketStatus: ticket.status,\r\n    stockDeducted: ticket.stockDeducted,\r\n    productsCount: ticket.products.length,\r\n    replaceProducts: ticket.products.filter(p => p.resolution === 'replace').length\r\n  });\r\n  \r\n  const replacedProducts = ticket.products.filter(p => p.resolution === 'replace');\r\n  \r\n  if (replacedProducts.length > 0) {\r\n    const productStore = useProductStore.getState();\r\n    const stockHistoryStore = useStockHistoryStore.getState();\r\n    const productCache = new Map<string, any>();\r\n    productStore.data.forEach(p => productCache.set(p.id, p));\r\n    \r\n    const rollbackResults: string[] = [];\r\n    \r\n    replacedProducts.forEach(warrantyProduct => {\r\n      if (!warrantyProduct.sku) {\r\n        rollbackResults.push(`Sản phẩm \"${warrantyProduct.productName}\" không có SKU`);\r\n        return;\r\n      }\r\n      \r\n      const product = productCache.get(warrantyProduct.sku);\r\n      \r\n      if (!product) {\r\n        rollbackResults.push(`Không tìm thấy SP SKU: ${warrantyProduct.sku}`);\r\n        return;\r\n      }\r\n      \r\n      const quantityToRollback = warrantyProduct.quantity || 1;\r\n      const currentInventory = product.inventoryByBranch[ticket.branchSystemId] || 0;\r\n      \r\n      console.log('🔄 [ROLLBACK] Before:', {\r\n        productId: product.id,\r\n        currentInventory,\r\n        quantityToRollback,\r\n        branchSystemId: ticket.branchSystemId\r\n      });\r\n      \r\n      // ✅ Hoàn kho: +Tồn kho (warranty xuất trực tiếp, không qua inTransit)\r\n      productStore.updateInventory(product.systemId as any, ticket.branchSystemId as any, quantityToRollback);\r\n      \r\n      // ✅ Lấy lại product sau khi update để có inventory mới\r\n      const freshProductStore = useProductStore.getState();\r\n      const updatedProduct = freshProductStore.data.find(p => p.systemId === product.systemId);\r\n      const newStockLevel = updatedProduct?.inventoryByBranch[ticket.branchSystemId] || currentInventory + quantityToRollback;\r\n      \r\n      console.log('✅ [ROLLBACK] After:', {\r\n        productId: product.id,\r\n        newStockLevel,\r\n        expectedLevel: currentInventory + quantityToRollback\r\n      });\r\n      \r\n      // Note: Không cần uncommit vì khi deduct đã uncommit rồi\r\n      \r\n      stockHistoryStore.addEntry({\r\n        productId: product.systemId,\r\n        date: toISODateTime(getCurrentDate()),\r\n        employeeName: getCurrentUserName(),\r\n        action: 'Hoàn kho (Hủy bảo hành)',\r\n        quantityChange: quantityToRollback,\r\n        newStockLevel,\r\n        documentId: ticket.id,\r\n        branchSystemId: ticket.branchSystemId,\r\n        branch: ticket.branchName,\r\n      });\r\n      \r\n      rollbackResults.push(`${product.name} (${product.id}): Hoàn ${quantityToRollback} cái`);\r\n    });\r\n    \r\n    toast.info('Đã hoàn kho sản phẩm thay thế', {\r\n      description: rollbackResults.join('\\n'),\r\n      duration: 4000,\r\n    });\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 2999, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/warranty/store/product-management.ts"],"sourcesContent":["import { getCurrentDate, toISODateTime } from '../../../lib/date-utils';\r\nimport { asSystemId } from '../../../lib/id-types';\r\nimport type { SystemId } from '../../../lib/id-types';\r\nimport type { WarrantyProduct, WarrantyHistory, WarrantyTicket } from '../types';\r\nimport { baseStore, originalUpdate, getCurrentUserName } from './base-store';\r\nimport { commitWarrantyStock, uncommitWarrantyStock } from './stock-management';\r\n\r\n/**\r\n * Tính summary từ danh sách sản phẩm\r\n */\r\nexport function calculateSummary(products: WarrantyProduct[]) {\r\n  const outOfStockProducts = products.filter(p => p.resolution === 'out_of_stock' || p.resolution === 'deduct');\r\n  \r\n  const totalSettlement = outOfStockProducts.reduce((sum, p) => {\r\n    if (p.resolution === 'deduct') return sum + (p.deductionAmount || 0);\r\n    if (p.resolution === 'out_of_stock') return sum + ((p.quantity || 1) * (p.unitPrice || 0));\r\n    return sum;\r\n  }, 0);\r\n  \r\n  return {\r\n    totalProducts: products.reduce((sum, p) => sum + (p.quantity || 1), 0),\r\n    totalReplaced: products.filter(p => p.resolution === 'replace').reduce((sum, p) => sum + (p.quantity || 1), 0),\r\n    totalReturned: products.filter(p => p.resolution === 'return').reduce((sum, p) => sum + (p.quantity || 1), 0),\r\n    totalDeduction: totalSettlement,\r\n    totalOutOfStock: outOfStockProducts.reduce((sum, p) => sum + (p.quantity || 1), 0),\r\n    totalSettlement: totalSettlement,\r\n  };\r\n}\r\n\r\nfunction adjustReplacementStock(\r\n  ticket: WarrantyTicket,\r\n  previousProduct?: WarrantyProduct,\r\n  nextProduct?: WarrantyProduct\r\n) {\r\n  if (!ticket) return;\r\n\r\n  const previousQty = previousProduct?.resolution === 'replace' ? (previousProduct.quantity || 1) : 0;\r\n  const nextQty = nextProduct?.resolution === 'replace' ? (nextProduct.quantity || 1) : 0;\r\n\r\n  if (previousQty === nextQty) {\r\n    return;\r\n  }\r\n\r\n  const diff = Math.abs(nextQty - previousQty);\r\n  const referenceProduct = nextQty > previousQty ? nextProduct : previousProduct;\r\n  if (!referenceProduct || diff <= 0) return;\r\n\r\n  const tempProduct: WarrantyProduct = {\r\n    ...referenceProduct,\r\n    quantity: diff,\r\n  };\r\n\r\n  const tempTicket = {\r\n    ...ticket,\r\n    products: [tempProduct],\r\n  } as WarrantyTicket;\r\n\r\n  if (nextQty > previousQty) {\r\n    commitWarrantyStock(tempTicket);\r\n  } else {\r\n    uncommitWarrantyStock(tempTicket, { silent: true });\r\n  }\r\n}\r\n\r\n/**\r\n * Thêm sản phẩm vào phiếu bảo hành\r\n */\r\nexport function addProduct(ticketSystemId: SystemId, product: Omit<WarrantyProduct, 'systemId'>) {\r\n  const ticket = baseStore.getState().data.find(t => t.systemId === ticketSystemId);\r\n  if (!ticket) return;\r\n  \r\n  const newProduct: WarrantyProduct = {\r\n    ...product,\r\n    systemId: asSystemId(`WP_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`),\r\n  };\r\n\r\n  adjustReplacementStock(ticket, undefined, newProduct);\r\n  \r\n  const updatedProducts = [...ticket.products, newProduct];\r\n  const summary = calculateSummary(updatedProducts);\r\n  \r\n  originalUpdate(ticketSystemId, {\r\n    ...ticket,\r\n    products: updatedProducts,\r\n    summary,\r\n    updatedAt: toISODateTime(getCurrentDate()),\r\n  } as any);\r\n  \r\n  // Add history\r\n  const resolutionLabels: Record<string, string> = {\r\n    replace: 'Thay thế',\r\n    refund: 'Hoàn tiền',\r\n    deduct: 'Trừ tiền',\r\n    warranty_extension: 'Gia hạn BH',\r\n    no_warranty: 'Không BH',\r\n    out_of_stock: 'Hết hàng',\r\n    return: 'Trả hàng'\r\n  };\r\n  const resolution = resolutionLabels[newProduct.resolution] || newProduct.resolution;\r\n  const quantity = newProduct.quantity || 1;\r\n  \r\n  addHistory(ticketSystemId, `Thêm SP: ${newProduct.productName} (${resolution}, SL: ${quantity})`, getCurrentUserName());\r\n}\r\n\r\n/**\r\n * Cập nhật sản phẩm trong phiếu\r\n */\r\nexport function updateProduct(ticketSystemId: SystemId, productSystemId: SystemId, updates: Partial<WarrantyProduct>) {\r\n  const ticket = baseStore.getState().data.find(t => t.systemId === ticketSystemId);\r\n  if (!ticket) return;\r\n  const originalProduct = ticket.products.find(p => p.systemId === productSystemId);\r\n  if (!originalProduct) return;\r\n  \r\n  const updatedProducts = ticket.products.map(p =>\r\n    p.systemId === productSystemId ? { ...p, ...updates } : p\r\n  );\r\n  \r\n  const summary = calculateSummary(updatedProducts);\r\n  const updatedProduct = updatedProducts.find(p => p.systemId === productSystemId);\r\n  adjustReplacementStock(ticket, originalProduct, updatedProduct);\r\n  \r\n  originalUpdate(ticketSystemId, {\r\n    ...ticket,\r\n    products: updatedProducts,\r\n    summary,\r\n    updatedAt: toISODateTime(getCurrentDate()),\r\n  } as any);\r\n  \r\n  // Add history\r\n  if (updatedProduct) {\r\n    addHistory(ticketSystemId, `Cập nhật SP: ${updatedProduct.productName}`, getCurrentUserName());\r\n  }\r\n}\r\n\r\n/**\r\n * Xóa sản phẩm khỏi phiếu\r\n */\r\nexport function removeProduct(ticketSystemId: SystemId, productSystemId: SystemId) {\r\n  const ticket = baseStore.getState().data.find(t => t.systemId === ticketSystemId);\r\n  if (!ticket) return;\r\n  \r\n  const productToRemove = ticket.products.find(p => p.systemId === productSystemId);\r\n  const updatedProducts = ticket.products.filter(p => p.systemId !== productSystemId);\r\n  \r\n  const summary = calculateSummary(updatedProducts);\r\n\r\n  if (productToRemove) {\r\n    adjustReplacementStock(ticket, productToRemove, undefined);\r\n  }\r\n  \r\n  originalUpdate(ticketSystemId, {\r\n    ...ticket,\r\n    products: updatedProducts,\r\n    summary,\r\n    updatedAt: toISODateTime(getCurrentDate()),\r\n  } as any);\r\n  \r\n  if (productToRemove) {\r\n    addHistory(ticketSystemId, `Xóa SP: ${productToRemove.productName}`, getCurrentUserName());\r\n  }\r\n}\r\n\r\n/**\r\n * Tính toán lại summary\r\n */\r\nexport function recalculateSummary(ticketSystemId: SystemId) {\r\n  const ticket = baseStore.getState().data.find(t => t.systemId === ticketSystemId);\r\n  if (!ticket) return;\r\n  \r\n  const summary = calculateSummary(ticket.products);\r\n  \r\n  originalUpdate(ticketSystemId, {\r\n    ...ticket,\r\n    summary,\r\n  } as any);\r\n}\r\n\r\n/**\r\n * Helper: Tính trạng thái thanh toán\r\n */\r\nexport function calculateSettlementStatus(\r\n  totalSettlement: number, \r\n  totalPaid: number, \r\n  shippingFee: number = 0\r\n): 'pending' | 'partial' | 'completed' {\r\n  if (totalSettlement <= 0) return 'completed';\r\n  \r\n  const netAmount = totalSettlement - shippingFee;\r\n  if (netAmount <= 0) return 'completed';\r\n  \r\n  if (totalPaid === 0) return 'pending';\r\n  if (totalPaid >= netAmount) return 'completed';\r\n  return 'partial';\r\n}\r\n\r\n/**\r\n * Thêm lịch sử (internal use only)\r\n */\r\nexport function addHistory(\r\n  ticketSystemId: SystemId, \r\n  action: string, \r\n  performedBy: string, \r\n  note?: string,\r\n  metadata?: Record<string, any>\r\n) {\r\n  const ticket = baseStore.getState().data.find(t => t.systemId === ticketSystemId);\r\n  if (!ticket) return;\r\n  \r\n  const historyEntry: WarrantyHistory = {\r\n    systemId: asSystemId(`WH_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`),\r\n    action,\r\n    actionLabel: action,\r\n    performedBy,\r\n    performedAt: toISODateTime(getCurrentDate()),\r\n    note,\r\n    metadata,\r\n  };\r\n  \r\n  originalUpdate(ticketSystemId, {\r\n    ...ticket,\r\n    history: [...(ticket.history || []), historyEntry],\r\n  } as any);\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 3186, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/warranty/store/status-management.ts"],"sourcesContent":["import { getCurrentDate, toISODateTime } from '../../../lib/date-utils';\r\nimport type { SystemId } from '../../../lib/id-types';\r\nimport type { WarrantyTicket, WarrantyStatus } from '../types';\r\nimport { baseStore, originalUpdate, getCurrentUserName } from './base-store';\r\nimport { addHistory } from './product-management';\r\nimport { deductWarrantyStock, rollbackWarrantyStock } from './stock-management';\r\nimport {\r\n  notifyWarrantyProcessing,\r\n  notifyWarrantyProcessed,\r\n  notifyWarrantyReturned,\r\n} from '../notification-utils';\r\nimport { triggerWarrantyDataUpdate } from '../use-realtime-updates';\r\n\r\ntype TimestampKey = 'processingStartedAt' | 'processedAt' | 'returnedAt' | 'completedAt';\r\n\r\nconst STATUS_ORDER: Record<WarrantyStatus, number> = {\r\n  incomplete: 0,\r\n  pending: 1,\r\n  processed: 2,\r\n  returned: 3,\r\n  completed: 4,\r\n  cancelled: 5,\r\n};\r\n\r\nconst TIMESTAMP_STAGES: Array<{ key: TimestampKey; stageOrder: number }> = [\r\n  { key: 'processingStartedAt', stageOrder: STATUS_ORDER.pending },\r\n  { key: 'processedAt', stageOrder: STATUS_ORDER.processed },\r\n  { key: 'returnedAt', stageOrder: STATUS_ORDER.returned },\r\n  { key: 'completedAt', stageOrder: STATUS_ORDER.completed },\r\n];\r\n\r\nfunction computeTimestampUpdates(\r\n  ticket: WarrantyTicket,\r\n  newStatus: WarrantyStatus,\r\n  nowIso: string\r\n): Partial<Pick<WarrantyTicket, TimestampKey>> {\r\n  const updates: Partial<Pick<WarrantyTicket, TimestampKey>> = {};\r\n  const oldOrder = STATUS_ORDER[ticket.status] ?? 0;\r\n  const newOrder = STATUS_ORDER[newStatus] ?? oldOrder;\r\n\r\n  TIMESTAMP_STAGES.forEach(({ key, stageOrder }) => {\r\n    const currentValue = ticket[key];\r\n    const crossedForward = newOrder >= stageOrder && oldOrder < stageOrder;\r\n\r\n    if (newStatus !== 'cancelled' && crossedForward && !currentValue) {\r\n      updates[key] = nowIso;\r\n      return;\r\n    }\r\n\r\n    const movedBackward = newOrder < stageOrder;\r\n    if (movedBackward && currentValue) {\r\n      updates[key] = undefined;\r\n    }\r\n  });\r\n\r\n  return updates;\r\n}\r\n\r\n/**\r\n * Cập nhật trạng thái phiếu bảo hành\r\n * NEW LOGIC theo yêu cầu:\r\n * - pending: +Đang giao dịch (commitWarrantyStock)\r\n * - processed: Không động kho\r\n * - returned: Không động kho\r\n * - completed: -Đang giao dịch + -Tồn kho (deductWarrantyStock)\r\n */\r\nexport function updateStatus(ticketSystemId: SystemId, newStatus: WarrantyTicket['status'], note?: string) {\r\n  const ticket = baseStore.getState().data.find(t => t.systemId === ticketSystemId);\r\n  if (!ticket) return;\r\n  \r\n  console.log('[STATUS CHANGE]', {\r\n    ticketId: ticket.id,\r\n    oldStatus: ticket.status,\r\n    newStatus: newStatus,\r\n    productsCount: ticket.products.length,\r\n    replacedProducts: ticket.products.filter(p => p.resolution === 'replace').length\r\n  });\r\n  \r\n  const nowIso = toISODateTime(getCurrentDate());\r\n  const timestampUpdates = computeTimestampUpdates(ticket, newStatus, nowIso);\r\n  const baseUpdate: WarrantyTicket = {\r\n    ...ticket,\r\n    ...timestampUpdates,\r\n    status: newStatus,\r\n    updatedAt: nowIso,\r\n  };\r\n\r\n  // XUẤT KHO khi completed (CHỈ 1 LẦN DUY NHẤT - không trừ lại khi reopen)\r\n  if (newStatus === 'completed' && ticket.status !== 'completed' && !ticket.stockDeducted) {\r\n    console.log('[COMPLETED - DEDUCT] Xuất kho (LẦN ĐẦU TIÊN):', {\r\n      ticketId: ticket.id,\r\n      oldStatus: ticket.status,\r\n      newStatus: newStatus,\r\n      stockDeducted: ticket.stockDeducted,\r\n      action: '-Đang giao dịch + -Tồn kho'\r\n    });\r\n    deductWarrantyStock(ticket);\r\n    \r\n    // Set flag để không trừ lại lần nữa\r\n    originalUpdate(ticketSystemId, {\r\n      ...baseUpdate,\r\n      stockDeducted: true,\r\n    } as any);\r\n  } else if (newStatus === 'completed' && ticket.stockDeducted) {\r\n    console.log('[COMPLETED - SKIP DEDUCT] Đã trừ kho rồi, bỏ qua:', {\r\n      ticketId: ticket.id,\r\n      oldStatus: ticket.status,\r\n      newStatus: newStatus,\r\n      stockDeducted: ticket.stockDeducted\r\n    });\r\n    \r\n    // Chỉ update status, KHÔNG trừ kho nữa\r\n    originalUpdate(ticketSystemId, baseUpdate as any);\r\n  } else {\r\n    // Normal status update (không phải completed)\r\n    originalUpdate(ticketSystemId, baseUpdate as any);\r\n  }\r\n  \r\n  // KHÔNG ROLLBACK KHO khi mở lại từ completed\r\n  // Lý do:\r\n  // - Kết thúc = Đơn đã xong, hàng đã xuất, tiền đã thanh toán đầy đủ\r\n  // - Mở lại (completed → returned) CHỈ để xem lại, KHÔNG được sửa/thay đổi gì\r\n  // - Nếu cần điều chỉnh → Phải tạo phiếu mới, hoàn hàng thủ công, tạo phiếu thu/chi riêng\r\n  // - Giữ nguyên inventory và payment history để đảm bảo tính toàn vẹn dữ liệu\r\n  \r\n  // KHÔNG ROLLBACK KHO khi mở lại từ completed\r\n  // Lý do:\r\n  // - Kết thúc = Đơn đã xong, hàng đã xuất, tiền đã thanh toán đầy đủ\r\n  // - Mở lại (completed → returned) CHỈ để xem lại, KHÔNG được sửa/thay đổi gì\r\n  // - Nếu cần điều chỉnh → Phải tạo phiếu mới, hoàn hàng thủ công, tạo phiếu thu/chi riêng\r\n  // - Giữ nguyên inventory và payment history để đảm bảo tính toàn vẹn dữ liệu\r\n  \r\n  // Add history với format rõ ràng\r\n  const statusLabels: Record<string, string> = {\r\n    incomplete: 'Chưa đủ thông tin',\r\n    pending: 'Chưa xử lý',\r\n    processed: 'Đã xử lý',\r\n    returned: 'Đã trả hàng',\r\n    completed: 'Kết thúc'\r\n  };\r\n  const oldStatusLabel = statusLabels[ticket.status] || ticket.status;\r\n  const newStatusLabel = statusLabels[newStatus] || newStatus;\r\n  \r\n  // Format history dựa trên hướng chuyển đổi\r\n  let historyAction: string;\r\n  if (ticket.status === 'completed' && (newStatus === 'returned' || newStatus === 'processed')) {\r\n    // Mở lại từ \"Kết thúc\"\r\n    historyAction = `Mở lại từ ${oldStatusLabel}`;\r\n  } else if (ticket.status === 'returned' && newStatus === 'processed') {\r\n    // Mở lại từ \"Đã trả hàng\"\r\n    historyAction = `Mở lại từ ${oldStatusLabel}`;\r\n  } else if (newStatus === 'completed') {\r\n    // Kết thúc phiếu\r\n    historyAction = 'Kết thúc phiếu bảo hành';\r\n  } else {\r\n    // Chuyển trạng thái bình thường\r\n    historyAction = `Chuyển trạng thái: ${oldStatusLabel} → ${newStatusLabel}`;\r\n  }\r\n  \r\n  addHistory(ticketSystemId, historyAction, getCurrentUserName(), note);\r\n  \r\n  // Send notifications\r\n  if (ticket.status !== newStatus) {\r\n    if (newStatus === 'pending') {\r\n      notifyWarrantyProcessing(ticket.id);\r\n    } else if (newStatus === 'processed') {\r\n      notifyWarrantyProcessed(ticket.id);\r\n    } else if (newStatus === 'returned') {\r\n      notifyWarrantyReturned(ticket.id, undefined);\r\n    }\r\n  }\r\n  \r\n  triggerWarrantyDataUpdate();\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 3349, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/warranty/store/index.ts"],"sourcesContent":["import { create } from 'zustand';\r\nimport { getCurrentDate, toISODateTime } from '../../../lib/date-utils';\r\nimport { getWorkflowTemplate } from '../../settings/printer/workflow-templates-page';\r\nimport { toast } from 'sonner';\r\nimport { asSystemId } from '../../../lib/id-types';\r\nimport type { SystemId } from '../../../lib/id-types';\r\nimport {\r\n  notifyWarrantyCreated,\r\n} from '../notification-utils';\r\nimport { triggerWarrantyDataUpdate } from '../use-realtime-updates';\r\nimport type { WarrantyTicket, WarrantyProduct } from '../types';\r\nimport type { WarrantyStore } from '../types';\r\n\r\n// Import base store và các modules\r\nimport {\r\n  baseStore,\r\n  originalAdd,\r\n  originalUpdate,\r\n  originalRemove,\r\n  generatePublicTrackingCode,\r\n  getCurrentUserName,\r\n  syncToApi,\r\n} from './base-store';\r\n\r\nimport {\r\n  commitWarrantyStock,\r\n  uncommitWarrantyStock,\r\n} from './stock-management';\r\n\r\nimport {\r\n  addProduct,\r\n  updateProduct,\r\n  removeProduct,\r\n  recalculateSummary,\r\n  calculateSummary,\r\n  calculateSettlementStatus,\r\n  addHistory,\r\n} from './product-management';\r\n\r\nimport {\r\n  updateStatus,\r\n} from './status-management';\r\n\r\n// Override add() for custom logic\r\nbaseStore.setState({\r\n  add: (item: Omit<WarrantyTicket, 'systemId'>) => {\r\n    // Auto ID generation by createCrudStore\r\n    const newTicket = originalAdd(item);\r\n    \r\n    // Copy workflow template subtasks\r\n    const subtasks = getWorkflowTemplate('warranty');\r\n    if (subtasks && subtasks.length > 0) {\r\n      newTicket.subtasks = subtasks;\r\n    }\r\n    \r\n    // Generate public tracking code\r\n    if (!newTicket.publicTrackingCode) {\r\n      newTicket.publicTrackingCode = generatePublicTrackingCode();\r\n    }\r\n    \r\n    // Commit stock for replace products\r\n    commitWarrantyStock(newTicket);\r\n    \r\n    // Add initial history\r\n    if (!newTicket.history || newTicket.history.length === 0) {\r\n      newTicket.history = [{\r\n        systemId: asSystemId(`WH_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`),\r\n        action: 'Tạo phiếu bảo hành',\r\n        actionLabel: 'Tạo phiếu bảo hành',\r\n        performedBy: getCurrentUserName(),\r\n        performedAt: toISODateTime(getCurrentDate()),\r\n      }];\r\n    }\r\n    \r\n    // Update state to include subtasks, history, publicTrackingCode\r\n    baseStore.setState((state) => ({\r\n      data: state.data.map(t => t.systemId === newTicket.systemId ? newTicket : t)\r\n    }));\r\n    \r\n    // ✅ Sync to API\r\n    syncToApi.create(newTicket);\r\n    \r\n    // Send notification\r\n    notifyWarrantyCreated(newTicket.id);\r\n    \r\n    // Trigger realtime update\r\n    triggerWarrantyDataUpdate();\r\n    \r\n    return newTicket;\r\n  },\r\n  \r\n  update: (systemId: SystemId, updates: any) => {\r\n    const oldTicket = baseStore.getState().data.find(t => t.systemId === systemId);\r\n    if (!oldTicket) return;\r\n    \r\n    // Check if history is explicitly provided\r\n    const hasExplicitHistory = updates.history && updates.history.length > (oldTicket.history?.length || 0);\r\n    \r\n    // Track changes for auto-history\r\n    const changes: string[] = [];\r\n    \r\n    if (!hasExplicitHistory) {\r\n      if (updates.customerName && updates.customerName !== oldTicket.customerName) {\r\n        changes.push(`Tên khách hàng: \"${oldTicket.customerName}\" → \"${updates.customerName}\"`);\r\n      }\r\n      if (updates.customerPhone && updates.customerPhone !== oldTicket.customerPhone) {\r\n        changes.push(`Số điện thoại: \"${oldTicket.customerPhone}\" → \"${updates.customerPhone}\"`);\r\n      }\r\n      if (updates.trackingCode && updates.trackingCode !== oldTicket.trackingCode) {\r\n        changes.push(`Mã vận đơn: \"${oldTicket.trackingCode}\" → \"${updates.trackingCode}\"`);\r\n      }\r\n    }\r\n    \r\n    originalUpdate(systemId, updates);\r\n    \r\n    // ✅ Sync to API\r\n    syncToApi.update(systemId, updates);\r\n    \r\n    // Add auto-history\r\n    if (!hasExplicitHistory && changes.length > 0) {\r\n      changes.forEach(change => {\r\n        addHistory(systemId, change, getCurrentUserName());\r\n      });\r\n    }\r\n    \r\n    // Trigger realtime update\r\n    triggerWarrantyDataUpdate();\r\n  },\r\n  \r\n  remove: (systemId: SystemId) => {\r\n    const ticket = baseStore.getState().data.find(t => t.systemId === systemId);\r\n    \r\n    if (ticket) {\r\n      // Add history before deletion\r\n      addHistory(systemId, 'Xóa phiếu bảo hành (chuyển vào thùng rác)', getCurrentUserName());\r\n      \r\n      // Uncommit stock\r\n      uncommitWarrantyStock(ticket);\r\n    }\r\n    \r\n    originalRemove(systemId);\r\n    \r\n    // ✅ Sync to API\r\n    syncToApi.delete(systemId, false);\r\n    \r\n    // Trigger realtime update\r\n    triggerWarrantyDataUpdate();\r\n  },\r\n});\r\n\r\nexport const useWarrantyStore = create<WarrantyStore>()((set, get) => ({\r\n  ...baseStore.getState(),\r\n  \r\n  // Warranty-specific methods\r\n  addProduct,\r\n  updateProduct,\r\n  removeProduct,\r\n  updateStatus,\r\n  addHistory,\r\n  recalculateSummary,\r\n  calculateSummary,\r\n  calculateSettlementStatus,\r\n  \r\n  // Placeholder methods for backward compatibility\r\n  addComment: () => console.warn('addComment: Use generic Comments component instead'),\r\n  updateComment: () => console.warn('updateComment: Use generic Comments component instead'),\r\n  deleteComment: () => console.warn('deleteComment: Use generic Comments component instead'),\r\n  replyComment: () => console.warn('replyComment: Use generic Comments component instead'),\r\n  generateNextSystemId: () => {\r\n    // Generate next systemId using same pattern as createCrudStore\r\n    const maxSystemId = baseStore.getState().data.reduce((max, item) => {\r\n      const match = item.systemId.match(/WARRANTY(\\d{6})/);\r\n      return match ? Math.max(max, parseInt(match[1])) : max;\r\n    }, 0);\r\n    return asSystemId(`WARRANTY${String(maxSystemId + 1).padStart(6, '0')}`);\r\n  },\r\n  _migrate: () => console.warn('_migrate: No longer needed with createCrudStore'),\r\n}));\r\n\r\n// Subscribe to base store changes\r\nbaseStore.subscribe((state) => {\r\n  useWarrantyStore.setState(state as any);\r\n});\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 3497, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/warranty/store.ts"],"sourcesContent":["export { useWarrantyStore } from './store/index';\r\n"],"names":[],"mappings":";AAAA"}},
    {"offset": {"line": 3507, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/products/store.ts"],"sourcesContent":["import { createCrudStore, CrudState } from '../../lib/store-factory';\r\n// REMOVED: import { data as initialData } from './data'; // Mock data no longer used - database is source of truth\r\nimport type { Product } from './types';\r\nimport { type SystemId } from '@/lib/id-types';\r\nimport { asSystemId, asBusinessId } from '../../lib/id-types';\r\nimport { getCurrentUserSystemId } from '../../contexts/auth-context';\r\nimport Fuse from 'fuse.js';\r\nimport {\r\n  getCurrentUserInfo,\r\n  createCreatedEntry,\r\n  createUpdatedEntry,\r\n  createStatusChangedEntry,\r\n  appendHistoryEntry,\r\n  type HistoryEntry\r\n} from '../../lib/activity-history-helper';\r\n\r\nconst baseStore = createCrudStore<Product>([], 'products', {\r\n  businessIdField: 'id',\r\n  getCurrentUser: getCurrentUserSystemId, // ✅ Track who creates/updates\r\n  apiEndpoint: '/api/products',\r\n});\r\n\r\n// ✅ API Sync helpers\r\nconst API_ENDPOINT = '/api/products';\r\n\r\nconst syncToApi = {\r\n  create: async (product: Product) => {\r\n    try {\r\n      const response = await fetch(API_ENDPOINT, {\r\n        method: 'POST',\r\n        credentials: 'include',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify(product),\r\n      });\r\n      if (!response.ok) console.warn('[Product API] Create sync failed');\r\n      else console.log('[Product API] Created:', product.systemId);\r\n    } catch (e) {\r\n      console.warn('[Product API] Create sync error:', e);\r\n    }\r\n  },\r\n  update: async (systemId: SystemId, updates: Partial<Product>) => {\r\n    try {\r\n      const response = await fetch(`${API_ENDPOINT}/${systemId}`, {\r\n        method: 'PATCH',\r\n        credentials: 'include',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify(updates),\r\n      });\r\n      if (!response.ok) console.warn('[Product API] Update sync failed');\r\n      else console.log('[Product API] Updated:', systemId);\r\n    } catch (e) {\r\n      console.warn('[Product API] Update sync error:', e);\r\n    }\r\n  },\r\n  delete: async (systemId: SystemId, hard = false) => {\r\n    try {\r\n      const response = await fetch(`${API_ENDPOINT}/${systemId}`, {\r\n        method: 'DELETE',\r\n        credentials: 'include',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({ hard }),\r\n      });\r\n      if (!response.ok) console.warn('[Product API] Delete sync failed');\r\n      else console.log('[Product API] Deleted:', systemId);\r\n    } catch (e) {\r\n      console.warn('[Product API] Delete sync error:', e);\r\n    }\r\n  },\r\n  restore: async (systemId: SystemId) => {\r\n    try {\r\n      const response = await fetch(`${API_ENDPOINT}/${systemId}/restore`, {\r\n        method: 'POST',\r\n        credentials: 'include',\r\n        headers: { 'Content-Type': 'application/json' },\r\n      });\r\n      if (!response.ok) console.warn('[Product API] Restore sync failed');\r\n      else console.log('[Product API] Restored:', systemId);\r\n    } catch (e) {\r\n      console.warn('[Product API] Restore sync error:', e);\r\n    }\r\n  },\r\n};\r\n\r\n// ✅ Wrap base store methods with API sync\r\nconst originalAdd = baseStore.getState().add;\r\nconst originalUpdate = baseStore.getState().update;\r\nconst originalRemove = baseStore.getState().remove;\r\nconst originalHardDelete = baseStore.getState().hardDelete;\r\nconst originalRestore = baseStore.getState().restore;\r\n\r\nbaseStore.setState({\r\n  add: (item: Omit<Product, 'systemId'>) => {\r\n    const result = originalAdd(item);\r\n    syncToApi.create(result);\r\n    return result;\r\n  },\r\n  update: (systemId: SystemId, updates: Partial<Product>) => {\r\n    originalUpdate(systemId, updates);\r\n    syncToApi.update(systemId, updates);\r\n  },\r\n  remove: (systemId: SystemId) => {\r\n    originalRemove(systemId);\r\n    syncToApi.delete(systemId, false);\r\n  },\r\n  hardDelete: (systemId: SystemId) => {\r\n    originalHardDelete(systemId);\r\n    syncToApi.delete(systemId, true);\r\n  },\r\n  restore: (systemId: SystemId) => {\r\n    originalRestore(systemId);\r\n    syncToApi.restore(systemId);\r\n  },\r\n});\r\n\r\n// Define extended store interface\r\nexport interface ProductStoreState extends CrudState<Product> {\r\n  updateInventory: (productSystemId: SystemId, branchSystemId: SystemId, quantityChange: number) => void;\r\n  commitStock: (productSystemId: SystemId, branchSystemId: SystemId, quantity: number) => void;\r\n  uncommitStock: (productSystemId: SystemId, branchSystemId: SystemId, quantity: number) => void;\r\n  dispatchStock: (productSystemId: SystemId, branchSystemId: SystemId, quantity: number) => void;\r\n  completeDelivery: (productSystemId: SystemId, branchSystemId: SystemId, quantity: number) => void;\r\n  returnStockFromTransit: (productSystemId: SystemId, branchSystemId: SystemId, quantity: number) => void;\r\n  updateLastPurchasePrice: (productSystemId: SystemId, price: number, date: string) => void;\r\n  searchProducts: (query: string, page: number, limit?: number) => Promise<{ items: { value: SystemId; label: string }[], hasNextPage: boolean }>;\r\n}\r\n\r\n// Helper to check if product tracks stock\r\nconst canModifyStock = (product: Product | undefined): boolean => {\r\n  if (!product) return false;\r\n  // Services, digital products, and combos don't track stock directly\r\n  if (product.type === 'service' || product.type === 'digital' || product.type === 'combo') return false;\r\n  // Explicitly disabled stock tracking\r\n  if (product.isStockTracked === false) return false;\r\n  return true;\r\n};\r\n\r\n// Define custom methods\r\nconst updateInventory = (productSystemId: SystemId, branchSystemId: SystemId, quantityChange: number) => {\r\n  baseStore.setState(state => {\r\n    const product = state.data.find(p => p.systemId === productSystemId);\r\n    if (!product) return state;\r\n    \r\n    // Skip if product doesn't track stock\r\n    if (!canModifyStock(product)) {\r\n      console.warn(`[updateInventory] Skipped: Product ${productSystemId} does not track stock`);\r\n      return state;\r\n    }\r\n    \r\n    const oldQuantity = product.inventoryByBranch?.[branchSystemId] || 0;\r\n    const newQuantity = oldQuantity + quantityChange;\r\n    \r\n    // ✅ Removed COMPLAINT_ADJUSTMENT stock history creation\r\n    // Stock history will be created by inventory check balance instead\r\n    \r\n    return {\r\n      data: state.data.map(p => {\r\n        if (p.systemId === productSystemId) {\r\n          const newInventoryByBranch = { ...p.inventoryByBranch };\r\n          newInventoryByBranch[branchSystemId] = newQuantity;\r\n          return {\r\n            ...p,\r\n            inventoryByBranch: newInventoryByBranch,\r\n          };\r\n        }\r\n        return p;\r\n      }),\r\n    };\r\n  });\r\n};\r\n\r\nconst commitStock = (productSystemId: SystemId, branchSystemId: SystemId, quantity: number) => {\r\n  baseStore.setState(state => {\r\n    const product = state.data.find(p => p.systemId === productSystemId);\r\n    if (!canModifyStock(product)) {\r\n      console.warn(`[commitStock] Skipped: Product ${productSystemId} does not track stock`);\r\n      return state;\r\n    }\r\n    return {\r\n      data: state.data.map(p => {\r\n        if (p.systemId === productSystemId) {\r\n          const newCommitted = { ...p.committedByBranch };\r\n          newCommitted[branchSystemId] = (newCommitted[branchSystemId] || 0) + quantity;\r\n          return { ...p, committedByBranch: newCommitted };\r\n        }\r\n        return p;\r\n      }),\r\n    };\r\n  });\r\n};\r\n\r\nconst uncommitStock = (productSystemId: SystemId, branchSystemId: SystemId, quantity: number) => {\r\n  baseStore.setState(state => {\r\n    const product = state.data.find(p => p.systemId === productSystemId);\r\n    if (!canModifyStock(product)) {\r\n      console.warn(`[uncommitStock] Skipped: Product ${productSystemId} does not track stock`);\r\n      return state;\r\n    }\r\n    return {\r\n      data: state.data.map(p => {\r\n        if (p.systemId === productSystemId) {\r\n          const newCommitted = { ...p.committedByBranch };\r\n          newCommitted[branchSystemId] = Math.max(0, (newCommitted[branchSystemId] || 0) - quantity);\r\n          return { ...p, committedByBranch: newCommitted };\r\n        }\r\n        return p;\r\n      }),\r\n    };\r\n  });\r\n};\r\n\r\nconst dispatchStock = (productSystemId: SystemId, branchSystemId: SystemId, quantity: number) => {\r\n  console.log('🔴 [dispatchStock] Called with:', { productSystemId, branchSystemId, quantity });\r\n  \r\n  baseStore.setState(state => {\r\n    const product = state.data.find(p => p.systemId === productSystemId);\r\n    if (!product) {\r\n      console.error('❌ [dispatchStock] Product not found:', productSystemId);\r\n      return state;\r\n    }\r\n    \r\n    // Skip if product doesn't track stock\r\n    if (!canModifyStock(product)) {\r\n      console.warn(`[dispatchStock] Skipped: Product ${productSystemId} does not track stock`);\r\n      return state;\r\n    }\r\n    \r\n    console.log('📦 [dispatchStock] Current inventory:', product.inventoryByBranch);\r\n    console.log('📦 [dispatchStock] Current committed:', product.committedByBranch);\r\n    \r\n    return {\r\n      data: state.data.map(product => {\r\n        if (product.systemId === productSystemId) {\r\n          const newInventory = { ...product.inventoryByBranch };\r\n          const oldInventory = newInventory[branchSystemId] || 0;\r\n          newInventory[branchSystemId] = oldInventory - quantity;\r\n          \r\n          const newCommitted = { ...product.committedByBranch };\r\n          newCommitted[branchSystemId] = Math.max(0, (newCommitted[branchSystemId] || 0) - quantity);\r\n\r\n          const newInTransit = { ...product.inTransitByBranch };\r\n          newInTransit[branchSystemId] = (newInTransit[branchSystemId] || 0) + quantity;\r\n          \r\n          console.log('✅ [dispatchStock] Updated inventory:', {\r\n            old: oldInventory,\r\n            new: newInventory[branchSystemId],\r\n            change: -quantity\r\n          });\r\n          \r\n          return { \r\n            ...product, \r\n            inventoryByBranch: newInventory,\r\n            committedByBranch: newCommitted,\r\n            inTransitByBranch: newInTransit,\r\n          };\r\n        }\r\n        return product;\r\n      }),\r\n    };\r\n  });\r\n  \r\n  console.log('✅ [dispatchStock] Completed');\r\n};\r\n\r\nconst completeDelivery = (productSystemId: SystemId, branchSystemId: SystemId, quantity: number) => {\r\n  baseStore.setState(state => {\r\n    const product = state.data.find(p => p.systemId === productSystemId);\r\n    if (!canModifyStock(product)) {\r\n      return state;\r\n    }\r\n    return {\r\n      data: state.data.map(p => {\r\n        if (p.systemId === productSystemId) {\r\n          const newInTransit = { ...p.inTransitByBranch };\r\n          newInTransit[branchSystemId] = Math.max(0, (newInTransit[branchSystemId] || 0) - quantity);\r\n          return { ...p, inTransitByBranch: newInTransit };\r\n        }\r\n        return p;\r\n      }),\r\n    };\r\n  });\r\n};\r\n\r\nconst returnStockFromTransit = (productSystemId: SystemId, branchSystemId: SystemId, quantity: number) => {\r\n  baseStore.setState(state => {\r\n    const product = state.data.find(p => p.systemId === productSystemId);\r\n    if (!canModifyStock(product)) {\r\n      return state;\r\n    }\r\n    return {\r\n      data: state.data.map(p => {\r\n        if (p.systemId === productSystemId) {\r\n          const newInTransit = { ...p.inTransitByBranch };\r\n          newInTransit[branchSystemId] = Math.max(0, (newInTransit[branchSystemId] || 0) - quantity);\r\n          const newInventory = { ...p.inventoryByBranch };\r\n          newInventory[branchSystemId] = (newInventory[branchSystemId] || 0) + quantity;\r\n          return { ...p, inventoryByBranch: newInventory, inTransitByBranch: newInTransit };\r\n        }\r\n        return p;\r\n      }),\r\n    };\r\n  });\r\n};\r\n\r\nconst updateLastPurchasePrice = (productSystemId: SystemId, price: number, date: string) => {\r\n  baseStore.setState(state => ({\r\n    data: state.data.map(product => {\r\n      if (product.systemId === productSystemId) {\r\n        // Only update if the new date is newer or equal to the existing lastPurchaseDate\r\n        const existingDate = product.lastPurchaseDate ? new Date(product.lastPurchaseDate).getTime() : 0;\r\n        const newDateTs = new Date(date).getTime();\r\n        \r\n        if (newDateTs >= existingDate) {\r\n          return {\r\n            ...product,\r\n            lastPurchasePrice: price,\r\n            lastPurchaseDate: date,\r\n          };\r\n        }\r\n      }\r\n      return product;\r\n    }),\r\n  }));\r\n};\r\n\r\nconst searchProducts = async (query: string, page: number = 1, limit: number = 10): Promise<{ items: { value: SystemId; label: string }[], hasNextPage: boolean }> => {\r\n  const allProducts = baseStore.getState().data;\r\n  \r\n  // ✅ Create fresh Fuse instance with current data (avoid stale data)\r\n  const fuse = new Fuse(allProducts, {\r\n    keys: ['name', 'id', 'sku', 'barcode'],\r\n    threshold: 0.3,\r\n  });\r\n  \r\n  const results = fuse.search(query);\r\n  const startIndex = (page - 1) * limit;\r\n  const endIndex = startIndex + limit;\r\n  const paginatedResults = results.slice(startIndex, endIndex);\r\n\r\n  return {\r\n    items: paginatedResults.map(result => ({\r\n      value: asSystemId(result.item.systemId),\r\n      label: `${result.item.name} (${result.item.id})`,\r\n    })),\r\n    hasNextPage: endIndex < results.length,\r\n  };\r\n};\r\n\r\n// Wrapped add method with activity history logging\r\nconst addProduct = (product: Omit<Product, 'systemId'>) => {\r\n  const userInfo = getCurrentUserInfo();\r\n  const newProduct = baseStore.getState().add(product);\r\n  \r\n  // Add activity history entry\r\n  const historyEntry = createCreatedEntry(\r\n    userInfo,\r\n    `${userInfo.name} đã tạo sản phẩm ${newProduct.name} (${newProduct.id})`\r\n  );\r\n  baseStore.getState().update(newProduct.systemId, {\r\n    ...newProduct,\r\n    activityHistory: [historyEntry]\r\n  });\r\n  \r\n  return newProduct;\r\n};\r\n\r\n// Wrapped update method with activity history logging\r\nconst updateProduct = (systemId: SystemId, updatedProduct: Product) => {\r\n  const userInfo = getCurrentUserInfo();\r\n  const existingProduct = baseStore.getState().data.find(p => p.systemId === systemId);\r\n  const historyEntries: HistoryEntry[] = [];\r\n  \r\n  if (existingProduct) {\r\n    // Track status changes\r\n    if (existingProduct.status !== updatedProduct.status) {\r\n      const statusLabels: Record<string, string> = {\r\n        'active': 'Đang kinh doanh',\r\n        'inactive': 'Ngừng kinh doanh',\r\n        'discontinued': 'Ngừng sản xuất'\r\n      };\r\n      historyEntries.push(createStatusChangedEntry(\r\n        userInfo,\r\n        statusLabels[existingProduct.status || 'active'],\r\n        statusLabels[updatedProduct.status || 'active'],\r\n        `${userInfo.name} đã đổi trạng thái từ \"${statusLabels[existingProduct.status || 'active']}\" sang \"${statusLabels[updatedProduct.status || 'active']}\"`\r\n      ));\r\n    }\r\n    \r\n    // Track field changes\r\n    const fieldsToTrack: Array<{ key: keyof Product; label: string }> = [\r\n      { key: 'name', label: 'Tên sản phẩm' },\r\n      { key: 'id', label: 'Mã SKU' },\r\n      { key: 'description', label: 'Mô tả' },\r\n      { key: 'shortDescription', label: 'Mô tả ngắn' },\r\n      { key: 'type', label: 'Loại sản phẩm' },\r\n      { key: 'categorySystemId', label: 'Danh mục' },\r\n      { key: 'brandSystemId', label: 'Thương hiệu' },\r\n      { key: 'unit', label: 'Đơn vị tính' },\r\n      { key: 'costPrice', label: 'Giá vốn' },\r\n      { key: 'minPrice', label: 'Giá tối thiểu' },\r\n      { key: 'barcode', label: 'Mã vạch' },\r\n      { key: 'primarySupplierSystemId', label: 'Nhà cung cấp chính' },\r\n      { key: 'warrantyPeriodMonths', label: 'Thời hạn bảo hành' },\r\n      { key: 'reorderLevel', label: 'Mức đặt hàng lại' },\r\n      { key: 'safetyStock', label: 'Tồn kho an toàn' },\r\n      { key: 'maxStock', label: 'Tồn kho tối đa' },\r\n    ];\r\n    \r\n    const changes: string[] = [];\r\n    for (const field of fieldsToTrack) {\r\n      const oldVal = existingProduct[field.key];\r\n      const newVal = updatedProduct[field.key];\r\n      if (oldVal !== newVal && !(oldVal === undefined && newVal === undefined)) {\r\n        if (field.key === 'status') continue;\r\n        const oldDisplay = oldVal !== undefined && oldVal !== null && oldVal !== '' ? String(oldVal) : '(trống)';\r\n        const newDisplay = newVal !== undefined && newVal !== null && newVal !== '' ? String(newVal) : '(trống)';\r\n        changes.push(`${field.label}: ${oldDisplay} → ${newDisplay}`);\r\n      }\r\n    }\r\n    \r\n    // Track price changes separately\r\n    if (existingProduct.costPrice !== updatedProduct.costPrice) {\r\n      changes.push(`Giá vốn: ${existingProduct.costPrice?.toLocaleString('vi-VN')} → ${updatedProduct.costPrice?.toLocaleString('vi-VN')}`);\r\n    }\r\n    \r\n    if (changes.length > 0) {\r\n      historyEntries.push(createUpdatedEntry(\r\n        userInfo,\r\n        `${userInfo.name} đã cập nhật: ${changes.join(', ')}`\r\n      ));\r\n    }\r\n  }\r\n  \r\n  const productWithHistory = {\r\n    ...updatedProduct,\r\n    activityHistory: appendHistoryEntry(existingProduct?.activityHistory, ...historyEntries)\r\n  };\r\n  \r\n  baseStore.getState().update(systemId, productWithHistory);\r\n};\r\n\r\n// Export typed hook that includes both base and custom methods\r\nexport const useProductStore = (): ProductStoreState => {\r\n  const state = baseStore();\r\n  return {\r\n    ...state,\r\n    add: addProduct,\r\n    update: updateProduct,\r\n    updateInventory,\r\n    commitStock,\r\n    uncommitStock,\r\n    dispatchStock,\r\n    completeDelivery,\r\n    returnStockFromTransit,\r\n    updateLastPurchasePrice,\r\n    searchProducts,\r\n  };\r\n};\r\n\r\n// Export getState method for non-hook usage\r\nuseProductStore.getState = () => {\r\n  const state = baseStore.getState();\r\n  return {\r\n    ...state,\r\n    add: addProduct,\r\n    update: updateProduct,\r\n    updateInventory,\r\n    commitStock,\r\n    uncommitStock,\r\n    dispatchStock,\r\n    completeDelivery,\r\n    returnStockFromTransit,\r\n    updateLastPurchasePrice,\r\n    searchProducts,\r\n  };\r\n};\r\n\r\n(useProductStore as typeof useProductStore & { subscribe?: typeof baseStore.subscribe }).subscribe = baseStore.subscribe;\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 4021, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/products/combo-utils.ts"],"sourcesContent":["/**\r\n * Combo Product Utilities\r\n * ═══════════════════════════════════════════════════════════════\r\n * Tham khảo: Sapo Combo\r\n * - Combo không có tồn kho riêng\r\n * - Tồn kho combo = MIN(tồn kho SP con / số lượng trong combo)\r\n * - Tối đa 20 sản phẩm con\r\n * - Không cho phép combo lồng combo\r\n * ═══════════════════════════════════════════════════════════════\r\n */\r\n\r\nimport type { Product, ComboItem, ComboPricingType } from './types';\r\nimport type { SystemId } from '@/lib/id-types';\r\n\r\n// Constants\r\nexport const MAX_COMBO_ITEMS = 20;\r\nexport const MIN_COMBO_ITEMS = 2;\r\n\r\n/**\r\n * Check if product is a combo\r\n */\r\nexport function isComboProduct(product: Product): boolean {\r\n  return product.type === 'combo';\r\n}\r\n\r\n/**\r\n * Check if a product can be added to combo\r\n * - Không cho phép thêm combo vào combo (no nested combo)\r\n * - Sản phẩm phải active\r\n */\r\nexport function canAddToCombo(product: Product): boolean {\r\n  if (product.type === 'combo') return false;\r\n  if (product.status === 'discontinued') return false;\r\n  if (product.isDeleted) return false;\r\n  return true;\r\n}\r\n\r\n/**\r\n * Validate combo items\r\n * Returns error message or null if valid\r\n */\r\nexport function validateComboItems(\r\n  comboItems: ComboItem[],\r\n  allProducts: Product[]\r\n): string | null {\r\n  // Check minimum items\r\n  if (comboItems.length < MIN_COMBO_ITEMS) {\r\n    return `Combo phải có ít nhất ${MIN_COMBO_ITEMS} sản phẩm`;\r\n  }\r\n  \r\n  // Check maximum items\r\n  if (comboItems.length > MAX_COMBO_ITEMS) {\r\n    return `Combo chỉ được tối đa ${MAX_COMBO_ITEMS} sản phẩm`;\r\n  }\r\n  \r\n  // Check for duplicate products\r\n  const productIds = comboItems.map(item => item.productSystemId);\r\n  const uniqueIds = new Set(productIds);\r\n  if (uniqueIds.size !== productIds.length) {\r\n    return 'Combo không được chứa sản phẩm trùng lặp';\r\n  }\r\n  \r\n  // Check each item\r\n  for (const item of comboItems) {\r\n    // Check quantity\r\n    if (item.quantity < 1) {\r\n      return 'Số lượng sản phẩm trong combo phải >= 1';\r\n    }\r\n    \r\n    if (!Number.isInteger(item.quantity)) {\r\n      return 'Số lượng sản phẩm trong combo phải là số nguyên';\r\n    }\r\n    \r\n    // Check product exists and is valid\r\n    const product = allProducts.find(p => p.systemId === item.productSystemId);\r\n    if (!product) {\r\n      return 'Sản phẩm trong combo không tồn tại';\r\n    }\r\n    \r\n    if (!canAddToCombo(product)) {\r\n      return `Sản phẩm \"${product.name}\" không thể thêm vào combo`;\r\n    }\r\n  }\r\n  \r\n  return null;\r\n}\r\n\r\n/**\r\n * Calculate combo available stock for a specific branch\r\n * Formula: MIN(child_product_available / quantity_in_combo)\r\n * \r\n * @param comboItems - List of combo items\r\n * @param allProducts - All products to lookup\r\n * @param branchSystemId - Branch to calculate stock for\r\n * @returns Available combo quantity (floored to integer)\r\n */\r\nexport function calculateComboStock(\r\n  comboItems: ComboItem[],\r\n  allProducts: Product[],\r\n  branchSystemId: SystemId\r\n): number {\r\n  if (!comboItems || comboItems.length === 0) return 0;\r\n  \r\n  let minComboQuantity = Infinity;\r\n  \r\n  for (const item of comboItems) {\r\n    const product = allProducts.find(p => p.systemId === item.productSystemId);\r\n    if (!product) return 0; // If any product not found, combo unavailable\r\n    \r\n    // Available = On-hand - Committed\r\n    const onHand = product.inventoryByBranch?.[branchSystemId] || 0;\r\n    const committed = product.committedByBranch?.[branchSystemId] || 0;\r\n    const available = onHand - committed;\r\n    \r\n    // How many combos can we make from this product?\r\n    const comboQuantityFromThisProduct = Math.floor(available / item.quantity);\r\n    \r\n    minComboQuantity = Math.min(minComboQuantity, comboQuantityFromThisProduct);\r\n  }\r\n  \r\n  return minComboQuantity === Infinity ? 0 : Math.max(0, minComboQuantity);\r\n}\r\n\r\n/**\r\n * Calculate combo stock across all branches\r\n * Returns a map of branchSystemId -> available combo quantity\r\n */\r\nexport function calculateComboStockAllBranches(\r\n  comboItems: ComboItem[],\r\n  allProducts: Product[]\r\n): Record<SystemId, number> {\r\n  if (!comboItems || comboItems.length === 0) return {};\r\n  \r\n  // Collect all branch IDs from child products\r\n  const allBranchIds = new Set<SystemId>();\r\n  for (const item of comboItems) {\r\n    const product = allProducts.find(p => p.systemId === item.productSystemId);\r\n    if (product?.inventoryByBranch) {\r\n      Object.keys(product.inventoryByBranch).forEach(branchId => {\r\n        allBranchIds.add(branchId as SystemId);\r\n      });\r\n    }\r\n  }\r\n  \r\n  // Calculate stock for each branch\r\n  const result: Record<SystemId, number> = {};\r\n  for (const branchId of allBranchIds) {\r\n    result[branchId] = calculateComboStock(comboItems, allProducts, branchId);\r\n  }\r\n  \r\n  return result;\r\n}\r\n\r\n/**\r\n * Calculate combo price based on pricing type\r\n * \r\n * @param comboItems - List of combo items\r\n * @param allProducts - All products to lookup prices\r\n * @param pricingPolicySystemId - Which pricing policy to use\r\n * @param comboPricingType - How to calculate price\r\n * @param comboDiscount - Discount value (% or fixed amount)\r\n * @returns Calculated combo price\r\n */\r\nexport function calculateComboPrice(\r\n  comboItems: ComboItem[],\r\n  allProducts: Product[],\r\n  pricingPolicySystemId: SystemId,\r\n  comboPricingType: ComboPricingType,\r\n  comboDiscount: number = 0\r\n): number {\r\n  if (comboPricingType === 'fixed') {\r\n    // Fixed price is stored directly, not calculated\r\n    return comboDiscount; // In fixed mode, comboDiscount IS the price\r\n  }\r\n  \r\n  // Calculate sum of child products' prices\r\n  let sumPrice = 0;\r\n  for (const item of comboItems) {\r\n    const product = allProducts.find(p => p.systemId === item.productSystemId);\r\n    if (!product) continue;\r\n    \r\n    const unitPrice = product.prices?.[pricingPolicySystemId] || 0;\r\n    sumPrice += unitPrice * item.quantity;\r\n  }\r\n  \r\n  // Apply discount\r\n  if (comboPricingType === 'sum_discount_percent') {\r\n    const discountAmount = sumPrice * (comboDiscount / 100);\r\n    return Math.round(sumPrice - discountAmount);\r\n  }\r\n  \r\n  if (comboPricingType === 'sum_discount_amount') {\r\n    return Math.max(0, sumPrice - comboDiscount);\r\n  }\r\n  \r\n  return sumPrice;\r\n}\r\n\r\n/**\r\n * Calculate combo cost price (sum of child products' cost prices)\r\n */\r\ntype ComboCostOptions = {\r\n  /**\r\n   * Optional pricing policy to use when we have to fall back to selling price data.\r\n   * Ensures cost previews stay in sync with the price policy that users actually see.\r\n   */\r\n  fallbackPricingPolicyId?: SystemId;\r\n  /**\r\n   * Allow falling back to selling price data if cost/last purchase/min price are missing.\r\n   * Defaults to true to avoid showing zero cost when data is incomplete.\r\n   */\r\n  allowPriceFallback?: boolean;\r\n};\r\n\r\nconst isNumber = (value: unknown): value is number => typeof value === 'number' && Number.isFinite(value);\r\n\r\nexport function calculateComboCostPrice(\r\n  comboItems: ComboItem[],\r\n  allProducts: Product[],\r\n  options: ComboCostOptions = {}\r\n): number {\r\n  const { fallbackPricingPolicyId, allowPriceFallback = true } = options;\r\n  let totalCost = 0;\r\n  \r\n  for (const item of comboItems) {\r\n    const product = allProducts.find(p => p.systemId === item.productSystemId);\r\n    if (!product) continue;\r\n\r\n    let unitCost = product.costPrice;\r\n\r\n    if (!isNumber(unitCost) && isNumber(product.lastPurchasePrice)) {\r\n      unitCost = product.lastPurchasePrice;\r\n    }\r\n\r\n    if (!isNumber(unitCost) && allowPriceFallback) {\r\n      if (fallbackPricingPolicyId && isNumber(product.prices?.[fallbackPricingPolicyId])) {\r\n        unitCost = product.prices![fallbackPricingPolicyId];\r\n      }\r\n\r\n      if (!isNumber(unitCost)) {\r\n        const firstPrice = Object.values(product.prices || {}).find((price): price is number => isNumber(price));\r\n        if (isNumber(firstPrice)) {\r\n          unitCost = firstPrice;\r\n        }\r\n      }\r\n    }\r\n\r\n    if (!isNumber(unitCost) && isNumber(product.minPrice)) {\r\n      unitCost = product.minPrice;\r\n    }\r\n    \r\n    totalCost += (unitCost || 0) * item.quantity;\r\n  }\r\n  \r\n  return totalCost;\r\n}\r\n\r\n/**\r\n * Calculate combo last purchase price (sum of child products' last purchase prices)\r\n */\r\nexport function calculateComboLastPurchasePrice(\r\n  comboItems: ComboItem[],\r\n  allProducts: Product[]\r\n): number {\r\n  let total = 0;\r\n  \r\n  for (const item of comboItems) {\r\n    const product = allProducts.find(p => p.systemId === item.productSystemId);\r\n    if (!product) continue;\r\n    \r\n    total += (product.lastPurchasePrice || 0) * item.quantity;\r\n  }\r\n  \r\n  return total;\r\n}\r\n\r\n/**\r\n * Calculate combo min price (sum of child products' min prices)\r\n */\r\nexport function calculateComboMinPrice(\r\n  comboItems: ComboItem[],\r\n  allProducts: Product[]\r\n): number {\r\n  let total = 0;\r\n  \r\n  for (const item of comboItems) {\r\n    const product = allProducts.find(p => p.systemId === item.productSystemId);\r\n    if (!product) continue;\r\n    \r\n    total += (product.minPrice || 0) * item.quantity;\r\n  }\r\n  \r\n  return total;\r\n}\r\n\r\n/**\r\n * Calculate combo prices by policy (sum of child products' prices per policy)\r\n * This returns the RAW sum without any discount applied\r\n */\r\nexport function calculateComboPricesByPolicy(\r\n  comboItems: ComboItem[],\r\n  allProducts: Product[]\r\n): Record<string, number> {\r\n  const pricesByPolicy: Record<string, number> = {};\r\n  \r\n  for (const item of comboItems) {\r\n    const product = allProducts.find(p => p.systemId === item.productSystemId);\r\n    if (!product || !product.prices) continue;\r\n    \r\n    for (const [policyId, price] of Object.entries(product.prices)) {\r\n      if (!pricesByPolicy[policyId]) {\r\n        pricesByPolicy[policyId] = 0;\r\n      }\r\n      pricesByPolicy[policyId] += (price || 0) * item.quantity;\r\n    }\r\n  }\r\n  \r\n  return pricesByPolicy;\r\n}\r\n\r\n/**\r\n * Calculate final combo prices by policy with discount applied\r\n * This returns the actual selling prices for the combo\r\n * \r\n * @param comboItems - List of combo items\r\n * @param allProducts - All products to lookup prices\r\n * @param comboPricingType - How to calculate price\r\n * @param comboDiscount - Discount value (% or fixed amount or fixed price)\r\n * @param defaultPolicyId - Default selling policy ID (used for fixed pricing)\r\n * @returns Final combo prices by policy\r\n */\r\nexport function calculateFinalComboPricesByPolicy(\r\n  comboItems: ComboItem[],\r\n  allProducts: Product[],\r\n  comboPricingType: ComboPricingType,\r\n  comboDiscount: number = 0,\r\n  defaultPolicyId?: string\r\n): Record<string, number> {\r\n  // Get raw sum prices first\r\n  const rawPricesByPolicy = calculateComboPricesByPolicy(comboItems, allProducts);\r\n  const finalPricesByPolicy: Record<string, number> = {};\r\n  \r\n  if (comboPricingType === 'fixed') {\r\n    // For fixed pricing, only policies that exist on child products should be auto-filled.\r\n    for (const policyId of Object.keys(rawPricesByPolicy)) {\r\n      finalPricesByPolicy[policyId] = comboDiscount; // comboDiscount IS the price in fixed mode\r\n    }\r\n    return finalPricesByPolicy;\r\n  }\r\n  \r\n  // For discount-based pricing, apply discount to each policy's sum\r\n  for (const [policyId, sumPrice] of Object.entries(rawPricesByPolicy)) {\r\n    if (comboPricingType === 'sum_discount_percent') {\r\n      const discountAmount = sumPrice * (comboDiscount / 100);\r\n      finalPricesByPolicy[policyId] = Math.round(sumPrice - discountAmount);\r\n    } else if (comboPricingType === 'sum_discount_amount') {\r\n      finalPricesByPolicy[policyId] = Math.max(0, sumPrice - comboDiscount);\r\n    } else {\r\n      // No discount, use raw sum\r\n      finalPricesByPolicy[policyId] = sumPrice;\r\n    }\r\n  }\r\n  \r\n  return finalPricesByPolicy;\r\n}\r\n\r\n/**\r\n * Get summary text for combo (e.g., \"3 sản phẩm, tồn kho: 15\")\r\n */\r\nexport function getComboSummary(\r\n  comboItems: ComboItem[],\r\n  allProducts: Product[],\r\n  branchSystemId?: SystemId\r\n): string {\r\n  const itemCount = comboItems?.length || 0;\r\n  \r\n  if (!branchSystemId) {\r\n    return `${itemCount} sản phẩm`;\r\n  }\r\n  \r\n  const stock = calculateComboStock(comboItems, allProducts, branchSystemId);\r\n  return `${itemCount} sản phẩm, tồn kho: ${stock}`;\r\n}\r\n\r\n/**\r\n * Check if combo has sufficient stock for a quantity\r\n */\r\nexport function hasComboStock(\r\n  comboItems: ComboItem[],\r\n  allProducts: Product[],\r\n  branchSystemId: SystemId,\r\n  requiredQuantity: number\r\n): boolean {\r\n  const available = calculateComboStock(comboItems, allProducts, branchSystemId);\r\n  return available >= requiredQuantity;\r\n}\r\n\r\n/**\r\n * Get the limiting product(s) for combo stock\r\n * Returns the product(s) that have the lowest available combo quantity\r\n */\r\nexport function getComboBottleneckProducts(\r\n  comboItems: ComboItem[],\r\n  allProducts: Product[],\r\n  branchSystemId: SystemId\r\n): Array<{ product: Product; availableForCombo: number; itemQuantity: number }> {\r\n  if (!comboItems || comboItems.length === 0) return [];\r\n  \r\n  const comboStock = calculateComboStock(comboItems, allProducts, branchSystemId);\r\n  const bottlenecks: Array<{ product: Product; availableForCombo: number; itemQuantity: number }> = [];\r\n  \r\n  for (const item of comboItems) {\r\n    const product = allProducts.find(p => p.systemId === item.productSystemId);\r\n    if (!product) continue;\r\n    \r\n    const onHand = product.inventoryByBranch?.[branchSystemId] || 0;\r\n    const committed = product.committedByBranch?.[branchSystemId] || 0;\r\n    const available = onHand - committed;\r\n    const comboQuantityFromThisProduct = Math.floor(available / item.quantity);\r\n    \r\n    // This product is a bottleneck if it limits the combo quantity\r\n    if (comboQuantityFromThisProduct === comboStock) {\r\n      bottlenecks.push({\r\n        product,\r\n        availableForCombo: comboQuantityFromThisProduct,\r\n        itemQuantity: item.quantity,\r\n      });\r\n    }\r\n  }\r\n  \r\n  return bottlenecks;\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 4295, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/stock-history/store.ts"],"sourcesContent":["import { create } from 'zustand';\r\nimport { formatDate, formatDateTime, formatDateTimeSeconds, formatDateCustom, parseDate, getCurrentDate } from '@/lib/date-utils';\r\nimport type { StockHistoryEntry } from './types';\r\nimport { asSystemId } from '../../lib/id-types';\r\nimport type { SystemId } from '../../lib/id-types';\r\n// REMOVED: import { data as initialData } from './data'; // Mock data no longer used - database is source of truth\r\n\r\n// API sync helpers\r\nasync function syncToAPI(action: 'create', data: any): Promise<boolean> {\r\n  try {\r\n    const response = await fetch('/api/inventory/stock-history', {\r\n      method: 'POST',\r\n      headers: { 'Content-Type': 'application/json' },\r\n      body: JSON.stringify(data),\r\n    });\r\n    \r\n    if (!response.ok) {\r\n      console.error(`[StockHistory API] ${action} failed:`, await response.text());\r\n      return false;\r\n    }\r\n    return true;\r\n  } catch (error) {\r\n    console.error(`[StockHistory API] ${action} error:`, error);\r\n    return false;\r\n  }\r\n}\r\n\r\n// ✨ Migration helper: Convert SKU to systemId for old data\r\nfunction migrateHistoryData(entries: StockHistoryEntry[]): StockHistoryEntry[] {\r\n  // Map SKU → systemId from products\r\n  const skuToSystemId: Record<string, string> = {\r\n    'DV-WEB-01': 'SP00000001',\r\n    'DV-WEB-02': 'SP00000002',\r\n    'DV-WEB-03': 'SP00000003',\r\n    'DV-MKT-01': 'SP00000004',\r\n    'DV-MKT-02': 'SP00000005',\r\n    'DV-MKT-03': 'SP00000006',\r\n    'DV-SEO-01': 'SP00000007',\r\n    'DV-SEO-02': 'SP00000008',\r\n    'DV-IT-01': 'SP00000009',\r\n    'DV-DSN-01': 'SP00000010',\r\n    'SW-CRM-01': 'SP00000011',\r\n    'SW-ERP-01': 'SP00000012',\r\n    'SW-WIN-01': 'SP00000013',\r\n    'SW-OFF-01': 'SP00000014',\r\n    'SW-ADOBE-01': 'SP00000015',\r\n    'HW-SRV-01': 'SP00000016',\r\n    'HW-SRV-02': 'SP00000017',\r\n    'HW-PC-01': 'SP00000018',\r\n    'HW-PC-02': 'SP00000019',\r\n    'HW-LT-01': 'SP00000020',\r\n    'HW-NET-01': 'SP00000021',\r\n    'HW-NET-02': 'SP00000022',\r\n    'HW-CAM-01': 'SP00000023',\r\n    'MISC-HOST-01': 'SP00000024',\r\n    'MISC-HOST-02': 'SP00000025',\r\n    'MISC-SSL-01': 'SP00000026',\r\n    'MISC-DOMAIN-COM': 'SP00000027',\r\n    'MISC-DOMAIN-VN': 'SP00000028',\r\n    'MISC-PRINT-01': 'SP00000029',\r\n    'MISC-PRINT-02': 'SP00000030',\r\n  };\r\n  \r\n  return entries.map(entry => ({\r\n    ...entry,\r\n    productId: asSystemId(skuToSystemId[entry.productId as any] || entry.productId) // Convert or keep if already systemId\r\n  }));\r\n}\r\n\r\ninterface StockHistoryState {\r\n  entries: StockHistoryEntry[];\r\n  initialized: boolean;\r\n  addEntry: (entry: Omit<StockHistoryEntry, 'systemId'>) => void;\r\n  getHistoryForProduct: (productId: SystemId, branchSystemId?: 'all' | SystemId) => StockHistoryEntry[];\r\n  loadFromAPI: () => Promise<void>;\r\n}\r\n\r\nlet entryCounter = 0;\r\n\r\nexport const useStockHistoryStore = create<StockHistoryState>()(\r\n  (set, get) => ({\r\n      entries: [], // Database is source of truth\r\n      initialized: false,\r\n      \r\n      addEntry: (entry) => {\r\n        entryCounter++;\r\n        const newEntry: StockHistoryEntry = {\r\n            ...entry,\r\n            systemId: asSystemId(`HISTORY${String(Date.now()).slice(-6)}_${entryCounter}`),\r\n        };\r\n        set((state) => ({ entries: [...state.entries, newEntry] }));\r\n        // Sync to API\r\n        syncToAPI('create', newEntry).catch(console.error);\r\n      },\r\n      \r\n      getHistoryForProduct: (productId, branchSystemId = 'all') => {\r\n          const productHistory = get().entries.filter(e => e.productId === productId);\r\n          const sortedHistory = productHistory.sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime());\r\n\r\n          if (branchSystemId === 'all') {\r\n            return sortedHistory;\r\n          }\r\n          return sortedHistory.filter(e => e.branchSystemId === branchSystemId);\r\n        },\r\n      \r\n      loadFromAPI: async () => {\r\n        try {\r\n          // NOTE: Use React Query hooks for paginated data. This only loads initial batch.\r\n          const response = await fetch('/api/inventory/stock-history?limit=30');\r\n          if (!response.ok) return;\r\n          const json = await response.json();\r\n          const apiData = json.data || [];\r\n          if (apiData.length > 0) {\r\n            set({ entries: migrateHistoryData(apiData), initialized: true });\r\n          } else {\r\n            set({ initialized: true });\r\n          }\r\n        } catch (error) {\r\n          console.error('[StockHistory API] loadFromAPI error:', error);\r\n        }\r\n      },\r\n    })\r\n);\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 4420, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/cashbook/store.ts"],"sourcesContent":["import { create } from 'zustand';\r\n// REMOVED: import { data as initialData } from './data'; // Mock data no longer used - database is source of truth\r\nimport type { CashAccount } from './types';\r\nimport { findNextAvailableBusinessId, generateSystemId, getMaxBusinessIdCounter, getMaxSystemIdCounter, type EntityType } from '../../lib/id-utils';\r\nimport { asBusinessId, asSystemId, type BusinessId, type SystemId } from '../../lib/id-types';\r\n\r\nconst CASH_ACCOUNT_ENTITY: EntityType = 'cash-accounts';\r\nconst SYSTEM_ID_PREFIX = 'ACCOUNT';\r\nconst BUSINESS_ID_PREFIX = 'TK';\r\nconst BUSINESS_ID_DIGITS = 6;\r\n\r\n// API sync helpers\r\nasync function syncToAPI(action: 'create' | 'update' | 'delete', data: any): Promise<boolean> {\r\n  try {\r\n    const endpoint = action === 'create' ? '/api/cash-accounts' : `/api/cash-accounts/${data.systemId}`;\r\n    const method = action === 'create' ? 'POST' : action === 'update' ? 'PATCH' : 'DELETE';\r\n    \r\n    const response = await fetch(endpoint, {\r\n      method,\r\n      headers: { 'Content-Type': 'application/json' },\r\n      body: action !== 'delete' ? JSON.stringify(data) : undefined,\r\n    });\r\n    \r\n    if (!response.ok) {\r\n      console.error(`[Cashbook API] ${action} failed:`, await response.text());\r\n      return false;\r\n    }\r\n    return true;\r\n  } catch (error) {\r\n    console.error(`[Cashbook API] ${action} error:`, error);\r\n    return false;\r\n  }\r\n}\r\n\r\nasync function fetchFromAPI(): Promise<CashAccount[]> {\r\n  try {\r\n    const response = await fetch('/api/cash-accounts?limit=50');\r\n    if (!response.ok) return [];\r\n    const json = await response.json();\r\n    return json.data || [];\r\n  } catch (error) {\r\n    console.error('[Cashbook API] fetch error:', error);\r\n    return [];\r\n  }\r\n}\r\n\r\ninterface CashbookState {\r\n  accounts: CashAccount[];\r\n  initialized: boolean;\r\n  getAccountById: (id: BusinessId) => CashAccount | undefined;\r\n  add: (item: Omit<CashAccount, 'systemId'>) => void;\r\n  update: (systemId: SystemId, item: CashAccount) => void;\r\n  remove: (systemId: SystemId) => void;\r\n  setDefault: (systemId: SystemId) => void;\r\n  loadFromAPI: () => Promise<void>;\r\n}\r\n\r\nconst getNextSystemId = (accounts: CashAccount[]): SystemId => {\r\n  const currentCounter = getMaxSystemIdCounter(accounts, SYSTEM_ID_PREFIX);\r\n  return asSystemId(generateSystemId(CASH_ACCOUNT_ENTITY, currentCounter + 1));\r\n};\r\n\r\nconst ensureBusinessId = (accounts: CashAccount[], provided?: BusinessId): BusinessId => {\r\n  if (provided && provided.trim()) {\r\n    return provided;\r\n  }\r\n\r\n  const existingIds = accounts.map(acc => acc.id as string);\r\n  const startCounter = getMaxBusinessIdCounter(accounts, BUSINESS_ID_PREFIX);\r\n  const { nextId } = findNextAvailableBusinessId(BUSINESS_ID_PREFIX, existingIds, startCounter, BUSINESS_ID_DIGITS);\r\n  return asBusinessId(nextId);\r\n};\r\n\r\nexport const useCashbookStore = create<CashbookState>()(\r\n  (set, get) => ({\r\n      accounts: [],\r\n      initialized: false,\r\n      getAccountById: (id) => get().accounts.find(a => a.id === id),\r\n      \r\n      add: (item) => {\r\n        const newAccount: CashAccount = {\r\n          ...item,\r\n          systemId: getNextSystemId(get().accounts),\r\n          id: ensureBusinessId(get().accounts, item.id),\r\n        };\r\n        set((state) => ({ accounts: [...state.accounts, newAccount] }));\r\n        // Sync to API\r\n        syncToAPI('create', newAccount).catch(console.error);\r\n      },\r\n      \r\n      update: (systemId, updatedItem) => {\r\n        set((state) => ({\r\n          accounts: state.accounts.map((acc) => (acc.systemId === systemId ? updatedItem : acc))\r\n        }));\r\n        // Sync to API\r\n        syncToAPI('update', updatedItem).catch(console.error);\r\n      },\r\n      \r\n      remove: (systemId) => {\r\n        set((state) => ({\r\n          accounts: state.accounts.filter(acc => acc.systemId !== systemId)\r\n        }));\r\n        // Sync to API\r\n        syncToAPI('delete', { systemId }).catch(console.error);\r\n      },\r\n      \r\n      setDefault: (systemId) => {\r\n        set((state) => {\r\n          const targetAccount = state.accounts.find(acc => acc.systemId === systemId);\r\n          if (!targetAccount) return state;\r\n\r\n          const updated = state.accounts.map(acc => ({\r\n            ...acc,\r\n            isDefault: (acc.type === targetAccount.type ? acc.systemId === systemId : acc.isDefault) ?? false\r\n          }));\r\n          \r\n          // Sync updated accounts to API\r\n          updated.forEach(acc => {\r\n            if (acc.type === targetAccount.type) {\r\n              syncToAPI('update', acc).catch(console.error);\r\n            }\r\n          });\r\n          \r\n          return { accounts: updated };\r\n        });\r\n      },\r\n      \r\n      loadFromAPI: async () => {\r\n        const apiData = await fetchFromAPI();\r\n        if (apiData.length > 0) {\r\n          set({ accounts: apiData, initialized: true });\r\n        } else {\r\n          set({ initialized: true });\r\n        }\r\n      },\r\n    })\r\n);\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 4555, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/finance/document-lookups.ts"],"sourcesContent":["import { useTargetGroupStore } from '@/features/settings/target-groups/store';\r\nimport { usePaymentMethodStore } from '@/features/settings/payments/methods/store';\r\nimport { useCashbookStore } from '@/features/cashbook/store';\r\nimport { useReceiptTypeStore } from '@/features/settings/receipt-types/store';\r\nimport { usePaymentTypeStore } from '@/features/settings/payments/types/store';\r\nimport type { TargetGroup } from '@/features/settings/target-groups/types';\r\nimport type { PaymentMethod } from '@/features/settings/payments/methods/types';\r\nimport type { CashAccount } from '@/features/cashbook/types';\r\nimport type { ReceiptType } from '@/features/settings/receipt-types/types';\r\nimport type { PaymentType } from '@/features/settings/payments/types/types';\r\nimport type { SystemId } from '@/lib/id-types';\r\n\r\nconst normalizeName = (value?: string | null) => (value ?? '').trim().toLowerCase();\r\n\r\nexport const DEFAULT_CUSTOMER_GROUP = 'khách hàng';\r\n\r\nexport const pickTargetGroup = (options?: {\r\n  systemId?: SystemId | undefined;\r\n  name?: string | undefined;\r\n  fallbackName?: string | undefined;\r\n}): TargetGroup | null => {\r\n  const groups = useTargetGroupStore.getState().data ?? [];\r\n  if (groups.length === 0) {\r\n    return null;\r\n  }\r\n\r\n  if (options?.systemId) {\r\n    const match = groups.find(group => group.systemId === options.systemId);\r\n    if (match) {\r\n      return match;\r\n    }\r\n  }\r\n\r\n  const lookupNames = [options?.name, options?.fallbackName, DEFAULT_CUSTOMER_GROUP].filter(Boolean) as string[];\r\n  for (const candidate of lookupNames) {\r\n    const normalized = normalizeName(candidate);\r\n    const match = groups.find(group => normalizeName(group.name) === normalized);\r\n    if (match) {\r\n      return match;\r\n    }\r\n  }\r\n\r\n  return groups[0] ?? null;\r\n};\r\n\r\nexport const pickPaymentMethod = (options?: {\r\n  systemId?: SystemId | undefined;\r\n  name?: string | undefined;\r\n}): PaymentMethod | null => {\r\n  const methods = usePaymentMethodStore.getState().data ?? [];\r\n  if (methods.length === 0) {\r\n    return null;\r\n  }\r\n\r\n  if (options?.systemId) {\r\n    const match = methods.find(method => method.systemId === options.systemId);\r\n    if (match) {\r\n      return match;\r\n    }\r\n  }\r\n\r\n  if (options?.name) {\r\n    const normalized = normalizeName(options.name);\r\n    const match = methods.find(method => normalizeName(method.name) === normalized);\r\n    if (match) {\r\n      return match;\r\n    }\r\n  }\r\n\r\n  return methods.find(method => method.isDefault) ?? methods[0] ?? null;\r\n};\r\n\r\nexport const pickAccount = (options: {\r\n  accountSystemId?: SystemId | undefined;\r\n  preferredType?: 'cash' | 'bank' | undefined;\r\n  branchSystemId?: SystemId | undefined;\r\n  paymentMethodName?: string | undefined;\r\n}): CashAccount | null => {\r\n  const { accounts } = useCashbookStore.getState();\r\n  if (!accounts || accounts.length === 0) {\r\n    return null;\r\n  }\r\n\r\n  if (options.accountSystemId) {\r\n    const match = accounts.find(account => account.systemId === options.accountSystemId);\r\n    if (match) {\r\n      return match;\r\n    }\r\n  }\r\n\r\n  let preferredType = options.preferredType;\r\n  if (!preferredType && options.paymentMethodName) {\r\n    const normalizedMethod = normalizeName(options.paymentMethodName);\r\n    preferredType = normalizedMethod === 'tiền mặt' ? 'cash' : normalizedMethod === 'chuyển khoản' ? 'bank' : undefined;\r\n  }\r\n\r\n  const candidates = preferredType ? accounts.filter(account => account.type === preferredType) : accounts;\r\n\r\n  if (candidates.length === 0) {\r\n    return accounts[0];\r\n  }\r\n\r\n  return (\r\n    candidates.find(account => account.branchSystemId && options.branchSystemId && account.branchSystemId === options.branchSystemId) ??\r\n    candidates.find(account => account.isDefault) ??\r\n    candidates[0]\r\n  );\r\n};\r\n\r\nexport const pickReceiptType = (options?: {\r\n  systemId?: SystemId | undefined;\r\n  name?: string | undefined;\r\n}): ReceiptType | null => {\r\n  const types = useReceiptTypeStore.getState().data ?? [];\r\n  if (types.length === 0) {\r\n    return null;\r\n  }\r\n\r\n  if (options?.systemId) {\r\n    const match = types.find(type => type.systemId === options.systemId);\r\n    if (match) {\r\n      return match;\r\n    }\r\n  }\r\n\r\n  if (options?.name) {\r\n    const normalized = normalizeName(options.name);\r\n    const match = types.find(type => normalizeName(type.name) === normalized);\r\n    if (match) {\r\n      return match;\r\n    }\r\n  }\r\n\r\n  return types[0] ?? null;\r\n};\r\n\r\nexport const pickPaymentType = (options?: {\r\n  systemId?: SystemId | undefined;\r\n  name?: string | undefined;\r\n}): PaymentType | null => {\r\n  const types = usePaymentTypeStore.getState().data ?? [];\r\n  if (types.length === 0) {\r\n    return null;\r\n  }\r\n\r\n  if (options?.systemId) {\r\n    const match = types.find(type => type.systemId === options.systemId);\r\n    if (match) {\r\n      return match;\r\n    }\r\n  }\r\n\r\n  if (options?.name) {\r\n    const normalized = normalizeName(options.name);\r\n    const match = types.find(type => normalizeName(type.name) === normalized);\r\n    if (match) {\r\n      return match;\r\n    }\r\n  }\r\n\r\n  return types[0] ?? null;\r\n};\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 4695, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/finance/document-helpers.ts"],"sourcesContent":["import { toISODateTime } from '@/lib/date-utils';\r\nimport { asBusinessId, type BusinessId, type SystemId } from '@/lib/id-types';\r\nimport { useReceiptStore, type ReceiptInput } from '@/features/receipts/store';\r\nimport type { Receipt } from '@/features/receipts/types';\r\nimport { usePaymentStore, type PaymentInput } from '@/features/payments/store';\r\nimport type { Payment } from '@/features/payments/types';\r\nimport { pickAccount, pickPaymentMethod, pickPaymentType, pickReceiptType, pickTargetGroup } from '@/features/finance/document-lookups';\r\n\r\nconst asBusinessIdOrUndefined = (value?: string | BusinessId | null) => {\r\n  if (!value) {\r\n    return undefined;\r\n  }\r\n  return typeof value === 'string' ? asBusinessId(value) : value;\r\n};\r\n\r\ninterface ReceiptDocumentOptions {\r\n  amount: number;\r\n  description: string;\r\n  customerName: string;\r\n  branchSystemId: SystemId;\r\n  branchName: string;\r\n  createdBy: SystemId;\r\n  customerSystemId?: SystemId;\r\n  paymentMethodSystemId?: SystemId;\r\n  paymentMethodName?: string;\r\n  accountSystemId?: SystemId;\r\n  accountPreference?: 'cash' | 'bank';\r\n  receiptTypeSystemId?: SystemId;\r\n  receiptTypeName?: string;\r\n  payerTargetGroupSystemId?: SystemId;\r\n  payerTargetGroupName?: string;\r\n  originalDocumentId?: string | BusinessId;\r\n  linkedOrderSystemId?: SystemId;\r\n  linkedSalesReturnSystemId?: SystemId;\r\n  linkedWarrantySystemId?: SystemId;\r\n  linkedComplaintSystemId?: SystemId;\r\n  category?: Receipt['category'];\r\n  affectsDebt?: boolean;\r\n  status?: Receipt['status'];\r\n  date?: string;\r\n}\r\n\r\ninterface PaymentDocumentOptions {\r\n  amount: number;\r\n  description: string;\r\n  recipientName: string;\r\n  branchSystemId: SystemId;\r\n  branchName: string;\r\n  createdBy: SystemId;\r\n  recipientSystemId?: SystemId;\r\n  customerSystemId?: SystemId;\r\n  customerName?: string;\r\n  paymentMethodSystemId?: SystemId;\r\n  paymentMethodName?: string;\r\n  accountSystemId?: SystemId;\r\n  accountPreference?: 'cash' | 'bank';\r\n  paymentTypeSystemId?: SystemId;\r\n  paymentTypeName?: string;\r\n  recipientTargetGroupSystemId?: SystemId;\r\n  recipientTargetGroupName?: string;\r\n  originalDocumentId?: string | BusinessId;\r\n  linkedOrderSystemId?: SystemId;\r\n  linkedSalesReturnSystemId?: SystemId;\r\n  linkedWarrantySystemId?: SystemId;\r\n  linkedComplaintSystemId?: SystemId;\r\n  category?: Payment['category'];\r\n  affectsDebt?: boolean;\r\n  status?: Payment['status'];\r\n  date?: string;\r\n}\r\n\r\nexport interface DocumentCreationResult<T> {\r\n  document: T | null;\r\n  error?: string;\r\n}\r\n\r\nexport const createReceiptDocument = (options: ReceiptDocumentOptions): DocumentCreationResult<Receipt> => {\r\n  if (!options.branchSystemId) {\r\n    return { document: null, error: 'Thiếu mã chi nhánh khi tạo phiếu thu.' };\r\n  }\r\n\r\n  const targetGroup = pickTargetGroup({\r\n    systemId: options.payerTargetGroupSystemId,\r\n    name: options.payerTargetGroupName,\r\n  });\r\n  if (!targetGroup) {\r\n    return { document: null, error: 'Chưa cấu hình nhóm đối tượng (Target Group) cho phiếu thu.' };\r\n  }\r\n\r\n  const paymentMethod = pickPaymentMethod({\r\n    systemId: options.paymentMethodSystemId,\r\n    name: options.paymentMethodName,\r\n  });\r\n  if (!paymentMethod) {\r\n    return { document: null, error: 'Chưa cấu hình phương thức thu tiền.' };\r\n  }\r\n\r\n  const account = pickAccount({\r\n    accountSystemId: options.accountSystemId,\r\n    preferredType: options.accountPreference,\r\n    branchSystemId: options.branchSystemId,\r\n    paymentMethodName: paymentMethod.name,\r\n  });\r\n  if (!account) {\r\n    return { document: null, error: 'Chưa cấu hình tài khoản quỹ phù hợp để tạo phiếu thu.' };\r\n  }\r\n\r\n  const receiptType = pickReceiptType({\r\n    systemId: options.receiptTypeSystemId,\r\n    name: options.receiptTypeName,\r\n  });\r\n  if (!receiptType) {\r\n    return { document: null, error: 'Chưa cấu hình loại phiếu thu.' };\r\n  }\r\n\r\n  const timestamp = options.date ?? toISODateTime(new Date());\r\n  const payload: ReceiptInput = {\r\n    date: timestamp,\r\n    amount: options.amount,\r\n    payerTypeSystemId: targetGroup.systemId,\r\n    payerTypeName: targetGroup.name,\r\n    payerName: options.customerName,\r\n    payerSystemId: options.customerSystemId,\r\n    description: options.description,\r\n    paymentMethodSystemId: paymentMethod.systemId,\r\n    paymentMethodName: paymentMethod.name,\r\n    accountSystemId: account.systemId,\r\n    paymentReceiptTypeSystemId: receiptType.systemId,\r\n    paymentReceiptTypeName: receiptType.name,\r\n    branchSystemId: options.branchSystemId,\r\n    branchName: options.branchName,\r\n    createdBy: options.createdBy,\r\n    createdAt: timestamp,\r\n    status: options.status ?? 'completed',\r\n    category: options.category,\r\n    originalDocumentId: asBusinessIdOrUndefined(options.originalDocumentId),\r\n    linkedOrderSystemId: options.linkedOrderSystemId,\r\n    linkedSalesReturnSystemId: options.linkedSalesReturnSystemId,\r\n    linkedWarrantySystemId: options.linkedWarrantySystemId,\r\n    linkedComplaintSystemId: options.linkedComplaintSystemId,\r\n    customerSystemId: options.customerSystemId,\r\n    customerName: options.customerName,\r\n    affectsDebt: options.affectsDebt ?? true,\r\n  };\r\n\r\n  const receipt = useReceiptStore.getState().add(payload);\r\n  return { document: receipt };\r\n};\r\n\r\nexport const createPaymentDocument = (options: PaymentDocumentOptions): DocumentCreationResult<Payment> => {\r\n  if (!options.branchSystemId) {\r\n    return { document: null, error: 'Thiếu mã chi nhánh khi tạo phiếu chi.' };\r\n  }\r\n\r\n  const targetGroup = pickTargetGroup({\r\n    systemId: options.recipientTargetGroupSystemId,\r\n    name: options.recipientTargetGroupName,\r\n  });\r\n  if (!targetGroup) {\r\n    return { document: null, error: 'Chưa cấu hình nhóm đối tượng (Target Group) cho phiếu chi.' };\r\n  }\r\n\r\n  const paymentMethod = pickPaymentMethod({\r\n    systemId: options.paymentMethodSystemId,\r\n    name: options.paymentMethodName,\r\n  });\r\n  if (!paymentMethod) {\r\n    return { document: null, error: 'Chưa cấu hình phương thức chi tiền.' };\r\n  }\r\n\r\n  const account = pickAccount({\r\n    accountSystemId: options.accountSystemId,\r\n    preferredType: options.accountPreference,\r\n    branchSystemId: options.branchSystemId,\r\n    paymentMethodName: paymentMethod.name,\r\n  });\r\n  if (!account) {\r\n    return { document: null, error: 'Chưa cấu hình tài khoản quỹ phù hợp để tạo phiếu chi.' };\r\n  }\r\n\r\n  const paymentType = pickPaymentType({\r\n    systemId: options.paymentTypeSystemId,\r\n    name: options.paymentTypeName,\r\n  });\r\n  if (!paymentType) {\r\n    return { document: null, error: 'Chưa cấu hình loại phiếu chi.' };\r\n  }\r\n\r\n  const timestamp = options.date ?? toISODateTime(new Date());\r\n  const payload: PaymentInput = {\r\n    date: timestamp,\r\n    amount: options.amount,\r\n    recipientTypeSystemId: targetGroup.systemId,\r\n    recipientTypeName: targetGroup.name,\r\n    recipientName: options.recipientName,\r\n    recipientSystemId: options.recipientSystemId,\r\n    description: options.description,\r\n    paymentMethodSystemId: paymentMethod.systemId,\r\n    paymentMethodName: paymentMethod.name,\r\n    accountSystemId: account.systemId,\r\n    paymentReceiptTypeSystemId: paymentType.systemId,\r\n    paymentReceiptTypeName: paymentType.name,\r\n    branchSystemId: options.branchSystemId,\r\n    branchName: options.branchName,\r\n    createdBy: options.createdBy,\r\n    createdAt: timestamp,\r\n    status: options.status ?? 'completed',\r\n    category: options.category,\r\n    originalDocumentId: asBusinessIdOrUndefined(options.originalDocumentId),\r\n    linkedOrderSystemId: options.linkedOrderSystemId,\r\n    linkedSalesReturnSystemId: options.linkedSalesReturnSystemId,\r\n    linkedWarrantySystemId: options.linkedWarrantySystemId,\r\n    linkedComplaintSystemId: options.linkedComplaintSystemId,\r\n    customerSystemId: options.customerSystemId,\r\n    customerName: options.customerName ?? options.recipientName,\r\n    affectsDebt: options.affectsDebt ?? true,\r\n  };\r\n\r\n  const payment = usePaymentStore.getState().add(payload);\r\n  return { document: payment };\r\n};\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 4890, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/receipts/store.ts"],"sourcesContent":["import { create } from 'zustand';\r\nimport { subscribeWithSelector } from 'zustand/middleware';\r\nimport type { Receipt } from './types';\r\nimport type { HistoryEntry } from '../../components/ActivityHistory';\r\nimport { \r\n  findNextAvailableBusinessId, \r\n  generateSystemId, \r\n  getMaxBusinessIdCounter, \r\n  getMaxSystemIdCounter,\r\n  extractCounterFromBusinessId,\r\n  type EntityType \r\n} from '@/lib/id-utils';\r\nimport { asSystemId, asBusinessId, type BusinessId, type SystemId } from '@/lib/id-types';\r\n// REMOVED: import { data as initialData } from './data'; // Mock data no longer used - database is source of truth\r\nimport { pickAccount, pickPaymentMethod, pickReceiptType, pickTargetGroup } from '@/features/finance/document-lookups';\r\nimport { useEmployeeStore } from '../employees/store';\r\nimport { getCurrentUserSystemId } from '../../contexts/auth-context';\r\n\r\n// API sync helpers\r\nasync function syncToAPI(action: 'create' | 'update' | 'delete', data: any): Promise<boolean> {\r\n  try {\r\n    const endpoint = action === 'create' ? '/api/receipts' : `/api/receipts/${data.systemId}`;\r\n    const method = action === 'create' ? 'POST' : action === 'update' ? 'PATCH' : 'DELETE';\r\n    \r\n    const response = await fetch(endpoint, {\r\n      method,\r\n      headers: { 'Content-Type': 'application/json' },\r\n      body: action !== 'delete' ? JSON.stringify(data) : undefined,\r\n    });\r\n    \r\n    if (!response.ok) {\r\n      console.error(`[Receipts API] ${action} failed:`, await response.text());\r\n      return false;\r\n    }\r\n    return true;\r\n  } catch (error) {\r\n    console.error(`[Receipts API] ${action} error:`, error);\r\n    return false;\r\n  }\r\n}\r\n\r\n// Helper to get current user info\r\nconst getCurrentUserInfo = () => {\r\n  const currentUserSystemId = getCurrentUserSystemId?.() || 'SYSTEM';\r\n  const employee = useEmployeeStore.getState().data.find(e => e.systemId === currentUserSystemId);\r\n  return {\r\n    systemId: currentUserSystemId,\r\n    name: employee?.fullName || 'Hệ thống',\r\n    avatar: employee?.avatarUrl,\r\n  };\r\n};\r\n\r\n// Helper to create history entry\r\nconst createHistoryEntry = (\r\n  action: HistoryEntry['action'],\r\n  description: string,\r\n  metadata?: HistoryEntry['metadata']\r\n): HistoryEntry => ({\r\n  id: crypto.randomUUID(),\r\n  action,\r\n  timestamp: new Date(),\r\n  user: getCurrentUserInfo(),\r\n  description,\r\n  metadata,\r\n});\r\n\r\nconst SYSTEM_AUTHOR = asSystemId('SYSTEM');\r\nconst getCurrentReceiptAuthor = (): SystemId => {\r\n  const userId = getCurrentUserSystemId?.();\r\n  return userId ? asSystemId(userId) : SYSTEM_AUTHOR;\r\n};\r\n\r\nexport type ReceiptInput = Omit<Receipt, 'systemId' | 'id'> & { id?: BusinessId };\r\n\r\ninterface ReceiptStore {\r\n  data: Receipt[];\r\n  businessIdCounter: number;\r\n  systemIdCounter: number;\r\n  initialized: boolean;\r\n  add: (item: ReceiptInput) => Receipt;\r\n  addMultiple: (items: ReceiptInput[]) => void;\r\n  update: (systemId: SystemId, item: Receipt) => void;\r\n  remove: (systemId: SystemId) => void;\r\n  findById: (systemId: SystemId) => Receipt | undefined;\r\n  getActive: () => Receipt[];\r\n  cancel: (systemId: SystemId, reason?: string) => void;\r\n  loadFromAPI: () => Promise<void>;\r\n}\r\n\r\nconst RECEIPT_ENTITY: EntityType = 'receipts';\r\nconst SYSTEM_ID_PREFIX = 'RECEIPT';\r\nconst BUSINESS_ID_PREFIX = 'PT';\r\nconst BUSINESS_ID_DIGITS = 6;\r\n\r\nconst normalizeReceiptStatus = (status?: Receipt['status']): Receipt['status'] =>\r\n  status === 'cancelled' ? 'cancelled' : 'completed';\r\n\r\nconst ensureReceiptMetadata = (receipt: Receipt): Receipt => {\r\n  let mutated = false;\r\n  const updates: Partial<Receipt> = {};\r\n\r\n  const targetGroup = pickTargetGroup({\r\n    systemId: receipt.payerTypeSystemId,\r\n    name: receipt.payerTypeName,\r\n  });\r\n  if (targetGroup) {\r\n    if (receipt.payerTypeSystemId !== targetGroup.systemId) {\r\n      updates.payerTypeSystemId = targetGroup.systemId;\r\n      mutated = true;\r\n    }\r\n    if (receipt.payerTypeName !== targetGroup.name) {\r\n      updates.payerTypeName = targetGroup.name;\r\n      mutated = true;\r\n    }\r\n  }\r\n\r\n  const paymentMethod = pickPaymentMethod({\r\n    systemId: receipt.paymentMethodSystemId,\r\n    name: receipt.paymentMethodName,\r\n  });\r\n  if (paymentMethod) {\r\n    if (receipt.paymentMethodSystemId !== paymentMethod.systemId) {\r\n      updates.paymentMethodSystemId = paymentMethod.systemId;\r\n      mutated = true;\r\n    }\r\n    if (receipt.paymentMethodName !== paymentMethod.name) {\r\n      updates.paymentMethodName = paymentMethod.name;\r\n      mutated = true;\r\n    }\r\n  }\r\n\r\n  const account = pickAccount({\r\n    accountSystemId: receipt.accountSystemId,\r\n    branchSystemId: receipt.branchSystemId,\r\n    paymentMethodName: paymentMethod?.name ?? receipt.paymentMethodName,\r\n  });\r\n  if (account && receipt.accountSystemId !== account.systemId) {\r\n    updates.accountSystemId = account.systemId;\r\n    mutated = true;\r\n  }\r\n\r\n  const receiptType = pickReceiptType({\r\n    systemId: receipt.paymentReceiptTypeSystemId,\r\n    name: receipt.paymentReceiptTypeName,\r\n  });\r\n  if (receiptType) {\r\n    if (receipt.paymentReceiptTypeSystemId !== receiptType.systemId) {\r\n      updates.paymentReceiptTypeSystemId = receiptType.systemId;\r\n      mutated = true;\r\n    }\r\n    if (receipt.paymentReceiptTypeName !== receiptType.name) {\r\n      updates.paymentReceiptTypeName = receiptType.name;\r\n      mutated = true;\r\n    }\r\n  }\r\n\r\n  if (!receipt.customerName && receipt.payerName) {\r\n    updates.customerName = receipt.payerName;\r\n    mutated = true;\r\n  }\r\n\r\n  if (!receipt.customerSystemId && receipt.payerSystemId) {\r\n    updates.customerSystemId = receipt.payerSystemId;\r\n    mutated = true;\r\n  }\r\n\r\n  return mutated ? { ...receipt, ...updates } : receipt;\r\n};\r\n\r\nconst backfillReceiptMetadata = (receipts: Receipt[]): Receipt[] => {\r\n  let mutated = false;\r\n  const updated = receipts.map(receipt => {\r\n    const normalized = ensureReceiptMetadata(receipt);\r\n    if (normalized !== receipt) {\r\n      mutated = true;\r\n    }\r\n    return normalized;\r\n  });\r\n  return mutated ? updated : receipts;\r\n};\r\n\r\nconst initialReceipts: Receipt[] = []; // Database is source of truth\r\n\r\nlet systemIdCounter = getMaxSystemIdCounter(initialReceipts, SYSTEM_ID_PREFIX);\r\nlet businessIdCounter = getMaxBusinessIdCounter(initialReceipts, BUSINESS_ID_PREFIX);\r\n\r\nconst getNextSystemId = (): SystemId => {\r\n  systemIdCounter += 1;\r\n  return asSystemId(generateSystemId(RECEIPT_ENTITY, systemIdCounter));\r\n};\r\n\r\nconst ensureReceiptBusinessId = (receipts: Receipt[], provided?: BusinessId | string): BusinessId => {\r\n  if (provided && `${provided}`.trim().length > 0) {\r\n    const normalized = `${provided}`.trim().toUpperCase();\r\n    const parsedCounter = extractCounterFromBusinessId(normalized, BUSINESS_ID_PREFIX);\r\n    if (parsedCounter > businessIdCounter) {\r\n      businessIdCounter = parsedCounter;\r\n    }\r\n    return asBusinessId(normalized);\r\n  }\r\n\r\n  const existingIds = receipts.map(receipt => receipt.id as string).filter(Boolean);\r\n  const { nextId, updatedCounter } = findNextAvailableBusinessId(\r\n    BUSINESS_ID_PREFIX,\r\n    existingIds,\r\n    businessIdCounter,\r\n    BUSINESS_ID_DIGITS\r\n  );\r\n  businessIdCounter = updatedCounter;\r\n  return asBusinessId(nextId);\r\n};\r\n\r\nexport const useReceiptStore = create<ReceiptStore>()(\r\n  subscribeWithSelector(\r\n    (set, get) => ({\r\n      data: initialReceipts,\r\n      businessIdCounter,\r\n      systemIdCounter,\r\n      initialized: false,\r\n      \r\n      add: (item: ReceiptInput): Receipt => {\r\n        let createdReceipt: Receipt | null = null;\r\n        set(state => {\r\n          const systemId = getNextSystemId();\r\n          const id = ensureReceiptBusinessId(state.data, item.id);\r\n          const createdBy = item.createdBy ?? getCurrentReceiptAuthor();\r\n          \r\n          const newReceipt: Receipt = { \r\n            ...item, \r\n            systemId, \r\n            id,\r\n            createdBy,\r\n            createdAt: item.createdAt || new Date().toISOString(),\r\n            status: normalizeReceiptStatus(item.status),\r\n            orderAllocations: item.orderAllocations ?? [],\r\n          };\r\n\r\n          const normalizedReceipt = ensureReceiptMetadata(newReceipt);\r\n          createdReceipt = normalizedReceipt;\r\n\r\n          return { \r\n            data: [...state.data, normalizedReceipt],\r\n            businessIdCounter,\r\n            systemIdCounter\r\n          };\r\n        });\r\n        // Sync to API\r\n        if (createdReceipt) {\r\n          syncToAPI('create', createdReceipt).catch(console.error);\r\n        }\r\n        return createdReceipt!;\r\n      },\r\n      \r\n      addMultiple: (items: ReceiptInput[]) => {\r\n        const created: Receipt[] = [];\r\n        set(state => {\r\n          items.forEach(item => {\r\n            const context = [...state.data, ...created];\r\n            const systemId = getNextSystemId();\r\n            const id = ensureReceiptBusinessId(context, item.id);\r\n            const createdBy = item.createdBy ?? getCurrentReceiptAuthor();\r\n            \r\n            const newReceipt: Receipt = { \r\n              ...item, \r\n              systemId, \r\n              id,\r\n              createdBy,\r\n              createdAt: item.createdAt || new Date().toISOString(),\r\n              status: normalizeReceiptStatus(item.status),\r\n              orderAllocations: item.orderAllocations ?? [],\r\n            };\r\n            created.push(ensureReceiptMetadata(newReceipt));\r\n          });\r\n          \r\n          return { \r\n            data: [...state.data, ...created],\r\n            businessIdCounter,\r\n            systemIdCounter\r\n          };\r\n        });\r\n        // Sync all to API\r\n        created.forEach(receipt => {\r\n          syncToAPI('create', receipt).catch(console.error);\r\n        });\r\n      },\r\n      \r\n      update: (systemId: SystemId, item: Receipt) => {\r\n        const updated = { ...item, status: normalizeReceiptStatus(item.status), updatedAt: new Date().toISOString() };\r\n        set(state => ({\r\n          data: state.data.map(r => r.systemId === systemId ? updated : r),\r\n          businessIdCounter,\r\n          systemIdCounter\r\n        }));\r\n        // Sync to API\r\n        syncToAPI('update', updated).catch(console.error);\r\n      },\r\n      \r\n      remove: (systemId: SystemId) => {\r\n        set(state => ({\r\n          data: state.data.filter(r => r.systemId !== systemId),\r\n          businessIdCounter,\r\n          systemIdCounter\r\n        }));\r\n        // Sync to API\r\n        syncToAPI('delete', { systemId }).catch(console.error);\r\n      },\r\n      \r\n      findById: (systemId: SystemId) => {\r\n        return get().data.find(r => r.systemId === systemId);\r\n      },\r\n      \r\n      getActive: () => {\r\n        return get().data.filter(r => r.status !== 'cancelled');\r\n      },\r\n      \r\n      cancel: (systemId: SystemId, reason?: string) => {\r\n        const receipt = get().findById(systemId);\r\n        if (receipt && receipt.status !== 'cancelled') {\r\n          const historyEntry = createHistoryEntry(\r\n            'cancelled',\r\n            `Đã hủy phiếu thu${reason ? `: ${reason}` : ''}`,\r\n            { oldValue: 'Hoàn thành', newValue: 'Đã hủy', note: reason }\r\n          );\r\n          \r\n          get().update(systemId, {\r\n            ...receipt,\r\n            status: 'cancelled',\r\n            cancelledAt: new Date().toISOString(),\r\n            activityHistory: [...(receipt.activityHistory || []), historyEntry],\r\n          });\r\n        }\r\n      },\r\n      \r\n      loadFromAPI: async () => {\r\n        try {\r\n          // NOTE: Use React Query hooks for paginated data. This only loads initial batch.\r\n          const response = await fetch('/api/receipts?limit=30');\r\n          if (!response.ok) return;\r\n          const json = await response.json();\r\n          const apiData = json.data || [];\r\n          if (apiData.length > 0) {\r\n            const normalized = backfillReceiptMetadata(apiData.map((receipt: Receipt) => ({\r\n              ...receipt,\r\n              status: normalizeReceiptStatus(receipt.status),\r\n            })));\r\n            const nextSystemCounter = getMaxSystemIdCounter(normalized, SYSTEM_ID_PREFIX);\r\n            const nextBusinessCounter = getMaxBusinessIdCounter(normalized, BUSINESS_ID_PREFIX);\r\n            systemIdCounter = nextSystemCounter;\r\n            businessIdCounter = nextBusinessCounter;\r\n            set({ \r\n              data: normalized, \r\n              systemIdCounter, \r\n              businessIdCounter,\r\n              initialized: true \r\n            });\r\n          } else {\r\n            set({ initialized: true });\r\n          }\r\n        } catch (error) {\r\n          console.error('[Receipts API] loadFromAPI error:', error);\r\n        }\r\n      },\r\n    })\r\n  )\r\n);\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 5221, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/payments/store.ts"],"sourcesContent":["import { create } from 'zustand';\r\nimport type { Payment } from './types';\r\nimport type { HistoryEntry } from '../../components/ActivityHistory';\r\n// REMOVED: import { data as initialData } from './data'; // Mock data no longer used - database is source of truth\r\nimport {\r\n  extractCounterFromBusinessId,\r\n  findNextAvailableBusinessId,\r\n  generateSystemId,\r\n  getMaxBusinessIdCounter,\r\n  getMaxSystemIdCounter,\r\n  type EntityType,\r\n} from '../../lib/id-utils';\r\nimport { asBusinessId, asSystemId, type BusinessId, type SystemId } from '../../lib/id-types';\r\nimport { pickAccount, pickPaymentMethod, pickPaymentType, pickTargetGroup } from '@/features/finance/document-lookups';\r\nimport { useEmployeeStore } from '../employees/store';\r\nimport { getCurrentUserSystemId } from '../../contexts/auth-context';\r\n\r\n// API sync helpers\r\nasync function syncToAPI(action: 'create' | 'update' | 'delete', data: any): Promise<boolean> {\r\n  try {\r\n    const endpoint = action === 'create' ? '/api/payments' : `/api/payments/${data.systemId}`;\r\n    const method = action === 'create' ? 'POST' : action === 'update' ? 'PATCH' : 'DELETE';\r\n    \r\n    const response = await fetch(endpoint, {\r\n      method,\r\n      headers: { 'Content-Type': 'application/json' },\r\n      body: action !== 'delete' ? JSON.stringify(data) : undefined,\r\n    });\r\n    \r\n    if (!response.ok) {\r\n      console.error(`[Payments API] ${action} failed:`, await response.text());\r\n      return false;\r\n    }\r\n    return true;\r\n  } catch (error) {\r\n    console.error(`[Payments API] ${action} error:`, error);\r\n    return false;\r\n  }\r\n}\r\n\r\n// Helper to get current user info\r\nconst getCurrentUserInfo = () => {\r\n  const currentUserSystemId = getCurrentUserSystemId?.() || 'SYSTEM';\r\n  const employee = useEmployeeStore.getState().data.find(e => e.systemId === currentUserSystemId);\r\n  return {\r\n    systemId: currentUserSystemId,\r\n    name: employee?.fullName || 'Hệ thống',\r\n    avatar: employee?.avatarUrl,\r\n  };\r\n};\r\n\r\n// Helper to create history entry\r\nconst createHistoryEntry = (\r\n  action: HistoryEntry['action'],\r\n  description: string,\r\n  metadata?: HistoryEntry['metadata']\r\n): HistoryEntry => ({\r\n  id: crypto.randomUUID(),\r\n  action,\r\n  timestamp: new Date(),\r\n  user: getCurrentUserInfo(),\r\n  description,\r\n  metadata,\r\n});\r\n\r\nexport type PaymentInput = Omit<Payment, 'systemId' | 'id'> & { id?: BusinessId | string };\r\n\r\ninterface PaymentStore {\r\n  data: Payment[];\r\n  businessIdCounter: number;\r\n  systemIdCounter: number;\r\n  initialized: boolean;\r\n  add: (item: PaymentInput) => Payment;\r\n  addMultiple: (items: PaymentInput[]) => void;\r\n  update: (systemId: SystemId, item: Payment) => void;\r\n  remove: (systemId: SystemId) => void;\r\n  findById: (systemId: SystemId) => Payment | undefined;\r\n  getActive: () => Payment[];\r\n  cancel: (systemId: SystemId, reason?: string) => void;\r\n  loadFromAPI: () => Promise<void>;\r\n}\r\n\r\nconst PAYMENT_ENTITY: EntityType = 'payments';\r\nconst SYSTEM_ID_PREFIX = 'PAYMENT';\r\nconst BUSINESS_ID_PREFIX = 'PC';\r\nconst BUSINESS_ID_DIGITS = 6;\r\nconst PURCHASE_ORDER_SYSTEM_PREFIX = 'PURCHASE';\r\nconst PURCHASE_ORDER_BUSINESS_PREFIX = 'PO';\r\n\r\nconst normalizePaymentStatus = (status?: Payment['status']): Payment['status'] =>\r\n  status === 'cancelled' ? 'cancelled' : 'completed';\r\n\r\nconst normalizePayment = (payment: Payment): Payment => ({\r\n  ...payment,\r\n  status: normalizePaymentStatus(payment.status),\r\n});\r\n\r\nconst ensurePaymentMetadata = (payment: Payment): Payment => {\r\n  let mutated = false;\r\n  const updates: Partial<Payment> = {};\r\n\r\n  const targetGroup = pickTargetGroup({\r\n    systemId: payment.recipientTypeSystemId,\r\n    name: payment.recipientTypeName,\r\n  });\r\n  if (targetGroup) {\r\n    if (payment.recipientTypeSystemId !== targetGroup.systemId) {\r\n      updates.recipientTypeSystemId = targetGroup.systemId;\r\n      mutated = true;\r\n    }\r\n    if (payment.recipientTypeName !== targetGroup.name) {\r\n      updates.recipientTypeName = targetGroup.name;\r\n      mutated = true;\r\n    }\r\n  }\r\n\r\n  const paymentMethod = pickPaymentMethod({\r\n    systemId: payment.paymentMethodSystemId,\r\n    name: payment.paymentMethodName,\r\n  });\r\n  if (paymentMethod) {\r\n    if (payment.paymentMethodSystemId !== paymentMethod.systemId) {\r\n      updates.paymentMethodSystemId = paymentMethod.systemId;\r\n      mutated = true;\r\n    }\r\n    if (payment.paymentMethodName !== paymentMethod.name) {\r\n      updates.paymentMethodName = paymentMethod.name;\r\n      mutated = true;\r\n    }\r\n  }\r\n\r\n  const account = pickAccount({\r\n    accountSystemId: payment.accountSystemId,\r\n    branchSystemId: payment.branchSystemId,\r\n    paymentMethodName: paymentMethod?.name ?? payment.paymentMethodName,\r\n  });\r\n  if (account && payment.accountSystemId !== account.systemId) {\r\n    updates.accountSystemId = account.systemId;\r\n    mutated = true;\r\n  }\r\n\r\n  const paymentType = pickPaymentType({\r\n    systemId: payment.paymentReceiptTypeSystemId,\r\n    name: payment.paymentReceiptTypeName,\r\n  });\r\n  if (paymentType) {\r\n    if (payment.paymentReceiptTypeSystemId !== paymentType.systemId) {\r\n      updates.paymentReceiptTypeSystemId = paymentType.systemId;\r\n      mutated = true;\r\n    }\r\n    if (payment.paymentReceiptTypeName !== paymentType.name) {\r\n      updates.paymentReceiptTypeName = paymentType.name;\r\n      mutated = true;\r\n    }\r\n  }\r\n\r\n  const normalizedGroupName = targetGroup?.name?.trim().toLowerCase();\r\n  if (normalizedGroupName === 'khách hàng') {\r\n    if (!payment.customerName && payment.recipientName) {\r\n      updates.customerName = payment.recipientName;\r\n      mutated = true;\r\n    }\r\n    if (!payment.customerSystemId && payment.recipientSystemId) {\r\n      updates.customerSystemId = payment.recipientSystemId;\r\n      mutated = true;\r\n    }\r\n  }\r\n\r\n  return mutated ? { ...payment, ...updates } : payment;\r\n};\r\n\r\nconst backfillPaymentMetadata = (payments: Payment[]): Payment[] => {\r\n  let mutated = false;\r\n  const updated = payments.map(payment => {\r\n    const normalized = ensurePaymentMetadata(payment);\r\n    if (normalized !== payment) {\r\n      mutated = true;\r\n    }\r\n    return normalized;\r\n  });\r\n  return mutated ? updated : payments;\r\n};\r\n\r\nconst initialPayments: Payment[] = []; // Database is source of truth\r\n\r\nlet systemIdCounter = getMaxSystemIdCounter(initialPayments, SYSTEM_ID_PREFIX);\r\nlet businessIdCounter = getMaxBusinessIdCounter(initialPayments, BUSINESS_ID_PREFIX);\r\n\r\nconst getNextSystemId = (): SystemId => {\r\n  systemIdCounter += 1;\r\n  return asSystemId(generateSystemId(PAYMENT_ENTITY, systemIdCounter));\r\n};\r\n\r\nconst ensurePaymentBusinessId = (payments: Payment[], provided?: BusinessId | string): BusinessId => {\r\n  if (provided && `${provided}`.trim().length > 0) {\r\n    const normalized = `${provided}`.trim().toUpperCase();\r\n    const parsedCounter = extractCounterFromBusinessId(normalized, BUSINESS_ID_PREFIX);\r\n    if (parsedCounter > businessIdCounter) {\r\n      businessIdCounter = parsedCounter;\r\n    }\r\n    return asBusinessId(normalized);\r\n  }\r\n\r\n  const existingIds = payments.map(payment => payment.id as string).filter(Boolean);\r\n  const { nextId, updatedCounter } = findNextAvailableBusinessId(\r\n    BUSINESS_ID_PREFIX,\r\n    existingIds,\r\n    businessIdCounter,\r\n    BUSINESS_ID_DIGITS\r\n  );\r\n  businessIdCounter = updatedCounter;\r\n  return asBusinessId(nextId);\r\n};\r\n\r\nconst reconcileLinkedDocuments = (payment: Payment): Payment => {\r\n  if (!payment.originalDocumentId) {\r\n    return payment;\r\n  }\r\n\r\n  const normalizedDocId = payment.originalDocumentId.toUpperCase();\r\n  const nextPayment = { ...payment };\r\n\r\n  if (!nextPayment.purchaseOrderSystemId && normalizedDocId.startsWith(PURCHASE_ORDER_SYSTEM_PREFIX)) {\r\n    nextPayment.purchaseOrderSystemId = asSystemId(payment.originalDocumentId);\r\n  }\r\n\r\n  if (!nextPayment.purchaseOrderId && normalizedDocId.startsWith(PURCHASE_ORDER_BUSINESS_PREFIX)) {\r\n    nextPayment.purchaseOrderId = asBusinessId(payment.originalDocumentId);\r\n  }\r\n\r\n  return nextPayment;\r\n};\r\n\r\nconst buildPayment = (input: PaymentInput, existingPayments: Payment[]): Payment => {\r\n  const systemId = getNextSystemId();\r\n  const id = ensurePaymentBusinessId(existingPayments, input.id);\r\n  const basePayment: Payment = {\r\n    ...input,\r\n    systemId,\r\n    id,\r\n    createdAt: input.createdAt || new Date().toISOString(),\r\n    status: normalizePaymentStatus(input.status),\r\n  };\r\n\r\n  return reconcileLinkedDocuments(basePayment);\r\n};\r\n\r\nexport const usePaymentStore = create<PaymentStore>()(\r\n  (set, get) => ({\r\n      data: initialPayments,\r\n      businessIdCounter,\r\n      systemIdCounter,\r\n      initialized: false,\r\n      \r\n      add: (item) => {\r\n        let createdPayment: Payment | null = null;\r\n        set(state => {\r\n          const newPayment = buildPayment(item, state.data);\r\n          createdPayment = newPayment;\r\n          return {\r\n            data: [...state.data, newPayment],\r\n            businessIdCounter,\r\n            systemIdCounter,\r\n          };\r\n        });\r\n        // Sync to API\r\n        if (createdPayment) {\r\n          syncToAPI('create', createdPayment).catch(console.error);\r\n        }\r\n        return createdPayment!;\r\n      },\r\n      \r\n      addMultiple: (items) => {\r\n        const created: Payment[] = [];\r\n        set(state => {\r\n          items.forEach(item => {\r\n            const context = [...state.data, ...created];\r\n            const payment = buildPayment(item, context);\r\n            created.push(payment);\r\n          });\r\n\r\n          return {\r\n            data: [...state.data, ...created],\r\n            businessIdCounter,\r\n            systemIdCounter,\r\n          };\r\n        });\r\n        // Sync all to API\r\n        created.forEach(payment => {\r\n          syncToAPI('create', payment).catch(console.error);\r\n        });\r\n      },\r\n      \r\n      update: (systemId, item) => {\r\n        const updated = reconcileLinkedDocuments({\r\n          ...item,\r\n          systemId,\r\n          status: normalizePaymentStatus(item.status),\r\n          updatedAt: new Date().toISOString(),\r\n        });\r\n        set(state => ({\r\n          data: state.data.map(payment =>\r\n            payment.systemId === systemId ? updated : payment\r\n          ),\r\n          businessIdCounter,\r\n          systemIdCounter,\r\n        }));\r\n        // Sync to API\r\n        syncToAPI('update', updated).catch(console.error);\r\n      },\r\n      \r\n      remove: (systemId) => {\r\n        set(state => ({\r\n          data: state.data.filter(payment => payment.systemId !== systemId),\r\n          businessIdCounter,\r\n          systemIdCounter,\r\n        }));\r\n        // Sync to API\r\n        syncToAPI('delete', { systemId }).catch(console.error);\r\n      },\r\n      \r\n      findById: (systemId) => {\r\n        return get().data.find(payment => payment.systemId === systemId);\r\n      },\r\n      \r\n      getActive: () => {\r\n        return get().data.filter(payment => payment.status !== 'cancelled');\r\n      },\r\n      \r\n      cancel: (systemId: SystemId, reason?: string) => {\r\n        const payment = get().findById(systemId);\r\n        if (payment && payment.status !== 'cancelled') {\r\n          const historyEntry = createHistoryEntry(\r\n            'cancelled',\r\n            `Đã hủy phiếu chi${reason ? `: ${reason}` : ''}`,\r\n            { oldValue: 'Hoàn thành', newValue: 'Đã hủy', note: reason }\r\n          );\r\n          \r\n          get().update(systemId, {\r\n            ...payment,\r\n            status: 'cancelled',\r\n            cancelledAt: new Date().toISOString(),\r\n            activityHistory: [...(payment.activityHistory || []), historyEntry],\r\n          });\r\n        }\r\n      },\r\n      \r\n      loadFromAPI: async () => {\r\n        try {\r\n          // NOTE: Use React Query hooks for paginated data. This only loads initial batch.\r\n          const response = await fetch('/api/payments?limit=30');\r\n          if (!response.ok) return;\r\n          const json = await response.json();\r\n          const apiData = json.data || [];\r\n          if (apiData.length > 0) {\r\n            const normalized = backfillPaymentMetadata(apiData.map(normalizePayment));\r\n            const nextSystemCounter = getMaxSystemIdCounter(normalized, SYSTEM_ID_PREFIX);\r\n            const nextBusinessCounter = getMaxBusinessIdCounter(normalized, BUSINESS_ID_PREFIX);\r\n            systemIdCounter = nextSystemCounter;\r\n            businessIdCounter = nextBusinessCounter;\r\n            set({ \r\n              data: normalized, \r\n              systemIdCounter, \r\n              businessIdCounter,\r\n              initialized: true \r\n            });\r\n          } else {\r\n            set({ initialized: true });\r\n          }\r\n        } catch (error) {\r\n          console.error('[Payments API] loadFromAPI error:', error);\r\n        }\r\n      },\r\n    })\r\n);\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 5557, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/sales-returns/store.ts"],"sourcesContent":["import { formatDate, formatDateTime, formatDateTimeSeconds, formatDateCustom, parseDate, getCurrentDate } from '@/lib/date-utils';\r\nimport { createCrudStore } from '../../lib/store-factory';\r\nimport type { SalesReturn, ReturnLineItem } from './types';\r\n// REMOVED: import { data as initialData } from './data'; // Mock data no longer used - database is source of truth\r\nimport { GHTKService, type GHTKCreateOrderParams } from '../settings/shipping/integrations/ghtk-service';\r\nimport { loadShippingConfig } from '../../lib/utils/shipping-config-migration';\r\nimport { toast } from 'sonner';\r\n\r\n// Other stores\r\nimport { useOrderStore } from '../orders/store';\r\nimport { useProductStore } from '../products/store';\r\nimport { useStockHistoryStore } from '../stock-history/store';\r\nimport { useCustomerStore } from '../customers/store';\r\nimport { createPaymentDocument, createReceiptDocument } from '../finance/document-helpers';\r\nimport { useShippingPartnerStore } from '../settings/shipping/store';\r\nimport { asBusinessId, asSystemId, type SystemId } from '../../lib/id-types';\r\nimport { isComboProduct } from '../products/combo-utils';\r\nimport { generateSystemId, getMaxSystemIdCounter } from '../../lib/id-utils';\r\n\r\n/**\r\n * ✅ Helper: Expand combo return items to child products\r\n * When a combo is returned, we need to add stock back to child products\r\n */\r\nconst getReturnStockItems = (returnItems: ReturnLineItem[]) => {\r\n    const { findById } = useProductStore.getState();\r\n    const expandedItems: { productSystemId: SystemId; productName: string; quantity: number }[] = [];\r\n    \r\n    returnItems.forEach(item => {\r\n        const product = findById(item.productSystemId);\r\n        if (product && isComboProduct(product) && product.comboItems) {\r\n            // Combo → expand to child products\r\n            product.comboItems.forEach(comboItem => {\r\n                const childProduct = findById(comboItem.productSystemId);\r\n                expandedItems.push({\r\n                    productSystemId: comboItem.productSystemId,\r\n                    productName: childProduct?.name || 'SP không xác định',\r\n                    quantity: comboItem.quantity * item.returnQuantity\r\n                });\r\n            });\r\n        } else {\r\n            // Regular product\r\n            expandedItems.push({\r\n                productSystemId: asSystemId(item.productSystemId),\r\n                productName: item.productName,\r\n                quantity: item.returnQuantity\r\n            });\r\n        }\r\n    });\r\n    return expandedItems;\r\n};\r\n\r\nconst baseStore = createCrudStore<SalesReturn>([], 'sales-returns', {\r\n  apiEndpoint: '/api/sales-returns',\r\n});\r\n\r\nconst originalAdd = baseStore.getState().add;\r\n\r\nconst augmentedMethods = {\r\n  addWithSideEffects: (item: Omit<SalesReturn, 'systemId' | 'id'> & { creatorId: string }) => {\r\n    const orderSystemId = asSystemId(item.orderSystemId);\r\n    const orderBusinessId = asBusinessId(item.orderId);\r\n    const customerSystemId = asSystemId(item.customerSystemId);\r\n    const branchSystemId = asSystemId(item.branchSystemId);\r\n    const creatorSystemId = asSystemId(item.creatorSystemId ?? item.creatorId ?? 'SYSTEM');\r\n    const exchangeOrderSystemId = item.exchangeOrderSystemId ? asSystemId(item.exchangeOrderSystemId) : undefined;\r\n    const accountSystemId = item.accountSystemId ? asSystemId(item.accountSystemId) : undefined;\r\n    const paymentVoucherSystemId = item.paymentVoucherSystemId ? asSystemId(item.paymentVoucherSystemId) : undefined;\r\n    const paymentVoucherSystemIds = item.paymentVoucherSystemIds?.map(asSystemId);\r\n    const receiptVoucherSystemIds = item.receiptVoucherSystemIds?.map(asSystemId);\r\n\r\n    const formattedItems = item.items.map(lineItem => ({\r\n      ...lineItem,\r\n      productSystemId: asSystemId(lineItem.productSystemId),\r\n      productId: asBusinessId(lineItem.productId),\r\n    }));\r\n\r\n    const formattedPayments = item.payments?.map(payment => ({\r\n      ...payment,\r\n      accountSystemId: asSystemId(payment.accountSystemId),\r\n    }));\r\n\r\n    const formattedRefunds = item.refunds?.map(refund => ({\r\n      ...refund,\r\n      accountSystemId: asSystemId(refund.accountSystemId),\r\n    }));\r\n\r\n    const newItemData: Omit<SalesReturn, 'systemId'> = {\r\n      id: asBusinessId(''),\r\n      orderSystemId,\r\n      orderId: orderBusinessId,\r\n      customerSystemId,\r\n      customerName: item.customerName,\r\n      branchSystemId,\r\n      branchName: item.branchName,\r\n      returnDate: item.returnDate,\r\n      reason: item.reason,\r\n      note: item.note,\r\n      notes: item.notes,\r\n      reference: item.reference,\r\n      items: formattedItems,\r\n      totalReturnValue: item.totalReturnValue,\r\n      isReceived: item.isReceived,\r\n      exchangeItems: item.exchangeItems ?? [],\r\n      exchangeOrderSystemId,\r\n      subtotalNew: item.subtotalNew,\r\n      shippingFeeNew: item.shippingFeeNew,\r\n      discountNew: item.discountNew,\r\n      discountNewType: item.discountNewType,\r\n      grandTotalNew: item.grandTotalNew,\r\n      deliveryMethod: item.deliveryMethod,\r\n      shippingPartnerId: item.shippingPartnerId,\r\n      shippingServiceId: item.shippingServiceId,\r\n      shippingAddress: item.shippingAddress,\r\n      packageInfo: item.packageInfo,\r\n      configuration: item.configuration,\r\n      finalAmount: item.finalAmount,\r\n      refundMethod: item.refundMethod,\r\n      refundAmount: item.refundAmount,\r\n      accountSystemId,\r\n      refunds: formattedRefunds,\r\n      payments: formattedPayments,\r\n      paymentVoucherSystemId,\r\n      paymentVoucherSystemIds,\r\n      receiptVoucherSystemIds,\r\n      creatorSystemId,\r\n      creatorName: item.creatorName,\r\n    };\r\n\r\n    // --- Side Effects ---\r\n    const { update: updateOrder, findById: findOrderById, add: addOrder } = useOrderStore.getState();\r\n    const { updateInventory } = useProductStore.getState();\r\n    const { addEntry: addStockHistory } = useStockHistoryStore.getState();\r\n    const { updateDebt, incrementReturnStats } = useCustomerStore.getState();\r\n    const order = findOrderById(newItemData.orderSystemId);\r\n    if (!order) return { newReturn: null, newOrderSystemId: null };\r\n\r\n    // ✅ IMPORTANT: Create the return FIRST to get IDs for exchange order\r\n    const newReturn = originalAdd(newItemData);\r\n    if (!newReturn) return { newReturn: null, newOrderSystemId: null };\r\n\r\n    // ✅ Update customer return stats\r\n    const totalReturnQty = newItemData.items.reduce((sum, item) => sum + item.returnQuantity, 0);\r\n    if (totalReturnQty > 0) {\r\n        incrementReturnStats(newItemData.customerSystemId, totalReturnQty);\r\n    }\r\n\r\n    let newOrderSystemId: SystemId | undefined;\r\n\r\n    // Create a new sales order for the exchange items\r\n    if (newItemData.exchangeItems && newItemData.exchangeItems.length > 0) {\r\n        console.log('🔄 [Sales Return] Creating exchange order...', {\r\n        exchangeItems: newItemData.exchangeItems,\r\n        finalAmount: newItemData.finalAmount,\r\n        payments: newItemData.payments,\r\n        });\r\n        \r\n      // ✅ Calculate payments for exchange order based on sales return logic\r\n      const exchangeOrderPayments =\r\n        newItemData.finalAmount > 0 && newItemData.payments\r\n        ? newItemData.payments.map(p => ({\r\n          method: p.method,\r\n          accountSystemId: p.accountSystemId,\r\n          amount: p.amount,\r\n          }))\r\n        : [];\r\n        // If company refunded customer (finalAmount < 0)\r\n        // The exchange order will have COD = grandTotal (shipper collects on delivery)\r\n        // No payments array needed - will be handled by COD in shipping\r\n        \r\n        // ✅ Determine status and packagings based on delivery method\r\n        let finalMainStatus: 'Đặt hàng' | 'Đang giao dịch' = 'Đặt hàng';\r\n        let finalDeliveryStatus: string = 'Chờ đóng gói';\r\n        const packagings: any[] = [];\r\n        const now = formatDateCustom(getCurrentDate(), 'yyyy-MM-dd HH:mm');\r\n        \r\n        // ✅ Helper to get next packaging systemId\r\n        const PACKAGING_SYSTEM_ID_PREFIX = 'PACKAGE';\r\n        const allOrders = useOrderStore.getState().data;\r\n        const allPackagings = allOrders.flatMap(o => o.packagings || []);\r\n        const maxPackagingCounter = getMaxSystemIdCounter(allPackagings, PACKAGING_SYSTEM_ID_PREFIX);\r\n        let packagingCounter = maxPackagingCounter;\r\n        const getNextPackagingSystemId = () => {\r\n            packagingCounter++;\r\n            return asSystemId(generateSystemId('packaging', packagingCounter));\r\n        };\r\n        \r\n        // Check if using shipping partner or pickup\r\n      const isPickup = newItemData.deliveryMethod === 'pickup';\r\n      const isShippingPartner = newItemData.shippingPartnerId && newItemData.shippingServiceId;\r\n        \r\n        if (isPickup) {\r\n            // Nhận tại cửa hàng - Tạo packaging request ngay\r\n            finalMainStatus = 'Đang giao dịch';\r\n            finalDeliveryStatus = 'Chờ đóng gói';\r\n            packagings.push({\r\n                systemId: getNextPackagingSystemId(), // ✅ Use proper format PACKAGE000001\r\n                id: '',\r\n                requestDate: now,\r\n          requestingEmployeeId: creatorSystemId,\r\n          requestingEmployeeName: newItemData.creatorName,\r\n                status: 'Chờ đóng gói',\r\n                printStatus: 'Chưa in',\r\n                deliveryStatus: 'Chờ đóng gói',\r\n            });\r\n        } else if (isShippingPartner) {\r\n            // Đẩy qua hãng vận chuyển - Tạo packaging đã đóng gói với tracking\r\n            finalMainStatus = 'Đang giao dịch';\r\n            finalDeliveryStatus = 'Chờ lấy hàng';\r\n            \r\n            // Get partner info\r\n            const { data: partners } = useShippingPartnerStore.getState();\r\n            const partner = partners.find(p => p.systemId === newItemData.shippingPartnerId);\r\n            const service = partner?.services.find(s => s.id === newItemData.shippingServiceId);\r\n            \r\n            packagings.push({\r\n                systemId: getNextPackagingSystemId(), // ✅ Use proper format PACKAGE000001\r\n                id: '',\r\n                requestDate: now,\r\n                confirmDate: now,\r\n              requestingEmployeeId: creatorSystemId,\r\n              requestingEmployeeName: newItemData.creatorName,\r\n              confirmingEmployeeId: creatorSystemId,\r\n              confirmingEmployeeName: newItemData.creatorName,\r\n                status: 'Đã đóng gói',\r\n                deliveryStatus: 'Chờ lấy hàng',\r\n                printStatus: 'Chưa in',\r\n                deliveryMethod: 'Dịch vụ giao hàng',\r\n                carrier: partner?.name,\r\n                service: service?.name,\r\n              trackingCode: newItemData.packageInfo?.trackingCode || `VC${Date.now()}`,\r\n              shippingFeeToPartner: newItemData.shippingFeeNew,\r\n                codAmount: 0, // Will be calculated based on payments\r\n                payer: 'Người nhận',\r\n              weight: newItemData.packageInfo?.weight,\r\n              dimensions: newItemData.packageInfo?.dimensions,\r\n            });\r\n        }\r\n        // else: deliver-later → keep default 'Đặt hàng', 'Chờ đóng gói', no packagings\r\n        \r\n        const newOrderPayload = {\r\n            id: '', // ✅ Empty string triggers auto-generation of business ID (DH...)\r\n            customerSystemId: order.customerSystemId,\r\n            customerName: order.customerName,\r\n            branchSystemId: order.branchSystemId, // ✅ Use systemId only\r\n            branchName: order.branchName,\r\n            salespersonId: creatorSystemId,\r\n            salesperson: newItemData.creatorName,\r\n            orderDate: formatDateCustom(getCurrentDate(), 'yyyy-MM-dd HH:mm'),\r\n            lineItems: newItemData.exchangeItems,\r\n            subtotal: newItemData.subtotalNew,\r\n            shippingFee: newItemData.shippingFeeNew,\r\n            tax: 0,\r\n            // ✅ IMPORTANT: grandTotal should be NET amount (after subtracting return value)\r\n            // grandTotal = subtotalNew + shippingFee - totalReturnValue\r\n            grandTotal: newItemData.finalAmount > 0 ? newItemData.finalAmount : newItemData.grandTotalNew,\r\n            // ✅ Store return value info for display\r\n            linkedSalesReturnId: newReturn.id, // ✅ Fixed: Use newReturn.id (business ID)\r\n            linkedSalesReturnSystemId: newReturn.systemId, // ✅ Add systemId for linking\r\n            linkedSalesReturnValue: newItemData.totalReturnValue, // Value of returned items\r\n            payments: exchangeOrderPayments, // ✅ Set payments based on sales return scenario\r\n            notes: `Đơn hàng đổi từ phiếu trả ${newReturn.id} của đơn hàng ${order.id}`, // ✅ Fixed: Use newReturn.id\r\n            sourceSalesReturnId: newReturn.id, // ✅ Fixed: Use newReturn.id\r\n            // ✅ Pass shipping info from form\r\n            deliveryMethod: newItemData.deliveryMethod === 'pickup' ? 'Nhận tại cửa hàng' : 'Dịch vụ giao hàng',\r\n            shippingPartnerId: newItemData.shippingPartnerId,\r\n            shippingServiceId: newItemData.shippingServiceId,\r\n            shippingAddress: newItemData.shippingAddress,\r\n            packageInfo: newItemData.packageInfo,\r\n            configuration: newItemData.configuration,\r\n            // ✅ Add required status fields based on delivery method\r\n            status: finalMainStatus,\r\n            paymentStatus: exchangeOrderPayments.length > 0 ? \r\n              (exchangeOrderPayments.reduce((sum, p) => sum + p.amount, 0) >= newItemData.grandTotalNew ? 'Thanh toán toàn bộ' : 'Thanh toán 1 phần') \r\n                : 'Chưa thanh toán' as const,\r\n            deliveryStatus: finalDeliveryStatus,\r\n            printStatus: 'Chưa in' as const,\r\n            stockOutStatus: 'Chưa xuất kho' as const,\r\n            returnStatus: 'Chưa trả hàng' as const,\r\n            codAmount: 0, // Will be calculated by ShippingIntegration based on payments\r\n            packagings: packagings,\r\n        };\r\n        \r\n        console.log('📦 [Sales Return] New order payload:', newOrderPayload);\r\n        \r\n        const newOrder = addOrder(newOrderPayload as any);\r\n        \r\n        console.log('✅ [Sales Return] New order created:', newOrder);\r\n        \r\n        if (newOrder) {\r\n          newOrderSystemId = asSystemId(newOrder.systemId);\r\n          // ✅ Save exchange order systemId to sales return\r\n          (newItemData as SalesReturn).exchangeOrderSystemId = newOrderSystemId;\r\n            \r\n            console.log('🎉 [Sales Return] Exchange order systemId:', newOrderSystemId);\r\n        } else {\r\n            console.error('❌ [Sales Return] Failed to create exchange order!');\r\n        }\r\n    }\r\n\r\n    // Adjust customer debt if needed\r\n    const creditAmount = newItemData.totalReturnValue - newItemData.grandTotalNew - (newItemData.refundAmount || 0);\r\n    if (creditAmount > 0) {\r\n      updateDebt(newItemData.customerSystemId, -creditAmount);\r\n    }\r\n    \r\n    // ✅ newReturn already created above, use it directly\r\n    // ✅ NOW create vouchers with correct originalDocumentId\r\n    // Handle Financials AFTER creating the return\r\n    const finalAmount = newItemData.finalAmount;\r\n\r\n    if (finalAmount < 0 && newItemData.refunds && newItemData.refunds.length > 0) {\r\n      const createdVoucherIds: SystemId[] = [];\r\n\r\n      newItemData.refunds.forEach(refund => {\r\n        if (!refund.amount || refund.amount <= 0) {\r\n          return;\r\n        }\r\n\r\n        const { document, error } = createPaymentDocument({\r\n          amount: refund.amount,\r\n          description: `Hoàn tiền đổi/trả hàng từ đơn ${order.id} (Phiếu: ${newReturn.id}) qua ${refund.method}`,\r\n          recipientName: newItemData.customerName,\r\n          recipientSystemId: newItemData.customerSystemId,\r\n          customerSystemId: newItemData.customerSystemId,\r\n          customerName: newItemData.customerName,\r\n          paymentMethodName: refund.method,\r\n          accountSystemId: refund.accountSystemId,\r\n          paymentTypeName: 'Hoàn tiền khách hàng',\r\n          branchSystemId: newReturn.branchSystemId,\r\n          branchName: newReturn.branchName,\r\n          createdBy: creatorSystemId,\r\n          originalDocumentId: newReturn.id,\r\n          linkedSalesReturnSystemId: newReturn.systemId,\r\n          linkedOrderSystemId: newReturn.orderSystemId,\r\n          category: 'complaint_refund',\r\n          affectsDebt: true, // ✅ Hoàn tiền khách hàng ảnh hưởng công nợ (giảm công nợ)\r\n        });\r\n\r\n        if (error) {\r\n          console.error('[Sales Return] Failed to create payment voucher:', error);\r\n          toast.error(`Không thể tạo phiếu chi hoàn tiền: ${error}`);\r\n          return;\r\n        }\r\n\r\n        if (document) {\r\n          createdVoucherIds.push(asSystemId(document.systemId));\r\n        }\r\n      });\r\n\r\n      if (createdVoucherIds.length > 0) {\r\n        baseStore.getState().update(newReturn.systemId, {\r\n          ...newReturn,\r\n          paymentVoucherSystemIds: createdVoucherIds,\r\n        });\r\n      }\r\n    } else if (finalAmount > 0 && newItemData.payments && newItemData.payments.length > 0) {\r\n      const createdVoucherIds: SystemId[] = [];\r\n\r\n      newItemData.payments.forEach(payment => {\r\n        if (!payment.amount || payment.amount <= 0) {\r\n          return;\r\n        }\r\n\r\n        const { document, error } = createReceiptDocument({\r\n          amount: payment.amount,\r\n          description: `Thu tiền chênh lệch đổi hàng từ đơn ${order.id} (Phiếu: ${newReturn.id})`,\r\n          customerName: newReturn.customerName,\r\n          customerSystemId: newItemData.customerSystemId,\r\n          paymentMethodName: payment.method,\r\n          accountSystemId: payment.accountSystemId,\r\n          receiptTypeName: 'Thanh toán cho đơn hàng',\r\n          branchSystemId: newReturn.branchSystemId,\r\n          branchName: newReturn.branchName,\r\n          createdBy: creatorSystemId,\r\n          originalDocumentId: newReturn.id,\r\n          linkedSalesReturnSystemId: newReturn.systemId,\r\n          linkedOrderSystemId: newReturn.orderSystemId,\r\n          category: 'sale',\r\n          affectsDebt: false,\r\n        });\r\n\r\n        if (error) {\r\n          console.error('[Sales Return] Failed to create receipt voucher:', error);\r\n          toast.error(`Không thể tạo phiếu thu đổi hàng: ${error}`);\r\n          return;\r\n        }\r\n\r\n        if (document) {\r\n          createdVoucherIds.push(asSystemId(document.systemId));\r\n        }\r\n      });\r\n\r\n      if (createdVoucherIds.length > 0) {\r\n        baseStore.getState().update(newReturn.systemId, {\r\n          ...newReturn,\r\n          receiptVoucherSystemIds: createdVoucherIds,\r\n        });\r\n      }\r\n    }\r\n\r\n    // ✅ Update inventory for returned items ONLY if isReceived = true\r\n    // ✅ For combo products, add stock to child products instead\r\n    if (newReturn.isReceived) {\r\n        console.log('✅ [Sales Return] Updating inventory - items received');\r\n        \r\n        // Expand combo items to child products\r\n        const stockItems = getReturnStockItems(newReturn.items);\r\n        \r\n        stockItems.forEach(item => {\r\n          if (item.quantity > 0) {\r\n            const product = useProductStore.getState().findById(item.productSystemId);\r\n            const oldStock = product?.inventoryByBranch[newReturn.branchSystemId] || 0;\r\n            updateInventory(item.productSystemId, newReturn.branchSystemId, item.quantity); // Add stock back\r\n            addStockHistory({\r\n              productId: item.productSystemId,\r\n              date: getCurrentDate().toISOString(),\r\n              employeeName: newReturn.creatorName,\r\n              action: 'Nhập hàng từ khách trả',\r\n              quantityChange: item.quantity,\r\n              newStockLevel: oldStock + item.quantity,\r\n              documentId: newReturn.id, // ✅ Use business ID for document reference\r\n              branchSystemId: newReturn.branchSystemId,\r\n              branch: newReturn.branchName,\r\n            });\r\n          }\r\n        });\r\n    } else {\r\n        console.log('⏸️ [Sales Return] Inventory NOT updated - waiting for receipt confirmation');\r\n    }\r\n\r\n    // Update original order's return status\r\n    const previousReturnsForOrder = baseStore.getState().data.filter(r => r.orderSystemId === order.systemId);\r\n    const totalReturnedQty = previousReturnsForOrder.flatMap(r => r.items).reduce((sum, item) => sum + item.returnQuantity, 0);\r\n    const totalOrderedQty = order.lineItems.reduce((sum, item) => sum + item.quantity, 0);\r\n    const newReturnStatus = totalReturnedQty >= totalOrderedQty ? 'Trả hàng toàn bộ' : 'Trả hàng một phần';\r\n    updateOrder(order.systemId, { ...order, returnStatus: newReturnStatus });\r\n    \r\n    return { newReturn, newOrderSystemId };\r\n  },\r\n  \r\n  /**\r\n   * ✅ Confirm receipt of returned items and update inventory\r\n   * Use this when isReceived was false initially and items are now received\r\n   * ✅ For combo products, add stock to child products instead\r\n   */\r\n  confirmReceipt: (returnSystemId: SystemId) => {\r\n    const salesReturn = baseStore.getState().findById(returnSystemId);\r\n    if (!salesReturn) {\r\n      console.error('❌ [Sales Return] Return not found:', returnSystemId);\r\n      return { success: false, message: 'Không tìm thấy phiếu trả hàng' };\r\n    }\r\n    \r\n    if (salesReturn.isReceived) {\r\n      console.warn('⚠️ [Sales Return] Already received:', returnSystemId);\r\n      return { success: false, message: 'Hàng đã được nhận trước đó' };\r\n    }\r\n    \r\n    const { updateInventory } = useProductStore.getState();\r\n    const { addEntry: addStockHistory } = useStockHistoryStore.getState();\r\n    \r\n    // ✅ Expand combo items to child products\r\n    const stockItems = getReturnStockItems(salesReturn.items);\r\n    \r\n    // Update inventory for all returned items (including expanded combo children)\r\n    stockItems.forEach(item => {\r\n      if (item.quantity > 0) {\r\n        const product = useProductStore.getState().findById(item.productSystemId);\r\n        const oldStock = product?.inventoryByBranch[salesReturn.branchSystemId] || 0;\r\n        updateInventory(item.productSystemId, salesReturn.branchSystemId, item.quantity);\r\n        addStockHistory({\r\n          productId: item.productSystemId,\r\n          date: getCurrentDate().toISOString(),\r\n          employeeName: salesReturn.creatorName,\r\n          action: 'Nhập hàng từ khách trả (xác nhận)',\r\n          quantityChange: item.quantity,\r\n          newStockLevel: oldStock + item.quantity,\r\n          documentId: salesReturn.id,\r\n          branchSystemId: salesReturn.branchSystemId,\r\n          branch: salesReturn.branchName,\r\n        });\r\n      }\r\n    });\r\n    \r\n    // Update the return record\r\n    baseStore.getState().update(returnSystemId, {\r\n      ...salesReturn,\r\n      isReceived: true,\r\n    });\r\n    \r\n    console.log('✅ [Sales Return] Receipt confirmed and inventory updated:', returnSystemId);\r\n    return { success: true, message: 'Đã xác nhận nhận hàng và cập nhật tồn kho' };\r\n  },\r\n};\r\n\r\n// Export typed hook\r\nexport const useSalesReturnStore = (): any => {\r\n  const state = baseStore();\r\n  return {\r\n    ...state,\r\n    ...augmentedMethods,\r\n  };\r\n};\r\n\r\n// Export getState for non-hook usage\r\nuseSalesReturnStore.getState = (): any => {\r\n  const state = baseStore.getState();\r\n  return {\r\n    ...state,\r\n    ...augmentedMethods,\r\n  };\r\n};\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 6045, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/shipments/store.ts"],"sourcesContent":["/**\r\n * Shipment Store - Entity riêng cho vận đơn\r\n * \r\n * ⚠️ ID Format theo ID-GOVERNANCE.md:\r\n * - SystemId: SHIPMENT000001\r\n * - BusinessId: VC000001\r\n * \r\n * Relationship: Shipment 1:1 Packaging (via packagingSystemId)\r\n */\r\n\r\nimport { create } from 'zustand';\r\nimport type { SystemId, BusinessId } from '../../lib/id-types';\r\nimport { asSystemId, asBusinessId } from '../../lib/id-types';\r\nimport { generateSystemId, generateBusinessId, getMaxSystemIdCounter, getMaxBusinessIdCounter } from '../../lib/id-utils';\r\nimport type { Shipment } from './types';\r\n\r\n// ========================================\r\n// CONSTANTS\r\n// ========================================\r\n\r\nconst SHIPMENT_SYSTEM_ID_PREFIX = 'SHIPMENT';\r\nconst SHIPMENT_BUSINESS_ID_PREFIX = 'VC';\r\n\r\n// ========================================\r\n// INITIAL SEED DATA\r\n// ========================================\r\n\r\nconst initialData: Shipment[] = [\r\n    {\r\n        systemId: asSystemId('SHIPMENT000001'),\r\n        id: asBusinessId('VC000001'),\r\n        packagingSystemId: asSystemId('PACKAGE000001'),\r\n        orderSystemId: asSystemId('ORDER000001'),\r\n        orderId: asBusinessId('DH000001'),\r\n        trackingCode: 'GHN000001',\r\n        carrier: 'GHN',\r\n        service: 'Chuẩn',\r\n        deliveryStatus: 'Đã giao hàng',\r\n        printStatus: 'Đã in',\r\n        reconciliationStatus: 'Đã đối soát',\r\n        shippingFeeToPartner: 25000,\r\n        codAmount: 0,\r\n        payer: 'Người gửi',\r\n        createdAt: '2025-11-01 08:30',\r\n        dispatchedAt: '2025-11-02 08:00',\r\n        deliveredAt: '2025-11-05 15:30',\r\n    },\r\n    {\r\n        systemId: asSystemId('SHIPMENT000002'),\r\n        id: asBusinessId('VC000002'),\r\n        packagingSystemId: asSystemId('PACKAGE000002'),\r\n        orderSystemId: asSystemId('ORDER000002'),\r\n        orderId: asBusinessId('DH000002'),\r\n        trackingCode: 'JT000245',\r\n        carrier: 'J&T Express',\r\n        service: 'Gói chuẩn',\r\n        deliveryStatus: 'Đang giao hàng',\r\n        printStatus: 'Đã in',\r\n        reconciliationStatus: 'Chưa đối soát',\r\n        shippingFeeToPartner: 30000,\r\n        codAmount: 5000000,\r\n        payer: 'Người nhận',\r\n        createdAt: '2025-11-03 16:00',\r\n        dispatchedAt: '2025-11-04 09:00',\r\n    },\r\n    // Thêm dữ liệu mẫu mới\r\n    {\r\n        systemId: asSystemId('SHIPMENT000003'),\r\n        id: asBusinessId('VC000003'),\r\n        packagingSystemId: asSystemId('PACKAGE000005'),\r\n        orderSystemId: asSystemId('ORDER000005'),\r\n        orderId: asBusinessId('DH000005'),\r\n        trackingCode: 'GHTK123456',\r\n        carrier: 'GHTK',\r\n        service: 'Nhanh',\r\n        deliveryStatus: 'Đã giao hàng',\r\n        printStatus: 'Đã in',\r\n        reconciliationStatus: 'Chưa đối soát',\r\n        shippingFeeToPartner: 35000,\r\n        codAmount: 12500000,\r\n        payer: 'Người nhận',\r\n        createdAt: '2025-11-08 10:00',\r\n        dispatchedAt: '2025-11-08 14:00',\r\n        deliveredAt: '2025-11-10 11:30',\r\n    },\r\n    {\r\n        systemId: asSystemId('SHIPMENT000004'),\r\n        id: asBusinessId('VC000004'),\r\n        packagingSystemId: asSystemId('PACKAGE000006'),\r\n        orderSystemId: asSystemId('ORDER000006'),\r\n        orderId: asBusinessId('DH000006'),\r\n        trackingCode: 'VTP789012',\r\n        carrier: 'Viettel Post',\r\n        service: 'Tiêu chuẩn',\r\n        deliveryStatus: 'Đang giao hàng',\r\n        printStatus: 'Đã in',\r\n        reconciliationStatus: 'Chưa đối soát',\r\n        shippingFeeToPartner: 28000,\r\n        codAmount: 8900000,\r\n        payer: 'Người nhận',\r\n        createdAt: '2025-11-09 09:15',\r\n        dispatchedAt: '2025-11-09 15:30',\r\n    },\r\n    {\r\n        systemId: asSystemId('SHIPMENT000005'),\r\n        id: asBusinessId('VC000005'),\r\n        packagingSystemId: asSystemId('PACKAGE000007'),\r\n        orderSystemId: asSystemId('ORDER000007'),\r\n        orderId: asBusinessId('DH000007'),\r\n        trackingCode: 'GHN345678',\r\n        carrier: 'GHN',\r\n        service: 'Express',\r\n        deliveryStatus: 'Đã giao hàng',\r\n        printStatus: 'Đã in',\r\n        reconciliationStatus: 'Chưa đối soát',\r\n        shippingFeeToPartner: 45000,\r\n        codAmount: 23800000,\r\n        payer: 'Người nhận',\r\n        createdAt: '2025-11-07 08:00',\r\n        dispatchedAt: '2025-11-07 10:00',\r\n        deliveredAt: '2025-11-08 09:30',\r\n    },\r\n    {\r\n        systemId: asSystemId('SHIPMENT000006'),\r\n        id: asBusinessId('VC000006'),\r\n        packagingSystemId: asSystemId('PACKAGE000008'),\r\n        orderSystemId: asSystemId('ORDER000008'),\r\n        orderId: asBusinessId('DH000008'),\r\n        trackingCode: 'BEST567890',\r\n        carrier: 'Best Express',\r\n        service: 'Tiết kiệm',\r\n        deliveryStatus: 'Chờ lấy hàng',\r\n        printStatus: 'Đã in',\r\n        reconciliationStatus: 'Chưa đối soát',\r\n        shippingFeeToPartner: 22000,\r\n        codAmount: 4500000,\r\n        payer: 'Người nhận',\r\n        createdAt: '2025-11-10 07:30',\r\n    },\r\n    {\r\n        systemId: asSystemId('SHIPMENT000007'),\r\n        id: asBusinessId('VC000007'),\r\n        packagingSystemId: asSystemId('PACKAGE000009'),\r\n        orderSystemId: asSystemId('ORDER000009'),\r\n        orderId: asBusinessId('DH000009'),\r\n        trackingCode: 'NJV901234',\r\n        carrier: 'Ninja Van',\r\n        service: 'Standard',\r\n        deliveryStatus: 'Đã giao hàng',\r\n        printStatus: 'Đã in',\r\n        reconciliationStatus: 'Đã đối soát',\r\n        shippingFeeToPartner: 32000,\r\n        codAmount: 15600000,\r\n        payer: 'Người gửi',\r\n        createdAt: '2025-11-05 11:00',\r\n        dispatchedAt: '2025-11-05 16:00',\r\n        deliveredAt: '2025-11-07 14:30',\r\n    },\r\n    {\r\n        systemId: asSystemId('SHIPMENT000008'),\r\n        id: asBusinessId('VC000008'),\r\n        packagingSystemId: asSystemId('PACKAGE000010'),\r\n        orderSystemId: asSystemId('ORDER000010'),\r\n        orderId: asBusinessId('DH000010'),\r\n        trackingCode: 'JT567891',\r\n        carrier: 'J&T Express',\r\n        service: 'Siêu tốc',\r\n        deliveryStatus: 'Đang giao hàng',\r\n        printStatus: 'Đã in',\r\n        reconciliationStatus: 'Chưa đối soát',\r\n        shippingFeeToPartner: 55000,\r\n        codAmount: 31200000,\r\n        payer: 'Người nhận',\r\n        createdAt: '2025-11-10 14:00',\r\n        dispatchedAt: '2025-11-10 16:30',\r\n    },\r\n];\r\n\r\n// ========================================\r\n// STORE INTERFACE\r\n// ========================================\r\n\r\nexport interface ShipmentStoreState {\r\n    data: Shipment[];\r\n    \r\n    // CRUD\r\n    findById: (systemId: string) => Shipment | undefined;\r\n    findByPackagingSystemId: (packagingSystemId: string) => Shipment | undefined;\r\n    findByTrackingCode: (trackingCode: string) => Shipment | undefined;\r\n    \r\n    // Actions\r\n    createShipment: (data: Omit<Shipment, 'systemId' | 'id'>) => Shipment;\r\n    updateShipment: (systemId: SystemId, updates: Partial<Shipment>) => void;\r\n    deleteShipment: (systemId: SystemId) => void;\r\n    \r\n    // Counters\r\n    getNextSystemId: () => SystemId;\r\n    getNextBusinessId: () => BusinessId;\r\n}\r\n\r\n// ========================================\r\n// HELPER FUNCTIONS\r\n// ========================================\r\n\r\nlet shipmentSystemIdCounter = 0;\r\nlet shipmentBusinessIdCounter = 0;\r\n\r\nfunction initCounters(shipments: Shipment[]) {\r\n    shipmentSystemIdCounter = getMaxSystemIdCounter(shipments, SHIPMENT_SYSTEM_ID_PREFIX);\r\n    shipmentBusinessIdCounter = getMaxBusinessIdCounter(shipments, SHIPMENT_BUSINESS_ID_PREFIX);\r\n}\r\n\r\nfunction getNextShipmentSystemId(): SystemId {\r\n    shipmentSystemIdCounter++;\r\n    return generateSystemId('shipments', shipmentSystemIdCounter) as SystemId;\r\n}\r\n\r\nfunction getNextShipmentBusinessId(): BusinessId {\r\n    shipmentBusinessIdCounter++;\r\n    return generateBusinessId('shipments', shipmentBusinessIdCounter) as BusinessId;\r\n}\r\n\r\n// Initialize counters\r\ninitCounters(initialData);\r\n\r\n// ========================================\r\n// STORE CREATION\r\n// ========================================\r\n\r\nexport const useShipmentStore = create<ShipmentStoreState>()(\r\n    (set, get) => ({\r\n            data: initialData,\r\n            \r\n            findById: (systemId: string) => {\r\n                return get().data.find(s => s.systemId === systemId);\r\n            },\r\n            \r\n            findByPackagingSystemId: (packagingSystemId: string) => {\r\n                return get().data.find(s => s.packagingSystemId === packagingSystemId);\r\n            },\r\n            \r\n            findByTrackingCode: (trackingCode: string) => {\r\n                return get().data.find(s => s.trackingCode === trackingCode);\r\n            },\r\n            \r\n            createShipment: (data: Omit<Shipment, 'systemId' | 'id'>) => {\r\n                const newShipment: Shipment = {\r\n                    systemId: getNextShipmentSystemId(),\r\n                    id: getNextShipmentBusinessId(),\r\n                    ...data,\r\n                };\r\n                \r\n                set(state => ({\r\n                    data: [...state.data, newShipment]\r\n                }));\r\n                \r\n                return newShipment;\r\n            },\r\n            \r\n            updateShipment: (systemId: SystemId, updates: Partial<Shipment>) => {\r\n                set(state => ({\r\n                    data: state.data.map(s => \r\n                        s.systemId === systemId \r\n                            ? { ...s, ...updates }\r\n                            : s\r\n                    )\r\n                }));\r\n            },\r\n            \r\n            deleteShipment: (systemId: SystemId) => {\r\n                set(state => ({\r\n                    data: state.data.filter(s => s.systemId !== systemId)\r\n                }));\r\n            },\r\n            \r\n            getNextSystemId: () => getNextShipmentSystemId(),\r\n            getNextBusinessId: () => getNextShipmentBusinessId(),\r\n        })\r\n);\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 6288, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/orders/store.ts"],"sourcesContent":["import { create } from 'zustand';\r\n// persist middleware removed - database is now source of truth\r\nimport { formatDate, formatDateCustom, toISODate, toISODateTime } from '../../lib/date-utils';\r\nimport { getApiUrl } from '../../lib/api-config';\r\nimport { createCrudStore } from '../../lib/store-factory';\r\n// REMOVED: import { data as initialDataOmit } from './data'; // Mock data no longer used - database is source of truth\r\nimport type { Order, OrderPayment, Packaging, OrderMainStatus, OrderDeliveryStatus, PackagingStatus, OrderPaymentStatus, OrderDeliveryMethod } from './types';\r\nimport type { SystemId, BusinessId } from '../../lib/id-types';\r\nimport { asSystemId, asBusinessId } from '../../lib/id-types';\r\nimport { generateSystemId, getMaxSystemIdCounter } from '../../lib/id-utils';\r\n\r\nimport { useEmployeeStore } from '../employees/store';\r\n// REMOVED: Voucher store no longer exists - using Payment/Receipt stores instead\r\nimport { useProductStore } from '../products/store';\r\nimport { isComboProduct } from '../products/combo-utils';\r\nimport { useStockHistoryStore } from '../stock-history/store';\r\nimport { useCustomerStore } from '../customers/store';\r\nimport { useReceiptTypeStore } from '../settings/receipt-types/store';\r\n// REMOVED: import type { Voucher } from '../vouchers/types';\r\nimport { useCashbookStore } from '../cashbook/store';\r\nimport { useReceiptStore } from '../receipts/store';\r\nimport type { Receipt, ReceiptOrderAllocation } from '../receipts/types';\r\nimport { useSalesReturnStore } from '../sales-returns/store';\r\nimport { createPaymentDocument, createReceiptDocument } from '../finance/document-helpers';\r\nimport { useShipmentStore } from '../shipments/store';\r\nimport type { Shipment } from '../shipments/types';\r\n\r\nimport { getCurrentUserSystemId } from '../../contexts/auth-context';\r\n\r\nimport { useSalesManagementSettingsStore } from '../settings/sales/sales-management-store';\r\nimport {\r\n  getCurrentUserInfo,\r\n  createCreatedEntry,\r\n  createHistoryEntry,\r\n  appendHistoryEntry,\r\n  type HistoryEntry\r\n} from '../../lib/activity-history-helper';\r\n\r\n// ✅ Helper to get branch systemId\r\nconst getBranchId = (order: Order) => order.branchSystemId;\r\n\r\nconst deliveryStatusesBlockedForCancellation: OrderDeliveryStatus[] = [\r\n    'Đang giao hàng',\r\n    'Đã giao hàng',\r\n    'Chờ giao lại',\r\n];\r\n\r\nconst IN_STORE_PICKUP_PREFIX = 'INSTORE';\r\n\r\nconst PACKAGING_CODE_PREFIX = 'DG';\r\nconst PACKAGING_SYSTEM_ID_PREFIX = 'PACKAGE';\r\n\r\n// ✅ Track packaging systemId counter globally\r\nlet packagingSystemIdCounter = 0;\r\n\r\n// ✅ Initialize counter from all existing packagings across all orders\r\nconst initPackagingCounter = (orders: Order[]): void => {\r\n    const allPackagings = orders.flatMap(o => o.packagings || []);\r\n    packagingSystemIdCounter = getMaxSystemIdCounter(allPackagings, PACKAGING_SYSTEM_ID_PREFIX);\r\n};\r\n\r\n// ✅ Generate next packaging systemId\r\nconst getNextPackagingSystemId = (): SystemId => {\r\n    packagingSystemIdCounter++;\r\n    return asSystemId(generateSystemId('packaging', packagingSystemIdCounter));\r\n};\r\n\r\nconst getPackagingSuffixFromOrderId = (orderId?: BusinessId) => {\r\n    if (!orderId) return '';\r\n    const rawValue = `${orderId}`;\r\n    const suffix = rawValue.replace(/^[A-Z-]+/, '');\r\n    return suffix || rawValue;\r\n};\r\n\r\n// Count only active packagings (not cancelled) for numbering\r\nconst getActivePackagingCount = (packagings: Packaging[]): number => {\r\n    return packagings.filter(p => p.status !== 'Hủy đóng gói').length;\r\n};\r\n\r\nconst buildPackagingBusinessId = (orderId: BusinessId, activeIndex: number, activeCount: number): BusinessId => {\r\n    const suffix = getPackagingSuffixFromOrderId(orderId);\r\n    const baseCode = `${PACKAGING_CODE_PREFIX}${suffix || '000000'}`;\r\n    // Only add suffix if there are multiple active packagings\r\n    if (activeCount > 1 && activeIndex > 0) {\r\n        const paddedIndex = String(activeIndex + 1).padStart(2, '0');\r\n        return asBusinessId(`${baseCode}-${paddedIndex}`);\r\n    }\r\n    return asBusinessId(baseCode);\r\n};\r\n\r\nconst getReturnedValueForOrder = (orderSystemId: SystemId): number => {\r\n    return useSalesReturnStore.getState().data\r\n        .filter(sr => sr.orderSystemId === orderSystemId)\r\n        .reduce((sum, sr) => sum + sr.totalReturnValue, 0);\r\n};\r\n\r\nconst calculateActualDebt = (order: Order): number => {\r\n    const totalReturnedValue = getReturnedValueForOrder(order.systemId);\r\n    return Math.max(order.grandTotal - totalReturnedValue, 0);\r\n};\r\n\r\nconst calculateTotalPaid = (payments: OrderPayment[]): number => {\r\n    return payments.reduce((sum, payment) => sum + payment.amount, 0);\r\n};\r\n\r\nconst getOrderOutstandingAmount = (order: Order): number => {\r\n    const actualDebt = calculateActualDebt(order);\r\n    const totalPaid = calculateTotalPaid(order.payments ?? []);\r\n    return Math.max(actualDebt - totalPaid, 0);\r\n};\r\n\r\nconst applyPaymentToOrder = (order: Order, payment: OrderPayment): Order => {\r\n    const updatedPayments = [...(order.payments ?? []), payment];\r\n    const totalPaid = calculateTotalPaid(updatedPayments);\r\n    const actualDebt = calculateActualDebt(order);\r\n\r\n    let newPaymentStatus: OrderPaymentStatus = 'Chưa thanh toán';\r\n    if (totalPaid >= actualDebt) {\r\n        newPaymentStatus = 'Thanh toán toàn bộ';\r\n    } else if (totalPaid > 0) {\r\n        newPaymentStatus = 'Thanh toán 1 phần';\r\n    }\r\n\r\n    const wasCompleted = order.status === 'Hoàn thành';\r\n    let newStatus = order.status;\r\n    let newCompletedDate = order.completedDate;\r\n\r\n    if (newPaymentStatus === 'Thanh toán toàn bộ' && order.deliveryStatus === 'Đã giao hàng') {\r\n        newStatus = 'Hoàn thành';\r\n        newCompletedDate = toISODateTime(new Date());\r\n        if (!wasCompleted) {\r\n            const { incrementOrderStats } = useCustomerStore.getState();\r\n            incrementOrderStats(order.customerSystemId, order.grandTotal);\r\n        }\r\n    }\r\n\r\n    const { updateDebtTransactionPayment } = useCustomerStore.getState();\r\n    updateDebtTransactionPayment(order.customerSystemId, order.id, payment.amount);\r\n\r\n    return {\r\n        ...order,\r\n        payments: updatedPayments,\r\n        paymentStatus: newPaymentStatus,\r\n        status: newStatus,\r\n        completedDate: newCompletedDate,\r\n        paidAmount: totalPaid,\r\n    };\r\n};\r\n\r\nconst shouldAutoAllocateReceipt = (receipt: Receipt): boolean => {\r\n    return (\r\n        receipt.status === 'completed' &&\r\n        receipt.affectsDebt &&\r\n        !!receipt.customerSystemId &&\r\n        !receipt.linkedOrderSystemId\r\n    );\r\n};\r\n\r\nconst getAllocatedAmount = (receipt: Receipt): number => {\r\n    return receipt.orderAllocations?.reduce((sum, allocation) => sum + allocation.amount, 0) ?? 0;\r\n};\r\n\r\nconst autoAllocateReceiptToOrders = (receipt: Receipt) => {\r\n    if (!shouldAutoAllocateReceipt(receipt)) {\r\n        return;\r\n    }\r\n\r\n    const remainingAmount = receipt.amount - getAllocatedAmount(receipt);\r\n    if (remainingAmount <= 0) {\r\n        return;\r\n    }\r\n\r\n    const candidateOrders = baseStore.getState().data\r\n        .filter(order => order.customerSystemId === receipt.customerSystemId && order.status !== 'Đã hủy')\r\n        .map(order => ({ order, outstanding: getOrderOutstandingAmount(order) }))\r\n        .filter(entry => entry.outstanding > 0)\r\n        .sort((a, b) => {\r\n            const aTime = a.order.orderDate ? new Date(a.order.orderDate).getTime() : 0;\r\n            const bTime = b.order.orderDate ? new Date(b.order.orderDate).getTime() : 0;\r\n            return aTime - bTime;\r\n        });\r\n\r\n    if (!candidateOrders.length) {\r\n        return;\r\n    }\r\n\r\n    let amountToDistribute = remainingAmount;\r\n    const updatedOrders = new Map<SystemId, Order>();\r\n    const allocationEntries: ReceiptOrderAllocation[] = [];\r\n\r\n    for (const { order } of candidateOrders) {\r\n        if (amountToDistribute <= 0) {\r\n            break;\r\n        }\r\n\r\n        const currentOrderState = updatedOrders.get(order.systemId) ?? order;\r\n        const outstanding = getOrderOutstandingAmount(currentOrderState);\r\n        if (outstanding <= 0) {\r\n            continue;\r\n        }\r\n\r\n        const allocationAmount = Math.min(outstanding, amountToDistribute);\r\n        if (allocationAmount <= 0) {\r\n            continue;\r\n        }\r\n\r\n        const paymentEntry: OrderPayment = {\r\n            systemId: receipt.systemId,\r\n            id: receipt.id,\r\n            date: receipt.date,\r\n            amount: allocationAmount,\r\n            method: receipt.paymentMethodName,\r\n            createdBy: asSystemId(receipt.createdBy),\r\n            description: receipt.description ?? `Thanh toán từ phiếu thu ${receipt.id}`,\r\n        };\r\n\r\n        const updatedOrder = applyPaymentToOrder(currentOrderState, paymentEntry);\r\n        updatedOrders.set(order.systemId, updatedOrder);\r\n        allocationEntries.push({\r\n            orderSystemId: order.systemId,\r\n            orderId: order.id,\r\n            amount: allocationAmount,\r\n        });\r\n\r\n        amountToDistribute -= allocationAmount;\r\n    }\r\n\r\n    if (!allocationEntries.length) {\r\n        return;\r\n    }\r\n\r\n    baseStore.setState(state => {\r\n        const data = state.data.map(order => updatedOrders.get(order.systemId) ?? order);\r\n        return { data };\r\n    });\r\n\r\n    const receiptStore = useReceiptStore.getState();\r\n    const latestReceipt = receiptStore.findById(receipt.systemId);\r\n    if (!latestReceipt) {\r\n        return;\r\n    }\r\n\r\n    receiptStore.update(receipt.systemId, {\r\n        ...latestReceipt,\r\n        orderAllocations: [...(latestReceipt.orderAllocations ?? []), ...allocationEntries],\r\n    });\r\n};\r\n\r\nconst ensureOrderPackagingIdentifiers = (order: Order): Order | null => {\r\n    if (!order.packagings || order.packagings.length === 0) {\r\n        return null;\r\n    }\r\n\r\n    // Count only active packagings for proper numbering\r\n    const activePackagings = order.packagings.filter(p => p.status !== 'Hủy đóng gói');\r\n    const activeCount = activePackagings.length;\r\n    let changed = false;\r\n    let activeIndex = 0;\r\n\r\n    const updatedPackagings = order.packagings.map((pkg, idx) => {\r\n        const isCancelled = pkg.status === 'Hủy đóng gói';\r\n        const hasId = typeof pkg.id === 'string' && pkg.id.trim().length > 0;\r\n        // ✅ Check for temp systemId or old format (PKG_)\r\n        const hasTempOrOldSystemId = pkg.systemId?.startsWith('PKG_TEMP_') || pkg.systemId?.startsWith('PKG_');\r\n        const hasValidSystemId = pkg.systemId?.startsWith(PACKAGING_SYSTEM_ID_PREFIX);\r\n        const shouldFixTracking = pkg.deliveryMethod === 'Nhận tại cửa hàng' && pkg.trackingCode === `${IN_STORE_PICKUP_PREFIX}-`;\r\n\r\n        // For cancelled packagings, keep existing ID\r\n        if (isCancelled) {\r\n            if (!hasId || (hasTempOrOldSystemId && !hasValidSystemId)) {\r\n                // Still need to assign an ID if missing\r\n                const nextPkg = { ...pkg };\r\n                if (!hasId) {\r\n                    nextPkg.id = buildPackagingBusinessId(order.id, 0, 1);\r\n                }\r\n                if (hasTempOrOldSystemId && !hasValidSystemId) {\r\n                    nextPkg.systemId = getNextPackagingSystemId();\r\n                }\r\n                changed = true;\r\n                return nextPkg;\r\n            }\r\n            return pkg;\r\n        }\r\n\r\n        // For active packagings, use activeIndex for numbering\r\n        const currentActiveIndex = activeIndex;\r\n        activeIndex++;\r\n\r\n        if (hasId && !shouldFixTracking && hasValidSystemId) {\r\n            return pkg;\r\n        }\r\n\r\n        const nextPkg = { ...pkg };\r\n        if (!hasId) {\r\n            nextPkg.id = buildPackagingBusinessId(order.id, currentActiveIndex, activeCount);\r\n            changed = true;\r\n        }\r\n        \r\n        // ✅ Fix temporary/old systemId to proper format PACKAGE000001\r\n        if (hasTempOrOldSystemId && !hasValidSystemId) {\r\n            nextPkg.systemId = getNextPackagingSystemId();\r\n            changed = true;\r\n        }\r\n\r\n        if (shouldFixTracking) {\r\n            const resolvedId = nextPkg.id ?? buildPackagingBusinessId(order.id, currentActiveIndex, activeCount);\r\n            nextPkg.trackingCode = `${IN_STORE_PICKUP_PREFIX}-${resolvedId}`;\r\n            changed = true;\r\n        }\r\n\r\n        return nextPkg;\r\n    });\r\n\r\n    return changed ? { ...order, packagings: updatedPackagings } : null;\r\n};\r\n\r\nconst ensureCancellationAllowed = (order: Order | undefined, actionLabel: string) => {\r\n    if (!order) return false;\r\n\r\n    const { allowCancelAfterExport } = useSalesManagementSettingsStore.getState();\r\n    if (allowCancelAfterExport) {\r\n        return true;\r\n    }\r\n\r\n    const hasLeftWarehouse =\r\n        order.stockOutStatus === 'Xuất kho toàn bộ' ||\r\n        deliveryStatusesBlockedForCancellation.includes(order.deliveryStatus);\r\n\r\n    if (hasLeftWarehouse) {\r\n        alert(\r\n            `Không thể ${actionLabel} vì đơn hàng đã xuất kho. Vào Cấu hình bán hàng -> Thiết lập quản lý bán hàng và bật \"Cho phép hủy đơn hàng sau khi xuất kho\".`,\r\n        );\r\n        return false;\r\n    }\r\n\r\n    return true;\r\n};\r\n\r\n/**\r\n * ✅ Helper để xử lý stock cho combo hoặc sản phẩm thường\r\n * Combo không có tồn kho thực tế - thao tác trên SP con\r\n */\r\ntype StockOperation = 'commit' | 'uncommit' | 'dispatch' | 'complete' | 'return';\r\n\r\nconst processLineItemStock = (\r\n    lineItem: { productSystemId: string; quantity: number },\r\n    branchSystemId: string,\r\n    operation: StockOperation,\r\n    orderQuantity: number = 1 // Số lượng đặt của line item\r\n) => {\r\n    const { \r\n        findById: findProductById, \r\n        commitStock, \r\n        uncommitStock, \r\n        dispatchStock, \r\n        completeDelivery, \r\n        returnStockFromTransit \r\n    } = useProductStore.getState();\r\n    \r\n    const product = findProductById(asSystemId(lineItem.productSystemId));\r\n    \r\n    // Xác định danh sách items cần xử lý (SP con nếu combo, hoặc chính SP nếu thường)\r\n    const itemsToProcess: { productSystemId: SystemId; quantity: number }[] = [];\r\n    \r\n    if (product && isComboProduct(product) && product.comboItems) {\r\n        // Combo: xử lý tất cả SP con\r\n        product.comboItems.forEach(comboItem => {\r\n            itemsToProcess.push({\r\n                productSystemId: asSystemId(comboItem.productSystemId),\r\n                quantity: orderQuantity * comboItem.quantity, // Số lượng combo × số lượng SP con\r\n            });\r\n        });\r\n    } else {\r\n        // Sản phẩm thường\r\n        itemsToProcess.push({\r\n            productSystemId: asSystemId(lineItem.productSystemId),\r\n            quantity: orderQuantity,\r\n        });\r\n    }\r\n    \r\n    // Thực hiện operation cho từng item\r\n    itemsToProcess.forEach(item => {\r\n        const branchId = asSystemId(branchSystemId);\r\n        switch (operation) {\r\n            case 'commit':\r\n                commitStock(item.productSystemId, branchId, item.quantity);\r\n                break;\r\n            case 'uncommit':\r\n                uncommitStock(item.productSystemId, branchId, item.quantity);\r\n                break;\r\n            case 'dispatch':\r\n                dispatchStock(item.productSystemId, branchId, item.quantity);\r\n                break;\r\n            case 'complete':\r\n                completeDelivery(item.productSystemId, branchId, item.quantity);\r\n                break;\r\n            case 'return':\r\n                returnStockFromTransit(item.productSystemId, branchId, item.quantity);\r\n                break;\r\n        }\r\n    });\r\n    \r\n    return itemsToProcess; // Return để có thể dùng cho stock history\r\n};\r\n\r\n/**\r\n * ✅ Helper để lấy danh sách stock items từ line items (mở rộng combo thành SP con)\r\n * Dùng trong webhook GHTK hoặc các thao tác batch\r\n */\r\nconst getComboStockItems = (lineItems: { productSystemId: string; quantity: number }[]): { productSystemId: SystemId; quantity: number }[] => {\r\n    const { findById: findProductById } = useProductStore.getState();\r\n    const stockItems: { productSystemId: SystemId; quantity: number }[] = [];\r\n    \r\n    lineItems.forEach(item => {\r\n        const product = findProductById(asSystemId(item.productSystemId));\r\n        \r\n        if (product && isComboProduct(product) && product.comboItems) {\r\n            // Combo: mở rộng thành SP con\r\n            product.comboItems.forEach(comboItem => {\r\n                stockItems.push({\r\n                    productSystemId: asSystemId(comboItem.productSystemId),\r\n                    quantity: item.quantity * comboItem.quantity,\r\n                });\r\n            });\r\n        } else {\r\n            // Sản phẩm thường\r\n            stockItems.push({\r\n                productSystemId: asSystemId(item.productSystemId),\r\n                quantity: item.quantity,\r\n            });\r\n        }\r\n    });\r\n    \r\n    return stockItems;\r\n};\r\n\r\nconst createOrderRefundVoucher = (order: Order, amount: number, employeeId: SystemId) => {\r\n    const lastPositivePayment = [...(order.payments ?? [])].reverse().find(p => p.amount > 0);\r\n    const { document, error } = createPaymentDocument({\r\n        amount,\r\n        description: `Hoàn tiền do hủy đơn ${order.id}`,\r\n        recipientName: order.customerName,\r\n        recipientSystemId: order.customerSystemId,\r\n        customerSystemId: order.customerSystemId,\r\n        customerName: order.customerName,\r\n        branchSystemId: order.branchSystemId,\r\n        branchName: order.branchName,\r\n        createdBy: employeeId,\r\n        paymentMethodName: lastPositivePayment?.method || 'Tiền mặt',\r\n        paymentTypeName: 'Hoàn tiền khách hàng',\r\n        originalDocumentId: order.id,\r\n        linkedOrderSystemId: order.systemId,\r\n        affectsDebt: true,\r\n        category: 'other',\r\n    });\r\n\r\n    if (!document) {\r\n        console.error('[cancelOrder] Không thể tạo phiếu chi hoàn tiền', error);\r\n        return null;\r\n    }\r\n\r\n    return document;\r\n};\r\n\r\n// REMOVED: initialDataOmit transformation - database is source of truth\r\nconst initialData: Order[] = [];\r\n\r\nconst baseStore = createCrudStore<Order>([], 'orders', {\r\n  businessIdField: 'id',\r\n  apiEndpoint: '/api/orders',\r\n  getCurrentUser: () => {\r\n    return asSystemId(getCurrentUserSystemId());\r\n  }\r\n});\r\n\r\n// ✅ API Sync helpers\r\nconst API_ENDPOINT = '/api/orders';\r\n\r\nconst syncToApi = {\r\n  create: async (order: Order) => {\r\n    try {\r\n      const response = await fetch(API_ENDPOINT, {\r\n        method: 'POST',\r\n        credentials: 'include',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify(order),\r\n      });\r\n      if (!response.ok) console.warn('[Order API] Create sync failed');\r\n      else console.log('[Order API] Created:', order.systemId);\r\n    } catch (e) {\r\n      console.warn('[Order API] Create sync error:', e);\r\n    }\r\n  },\r\n  update: async (systemId: SystemId, updates: Partial<Order>) => {\r\n    try {\r\n      const response = await fetch(`${API_ENDPOINT}/${systemId}`, {\r\n        method: 'PATCH',\r\n        credentials: 'include',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify(updates),\r\n      });\r\n      if (!response.ok) console.warn('[Order API] Update sync failed');\r\n      else console.log('[Order API] Updated:', systemId);\r\n    } catch (e) {\r\n      console.warn('[Order API] Update sync error:', e);\r\n    }\r\n  },\r\n  delete: async (systemId: SystemId, hard = false) => {\r\n    try {\r\n      const response = await fetch(`${API_ENDPOINT}/${systemId}`, {\r\n        method: 'DELETE',\r\n        credentials: 'include',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({ hard }),\r\n      });\r\n      if (!response.ok) console.warn('[Order API] Delete sync failed');\r\n      else console.log('[Order API] Deleted:', systemId);\r\n    } catch (e) {\r\n      console.warn('[Order API] Delete sync error:', e);\r\n    }\r\n  },\r\n  restore: async (systemId: SystemId) => {\r\n    try {\r\n      const response = await fetch(`${API_ENDPOINT}/${systemId}/restore`, {\r\n        method: 'POST',\r\n        credentials: 'include',\r\n        headers: { 'Content-Type': 'application/json' },\r\n      });\r\n      if (!response.ok) console.warn('[Order API] Restore sync failed');\r\n      else console.log('[Order API] Restored:', systemId);\r\n    } catch (e) {\r\n      console.warn('[Order API] Restore sync error:', e);\r\n    }\r\n  },\r\n};\r\n\r\n// ✅ Wrap base store methods with API sync\r\nconst originalAdd = baseStore.getState().add;\r\nconst originalUpdate = baseStore.getState().update;\r\nconst originalRemove = baseStore.getState().remove;\r\nconst originalHardDelete = baseStore.getState().hardDelete;\r\nconst originalRestore = baseStore.getState().restore;\r\n\r\nbaseStore.setState({\r\n  add: (item: Omit<Order, 'systemId'>) => {\r\n    const result = originalAdd(item);\r\n    syncToApi.create(result);\r\n    return result;\r\n  },\r\n  update: (systemId: SystemId, updates: Partial<Order>) => {\r\n    originalUpdate(systemId, updates);\r\n    syncToApi.update(systemId, updates);\r\n  },\r\n  remove: (systemId: SystemId) => {\r\n    originalRemove(systemId);\r\n    syncToApi.delete(systemId, false);\r\n  },\r\n  hardDelete: (systemId: SystemId) => {\r\n    originalHardDelete(systemId);\r\n    syncToApi.delete(systemId, true);\r\n  },\r\n  restore: (systemId: SystemId) => {\r\n    originalRestore(systemId);\r\n    syncToApi.restore(systemId);\r\n  },\r\n});\r\n\r\n// ✅ MIGRATION: Ensure all orders have paidAmount field (backward compatibility)\r\nbaseStore.setState(state => ({\r\n  data: state.data.map(order => ({\r\n    ...order,\r\n    paidAmount: order.paidAmount ?? 0, // Default to 0 if undefined\r\n  }))\r\n}));\r\n\r\n// ✅ MIGRATION: Merge seed data - add new orders from initialData if not exist in persisted store\r\nbaseStore.setState(state => {\r\n  const existingIds = new Set(state.data.map(o => o.systemId));\r\n  const newOrders = initialData.filter(o => !existingIds.has(o.systemId));\r\n  if (newOrders.length > 0) {\r\n    return { data: [...state.data, ...newOrders] };\r\n  }\r\n  return state;\r\n});\r\n\r\n// ✅ MIGRATION: Fix order status - orders with full payment and delivery should be \"Hoàn thành\"\r\nbaseStore.setState(state => ({\r\n  data: state.data.map(order => {\r\n    // If order is already completed or cancelled, skip\r\n    if (order.status === 'Hoàn thành' || order.status === 'Đã hủy') {\r\n      return order;\r\n    }\r\n    \r\n    // Check if all active packagings are delivered\r\n    const activePackagings = order.packagings.filter(p => p.status !== 'Hủy đóng gói');\r\n    const isAllDelivered = activePackagings.length > 0 && activePackagings.every(p => p.deliveryStatus === 'Đã giao hàng');\r\n    \r\n    // If fully paid and fully delivered, update status to \"Hoàn thành\"\r\n    if (order.paymentStatus === 'Thanh toán toàn bộ' && (isAllDelivered || order.deliveryStatus === 'Đã giao hàng')) {\r\n      return {\r\n        ...order,\r\n        status: 'Hoàn thành' as OrderMainStatus,\r\n        completedDate: order.completedDate || toISODateTime(new Date()),\r\n      };\r\n    }\r\n    \r\n    return order;\r\n  })\r\n}));\r\n\r\nconst originalAddWithStock = baseStore.getState().add;\r\n\r\nbaseStore.setState({\r\n    add: (item) => {\r\n        const { commitStock, findById: findProductById } = useProductStore.getState();\r\n        const userInfo = getCurrentUserInfo();\r\n        const newItem = originalAddWithStock(item);\r\n        if (newItem) {\r\n            const hydratedPackagings = ensureOrderPackagingIdentifiers(newItem);\r\n            if (hydratedPackagings) {\r\n                Object.assign(newItem, hydratedPackagings);\r\n                baseStore.setState(state => ({\r\n                    data: state.data.map(order => order.systemId === hydratedPackagings.systemId ? hydratedPackagings : order),\r\n                }));\r\n            }\r\n            newItem.lineItems.forEach(li => {\r\n                const product = findProductById(asSystemId(li.productSystemId));\r\n                \r\n                // ✅ Xử lý combo: commit stock của SP con thay vì combo\r\n                if (product && isComboProduct(product) && product.comboItems) {\r\n                    product.comboItems.forEach(comboItem => {\r\n                        // Commit stock = số lượng combo × số lượng SP con trong combo\r\n                        const totalQuantity = li.quantity * comboItem.quantity;\r\n                        commitStock(asSystemId(comboItem.productSystemId), asSystemId(newItem.branchSystemId), totalQuantity);\r\n                    });\r\n                } else {\r\n                    // Sản phẩm thường: commit stock như bình thường\r\n                    commitStock(asSystemId(li.productSystemId), asSystemId(newItem.branchSystemId), li.quantity);\r\n                }\r\n            });\r\n            \r\n            // ✅ Cập nhật lastPurchaseDate khi tạo đơn mới (để SLA/churn risk hoạt động đúng)\r\n            if (newItem.customerSystemId) {\r\n                const { update: updateCustomer, findById: findCustomer } = useCustomerStore.getState();\r\n                const customer = findCustomer(newItem.customerSystemId);\r\n                if (customer) {\r\n                    updateCustomer(newItem.customerSystemId, {\r\n                        lastPurchaseDate: new Date().toISOString().split('T')[0],\r\n                    });\r\n                }\r\n            }\r\n            \r\n            // ✅ Add activity history entry\r\n            const historyEntry = createCreatedEntry(\r\n                userInfo,\r\n                `${userInfo.name} đã tạo đơn hàng ${newItem.id} cho khách hàng ${newItem.customerName} (Tổng: ${newItem.grandTotal.toLocaleString('vi-VN')}đ)`\r\n            );\r\n            baseStore.setState(state => ({\r\n                data: state.data.map(order => order.systemId === newItem.systemId ? { ...order, activityHistory: [historyEntry] } : order),\r\n            }));\r\n        }\r\n        return newItem;\r\n    },\r\n});\r\n\r\nconst backfillPackagingIdentifiers = () => {\r\n    const currentState = baseStore.getState();\r\n    let changed = false;\r\n    const updatedData = currentState.data.map(order => {\r\n        const updatedOrder = ensureOrderPackagingIdentifiers(order);\r\n        if (updatedOrder) {\r\n            changed = true;\r\n            return updatedOrder;\r\n        }\r\n        return order;\r\n    });\r\n\r\n    if (changed) {\r\n        baseStore.setState({ data: updatedData });\r\n    }\r\n};\r\n\r\nbackfillPackagingIdentifiers();\r\n\r\nconst augmentedMethods = {\r\n    cancelOrder: (\r\n        systemId: SystemId,\r\n        employeeId: SystemId,\r\n        options?: { reason?: string; restock?: boolean }\r\n    ) => {\r\n        const { reason, restock = true } = options ?? {};\r\n        const currentOrder = baseStore.getState().data.find(o => o.systemId === systemId);\r\n        if (!ensureCancellationAllowed(currentOrder, 'hủy đơn hàng')) {\r\n            return;\r\n        }\r\n\r\n        baseStore.setState(state => {\r\n            const orderToCancel = state.data.find(o => o.systemId === systemId);\r\n            if (!orderToCancel || orderToCancel.status === 'Đã hủy') {\r\n                return state;\r\n            }\r\n\r\n            const employee = useEmployeeStore.getState().findById(employeeId as SystemId);\r\n            const now = toISODateTime(new Date());\r\n            const cancellationReason = (reason && reason.trim().length > 0)\r\n                ? reason.trim()\r\n                : orderToCancel.cancellationReason || `Hủy bởi ${employee?.fullName || 'Hệ thống'}`;\r\n\r\n            // ✅ Uncommit stock (hỗ trợ combo)\r\n            if (restock) {\r\n                orderToCancel.lineItems.forEach(item => {\r\n                    processLineItemStock(item, orderToCancel.branchSystemId, 'uncommit', item.quantity);\r\n                });\r\n            }\r\n\r\n            const hasDispatchedStock = orderToCancel.stockOutStatus === 'Xuất kho toàn bộ'\r\n                || ['Chờ lấy hàng', 'Đang giao hàng', 'Đã giao hàng', 'Chờ giao lại'].includes(orderToCancel.deliveryStatus);\r\n\r\n            // ✅ Return stock from transit (hỗ trợ combo)\r\n            if (restock && hasDispatchedStock) {\r\n                orderToCancel.lineItems.forEach(item => {\r\n                    processLineItemStock(item, orderToCancel.branchSystemId, 'return', item.quantity);\r\n                });\r\n            }\r\n\r\n            const existingPayments = orderToCancel.payments ?? [];\r\n            const netCollected = existingPayments.reduce((sum, payment) => sum + payment.amount, 0);\r\n            let refundPaymentEntry: OrderPayment | null = null;\r\n            const refundAmount = netCollected > 0 ? netCollected : 0;\r\n\r\n            if (refundAmount > 0) {\r\n                const refundVoucher = createOrderRefundVoucher(orderToCancel, refundAmount, employeeId);\r\n                if (!refundVoucher) {\r\n                    alert('Không thể tạo phiếu chi hoàn tiền. Vui lòng kiểm tra cấu hình tài chính trước khi hủy đơn.');\r\n                    return state;\r\n                }\r\n\r\n                refundPaymentEntry = {\r\n                    systemId: refundVoucher.systemId,\r\n                    id: refundVoucher.id,\r\n                    date: refundVoucher.date,\r\n                    amount: -refundAmount,\r\n                    method: refundVoucher.paymentMethodName,\r\n                    createdBy: employeeId,\r\n                    description: `Hoàn tiền khi hủy đơn ${orderToCancel.id}`,\r\n                };\r\n            }\r\n\r\n            const updatedPayments = refundPaymentEntry ? [...existingPayments, refundPaymentEntry] : existingPayments;\r\n            const updatedPaidAmount = Math.max(0, (orderToCancel.paidAmount ?? 0) - refundAmount);\r\n            const updatedPackagings = orderToCancel.packagings.map(pkg => {\r\n                if (pkg.status === 'Hủy đóng gói' && pkg.deliveryStatus === 'Đã hủy') {\r\n                    return pkg;\r\n                }\r\n                return {\r\n                    ...pkg,\r\n                    status: 'Hủy đóng gói' as PackagingStatus,\r\n                    deliveryStatus: 'Đã hủy' as OrderDeliveryStatus,\r\n                    cancelDate: now,\r\n                    cancelReason: pkg.cancelReason ?? cancellationReason,\r\n                    cancelingEmployeeId: employeeId,\r\n                    cancelingEmployeeName: employee?.fullName || 'Hệ thống',\r\n                };\r\n            });\r\n\r\n            const updatedOrder = {\r\n                ...orderToCancel,\r\n                status: 'Đã hủy' as OrderMainStatus,\r\n                cancelledDate: now,\r\n                cancellationReason,\r\n                deliveryStatus: 'Đã hủy' as OrderDeliveryStatus,\r\n                stockOutStatus: restock ? 'Chưa xuất kho' as const : orderToCancel.stockOutStatus,\r\n                payments: updatedPayments,\r\n                paidAmount: updatedPaidAmount,\r\n                paymentStatus: refundPaymentEntry ? 'Chưa thanh toán' as OrderPaymentStatus : orderToCancel.paymentStatus,\r\n                packagings: updatedPackagings,\r\n                cancellationMetadata: {\r\n                    restockItems: restock,\r\n                    notifyCustomer: false,\r\n                    emailNotifiedAt: undefined,\r\n                },\r\n                activityHistory: appendHistoryEntry(\r\n                    orderToCancel.activityHistory,\r\n                    createHistoryEntry(\r\n                        'cancelled',\r\n                        getCurrentUserInfo(),\r\n                        `${employee?.fullName || 'Hệ thống'} đã hủy đơn hàng. Lý do: ${cancellationReason}${refundAmount > 0 ? `. Hoàn tiền: ${refundAmount.toLocaleString('vi-VN')}đ` : ''}`\r\n                    )\r\n                ),\r\n            };\r\n\r\n            // ✅ Remove debt transaction from customer\r\n            useCustomerStore.getState().removeDebtTransaction(orderToCancel.customerSystemId, orderToCancel.id);\r\n\r\n            return { data: state.data.map(o => (o.systemId === systemId ? updatedOrder : o)) };\r\n        });\r\n    },\r\n\r\n    addPayment: (orderSystemId: SystemId, paymentData: { amount: number; method: string }, employeeId: SystemId) => {\r\n        // --- Side effects must happen outside setState ---\r\n        const order = baseStore.getState().findById(orderSystemId as SystemId);\r\n        const employee = useEmployeeStore.getState().findById(employeeId as SystemId);\r\n\r\n        if (!order || !employee) {\r\n            console.error(\"Order or employee not found for payment.\");\r\n            return;\r\n        }\r\n\r\n        const { document: createdReceipt, error } = createReceiptDocument({\r\n            amount: paymentData.amount,\r\n            description: `Thanh toán cho đơn hàng ${order.id}`,\r\n            customerName: order.customerName,\r\n            customerSystemId: order.customerSystemId,\r\n            branchSystemId: order.branchSystemId,\r\n            branchName: order.branchName,\r\n            createdBy: employeeId,\r\n            paymentMethodName: paymentData.method,\r\n            receiptTypeName: 'Thanh toán cho đơn hàng',\r\n            originalDocumentId: order.id,\r\n            linkedOrderSystemId: order.systemId,\r\n            affectsDebt: true,\r\n        });\r\n\r\n        if (!createdReceipt) {\r\n            console.error('Failed to create receipt', error);\r\n            alert('Không thể tạo phiếu thu cho đơn hàng. Vui lòng kiểm tra cấu hình chứng từ.');\r\n            return;\r\n        }\r\n\r\n        // 2. Now, update the order state with the created receipt info\r\n        baseStore.setState(state => {\r\n            const orderIndex = state.data.findIndex(o => o.systemId === orderSystemId);\r\n            if (orderIndex === -1) return state;\r\n\r\n            const orderToUpdate = state.data[orderIndex];\r\n            const newPayment: OrderPayment = {\r\n                systemId: createdReceipt.systemId,\r\n                id: createdReceipt.id,\r\n                date: createdReceipt.date,\r\n                amount: createdReceipt.amount,\r\n                method: createdReceipt.paymentMethodName,\r\n                createdBy: asSystemId(createdReceipt.createdBy),\r\n                description: createdReceipt.description,\r\n            };\r\n\r\n            const updatedOrder = applyPaymentToOrder(orderToUpdate, newPayment);\r\n            \r\n            // ✅ Add activity history entry\r\n            updatedOrder.activityHistory = appendHistoryEntry(\r\n                orderToUpdate.activityHistory,\r\n                createHistoryEntry(\r\n                    'payment_made',\r\n                    getCurrentUserInfo(),\r\n                    `${employee?.fullName || 'Nhân viên'} đã thanh toán ${paymentData.amount.toLocaleString('vi-VN')}đ bằng ${paymentData.method}`\r\n                )\r\n            );\r\n            \r\n            const newData = [...state.data];\r\n            newData[orderIndex] = updatedOrder;\r\n\r\n            return { data: newData };\r\n        });\r\n    },\r\n\r\n    requestPackaging: (orderSystemId: SystemId, employeeId: SystemId, assignedEmployeeId?: SystemId) => {\r\n        baseStore.setState(state => {\r\n            const order = state.data.find(o => o.systemId === orderSystemId);\r\n            if (!order) return state;\r\n            const employee = useEmployeeStore.getState().findById(employeeId as SystemId);\r\n            const assignedEmployee = assignedEmployeeId ? useEmployeeStore.getState().findById(assignedEmployeeId as SystemId) : null;\r\n            \r\n            // Count only active packagings for proper numbering\r\n            const activePackagings = order.packagings.filter(p => p.status !== 'Hủy đóng gói');\r\n            const activeCountAfterInsert = activePackagings.length + 1;\r\n            const newActiveIndex = activePackagings.length; // This will be the index in active packagings\r\n            \r\n            const newPackaging: Packaging = {\r\n                systemId: getNextPackagingSystemId(), // ✅ Use proper format PACKAGE000001\r\n                id: buildPackagingBusinessId(order.id, newActiveIndex, activeCountAfterInsert),\r\n                requestDate: toISODateTime(new Date()),\r\n                requestingEmployeeId: employeeId,\r\n                requestingEmployeeName: employee?.fullName || 'N/A',\r\n                assignedEmployeeId,\r\n                assignedEmployeeName: assignedEmployee?.fullName,\r\n                status: 'Chờ đóng gói',\r\n                printStatus: 'Chưa in',\r\n            };\r\n\r\n            const updatedOrder = { ...order, packagings: [...order.packagings, newPackaging], deliveryStatus: 'Chờ đóng gói' as OrderDeliveryStatus };\r\n            return { data: state.data.map(o => o.systemId === orderSystemId ? updatedOrder : o) };\r\n        });\r\n    },\r\n\r\n    confirmPackaging: (orderSystemId: SystemId, packagingSystemId: SystemId, employeeId: SystemId) => {\r\n        // ✅ Check negative packing setting\r\n        const { allowNegativePacking } = useSalesManagementSettingsStore.getState();\r\n        if (!allowNegativePacking) {\r\n            const order = baseStore.getState().data.find(o => o.systemId === orderSystemId);\r\n            if (order) {\r\n                const { findById: findProductById } = useProductStore.getState();\r\n                for (const item of order.lineItems) {\r\n                    const product = findProductById(asSystemId(item.productSystemId));\r\n                    \r\n                    if (product && isComboProduct(product) && product.comboItems) {\r\n                        for (const comboItem of product.comboItems) {\r\n                            const childProduct = findProductById(asSystemId(comboItem.productSystemId));\r\n                            const requiredQty = item.quantity * comboItem.quantity;\r\n                            const currentStock = childProduct?.inventoryByBranch?.[order.branchSystemId] || 0;\r\n                            if (currentStock < requiredQty) {\r\n                                alert(`Không thể đóng gói: Sản phẩm \"${childProduct?.name}\" không đủ tồn kho (Có: ${currentStock}, Cần: ${requiredQty})`);\r\n                                return baseStore.getState();\r\n                            }\r\n                        }\r\n                    } else {\r\n                        const currentStock = product?.inventoryByBranch?.[order.branchSystemId] || 0;\r\n                        if (currentStock < item.quantity) {\r\n                            alert(`Không thể đóng gói: Sản phẩm \"${item.productName}\" không đủ tồn kho (Có: ${currentStock}, Cần: ${item.quantity})`);\r\n                            return baseStore.getState();\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        }\r\n\r\n        baseStore.setState(state => {\r\n            const dataCopy = [...state.data];\r\n            const orderIndex = dataCopy.findIndex(o => o.systemId === orderSystemId);\r\n            if (orderIndex === -1) return state;\r\n    \r\n        const orderCopy = { ...dataCopy[orderIndex] };\r\n            const packagingIndex = orderCopy.packagings.findIndex(p => p.systemId === packagingSystemId);\r\n            if (packagingIndex === -1) return state;\r\n            \r\n            const employee = useEmployeeStore.getState().findById(employeeId as SystemId);\r\n    \r\n        const packagingsCopy = [...orderCopy.packagings];\r\n            packagingsCopy[packagingIndex] = {\r\n                ...packagingsCopy[packagingIndex],\r\n                status: 'Đã đóng gói' as PackagingStatus,\r\n                confirmDate: toISODateTime(new Date()),\r\n                confirmingEmployeeId: employeeId,\r\n                confirmingEmployeeName: employee?.fullName || 'N/A',\r\n            };\r\n    \r\n        orderCopy.packagings = packagingsCopy;\r\n        orderCopy.deliveryStatus = 'Đã đóng gói' as OrderDeliveryStatus;\r\n            \r\n            dataCopy[orderIndex] = orderCopy;\r\n    \r\n        return { data: dataCopy };\r\n        });\r\n    },\r\n\r\n    cancelPackagingRequest: (orderSystemId: SystemId, packagingSystemId: SystemId, employeeId: SystemId, reason: string) => {\r\n        baseStore.setState(state => {\r\n             const order = state.data.find(o => o.systemId === orderSystemId);\r\n            if (!order) return state;\r\n            const employee = useEmployeeStore.getState().findById(employeeId as SystemId);\r\n\r\n            const updatedPackagings = order.packagings.map(p => {\r\n                if (p.systemId === packagingSystemId) {\r\n                    return {\r\n                        ...p,\r\n                        status: 'Hủy đóng gói' as PackagingStatus,\r\n                        cancelDate: toISODateTime(new Date()),\r\n                        cancelingEmployeeId: employeeId,\r\n                        cancelingEmployeeName: employee?.fullName || 'N/A',\r\n                        cancelReason: reason,\r\n                    };\r\n                }\r\n                return p;\r\n            });\r\n            const isAnyActivePackaging = updatedPackagings.some(p => p.status !== 'Hủy đóng gói');\r\n            const updatedOrder = { ...order, packagings: updatedPackagings, deliveryStatus: isAnyActivePackaging ? order.deliveryStatus : 'Chờ đóng gói' as OrderDeliveryStatus };\r\n            return { data: state.data.map(o => o.systemId === orderSystemId ? updatedOrder : o) };\r\n        });\r\n    },\r\n    \r\n    processInStorePickup: (orderSystemId: SystemId, packagingSystemId: SystemId) => {\r\n        baseStore.setState(state => {\r\n            const order = state.data.find(o => o.systemId === orderSystemId);\r\n            if (!order) return state;\r\n    \r\n            const totalCount = order.packagings.length;\r\n            const updatedPackagings = order.packagings.map((p, index) => {\r\n                if (p.systemId === packagingSystemId) {\r\n                    const hasId = typeof p.id === 'string' && p.id.trim().length > 0;\r\n                    const resolvedId = hasId ? p.id : buildPackagingBusinessId(order.id, index, totalCount);\r\n                    return {\r\n                        ...p,\r\n                        id: resolvedId,\r\n                        deliveryMethod: 'Nhận tại cửa hàng' as OrderDeliveryMethod,\r\n                        deliveryStatus: 'Đã đóng gói' as OrderDeliveryStatus,\r\n                        // trackingCode will be set when shipment is created in confirmInStorePickup\r\n                    };\r\n                }\r\n                return p;\r\n            });\r\n            \r\n            const updatedOrder = { \r\n                ...order, \r\n                packagings: updatedPackagings, \r\n                deliveryStatus: 'Đã đóng gói' as OrderDeliveryStatus \r\n            };\r\n    \r\n            return { data: state.data.map(o => o.systemId === orderSystemId ? updatedOrder : o) };\r\n        });\r\n    },\r\n    \r\n    confirmInStorePickup: (orderSystemId: SystemId, packagingSystemId: SystemId, employeeId: SystemId) => {\r\n        console.log('🟢 [confirmInStorePickup] Called with:', { orderSystemId, packagingSystemId, employeeId });\r\n        \r\n        // ✅ Check negative stock out setting\r\n        const { allowNegativeStockOut } = useSalesManagementSettingsStore.getState();\r\n        if (!allowNegativeStockOut) {\r\n            const order = baseStore.getState().data.find(o => o.systemId === orderSystemId);\r\n            if (order) {\r\n                const { findById: findProductById } = useProductStore.getState();\r\n                for (const item of order.lineItems) {\r\n                    const product = findProductById(asSystemId(item.productSystemId));\r\n                    \r\n                    if (product && isComboProduct(product) && product.comboItems) {\r\n                        for (const comboItem of product.comboItems) {\r\n                            const childProduct = findProductById(asSystemId(comboItem.productSystemId));\r\n                            const requiredQty = item.quantity * comboItem.quantity;\r\n                            const currentStock = childProduct?.inventoryByBranch?.[order.branchSystemId] || 0;\r\n                            if (currentStock < requiredQty) {\r\n                                alert(`Không thể xuất kho: Sản phẩm \"${childProduct?.name}\" không đủ tồn kho (Có: ${currentStock}, Cần: ${requiredQty})`);\r\n                                return baseStore.getState();\r\n                            }\r\n                        }\r\n                    } else {\r\n                        const currentStock = product?.inventoryByBranch?.[order.branchSystemId] || 0;\r\n                        if (currentStock < item.quantity) {\r\n                            alert(`Không thể xuất kho: Sản phẩm \"${item.productName}\" không đủ tồn kho (Có: ${currentStock}, Cần: ${item.quantity})`);\r\n                            return baseStore.getState();\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        }\r\n\r\n        baseStore.setState(state => {\r\n            const order = state.data.find(o => o.systemId === orderSystemId);\r\n            if (!order) {\r\n                console.error('❌ [confirmInStorePickup] Order not found:', orderSystemId);\r\n                return state;\r\n            }\r\n    \r\n            console.log('📋 [confirmInStorePickup] Order found:', order.id);\r\n            console.log('📋 [confirmInStorePickup] Line items:', order.lineItems.length);\r\n            \r\n            // Stock logic\r\n            const { addEntry: addStockHistory } = useStockHistoryStore.getState();\r\n            const employeeData = useEmployeeStore.getState().findById(employeeId as SystemId);\r\n            const now = toISODateTime(new Date());\r\n    \r\n            order.lineItems.forEach((item, index) => {\r\n                console.log(`📦 [confirmInStorePickup] Dispatching item ${index + 1}:`, {\r\n                    productSystemId: item.productSystemId,\r\n                    productName: item.productName,\r\n                    quantity: item.quantity,\r\n                    branchSystemId: getBranchId(order)\r\n                });\r\n                \r\n                // ✅ Dispatch stock (hỗ trợ combo - sẽ dispatch SP con)\r\n                const processedItems = processLineItemStock(item, getBranchId(order), 'dispatch', item.quantity);\r\n                \r\n                // ✅ Add stock history entry for each processed item (SP con nếu combo)\r\n                processedItems.forEach(processedItem => {\r\n                    const product = useProductStore.getState().findById(processedItem.productSystemId);\r\n                    const currentStock = product?.inventoryByBranch?.[getBranchId(order)] || 0;\r\n                    \r\n                    addStockHistory({\r\n                        date: now,\r\n                        productId: processedItem.productSystemId,\r\n                        action: 'Xuất kho (Đơn hàng)',\r\n                        quantityChange: -processedItem.quantity,\r\n                        newStockLevel: currentStock, // After dispatch\r\n                        documentId: order.id,\r\n                        branchSystemId: getBranchId(order),\r\n                        branch: order.branchName,\r\n                        employeeName: employeeData?.fullName || 'Hệ thống',\r\n                    });\r\n                });\r\n            });\r\n    \r\n            // Status update logic - will be updated with trackingCode after shipment creation\r\n            let updatedPackagings = order.packagings.map(p => {\r\n                if (p.systemId === packagingSystemId) {\r\n                    return { \r\n                        ...p, \r\n                        deliveryStatus: 'Đã giao hàng' as OrderDeliveryStatus, \r\n                        deliveredDate: toISODateTime(new Date()) \r\n                    };\r\n                }\r\n                return p;\r\n            });\r\n    \r\n            const isAllDelivered = updatedPackagings.every(p => p.status === 'Hủy đóng gói' || p.deliveryStatus === 'Đã giao hàng');\r\n            \r\n            let newStatus = order.status === 'Đặt hàng' ? 'Đang giao dịch' : order.status;\r\n            let newCompletedDate = order.completedDate;\r\n            if (isAllDelivered && order.paymentStatus === 'Thanh toán toàn bộ') {\r\n                newStatus = 'Hoàn thành';\r\n                newCompletedDate = toISODateTime(new Date());\r\n            }\r\n    \r\n            \r\n            const employee = useEmployeeStore.getState().findById(employeeId as SystemId);\r\n            \r\n            // ✅ Create shipment record for INSTORE pickup\r\n            const packaging = order.packagings.find(p => p.systemId === packagingSystemId);\r\n            let newShipment: Shipment | null = null;\r\n            if (packaging) {\r\n                const { createShipment, updateShipment } = useShipmentStore.getState();\r\n                newShipment = createShipment({\r\n                    packagingSystemId: packagingSystemId,\r\n                    orderSystemId: orderSystemId,\r\n                    orderId: order.id,\r\n                    trackingCode: '', // Will be set to shipment business ID below\r\n                    carrier: 'Nhận tại cửa hàng',\r\n                    service: 'Nhận tại cửa hàng',\r\n                    deliveryStatus: 'Đã giao hàng',\r\n                    printStatus: 'Chưa in',\r\n                    reconciliationStatus: 'Chưa đối soát',\r\n                    shippingFeeToPartner: 0,\r\n                    codAmount: 0,\r\n                    payer: 'Người gửi',\r\n                    createdAt: now,\r\n                    dispatchedAt: now,\r\n                    deliveredAt: now,\r\n                });\r\n                // Update shipment trackingCode to use its own business ID\r\n                if (newShipment) {\r\n                    updateShipment(newShipment.systemId, {\r\n                        trackingCode: newShipment.id, // Use shipment business ID (VC000XXX)\r\n                    });\r\n                    // Update packaging with shipment trackingCode\r\n                    updatedPackagings = updatedPackagings.map(p => {\r\n                        if (p.systemId === packagingSystemId) {\r\n                            return { ...p, trackingCode: newShipment!.id };\r\n                        }\r\n                        return p;\r\n                    });\r\n                }\r\n                console.log('✅ [confirmInStorePickup] Shipment created:', newShipment?.id);\r\n            }\r\n            \r\n            const updatedOrder = { \r\n                ...order, \r\n                packagings: updatedPackagings, \r\n                deliveryStatus: 'Đã giao hàng' as OrderDeliveryStatus,\r\n                status: newStatus,\r\n                completedDate: newCompletedDate,\r\n                stockOutStatus: 'Xuất kho toàn bộ' as const,\r\n                dispatchedDate: toISODateTime(new Date()),\r\n                dispatchedByEmployeeId: employeeId,\r\n                dispatchedByEmployeeName: employee?.fullName,\r\n            };\r\n    \r\n            console.log('✅ [confirmInStorePickup] Stock dispatched successfully');\r\n            return { data: state.data.map(o => o.systemId === orderSystemId ? updatedOrder : o) };\r\n        });\r\n    },    \r\n    confirmPartnerShipment: async (orderSystemId: SystemId, packagingSystemId: SystemId, shipmentData: any): Promise<{ success: boolean; message: string }> => {\r\n        try {\r\n            const order = baseStore.getState().data.find(o => o.systemId === orderSystemId);\r\n            if (!order) {\r\n                return { success: false, message: 'Không tìm thấy đơn hàng' };\r\n            }\r\n\r\n            // ✅ Check negative packing setting (covers creating shipment)\r\n            const { allowNegativePacking } = useSalesManagementSettingsStore.getState();\r\n            if (!allowNegativePacking) {\r\n                const { findById: findProductById } = useProductStore.getState();\r\n                for (const item of order.lineItems) {\r\n                    const product = findProductById(asSystemId(item.productSystemId));\r\n                    \r\n                    if (product && isComboProduct(product) && product.comboItems) {\r\n                        for (const comboItem of product.comboItems) {\r\n                            const childProduct = findProductById(asSystemId(comboItem.productSystemId));\r\n                            const requiredQty = item.quantity * comboItem.quantity;\r\n                            const currentStock = childProduct?.inventoryByBranch?.[order.branchSystemId] || 0;\r\n                            if (currentStock < requiredQty) {\r\n                                return { success: false, message: `Không thể tạo vận đơn: Sản phẩm \"${childProduct?.name}\" không đủ tồn kho` };\r\n                            }\r\n                        }\r\n                    } else {\r\n                        const currentStock = product?.inventoryByBranch?.[order.branchSystemId] || 0;\r\n                        if (currentStock < item.quantity) {\r\n                            return { success: false, message: `Không thể tạo vận đơn: Sản phẩm \"${item.productName}\" không đủ tồn kho` };\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n\r\n            // ✅ Get GHTK preview params from window (set by ShippingIntegration)\r\n            const ghtkParams = (window as any).__ghtkPreviewParams;\r\n            \r\n            if (!ghtkParams) {\r\n                return { success: false, message: 'Thiếu thông tin vận chuyển. Vui lòng chọn dịch vụ vận chuyển.' };\r\n            }\r\n\r\n            // ✅ Import GHTK service dynamically\r\n            const { GHTKService } = await import('../settings/shipping/integrations/ghtk-service');\r\n            const { getGHTKCredentials } = await import('../../lib/utils/get-shipping-credentials');\r\n            \r\n            const { apiToken, partnerCode } = getGHTKCredentials();\r\n            const ghtkService = new GHTKService(apiToken, partnerCode);\r\n\r\n            console.log('📤 [confirmPartnerShipment] Calling GHTK API with params:', ghtkParams);\r\n\r\n            // ✅ Call real GHTK API\r\n            const result = await ghtkService.createOrder(ghtkParams);\r\n\r\n            if (!result.success || !result.order) {\r\n                throw new Error(result.message || 'Không thể tạo đơn vận chuyển');\r\n            }\r\n\r\n            // ✅ Update order with real tracking code from GHTK\r\n            const trackingCode = result.order.label;\r\n            const ghtkTrackingId = result.order.tracking_id;\r\n            const estimatedPickTime = result.order.estimated_pick_time;\r\n            const estimatedDeliverTime = result.order.estimated_deliver_time;\r\n\r\n            baseStore.setState(state => {\r\n                const updatedPackagings = order.packagings.map(p => {\r\n                    if (p.systemId === packagingSystemId) {\r\n                        return {\r\n                            ...p,\r\n                            deliveryMethod: 'Dịch vụ giao hàng' as OrderDeliveryMethod,\r\n                            deliveryStatus: 'Chờ lấy hàng' as OrderDeliveryStatus,\r\n                            carrier: 'GHTK',\r\n                            service: result.order?.fee ? `${result.order.fee}đ` : 'Standard',\r\n                            trackingCode: trackingCode,\r\n                            shippingFeeToPartner: parseInt(result.order?.fee || '0') || 0,\r\n                            codAmount: ghtkParams.pick_money || 0,\r\n                            payer: (ghtkParams.is_freeship === 1 ? 'Người gửi' : 'Người nhận') as 'Người gửi' | 'Người nhận',\r\n                            noteToShipper: ghtkParams.note || '',\r\n                            weight: ghtkParams.weight,\r\n                            dimensions: `${ghtkParams.products?.[0]?.length || 10}×${ghtkParams.products?.[0]?.width || 10}×${ghtkParams.products?.[0]?.height || 10}`,\r\n                            // ✅ Store GHTK specific data\r\n                            ghtkTrackingId: String(ghtkTrackingId),\r\n                            estimatedPickTime: estimatedPickTime,\r\n                            estimatedDeliverTime: estimatedDeliverTime,\r\n                        };\r\n                    }\r\n                    return p;\r\n                });\r\n                \r\n                const updatedOrder = { \r\n                    ...order, \r\n                    packagings: updatedPackagings, \r\n                    deliveryStatus: 'Chờ lấy hàng' as OrderDeliveryStatus, \r\n                    status: 'Đang giao dịch' as OrderMainStatus \r\n                };\r\n                \r\n                return { data: state.data.map(o => o.systemId === orderSystemId ? updatedOrder : o) };\r\n            });\r\n\r\n            console.log('✅ [confirmPartnerShipment] GHTK order created successfully:', {\r\n                trackingCode,\r\n                ghtkTrackingId,\r\n                estimatedPickTime,\r\n                estimatedDeliverTime\r\n            });\r\n\r\n            return { \r\n                success: true, \r\n                message: `Tạo vận đơn thành công! Mã vận đơn: ${trackingCode}` \r\n            };\r\n\r\n        } catch (error) {\r\n            console.error('❌ [confirmPartnerShipment] Error:', error);\r\n            \r\n            let errorMessage = 'Vui lòng thử lại';\r\n            if (error instanceof Error) {\r\n                errorMessage = error.message;\r\n            }\r\n            \r\n            return { \r\n                success: false, \r\n                message: `Lỗi tạo đơn vận chuyển: ${errorMessage}` \r\n            };\r\n        }\r\n    },\r\n\r\n    dispatchFromWarehouse: (orderSystemId: SystemId, packagingSystemId: SystemId, employeeId: SystemId) => {\r\n        // ✅ Check negative stock out setting\r\n        const { allowNegativeStockOut } = useSalesManagementSettingsStore.getState();\r\n        if (!allowNegativeStockOut) {\r\n            const order = baseStore.getState().data.find(o => o.systemId === orderSystemId);\r\n            if (order) {\r\n                const { findById: findProductById } = useProductStore.getState();\r\n                for (const item of order.lineItems) {\r\n                    const product = findProductById(asSystemId(item.productSystemId));\r\n                    \r\n                    if (product && isComboProduct(product) && product.comboItems) {\r\n                        for (const comboItem of product.comboItems) {\r\n                            const childProduct = findProductById(asSystemId(comboItem.productSystemId));\r\n                            const requiredQty = item.quantity * comboItem.quantity;\r\n                            const currentStock = childProduct?.inventoryByBranch?.[order.branchSystemId] || 0;\r\n                            if (currentStock < requiredQty) {\r\n                                alert(`Không thể xuất kho: Sản phẩm \"${childProduct?.name}\" không đủ tồn kho (Có: ${currentStock}, Cần: ${requiredQty})`);\r\n                                return baseStore.getState();\r\n                            }\r\n                        }\r\n                    } else {\r\n                        const currentStock = product?.inventoryByBranch?.[order.branchSystemId] || 0;\r\n                        if (currentStock < item.quantity) {\r\n                            alert(`Không thể xuất kho: Sản phẩm \"${item.productName}\" không đủ tồn kho (Có: ${currentStock}, Cần: ${item.quantity})`);\r\n                            return baseStore.getState();\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        }\r\n\r\n        baseStore.setState(state => {\r\n            const order = state.data.find(o => o.systemId === orderSystemId);\r\n            if (!order) return state;\r\n\r\n            const { addEntry: addStockHistory } = useStockHistoryStore.getState();\r\n            const employeeData = useEmployeeStore.getState().findById(employeeId as SystemId);\r\n            const now = toISODateTime(new Date());\r\n            \r\n            order.lineItems.forEach(item => {\r\n                // ✅ Dispatch stock (hỗ trợ combo - sẽ dispatch SP con)\r\n                const processedItems = processLineItemStock(item, getBranchId(order), 'dispatch', item.quantity);\r\n                \r\n                // ✅ Add stock history entry for each processed item\r\n                processedItems.forEach(processedItem => {\r\n                    const product = useProductStore.getState().findById(processedItem.productSystemId);\r\n                    const currentStock = product?.inventoryByBranch?.[getBranchId(order)] || 0;\r\n                    \r\n                    addStockHistory({\r\n                        date: now,\r\n                        productId: processedItem.productSystemId,\r\n                        action: 'Xuất kho (Đơn hàng)',\r\n                        quantityChange: -processedItem.quantity,\r\n                        newStockLevel: currentStock,\r\n                        documentId: order.id,\r\n                        branchSystemId: getBranchId(order),\r\n                        branch: order.branchName,\r\n                        employeeName: employeeData?.fullName || 'Hệ thống',\r\n                    });\r\n                });\r\n            });\r\n            \r\n            const now2 = toISODateTime(new Date());\r\n            \r\n            const updatedPackagings = order.packagings.map(p => \r\n                p.systemId === packagingSystemId ? { ...p, deliveryStatus: 'Đang giao hàng' as OrderDeliveryStatus } : p\r\n            );\r\n\r\n            const updatedOrder = {\r\n                ...order,\r\n                packagings: updatedPackagings,\r\n                deliveryStatus: 'Đang giao hàng' as OrderDeliveryStatus,\r\n                stockOutStatus: 'Xuất kho toàn bộ' as const,\r\n                dispatchedDate: now2,\r\n                dispatchedByEmployeeId: employeeId,\r\n                dispatchedByEmployeeName: employeeData?.fullName,\r\n                status: order.status === 'Đặt hàng' ? 'Đang giao dịch' : order.status,\r\n            };\r\n            return { data: state.data.map(o => o.systemId === orderSystemId ? updatedOrder : o) };\r\n        });\r\n    },\r\n\r\n    completeDelivery: (orderSystemId: SystemId, packagingSystemId: SystemId, employeeId: SystemId) => {\r\n        baseStore.setState(state => {\r\n            const order = state.data.find(o => o.systemId === orderSystemId);\r\n            if (!order) return state;\r\n            \r\n            // ✅ Complete delivery (hỗ trợ combo - sẽ complete SP con)\r\n            order.lineItems.forEach(item => {\r\n                processLineItemStock(item, getBranchId(order), 'complete', item.quantity);\r\n            });\r\n\r\n            const updatedPackagings = order.packagings.map(p => \r\n                p.systemId === packagingSystemId ? { ...p, deliveryStatus: 'Đã giao hàng' as OrderDeliveryStatus, deliveredDate: toISODateTime(new Date()) } : p\r\n            );\r\n            \r\n            const isAllDelivered = updatedPackagings.every(p => p.status === 'Hủy đóng gói' || p.deliveryStatus === 'Đã giao hàng');\r\n            let newStatus = order.status;\r\n            let newCompletedDate = order.completedDate;\r\n            \r\n            // ✅ Khi tất cả đơn đã giao → tạo công nợ (nếu có) và cập nhật stats\r\n            if (isAllDelivered && order.status !== 'Hoàn thành') {\r\n                // Tính công nợ còn lại\r\n                const totalPaid = (order.payments || []).reduce((sum, p) => sum + p.amount, 0);\r\n                const debtAmount = Math.max(0, order.grandTotal - totalPaid);\r\n                \r\n                // ✅ Tạo công nợ CHỈ KHI giao hàng thành công\r\n                if (debtAmount > 0) {\r\n                    const { addDebtTransaction } = useCustomerStore.getState();\r\n                    const dueDate = new Date();\r\n                    dueDate.setDate(dueDate.getDate() + 30);\r\n                    addDebtTransaction(order.customerSystemId, {\r\n                        systemId: asSystemId(`DEBT_${order.systemId}`),\r\n                        orderId: order.id,\r\n                        orderDate: order.orderDate.split('T')[0],\r\n                        amount: debtAmount,\r\n                        dueDate: dueDate.toISOString().split('T')[0],\r\n                        isPaid: false,\r\n                        remainingAmount: debtAmount,\r\n                        notes: 'Công nợ từ đơn hàng đã giao thành công',\r\n                    });\r\n                }\r\n                \r\n                // Update customer stats\r\n                const { incrementOrderStats } = useCustomerStore.getState();\r\n                incrementOrderStats(order.customerSystemId, order.grandTotal);\r\n            }\r\n            \r\n            // Check if order is fully complete (delivered + fully paid)\r\n            if (isAllDelivered && order.paymentStatus === 'Thanh toán toàn bộ') {\r\n                newStatus = 'Hoàn thành';\r\n                newCompletedDate = toISODateTime(new Date());\r\n            }\r\n\r\n            const employee = useEmployeeStore.getState().findById(employeeId as SystemId);\r\n            const updatedOrder = { \r\n                ...order, \r\n                packagings: updatedPackagings, \r\n                deliveryStatus: 'Đã giao hàng' as OrderDeliveryStatus, \r\n                status: newStatus, \r\n                completedDate: newCompletedDate,\r\n                activityHistory: appendHistoryEntry(\r\n                    order.activityHistory,\r\n                    createHistoryEntry(\r\n                        'status_changed',\r\n                        getCurrentUserInfo(),\r\n                        `${employee?.fullName || 'Nhân viên'} đã xác nhận giao hàng thành công${newStatus === 'Hoàn thành' ? '. Đơn hàng hoàn thành' : ''}`\r\n                    )\r\n                ),\r\n            };\r\n            return { data: state.data.map(o => o.systemId === orderSystemId ? updatedOrder : o) };\r\n        });\r\n    },\r\n\r\n    failDelivery: (orderSystemId: SystemId, packagingSystemId: SystemId, employeeId: SystemId, reason: string) => {\r\n        baseStore.setState(state => {\r\n            const order = state.data.find(o => o.systemId === orderSystemId);\r\n            if (!order) return state;\r\n            const { incrementFailedDeliveryStats } = useCustomerStore.getState();\r\n            \r\n            // ✅ Return stock from transit (hỗ trợ combo - sẽ return SP con)\r\n            order.lineItems.forEach(item => {\r\n                processLineItemStock(item, getBranchId(order), 'return', item.quantity);\r\n            });\r\n\r\n            // ✅ Update customer failed delivery stats\r\n            incrementFailedDeliveryStats(order.customerSystemId);\r\n\r\n            const updatedPackagings = order.packagings.map(p => \r\n                p.systemId === packagingSystemId ? { ...p, deliveryStatus: 'Chờ giao lại' as OrderDeliveryStatus, notes: `Giao thất bại: ${reason}` } : p\r\n            );\r\n            \r\n            const updatedOrder = { ...order, packagings: updatedPackagings, deliveryStatus: 'Chờ giao lại' as OrderDeliveryStatus };\r\n            return { data: state.data.map(o => o.systemId === orderSystemId ? updatedOrder : o) };\r\n         });\r\n    },\r\n\r\n    // ✅ Hủy giao hàng - KHÔNG trả hàng về kho (hàng bị thất tung/shipper giữ)\r\n    cancelDeliveryOnly: (orderSystemId: SystemId, packagingSystemId: SystemId, employeeId: SystemId, reason: string) => {\r\n        const currentOrder = baseStore.getState().data.find(o => o.systemId === orderSystemId);\r\n        if (!ensureCancellationAllowed(currentOrder, 'hủy giao hàng')) {\r\n            return;\r\n        }\r\n\r\n        baseStore.setState(state => {\r\n            const order = state.data.find(o => o.systemId === orderSystemId);\r\n            if (!order) return state;\r\n\r\n            // ✅ Get employee info for canceller\r\n            const employeeData = useEmployeeStore.getState().findById(employeeId as SystemId);\r\n\r\n            const updatedPackagings = order.packagings.map(p => \r\n                p.systemId === packagingSystemId ? { \r\n                    ...p, \r\n                    status: 'Hủy đóng gói' as PackagingStatus,\r\n                    deliveryStatus: 'Đã hủy' as OrderDeliveryStatus,\r\n                    cancelReason: `Hủy giao hàng: ${reason}`, \r\n                    cancelDate: toISODateTime(new Date()),\r\n                    cancelingEmployeeId: employeeId,\r\n                    cancelingEmployeeName: employeeData?.fullName || 'Hệ thống',\r\n                } : p\r\n            );\r\n            \r\n            // ✅ Check if all packagings are cancelled, update order status accordingly\r\n            const allCancelled = updatedPackagings.every(p => p.deliveryStatus === 'Đã hủy' || p.status === 'Hủy đóng gói');\r\n            const hasAnyActive = updatedPackagings.some(p => p.deliveryStatus && p.deliveryStatus !== 'Đã hủy' && p.status !== 'Hủy đóng gói');\r\n            \r\n            let newOrderStatus = order.status;\r\n            let newDeliveryStatus = order.deliveryStatus;\r\n            \r\n            if (allCancelled) {\r\n                // All packagings cancelled → order goes back to pending state\r\n                newOrderStatus = 'Đang giao dịch' as OrderMainStatus;\r\n                newDeliveryStatus = 'Chưa giao hàng' as OrderDeliveryStatus;\r\n            } else if (hasAnyActive) {\r\n                // Some packagings still active → keep current delivery status of remaining active packaging\r\n                const activePackaging = updatedPackagings.find(p => p.deliveryStatus && p.deliveryStatus !== 'Đã hủy');\r\n                if (activePackaging?.deliveryStatus) {\r\n                    newDeliveryStatus = activePackaging.deliveryStatus;\r\n                }\r\n            }\r\n            \r\n            const updatedOrder = { \r\n                ...order, \r\n                packagings: updatedPackagings,\r\n                status: newOrderStatus,\r\n                deliveryStatus: newDeliveryStatus\r\n            };\r\n            return { data: state.data.map(o => o.systemId === orderSystemId ? updatedOrder : o) };\r\n         });\r\n    },\r\n\r\n    // ✅ Hủy giao và nhận lại hàng - TRẢ hàng về kho (đã nhận lại từ shipper)\r\n    cancelDelivery: (orderSystemId: SystemId, packagingSystemId: SystemId, employeeId: SystemId, reason: string) => {\r\n        const currentOrder = baseStore.getState().data.find(o => o.systemId === orderSystemId);\r\n        if (!ensureCancellationAllowed(currentOrder, 'hủy giao hàng')) {\r\n            return;\r\n        }\r\n\r\n         baseStore.setState(state => {\r\n            const order = state.data.find(o => o.systemId === orderSystemId);\r\n            if (!order) return state;\r\n            \r\n            // ✅ TRẢ hàng từ \"đang giao\" về \"tồn kho\" (hỗ trợ combo - sẽ return SP con)\r\n            order.lineItems.forEach(item => {\r\n                processLineItemStock(item, getBranchId(order), 'return', item.quantity);\r\n            });\r\n\r\n            // ✅ Get employee info for canceller\r\n            const employeeData = useEmployeeStore.getState().findById(employeeId as SystemId);\r\n\r\n            const updatedPackagings = order.packagings.map(p => \r\n                p.systemId === packagingSystemId ? { \r\n                    ...p, \r\n                    status: 'Hủy đóng gói' as PackagingStatus,\r\n                    deliveryStatus: 'Đã hủy' as OrderDeliveryStatus,\r\n                    cancelReason: `Hủy giao hàng: ${reason}`, \r\n                    cancelDate: toISODateTime(new Date()),\r\n                    cancelingEmployeeId: employeeId,\r\n                    cancelingEmployeeName: employeeData?.fullName || 'Hệ thống',\r\n                } : p\r\n            );\r\n            \r\n            // ✅ Check if all packagings are cancelled, update order status accordingly\r\n            const allCancelled = updatedPackagings.every(p => p.deliveryStatus === 'Đã hủy' || p.status === 'Hủy đóng gói');\r\n            const hasAnyActive = updatedPackagings.some(p => p.deliveryStatus && p.deliveryStatus !== 'Đã hủy' && p.status !== 'Hủy đóng gói');\r\n            \r\n            let newOrderStatus = order.status;\r\n            let newDeliveryStatus = order.deliveryStatus;\r\n            \r\n            if (allCancelled) {\r\n                // All packagings cancelled → order goes back to pending state\r\n                newOrderStatus = 'Đang giao dịch' as OrderMainStatus;\r\n                newDeliveryStatus = 'Chưa giao hàng' as OrderDeliveryStatus;\r\n            } else if (hasAnyActive) {\r\n                // Some packagings still active → keep current delivery status of remaining active packaging\r\n                const activePackaging = updatedPackagings.find(p => p.deliveryStatus && p.deliveryStatus !== 'Đã hủy');\r\n                if (activePackaging?.deliveryStatus) {\r\n                    newDeliveryStatus = activePackaging.deliveryStatus;\r\n                }\r\n            }\r\n            \r\n            const updatedOrder = { \r\n                ...order, \r\n                packagings: updatedPackagings,\r\n                status: newOrderStatus,\r\n                deliveryStatus: newDeliveryStatus\r\n            };\r\n            return { data: state.data.map(o => o.systemId === orderSystemId ? updatedOrder : o) };\r\n         });\r\n    },\r\n\r\n    confirmCodReconciliation: (shipments: (Packaging & { orderSystemId: SystemId })[], employeeId: SystemId) => {\r\n        const { add: addReceipt } = useReceiptStore.getState();\r\n        const { accounts } = useCashbookStore.getState();\r\n        const { data: receiptTypes } = useReceiptTypeStore.getState();\r\n        const employee = useEmployeeStore.getState().findById(employeeId as SystemId);\r\n        const allOrders = baseStore.getState().data;\r\n    \r\n        const totalByPartnerAndBranch: Record<string, { total: number; ids: string[]; branchSystemId: string; branchName: string; partnerName: string; shipmentSystemIds: string[] }> = {};\r\n    \r\n        shipments.forEach(shipment => {\r\n            const order = allOrders.find(o => o.systemId === shipment.orderSystemId);\r\n            if (!order || !shipment.carrier) return;\r\n    \r\n            const key = `${shipment.carrier}-${getBranchId(order)}`;\r\n            if (!totalByPartnerAndBranch[key]) {\r\n                totalByPartnerAndBranch[key] = { total: 0, ids: [], branchSystemId: getBranchId(order), branchName: order.branchName, partnerName: shipment.carrier, shipmentSystemIds: [] };\r\n            }\r\n            totalByPartnerAndBranch[key].total += shipment.codAmount || 0;\r\n            totalByPartnerAndBranch[key].ids.push(shipment.trackingCode || shipment.id);\r\n            totalByPartnerAndBranch[key].shipmentSystemIds.push(shipment.systemId);\r\n        });\r\n    \r\n        const createdReceipts: (any & { shipmentSystemIds: string[] })[] = [];\r\n    \r\n        Object.values(totalByPartnerAndBranch).forEach(group => {\r\n            const account = accounts.find(acc => acc.type === 'bank' && acc.branchSystemId === group.branchSystemId) || accounts.find(acc => acc.type === 'bank');\r\n            const category = receiptTypes.find(c => c.id === 'DOISOATCOD');\r\n            if (account && category) {\r\n                const newReceiptData = {\r\n                    id: '',\r\n                    date: toISODateTime(new Date()),\r\n                    amount: group.total,\r\n                    payerType: 'Đối tác vận chuyển',\r\n                    payerName: group.partnerName,\r\n                    description: `Đối soát COD cho các vận đơn: ${group.ids.join(', ')}`,\r\n                    paymentMethod: 'Chuyển khoản',\r\n                    accountSystemId: account.systemId,\r\n                    originalDocumentId: group.ids.join(', '),\r\n                    createdBy: employee?.fullName || 'N/A',\r\n                    branchSystemId: group.branchSystemId,\r\n                    branchName: group.branchName,\r\n                    paymentReceiptTypeSystemId: category.systemId,\r\n                    paymentReceiptTypeName: category.name,\r\n                    status: 'completed' as const,\r\n                    createdAt: toISODateTime(new Date()),\r\n                    updatedAt: toISODateTime(new Date()),\r\n                    affectsDebt: false,\r\n                };\r\n                const newReceipt = addReceipt(newReceiptData as any);\r\n                if (newReceipt) {\r\n                    createdReceipts.push({ ...newReceipt, shipmentSystemIds: group.shipmentSystemIds });\r\n                }\r\n            }\r\n        });\r\n    \r\n        baseStore.setState(state => {\r\n            const updates = new Map<string, { newPayments: OrderPayment[]; reconciledShipmentIds: string[] }>();\r\n    \r\n            shipments.forEach(shipment => {\r\n                const receiptForShipment = createdReceipts.find(v => v.shipmentSystemIds.includes(shipment.systemId));\r\n                if (!receiptForShipment || !shipment.codAmount || shipment.codAmount <= 0) return;\r\n    \r\n                const orderSystemId = shipment.orderSystemId;\r\n                const orderUpdates = updates.get(orderSystemId) || { newPayments: [], reconciledShipmentIds: [] };\r\n    \r\n                const newPayment: OrderPayment = {\r\n                    systemId: receiptForShipment.systemId,\r\n                    id: receiptForShipment.id,\r\n                    date: receiptForShipment.date,\r\n                    method: 'Đối soát COD',\r\n                    amount: shipment.codAmount || 0,\r\n                    createdBy: asSystemId('SYSTEM'),\r\n                    description: `Thanh toán COD cho vận đơn ${shipment.trackingCode || shipment.id}`,\r\n                };\r\n                orderUpdates.newPayments.push(newPayment);\r\n                orderUpdates.reconciledShipmentIds.push(shipment.systemId);\r\n                updates.set(orderSystemId, orderUpdates);\r\n            });\r\n    \r\n            if (updates.size === 0) return state;\r\n    \r\n            const newData = state.data.map(order => {\r\n                if (updates.has(order.systemId)) {\r\n                    const orderUpdates = updates.get(order.systemId)!;\r\n                    let updatedOrder = { ...order };\r\n\r\n                    updatedOrder.packagings = updatedOrder.packagings.map(p =>\r\n                        orderUpdates.reconciledShipmentIds.includes(p.systemId)\r\n                            ? { ...p, reconciliationStatus: 'Đã đối soát' as const }\r\n                            : p\r\n                    );\r\n\r\n                    for (const payment of orderUpdates.newPayments) {\r\n                        updatedOrder = applyPaymentToOrder(updatedOrder, payment);\r\n                    }\r\n    \r\n                    return updatedOrder;\r\n                }\r\n                return order;\r\n            });\r\n    \r\n            return { data: newData };\r\n        });\r\n    },\r\n\r\n    // ============================================\r\n    // GHTK INTEGRATION METHODS\r\n    // ============================================\r\n\r\n    /**\r\n     * Process GHTK webhook update\r\n     * Called when GHTK pushes status update or from tracking API\r\n     */\r\n    processGHTKWebhook: (webhookData: import('./types').GHTKWebhookPayload) => {\r\n        baseStore.setState(state => {\r\n            // Find order by tracking code or partner_id\r\n            const order = state.data.find(o => \r\n                o.packagings.some(p => \r\n                    p.trackingCode === webhookData.label_id || \r\n                    p.systemId === webhookData.partner_id ||\r\n                    o.systemId === webhookData.partner_id\r\n                )\r\n            );\r\n            \r\n            if (!order) {\r\n                console.warn('[GHTK Webhook] Order not found for:', {\r\n                    label_id: webhookData.label_id,\r\n                    partner_id: webhookData.partner_id\r\n                });\r\n                return state;\r\n            }\r\n            \r\n            // Import status mapping\r\n            const { getGHTKStatusInfo, getGHTKReasonText } = require('../../lib/ghtk-constants');\r\n            \r\n            const statusMapping = getGHTKStatusInfo(webhookData.status_id);\r\n            if (!statusMapping) {\r\n                console.warn('[GHTK Webhook] Unknown status:', webhookData.status_id);\r\n                return state;\r\n            }\r\n            \r\n            console.log('[GHTK Webhook] Processing update:', {\r\n                order: order.id,\r\n                trackingCode: webhookData.label_id,\r\n                statusId: webhookData.status_id,\r\n                statusText: statusMapping.statusText,\r\n                deliveryStatus: statusMapping.deliveryStatus\r\n            });\r\n            \r\n            // Update packaging with new status\r\n            const updatedPackagings = order.packagings.map(p => {\r\n                if (p.trackingCode !== webhookData.label_id && \r\n                    p.systemId !== webhookData.partner_id) {\r\n                    return p;\r\n                }\r\n                \r\n                return {\r\n                    ...p,\r\n                    deliveryStatus: statusMapping.deliveryStatus,\r\n                    partnerStatus: statusMapping.statusText,\r\n                    ghtkStatusId: webhookData.status_id,\r\n                    ghtkReasonCode: webhookData.reason_code,\r\n                    ghtkReasonText: webhookData.reason \r\n                        ? webhookData.reason \r\n                        : (webhookData.reason_code ? getGHTKReasonText(webhookData.reason_code) : undefined),\r\n                    actualWeight: webhookData.weight,\r\n                    actualFee: webhookData.fee,\r\n                    lastSyncedAt: toISODateTime(new Date()),\r\n                    // Update reconciliation status if status = 6 (Đã đối soát)\r\n                    reconciliationStatus: webhookData.status_id === 6 \r\n                        ? 'Đã đối soát' as const \r\n                        : p.reconciliationStatus,\r\n                    // Update delivered date if status = 5 or 6\r\n                    deliveredDate: [5, 6].includes(webhookData.status_id) && !p.deliveredDate\r\n                        ? toISODateTime(new Date())\r\n                        : p.deliveredDate,\r\n                };\r\n            });\r\n            \r\n            // Handle stock updates based on status\r\n            if (statusMapping.shouldUpdateStock && statusMapping.stockAction) {\r\n                const { dispatchStock, completeDelivery: productCompleteDelivery, returnStockFromTransit } = useProductStore.getState();\r\n                const { incrementFailedDeliveryStats } = useCustomerStore.getState();\r\n                \r\n                // ✅ Expand combo items to child products\r\n                const stockItems = getComboStockItems(order.lineItems);\r\n                \r\n                stockItems.forEach(item => {\r\n                    switch (statusMapping.stockAction) {\r\n                        case 'dispatch':\r\n                            // Status 3: Đã lấy hàng -> Move to transit\r\n                            dispatchStock(item.productSystemId, asSystemId(getBranchId(order)), item.quantity);\r\n                            break;\r\n                        case 'complete':\r\n                            // Status 5: Đã giao hàng -> Complete delivery\r\n                            productCompleteDelivery(item.productSystemId, asSystemId(getBranchId(order)), item.quantity);\r\n                            break;\r\n                        case 'return':\r\n                            // Status -1, 7, 9, 13, 20: Failed/Returned -> Return stock\r\n                            returnStockFromTransit(item.productSystemId, asSystemId(getBranchId(order)), item.quantity);\r\n                            break;\r\n                    }\r\n                });\r\n                \r\n                // ✅ Increment failed delivery stats for customer if return (moved outside loop)\r\n                if (statusMapping.stockAction === 'return') {\r\n                    const failureStatuses = [7, 9, 13, 20, 21];\r\n                    const currentPackaging = order.packagings.find(p => p.trackingCode === webhookData.label_id);\r\n                    const previousStatusId = currentPackaging?.ghtkStatusId;\r\n                    \r\n                    if (failureStatuses.includes(webhookData.status_id) && (!previousStatusId || !failureStatuses.includes(previousStatusId))) {\r\n                        incrementFailedDeliveryStats(order.customerSystemId);\r\n                    }\r\n                }\r\n                \r\n                console.log('[GHTK Webhook] Stock updated:', {\r\n                    action: statusMapping.stockAction,\r\n                    items: stockItems.length\r\n                });\r\n            }\r\n            \r\n            // Determine order-level delivery status\r\n            const allPackagingsDelivered = updatedPackagings.every(p => \r\n                p.status === 'Hủy đóng gói' || \r\n                p.deliveryStatus === 'Đã giao hàng'\r\n            );\r\n            \r\n            let newOrderDeliveryStatus = order.deliveryStatus;\r\n            let newOrderStatus = order.status;\r\n            let newCompletedDate = order.completedDate;\r\n            let newStockOutStatus = order.stockOutStatus;\r\n            \r\n            // Update order delivery status\r\n            if (allPackagingsDelivered) {\r\n                newOrderDeliveryStatus = 'Đã giao hàng';\r\n                \r\n                // Auto-complete order if delivered + paid\r\n                if (order.paymentStatus === 'Thanh toán toàn bộ' && order.status !== 'Hoàn thành') {\r\n                    newOrderStatus = 'Hoàn thành';\r\n                    newCompletedDate = toISODateTime(new Date());\r\n                    \r\n                    // Update customer stats\r\n                    const { incrementOrderStats } = useCustomerStore.getState();\r\n                    incrementOrderStats(order.customerSystemId, order.grandTotal);\r\n                    \r\n                    console.log('[GHTK Webhook] Order completed:', order.id);\r\n                }\r\n            } else if (statusMapping.statusId === 3) {\r\n                // Status 3: Đã lấy hàng\r\n                newOrderDeliveryStatus = 'Đang giao hàng';\r\n                newStockOutStatus = 'Xuất kho toàn bộ';\r\n            } else if ([4, 10].includes(statusMapping.statusId)) {\r\n                // Status 4, 10: Đang giao\r\n                newOrderDeliveryStatus = 'Đang giao hàng';\r\n            }\r\n            \r\n            const updatedOrder = {\r\n                ...order,\r\n                packagings: updatedPackagings,\r\n                deliveryStatus: newOrderDeliveryStatus,\r\n                status: newOrderStatus,\r\n                completedDate: newCompletedDate,\r\n                stockOutStatus: newStockOutStatus,\r\n            };\r\n            \r\n            return {\r\n                data: state.data.map(o => o.systemId === order.systemId ? updatedOrder : o)\r\n            };\r\n        });\r\n    },\r\n\r\n    /**\r\n     * Cancel GHTK shipment\r\n     * ⚠️ Chỉ hủy được khi đơn ở trạng thái: 1, 2, 12 (Chưa tiếp nhận, Đã tiếp nhận, Đang lấy hàng)\r\n     */\r\n    cancelGHTKShipment: async (orderSystemId: SystemId, packagingSystemId: SystemId, trackingCode: string) => {\r\n        try {\r\n            console.log('[GHTK] Cancelling shipment:', trackingCode);\r\n            \r\n            // ✅ Lấy credentials từ shipping_partners_config\r\n            const { getGHTKCredentials } = await import('../../lib/utils/get-shipping-credentials');\r\n            let credentials;\r\n            \r\n            try {\r\n                credentials = getGHTKCredentials();\r\n            } catch (error: any) {\r\n                return {\r\n                    success: false,\r\n                    message: error.message || 'Chưa cấu hình GHTK. Vui lòng vào Cài đặt → Đối tác vận chuyển.'\r\n                };\r\n            }\r\n            \r\n            const response = await fetch(getApiUrl('/shipping/ghtk/cancel-order'), {\r\n                method: 'POST',\r\n                headers: {\r\n                    'Content-Type': 'application/json',\r\n                },\r\n                body: JSON.stringify({\r\n                    trackingCode,\r\n                    apiToken: credentials.apiToken,\r\n                    partnerCode: credentials.partnerCode,\r\n                }),\r\n            });\r\n            \r\n            const data = await response.json();\r\n            \r\n            // ✅ Kiểm tra response từ GHTK\r\n            if (!response.ok) {\r\n                throw new Error(data.message || data.error || 'Failed to cancel GHTK shipment');\r\n            }\r\n            \r\n            // ✅ GHTK trả success: false khi không thể hủy (đã lấy hàng)\r\n            if (data.success === false) {\r\n                console.log('[GHTK] Cannot cancel:', data.message);\r\n                return { \r\n                    success: false, \r\n                    message: data.message || 'Không thể hủy đơn hàng' \r\n                };\r\n            }\r\n            \r\n            console.log('[GHTK] Cancellation successful:', data.message);\r\n            \r\n            // ✅ CHỈ update state khi GHTK xác nhận hủy thành công\r\n            baseStore.setState(state => {\r\n                const order = state.data.find(o => o.systemId === orderSystemId);\r\n                if (!order) return state;\r\n                \r\n                const updatedPackagings = order.packagings.map(p => {\r\n                    if (p.systemId !== packagingSystemId) return p;\r\n                    \r\n                    return {\r\n                        ...p,\r\n                        status: 'Hủy đóng gói' as PackagingStatus,\r\n                        deliveryStatus: 'Đã hủy' as OrderDeliveryStatus,\r\n                        cancelDate: toISODateTime(new Date()),\r\n                        cancelReason: 'Hủy vận đơn GHTK',\r\n                        ghtkStatusId: -1,\r\n                        partnerStatus: 'Hủy đơn hàng',\r\n                    };\r\n                });\r\n                \r\n                // ✅ KHÔNG rollback stock - để user tự quyết định (nút \"Hủy giao và nhận lại hàng\")\r\n                \r\n                const updatedOrder = {\r\n                    ...order,\r\n                    packagings: updatedPackagings,\r\n                };\r\n                \r\n                return {\r\n                    data: state.data.map(o => o.systemId === orderSystemId ? updatedOrder : o)\r\n                };\r\n            });\r\n            \r\n            return { \r\n                success: true, \r\n                message: data.message || 'Đã hủy vận đơn GHTK thành công' \r\n            };\r\n            \r\n        } catch (error: any) {\r\n            console.error('[GHTK] Cancel error:', error);\r\n            return { \r\n                success: false, \r\n                message: error.message || 'Lỗi khi hủy vận đơn GHTK' \r\n            };\r\n        }\r\n    },\r\n};\r\n\r\n// Auto-allocate historical receipts on startup\r\nuseReceiptStore.getState().data.forEach(receipt => {\r\n    autoAllocateReceiptToOrders(receipt);\r\n});\r\n\r\n// React to newly created receipts\r\nuseReceiptStore.subscribe(\r\n    state => state.data,\r\n    (currentReceipts, previousReceipts) => {\r\n        const previousIds = new Set((previousReceipts ?? []).map(r => r.systemId));\r\n        currentReceipts.forEach(receipt => {\r\n            if (!previousIds.has(receipt.systemId)) {\r\n                autoAllocateReceiptToOrders(receipt);\r\n            }\r\n        });\r\n    }\r\n);\r\n\r\n\r\n// Export typed hook with all augmented methods\r\nexport const useOrderStore = (): any => {\r\n  const state = baseStore();\r\n  return {\r\n    ...state,\r\n    ...augmentedMethods,\r\n  };\r\n};\r\n\r\n// Export getState for non-hook usage\r\nuseOrderStore.getState = (): any => {\r\n  const state = baseStore.getState();\r\n  return {\r\n    ...state,\r\n    ...augmentedMethods,\r\n  };\r\n};\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 8083, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/attendance/store.ts"],"sourcesContent":["import { create } from 'zustand';\r\nimport type { AttendanceDataRow, AttendanceDayKey, DailyRecord } from './types';\r\nimport type { SystemId } from '../../lib/id-types';\r\n\r\n// API sync helper\r\nasync function syncToAPI(action: 'save' | 'lock' | 'unlock', data: any): Promise<boolean> {\r\n  try {\r\n    const endpoint = '/api/attendance';\r\n    const method = action === 'save' ? 'POST' : 'PATCH';\r\n    \r\n    const response = await fetch(endpoint, {\r\n      method,\r\n      headers: { 'Content-Type': 'application/json' },\r\n      body: JSON.stringify({ action, ...data }),\r\n    });\r\n    \r\n    if (!response.ok) {\r\n      console.error(`[Attendance API] ${action} failed:`, await response.text());\r\n      return false;\r\n    }\r\n    return true;\r\n  } catch (error) {\r\n    console.error(`[Attendance API] ${action} error:`, error);\r\n    return false;\r\n  }\r\n}\r\n\r\nasync function fetchFromAPI(monthKey: string): Promise<AttendanceDataRow[] | null> {\r\n  try {\r\n    const [year, month] = monthKey.split('-');\r\n    const fromDate = `${year}-${month}-01`;\r\n    const lastDay = new Date(parseInt(year), parseInt(month), 0).getDate();\r\n    const toDate = `${year}-${month}-${lastDay}`;\r\n    \r\n    // Attendance is filtered by month, so 500 records should cover most cases\r\n    const response = await fetch(`/api/attendance?fromDate=${fromDate}&toDate=${toDate}&limit=500`);\r\n    if (!response.ok) return null;\r\n    \r\n    const json = await response.json();\r\n    return json.data || null;\r\n  } catch (error) {\r\n    console.error('[Attendance API] fetch error:', error);\r\n    return null;\r\n  }\r\n}\r\n\r\ntype AttendanceStoreState = {\r\n  lockedMonths: Record<string, boolean>; // key: \"YYYY-MM\"\r\n  toggleLock: (monthYear: string) => void;\r\n  lockMonth: (monthYear: string) => void;\r\n  unlockMonth: (monthYear: string) => void;\r\n  \r\n  // Data storage\r\n  attendanceData: Record<string, AttendanceDataRow[]>; // key: \"YYYY-MM\"\r\n  saveAttendanceData: (monthKey: string, data: AttendanceDataRow[]) => void;\r\n  getAttendanceData: (monthKey: string) => AttendanceDataRow[] | null;\r\n  updateEmployeeRecord: (\r\n    monthKey: string,\r\n    employeeSystemId: SystemId,\r\n    dayKey: AttendanceDayKey,\r\n    record: DailyRecord\r\n  ) => void;\r\n  \r\n  // API sync\r\n  loadFromAPI: (monthKey: string) => Promise<void>;\r\n  initialized: boolean;\r\n};\r\n\r\nexport const useAttendanceStore = create<AttendanceStoreState>()(\r\n  (set, get) => ({\r\n      lockedMonths: {},\r\n      initialized: false,\r\n      \r\n      lockMonth: (monthYear) => {\r\n        set((state) => ({\r\n          lockedMonths: {\r\n            ...state.lockedMonths,\r\n            [monthYear]: true,\r\n          },\r\n        }));\r\n        // Sync to API\r\n        syncToAPI('lock', { monthYear }).catch(console.error);\r\n      },\r\n      unlockMonth: (monthYear) => {\r\n        set((state) => {\r\n          if (!state.lockedMonths[monthYear]) {\r\n            return state;\r\n          }\r\n          const nextLocked = { ...state.lockedMonths };\r\n          delete nextLocked[monthYear];\r\n          return { lockedMonths: nextLocked };\r\n        });\r\n        // Sync to API\r\n        syncToAPI('unlock', { monthYear }).catch(console.error);\r\n      },\r\n      toggleLock: (monthYear) => {\r\n        const isLocked = Boolean(get().lockedMonths[monthYear]);\r\n        if (isLocked) {\r\n          get().unlockMonth(monthYear);\r\n        } else {\r\n          get().lockMonth(monthYear);\r\n        }\r\n      },\r\n      \r\n      // Data management\r\n      attendanceData: {},\r\n      saveAttendanceData: (monthKey, data) => {\r\n        set((state) => ({\r\n          attendanceData: {\r\n            ...state.attendanceData,\r\n            [monthKey]: data,\r\n          },\r\n        }));\r\n        // Sync to API\r\n        syncToAPI('save', { monthKey, data }).catch(console.error);\r\n      },\r\n      getAttendanceData: (monthKey) => {\r\n        return get().attendanceData[monthKey] || null;\r\n      },\r\n      updateEmployeeRecord: (monthKey, employeeSystemId, dayKey, record) => {\r\n        set((state) => {\r\n          const monthData = state.attendanceData[monthKey];\r\n          if (!monthData) return state;\r\n          \r\n          const updatedData = monthData.map(emp => {\r\n            if (emp.employeeSystemId === employeeSystemId) {\r\n              return { ...emp, [dayKey]: record };\r\n            }\r\n            return emp;\r\n          });\r\n          \r\n          return {\r\n            attendanceData: {\r\n              ...state.attendanceData,\r\n              [monthKey]: updatedData,\r\n            },\r\n          };\r\n        });\r\n        // Sync single record to API\r\n        syncToAPI('save', { monthKey, employeeSystemId, dayKey, record }).catch(console.error);\r\n      },\r\n      \r\n      // Load from API\r\n      loadFromAPI: async (monthKey: string) => {\r\n        const apiData = await fetchFromAPI(monthKey);\r\n        if (apiData && apiData.length > 0) {\r\n          set((state) => ({\r\n            attendanceData: {\r\n              ...state.attendanceData,\r\n              [monthKey]: apiData,\r\n            },\r\n            initialized: true,\r\n          }));\r\n        }\r\n      },\r\n    })\r\n);\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 8238, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/attendance/utils.ts"],"sourcesContent":["import { formatDate, formatDateTime, formatDateTimeSeconds, formatDateCustom, parseDate, getCurrentDate, toISODate, isValidDate, isDateAfter, getStartOfDay, getEndOfDay, getDayOfWeek } from '../../lib/date-utils';\r\nimport type { AttendanceDataRow, DailyRecord, AnyAttendanceDataRow } from './types';\r\nimport type { EmployeeSettings } from '../settings/employees/types';\r\nimport type { Employee } from '../employees/types';\r\nimport type { SystemId, BusinessId } from '../../lib/id-types';\r\n\r\n/**\r\n * Initialize empty attendance data for employees\r\n * Creates attendance rows with default status (weekend/absent) based on working days\r\n * NO mock data - just empty structure ready for real data input\r\n */\r\nexport function initializeEmptyAttendance(\r\n  employees: Employee[],\r\n  year: number,\r\n  month: number,\r\n  settings: EmployeeSettings\r\n): AttendanceDataRow[] {\r\n  const daysInMonth = new Date(year, month, 0).getDate();\r\n  \r\n  return employees.map((emp) => {\r\n    const row: AnyAttendanceDataRow = {\r\n      systemId: emp.systemId,\r\n      employeeSystemId: emp.systemId,\r\n      employeeId: emp.id,\r\n      fullName: emp.fullName,\r\n      department: emp.department,\r\n      workDays: 0,\r\n      leaveDays: 0,\r\n      absentDays: 0,\r\n      lateArrivals: 0,\r\n      earlyDepartures: 0,\r\n      otHours: 0,\r\n      otHoursWeekday: 0,\r\n      otHoursWeekend: 0,\r\n      otHoursHoliday: 0,\r\n    };\r\n\r\n    // Initialize each day with default status\r\n    for (let d = 1; d <= daysInMonth; d++) {\r\n      const workDate = new Date(year, month - 1, d);\r\n      const dayOfWeek = getDayOfWeek(workDate);\r\n      const isWorkingDay = dayOfWeek !== null && settings.workingDays.includes(dayOfWeek);\r\n      \r\n      row[`day_${d}`] = {\r\n        status: isWorkingDay ? 'absent' : 'weekend',\r\n      };\r\n    }\r\n\r\n    return row as AttendanceDataRow;\r\n  });\r\n}\r\n\r\n// Function to convert Excel serial time number to HH:mm format\r\nexport function excelSerialToTime(serial: any): string {\r\n    if (typeof serial === 'string') {\r\n        // If it's already a time string, just ensure format\r\n        const parts = serial.split(':');\r\n        if (parts.length >= 2) {\r\n            return `${parts[0].padStart(2, '0')}:${parts[1].padStart(2, '0')}`;\r\n        }\r\n        return '';\r\n    }\r\n    if (typeof serial !== 'number' || serial < 0 || serial > 1) {\r\n        // It might be a Date object from cellDates:true\r\n        if (serial instanceof Date) {\r\n            // Use local time (getHours/getMinutes) for Vietnam timezone GMT+7\r\n            const hours = serial.getHours();\r\n            const minutes = serial.getMinutes();\r\n            return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;\r\n        }\r\n        return ''; // Invalid time serial\r\n    }\r\n    const totalSeconds = Math.round(serial * 86400);\r\n    const hours = Math.floor(totalSeconds / 3600);\r\n    const minutes = Math.floor((totalSeconds % 3600) / 60);\r\n    return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;\r\n}\r\n\r\n\r\nexport function recalculateSummary(\r\n    row: AnyAttendanceDataRow, \r\n    year: number, \r\n    month: number, \r\n    settings: EmployeeSettings\r\n): Pick<AttendanceDataRow, 'workDays' | 'leaveDays' | 'absentDays' | 'lateArrivals' | 'earlyDepartures' | 'otHours' | 'otHoursWeekday' | 'otHoursWeekend' | 'otHoursHoliday'> {\r\n    let totalWorkMinutes = 0; // Tổng phút làm việc trong giờ hành chính (8:30-18:00)\r\n    let leaveDays = 0;\r\n    let absentDays = 0;\r\n    let lateArrivals = 0;\r\n    let earlyDepartures = 0;\r\n    \r\n    // OT theo loại ngày\r\n    let otMinutesWeekday = 0;  // Làm thêm ngày thường (sau 18h)\r\n    let otMinutesWeekend = 0;  // Làm thêm cuối tuần\r\n    let otMinutesHoliday = 0;  // Làm thêm ngày lễ\r\n    \r\n    const daysInMonth = new Date(year, month, 0).getDate();\r\n    \r\n    // Tính số giờ làm việc tiêu chuẩn 1 ngày (trừ nghỉ trưa)\r\n    // VD: 8:30-18:00 = 9.5h, trừ nghỉ trưa 1.5h = 8h\r\n    const workStartParts = settings.workStartTime.split(':').map(Number);\r\n    const workEndParts = settings.workEndTime.split(':').map(Number);\r\n    const workStartMinutes = workStartParts[0] * 60 + workStartParts[1];\r\n    const workEndMinutes = workEndParts[0] * 60 + workEndParts[1];\r\n    const standardDayMinutes = workEndMinutes - workStartMinutes - settings.lunchBreakDuration;\r\n    \r\n    // Lấy giờ nghỉ trưa từ settings (nếu có), fallback về hardcode\r\n    const lunchStartParts = (settings.lunchBreakStart || '12:00').split(':').map(Number);\r\n    const lunchEndParts = (settings.lunchBreakEnd || '13:30').split(':').map(Number);\r\n    const lunchStartMinutes = lunchStartParts[0] * 60 + lunchStartParts[1];\r\n    const lunchEndMinutes = lunchEndParts[0] * 60 + lunchEndParts[1];\r\n\r\n    for (let d = 1; d <= daysInMonth; d++) {\r\n        const record = row[`day_${d}`] as DailyRecord;\r\n        const workDate = new Date(year, month - 1, d);\r\n        const dayOfWeek = getDayOfWeek(workDate);\r\n        const isWorkingDay = dayOfWeek !== null && settings.workingDays.includes(dayOfWeek);\r\n        const isWeekend = dayOfWeek === 0 || dayOfWeek === 6; // CN = 0, T7 = 6\r\n        const isHoliday = record?.status === 'holiday';\r\n\r\n        if (record) {\r\n            // Xử lý cho ngày làm việc (thứ 2-6)\r\n            if (isWorkingDay) {\r\n                // Tính giờ làm việc thực tế từ checkIn/checkOut\r\n                if (record.checkIn && record.checkOut) {\r\n                    const workDateStr = toISODate(workDate);\r\n                    const checkInTime = new Date(`${workDateStr}T${record.checkIn}`);\r\n                    const checkOutTime = new Date(`${workDateStr}T${record.checkOut}`);\r\n                    \r\n                    if (isValidDate(checkInTime) && isValidDate(checkOutTime) && isDateAfter(checkOutTime, checkInTime)) {\r\n                        const checkInMins = checkInTime.getHours() * 60 + checkInTime.getMinutes();\r\n                        const checkOutMins = checkOutTime.getHours() * 60 + checkOutTime.getMinutes();\r\n                        \r\n                        // ===== TÍNH GIỜ CÔNG (trong giờ hành chính 8:30-18:00) =====\r\n                        // Giờ vào tính công = max(checkIn, workStart)\r\n                        const effectiveStartMins = Math.max(checkInMins, workStartMinutes);\r\n                        // Giờ ra tính công = min(checkOut, workEnd)\r\n                        const effectiveEndMins = Math.min(checkOutMins, workEndMinutes);\r\n                        \r\n                        let workedMinutes = effectiveEndMins - effectiveStartMins;\r\n                        \r\n                        // Trừ nghỉ trưa nếu làm qua giờ nghỉ trưa\r\n                        if (effectiveStartMins < lunchStartMinutes && effectiveEndMins > lunchEndMinutes) {\r\n                            workedMinutes -= settings.lunchBreakDuration;\r\n                        } else if (effectiveStartMins < lunchEndMinutes && effectiveEndMins > lunchStartMinutes) {\r\n                            // Nếu chỉ chạm 1 phần giờ nghỉ trưa\r\n                            const overlapStart = Math.max(effectiveStartMins, lunchStartMinutes);\r\n                            const overlapEnd = Math.min(effectiveEndMins, lunchEndMinutes);\r\n                            workedMinutes -= Math.max(0, overlapEnd - overlapStart);\r\n                        }\r\n                        \r\n                        totalWorkMinutes += Math.max(0, workedMinutes);\r\n                        \r\n                        // ===== TÍNH GIỜ LÀM THÊM (sau giờ tan làm 18:00) =====\r\n                        if (checkOutMins > workEndMinutes) {\r\n                            const otMinutes = checkOutMins - workEndMinutes;\r\n                            if (isHoliday) {\r\n                                otMinutesHoliday += otMinutes;\r\n                            } else {\r\n                                otMinutesWeekday += otMinutes;\r\n                            }\r\n                        }\r\n                        \r\n                        // Early departure calculation - ra trước giờ tan làm\r\n                        if (checkOutMins < workEndMinutes) {\r\n                            earlyDepartures++;\r\n                        }\r\n                    }\r\n                }\r\n                \r\n                // Đếm ngày nghỉ phép\r\n                if (record.status === 'leave') {\r\n                    leaveDays += 1;\r\n                }\r\n\r\n                // Late arrival calculation\r\n                if (record.checkIn) {\r\n                    const workDateStr = toISODate(workDate);\r\n                    const checkInTime = new Date(`${workDateStr}T${record.checkIn}`);\r\n                    const workStartTime = new Date(`${workDateStr}T${settings.workStartTime}`);\r\n                    const allowedLateTime = new Date(workStartTime.getTime() + settings.allowedLateMinutes * 60000);\r\n\r\n                    if (isDateAfter(checkInTime, allowedLateTime)) {\r\n                        lateArrivals++;\r\n                    }\r\n                }\r\n            }\r\n            \r\n            // ===== XỬ LÝ LÀM THÊM CUỐI TUẦN / NGÀY LỄ =====\r\n            // Nếu là cuối tuần hoặc ngày lễ mà có checkIn/checkOut → tính toàn bộ là OT\r\n            if ((isWeekend || isHoliday) && record.checkIn && record.checkOut) {\r\n                const workDateStr = toISODate(workDate);\r\n                const checkInTime = new Date(`${workDateStr}T${record.checkIn}`);\r\n                const checkOutTime = new Date(`${workDateStr}T${record.checkOut}`);\r\n                \r\n                if (isValidDate(checkInTime) && isValidDate(checkOutTime) && isDateAfter(checkOutTime, checkInTime)) {\r\n                    let otMinutes = (checkOutTime.getTime() - checkInTime.getTime()) / 60000;\r\n                    \r\n                    // Trừ nghỉ trưa nếu làm qua trưa\r\n                    const checkInMins = checkInTime.getHours() * 60 + checkInTime.getMinutes();\r\n                    const checkOutMins = checkOutTime.getHours() * 60 + checkOutTime.getMinutes();\r\n                    if (checkInMins < lunchStartMinutes && checkOutMins > lunchEndMinutes) {\r\n                        otMinutes -= settings.lunchBreakDuration;\r\n                    }\r\n                    \r\n                    if (isHoliday) {\r\n                        otMinutesHoliday += Math.max(0, otMinutes);\r\n                    } else {\r\n                        otMinutesWeekend += Math.max(0, otMinutes);\r\n                    }\r\n                }\r\n            }\r\n            \r\n            // OT từ cột overtimeCheckIn/overtimeCheckOut riêng (nếu có)\r\n            if (record.overtimeCheckIn && record.overtimeCheckOut) {\r\n                const workDateStr = toISODate(workDate);\r\n                const otStartDate = new Date(`${workDateStr}T${record.overtimeCheckIn}`);\r\n                const otEndDate = new Date(`${workDateStr}T${record.overtimeCheckOut}`);\r\n                if (isValidDate(otStartDate) && isValidDate(otEndDate) && isDateAfter(otEndDate, otStartDate)) {\r\n                    const diffInMinutes = (otEndDate.getTime() - otStartDate.getTime()) / 60000;\r\n                    if (isHoliday) {\r\n                        otMinutesHoliday += diffInMinutes;\r\n                    } else if (isWeekend) {\r\n                        otMinutesWeekend += diffInMinutes;\r\n                    } else {\r\n                        otMinutesWeekday += diffInMinutes;\r\n                    }\r\n                }\r\n            }\r\n        }\r\n    }\r\n    \r\n    // Tính số công = Tổng giờ làm / Giờ tiêu chuẩn 1 ngày (tối đa = số ngày làm việc trong tháng)\r\n    const workDays = standardDayMinutes > 0 \r\n        ? parseFloat((totalWorkMinutes / standardDayMinutes).toFixed(2))\r\n        : 0;\r\n    \r\n    // Tính ngày vắng = Tổng ngày làm việc trong tháng - ngày có công - ngày phép\r\n    const totalWorkingDaysInMonth = Array.from({ length: daysInMonth }, (_, i) => {\r\n        const d = new Date(year, month - 1, i + 1);\r\n        const dow = getDayOfWeek(d);\r\n        return dow !== null && settings.workingDays.includes(dow) ? 1 : 0;\r\n    }).reduce((a, b) => a + b, 0);\r\n    \r\n    absentDays = Math.max(0, totalWorkingDaysInMonth - Math.ceil(workDays) - leaveDays);\r\n    \r\n    // Convert OT từ phút sang giờ\r\n    const otHoursWeekday = parseFloat((otMinutesWeekday / 60).toFixed(2));\r\n    const otHoursWeekend = parseFloat((otMinutesWeekend / 60).toFixed(2));\r\n    const otHoursHoliday = parseFloat((otMinutesHoliday / 60).toFixed(2));\r\n    const otHours = parseFloat((otHoursWeekday + otHoursWeekend + otHoursHoliday).toFixed(2));\r\n    \r\n    return {\r\n        workDays,\r\n        leaveDays,\r\n        absentDays,\r\n        lateArrivals,\r\n        earlyDepartures,\r\n        otHours,\r\n        otHoursWeekday,\r\n        otHoursWeekend,\r\n        otHoursHoliday,\r\n    };\r\n}\r\n\r\n/**\r\n * Tính tiền làm thêm (OT) dựa trên số giờ và cài đặt\r\n * \r\n * Công thức:\r\n * - Ngày thường: otHoursWeekday * otHourlyRate (VNĐ/giờ)\r\n * - Cuối tuần: otHoursWeekend * otHourlyRate * otRateWeekend (hệ số 1.5)\r\n * - Ngày lễ: otHoursHoliday * otHourlyRate * otRateHoliday (hệ số 3)\r\n * \r\n * VD: settings.otHourlyRate = 25000, otRateWeekend = 1.5, otRateHoliday = 3\r\n * - 2 giờ OT ngày thường = 2 * 25000 = 50,000 VNĐ\r\n * - 2 giờ OT cuối tuần = 2 * 25000 * 1.5 = 75,000 VNĐ\r\n * - 2 giờ OT ngày lễ = 2 * 25000 * 3 = 150,000 VNĐ\r\n */\r\nexport function calculateOvertimePay(\r\n    otHoursWeekday: number,\r\n    otHoursWeekend: number,\r\n    otHoursHoliday: number,\r\n    settings: EmployeeSettings\r\n): {\r\n    weekdayPay: number;\r\n    weekendPay: number;\r\n    holidayPay: number;\r\n    totalOtPay: number;\r\n} {\r\n    const hourlyRate = settings.otHourlyRate || 0;\r\n    \r\n    // Ngày thường: tiền/giờ * số giờ\r\n    const weekdayPay = otHoursWeekday * hourlyRate;\r\n    \r\n    // Cuối tuần: tiền/giờ * hệ số cuối tuần * số giờ\r\n    const weekendPay = otHoursWeekend * hourlyRate * (settings.otRateWeekend || 1.5);\r\n    \r\n    // Ngày lễ: tiền/giờ * hệ số ngày lễ * số giờ  \r\n    const holidayPay = otHoursHoliday * hourlyRate * (settings.otRateHoliday || 3);\r\n    \r\n    const totalOtPay = weekdayPay + weekendPay + holidayPay;\r\n    \r\n    return {\r\n        weekdayPay: Math.round(weekdayPay),\r\n        weekendPay: Math.round(weekendPay),\r\n        holidayPay: Math.round(holidayPay),\r\n        totalOtPay: Math.round(totalOtPay),\r\n    };\r\n}\r\n\r\n/**\r\n * Tính tiền OT từ AttendanceDataRow\r\n */\r\nexport function calculateOvertimePayFromRow(\r\n    row: AttendanceDataRow,\r\n    settings: EmployeeSettings\r\n): ReturnType<typeof calculateOvertimePay> {\r\n    return calculateOvertimePay(\r\n        row.otHoursWeekday || 0,\r\n        row.otHoursWeekend || 0,\r\n        row.otHoursHoliday || 0,\r\n        settings\r\n    );\r\n}"],"names":[],"mappings":"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"}},
    {"offset": {"line": 8487, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/leaves/leave-sync-service.ts"],"sourcesContent":["import type { LeaveRequest } from './types';\r\nimport type { AttendanceDayKey, AttendanceDataRow, AnyAttendanceDataRow, DailyRecord } from '../attendance/types';\r\nimport { useAttendanceStore } from '../attendance/store';\r\nimport { useEmployeeSettingsStore } from '../settings/employees/employee-settings-store';\r\nimport { recalculateSummary } from '../attendance/utils';\r\nimport { getCurrentDate } from '../../lib/date-utils';\r\n\r\nconst LEAVE_NOTE_PREFIX = '[LEAVE:';\r\n\r\ntype DayContext = {\r\n  date: Date;\r\n  dayOfMonth: number;\r\n};\r\n\r\ntype MonthDayMap = Map<string, DayContext[]>;\r\n\r\nconst buildMonthKey = (date: Date) => `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;\r\n\r\nconst buildLeaveNote = (leave: LeaveRequest) => {\r\n  const description = `${LEAVE_NOTE_PREFIX}${leave.systemId}] ${leave.leaveTypeName}`;\r\n  return leave.reason ? `${description} - ${leave.reason}` : description;\r\n};\r\n\r\nconst isSameLeaveNote = (record: DailyRecord | undefined, leave: LeaveRequest) => {\r\n  if (!record?.notes) return false;\r\n  return record.notes.includes(`${LEAVE_NOTE_PREFIX}${leave.systemId}]`);\r\n};\r\n\r\nconst cloneDate = (input: Date) => new Date(input.getFullYear(), input.getMonth(), input.getDate());\r\n\r\nconst parseLeaveBoundary = (value: string): Date => {\r\n  const parsed = new Date(`${value}T00:00:00`);\r\n  return Number.isNaN(parsed.getTime()) ? new Date() : parsed;\r\n};\r\n\r\nconst collectWorkingDays = (leave: LeaveRequest): MonthDayMap => {\r\n  const workingDays = new Set(useEmployeeSettingsStore.getState().settings.workingDays);\r\n  if (!leave.startDate || !leave.endDate) return new Map();\r\n\r\n  let start = parseLeaveBoundary(leave.startDate);\r\n  let end = parseLeaveBoundary(leave.endDate);\r\n  if (start > end) {\r\n    const temp = start;\r\n    start = end;\r\n    end = temp;\r\n  }\r\n\r\n  const monthMap: MonthDayMap = new Map();\r\n  for (let cursor = cloneDate(start); cursor <= end; cursor.setDate(cursor.getDate() + 1)) {\r\n    const dayOfWeek = cursor.getDay();\r\n    if (!workingDays.has(dayOfWeek)) {\r\n      continue;\r\n    }\r\n\r\n    const monthKey = buildMonthKey(cursor);\r\n    const entry: DayContext = { date: cloneDate(cursor), dayOfMonth: cursor.getDate() };\r\n    const existing = monthMap.get(monthKey);\r\n    if (existing) {\r\n      existing.push(entry);\r\n    } else {\r\n      monthMap.set(monthKey, [entry]);\r\n    }\r\n  }\r\n\r\n  return monthMap;\r\n};\r\n\r\nconst buildLeaveRecord = (leave: LeaveRequest): DailyRecord => ({\r\n  status: 'leave',\r\n  notes: buildLeaveNote(leave),\r\n});\r\n\r\nconst buildRevertedRecord = (context: DayContext): DailyRecord => {\r\n  const today = getCurrentDate();\r\n  if (context.date > today) {\r\n    return { status: 'future' };\r\n  }\r\n  return { status: 'absent' };\r\n};\r\n\r\nconst applyUpdatesForMonth = (monthKey: string, days: DayContext[], leave: LeaveRequest, mode: 'apply' | 'clear') => {\r\n  if (days.length === 0) return;\r\n\r\n  const attendanceStore = useAttendanceStore.getState();\r\n  const monthData = attendanceStore.getAttendanceData(monthKey);\r\n  if (!monthData?.length) return;\r\n\r\n  const [yearStr, monthStr] = monthKey.split('-');\r\n  const year = Number(yearStr) || new Date().getFullYear();\r\n  const month = Number(monthStr) || new Date().getMonth() + 1;\r\n  const settings = useEmployeeSettingsStore.getState().settings;\r\n\r\n  let didChange = false;\r\n  const updatedRows: AttendanceDataRow[] = monthData.map((row) => {\r\n    if (row.employeeSystemId !== leave.employeeSystemId) {\r\n      return row;\r\n    }\r\n\r\n    let rowChanged = false;\r\n    const mutableRow: AnyAttendanceDataRow = { ...row };\r\n\r\n    days.forEach((ctx) => {\r\n      const dayKey = `day_${ctx.dayOfMonth}` as AttendanceDayKey;\r\n      const currentRecord = mutableRow[dayKey] as DailyRecord | undefined;\r\n\r\n      if (mode === 'apply') {\r\n        mutableRow[dayKey] = buildLeaveRecord(leave);\r\n        rowChanged = true;\r\n        return;\r\n      }\r\n\r\n      if (mode === 'clear' && currentRecord && isSameLeaveNote(currentRecord, leave)) {\r\n        mutableRow[dayKey] = buildRevertedRecord(ctx);\r\n        rowChanged = true;\r\n      }\r\n    });\r\n\r\n    if (!rowChanged) {\r\n      return row;\r\n    }\r\n\r\n    didChange = true;\r\n    const summary = recalculateSummary(mutableRow, year, month, settings);\r\n    return { ...mutableRow, ...summary } as AttendanceDataRow;\r\n  });\r\n\r\n  if (didChange) {\r\n    attendanceStore.saveAttendanceData(monthKey, updatedRows);\r\n  }\r\n};\r\n\r\nexport const leaveAttendanceSync = {\r\n  apply(leave: LeaveRequest) {\r\n    const monthMap = collectWorkingDays(leave);\r\n    monthMap.forEach((days, monthKey) => applyUpdatesForMonth(monthKey, days, leave, 'apply'));\r\n  },\r\n  clear(leave: LeaveRequest) {\r\n    const monthMap = collectWorkingDays(leave);\r\n    monthMap.forEach((days, monthKey) => applyUpdatesForMonth(monthKey, days, leave, 'clear'));\r\n  },\r\n};\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 8623, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/leaves/leave-quota-service.ts"],"sourcesContent":["import type { LeaveRequest } from './types';\r\nimport type { LeaveType } from '../settings/employees/types';\r\nimport { useEmployeeStore } from '../employees/store';\r\nimport { useEmployeeSettingsStore } from '../settings/employees/employee-settings-store';\r\nimport { getCurrentDate } from '../../lib/date-utils';\r\n\r\nconst clampNonNegative = (value: number) => (Number.isFinite(value) && value > 0 ? value : 0);\r\n\r\nconst resolveDelta = (leave: LeaveRequest) => {\r\n  const days = Number(leave.numberOfDays) || 0;\r\n  return days > 0 ? days : 0;\r\n};\r\n\r\ntype LeaveTypeMetadata = {\r\n  isPaid: boolean;\r\n  countsTowardsAnnual: boolean;\r\n};\r\n\r\nconst isAnnualLeaveType = (leaveType?: LeaveType | null) => {\r\n  if (!leaveType) return false;\r\n  const normalizedName = leaveType.name?.toLowerCase() ?? '';\r\n  const annualKeywords = ['phép năm', 'phep nam', 'annual'];\r\n  return annualKeywords.some((keyword) => normalizedName.includes(keyword));\r\n};\r\n\r\nconst resolveLeaveTypeMetadata = (leave: LeaveRequest): LeaveTypeMetadata => {\r\n  const settings = useEmployeeSettingsStore.getState().settings;\r\n  const matchedType = settings.leaveTypes.find((type) => {\r\n    if (leave.leaveTypeSystemId && type.systemId === leave.leaveTypeSystemId) return true;\r\n    if (leave.leaveTypeId && type.id === leave.leaveTypeId) return true;\r\n    return false;\r\n  });\r\n\r\n  const isPaid = typeof leave.leaveTypeIsPaid === 'boolean'\r\n    ? leave.leaveTypeIsPaid\r\n    : matchedType?.isPaid ?? true;\r\n\r\n  const countsTowardsAnnual = matchedType\r\n    ? isAnnualLeaveType(matchedType)\r\n    : isPaid;\r\n\r\n  return {\r\n    isPaid,\r\n    countsTowardsAnnual,\r\n  } satisfies LeaveTypeMetadata;\r\n};\r\n\r\nconst getServiceYears = (hireDate?: string) => {\r\n  if (!hireDate) return 0;\r\n  const parsed = new Date(hireDate);\r\n  if (Number.isNaN(parsed.getTime())) return 0;\r\n  const today = getCurrentDate();\r\n  let years = today.getFullYear() - parsed.getFullYear();\r\n  const hasNotReachedAnniversary =\r\n    today.getMonth() < parsed.getMonth() ||\r\n    (today.getMonth() === parsed.getMonth() && today.getDate() < parsed.getDate());\r\n  if (hasNotReachedAnniversary) {\r\n    years -= 1;\r\n  }\r\n  return Math.max(years, 0);\r\n};\r\n\r\nconst computeAnnualQuota = (employeeHireDate?: string) => {\r\n  const { baseAnnualLeaveDays, annualLeaveSeniorityBonus } = useEmployeeSettingsStore.getState().settings;\r\n  const base = baseAnnualLeaveDays ?? 0;\r\n  if (!annualLeaveSeniorityBonus) {\r\n    return clampNonNegative(base);\r\n  }\r\n  const years = getServiceYears(employeeHireDate);\r\n  const bonusInterval = annualLeaveSeniorityBonus.years || 0;\r\n  const bonusValue = annualLeaveSeniorityBonus.additionalDays || 0;\r\n  const bonusMultiplier = bonusInterval > 0 ? Math.floor(years / bonusInterval) : 0;\r\n  const bonus = bonusMultiplier * bonusValue;\r\n  return clampNonNegative(base + bonus);\r\n};\r\n\r\nconst adjustLeaveUsage = (leave: LeaveRequest, delta: number) => {\r\n  if (!delta) return;\r\n  const employeeStore = useEmployeeStore.getState();\r\n  const employee = employeeStore.findById(leave.employeeSystemId);\r\n  if (!employee) return;\r\n\r\n  const { isPaid, countsTowardsAnnual } = resolveLeaveTypeMetadata(leave);\r\n  const totalDelta = delta;\r\n  const paidDelta = isPaid ? delta : 0;\r\n  const unpaidDelta = isPaid ? 0 : delta;\r\n  const annualDelta = countsTowardsAnnual ? delta : 0;\r\n\r\n  const nextLeaveTaken = clampNonNegative((employee.leaveTaken ?? 0) + totalDelta);\r\n  const nextPaid = clampNonNegative((employee.paidLeaveTaken ?? 0) + paidDelta);\r\n  const nextUnpaid = clampNonNegative((employee.unpaidLeaveTaken ?? 0) + unpaidDelta);\r\n  const nextAnnual = clampNonNegative((employee.annualLeaveTaken ?? 0) + annualDelta);\r\n  const quota = computeAnnualQuota(employee.hireDate);\r\n  const nextBalance = clampNonNegative(quota - nextAnnual);\r\n\r\n  const hasChanges =\r\n    nextLeaveTaken !== (employee.leaveTaken ?? 0) ||\r\n    nextPaid !== (employee.paidLeaveTaken ?? 0) ||\r\n    nextUnpaid !== (employee.unpaidLeaveTaken ?? 0) ||\r\n    nextAnnual !== (employee.annualLeaveTaken ?? 0) ||\r\n    nextBalance !== (employee.annualLeaveBalance ?? quota);\r\n\r\n  if (!hasChanges) return;\r\n\r\n  employeeStore.update(leave.employeeSystemId, {\r\n    ...employee,\r\n    leaveTaken: nextLeaveTaken,\r\n    paidLeaveTaken: nextPaid,\r\n    unpaidLeaveTaken: nextUnpaid,\r\n    annualLeaveTaken: nextAnnual,\r\n    annualLeaveBalance: nextBalance,\r\n  });\r\n};\r\n\r\nexport const leaveQuotaSync = {\r\n  apply(leave: LeaveRequest) {\r\n    const delta = resolveDelta(leave);\r\n    if (!delta) return;\r\n    adjustLeaveUsage(leave, delta);\r\n  },\r\n  clear(leave: LeaveRequest) {\r\n    const delta = resolveDelta(leave);\r\n    if (!delta) return;\r\n    adjustLeaveUsage(leave, -delta);\r\n  },\r\n};\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 8733, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/leaves/store.ts"],"sourcesContent":["import { createCrudStore, type CrudState } from '../../lib/store-factory';\r\n// REMOVED: import { data as initialData } from './data'; // Mock data no longer used - database is source of truth\r\nimport type { LeaveRequest } from './types';\r\nimport { leaveAttendanceSync } from './leave-sync-service';\r\nimport { leaveQuotaSync } from './leave-quota-service';\r\n\r\nexport type LeaveStoreState = CrudState<LeaveRequest>;\r\n\r\nconst baseStore = createCrudStore<LeaveRequest>([], 'leaves', {\r\n\tbusinessIdField: 'id',\r\n\tapiEndpoint: '/api/leaves',\r\n});\r\n\r\nconst isApproved = (leave?: LeaveRequest | null): leave is LeaveRequest =>\r\n\tBoolean(leave && leave.status === 'Đã duyệt');\r\n\r\nconst snapshotLeave = (leave?: LeaveRequest | null): LeaveRequest | undefined =>\r\n\tleave ? { ...leave } : undefined;\r\n\r\nconst syncApprovedLeave = {\r\n\tapply: (leave: LeaveRequest) => {\r\n\t\tleaveAttendanceSync.apply(leave);\r\n\t\tleaveQuotaSync.apply(leave);\r\n\t},\r\n\tclear: (leave: LeaveRequest) => {\r\n\t\tleaveAttendanceSync.clear(leave);\r\n\t\tleaveQuotaSync.clear(leave);\r\n\t},\r\n};\r\n\r\nconst syncAwareActions: Pick<LeaveStoreState, 'add' | 'update' | 'remove' | 'restore' | 'hardDelete'> = {\r\n\tadd: (payload) => {\r\n\t\tconst created = baseStore.getState().add(payload);\r\n\t\tif (isApproved(created)) {\r\n\t\t\tsyncApprovedLeave.apply(created);\r\n\t\t}\r\n\t\treturn created;\r\n\t},\r\n\tupdate: (systemId, next) => {\r\n\t\tconst store = baseStore.getState();\r\n\t\tconst previous = snapshotLeave(store.findById(systemId));\r\n\t\tstore.update(systemId, next);\r\n\t\tconst updated = snapshotLeave(baseStore.getState().findById(systemId));\r\n\t\tif (isApproved(previous)) {\r\n\t\t\tsyncApprovedLeave.clear(previous);\r\n\t\t}\r\n\t\tif (isApproved(updated)) {\r\n\t\t\tsyncApprovedLeave.apply(updated);\r\n\t\t}\r\n\t},\r\n\tremove: (systemId) => {\r\n\t\tconst store = baseStore.getState();\r\n\t\tconst target = snapshotLeave(store.findById(systemId));\r\n\t\tstore.remove(systemId);\r\n\t\tif (isApproved(target)) {\r\n\t\t\tsyncApprovedLeave.clear(target);\r\n\t\t}\r\n\t},\r\n\trestore: (systemId) => {\r\n\t\tconst store = baseStore.getState();\r\n\t\tstore.restore(systemId);\r\n\t\tconst restored = snapshotLeave(baseStore.getState().findById(systemId));\r\n\t\tif (isApproved(restored)) {\r\n\t\t\tsyncApprovedLeave.apply(restored);\r\n\t\t}\r\n\t},\r\n\thardDelete: (systemId) => {\r\n\t\tconst store = baseStore.getState();\r\n\t\tconst target = snapshotLeave(store.findById(systemId));\r\n\t\tstore.hardDelete(systemId);\r\n\t\tif (isApproved(target)) {\r\n\t\t\tsyncApprovedLeave.clear(target);\r\n\t\t}\r\n\t},\r\n};\r\n\r\nconst withSync = (state: LeaveStoreState): LeaveStoreState => ({\r\n\t...state,\r\n\t...syncAwareActions,\r\n});\r\n\r\nexport const useLeaveStore = () => withSync(baseStore());\r\n\r\nuseLeaveStore.getState = () => withSync(baseStore.getState());\r\n"],"names":[],"mappings":";;;;AAAA;AAGA;AACA;;;;AAIA,MAAM,YAAY,IAAA,6IAAe,EAAe,EAAE,EAAE,UAAU;IAC7D,iBAAiB;IACjB,aAAa;AACd;AAEA,MAAM,aAAa,CAAC,QACnB,QAAQ,SAAS,MAAM,MAAM,KAAK;AAEnC,MAAM,gBAAgB,CAAC,QACtB,QAAQ;QAAE,GAAG,KAAK;IAAC,IAAI;AAExB,MAAM,oBAAoB;IACzB,OAAO,CAAC;QACP,wKAAmB,CAAC,KAAK,CAAC;QAC1B,oKAAc,CAAC,KAAK,CAAC;IACtB;IACA,OAAO,CAAC;QACP,wKAAmB,CAAC,KAAK,CAAC;QAC1B,oKAAc,CAAC,KAAK,CAAC;IACtB;AACD;AAEA,MAAM,mBAAkG;IACvG,KAAK,CAAC;QACL,MAAM,UAAU,UAAU,QAAQ,GAAG,GAAG,CAAC;QACzC,IAAI,WAAW,UAAU;YACxB,kBAAkB,KAAK,CAAC;QACzB;QACA,OAAO;IACR;IACA,QAAQ,CAAC,UAAU;QAClB,MAAM,QAAQ,UAAU,QAAQ;QAChC,MAAM,WAAW,cAAc,MAAM,QAAQ,CAAC;QAC9C,MAAM,MAAM,CAAC,UAAU;QACvB,MAAM,UAAU,cAAc,UAAU,QAAQ,GAAG,QAAQ,CAAC;QAC5D,IAAI,WAAW,WAAW;YACzB,kBAAkB,KAAK,CAAC;QACzB;QACA,IAAI,WAAW,UAAU;YACxB,kBAAkB,KAAK,CAAC;QACzB;IACD;IACA,QAAQ,CAAC;QACR,MAAM,QAAQ,UAAU,QAAQ;QAChC,MAAM,SAAS,cAAc,MAAM,QAAQ,CAAC;QAC5C,MAAM,MAAM,CAAC;QACb,IAAI,WAAW,SAAS;YACvB,kBAAkB,KAAK,CAAC;QACzB;IACD;IACA,SAAS,CAAC;QACT,MAAM,QAAQ,UAAU,QAAQ;QAChC,MAAM,OAAO,CAAC;QACd,MAAM,WAAW,cAAc,UAAU,QAAQ,GAAG,QAAQ,CAAC;QAC7D,IAAI,WAAW,WAAW;YACzB,kBAAkB,KAAK,CAAC;QACzB;IACD;IACA,YAAY,CAAC;QACZ,MAAM,QAAQ,UAAU,QAAQ;QAChC,MAAM,SAAS,cAAc,MAAM,QAAQ,CAAC;QAC5C,MAAM,UAAU,CAAC;QACjB,IAAI,WAAW,SAAS;YACvB,kBAAkB,KAAK,CAAC;QACzB;IACD;AACD;AAEA,MAAM,WAAW,CAAC,QAA4C,CAAC;QAC9D,GAAG,KAAK;QACR,GAAG,gBAAgB;IACpB,CAAC;AAEM,MAAM,gBAAgB,IAAM,SAAS;AAE5C,cAAc,QAAQ,GAAG,IAAM,SAAS,UAAU,QAAQ"}},
    {"offset": {"line": 8819, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/suppliers/store.ts"],"sourcesContent":["import { createCrudStore, CrudState } from '../../lib/store-factory';\r\n// REMOVED: import { data as initialData } from './data'; // Mock data no longer used - database is source of truth\r\nimport type { Supplier } from './types';\r\nimport type { SystemId } from '../../lib/id-types';\r\nimport { asSystemId, asBusinessId } from '../../lib/id-types';\r\nimport Fuse from 'fuse.js';\r\nimport { getCurrentUserSystemId } from '../../contexts/auth-context';\r\n\r\nconst baseStore = createCrudStore<Supplier>([], 'suppliers', {\r\n  businessIdField: 'id',\r\n  getCurrentUser: getCurrentUserSystemId, // ✅ Track who creates/updates\r\n  apiEndpoint: '/api/suppliers',\r\n});\r\n\r\n// ✅ API Sync helpers\r\nconst API_ENDPOINT = '/api/suppliers';\r\n\r\nconst syncToApi = {\r\n  create: async (supplier: Supplier) => {\r\n    try {\r\n      const response = await fetch(API_ENDPOINT, {\r\n        method: 'POST',\r\n        credentials: 'include',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify(supplier),\r\n      });\r\n      if (!response.ok) console.warn('[Supplier API] Create sync failed');\r\n      else console.log('[Supplier API] Created:', supplier.systemId);\r\n    } catch (e) {\r\n      console.warn('[Supplier API] Create sync error:', e);\r\n    }\r\n  },\r\n  update: async (systemId: SystemId, updates: Partial<Supplier>) => {\r\n    try {\r\n      const response = await fetch(`${API_ENDPOINT}/${systemId}`, {\r\n        method: 'PATCH',\r\n        credentials: 'include',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify(updates),\r\n      });\r\n      if (!response.ok) console.warn('[Supplier API] Update sync failed');\r\n      else console.log('[Supplier API] Updated:', systemId);\r\n    } catch (e) {\r\n      console.warn('[Supplier API] Update sync error:', e);\r\n    }\r\n  },\r\n  delete: async (systemId: SystemId, hard = false) => {\r\n    try {\r\n      const response = await fetch(`${API_ENDPOINT}/${systemId}`, {\r\n        method: 'DELETE',\r\n        credentials: 'include',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({ hard }),\r\n      });\r\n      if (!response.ok) console.warn('[Supplier API] Delete sync failed');\r\n      else console.log('[Supplier API] Deleted:', systemId);\r\n    } catch (e) {\r\n      console.warn('[Supplier API] Delete sync error:', e);\r\n    }\r\n  },\r\n  restore: async (systemId: SystemId) => {\r\n    try {\r\n      const response = await fetch(`${API_ENDPOINT}/${systemId}/restore`, {\r\n        method: 'POST',\r\n        credentials: 'include',\r\n        headers: { 'Content-Type': 'application/json' },\r\n      });\r\n      if (!response.ok) console.warn('[Supplier API] Restore sync failed');\r\n      else console.log('[Supplier API] Restored:', systemId);\r\n    } catch (e) {\r\n      console.warn('[Supplier API] Restore sync error:', e);\r\n    }\r\n  },\r\n};\r\n\r\n// ✅ Wrap base store methods with API sync\r\nconst originalAdd = baseStore.getState().add;\r\nconst originalUpdate = baseStore.getState().update;\r\nconst originalRemove = baseStore.getState().remove;\r\nconst originalHardDelete = baseStore.getState().hardDelete;\r\nconst originalRestore = baseStore.getState().restore;\r\n\r\nbaseStore.setState({\r\n  add: (item: Omit<Supplier, 'systemId'>) => {\r\n    const result = originalAdd(item);\r\n    syncToApi.create(result);\r\n    return result;\r\n  },\r\n  update: (systemId: SystemId, updates: Partial<Supplier>) => {\r\n    originalUpdate(systemId, updates);\r\n    syncToApi.update(systemId, updates);\r\n  },\r\n  remove: (systemId: SystemId) => {\r\n    originalRemove(systemId);\r\n    syncToApi.delete(systemId, false);\r\n  },\r\n  hardDelete: (systemId: SystemId) => {\r\n    originalHardDelete(systemId);\r\n    syncToApi.delete(systemId, true);\r\n  },\r\n  restore: (systemId: SystemId) => {\r\n    originalRestore(systemId);\r\n    syncToApi.restore(systemId);\r\n  },\r\n});\r\n\r\nconst fuse = new Fuse(baseStore.getState().data, {\r\n    keys: ['name', 'id', 'phone'],\r\n    threshold: 0.3,\r\n});\r\n\r\n// Define enhanced interface\r\ninterface SupplierStoreState extends CrudState<Supplier> {\r\n  searchSuppliers: (query: string, page: number, limit?: number) => Promise<{ items: { value: string; label: string }[], hasNextPage: boolean }>;\r\n  updateStatus: (systemIds: SystemId[], status: Supplier['status']) => void;\r\n  bulkDelete: (systemIds: SystemId[]) => void;\r\n}\r\n\r\n// Augmented methods\r\nconst augmentedMethods = {\r\n    searchSuppliers: async (query: string, page: number, limit: number = 20) => {\r\n        return new Promise<{ items: { value: string; label: string }[], hasNextPage: boolean }>(resolve => {\r\n            setTimeout(() => {\r\n                const allSuppliers = baseStore.getState().data;\r\n                const results = query ? fuse.search(query).map(r => r.item) : allSuppliers;\r\n                \r\n                const start = (page - 1) * limit;\r\n                const end = start + limit;\r\n                const paginatedItems = results.slice(start, end);\r\n\r\n                resolve({\r\n                    items: paginatedItems.map(s => ({ value: s.systemId, label: s.name })),\r\n                    hasNextPage: end < results.length,\r\n                });\r\n            }, 300);\r\n        });\r\n    },\r\n    updateStatus: (systemIds: SystemId[], status: Supplier['status']) => {\r\n        const currentUser = asSystemId(getCurrentUserSystemId());\r\n        baseStore.setState((state) => ({\r\n            data: state.data.map((item) =>\r\n                systemIds.includes(item.systemId)\r\n                    ? { ...item, status, updatedBy: currentUser, updatedAt: new Date().toISOString() }\r\n                    : item\r\n            ),\r\n        }));\r\n    },\r\n    bulkDelete: (systemIds: SystemId[]) => {\r\n        const currentUser = asSystemId(getCurrentUserSystemId());\r\n        baseStore.setState((state) => ({\r\n            data: state.data.map((item) =>\r\n                systemIds.includes(item.systemId)\r\n                    ? { ...item, isDeleted: true, deletedBy: currentUser, deletedAt: new Date().toISOString() }\r\n                    : item\r\n            ),\r\n        }));\r\n    }\r\n};\r\n\r\n// Export typed hook\r\nexport const useSupplierStore = (): SupplierStoreState => {\r\n  const state = baseStore();\r\n  return {\r\n    ...state,\r\n    ...augmentedMethods,\r\n  };\r\n};\r\n\r\n// Export getState for non-hook usage\r\nuseSupplierStore.getState = (): SupplierStoreState => {\r\n  const state = baseStore.getState();\r\n  return {\r\n    ...state,\r\n    ...augmentedMethods,\r\n  };\r\n};\r\n"],"names":[],"mappings":";;;;AAAA;AAIA;AACA;AACA;;;;;AAEA,MAAM,YAAY,IAAA,6IAAe,EAAW,EAAE,EAAE,aAAa;IAC3D,iBAAiB;IACjB,gBAAgB,yJAAsB;IACtC,aAAa;AACf;AAEA,qBAAqB;AACrB,MAAM,eAAe;AAErB,MAAM,YAAY;IAChB,QAAQ,OAAO;QACb,IAAI;YACF,MAAM,WAAW,MAAM,MAAM,cAAc;gBACzC,QAAQ;gBACR,aAAa;gBACb,SAAS;oBAAE,gBAAgB;gBAAmB;gBAC9C,MAAM,KAAK,SAAS,CAAC;YACvB;YACA,IAAI,CAAC,SAAS,EAAE,EAAE,QAAQ,IAAI,CAAC;iBAC1B,QAAQ,GAAG,CAAC,2BAA2B,SAAS,QAAQ;QAC/D,EAAE,OAAO,GAAG;YACV,QAAQ,IAAI,CAAC,qCAAqC;QACpD;IACF;IACA,QAAQ,OAAO,UAAoB;QACjC,IAAI;YACF,MAAM,WAAW,MAAM,MAAM,GAAG,aAAa,CAAC,EAAE,UAAU,EAAE;gBAC1D,QAAQ;gBACR,aAAa;gBACb,SAAS;oBAAE,gBAAgB;gBAAmB;gBAC9C,MAAM,KAAK,SAAS,CAAC;YACvB;YACA,IAAI,CAAC,SAAS,EAAE,EAAE,QAAQ,IAAI,CAAC;iBAC1B,QAAQ,GAAG,CAAC,2BAA2B;QAC9C,EAAE,OAAO,GAAG;YACV,QAAQ,IAAI,CAAC,qCAAqC;QACpD;IACF;IACA,QAAQ,OAAO,UAAoB,OAAO,KAAK;QAC7C,IAAI;YACF,MAAM,WAAW,MAAM,MAAM,GAAG,aAAa,CAAC,EAAE,UAAU,EAAE;gBAC1D,QAAQ;gBACR,aAAa;gBACb,SAAS;oBAAE,gBAAgB;gBAAmB;gBAC9C,MAAM,KAAK,SAAS,CAAC;oBAAE;gBAAK;YAC9B;YACA,IAAI,CAAC,SAAS,EAAE,EAAE,QAAQ,IAAI,CAAC;iBAC1B,QAAQ,GAAG,CAAC,2BAA2B;QAC9C,EAAE,OAAO,GAAG;YACV,QAAQ,IAAI,CAAC,qCAAqC;QACpD;IACF;IACA,SAAS,OAAO;QACd,IAAI;YACF,MAAM,WAAW,MAAM,MAAM,GAAG,aAAa,CAAC,EAAE,SAAS,QAAQ,CAAC,EAAE;gBAClE,QAAQ;gBACR,aAAa;gBACb,SAAS;oBAAE,gBAAgB;gBAAmB;YAChD;YACA,IAAI,CAAC,SAAS,EAAE,EAAE,QAAQ,IAAI,CAAC;iBAC1B,QAAQ,GAAG,CAAC,4BAA4B;QAC/C,EAAE,OAAO,GAAG;YACV,QAAQ,IAAI,CAAC,sCAAsC;QACrD;IACF;AACF;AAEA,0CAA0C;AAC1C,MAAM,cAAc,UAAU,QAAQ,GAAG,GAAG;AAC5C,MAAM,iBAAiB,UAAU,QAAQ,GAAG,MAAM;AAClD,MAAM,iBAAiB,UAAU,QAAQ,GAAG,MAAM;AAClD,MAAM,qBAAqB,UAAU,QAAQ,GAAG,UAAU;AAC1D,MAAM,kBAAkB,UAAU,QAAQ,GAAG,OAAO;AAEpD,UAAU,QAAQ,CAAC;IACjB,KAAK,CAAC;QACJ,MAAM,SAAS,YAAY;QAC3B,UAAU,MAAM,CAAC;QACjB,OAAO;IACT;IACA,QAAQ,CAAC,UAAoB;QAC3B,eAAe,UAAU;QACzB,UAAU,MAAM,CAAC,UAAU;IAC7B;IACA,QAAQ,CAAC;QACP,eAAe;QACf,UAAU,MAAM,CAAC,UAAU;IAC7B;IACA,YAAY,CAAC;QACX,mBAAmB;QACnB,UAAU,MAAM,CAAC,UAAU;IAC7B;IACA,SAAS,CAAC;QACR,gBAAgB;QAChB,UAAU,OAAO,CAAC;IACpB;AACF;AAEA,MAAM,OAAO,IAAI,yJAAI,CAAC,UAAU,QAAQ,GAAG,IAAI,EAAE;IAC7C,MAAM;QAAC;QAAQ;QAAM;KAAQ;IAC7B,WAAW;AACf;AASA,oBAAoB;AACpB,MAAM,mBAAmB;IACrB,iBAAiB,OAAO,OAAe,MAAc,QAAgB,EAAE;QACnE,OAAO,IAAI,QAA6E,CAAA;YACpF,WAAW;gBACP,MAAM,eAAe,UAAU,QAAQ,GAAG,IAAI;gBAC9C,MAAM,UAAU,QAAQ,KAAK,MAAM,CAAC,OAAO,GAAG,CAAC,CAAA,IAAK,EAAE,IAAI,IAAI;gBAE9D,MAAM,QAAQ,CAAC,OAAO,CAAC,IAAI;gBAC3B,MAAM,MAAM,QAAQ;gBACpB,MAAM,iBAAiB,QAAQ,KAAK,CAAC,OAAO;gBAE5C,QAAQ;oBACJ,OAAO,eAAe,GAAG,CAAC,CAAA,IAAK,CAAC;4BAAE,OAAO,EAAE,QAAQ;4BAAE,OAAO,EAAE,IAAI;wBAAC,CAAC;oBACpE,aAAa,MAAM,QAAQ,MAAM;gBACrC;YACJ,GAAG;QACP;IACJ;IACA,cAAc,CAAC,WAAuB;QAClC,MAAM,cAAc,IAAA,mIAAU,EAAC,IAAA,yJAAsB;QACrD,UAAU,QAAQ,CAAC,CAAC,QAAU,CAAC;gBAC3B,MAAM,MAAM,IAAI,CAAC,GAAG,CAAC,CAAC,OAClB,UAAU,QAAQ,CAAC,KAAK,QAAQ,IAC1B;wBAAE,GAAG,IAAI;wBAAE;wBAAQ,WAAW;wBAAa,WAAW,IAAI,OAAO,WAAW;oBAAG,IAC/E;YAEd,CAAC;IACL;IACA,YAAY,CAAC;QACT,MAAM,cAAc,IAAA,mIAAU,EAAC,IAAA,yJAAsB;QACrD,UAAU,QAAQ,CAAC,CAAC,QAAU,CAAC;gBAC3B,MAAM,MAAM,IAAI,CAAC,GAAG,CAAC,CAAC,OAClB,UAAU,QAAQ,CAAC,KAAK,QAAQ,IAC1B;wBAAE,GAAG,IAAI;wBAAE,WAAW;wBAAM,WAAW;wBAAa,WAAW,IAAI,OAAO,WAAW;oBAAG,IACxF;YAEd,CAAC;IACL;AACJ;AAGO,MAAM,mBAAmB;IAC9B,MAAM,QAAQ;IACd,OAAO;QACL,GAAG,KAAK;QACR,GAAG,gBAAgB;IACrB;AACF;AAEA,qCAAqC;AACrC,iBAAiB,QAAQ,GAAG;IAC1B,MAAM,QAAQ,UAAU,QAAQ;IAChC,OAAO;QACL,GAAG,KAAK;QACR,GAAG,gBAAgB;IACrB;AACF"}},
    {"offset": {"line": 9007, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/inventory-receipts/store.ts"],"sourcesContent":["import { createCrudStore, CrudState } from '../../lib/store-factory';\r\n// REMOVED: import { data as initialData } from './data'; // Mock data no longer used - database is source of truth\r\nimport type { InventoryReceipt, InventoryReceiptLineItem } from './types';\r\nimport type { SystemId, BusinessId } from '../../lib/id-types';\r\nimport { useProductStore } from '../products/store';\r\n\r\nconst baseStore = createCrudStore<InventoryReceipt>(\r\n  [],\r\n  'inventory-receipts',\r\n  {\r\n    apiEndpoint: '/api/inventory-receipts',\r\n  }\r\n);\r\n\r\nexport interface InventoryReceiptStoreState extends CrudState<InventoryReceipt> {\r\n  // Add custom methods if needed\r\n}\r\n\r\nconst addReceipt = (item: Omit<InventoryReceipt, 'systemId'>) => {\r\n  const newItem = baseStore.getState().add(item);\r\n  \r\n  // Update last purchase price for all items in the receipt\r\n  const productStore = useProductStore.getState();\r\n  newItem.items.forEach(item => {\r\n    if (item.productSystemId && item.unitPrice > 0) {\r\n      productStore.updateLastPurchasePrice(\r\n        item.productSystemId, \r\n        item.unitPrice, \r\n        newItem.receivedDate\r\n      );\r\n    }\r\n  });\r\n  \r\n  return newItem;\r\n};\r\n\r\nconst updateReceipt = (systemId: SystemId, updates: Partial<InventoryReceipt>) => {\r\n  baseStore.getState().update(systemId, updates);\r\n  \r\n  // Update last purchase price if items or date changed\r\n  if (updates.items || updates.receivedDate) {\r\n    const updatedReceipt = baseStore.getState().findById(systemId);\r\n    if (updatedReceipt) {\r\n      const productStore = useProductStore.getState();\r\n      updatedReceipt.items.forEach(item => {\r\n        if (item.productSystemId && item.unitPrice > 0) {\r\n          productStore.updateLastPurchasePrice(\r\n            item.productSystemId, \r\n            item.unitPrice, \r\n            updatedReceipt.receivedDate\r\n          );\r\n        }\r\n      });\r\n    }\r\n  }\r\n};\r\n\r\nexport const useInventoryReceiptStore = (): InventoryReceiptStoreState => {\r\n  const state = baseStore();\r\n  return {\r\n    ...state,\r\n    add: addReceipt,\r\n    update: updateReceipt,\r\n  };\r\n};\r\n\r\nuseInventoryReceiptStore.getState = () => {\r\n  const state = baseStore.getState();\r\n  return {\r\n    ...state,\r\n    add: addReceipt,\r\n    update: updateReceipt,\r\n  };\r\n};\r\n\r\n(useInventoryReceiptStore as any).subscribe = baseStore.subscribe;\r\n(useInventoryReceiptStore as any).setState = baseStore.setState;\r\n\r\ntype PurchaseOrderReference = {\r\n  systemId: SystemId;\r\n  id: BusinessId;\r\n  branchSystemId?: SystemId;\r\n  branchName?: string;\r\n  supplierSystemId?: SystemId;\r\n  supplierName?: string;\r\n};\r\n\r\ntype ProductReference = {\r\n  systemId: SystemId;\r\n  id: BusinessId;\r\n  name: string;\r\n  sku?: string;\r\n};\r\n\r\ntype InventoryReceiptBackfillInput = {\r\n  purchaseOrders: PurchaseOrderReference[];\r\n  products?: ProductReference[];\r\n};\r\n\r\nconst normalizeKey = (value?: string | null) => (value ? value.trim().toLowerCase() : '');\r\n\r\nconst buildLookup = <T extends { systemId: SystemId; id: BusinessId }>(\r\n  entries: T[],\r\n  extraKeys?: (entry: T) => (string | undefined)[],\r\n) => {\r\n  const bySystemId = new Map<string, T>();\r\n  const byAnyKey = new Map<string, T>();\r\n\r\n  entries.forEach(entry => {\r\n    const systemKey = normalizeKey(entry.systemId);\r\n    const businessKey = normalizeKey(entry.id);\r\n    if (systemKey) {\r\n      bySystemId.set(systemKey, entry);\r\n      byAnyKey.set(systemKey, entry);\r\n    }\r\n    if (businessKey) {\r\n      byAnyKey.set(businessKey, entry);\r\n    }\r\n    (extraKeys?.(entry) ?? []).forEach(key => {\r\n      const normalized = normalizeKey(key);\r\n      if (normalized) {\r\n        byAnyKey.set(normalized, entry);\r\n      }\r\n    });\r\n  });\r\n\r\n  return { bySystemId, byAnyKey };\r\n};\r\n\r\nconst matchProduct = (\r\n  item: InventoryReceiptLineItem,\r\n  lookup: Map<string, ProductReference>,\r\n) => {\r\n  const candidates = [item.productSystemId, item.productId, item.productName];\r\n  for (const candidate of candidates) {\r\n    const normalized = normalizeKey(candidate);\r\n    if (!normalized) continue;\r\n    const product = lookup.get(normalized);\r\n    if (product) {\r\n      return product;\r\n    }\r\n  }\r\n  return undefined;\r\n};\r\n\r\n/**\r\n * Ensure historical receipts keep dual IDs + branch context + correct product linkage.\r\n * Call once after purchase order & product stores are hydrated to migrate legacy data.\r\n */\r\nexport function syncInventoryReceiptsWithPurchaseOrders({\r\n  purchaseOrders,\r\n  products,\r\n}: InventoryReceiptBackfillInput) {\r\n  if (!purchaseOrders.length) return;\r\n\r\n  const poLookup = buildLookup(purchaseOrders, po => [po.id]);\r\n  const productLookup = buildLookup(products ?? [], product => [product.id, product.sku, product.name]);\r\n\r\n  const storeState = useInventoryReceiptStore.getState();\r\n  const updated = storeState.data.map(receipt => {\r\n    let next = receipt;\r\n    const matchedPo =\r\n      poLookup.bySystemId.get(normalizeKey(receipt.purchaseOrderSystemId)) ||\r\n      poLookup.byAnyKey.get(normalizeKey(receipt.purchaseOrderId));\r\n\r\n    if (!matchedPo) {\r\n      return receipt;\r\n    }\r\n\r\n    const updates: Partial<InventoryReceipt> = {};\r\n    let mutated = false;\r\n\r\n    if (receipt.purchaseOrderSystemId !== matchedPo.systemId) {\r\n      updates.purchaseOrderSystemId = matchedPo.systemId;\r\n      mutated = true;\r\n    }\r\n\r\n    if (receipt.purchaseOrderId !== matchedPo.id) {\r\n      updates.purchaseOrderId = matchedPo.id;\r\n      mutated = true;\r\n    }\r\n\r\n    if (matchedPo.branchSystemId && receipt.branchSystemId !== matchedPo.branchSystemId) {\r\n      updates.branchSystemId = matchedPo.branchSystemId;\r\n      mutated = true;\r\n    }\r\n\r\n    if (matchedPo.branchName && receipt.branchName !== matchedPo.branchName) {\r\n      updates.branchName = matchedPo.branchName;\r\n      mutated = true;\r\n    }\r\n\r\n    if (matchedPo.supplierSystemId && receipt.supplierSystemId !== matchedPo.supplierSystemId) {\r\n      updates.supplierSystemId = matchedPo.supplierSystemId;\r\n      mutated = true;\r\n    }\r\n\r\n    if (matchedPo.supplierName && receipt.supplierName !== matchedPo.supplierName) {\r\n      updates.supplierName = matchedPo.supplierName;\r\n      mutated = true;\r\n    }\r\n\r\n    if (products?.length) {\r\n      const normalizedItems = next.items.map(item => {\r\n        const matchedProduct = matchProduct(item, productLookup.byAnyKey);\r\n        if (!matchedProduct) {\r\n          return item;\r\n        }\r\n\r\n        if (\r\n          item.productSystemId === matchedProduct.systemId &&\r\n          item.productId === matchedProduct.id &&\r\n          item.productName === matchedProduct.name\r\n        ) {\r\n          return item;\r\n        }\r\n\r\n        mutated = true;\r\n        return {\r\n          ...item,\r\n          productSystemId: matchedProduct.systemId,\r\n          productId: matchedProduct.id,\r\n          productName: matchedProduct.name,\r\n        };\r\n      });\r\n\r\n      const itemsChanged = normalizedItems.some((item, index) => item !== next.items[index]);\r\n      if (itemsChanged) {\r\n        updates.items = normalizedItems;\r\n      }\r\n    }\r\n\r\n    return mutated ? { ...next, ...updates } : receipt;\r\n  });\r\n\r\n  const hasChanges = updated.some((receipt, index) => receipt !== storeState.data[index]);\r\n  if (hasChanges) {\r\n    (baseStore as any).setState({ data: updated });\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 9190, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/purchase-returns/store.ts"],"sourcesContent":["import { formatDateCustom, getCurrentDate } from '../../lib/date-utils';\r\nimport { createCrudStore, type CrudState } from '../../lib/store-factory';\r\n// REMOVED: import { data as initialData } from './data'; // Mock data no longer used - database is source of truth\r\nimport type { PurchaseReturn } from './types';\r\nimport { useProductStore } from '../products/store';\r\nimport { useStockHistoryStore } from '../stock-history/store';\r\nimport { useReceiptStore } from '../receipts/store';\r\nimport { usePurchaseOrderStore } from '../purchase-orders/store';\r\nimport { useCashbookStore } from '../cashbook/store';\r\nimport { useReceiptTypeStore } from '../settings/receipt-types/store';\r\nimport type { Receipt } from '../receipts/types';\r\nimport type { PurchaseOrderRefundStatus } from '../purchase-orders/types';\r\nimport { useInventoryReceiptStore } from '../inventory-receipts/store';\r\nimport { asBusinessId, asSystemId, type SystemId } from '@/lib/id-types';\r\n\r\nconst baseStore = createCrudStore<PurchaseReturn>(\r\n  [],\r\n  'purchase-returns',\r\n  {\r\n    apiEndpoint: '/api/purchase-returns',\r\n  }\r\n);\r\n\r\nconst originalAdd = baseStore.getState().add;\r\n\r\nconst newAdd = (item: Omit<PurchaseReturn, 'systemId'>): PurchaseReturn | undefined => {\r\n    // 1. Get other stores' methods\r\n    const { updateInventory } = useProductStore.getState();\r\n    const { addEntry: addStockHistory } = useStockHistoryStore.getState();\r\n    const { add: addReceipt } = useReceiptStore.getState();\r\n    const { processReturn: updatePOonReturn, data: allPOs } = usePurchaseOrderStore.getState();\r\n    const { accounts } = useCashbookStore.getState();\r\n    const { data: receiptTypes } = useReceiptTypeStore.getState();\r\n    const { data: allReceipts } = useInventoryReceiptStore.getState();\r\n    \r\n    // 2. Add the return record itself\r\n    const newReturn = originalAdd(item);\r\n\r\n    if (!newReturn) {\r\n      return undefined;\r\n    }\r\n\r\n    // 3. Update inventory & create stock history\r\n    newReturn.items.forEach(lineItem => {\r\n        if (lineItem.returnQuantity > 0) {\r\n            const productBeforeUpdate = useProductStore.getState().findById(lineItem.productSystemId);\r\n            const oldStock = productBeforeUpdate?.inventoryByBranch[newReturn.branchSystemId] || 0;\r\n            \r\n            updateInventory(lineItem.productSystemId, newReturn.branchSystemId, -lineItem.returnQuantity);\r\n            addStockHistory({\r\n                productId: lineItem.productSystemId,\r\n                date: new Date().toISOString(),\r\n                employeeName: newReturn.creatorName,\r\n                action: 'Hoàn trả NCC',\r\n                quantityChange: -lineItem.returnQuantity,\r\n                newStockLevel: oldStock - lineItem.returnQuantity,\r\n                documentId: newReturn.id,\r\n                branchSystemId: newReturn.branchSystemId,\r\n                branch: newReturn.branchName,\r\n            });\r\n        }\r\n    });\r\n\r\n    // 4. Create receipt when supplier refunds money (supplier pays company)\r\n    if (newReturn.refundAmount > 0) {\r\n      const receiptCategory = receiptTypes.find(pt => pt.name === 'Nhà cung cấp hoàn tiền');\r\n      if (newReturn.accountSystemId) {\r\n        const account = accounts.find(acc => acc.systemId === newReturn.accountSystemId);\r\n        const issuedAt = formatDateCustom(getCurrentDate(), 'yyyy-MM-dd HH:mm');\r\n\r\n        const refundReceipt: Omit<Receipt, 'systemId'> = {\r\n          id: asBusinessId(''), // Let receipt store auto-generate PT-XXXXXX\r\n          date: issuedAt,\r\n          amount: newReturn.refundAmount,\r\n\r\n          // Payer info (TargetGroup placeholder)\r\n          payerTypeSystemId: asSystemId('NHACUNGCAP'),\r\n          payerTypeName: 'Nhà cung cấp',\r\n          payerName: newReturn.supplierName,\r\n          payerSystemId: newReturn.supplierSystemId,\r\n\r\n          description: `Nhận hoàn tiền cho đơn nhập ${newReturn.purchaseOrderId} (Phiếu trả hàng ${newReturn.id})`,\r\n\r\n          // Payment method placeholders — should map to settings\r\n          paymentMethodSystemId: asSystemId(account?.type === 'cash' ? 'PAYMENT_METHOD_CASH' : 'PAYMENT_METHOD_BANK'),\r\n          paymentMethodName: newReturn.refundMethod,\r\n\r\n          accountSystemId: newReturn.accountSystemId,\r\n          paymentReceiptTypeSystemId: receiptCategory?.systemId ?? asSystemId('RT_SUPPLIER_REFUND'),\r\n          paymentReceiptTypeName: receiptCategory?.name ?? 'Nhà cung cấp hoàn tiền',\r\n\r\n          branchSystemId: newReturn.branchSystemId,\r\n          branchName: newReturn.branchName,\r\n          createdBy: asSystemId('SYSTEM'),\r\n          createdAt: issuedAt,\r\n\r\n          status: 'completed',\r\n          category: 'other',\r\n          affectsDebt: true,\r\n\r\n          purchaseOrderSystemId: newReturn.purchaseOrderSystemId,\r\n          purchaseOrderId: newReturn.purchaseOrderId,\r\n          originalDocumentId: newReturn.id,\r\n        };\r\n\r\n        addReceipt(refundReceipt);\r\n        }\r\n    }\r\n\r\n    // 5. Update the original Purchase Order's status\r\n    const po = allPOs.find(p => asSystemId(p.systemId) === newReturn.purchaseOrderSystemId);\r\n    if (po) {\r\n        // A full check would require summing all returns for this PO.\r\n        const allItems = po.lineItems;\r\n        const poSystemId = asSystemId(po.systemId);\r\n        const allReturnedItems = baseStore.getState().data\r\n        .filter(pr => pr.purchaseOrderSystemId === poSystemId)\r\n            .flatMap(pr => pr.items);\r\n            \r\n      const receiptsForPO = allReceipts.filter(r => r.purchaseOrderSystemId === poSystemId);\r\n\r\n        const isFullReturn = allItems.every(poItem => {\r\n            const totalReceived = receiptsForPO.reduce((sum, receipt) => {\r\n                const receiptItem = receipt.items.find(i => i.productSystemId === poItem.productSystemId);\r\n                return sum + (receiptItem ? Number(receiptItem.receivedQuantity) : 0);\r\n            }, 0);\r\n\r\n            const totalReturned = allReturnedItems\r\n                .filter(returnedItem => returnedItem.productSystemId === poItem.productSystemId)\r\n                .reduce((sum, returnedItem) => sum + returnedItem.returnQuantity, 0);\r\n            \r\n            return totalReturned >= totalReceived;\r\n        });\r\n        \r\n        const existingReturnsForPO = baseStore.getState().data.filter(pr => pr.purchaseOrderSystemId === poSystemId && pr.systemId !== newReturn.systemId);\r\n        const allReturnsForPO = [...existingReturnsForPO, newReturn];\r\n        const totalReturnedValue = allReturnsForPO.reduce((sum, r) => sum + r.totalReturnValue, 0);\r\n        const totalRefunded = allReturnsForPO.reduce((sum, r) => sum + r.refundAmount, 0);\r\n\r\n        let newRefundStatus: PurchaseOrderRefundStatus = po.refundStatus || 'Chưa hoàn tiền';\r\n        if (totalReturnedValue > 0) {\r\n            if (totalRefunded >= totalReturnedValue) {\r\n                newRefundStatus = 'Hoàn tiền toàn bộ';\r\n            } else if (totalRefunded > 0) {\r\n                newRefundStatus = 'Hoàn tiền một phần';\r\n            } else {\r\n                newRefundStatus = 'Chưa hoàn tiền';\r\n            }\r\n        }\r\n\r\n        updatePOonReturn(po.id, isFullReturn, newRefundStatus, newReturn.id, newReturn.creatorName);\r\n    }\r\n\r\n    return newReturn;\r\n};\r\n\r\nconst otherMethods = {\r\n  findByPurchaseOrderSystemId: (purchaseOrderSystemId: SystemId) => {\r\n    return baseStore.getState().data.filter(pr => pr.purchaseOrderSystemId === purchaseOrderSystemId);\r\n  }\r\n};\r\n\r\ntype BaseState = CrudState<PurchaseReturn>;\r\n\r\nexport type PurchaseReturnStoreState = Omit<BaseState, 'add'> & {\r\n  add: typeof newAdd;\r\n  findByPurchaseOrderSystemId: (purchaseOrderSystemId: SystemId) => PurchaseReturn[];\r\n};\r\n\r\nexport const usePurchaseReturnStore = (): PurchaseReturnStoreState => {\r\n  const { add: _unusedAdd, ...rest } = baseStore();\r\n  return {\r\n    ...rest,\r\n    add: newAdd,\r\n    ...otherMethods,\r\n  } as PurchaseReturnStoreState;\r\n};\r\n\r\nusePurchaseReturnStore.getState = (): PurchaseReturnStoreState => {\r\n  const { add: _unusedAdd, ...rest } = baseStore.getState();\r\n  return {\r\n    ...rest,\r\n    add: newAdd,\r\n    ...otherMethods,\r\n  } as PurchaseReturnStoreState;\r\n};\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 9352, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/purchase-orders/payment-utils.ts"],"sourcesContent":["import type { Payment } from '../payments/types';\r\nimport type { Receipt } from '../receipts/types';\r\nimport type { PurchaseOrder } from './types';\r\n\r\nconst SUPPLIER_TARGET_IDS = ['NHACUNGCAP', 'supplier'];\r\nconst SUPPLIER_TARGET_LABELS = ['Nhà cung cấp'];\r\n\r\nexport const isPaymentLinkedToPurchaseOrder = (payment: Payment, purchaseOrder: PurchaseOrder): boolean => {\r\n  if (!payment || !purchaseOrder) {\r\n    return false;\r\n  }\r\n\r\n  if (payment.purchaseOrderSystemId) {\r\n    return payment.purchaseOrderSystemId === purchaseOrder.systemId;\r\n  }\r\n\r\n  if (payment.originalDocumentId) {\r\n    return (\r\n      payment.originalDocumentId === purchaseOrder.systemId ||\r\n      payment.originalDocumentId === purchaseOrder.id\r\n    );\r\n  }\r\n\r\n  const isSupplierTarget =\r\n    (payment.recipientTypeSystemId && SUPPLIER_TARGET_IDS.includes(payment.recipientTypeSystemId)) ||\r\n    (payment.recipientTypeName && SUPPLIER_TARGET_LABELS.includes(payment.recipientTypeName));\r\n\r\n  if (isSupplierTarget && payment.recipientSystemId && payment.recipientSystemId === purchaseOrder.supplierSystemId) {\r\n    return true;\r\n  }\r\n\r\n  return false;\r\n};\r\n\r\nexport const getPaymentsForPurchaseOrder = (payments: Payment[], purchaseOrder: PurchaseOrder): Payment[] => {\r\n  if (!Array.isArray(payments) || !purchaseOrder) {\r\n    return [];\r\n  }\r\n  return payments.filter(payment => isPaymentLinkedToPurchaseOrder(payment, purchaseOrder));\r\n};\r\n\r\nexport const sumPaymentsForPurchaseOrder = (payments: Payment[], purchaseOrder: PurchaseOrder): number => {\r\n  return getPaymentsForPurchaseOrder(payments, purchaseOrder).reduce((sum, payment) => sum + (payment.amount || 0), 0);\r\n};\r\n\r\nexport const isReceiptLinkedToPurchaseOrder = (receipt: Receipt, purchaseOrder: PurchaseOrder): boolean => {\r\n  if (!receipt || !purchaseOrder) {\r\n    return false;\r\n  }\r\n\r\n  if (receipt.purchaseOrderSystemId) {\r\n    return receipt.purchaseOrderSystemId === purchaseOrder.systemId;\r\n  }\r\n\r\n  if (receipt.originalDocumentId) {\r\n    return (\r\n      receipt.originalDocumentId === purchaseOrder.systemId ||\r\n      receipt.originalDocumentId === purchaseOrder.id\r\n    );\r\n  }\r\n\r\n  const isSupplierTarget =\r\n    (receipt.payerTypeSystemId && SUPPLIER_TARGET_IDS.includes(receipt.payerTypeSystemId)) ||\r\n    (receipt.payerTypeName && SUPPLIER_TARGET_LABELS.includes(receipt.payerTypeName));\r\n\r\n  if (isSupplierTarget && receipt.payerSystemId && receipt.payerSystemId === purchaseOrder.supplierSystemId) {\r\n    return true;\r\n  }\r\n\r\n  return false;\r\n};\r\n\r\nexport const getReceiptsForPurchaseOrder = (receipts: Receipt[], purchaseOrder: PurchaseOrder): Receipt[] => {\r\n  if (!Array.isArray(receipts) || !purchaseOrder) {\r\n    return [];\r\n  }\r\n  return receipts.filter(receipt => isReceiptLinkedToPurchaseOrder(receipt, purchaseOrder));\r\n};\r\n"],"names":[],"mappings":";;;;;;;;;;;;AAIA,MAAM,sBAAsB;IAAC;IAAc;CAAW;AACtD,MAAM,yBAAyB;IAAC;CAAe;AAExC,MAAM,iCAAiC,CAAC,SAAkB;IAC/D,IAAI,CAAC,WAAW,CAAC,eAAe;QAC9B,OAAO;IACT;IAEA,IAAI,QAAQ,qBAAqB,EAAE;QACjC,OAAO,QAAQ,qBAAqB,KAAK,cAAc,QAAQ;IACjE;IAEA,IAAI,QAAQ,kBAAkB,EAAE;QAC9B,OACE,QAAQ,kBAAkB,KAAK,cAAc,QAAQ,IACrD,QAAQ,kBAAkB,KAAK,cAAc,EAAE;IAEnD;IAEA,MAAM,mBACJ,AAAC,QAAQ,qBAAqB,IAAI,oBAAoB,QAAQ,CAAC,QAAQ,qBAAqB,KAC3F,QAAQ,iBAAiB,IAAI,uBAAuB,QAAQ,CAAC,QAAQ,iBAAiB;IAEzF,IAAI,oBAAoB,QAAQ,iBAAiB,IAAI,QAAQ,iBAAiB,KAAK,cAAc,gBAAgB,EAAE;QACjH,OAAO;IACT;IAEA,OAAO;AACT;AAEO,MAAM,8BAA8B,CAAC,UAAqB;IAC/D,IAAI,CAAC,MAAM,OAAO,CAAC,aAAa,CAAC,eAAe;QAC9C,OAAO,EAAE;IACX;IACA,OAAO,SAAS,MAAM,CAAC,CAAA,UAAW,+BAA+B,SAAS;AAC5E;AAEO,MAAM,8BAA8B,CAAC,UAAqB;IAC/D,OAAO,4BAA4B,UAAU,eAAe,MAAM,CAAC,CAAC,KAAK,UAAY,MAAM,CAAC,QAAQ,MAAM,IAAI,CAAC,GAAG;AACpH;AAEO,MAAM,iCAAiC,CAAC,SAAkB;IAC/D,IAAI,CAAC,WAAW,CAAC,eAAe;QAC9B,OAAO;IACT;IAEA,IAAI,QAAQ,qBAAqB,EAAE;QACjC,OAAO,QAAQ,qBAAqB,KAAK,cAAc,QAAQ;IACjE;IAEA,IAAI,QAAQ,kBAAkB,EAAE;QAC9B,OACE,QAAQ,kBAAkB,KAAK,cAAc,QAAQ,IACrD,QAAQ,kBAAkB,KAAK,cAAc,EAAE;IAEnD;IAEA,MAAM,mBACJ,AAAC,QAAQ,iBAAiB,IAAI,oBAAoB,QAAQ,CAAC,QAAQ,iBAAiB,KACnF,QAAQ,aAAa,IAAI,uBAAuB,QAAQ,CAAC,QAAQ,aAAa;IAEjF,IAAI,oBAAoB,QAAQ,aAAa,IAAI,QAAQ,aAAa,KAAK,cAAc,gBAAgB,EAAE;QACzG,OAAO;IACT;IAEA,OAAO;AACT;AAEO,MAAM,8BAA8B,CAAC,UAAqB;IAC/D,IAAI,CAAC,MAAM,OAAO,CAAC,aAAa,CAAC,eAAe;QAC9C,OAAO,EAAE;IACX;IACA,OAAO,SAAS,MAAM,CAAC,CAAA,UAAW,+BAA+B,SAAS;AAC5E"}},
    {"offset": {"line": 9425, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/purchase-orders/store.ts"],"sourcesContent":["import { create } from 'zustand';\r\n// REMOVED: import { data as initialDataOmit } from './data'; // Mock data no longer used - database is source of truth\r\nimport type { PurchaseOrder, PurchaseOrderPayment, PurchaseOrderStatus, DeliveryStatus, PaymentStatus, PurchaseOrderReturnStatus, PurchaseOrderRefundStatus } from './types';\r\nimport type { HistoryEntry } from '../../components/ActivityHistory';\r\n// REMOVED: Voucher store no longer exists\r\n// import { useVoucherStore } from '../vouchers/store';\r\nimport { useInventoryReceiptStore, syncInventoryReceiptsWithPurchaseOrders } from '../inventory-receipts/store';\r\nimport { usePaymentStore } from '../payments/store';\r\nimport type { Payment } from '../payments/types';\r\nimport { useReceiptStore } from '../receipts/store';\r\nimport type { Receipt } from '../receipts/types';\r\nimport { useEmployeeStore } from '../employees/store';\r\nimport { usePurchaseReturnStore } from '../purchase-returns/store';\r\nimport { formatDate, formatDateCustom, toISODate, toISODateTime } from '../../lib/date-utils';\r\nimport { useCashbookStore } from '../cashbook/store';\r\nimport { useReceiptTypeStore } from '../settings/receipt-types/store';\r\nimport { usePaymentTypeStore } from '../settings/payments/types/store';\r\nimport { createCrudStore } from '../../lib/store-factory';\r\nimport { sumPaymentsForPurchaseOrder } from './payment-utils';\r\nimport { useProductStore } from '../products/store';\r\nimport { asSystemId } from '@/lib/id-types';\r\n\r\n// REMOVED: initialDataOmit transformation - database is source of truth\r\nconst initialData: PurchaseOrder[] = [];\r\n\r\nconst baseStore = createCrudStore<any>([], 'purchase-orders', {\r\n  businessIdField: 'id',\r\n  apiEndpoint: '/api/purchase-orders',\r\n});\r\n\r\nconst runInventoryReceiptBackfill = () => {\r\n  syncInventoryReceiptsWithPurchaseOrders({\r\n    purchaseOrders: baseStore.getState().data,\r\n    products: useProductStore.getState().data,\r\n  });\r\n};\r\n\r\nrunInventoryReceiptBackfill();\r\n\r\n// Re-run backfill whenever purchase orders or products hydrate/update\r\n(baseStore as typeof baseStore & { subscribe?: (listener: () => void) => () => void }).subscribe?.(() => {\r\n  runInventoryReceiptBackfill();\r\n});\r\n\r\n(useProductStore as typeof useProductStore & { subscribe?: (listener: () => void) => () => void }).subscribe?.(() => {\r\n  runInventoryReceiptBackfill();\r\n});\r\n\r\n// Helper functions for ActivityHistory\r\nconst getCurrentUserInfo = () => {\r\n  const employees = useEmployeeStore.getState().data;\r\n  // Fallback to system user\r\n  return { systemId: 'SYSTEM', name: 'Hệ thống' };\r\n};\r\n\r\nconst createHistoryEntry = (\r\n  action: HistoryEntry['action'],\r\n  description: string,\r\n  user: { systemId: string; name: string },\r\n  metadata?: HistoryEntry['metadata']\r\n): HistoryEntry => ({\r\n  id: crypto.randomUUID(),\r\n  action,\r\n  timestamp: new Date(),\r\n  user: { systemId: user.systemId, name: user.name },\r\n  description,\r\n  metadata,\r\n});\r\n\r\nconst augmentedMethods = {\r\n  addPayment: (purchaseOrderId: string, payment: Omit<PurchaseOrderPayment, 'id'>) => baseStore.setState(state => {\r\n    const { data: allReturns } = usePurchaseReturnStore.getState();\r\n    const newData = state.data.map(po => {\r\n      if (po.systemId === purchaseOrderId) {\r\n        const poSystemId = asSystemId(po.systemId);\r\n        const newPayment: PurchaseOrderPayment = {\r\n          ...payment,\r\n          id: `PAY_${po.id}_${(po.payments || []).length + 1}`\r\n        };\r\n        const updatedPayments = [...(po.payments || []), newPayment];\r\n        const totalPaid = updatedPayments.reduce((sum, p) => sum + p.amount, 0);\r\n\r\n        const totalReturnedValue = allReturns\r\n          .filter(r => r.purchaseOrderSystemId === poSystemId)\r\n          .reduce((sum, r) => sum + r.totalReturnValue, 0);\r\n        const actualDebt = po.grandTotal - totalReturnedValue;\r\n        \r\n        let newPaymentStatus: PurchaseOrder['paymentStatus'];\r\n        if (totalPaid >= actualDebt) {\r\n          newPaymentStatus = 'Đã thanh toán';\r\n        } else if (totalPaid > 0) {\r\n          newPaymentStatus = 'Thanh toán một phần';\r\n        } else {\r\n          newPaymentStatus = 'Chưa thanh toán';\r\n        }\r\n\r\n        let newStatus: PurchaseOrderStatus = po.status;\r\n        if (po.status !== 'Đã hủy' && po.status !== 'Kết thúc') {\r\n          // Hoàn thành: đã nhập hết + đã thanh toán hết\r\n          if (po.deliveryStatus === 'Đã nhập' && newPaymentStatus === 'Đã thanh toán') {\r\n            newStatus = 'Hoàn thành';\r\n          }\r\n          // Đặt hàng: chưa nhập + chưa thanh toán\r\n          else if (po.deliveryStatus === 'Chưa nhập' && newPaymentStatus === 'Chưa thanh toán') {\r\n            newStatus = 'Đặt hàng';\r\n          }\r\n          // Đang giao dịch: tất cả trường hợp khác\r\n          else {\r\n            newStatus = 'Đang giao dịch';\r\n          }\r\n        }\r\n        \r\n        return { ...po, payments: updatedPayments, paymentStatus: newPaymentStatus, status: newStatus };\r\n      }\r\n      return po;\r\n    });\r\n    return { data: newData };\r\n  }),\r\n  updatePaymentStatusForPoIds: (poIds: string[]) => {\r\n    baseStore.setState(state => {\r\n        const { data: allPayments } = usePaymentStore.getState();\r\n        const { data: allReturns } = usePurchaseReturnStore.getState();\r\n        const uniquePoIds = [...new Set(poIds)];\r\n    \r\n        const newData = [...state.data];\r\n        let changed = false;\r\n\r\n        uniquePoIds.forEach(poId => {\r\n            const poIndex = newData.findIndex(p => p.id === poId);\r\n            if (poIndex === -1) return;\r\n\r\n            const po = newData[poIndex] as PurchaseOrder;\r\n            const poSystemId = asSystemId(po.systemId);\r\n            \r\n            const totalPaid = sumPaymentsForPurchaseOrder(allPayments, po);\r\n            \r\n            const totalReturnedValue = allReturns\r\n              .filter(r => r.purchaseOrderSystemId === poSystemId)\r\n                .reduce((sum, r) => sum + r.totalReturnValue, 0);\r\n            const actualDebt = po.grandTotal - totalReturnedValue;\r\n\r\n            let newPaymentStatus: PaymentStatus;\r\n            if (totalPaid >= actualDebt) {\r\n                newPaymentStatus = 'Đã thanh toán';\r\n            } else if (totalPaid > 0) {\r\n                newPaymentStatus = 'Thanh toán một phần';\r\n            } else {\r\n                newPaymentStatus = 'Chưa thanh toán';\r\n            }\r\n            \r\n            let newStatus: PurchaseOrderStatus = po.status;\r\n            if (po.status !== 'Đã hủy' && po.status !== 'Kết thúc') {\r\n              // Hoàn thành: đã nhập hết + đã thanh toán hết\r\n              if (po.deliveryStatus === 'Đã nhập' && newPaymentStatus === 'Đã thanh toán') {\r\n                newStatus = 'Hoàn thành';\r\n              }\r\n              // Đặt hàng: chưa nhập + chưa thanh toán\r\n              else if (po.deliveryStatus === 'Chưa nhập' && newPaymentStatus === 'Chưa thanh toán') {\r\n                newStatus = 'Đặt hàng';\r\n              }\r\n              // Đang giao dịch: tất cả trường hợp khác\r\n              else {\r\n                newStatus = 'Đang giao dịch';\r\n              }\r\n            }\r\n\r\n            if (po.paymentStatus !== newPaymentStatus || po.status !== newStatus) {\r\n                newData[poIndex] = { ...po, paymentStatus: newPaymentStatus, status: newStatus };\r\n                changed = true;\r\n            }\r\n        });\r\n\r\n        return changed ? { data: newData } : state;\r\n    });\r\n  },\r\n  processInventoryReceipt: (purchaseOrderSystemId: string) => {\r\n    baseStore.setState(state => {\r\n      const { data: allReceipts } = useInventoryReceiptStore.getState();\r\n      const poIndex = state.data.findIndex(p => p.systemId === purchaseOrderSystemId);\r\n      if (poIndex === -1) return state;\r\n\r\n      const po = state.data[poIndex] as PurchaseOrder;\r\n      const poReceipts = allReceipts.filter(r => r.purchaseOrderSystemId === purchaseOrderSystemId);\r\n      const totalReceivedByProduct = po.lineItems.reduce((acc, lineItem) => {\r\n        const totalReceived = poReceipts.reduce((sum, receipt) => {\r\n          const item = receipt.items.find(i => i.productSystemId === lineItem.productSystemId);\r\n          return sum + (item ? Number(item.receivedQuantity) : 0);\r\n        }, 0);\r\n        acc[lineItem.productSystemId] = totalReceived;\r\n        return acc;\r\n      }, {} as Record<string, number>);\r\n\r\n      const allItemsFullyReceived = po.lineItems.every(item => (totalReceivedByProduct[item.productSystemId] || 0) >= item.quantity);\r\n      const anyItemReceived = Object.values(totalReceivedByProduct).some(qty => qty > 0);\r\n\r\n      let newDeliveryStatus: DeliveryStatus;\r\n      if (allItemsFullyReceived) {\r\n        newDeliveryStatus = 'Đã nhập';\r\n      } else if (anyItemReceived) {\r\n        newDeliveryStatus = 'Đã nhập một phần';\r\n      } else {\r\n        newDeliveryStatus = 'Chưa nhập';\r\n      }\r\n      \r\n      let newStatus: PurchaseOrderStatus = po.status;\r\n      // Chỉ tự động cập nhật status nếu KHÔNG phải trạng thái terminal\r\n      if (po.status !== 'Đã hủy' && po.status !== 'Kết thúc') {\r\n          // Hoàn thành: đã nhập hết + đã thanh toán hết\r\n          if (newDeliveryStatus === 'Đã nhập' && po.paymentStatus === 'Đã thanh toán') {\r\n            newStatus = 'Hoàn thành';\r\n          }\r\n          // Đặt hàng: chưa nhập + chưa thanh toán\r\n          else if (newDeliveryStatus === 'Chưa nhập' && po.paymentStatus === 'Chưa thanh toán') {\r\n            newStatus = 'Đặt hàng';\r\n          }\r\n          // Đang giao dịch: tất cả trường hợp khác\r\n          else {\r\n            newStatus = 'Đang giao dịch';\r\n          }\r\n      }\r\n\r\n      if (po.deliveryStatus !== newDeliveryStatus || po.status !== newStatus) {\r\n        const newData = [...state.data];\r\n        const updatedPO: PurchaseOrder = { ...po, deliveryStatus: newDeliveryStatus, status: newStatus };\r\n\r\n        if (po.deliveryStatus === 'Chưa nhập' && newDeliveryStatus !== 'Chưa nhập') {\r\n          const latestReceipt = poReceipts.sort((a,b) => new Date(b.receivedDate).getTime() - new Date(a.receivedDate).getTime())[0];\r\n          if (latestReceipt) {\r\n            updatedPO.deliveryDate = latestReceipt.receivedDate;\r\n          }\r\n        }\r\n\r\n        newData[poIndex] = updatedPO;\r\n\r\n        const latestReceipt = poReceipts.sort((a,b) => new Date(b.receivedDate).getTime() - new Date(a.receivedDate).getTime())[0];\r\n        const receiptReceiverName = latestReceipt?.receiverName || 'Hệ thống';\r\n        const user = latestReceipt?.receiverSystemId\r\n          ? useEmployeeStore.getState().data.find(e => e.systemId === latestReceipt.receiverSystemId)\r\n          : useEmployeeStore.getState().data.find(e => e.fullName === receiptReceiverName);\r\n\r\n        // Add to activityHistory\r\n        const historyEntry = createHistoryEntry(\r\n          'status_changed',\r\n          `Cập nhật trạng thái giao hàng thành \"${newDeliveryStatus}\" thông qua phiếu nhập kho ${latestReceipt.id}.`,\r\n          { systemId: user?.systemId || 'SYSTEM', name: receiptReceiverName },\r\n          { oldValue: po.deliveryStatus, newValue: newDeliveryStatus, field: 'deliveryStatus' }\r\n        );\r\n        newData[poIndex] = {\r\n          ...updatedPO,\r\n          activityHistory: [...(updatedPO.activityHistory || []), historyEntry],\r\n        };\r\n\r\n        return { data: newData };\r\n      }\r\n\r\n      return state;\r\n    });\r\n  },\r\n  processReturn: (purchaseOrderId, isFullReturn, newRefundStatus, returnId, creatorName) => baseStore.setState(state => {\r\n        const poIndex = state.data.findIndex(p => p.id === purchaseOrderId);\r\n        if (poIndex === -1) return state;\r\n\r\n        const po = state.data[poIndex] as PurchaseOrder;\r\n\r\n        let newReturnStatus: PurchaseOrderReturnStatus = 'Hoàn hàng một phần';\r\n        if (isFullReturn) {\r\n            newReturnStatus = 'Hoàn hàng toàn bộ';\r\n        }\r\n        \r\n        // QUAN TRỌNG: Không đè status thành \"Đã trả hàng\"\r\n        // Chỉ cập nhật returnStatus, giữ nguyên status chính (Hoàn thành, Đang giao dịch, etc.)\r\n        // Logic tự động sẽ xử lý status dựa trên deliveryStatus + paymentStatus\r\n        \r\n        const updatedPO = { \r\n            ...po, \r\n            returnStatus: newReturnStatus,\r\n            // Bỏ dòng: status: newStatus,  \r\n            ...(newRefundStatus && { refundStatus: newRefundStatus })\r\n        };\r\n        \r\n        if (returnId && creatorName) {\r\n            const user = useEmployeeStore.getState().data.find(e => e.fullName === creatorName);\r\n            // Add to activityHistory\r\n            const historyEntry = createHistoryEntry(\r\n              'status_changed',\r\n              `Tạo phiếu hoàn trả ${returnId}, cập nhật trạng thái hoàn trả đơn hàng.`,\r\n              { systemId: user?.systemId || 'SYSTEM', name: creatorName },\r\n              { oldValue: po.returnStatus || 'Chưa hoàn trả', newValue: newReturnStatus, field: 'returnStatus' }\r\n            );\r\n            updatedPO.activityHistory = [...(updatedPO.activityHistory || []), historyEntry];\r\n        }\r\n        \r\n        const newData = [...state.data];\r\n        newData[poIndex] = updatedPO;\r\n\r\n        return { data: newData };\r\n    }),\r\n  syncAllPurchaseOrderStatuses: () => baseStore.setState(state => {\r\n      const { data: allPayments } = usePaymentStore.getState();\r\n      const { data: allReturns } = usePurchaseReturnStore.getState();\r\n      const newData = state.data.map((po_untyped) => {\r\n        const po = po_untyped as PurchaseOrder;\r\n        const poSystemId = asSystemId(po.systemId);\r\n        const totalPaid = sumPaymentsForPurchaseOrder(allPayments, po);\r\n        \r\n        const totalReturnedValue = allReturns\r\n          .filter(r => r.purchaseOrderSystemId === poSystemId)\r\n          .reduce((sum, r) => sum + r.totalReturnValue, 0);\r\n        const actualDebt = po.grandTotal - totalReturnedValue;\r\n        \r\n        let newPaymentStatus: PaymentStatus;\r\n        if (totalPaid >= actualDebt) {\r\n          newPaymentStatus = 'Đã thanh toán';\r\n        } else if (totalPaid > 0) {\r\n          newPaymentStatus = 'Thanh toán một phần';\r\n        } else {\r\n          newPaymentStatus = 'Chưa thanh toán';\r\n        }\r\n        \r\n        let newStatus: PurchaseOrderStatus = po.status;\r\n        // Chỉ tự động cập nhật status nếu KHÔNG phải trạng thái terminal (Đã hủy, Kết thúc)\r\n        // Bỏ check \"Đã trả hàng\" vì đây không còn là status chính nữa\r\n        if (po.status !== 'Đã hủy' && po.status !== 'Kết thúc') {\r\n          // Hoàn thành: đã nhập hết + đã thanh toán hết\r\n          if (po.deliveryStatus === 'Đã nhập' && newPaymentStatus === 'Đã thanh toán') {\r\n            newStatus = 'Hoàn thành';\r\n          }\r\n          // Đặt hàng: chưa nhập + chưa thanh toán\r\n          else if (po.deliveryStatus === 'Chưa nhập' && newPaymentStatus === 'Chưa thanh toán') {\r\n            newStatus = 'Đặt hàng';\r\n          }\r\n          // Đang giao dịch: tất cả trường hợp khác (đã có hoạt động nhập hoặc thanh toán)\r\n          else {\r\n            newStatus = 'Đang giao dịch';\r\n          }\r\n        }\r\n        \r\n        if (po.paymentStatus !== newPaymentStatus || po.status !== newStatus) {\r\n            return { ...po, paymentStatus: newPaymentStatus, status: newStatus };\r\n        }\r\n        return po;\r\n      });\r\n\r\n      const hasChanged = newData.some((po, index) => po !== state.data[index]);\r\n      return hasChanged ? { data: newData } : state;\r\n    }),\r\n  finishOrder: (systemId: string, userId: string, userName: string) => baseStore.setState(state => {\r\n    const poIndex = state.data.findIndex(p => p.systemId === systemId);\r\n    if (poIndex === -1) return state;\r\n\r\n    const po = state.data[poIndex];\r\n    if (po.status === 'Kết thúc' || po.status === 'Đã hủy') return state;\r\n\r\n    // Add to activityHistory\r\n    const historyEntry = createHistoryEntry(\r\n      'ended',\r\n      `Đã kết thúc đơn hàng.`,\r\n      { systemId: userId, name: userName },\r\n      { oldValue: po.status, newValue: 'Kết thúc', field: 'status' }\r\n    );\r\n    const updatedPO = { \r\n      ...po, \r\n      status: 'Kết thúc' as PurchaseOrderStatus,\r\n      activityHistory: [...(po.activityHistory || []), historyEntry],\r\n    };\r\n    \r\n    const newData = [...state.data];\r\n    newData[poIndex] = updatedPO;\r\n    return { data: newData };\r\n  }),\r\n  cancelOrder: (systemId: string, userId: string, userName: string) => baseStore.setState((state) => {\r\n    const po = state.data.find(p => p.systemId === systemId);\r\n\r\n    if (!po || ['Hoàn thành', 'Đã hủy', 'Kết thúc'].includes(po.status)) {\r\n        console.warn(`Attempted to cancel an order with status: ${po?.status}`);\r\n        return state;\r\n    }\r\n\r\n    const { data: allPayments } = usePaymentStore.getState();\r\n    const totalPaid = sumPaymentsForPurchaseOrder(allPayments, po);\r\n\r\n    if (totalPaid > 0) {\r\n        const { accounts } = useCashbookStore.getState();\r\n        const { data: receiptTypes } = useReceiptTypeStore.getState();\r\n        const { add: addReceipt } = useReceiptStore.getState();\r\n        const refundCategory = receiptTypes.find(rt => rt.name === 'Nhà cung cấp hoàn tiền');\r\n        const targetAccount = accounts.find(acc => acc.type === 'cash' && acc.branchSystemId === po.branchSystemId) || accounts.find(acc => acc.type === 'cash');\r\n\r\n        if (refundCategory && targetAccount) {\r\n           const newReceipt: Omit<Receipt, 'systemId'> = {\r\n            id: '' as any, // Let receipt store generate PT-XXXXXX\r\n            date: toISODateTime(new Date()),\r\n            amount: totalPaid,\r\n            payerType: 'Nhà cung cấp',\r\n            payerTypeSystemId: 'NHACUNGCAP',\r\n            payerTypeName: 'Nhà cung cấp',\r\n            payerName: po.supplierName,\r\n            payerSystemId: po.supplierSystemId,\r\n            description: `Nhận hoàn tiền từ NCC cho đơn hàng ${po.id} bị hủy.`,\r\n            paymentMethod: 'Tiền mặt',\r\n            paymentMethodSystemId: 'CASH',\r\n            paymentMethodName: 'Tiền mặt',\r\n            accountSystemId: targetAccount.systemId,\r\n            paymentReceiptTypeSystemId: refundCategory.systemId,\r\n            paymentReceiptTypeName: refundCategory.name,\r\n            branchSystemId: po.branchSystemId,\r\n            branchName: po.branchName,\r\n            createdBy: userName,\r\n            createdAt: toISODateTime(new Date()),\r\n            status: 'completed',\r\n            category: 'other',\r\n            affectsDebt: true,\r\n            purchaseOrderSystemId: po.systemId,\r\n            purchaseOrderId: po.id,\r\n            originalDocumentId: po.id,\r\n          } as any;\r\n          addReceipt(newReceipt);\r\n        } else {\r\n            console.error(\"Không thể tạo phiếu thu hoàn tiền: Thiếu loại phiếu 'Nhà cung cấp hoàn tiền' hoặc tài khoản quỹ tiền mặt.\");\r\n        }\r\n    }\r\n    \r\n    // Add to activityHistory\r\n    const historyEntry = createHistoryEntry(\r\n      'cancelled',\r\n      `Đã hủy đơn hàng.`,\r\n      { systemId: userId, name: userName },\r\n      { oldValue: po.status, newValue: 'Đã hủy', field: 'status' }\r\n    );\r\n    const updatedPO = { \r\n      ...po, \r\n      status: 'Đã hủy' as const,\r\n      activityHistory: [...(po.activityHistory || []), historyEntry],\r\n    };\r\n    \r\n    return { data: state.data.map(item => item.systemId === systemId ? updatedPO : item) };\r\n  }),\r\n  \r\n  bulkCancel: (systemIds: string[], userId: string, userName: string) => {\r\n    systemIds.forEach(systemId => {\r\n      augmentedMethods.cancelOrder(systemId, userId, userName);\r\n    });\r\n  },\r\n  \r\n  printPurchaseOrders: (systemIds: string[]) => {\r\n    // Placeholder for print functionality\r\n    console.log('Printing purchase orders:', systemIds);\r\n    // TODO: Implement actual print logic\r\n  },\r\n};\r\n\r\n// Define the enhanced store interface\r\nexport interface PurchaseOrderStoreState {\r\n  data: PurchaseOrder[];\r\n  add: (item: Omit<PurchaseOrder, 'systemId'>) => PurchaseOrder;\r\n  addMultiple: (items: Omit<PurchaseOrder, 'systemId'>[]) => void;\r\n  update: (systemId: string, item: PurchaseOrder) => void;\r\n  remove: (systemId: string) => void;\r\n  findById: (systemId: string) => PurchaseOrder | undefined;\r\n  addPayment: (purchaseOrderId: string, payment: Omit<PurchaseOrderPayment, 'id'>) => void;\r\n  updatePaymentStatusForPoIds: (poIds: string[]) => void;\r\n  processInventoryReceipt: (purchaseOrderSystemId: string) => void;\r\n  processReturn: (purchaseOrderId: string, isFullReturn: boolean, newRefundStatus: PurchaseOrderRefundStatus | undefined, returnId: string, creatorName: string) => void;\r\n  syncAllPurchaseOrderStatuses: () => void;\r\n  finishOrder: (systemId: string, userId: string, userName: string) => void;\r\n  cancelOrder: (systemId: string, userId: string, userName: string) => void;\r\n  bulkCancel: (systemIds: string[], userId: string, userName: string) => void;\r\n  printPurchaseOrders: (systemIds: string[]) => void;\r\n}\r\n\r\n// Export typed hook\r\nexport const usePurchaseOrderStore = (): PurchaseOrderStoreState => {\r\n  const state = baseStore();\r\n  return {\r\n    ...state,\r\n    ...augmentedMethods,\r\n  };\r\n};\r\n\r\n// Export getState for non-hook usage\r\nusePurchaseOrderStore.getState = () => {\r\n  const state = baseStore.getState();\r\n  return {\r\n    ...state,\r\n    ...augmentedMethods,\r\n  };\r\n};\r\n"],"names":[],"mappings":"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"}}]
}