{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/payments/api/payments-api.ts"],"sourcesContent":["/**\r\n * Payments (Phiếu Chi) API functions\r\n * \r\n * ⚠️ Direct import: import { fetchPayments } from '@/features/payments/api/payments-api'\r\n */\r\n\r\nimport type { SystemId } from '@/lib/id-types';\r\nimport type { Payment, PaymentStatus, PaymentCategory } from '../types';\r\n\r\nconst BASE_URL = '/api/payments';\r\n\r\nexport interface PaymentsParams {\r\n  page?: number;\r\n  limit?: number;\r\n  search?: string;\r\n  status?: PaymentStatus;\r\n  category?: PaymentCategory;\r\n  recipientTypeSystemId?: string;\r\n  recipientSystemId?: string;\r\n  branchId?: string;\r\n  accountId?: string;\r\n  startDate?: string;\r\n  endDate?: string;\r\n  sortBy?: string;\r\n  sortOrder?: 'asc' | 'desc';\r\n}\r\n\r\nexport interface PaymentsResponse {\r\n  data: Payment[];\r\n  total: number;\r\n  page: number;\r\n  pageSize: number;\r\n}\r\n\r\nexport async function fetchPayments(params: PaymentsParams = {}): Promise<PaymentsResponse> {\r\n  const searchParams = new URLSearchParams();\r\n  \r\n  if (params.page) searchParams.set('page', String(params.page));\r\n  if (params.limit) searchParams.set('limit', String(params.limit));\r\n  if (params.search) searchParams.set('search', params.search);\r\n  if (params.status) searchParams.set('status', params.status);\r\n  if (params.category) searchParams.set('category', params.category);\r\n  if (params.recipientTypeSystemId) searchParams.set('recipientTypeSystemId', params.recipientTypeSystemId);\r\n  if (params.recipientSystemId) searchParams.set('recipientSystemId', params.recipientSystemId);\r\n  if (params.branchId) searchParams.set('branchId', params.branchId);\r\n  if (params.accountId) searchParams.set('accountId', params.accountId);\r\n  if (params.startDate) searchParams.set('startDate', params.startDate);\r\n  if (params.endDate) searchParams.set('endDate', params.endDate);\r\n  if (params.sortBy) searchParams.set('sortBy', params.sortBy);\r\n  if (params.sortOrder) searchParams.set('sortOrder', params.sortOrder);\r\n  \r\n  const url = searchParams.toString() ? `${BASE_URL}?${searchParams}` : BASE_URL;\r\n  const response = await fetch(url);\r\n  \r\n  if (!response.ok) {\r\n    throw new Error(`Failed to fetch payments: ${response.statusText}`);\r\n  }\r\n  \r\n  return response.json();\r\n}\r\n\r\nexport async function fetchPayment(systemId: SystemId): Promise<Payment> {\r\n  const response = await fetch(`${BASE_URL}/${systemId}`);\r\n  \r\n  if (!response.ok) {\r\n    throw new Error(`Failed to fetch payment: ${response.statusText}`);\r\n  }\r\n  \r\n  return response.json();\r\n}\r\n\r\nexport async function createPayment(data: Omit<Payment, 'systemId' | 'id' | 'createdAt' | 'updatedAt'>): Promise<Payment> {\r\n  const response = await fetch(BASE_URL, {\r\n    method: 'POST',\r\n    headers: { 'Content-Type': 'application/json' },\r\n    body: JSON.stringify(data),\r\n  });\r\n  \r\n  if (!response.ok) {\r\n    const error = await response.json().catch(() => ({}));\r\n    throw new Error(error.message || 'Failed to create payment');\r\n  }\r\n  \r\n  return response.json();\r\n}\r\n\r\nexport async function updatePayment(systemId: SystemId, data: Partial<Payment>): Promise<Payment> {\r\n  const response = await fetch(`${BASE_URL}/${systemId}`, {\r\n    method: 'PUT',\r\n    headers: { 'Content-Type': 'application/json' },\r\n    body: JSON.stringify(data),\r\n  });\r\n  \r\n  if (!response.ok) {\r\n    const error = await response.json().catch(() => ({}));\r\n    throw new Error(error.message || 'Failed to update payment');\r\n  }\r\n  \r\n  return response.json();\r\n}\r\n\r\nexport async function deletePayment(systemId: SystemId): Promise<void> {\r\n  const response = await fetch(`${BASE_URL}/${systemId}`, {\r\n    method: 'DELETE',\r\n  });\r\n  \r\n  if (!response.ok) {\r\n    throw new Error(`Failed to delete payment: ${response.statusText}`);\r\n  }\r\n}\r\n\r\nexport async function cancelPayment(systemId: SystemId, reason?: string): Promise<Payment> {\r\n  const response = await fetch(`${BASE_URL}/${systemId}/cancel`, {\r\n    method: 'POST',\r\n    headers: { 'Content-Type': 'application/json' },\r\n    body: JSON.stringify({ reason }),\r\n  });\r\n  \r\n  if (!response.ok) {\r\n    const error = await response.json().catch(() => ({}));\r\n    throw new Error(error.message || 'Failed to cancel payment');\r\n  }\r\n  \r\n  return response.json();\r\n}\r\n\r\nexport async function fetchPaymentStats(): Promise<{\r\n  total: number;\r\n  completed: number;\r\n  cancelled: number;\r\n  totalAmount: number;\r\n}> {\r\n  const response = await fetch(`${BASE_URL}/stats`);\r\n  \r\n  if (!response.ok) {\r\n    throw new Error(`Failed to fetch payment stats: ${response.statusText}`);\r\n  }\r\n  \r\n  return response.json();\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 120, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/payments/hooks/use-payments.ts"],"sourcesContent":["/**\r\n * usePayments - React Query hooks (Phiếu Chi)\r\n * \r\n * ⚠️ Direct import: import { usePayments } from '@/features/payments/hooks/use-payments'\r\n */\r\n\r\nimport { useQuery, useMutation, useQueryClient, keepPreviousData } from '@tanstack/react-query';\r\nimport {\r\n  fetchPayments,\r\n  fetchPayment,\r\n  createPayment,\r\n  updatePayment,\r\n  deletePayment,\r\n  cancelPayment,\r\n  fetchPaymentStats,\r\n  type PaymentsParams,\r\n} from '../api/payments-api';\r\nimport type { Payment } from '../types';\r\nimport { asSystemId } from '@/lib/id-types';\r\n\r\nexport const paymentKeys = {\r\n  all: ['payments'] as const,\r\n  lists: () => [...paymentKeys.all, 'list'] as const,\r\n  list: (params: PaymentsParams) => [...paymentKeys.lists(), params] as const,\r\n  details: () => [...paymentKeys.all, 'detail'] as const,\r\n  detail: (id: string) => [...paymentKeys.details(), id] as const,\r\n  stats: () => [...paymentKeys.all, 'stats'] as const,\r\n};\r\n\r\nexport function usePayments(params: PaymentsParams = {}) {\r\n  return useQuery({\r\n    queryKey: paymentKeys.list(params),\r\n    queryFn: () => fetchPayments(params),\r\n    staleTime: 30_000,\r\n    gcTime: 5 * 60 * 1000,\r\n    placeholderData: keepPreviousData,\r\n  });\r\n}\r\n\r\nexport function usePayment(id: string | null | undefined) {\r\n  return useQuery({\r\n    queryKey: paymentKeys.detail(id!),\r\n    queryFn: () => fetchPayment(asSystemId(id!)),\r\n    enabled: !!id,\r\n    staleTime: 60_000,\r\n  });\r\n}\r\n\r\nexport function usePaymentStats() {\r\n  return useQuery({\r\n    queryKey: paymentKeys.stats(),\r\n    queryFn: fetchPaymentStats,\r\n    staleTime: 60_000,\r\n  });\r\n}\r\n\r\ninterface UsePaymentMutationsOptions {\r\n  onCreateSuccess?: (payment: Payment) => void;\r\n  onUpdateSuccess?: (payment: Payment) => void;\r\n  onDeleteSuccess?: () => void;\r\n  onCancelSuccess?: (payment: Payment) => void;\r\n  onError?: (error: Error) => void;\r\n}\r\n\r\nexport function usePaymentMutations(options: UsePaymentMutationsOptions = {}) {\r\n  const queryClient = useQueryClient();\r\n  \r\n  const create = useMutation({\r\n    mutationFn: createPayment,\r\n    onSuccess: (data) => {\r\n      queryClient.invalidateQueries({ queryKey: paymentKeys.lists() });\r\n      queryClient.invalidateQueries({ queryKey: paymentKeys.stats() });\r\n      options.onCreateSuccess?.(data);\r\n    },\r\n    onError: options.onError,\r\n  });\r\n  \r\n  const update = useMutation({\r\n    mutationFn: ({ systemId, data }: { systemId: string; data: Partial<Payment> }) => \r\n      updatePayment(asSystemId(systemId), data),\r\n    onSuccess: (data, variables) => {\r\n      queryClient.invalidateQueries({ queryKey: paymentKeys.detail(variables.systemId) });\r\n      queryClient.invalidateQueries({ queryKey: paymentKeys.lists() });\r\n      queryClient.invalidateQueries({ queryKey: paymentKeys.stats() });\r\n      options.onUpdateSuccess?.(data);\r\n    },\r\n    onError: options.onError,\r\n  });\r\n  \r\n  const remove = useMutation({\r\n    mutationFn: (systemId: string) => deletePayment(asSystemId(systemId)),\r\n    onSuccess: () => {\r\n      queryClient.invalidateQueries({ queryKey: paymentKeys.all });\r\n      options.onDeleteSuccess?.();\r\n    },\r\n    onError: options.onError,\r\n  });\r\n  \r\n  const cancel = useMutation({\r\n    mutationFn: ({ systemId, reason }: { systemId: string; reason?: string }) => \r\n      cancelPayment(asSystemId(systemId), reason),\r\n    onSuccess: (data, variables) => {\r\n      queryClient.invalidateQueries({ queryKey: paymentKeys.detail(variables.systemId) });\r\n      queryClient.invalidateQueries({ queryKey: paymentKeys.lists() });\r\n      queryClient.invalidateQueries({ queryKey: paymentKeys.stats() });\r\n      options.onCancelSuccess?.(data);\r\n    },\r\n    onError: options.onError,\r\n  });\r\n  \r\n  return { create, update, remove, cancel };\r\n}\r\n\r\nexport function usePaymentsByRecipient(recipientSystemId: string | null | undefined) {\r\n  return usePayments({\r\n    recipientSystemId: recipientSystemId || undefined,\r\n    limit: 50,\r\n  });\r\n}\r\n\r\nexport function usePaymentsByBranch(branchId: string | null | undefined) {\r\n  return usePayments({\r\n    branchId: branchId || undefined,\r\n    limit: 100,\r\n  });\r\n}\r\n\r\nexport function usePaymentsByDateRange(startDate: string, endDate: string) {\r\n  return usePayments({ startDate, endDate });\r\n}\r\n\r\nexport function usePaymentsByCategory(category: Payment['category']) {\r\n  return usePayments({ category: category as any });\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 367, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/payments/store.ts"],"sourcesContent":["import { create } from 'zustand';\r\nimport type { Payment } from './types';\r\nimport type { HistoryEntry } from '../../components/ActivityHistory';\r\n// REMOVED: import { data as initialData } from './data'; // Mock data no longer used - database is source of truth\r\nimport {\r\n  extractCounterFromBusinessId,\r\n  findNextAvailableBusinessId,\r\n  generateSystemId,\r\n  getMaxBusinessIdCounter,\r\n  getMaxSystemIdCounter,\r\n  type EntityType,\r\n} from '../../lib/id-utils';\r\nimport { asBusinessId, asSystemId, type BusinessId, type SystemId } from '../../lib/id-types';\r\nimport { pickAccount, pickPaymentMethod, pickPaymentType, pickTargetGroup } from '@/features/finance/document-lookups';\r\nimport { useEmployeeStore } from '../employees/store';\r\nimport { getCurrentUserSystemId } from '../../contexts/auth-context';\r\n\r\n// API sync helpers\r\nasync function syncToAPI(action: 'create' | 'update' | 'delete', data: any): Promise<boolean> {\r\n  try {\r\n    const endpoint = action === 'create' ? '/api/payments' : `/api/payments/${data.systemId}`;\r\n    const method = action === 'create' ? 'POST' : action === 'update' ? 'PATCH' : 'DELETE';\r\n    \r\n    const response = await fetch(endpoint, {\r\n      method,\r\n      headers: { 'Content-Type': 'application/json' },\r\n      body: action !== 'delete' ? JSON.stringify(data) : undefined,\r\n    });\r\n    \r\n    if (!response.ok) {\r\n      console.error(`[Payments API] ${action} failed:`, await response.text());\r\n      return false;\r\n    }\r\n    return true;\r\n  } catch (error) {\r\n    console.error(`[Payments API] ${action} error:`, error);\r\n    return false;\r\n  }\r\n}\r\n\r\n// Helper to get current user info\r\nconst getCurrentUserInfo = () => {\r\n  const currentUserSystemId = getCurrentUserSystemId?.() || 'SYSTEM';\r\n  const employee = useEmployeeStore.getState().data.find(e => e.systemId === currentUserSystemId);\r\n  return {\r\n    systemId: currentUserSystemId,\r\n    name: employee?.fullName || 'Hệ thống',\r\n    avatar: employee?.avatarUrl,\r\n  };\r\n};\r\n\r\n// Helper to create history entry\r\nconst createHistoryEntry = (\r\n  action: HistoryEntry['action'],\r\n  description: string,\r\n  metadata?: HistoryEntry['metadata']\r\n): HistoryEntry => ({\r\n  id: crypto.randomUUID(),\r\n  action,\r\n  timestamp: new Date(),\r\n  user: getCurrentUserInfo(),\r\n  description,\r\n  metadata,\r\n});\r\n\r\nexport type PaymentInput = Omit<Payment, 'systemId' | 'id'> & { id?: BusinessId | string };\r\n\r\ninterface PaymentStore {\r\n  data: Payment[];\r\n  businessIdCounter: number;\r\n  systemIdCounter: number;\r\n  initialized: boolean;\r\n  add: (item: PaymentInput) => Payment;\r\n  addMultiple: (items: PaymentInput[]) => void;\r\n  update: (systemId: SystemId, item: Payment) => void;\r\n  remove: (systemId: SystemId) => void;\r\n  findById: (systemId: SystemId) => Payment | undefined;\r\n  getActive: () => Payment[];\r\n  cancel: (systemId: SystemId, reason?: string) => void;\r\n  loadFromAPI: () => Promise<void>;\r\n}\r\n\r\nconst PAYMENT_ENTITY: EntityType = 'payments';\r\nconst SYSTEM_ID_PREFIX = 'PAYMENT';\r\nconst BUSINESS_ID_PREFIX = 'PC';\r\nconst BUSINESS_ID_DIGITS = 6;\r\nconst PURCHASE_ORDER_SYSTEM_PREFIX = 'PURCHASE';\r\nconst PURCHASE_ORDER_BUSINESS_PREFIX = 'PO';\r\n\r\nconst normalizePaymentStatus = (status?: Payment['status']): Payment['status'] =>\r\n  status === 'cancelled' ? 'cancelled' : 'completed';\r\n\r\nconst normalizePayment = (payment: Payment): Payment => ({\r\n  ...payment,\r\n  status: normalizePaymentStatus(payment.status),\r\n});\r\n\r\nconst ensurePaymentMetadata = (payment: Payment): Payment => {\r\n  let mutated = false;\r\n  const updates: Partial<Payment> = {};\r\n\r\n  const targetGroup = pickTargetGroup({\r\n    systemId: payment.recipientTypeSystemId,\r\n    name: payment.recipientTypeName,\r\n  });\r\n  if (targetGroup) {\r\n    if (payment.recipientTypeSystemId !== targetGroup.systemId) {\r\n      updates.recipientTypeSystemId = targetGroup.systemId;\r\n      mutated = true;\r\n    }\r\n    if (payment.recipientTypeName !== targetGroup.name) {\r\n      updates.recipientTypeName = targetGroup.name;\r\n      mutated = true;\r\n    }\r\n  }\r\n\r\n  const paymentMethod = pickPaymentMethod({\r\n    systemId: payment.paymentMethodSystemId,\r\n    name: payment.paymentMethodName,\r\n  });\r\n  if (paymentMethod) {\r\n    if (payment.paymentMethodSystemId !== paymentMethod.systemId) {\r\n      updates.paymentMethodSystemId = paymentMethod.systemId;\r\n      mutated = true;\r\n    }\r\n    if (payment.paymentMethodName !== paymentMethod.name) {\r\n      updates.paymentMethodName = paymentMethod.name;\r\n      mutated = true;\r\n    }\r\n  }\r\n\r\n  const account = pickAccount({\r\n    accountSystemId: payment.accountSystemId,\r\n    branchSystemId: payment.branchSystemId,\r\n    paymentMethodName: paymentMethod?.name ?? payment.paymentMethodName,\r\n  });\r\n  if (account && payment.accountSystemId !== account.systemId) {\r\n    updates.accountSystemId = account.systemId;\r\n    mutated = true;\r\n  }\r\n\r\n  const paymentType = pickPaymentType({\r\n    systemId: payment.paymentReceiptTypeSystemId,\r\n    name: payment.paymentReceiptTypeName,\r\n  });\r\n  if (paymentType) {\r\n    if (payment.paymentReceiptTypeSystemId !== paymentType.systemId) {\r\n      updates.paymentReceiptTypeSystemId = paymentType.systemId;\r\n      mutated = true;\r\n    }\r\n    if (payment.paymentReceiptTypeName !== paymentType.name) {\r\n      updates.paymentReceiptTypeName = paymentType.name;\r\n      mutated = true;\r\n    }\r\n  }\r\n\r\n  const normalizedGroupName = targetGroup?.name?.trim().toLowerCase();\r\n  if (normalizedGroupName === 'khách hàng') {\r\n    if (!payment.customerName && payment.recipientName) {\r\n      updates.customerName = payment.recipientName;\r\n      mutated = true;\r\n    }\r\n    if (!payment.customerSystemId && payment.recipientSystemId) {\r\n      updates.customerSystemId = payment.recipientSystemId;\r\n      mutated = true;\r\n    }\r\n  }\r\n\r\n  return mutated ? { ...payment, ...updates } : payment;\r\n};\r\n\r\nconst backfillPaymentMetadata = (payments: Payment[]): Payment[] => {\r\n  let mutated = false;\r\n  const updated = payments.map(payment => {\r\n    const normalized = ensurePaymentMetadata(payment);\r\n    if (normalized !== payment) {\r\n      mutated = true;\r\n    }\r\n    return normalized;\r\n  });\r\n  return mutated ? updated : payments;\r\n};\r\n\r\nconst initialPayments: Payment[] = []; // Database is source of truth\r\n\r\nlet systemIdCounter = getMaxSystemIdCounter(initialPayments, SYSTEM_ID_PREFIX);\r\nlet businessIdCounter = getMaxBusinessIdCounter(initialPayments, BUSINESS_ID_PREFIX);\r\n\r\nconst getNextSystemId = (): SystemId => {\r\n  systemIdCounter += 1;\r\n  return asSystemId(generateSystemId(PAYMENT_ENTITY, systemIdCounter));\r\n};\r\n\r\nconst ensurePaymentBusinessId = (payments: Payment[], provided?: BusinessId | string): BusinessId => {\r\n  if (provided && `${provided}`.trim().length > 0) {\r\n    const normalized = `${provided}`.trim().toUpperCase();\r\n    const parsedCounter = extractCounterFromBusinessId(normalized, BUSINESS_ID_PREFIX);\r\n    if (parsedCounter > businessIdCounter) {\r\n      businessIdCounter = parsedCounter;\r\n    }\r\n    return asBusinessId(normalized);\r\n  }\r\n\r\n  const existingIds = payments.map(payment => payment.id as string).filter(Boolean);\r\n  const { nextId, updatedCounter } = findNextAvailableBusinessId(\r\n    BUSINESS_ID_PREFIX,\r\n    existingIds,\r\n    businessIdCounter,\r\n    BUSINESS_ID_DIGITS\r\n  );\r\n  businessIdCounter = updatedCounter;\r\n  return asBusinessId(nextId);\r\n};\r\n\r\nconst reconcileLinkedDocuments = (payment: Payment): Payment => {\r\n  if (!payment.originalDocumentId) {\r\n    return payment;\r\n  }\r\n\r\n  const normalizedDocId = payment.originalDocumentId.toUpperCase();\r\n  const nextPayment = { ...payment };\r\n\r\n  if (!nextPayment.purchaseOrderSystemId && normalizedDocId.startsWith(PURCHASE_ORDER_SYSTEM_PREFIX)) {\r\n    nextPayment.purchaseOrderSystemId = asSystemId(payment.originalDocumentId);\r\n  }\r\n\r\n  if (!nextPayment.purchaseOrderId && normalizedDocId.startsWith(PURCHASE_ORDER_BUSINESS_PREFIX)) {\r\n    nextPayment.purchaseOrderId = asBusinessId(payment.originalDocumentId);\r\n  }\r\n\r\n  return nextPayment;\r\n};\r\n\r\nconst buildPayment = (input: PaymentInput, existingPayments: Payment[]): Payment => {\r\n  const systemId = getNextSystemId();\r\n  const id = ensurePaymentBusinessId(existingPayments, input.id);\r\n  const basePayment: Payment = {\r\n    ...input,\r\n    systemId,\r\n    id,\r\n    createdAt: input.createdAt || new Date().toISOString(),\r\n    status: normalizePaymentStatus(input.status),\r\n  };\r\n\r\n  return reconcileLinkedDocuments(basePayment);\r\n};\r\n\r\nexport const usePaymentStore = create<PaymentStore>()(\r\n  (set, get) => ({\r\n      data: initialPayments,\r\n      businessIdCounter,\r\n      systemIdCounter,\r\n      initialized: false,\r\n      \r\n      add: (item) => {\r\n        let createdPayment: Payment | null = null;\r\n        set(state => {\r\n          const newPayment = buildPayment(item, state.data);\r\n          createdPayment = newPayment;\r\n          return {\r\n            data: [...state.data, newPayment],\r\n            businessIdCounter,\r\n            systemIdCounter,\r\n          };\r\n        });\r\n        // Sync to API\r\n        if (createdPayment) {\r\n          syncToAPI('create', createdPayment).catch(console.error);\r\n        }\r\n        return createdPayment!;\r\n      },\r\n      \r\n      addMultiple: (items) => {\r\n        const created: Payment[] = [];\r\n        set(state => {\r\n          items.forEach(item => {\r\n            const context = [...state.data, ...created];\r\n            const payment = buildPayment(item, context);\r\n            created.push(payment);\r\n          });\r\n\r\n          return {\r\n            data: [...state.data, ...created],\r\n            businessIdCounter,\r\n            systemIdCounter,\r\n          };\r\n        });\r\n        // Sync all to API\r\n        created.forEach(payment => {\r\n          syncToAPI('create', payment).catch(console.error);\r\n        });\r\n      },\r\n      \r\n      update: (systemId, item) => {\r\n        const updated = reconcileLinkedDocuments({\r\n          ...item,\r\n          systemId,\r\n          status: normalizePaymentStatus(item.status),\r\n          updatedAt: new Date().toISOString(),\r\n        });\r\n        set(state => ({\r\n          data: state.data.map(payment =>\r\n            payment.systemId === systemId ? updated : payment\r\n          ),\r\n          businessIdCounter,\r\n          systemIdCounter,\r\n        }));\r\n        // Sync to API\r\n        syncToAPI('update', updated).catch(console.error);\r\n      },\r\n      \r\n      remove: (systemId) => {\r\n        set(state => ({\r\n          data: state.data.filter(payment => payment.systemId !== systemId),\r\n          businessIdCounter,\r\n          systemIdCounter,\r\n        }));\r\n        // Sync to API\r\n        syncToAPI('delete', { systemId }).catch(console.error);\r\n      },\r\n      \r\n      findById: (systemId) => {\r\n        return get().data.find(payment => payment.systemId === systemId);\r\n      },\r\n      \r\n      getActive: () => {\r\n        return get().data.filter(payment => payment.status !== 'cancelled');\r\n      },\r\n      \r\n      cancel: (systemId: SystemId, reason?: string) => {\r\n        const payment = get().findById(systemId);\r\n        if (payment && payment.status !== 'cancelled') {\r\n          const historyEntry = createHistoryEntry(\r\n            'cancelled',\r\n            `Đã hủy phiếu chi${reason ? `: ${reason}` : ''}`,\r\n            { oldValue: 'Hoàn thành', newValue: 'Đã hủy', note: reason }\r\n          );\r\n          \r\n          get().update(systemId, {\r\n            ...payment,\r\n            status: 'cancelled',\r\n            cancelledAt: new Date().toISOString(),\r\n            activityHistory: [...(payment.activityHistory || []), historyEntry],\r\n          });\r\n        }\r\n      },\r\n      \r\n      loadFromAPI: async () => {\r\n        try {\r\n          // NOTE: Use React Query hooks for paginated data. This only loads initial batch.\r\n          const response = await fetch('/api/payments?limit=30');\r\n          if (!response.ok) return;\r\n          const json = await response.json();\r\n          const apiData = json.data || [];\r\n          if (apiData.length > 0) {\r\n            const normalized = backfillPaymentMetadata(apiData.map(normalizePayment));\r\n            const nextSystemCounter = getMaxSystemIdCounter(normalized, SYSTEM_ID_PREFIX);\r\n            const nextBusinessCounter = getMaxBusinessIdCounter(normalized, BUSINESS_ID_PREFIX);\r\n            systemIdCounter = nextSystemCounter;\r\n            businessIdCounter = nextBusinessCounter;\r\n            set({ \r\n              data: normalized, \r\n              systemIdCounter, \r\n              businessIdCounter,\r\n              initialized: true \r\n            });\r\n          } else {\r\n            set({ initialized: true });\r\n          }\r\n        } catch (error) {\r\n          console.error('[Payments API] loadFromAPI error:', error);\r\n        }\r\n      },\r\n    })\r\n);\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 703, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/suppliers/api/suppliers-api.ts"],"sourcesContent":["/**\r\n * Suppliers API - Isolated API functions\r\n * \r\n * ⚠️ IMPORTANT: This file should ONLY contain:\r\n * - Fetch functions\r\n * - Type imports from ../types\r\n * - NO store imports\r\n * - NO cross-feature imports\r\n */\r\n\r\nimport type { Supplier } from '../types';\r\n\r\nconst API_BASE = '/api/suppliers';\r\n\r\nexport interface SuppliersParams {\r\n  page?: number;\r\n  limit?: number;\r\n  search?: string;\r\n  status?: string;\r\n  hasDebt?: boolean;\r\n  sortBy?: string;\r\n  sortOrder?: 'asc' | 'desc';\r\n  includeDeleted?: boolean;\r\n}\r\n\r\nexport interface PaginatedResponse<T> {\r\n  data: T[];\r\n  pagination: {\r\n    page: number;\r\n    limit: number;\r\n    total: number;\r\n    totalPages: number;\r\n  };\r\n}\r\n\r\nexport interface CreateSupplierInput {\r\n  name: string;\r\n  taxCode?: string;\r\n  phone?: string;\r\n  email?: string;\r\n  address?: string;\r\n  website?: string;\r\n  accountManager?: string;\r\n  bankAccount?: string;\r\n  bankName?: string;\r\n  contactPerson?: string;\r\n  notes?: string;\r\n}\r\n\r\nexport interface UpdateSupplierInput extends Partial<CreateSupplierInput> {\r\n  systemId: string;\r\n  isDeleted?: boolean;\r\n  deletedAt?: string | Date | null;\r\n  status?: string;\r\n}\r\n\r\n/**\r\n * Fetch paginated suppliers list\r\n */\r\nexport async function fetchSuppliers(params: SuppliersParams = {}): Promise<PaginatedResponse<Supplier>> {\r\n  const { page = 1, limit = 50, ...rest } = params;\r\n  \r\n  const searchParams = new URLSearchParams({\r\n    page: String(page),\r\n    limit: String(limit),\r\n  });\r\n  \r\n  Object.entries(rest).forEach(([key, value]) => {\r\n    if (value != null && value !== '') {\r\n      searchParams.set(key, String(value));\r\n    }\r\n  });\r\n  \r\n  const res = await fetch(`${API_BASE}?${searchParams}`, {\r\n    credentials: 'include',\r\n  });\r\n  \r\n  if (!res.ok) {\r\n    throw new Error(`Failed to fetch suppliers: ${res.statusText}`);\r\n  }\r\n  \r\n  return res.json();\r\n}\r\n\r\n/**\r\n * Fetch single supplier by ID\r\n */\r\nexport async function fetchSupplier(id: string): Promise<Supplier> {\r\n  const res = await fetch(`${API_BASE}/${id}`, {\r\n    credentials: 'include',\r\n  });\r\n  \r\n  if (!res.ok) {\r\n    throw new Error(`Failed to fetch supplier ${id}: ${res.statusText}`);\r\n  }\r\n  \r\n  return res.json();\r\n}\r\n\r\n/**\r\n * Create new supplier\r\n */\r\nexport async function createSupplier(data: CreateSupplierInput): Promise<Supplier> {\r\n  const res = await fetch(API_BASE, {\r\n    method: 'POST',\r\n    headers: { 'Content-Type': 'application/json' },\r\n    credentials: 'include',\r\n    body: JSON.stringify(data),\r\n  });\r\n  \r\n  if (!res.ok) {\r\n    const error = await res.json().catch(() => ({}));\r\n    throw new Error(error.message || `Failed to create supplier: ${res.statusText}`);\r\n  }\r\n  \r\n  return res.json();\r\n}\r\n\r\n/**\r\n * Update existing supplier\r\n */\r\nexport async function updateSupplier({ systemId, ...data }: UpdateSupplierInput): Promise<Supplier> {\r\n  const res = await fetch(`${API_BASE}/${systemId}`, {\r\n    method: 'PATCH',\r\n    headers: { 'Content-Type': 'application/json' },\r\n    credentials: 'include',\r\n    body: JSON.stringify(data),\r\n  });\r\n  \r\n  if (!res.ok) {\r\n    const error = await res.json().catch(() => ({}));\r\n    throw new Error(error.message || `Failed to update supplier: ${res.statusText}`);\r\n  }\r\n  \r\n  return res.json();\r\n}\r\n\r\n/**\r\n * Delete supplier (soft delete)\r\n */\r\nexport async function deleteSupplier(id: string): Promise<void> {\r\n  const res = await fetch(`${API_BASE}/${id}`, {\r\n    method: 'DELETE',\r\n    credentials: 'include',\r\n  });\r\n  \r\n  if (!res.ok) {\r\n    const error = await res.json().catch(() => ({}));\r\n    throw new Error(error.message || `Failed to delete supplier: ${res.statusText}`);\r\n  }\r\n}\r\n\r\n/**\r\n * Search suppliers for autocomplete\r\n */\r\nexport async function searchSuppliers(query: string, limit = 20): Promise<Supplier[]> {\r\n  const res = await fetch(`${API_BASE}?search=${encodeURIComponent(query)}&limit=${limit}`, {\r\n    credentials: 'include',\r\n  });\r\n  \r\n  if (!res.ok) {\r\n    throw new Error(`Failed to search suppliers: ${res.statusText}`);\r\n  }\r\n  \r\n  const json = await res.json();\r\n  return json.data || [];\r\n}\r\n"],"names":[],"mappings":"AAAA;;;;;;;;CAQC;;;;;;;;;;;;;;AAID,MAAM,WAAW;AA+CV,eAAe,eAAe,SAA0B,CAAC,CAAC;IAC/D,MAAM,EAAE,OAAO,CAAC,EAAE,QAAQ,EAAE,EAAE,GAAG,MAAM,GAAG;IAE1C,MAAM,eAAe,IAAI,gBAAgB;QACvC,MAAM,OAAO;QACb,OAAO,OAAO;IAChB;IAEA,OAAO,OAAO,CAAC,MAAM,OAAO,CAAC,CAAC,CAAC,KAAK,MAAM;QACxC,IAAI,SAAS,QAAQ,UAAU,IAAI;YACjC,aAAa,GAAG,CAAC,KAAK,OAAO;QAC/B;IACF;IAEA,MAAM,MAAM,MAAM,MAAM,GAAG,SAAS,CAAC,EAAE,cAAc,EAAE;QACrD,aAAa;IACf;IAEA,IAAI,CAAC,IAAI,EAAE,EAAE;QACX,MAAM,IAAI,MAAM,CAAC,2BAA2B,EAAE,IAAI,UAAU,EAAE;IAChE;IAEA,OAAO,IAAI,IAAI;AACjB;AAKO,eAAe,cAAc,EAAU;IAC5C,MAAM,MAAM,MAAM,MAAM,GAAG,SAAS,CAAC,EAAE,IAAI,EAAE;QAC3C,aAAa;IACf;IAEA,IAAI,CAAC,IAAI,EAAE,EAAE;QACX,MAAM,IAAI,MAAM,CAAC,yBAAyB,EAAE,GAAG,EAAE,EAAE,IAAI,UAAU,EAAE;IACrE;IAEA,OAAO,IAAI,IAAI;AACjB;AAKO,eAAe,eAAe,IAAyB;IAC5D,MAAM,MAAM,MAAM,MAAM,UAAU;QAChC,QAAQ;QACR,SAAS;YAAE,gBAAgB;QAAmB;QAC9C,aAAa;QACb,MAAM,KAAK,SAAS,CAAC;IACvB;IAEA,IAAI,CAAC,IAAI,EAAE,EAAE;QACX,MAAM,QAAQ,MAAM,IAAI,IAAI,GAAG,KAAK,CAAC,IAAM,CAAC,CAAC,CAAC;QAC9C,MAAM,IAAI,MAAM,MAAM,OAAO,IAAI,CAAC,2BAA2B,EAAE,IAAI,UAAU,EAAE;IACjF;IAEA,OAAO,IAAI,IAAI;AACjB;AAKO,eAAe,eAAe,EAAE,QAAQ,EAAE,GAAG,MAA2B;IAC7E,MAAM,MAAM,MAAM,MAAM,GAAG,SAAS,CAAC,EAAE,UAAU,EAAE;QACjD,QAAQ;QACR,SAAS;YAAE,gBAAgB;QAAmB;QAC9C,aAAa;QACb,MAAM,KAAK,SAAS,CAAC;IACvB;IAEA,IAAI,CAAC,IAAI,EAAE,EAAE;QACX,MAAM,QAAQ,MAAM,IAAI,IAAI,GAAG,KAAK,CAAC,IAAM,CAAC,CAAC,CAAC;QAC9C,MAAM,IAAI,MAAM,MAAM,OAAO,IAAI,CAAC,2BAA2B,EAAE,IAAI,UAAU,EAAE;IACjF;IAEA,OAAO,IAAI,IAAI;AACjB;AAKO,eAAe,eAAe,EAAU;IAC7C,MAAM,MAAM,MAAM,MAAM,GAAG,SAAS,CAAC,EAAE,IAAI,EAAE;QAC3C,QAAQ;QACR,aAAa;IACf;IAEA,IAAI,CAAC,IAAI,EAAE,EAAE;QACX,MAAM,QAAQ,MAAM,IAAI,IAAI,GAAG,KAAK,CAAC,IAAM,CAAC,CAAC,CAAC;QAC9C,MAAM,IAAI,MAAM,MAAM,OAAO,IAAI,CAAC,2BAA2B,EAAE,IAAI,UAAU,EAAE;IACjF;AACF;AAKO,eAAe,gBAAgB,KAAa,EAAE,QAAQ,EAAE;IAC7D,MAAM,MAAM,MAAM,MAAM,GAAG,SAAS,QAAQ,EAAE,mBAAmB,OAAO,OAAO,EAAE,OAAO,EAAE;QACxF,aAAa;IACf;IAEA,IAAI,CAAC,IAAI,EAAE,EAAE;QACX,MAAM,IAAI,MAAM,CAAC,4BAA4B,EAAE,IAAI,UAAU,EAAE;IACjE;IAEA,MAAM,OAAO,MAAM,IAAI,IAAI;IAC3B,OAAO,KAAK,IAAI,IAAI,EAAE;AACxB"}},
    {"offset": {"line": 811, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/suppliers/hooks/use-all-suppliers.ts"],"sourcesContent":["/**\r\n * useAllSuppliers - Convenience hook for components needing all suppliers as flat array\r\n * \r\n * Replaces legacy useSupplierStore().data pattern\r\n */\r\n\r\nimport * as React from 'react';\r\nimport { useSuppliers } from './use-suppliers';\r\nimport type { Supplier } from '../types';\r\nimport type { SystemId } from '@/lib/id-types';\r\n\r\n/**\r\n * Returns all suppliers as a flat array\r\n * Compatible with legacy store pattern: { data: suppliers }\r\n */\r\nexport function useAllSuppliers() {\r\n  const query = useSuppliers({ limit: 500 });\r\n  \r\n  return {\r\n    data: query.data?.data || [],\r\n    isLoading: query.isLoading,\r\n    isError: query.isError,\r\n    error: query.error,\r\n  };\r\n}\r\n\r\n/**\r\n * Returns only active suppliers\r\n */\r\nexport function useActiveSuppliers() {\r\n  const { data, isLoading, isError, error } = useAllSuppliers();\r\n  \r\n  const activeSuppliers = React.useMemo(\r\n    () => data.filter(s => s.status === 'Đang Giao Dịch' && !s.isDeleted),\r\n    [data]\r\n  );\r\n  \r\n  return { data: activeSuppliers, isLoading, isError, error };\r\n}\r\n\r\n/**\r\n * Returns suppliers formatted as options for Select/Combobox\r\n */\r\nexport function useSupplierOptions() {\r\n  const { data, isLoading } = useActiveSuppliers();\r\n  \r\n  const options = React.useMemo(\r\n    () => data.map(s => ({\r\n      value: s.systemId,\r\n      label: s.name,\r\n    })),\r\n    [data]\r\n  );\r\n  \r\n  return { options, isLoading };\r\n}\r\n\r\n/**\r\n * Helper hook to find a supplier by ID from cached data\r\n * Replaces legacy findById() method\r\n */\r\nexport function useSupplierFinder() {\r\n  const { data } = useAllSuppliers();\r\n  \r\n  const findById = React.useCallback(\r\n    (systemId: SystemId | string | undefined): Supplier | undefined => {\r\n      if (!systemId) return undefined;\r\n      return data.find(s => s.systemId === systemId);\r\n    },\r\n    [data]\r\n  );\r\n  \r\n  return { findById };\r\n}\r\n"],"names":[],"mappings":";;;;;;;;;;AAAA;;;;CAIC,GAED;AACA;;;;AAQO,SAAS;;IACd,MAAM,QAAQ,IAAA,qLAAY,EAAC;QAAE,OAAO;IAAI;IAExC,OAAO;QACL,MAAM,MAAM,IAAI,EAAE,QAAQ,EAAE;QAC5B,WAAW,MAAM,SAAS;QAC1B,SAAS,MAAM,OAAO;QACtB,OAAO,MAAM,KAAK;IACpB;AACF;GATgB;;QACA,qLAAY;;;AAarB,SAAS;;IACd,MAAM,EAAE,IAAI,EAAE,SAAS,EAAE,OAAO,EAAE,KAAK,EAAE,GAAG;IAE5C,MAAM,kBAAkB,wKAAa;uDACnC,IAAM,KAAK,MAAM;+DAAC,CAAA,IAAK,EAAE,MAAM,KAAK,oBAAoB,CAAC,EAAE,SAAS;;sDACpE;QAAC;KAAK;IAGR,OAAO;QAAE,MAAM;QAAiB;QAAW;QAAS;IAAM;AAC5D;IATgB;;QAC8B;;;AAavC,SAAS;;IACd,MAAM,EAAE,IAAI,EAAE,SAAS,EAAE,GAAG;IAE5B,MAAM,UAAU,wKAAa;+CAC3B,IAAM,KAAK,GAAG;uDAAC,CAAA,IAAK,CAAC;wBACnB,OAAO,EAAE,QAAQ;wBACjB,OAAO,EAAE,IAAI;oBACf,CAAC;;8CACD;QAAC;KAAK;IAGR,OAAO;QAAE;QAAS;IAAU;AAC9B;IAZgB;;QACc;;;AAiBvB,SAAS;;IACd,MAAM,EAAE,IAAI,EAAE,GAAG;IAEjB,MAAM,WAAW,4KAAiB;mDAChC,CAAC;YACC,IAAI,CAAC,UAAU,OAAO;YACtB,OAAO,KAAK,IAAI;2DAAC,CAAA,IAAK,EAAE,QAAQ,KAAK;;QACvC;kDACA;QAAC;KAAK;IAGR,OAAO;QAAE;IAAS;AACpB;IAZgB;;QACG"}},
    {"offset": {"line": 921, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/suppliers/hooks/use-suppliers.ts"],"sourcesContent":["/**\r\n * useSuppliers - React Query hooks for suppliers\r\n * \r\n * ⚠️ IMPORTANT: Direct import pattern\r\n * - Import: import { useSuppliers } from '@/features/suppliers/hooks/use-suppliers'\r\n * - NEVER import from '@/features/suppliers/store'\r\n */\r\n\r\nimport { useQuery, useMutation, useQueryClient, keepPreviousData } from '@tanstack/react-query';\r\nimport {\r\n  fetchSuppliers,\r\n  fetchSupplier,\r\n  createSupplier,\r\n  updateSupplier,\r\n  deleteSupplier,\r\n  searchSuppliers,\r\n  type SuppliersParams,\r\n  type CreateSupplierInput,\r\n  type UpdateSupplierInput,\r\n} from '../api/suppliers-api';\r\n\r\n// Query keys\r\nexport const supplierKeys = {\r\n  all: ['suppliers'] as const,\r\n  lists: () => [...supplierKeys.all, 'list'] as const,\r\n  list: (params: SuppliersParams) => [...supplierKeys.lists(), params] as const,\r\n  details: () => [...supplierKeys.all, 'detail'] as const,\r\n  detail: (id: string) => [...supplierKeys.details(), id] as const,\r\n  search: (query: string) => [...supplierKeys.all, 'search', query] as const,\r\n};\r\n\r\nexport function useSuppliers(params: SuppliersParams = {}) {\r\n  return useQuery({\r\n    queryKey: supplierKeys.list(params),\r\n    queryFn: () => fetchSuppliers(params),\r\n    staleTime: 60_000,\r\n    gcTime: 10 * 60 * 1000,\r\n    placeholderData: keepPreviousData,\r\n  });\r\n}\r\n\r\nexport function useSupplier(id: string | null | undefined) {\r\n  return useQuery({\r\n    queryKey: supplierKeys.detail(id!),\r\n    queryFn: () => fetchSupplier(id!),\r\n    enabled: !!id,\r\n    staleTime: 60_000,\r\n  });\r\n}\r\n\r\nexport function useSupplierSearch(query: string, limit = 20) {\r\n  return useQuery({\r\n    queryKey: supplierKeys.search(query),\r\n    queryFn: () => searchSuppliers(query, limit),\r\n    enabled: query.length >= 2,\r\n    staleTime: 30_000,\r\n  });\r\n}\r\n\r\ninterface UseSupplierMutationsOptions {\r\n  onCreateSuccess?: (supplier: unknown) => void;\r\n  onUpdateSuccess?: (supplier: unknown) => void;\r\n  onDeleteSuccess?: () => void;\r\n  onError?: (error: Error) => void;\r\n}\r\n\r\nexport function useSupplierMutations(options: UseSupplierMutationsOptions = {}) {\r\n  const queryClient = useQueryClient();\r\n  \r\n  const create = useMutation({\r\n    mutationFn: createSupplier,\r\n    onSuccess: (data) => {\r\n      queryClient.invalidateQueries({ queryKey: supplierKeys.lists() });\r\n      options.onCreateSuccess?.(data);\r\n    },\r\n    onError: options.onError,\r\n  });\r\n  \r\n  const update = useMutation({\r\n    mutationFn: updateSupplier,\r\n    onSuccess: (data, variables) => {\r\n      queryClient.invalidateQueries({ queryKey: supplierKeys.detail(variables.systemId) });\r\n      queryClient.invalidateQueries({ queryKey: supplierKeys.lists() });\r\n      options.onUpdateSuccess?.(data);\r\n    },\r\n    onError: options.onError,\r\n  });\r\n  \r\n  const remove = useMutation({\r\n    mutationFn: deleteSupplier,\r\n    onSuccess: () => {\r\n      queryClient.invalidateQueries({ queryKey: supplierKeys.all });\r\n      options.onDeleteSuccess?.();\r\n    },\r\n    onError: options.onError,\r\n  });\r\n  \r\n  return {\r\n    create,\r\n    update,\r\n    remove,\r\n    isCreating: create.isPending,\r\n    isUpdating: update.isPending,\r\n    isDeleting: remove.isPending,\r\n  };\r\n}\r\n\r\nexport function useActiveSuppliers(params: Omit<SuppliersParams, 'status'> = {}) {\r\n  return useSuppliers({ ...params, status: 'Đang Giao Dịch' });\r\n}\r\n\r\n// Re-export from use-all-suppliers for backward compatibility\r\nexport { useAllSuppliers, useSupplierOptions, useSupplierFinder } from './use-all-suppliers';\r\nexport { useActiveSuppliers as useActiveSuppliersFromAll } from './use-all-suppliers';\r\n"],"names":[],"mappings":";;;;;;;;;;;;;;AAAA;;;;;;CAMC,GAED;AAAA;AAAA;AAAA;AACA;AAsGA,8DAA8D;AAC9D;;;;AA1FO,MAAM,eAAe;IAC1B,KAAK;QAAC;KAAY;IAClB,OAAO,IAAM;eAAI,aAAa,GAAG;YAAE;SAAO;IAC1C,MAAM,CAAC,SAA4B;eAAI,aAAa,KAAK;YAAI;SAAO;IACpE,SAAS,IAAM;eAAI,aAAa,GAAG;YAAE;SAAS;IAC9C,QAAQ,CAAC,KAAe;eAAI,aAAa,OAAO;YAAI;SAAG;IACvD,QAAQ,CAAC,QAAkB;eAAI,aAAa,GAAG;YAAE;YAAU;SAAM;AACnE;AAEO,SAAS,aAAa,SAA0B,CAAC,CAAC;;IACvD,OAAO,IAAA,0LAAQ,EAAC;QACd,UAAU,aAAa,IAAI,CAAC;QAC5B,OAAO;qCAAE,IAAM,IAAA,qKAAc,EAAC;;QAC9B,WAAW;QACX,QAAQ,KAAK,KAAK;QAClB,iBAAiB,8LAAgB;IACnC;AACF;GARgB;;QACP,0LAAQ;;;AASV,SAAS,YAAY,EAA6B;;IACvD,OAAO,IAAA,0LAAQ,EAAC;QACd,UAAU,aAAa,MAAM,CAAC;QAC9B,OAAO;oCAAE,IAAM,IAAA,oKAAa,EAAC;;QAC7B,SAAS,CAAC,CAAC;QACX,WAAW;IACb;AACF;IAPgB;;QACP,0LAAQ;;;AAQV,SAAS,kBAAkB,KAAa,EAAE,QAAQ,EAAE;;IACzD,OAAO,IAAA,0LAAQ,EAAC;QACd,UAAU,aAAa,MAAM,CAAC;QAC9B,OAAO;0CAAE,IAAM,IAAA,sKAAe,EAAC,OAAO;;QACtC,SAAS,MAAM,MAAM,IAAI;QACzB,WAAW;IACb;AACF;IAPgB;;QACP,0LAAQ;;;AAeV,SAAS,qBAAqB,UAAuC,CAAC,CAAC;;IAC5E,MAAM,cAAc,IAAA,2MAAc;IAElC,MAAM,SAAS,IAAA,gMAAW,EAAC;QACzB,YAAY,qKAAc;QAC1B,SAAS;wDAAE,CAAC;gBACV,YAAY,iBAAiB,CAAC;oBAAE,UAAU,aAAa,KAAK;gBAAG;gBAC/D,QAAQ,eAAe,GAAG;YAC5B;;QACA,SAAS,QAAQ,OAAO;IAC1B;IAEA,MAAM,SAAS,IAAA,gMAAW,EAAC;QACzB,YAAY,qKAAc;QAC1B,SAAS;wDAAE,CAAC,MAAM;gBAChB,YAAY,iBAAiB,CAAC;oBAAE,UAAU,aAAa,MAAM,CAAC,UAAU,QAAQ;gBAAE;gBAClF,YAAY,iBAAiB,CAAC;oBAAE,UAAU,aAAa,KAAK;gBAAG;gBAC/D,QAAQ,eAAe,GAAG;YAC5B;;QACA,SAAS,QAAQ,OAAO;IAC1B;IAEA,MAAM,SAAS,IAAA,gMAAW,EAAC;QACzB,YAAY,qKAAc;QAC1B,SAAS;wDAAE;gBACT,YAAY,iBAAiB,CAAC;oBAAE,UAAU,aAAa,GAAG;gBAAC;gBAC3D,QAAQ,eAAe;YACzB;;QACA,SAAS,QAAQ,OAAO;IAC1B;IAEA,OAAO;QACL;QACA;QACA;QACA,YAAY,OAAO,SAAS;QAC5B,YAAY,OAAO,SAAS;QAC5B,YAAY,OAAO,SAAS;IAC9B;AACF;IAvCgB;;QACM,2MAAc;QAEnB,gMAAW;QASX,gMAAW;QAUX,gMAAW;;;AAmBrB,SAAS,mBAAmB,SAA0C,CAAC,CAAC;;IAC7E,OAAO,aAAa;QAAE,GAAG,MAAM;QAAE,QAAQ;IAAiB;AAC5D;IAFgB;;QACP"}},
    {"offset": {"line": 1106, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/suppliers/store.ts"],"sourcesContent":["import { createCrudStore, CrudState } from '../../lib/store-factory';\r\n// REMOVED: import { data as initialData } from './data'; // Mock data no longer used - database is source of truth\r\nimport type { Supplier } from './types';\r\nimport type { SystemId } from '../../lib/id-types';\r\nimport { asSystemId, asBusinessId } from '../../lib/id-types';\r\nimport Fuse from 'fuse.js';\r\nimport { getCurrentUserSystemId } from '../../contexts/auth-context';\r\n\r\nconst baseStore = createCrudStore<Supplier>([], 'suppliers', {\r\n  businessIdField: 'id',\r\n  getCurrentUser: getCurrentUserSystemId, // ✅ Track who creates/updates\r\n  apiEndpoint: '/api/suppliers',\r\n});\r\n\r\n// ✅ API Sync helpers\r\nconst API_ENDPOINT = '/api/suppliers';\r\n\r\nconst syncToApi = {\r\n  create: async (supplier: Supplier) => {\r\n    try {\r\n      const response = await fetch(API_ENDPOINT, {\r\n        method: 'POST',\r\n        credentials: 'include',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify(supplier),\r\n      });\r\n      if (!response.ok) console.warn('[Supplier API] Create sync failed');\r\n      else console.log('[Supplier API] Created:', supplier.systemId);\r\n    } catch (e) {\r\n      console.warn('[Supplier API] Create sync error:', e);\r\n    }\r\n  },\r\n  update: async (systemId: SystemId, updates: Partial<Supplier>) => {\r\n    try {\r\n      const response = await fetch(`${API_ENDPOINT}/${systemId}`, {\r\n        method: 'PATCH',\r\n        credentials: 'include',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify(updates),\r\n      });\r\n      if (!response.ok) console.warn('[Supplier API] Update sync failed');\r\n      else console.log('[Supplier API] Updated:', systemId);\r\n    } catch (e) {\r\n      console.warn('[Supplier API] Update sync error:', e);\r\n    }\r\n  },\r\n  delete: async (systemId: SystemId, hard = false) => {\r\n    try {\r\n      const response = await fetch(`${API_ENDPOINT}/${systemId}`, {\r\n        method: 'DELETE',\r\n        credentials: 'include',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({ hard }),\r\n      });\r\n      if (!response.ok) console.warn('[Supplier API] Delete sync failed');\r\n      else console.log('[Supplier API] Deleted:', systemId);\r\n    } catch (e) {\r\n      console.warn('[Supplier API] Delete sync error:', e);\r\n    }\r\n  },\r\n  restore: async (systemId: SystemId) => {\r\n    try {\r\n      const response = await fetch(`${API_ENDPOINT}/${systemId}/restore`, {\r\n        method: 'POST',\r\n        credentials: 'include',\r\n        headers: { 'Content-Type': 'application/json' },\r\n      });\r\n      if (!response.ok) console.warn('[Supplier API] Restore sync failed');\r\n      else console.log('[Supplier API] Restored:', systemId);\r\n    } catch (e) {\r\n      console.warn('[Supplier API] Restore sync error:', e);\r\n    }\r\n  },\r\n};\r\n\r\n// ✅ Wrap base store methods with API sync\r\nconst originalAdd = baseStore.getState().add;\r\nconst originalUpdate = baseStore.getState().update;\r\nconst originalRemove = baseStore.getState().remove;\r\nconst originalHardDelete = baseStore.getState().hardDelete;\r\nconst originalRestore = baseStore.getState().restore;\r\n\r\nbaseStore.setState({\r\n  add: (item: Omit<Supplier, 'systemId'>) => {\r\n    const result = originalAdd(item);\r\n    syncToApi.create(result);\r\n    return result;\r\n  },\r\n  update: (systemId: SystemId, updates: Partial<Supplier>) => {\r\n    originalUpdate(systemId, updates);\r\n    syncToApi.update(systemId, updates);\r\n  },\r\n  remove: (systemId: SystemId) => {\r\n    originalRemove(systemId);\r\n    syncToApi.delete(systemId, false);\r\n  },\r\n  hardDelete: (systemId: SystemId) => {\r\n    originalHardDelete(systemId);\r\n    syncToApi.delete(systemId, true);\r\n  },\r\n  restore: (systemId: SystemId) => {\r\n    originalRestore(systemId);\r\n    syncToApi.restore(systemId);\r\n  },\r\n});\r\n\r\nconst fuse = new Fuse(baseStore.getState().data, {\r\n    keys: ['name', 'id', 'phone'],\r\n    threshold: 0.3,\r\n});\r\n\r\n// Define enhanced interface\r\ninterface SupplierStoreState extends CrudState<Supplier> {\r\n  searchSuppliers: (query: string, page: number, limit?: number) => Promise<{ items: { value: string; label: string }[], hasNextPage: boolean }>;\r\n  updateStatus: (systemIds: SystemId[], status: Supplier['status']) => void;\r\n  bulkDelete: (systemIds: SystemId[]) => void;\r\n}\r\n\r\n// Augmented methods\r\nconst augmentedMethods = {\r\n    searchSuppliers: async (query: string, page: number, limit: number = 20) => {\r\n        return new Promise<{ items: { value: string; label: string }[], hasNextPage: boolean }>(resolve => {\r\n            setTimeout(() => {\r\n                const allSuppliers = baseStore.getState().data;\r\n                const results = query ? fuse.search(query).map(r => r.item) : allSuppliers;\r\n                \r\n                const start = (page - 1) * limit;\r\n                const end = start + limit;\r\n                const paginatedItems = results.slice(start, end);\r\n\r\n                resolve({\r\n                    items: paginatedItems.map(s => ({ value: s.systemId, label: s.name })),\r\n                    hasNextPage: end < results.length,\r\n                });\r\n            }, 300);\r\n        });\r\n    },\r\n    updateStatus: (systemIds: SystemId[], status: Supplier['status']) => {\r\n        const currentUser = asSystemId(getCurrentUserSystemId());\r\n        baseStore.setState((state) => ({\r\n            data: state.data.map((item) =>\r\n                systemIds.includes(item.systemId)\r\n                    ? { ...item, status, updatedBy: currentUser, updatedAt: new Date().toISOString() }\r\n                    : item\r\n            ),\r\n        }));\r\n    },\r\n    bulkDelete: (systemIds: SystemId[]) => {\r\n        const currentUser = asSystemId(getCurrentUserSystemId());\r\n        baseStore.setState((state) => ({\r\n            data: state.data.map((item) =>\r\n                systemIds.includes(item.systemId)\r\n                    ? { ...item, isDeleted: true, deletedBy: currentUser, deletedAt: new Date().toISOString() }\r\n                    : item\r\n            ),\r\n        }));\r\n    }\r\n};\r\n\r\n// Export typed hook\r\nexport const useSupplierStore = (): SupplierStoreState => {\r\n  const state = baseStore();\r\n  return {\r\n    ...state,\r\n    ...augmentedMethods,\r\n  };\r\n};\r\n\r\n// Export getState for non-hook usage\r\nuseSupplierStore.getState = (): SupplierStoreState => {\r\n  const state = baseStore.getState();\r\n  return {\r\n    ...state,\r\n    ...augmentedMethods,\r\n  };\r\n};\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1294, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/inventory-receipts/api/inventory-receipts-api.ts"],"sourcesContent":["/**\r\n * Inventory Receipts (Phiếu Nhập Kho) API functions\r\n * \r\n * ⚠️ Direct import: import { fetchInventoryReceipts } from '@/features/inventory-receipts/api/inventory-receipts-api'\r\n */\r\n\r\nimport type { SystemId } from '@/lib/id-types';\r\nimport type { InventoryReceipt } from '../types';\r\n\r\nconst BASE_URL = '/api/inventory-receipts';\r\n\r\nexport interface InventoryReceiptsParams {\r\n  page?: number;\r\n  limit?: number;\r\n  search?: string;\r\n  supplierId?: string;\r\n  purchaseOrderId?: string;\r\n  branchId?: string;\r\n  receiverId?: string;\r\n  startDate?: string;\r\n  endDate?: string;\r\n  sortBy?: string;\r\n  sortOrder?: 'asc' | 'desc';\r\n}\r\n\r\nexport interface InventoryReceiptsResponse {\r\n  data: InventoryReceipt[];\r\n  total: number;\r\n  page: number;\r\n  pageSize: number;\r\n}\r\n\r\nexport async function fetchInventoryReceipts(params: InventoryReceiptsParams = {}): Promise<InventoryReceiptsResponse> {\r\n  const searchParams = new URLSearchParams();\r\n  \r\n  if (params.page) searchParams.set('page', String(params.page));\r\n  if (params.limit) searchParams.set('limit', String(params.limit));\r\n  if (params.search) searchParams.set('search', params.search);\r\n  if (params.supplierId) searchParams.set('supplierId', params.supplierId);\r\n  if (params.purchaseOrderId) searchParams.set('purchaseOrderId', params.purchaseOrderId);\r\n  if (params.branchId) searchParams.set('branchId', params.branchId);\r\n  if (params.receiverId) searchParams.set('receiverId', params.receiverId);\r\n  if (params.startDate) searchParams.set('startDate', params.startDate);\r\n  if (params.endDate) searchParams.set('endDate', params.endDate);\r\n  if (params.sortBy) searchParams.set('sortBy', params.sortBy);\r\n  if (params.sortOrder) searchParams.set('sortOrder', params.sortOrder);\r\n  \r\n  const url = searchParams.toString() ? `${BASE_URL}?${searchParams}` : BASE_URL;\r\n  const response = await fetch(url);\r\n  \r\n  if (!response.ok) {\r\n    throw new Error(`Failed to fetch inventory receipts: ${response.statusText}`);\r\n  }\r\n  \r\n  return response.json();\r\n}\r\n\r\nexport async function fetchInventoryReceipt(systemId: SystemId): Promise<InventoryReceipt> {\r\n  const response = await fetch(`${BASE_URL}/${systemId}`);\r\n  \r\n  if (!response.ok) {\r\n    throw new Error(`Failed to fetch inventory receipt: ${response.statusText}`);\r\n  }\r\n  \r\n  return response.json();\r\n}\r\n\r\nexport async function createInventoryReceipt(data: Omit<InventoryReceipt, 'systemId' | 'id' | 'createdAt' | 'updatedAt'>): Promise<InventoryReceipt> {\r\n  const response = await fetch(BASE_URL, {\r\n    method: 'POST',\r\n    headers: { 'Content-Type': 'application/json' },\r\n    body: JSON.stringify(data),\r\n  });\r\n  \r\n  if (!response.ok) {\r\n    const error = await response.json().catch(() => ({}));\r\n    throw new Error(error.message || 'Failed to create inventory receipt');\r\n  }\r\n  \r\n  return response.json();\r\n}\r\n\r\nexport async function updateInventoryReceipt(systemId: SystemId, data: Partial<InventoryReceipt>): Promise<InventoryReceipt> {\r\n  const response = await fetch(`${BASE_URL}/${systemId}`, {\r\n    method: 'PUT',\r\n    headers: { 'Content-Type': 'application/json' },\r\n    body: JSON.stringify(data),\r\n  });\r\n  \r\n  if (!response.ok) {\r\n    const error = await response.json().catch(() => ({}));\r\n    throw new Error(error.message || 'Failed to update inventory receipt');\r\n  }\r\n  \r\n  return response.json();\r\n}\r\n\r\nexport async function deleteInventoryReceipt(systemId: SystemId): Promise<void> {\r\n  const response = await fetch(`${BASE_URL}/${systemId}`, {\r\n    method: 'DELETE',\r\n  });\r\n  \r\n  if (!response.ok) {\r\n    throw new Error(`Failed to delete inventory receipt: ${response.statusText}`);\r\n  }\r\n}\r\n"],"names":[],"mappings":"AAAA;;;;CAIC;;;;;;;;;;;;AAKD,MAAM,WAAW;AAuBV,eAAe,uBAAuB,SAAkC,CAAC,CAAC;IAC/E,MAAM,eAAe,IAAI;IAEzB,IAAI,OAAO,IAAI,EAAE,aAAa,GAAG,CAAC,QAAQ,OAAO,OAAO,IAAI;IAC5D,IAAI,OAAO,KAAK,EAAE,aAAa,GAAG,CAAC,SAAS,OAAO,OAAO,KAAK;IAC/D,IAAI,OAAO,MAAM,EAAE,aAAa,GAAG,CAAC,UAAU,OAAO,MAAM;IAC3D,IAAI,OAAO,UAAU,EAAE,aAAa,GAAG,CAAC,cAAc,OAAO,UAAU;IACvE,IAAI,OAAO,eAAe,EAAE,aAAa,GAAG,CAAC,mBAAmB,OAAO,eAAe;IACtF,IAAI,OAAO,QAAQ,EAAE,aAAa,GAAG,CAAC,YAAY,OAAO,QAAQ;IACjE,IAAI,OAAO,UAAU,EAAE,aAAa,GAAG,CAAC,cAAc,OAAO,UAAU;IACvE,IAAI,OAAO,SAAS,EAAE,aAAa,GAAG,CAAC,aAAa,OAAO,SAAS;IACpE,IAAI,OAAO,OAAO,EAAE,aAAa,GAAG,CAAC,WAAW,OAAO,OAAO;IAC9D,IAAI,OAAO,MAAM,EAAE,aAAa,GAAG,CAAC,UAAU,OAAO,MAAM;IAC3D,IAAI,OAAO,SAAS,EAAE,aAAa,GAAG,CAAC,aAAa,OAAO,SAAS;IAEpE,MAAM,MAAM,aAAa,QAAQ,KAAK,GAAG,SAAS,CAAC,EAAE,cAAc,GAAG;IACtE,MAAM,WAAW,MAAM,MAAM;IAE7B,IAAI,CAAC,SAAS,EAAE,EAAE;QAChB,MAAM,IAAI,MAAM,CAAC,oCAAoC,EAAE,SAAS,UAAU,EAAE;IAC9E;IAEA,OAAO,SAAS,IAAI;AACtB;AAEO,eAAe,sBAAsB,QAAkB;IAC5D,MAAM,WAAW,MAAM,MAAM,GAAG,SAAS,CAAC,EAAE,UAAU;IAEtD,IAAI,CAAC,SAAS,EAAE,EAAE;QAChB,MAAM,IAAI,MAAM,CAAC,mCAAmC,EAAE,SAAS,UAAU,EAAE;IAC7E;IAEA,OAAO,SAAS,IAAI;AACtB;AAEO,eAAe,uBAAuB,IAA2E;IACtH,MAAM,WAAW,MAAM,MAAM,UAAU;QACrC,QAAQ;QACR,SAAS;YAAE,gBAAgB;QAAmB;QAC9C,MAAM,KAAK,SAAS,CAAC;IACvB;IAEA,IAAI,CAAC,SAAS,EAAE,EAAE;QAChB,MAAM,QAAQ,MAAM,SAAS,IAAI,GAAG,KAAK,CAAC,IAAM,CAAC,CAAC,CAAC;QACnD,MAAM,IAAI,MAAM,MAAM,OAAO,IAAI;IACnC;IAEA,OAAO,SAAS,IAAI;AACtB;AAEO,eAAe,uBAAuB,QAAkB,EAAE,IAA+B;IAC9F,MAAM,WAAW,MAAM,MAAM,GAAG,SAAS,CAAC,EAAE,UAAU,EAAE;QACtD,QAAQ;QACR,SAAS;YAAE,gBAAgB;QAAmB;QAC9C,MAAM,KAAK,SAAS,CAAC;IACvB;IAEA,IAAI,CAAC,SAAS,EAAE,EAAE;QAChB,MAAM,QAAQ,MAAM,SAAS,IAAI,GAAG,KAAK,CAAC,IAAM,CAAC,CAAC,CAAC;QACnD,MAAM,IAAI,MAAM,MAAM,OAAO,IAAI;IACnC;IAEA,OAAO,SAAS,IAAI;AACtB;AAEO,eAAe,uBAAuB,QAAkB;IAC7D,MAAM,WAAW,MAAM,MAAM,GAAG,SAAS,CAAC,EAAE,UAAU,EAAE;QACtD,QAAQ;IACV;IAEA,IAAI,CAAC,SAAS,EAAE,EAAE;QAChB,MAAM,IAAI,MAAM,CAAC,oCAAoC,EAAE,SAAS,UAAU,EAAE;IAC9E;AACF"}},
    {"offset": {"line": 1381, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/inventory-receipts/hooks/use-inventory-receipts.ts"],"sourcesContent":["/**\r\n * useInventoryReceipts - React Query hooks (Phiếu Nhập Kho)\r\n * \r\n * ⚠️ Direct import: import { useInventoryReceipts } from '@/features/inventory-receipts/hooks/use-inventory-receipts'\r\n */\r\n\r\nimport { useQuery, useMutation, useQueryClient, keepPreviousData } from '@tanstack/react-query';\r\nimport {\r\n  fetchInventoryReceipts,\r\n  fetchInventoryReceipt,\r\n  createInventoryReceipt,\r\n  updateInventoryReceipt,\r\n  deleteInventoryReceipt,\r\n  type InventoryReceiptsParams,\r\n} from '../api/inventory-receipts-api';\r\nimport type { InventoryReceipt } from '../types';\r\nimport { asSystemId } from '@/lib/id-types';\r\n\r\nexport const inventoryReceiptKeys = {\r\n  all: ['inventory-receipts'] as const,\r\n  lists: () => [...inventoryReceiptKeys.all, 'list'] as const,\r\n  list: (params: InventoryReceiptsParams) => [...inventoryReceiptKeys.lists(), params] as const,\r\n  details: () => [...inventoryReceiptKeys.all, 'detail'] as const,\r\n  detail: (id: string) => [...inventoryReceiptKeys.details(), id] as const,\r\n};\r\n\r\nexport function useInventoryReceipts(params: InventoryReceiptsParams = {}) {\r\n  return useQuery({\r\n    queryKey: inventoryReceiptKeys.list(params),\r\n    queryFn: () => fetchInventoryReceipts(params),\r\n    staleTime: 30_000,\r\n    gcTime: 5 * 60 * 1000,\r\n    placeholderData: keepPreviousData,\r\n  });\r\n}\r\n\r\nexport function useInventoryReceipt(id: string | null | undefined) {\r\n  return useQuery({\r\n    queryKey: inventoryReceiptKeys.detail(id!),\r\n    queryFn: () => fetchInventoryReceipt(asSystemId(id!)),\r\n    enabled: !!id,\r\n    staleTime: 60_000,\r\n  });\r\n}\r\n\r\ninterface UseInventoryReceiptMutationsOptions {\r\n  onCreateSuccess?: (receipt: InventoryReceipt) => void;\r\n  onUpdateSuccess?: (receipt: InventoryReceipt) => void;\r\n  onDeleteSuccess?: () => void;\r\n  onError?: (error: Error) => void;\r\n}\r\n\r\nexport function useInventoryReceiptMutations(options: UseInventoryReceiptMutationsOptions = {}) {\r\n  const queryClient = useQueryClient();\r\n  \r\n  const create = useMutation({\r\n    mutationFn: createInventoryReceipt,\r\n    onSuccess: (data) => {\r\n      queryClient.invalidateQueries({ queryKey: inventoryReceiptKeys.lists() });\r\n      options.onCreateSuccess?.(data);\r\n    },\r\n    onError: options.onError,\r\n  });\r\n  \r\n  const update = useMutation({\r\n    mutationFn: ({ systemId, data }: { systemId: string; data: Partial<InventoryReceipt> }) => \r\n      updateInventoryReceipt(asSystemId(systemId), data),\r\n    onSuccess: (data, variables) => {\r\n      queryClient.invalidateQueries({ queryKey: inventoryReceiptKeys.detail(variables.systemId) });\r\n      queryClient.invalidateQueries({ queryKey: inventoryReceiptKeys.lists() });\r\n      options.onUpdateSuccess?.(data);\r\n    },\r\n    onError: options.onError,\r\n  });\r\n  \r\n  const remove = useMutation({\r\n    mutationFn: (systemId: string) => deleteInventoryReceipt(asSystemId(systemId)),\r\n    onSuccess: () => {\r\n      queryClient.invalidateQueries({ queryKey: inventoryReceiptKeys.all });\r\n      options.onDeleteSuccess?.();\r\n    },\r\n    onError: options.onError,\r\n  });\r\n  \r\n  return { create, update, remove };\r\n}\r\n\r\nexport function useInventoryReceiptsBySupplier(supplierId: string | null | undefined) {\r\n  return useInventoryReceipts({\r\n    supplierId: supplierId || undefined,\r\n    limit: 50,\r\n  });\r\n}\r\n\r\nexport function useInventoryReceiptsByPO(purchaseOrderId: string | null | undefined) {\r\n  return useInventoryReceipts({\r\n    purchaseOrderId: purchaseOrderId || undefined,\r\n    limit: 20,\r\n  });\r\n}\r\n"],"names":[],"mappings":";;;;;;;;;;;;;;AAAA;;;;CAIC,GAED;AAAA;AAAA;AAAA;AACA;AASA;;;;;AAEO,MAAM,uBAAuB;IAClC,KAAK;QAAC;KAAqB;IAC3B,OAAO,IAAM;eAAI,qBAAqB,GAAG;YAAE;SAAO;IAClD,MAAM,CAAC,SAAoC;eAAI,qBAAqB,KAAK;YAAI;SAAO;IACpF,SAAS,IAAM;eAAI,qBAAqB,GAAG;YAAE;SAAS;IACtD,QAAQ,CAAC,KAAe;eAAI,qBAAqB,OAAO;YAAI;SAAG;AACjE;AAEO,SAAS,qBAAqB,SAAkC,CAAC,CAAC;;IACvE,OAAO,IAAA,0LAAQ,EAAC;QACd,UAAU,qBAAqB,IAAI,CAAC;QACpC,OAAO;6CAAE,IAAM,IAAA,qMAAsB,EAAC;;QACtC,WAAW;QACX,QAAQ,IAAI,KAAK;QACjB,iBAAiB,8LAAgB;IACnC;AACF;GARgB;;QACP,0LAAQ;;;AASV,SAAS,oBAAoB,EAA6B;;IAC/D,OAAO,IAAA,0LAAQ,EAAC;QACd,UAAU,qBAAqB,MAAM,CAAC;QACtC,OAAO;4CAAE,IAAM,IAAA,oMAAqB,EAAC,IAAA,mIAAU,EAAC;;QAChD,SAAS,CAAC,CAAC;QACX,WAAW;IACb;AACF;IAPgB;;QACP,0LAAQ;;;AAeV,SAAS,6BAA6B,UAA+C,CAAC,CAAC;;IAC5F,MAAM,cAAc,IAAA,2MAAc;IAElC,MAAM,SAAS,IAAA,gMAAW,EAAC;QACzB,YAAY,qMAAsB;QAClC,SAAS;gEAAE,CAAC;gBACV,YAAY,iBAAiB,CAAC;oBAAE,UAAU,qBAAqB,KAAK;gBAAG;gBACvE,QAAQ,eAAe,GAAG;YAC5B;;QACA,SAAS,QAAQ,OAAO;IAC1B;IAEA,MAAM,SAAS,IAAA,gMAAW,EAAC;QACzB,UAAU;gEAAE,CAAC,EAAE,QAAQ,EAAE,IAAI,EAAyD,GACpF,IAAA,qMAAsB,EAAC,IAAA,mIAAU,EAAC,WAAW;;QAC/C,SAAS;gEAAE,CAAC,MAAM;gBAChB,YAAY,iBAAiB,CAAC;oBAAE,UAAU,qBAAqB,MAAM,CAAC,UAAU,QAAQ;gBAAE;gBAC1F,YAAY,iBAAiB,CAAC;oBAAE,UAAU,qBAAqB,KAAK;gBAAG;gBACvE,QAAQ,eAAe,GAAG;YAC5B;;QACA,SAAS,QAAQ,OAAO;IAC1B;IAEA,MAAM,SAAS,IAAA,gMAAW,EAAC;QACzB,UAAU;gEAAE,CAAC,WAAqB,IAAA,qMAAsB,EAAC,IAAA,mIAAU,EAAC;;QACpE,SAAS;gEAAE;gBACT,YAAY,iBAAiB,CAAC;oBAAE,UAAU,qBAAqB,GAAG;gBAAC;gBACnE,QAAQ,eAAe;YACzB;;QACA,SAAS,QAAQ,OAAO;IAC1B;IAEA,OAAO;QAAE;QAAQ;QAAQ;IAAO;AAClC;IAjCgB;;QACM,2MAAc;QAEnB,gMAAW;QASX,gMAAW;QAWX,gMAAW;;;AAYrB,SAAS,+BAA+B,UAAqC;;IAClF,OAAO,qBAAqB;QAC1B,YAAY,cAAc;QAC1B,OAAO;IACT;AACF;IALgB;;QACP;;;AAMF,SAAS,yBAAyB,eAA0C;;IACjF,OAAO,qBAAqB;QAC1B,iBAAiB,mBAAmB;QACpC,OAAO;IACT;AACF;IALgB;;QACP"}},
    {"offset": {"line": 1554, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/inventory-receipts/store.ts"],"sourcesContent":["import { createCrudStore, CrudState } from '../../lib/store-factory';\r\n// REMOVED: import { data as initialData } from './data'; // Mock data no longer used - database is source of truth\r\nimport type { InventoryReceipt, InventoryReceiptLineItem } from './types';\r\nimport type { SystemId, BusinessId } from '../../lib/id-types';\r\nimport { useProductStore } from '../products/store';\r\n\r\nconst baseStore = createCrudStore<InventoryReceipt>(\r\n  [],\r\n  'inventory-receipts',\r\n  {\r\n    apiEndpoint: '/api/inventory-receipts',\r\n  }\r\n);\r\n\r\nexport interface InventoryReceiptStoreState extends CrudState<InventoryReceipt> {\r\n  // Add custom methods if needed\r\n}\r\n\r\nconst addReceipt = (item: Omit<InventoryReceipt, 'systemId'>) => {\r\n  const newItem = baseStore.getState().add(item);\r\n  \r\n  // Update last purchase price for all items in the receipt\r\n  const productStore = useProductStore.getState();\r\n  newItem.items.forEach(item => {\r\n    if (item.productSystemId && item.unitPrice > 0) {\r\n      productStore.updateLastPurchasePrice(\r\n        item.productSystemId, \r\n        item.unitPrice, \r\n        newItem.receivedDate\r\n      );\r\n    }\r\n  });\r\n  \r\n  return newItem;\r\n};\r\n\r\nconst updateReceipt = (systemId: SystemId, updates: Partial<InventoryReceipt>) => {\r\n  baseStore.getState().update(systemId, updates);\r\n  \r\n  // Update last purchase price if items or date changed\r\n  if (updates.items || updates.receivedDate) {\r\n    const updatedReceipt = baseStore.getState().findById(systemId);\r\n    if (updatedReceipt) {\r\n      const productStore = useProductStore.getState();\r\n      updatedReceipt.items.forEach(item => {\r\n        if (item.productSystemId && item.unitPrice > 0) {\r\n          productStore.updateLastPurchasePrice(\r\n            item.productSystemId, \r\n            item.unitPrice, \r\n            updatedReceipt.receivedDate\r\n          );\r\n        }\r\n      });\r\n    }\r\n  }\r\n};\r\n\r\nexport const useInventoryReceiptStore = (): InventoryReceiptStoreState => {\r\n  const state = baseStore();\r\n  return {\r\n    ...state,\r\n    add: addReceipt,\r\n    update: updateReceipt,\r\n  };\r\n};\r\n\r\nuseInventoryReceiptStore.getState = () => {\r\n  const state = baseStore.getState();\r\n  return {\r\n    ...state,\r\n    add: addReceipt,\r\n    update: updateReceipt,\r\n  };\r\n};\r\n\r\n(useInventoryReceiptStore as any).subscribe = baseStore.subscribe;\r\n(useInventoryReceiptStore as any).setState = baseStore.setState;\r\n\r\ntype PurchaseOrderReference = {\r\n  systemId: SystemId;\r\n  id: BusinessId;\r\n  branchSystemId?: SystemId;\r\n  branchName?: string;\r\n  supplierSystemId?: SystemId;\r\n  supplierName?: string;\r\n};\r\n\r\ntype ProductReference = {\r\n  systemId: SystemId;\r\n  id: BusinessId;\r\n  name: string;\r\n  sku?: string;\r\n};\r\n\r\ntype InventoryReceiptBackfillInput = {\r\n  purchaseOrders: PurchaseOrderReference[];\r\n  products?: ProductReference[];\r\n};\r\n\r\nconst normalizeKey = (value?: string | null) => (value ? value.trim().toLowerCase() : '');\r\n\r\nconst buildLookup = <T extends { systemId: SystemId; id: BusinessId }>(\r\n  entries: T[],\r\n  extraKeys?: (entry: T) => (string | undefined)[],\r\n) => {\r\n  const bySystemId = new Map<string, T>();\r\n  const byAnyKey = new Map<string, T>();\r\n\r\n  entries.forEach(entry => {\r\n    const systemKey = normalizeKey(entry.systemId);\r\n    const businessKey = normalizeKey(entry.id);\r\n    if (systemKey) {\r\n      bySystemId.set(systemKey, entry);\r\n      byAnyKey.set(systemKey, entry);\r\n    }\r\n    if (businessKey) {\r\n      byAnyKey.set(businessKey, entry);\r\n    }\r\n    (extraKeys?.(entry) ?? []).forEach(key => {\r\n      const normalized = normalizeKey(key);\r\n      if (normalized) {\r\n        byAnyKey.set(normalized, entry);\r\n      }\r\n    });\r\n  });\r\n\r\n  return { bySystemId, byAnyKey };\r\n};\r\n\r\nconst matchProduct = (\r\n  item: InventoryReceiptLineItem,\r\n  lookup: Map<string, ProductReference>,\r\n) => {\r\n  const candidates = [item.productSystemId, item.productId, item.productName];\r\n  for (const candidate of candidates) {\r\n    const normalized = normalizeKey(candidate);\r\n    if (!normalized) continue;\r\n    const product = lookup.get(normalized);\r\n    if (product) {\r\n      return product;\r\n    }\r\n  }\r\n  return undefined;\r\n};\r\n\r\n/**\r\n * Ensure historical receipts keep dual IDs + branch context + correct product linkage.\r\n * Call once after purchase order & product stores are hydrated to migrate legacy data.\r\n */\r\nexport function syncInventoryReceiptsWithPurchaseOrders({\r\n  purchaseOrders,\r\n  products,\r\n}: InventoryReceiptBackfillInput) {\r\n  if (!purchaseOrders.length) return;\r\n\r\n  const poLookup = buildLookup(purchaseOrders, po => [po.id]);\r\n  const productLookup = buildLookup(products ?? [], product => [product.id, product.sku, product.name]);\r\n\r\n  const storeState = useInventoryReceiptStore.getState();\r\n  const updated = storeState.data.map(receipt => {\r\n    let next = receipt;\r\n    const matchedPo =\r\n      poLookup.bySystemId.get(normalizeKey(receipt.purchaseOrderSystemId)) ||\r\n      poLookup.byAnyKey.get(normalizeKey(receipt.purchaseOrderId));\r\n\r\n    if (!matchedPo) {\r\n      return receipt;\r\n    }\r\n\r\n    const updates: Partial<InventoryReceipt> = {};\r\n    let mutated = false;\r\n\r\n    if (receipt.purchaseOrderSystemId !== matchedPo.systemId) {\r\n      updates.purchaseOrderSystemId = matchedPo.systemId;\r\n      mutated = true;\r\n    }\r\n\r\n    if (receipt.purchaseOrderId !== matchedPo.id) {\r\n      updates.purchaseOrderId = matchedPo.id;\r\n      mutated = true;\r\n    }\r\n\r\n    if (matchedPo.branchSystemId && receipt.branchSystemId !== matchedPo.branchSystemId) {\r\n      updates.branchSystemId = matchedPo.branchSystemId;\r\n      mutated = true;\r\n    }\r\n\r\n    if (matchedPo.branchName && receipt.branchName !== matchedPo.branchName) {\r\n      updates.branchName = matchedPo.branchName;\r\n      mutated = true;\r\n    }\r\n\r\n    if (matchedPo.supplierSystemId && receipt.supplierSystemId !== matchedPo.supplierSystemId) {\r\n      updates.supplierSystemId = matchedPo.supplierSystemId;\r\n      mutated = true;\r\n    }\r\n\r\n    if (matchedPo.supplierName && receipt.supplierName !== matchedPo.supplierName) {\r\n      updates.supplierName = matchedPo.supplierName;\r\n      mutated = true;\r\n    }\r\n\r\n    if (products?.length) {\r\n      const normalizedItems = next.items.map(item => {\r\n        const matchedProduct = matchProduct(item, productLookup.byAnyKey);\r\n        if (!matchedProduct) {\r\n          return item;\r\n        }\r\n\r\n        if (\r\n          item.productSystemId === matchedProduct.systemId &&\r\n          item.productId === matchedProduct.id &&\r\n          item.productName === matchedProduct.name\r\n        ) {\r\n          return item;\r\n        }\r\n\r\n        mutated = true;\r\n        return {\r\n          ...item,\r\n          productSystemId: matchedProduct.systemId,\r\n          productId: matchedProduct.id,\r\n          productName: matchedProduct.name,\r\n        };\r\n      });\r\n\r\n      const itemsChanged = normalizedItems.some((item, index) => item !== next.items[index]);\r\n      if (itemsChanged) {\r\n        updates.items = normalizedItems;\r\n      }\r\n    }\r\n\r\n    return mutated ? { ...next, ...updates } : receipt;\r\n  });\r\n\r\n  const hasChanges = updated.some((receipt, index) => receipt !== storeState.data[index]);\r\n  if (hasChanges) {\r\n    (baseStore as any).setState({ data: updated });\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1737, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/products/api/products-api.ts"],"sourcesContent":["/**\r\n * Products API - Isolated API functions\r\n * \r\n * ⚠️ IMPORTANT: This file should ONLY contain:\r\n * - Fetch functions\r\n * - Type imports from ../types\r\n * - NO store imports\r\n * - NO cross-feature imports\r\n */\r\n\r\nimport type { Product } from '../types';\r\n\r\nconst API_BASE = '/api/products';\r\n\r\nexport interface ProductsParams {\r\n  page?: number;\r\n  limit?: number;\r\n  search?: string;\r\n  categoryId?: string;\r\n  brandId?: string;\r\n  status?: string;\r\n  type?: string;\r\n  inStock?: boolean;\r\n  sortBy?: string;\r\n  sortOrder?: 'asc' | 'desc';\r\n}\r\n\r\nexport interface PaginatedResponse<T> {\r\n  data: T[];\r\n  pagination: {\r\n    page: number;\r\n    limit: number;\r\n    total: number;\r\n    totalPages: number;\r\n  };\r\n}\r\n\r\nexport interface CreateProductInput {\r\n  id?: string;  // Business ID (auto-generated if not provided)\r\n  name: string;\r\n  sku?: string;\r\n  barcode?: string;\r\n  categoryId?: string;\r\n  brandId?: string;\r\n  sellingPrice: number;\r\n  costPrice?: number;\r\n  description?: string;\r\n  images?: string[];\r\n  // Optional fields \r\n  type?: string;\r\n  productTypeSystemId?: string;\r\n  unit?: string;\r\n  prices?: Record<string, number>;\r\n  pkgxId?: number | undefined;\r\n  status?: string;\r\n  inventoryByBranch?: Record<string, number>;\r\n  committedByBranch?: Record<string, number>;\r\n  inTransitByBranch?: Record<string, number>;\r\n  isDeleted?: boolean;\r\n  updatedAt?: string;\r\n}\r\n\r\nexport interface UpdateProductInput extends Partial<CreateProductInput> {\r\n  systemId: string;\r\n  // Legacy field for backward compatibility\r\n  stockQuantity?: number;\r\n}\r\n\r\n/**\r\n * Fetch paginated products list\r\n */\r\nexport async function fetchProducts(params: ProductsParams = {}): Promise<PaginatedResponse<Product>> {\r\n  const { page = 1, limit = 50, ...rest } = params;\r\n  \r\n  const searchParams = new URLSearchParams({\r\n    page: String(page),\r\n    limit: String(limit),\r\n  });\r\n  \r\n  // Add optional params\r\n  Object.entries(rest).forEach(([key, value]) => {\r\n    if (value != null && value !== '') {\r\n      searchParams.set(key, String(value));\r\n    }\r\n  });\r\n  \r\n  const res = await fetch(`${API_BASE}?${searchParams}`, {\r\n    credentials: 'include',\r\n  });\r\n  \r\n  if (!res.ok) {\r\n    throw new Error(`Failed to fetch products: ${res.statusText}`);\r\n  }\r\n  \r\n  return res.json();\r\n}\r\n\r\n/**\r\n * Fetch single product by ID\r\n */\r\nexport async function fetchProduct(id: string): Promise<Product> {\r\n  const res = await fetch(`${API_BASE}/${id}`, {\r\n    credentials: 'include',\r\n  });\r\n  \r\n  if (!res.ok) {\r\n    throw new Error(`Failed to fetch product ${id}: ${res.statusText}`);\r\n  }\r\n  \r\n  return res.json();\r\n}\r\n\r\n/**\r\n * Create new product\r\n */\r\nexport async function createProduct(data: CreateProductInput): Promise<Product> {\r\n  const res = await fetch(API_BASE, {\r\n    method: 'POST',\r\n    headers: { 'Content-Type': 'application/json' },\r\n    credentials: 'include',\r\n    body: JSON.stringify(data),\r\n  });\r\n  \r\n  if (!res.ok) {\r\n    const error = await res.json().catch(() => ({}));\r\n    throw new Error(error.message || `Failed to create product: ${res.statusText}`);\r\n  }\r\n  \r\n  return res.json();\r\n}\r\n\r\n/**\r\n * Update existing product\r\n */\r\nexport async function updateProduct({ systemId, ...data }: UpdateProductInput): Promise<Product> {\r\n  const res = await fetch(`${API_BASE}/${systemId}`, {\r\n    method: 'PATCH',\r\n    headers: { 'Content-Type': 'application/json' },\r\n    credentials: 'include',\r\n    body: JSON.stringify(data),\r\n  });\r\n  \r\n  if (!res.ok) {\r\n    const error = await res.json().catch(() => ({}));\r\n    throw new Error(error.message || `Failed to update product: ${res.statusText}`);\r\n  }\r\n  \r\n  return res.json();\r\n}\r\n\r\n/**\r\n * Delete product (soft delete)\r\n */\r\nexport async function deleteProduct(id: string): Promise<void> {\r\n  const res = await fetch(`${API_BASE}/${id}`, {\r\n    method: 'DELETE',\r\n    credentials: 'include',\r\n  });\r\n  \r\n  if (!res.ok) {\r\n    const error = await res.json().catch(() => ({}));\r\n    throw new Error(error.message || `Failed to delete product: ${res.statusText}`);\r\n  }\r\n}\r\n\r\n/**\r\n * Search products for autocomplete\r\n */\r\nexport async function searchProducts(query: string, limit = 20): Promise<Product[]> {\r\n  const res = await fetch(`${API_BASE}?search=${encodeURIComponent(query)}&limit=${limit}`, {\r\n    credentials: 'include',\r\n  });\r\n  \r\n  if (!res.ok) {\r\n    throw new Error(`Failed to search products: ${res.statusText}`);\r\n  }\r\n  \r\n  const json = await res.json();\r\n  return json.data || [];\r\n}\r\n\r\n/**\r\n * Fetch product inventory by branch\r\n */\r\nexport async function fetchProductInventory(productId: string): Promise<Record<string, number>> {\r\n  const res = await fetch(`${API_BASE}/${productId}/inventory`, {\r\n    credentials: 'include',\r\n  });\r\n  \r\n  if (!res.ok) {\r\n    throw new Error(`Failed to fetch product inventory: ${res.statusText}`);\r\n  }\r\n  \r\n  return res.json();\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1857, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/products/hooks/use-products.ts"],"sourcesContent":["/**\r\n * useProducts - React Query hooks for products\r\n * \r\n * ⚠️ IMPORTANT: Direct import pattern\r\n * - Import this file directly: import { useProducts } from '@/features/products/hooks/use-products'\r\n * - NEVER import from '@/features/products' or '@/features/products/store'\r\n * \r\n * This hook is ISOLATED - it only depends on:\r\n * - @tanstack/react-query\r\n * - Local API functions\r\n * - Local types\r\n */\r\n\r\nimport { useQuery, useMutation, useQueryClient, keepPreviousData } from '@tanstack/react-query';\r\nimport {\r\n  fetchProducts,\r\n  fetchProduct,\r\n  createProduct,\r\n  updateProduct,\r\n  deleteProduct,\r\n  searchProducts,\r\n  fetchProductInventory,\r\n  type ProductsParams,\r\n  type CreateProductInput,\r\n  type UpdateProductInput,\r\n} from '../api/products-api';\r\n\r\n// Query keys - exported for invalidation\r\nexport const productKeys = {\r\n  all: ['products'] as const,\r\n  lists: () => [...productKeys.all, 'list'] as const,\r\n  list: (params: ProductsParams) => [...productKeys.lists(), params] as const,\r\n  details: () => [...productKeys.all, 'detail'] as const,\r\n  detail: (id: string) => [...productKeys.details(), id] as const,\r\n  search: (query: string) => [...productKeys.all, 'search', query] as const,\r\n  inventory: (id: string) => [...productKeys.all, 'inventory', id] as const,\r\n};\r\n\r\n/**\r\n * Hook for fetching paginated products list\r\n * \r\n * @example\r\n * ```tsx\r\n * function ProductsPage() {\r\n *   const [page, setPage] = useState(1);\r\n *   const { data, isLoading } = useProducts({ page, limit: 50 });\r\n *   \r\n *   return (\r\n *     <DataTable \r\n *       data={data?.data || []} \r\n *       pagination={data?.pagination}\r\n *       onPageChange={setPage}\r\n *     />\r\n *   );\r\n * }\r\n * ```\r\n */\r\nexport function useProducts(params: ProductsParams = {}) {\r\n  return useQuery({\r\n    queryKey: productKeys.list(params),\r\n    queryFn: () => fetchProducts(params),\r\n    staleTime: 60_000, // 1 minute - products don't change frequently\r\n    gcTime: 10 * 60 * 1000, // 10 minutes\r\n    placeholderData: keepPreviousData,\r\n  });\r\n}\r\n\r\n/**\r\n * Hook for fetching single product by ID\r\n */\r\nexport function useProduct(id: string | null | undefined) {\r\n  return useQuery({\r\n    queryKey: productKeys.detail(id!),\r\n    queryFn: () => fetchProduct(id!),\r\n    enabled: !!id,\r\n    staleTime: 60_000,\r\n    gcTime: 10 * 60 * 1000,\r\n  });\r\n}\r\n\r\n/**\r\n * Hook for searching products (autocomplete)\r\n */\r\nexport function useProductSearch(query: string, limit = 20) {\r\n  return useQuery({\r\n    queryKey: productKeys.search(query),\r\n    queryFn: () => searchProducts(query, limit),\r\n    enabled: query.length >= 2,\r\n    staleTime: 30_000,\r\n  });\r\n}\r\n\r\n/**\r\n * Hook for fetching product inventory\r\n */\r\nexport function useProductInventory(productId: string | null | undefined) {\r\n  return useQuery({\r\n    queryKey: productKeys.inventory(productId!),\r\n    queryFn: () => fetchProductInventory(productId!),\r\n    enabled: !!productId,\r\n    staleTime: 30_000, // Inventory can change more frequently\r\n  });\r\n}\r\n\r\n/**\r\n * Hook for product mutations (create/update/delete)\r\n */\r\ninterface UseProductMutationsOptions {\r\n  onCreateSuccess?: (product: unknown) => void;\r\n  onUpdateSuccess?: (product: unknown) => void;\r\n  onDeleteSuccess?: () => void;\r\n  onError?: (error: Error) => void;\r\n}\r\n\r\nexport function useProductMutations(options: UseProductMutationsOptions = {}) {\r\n  const queryClient = useQueryClient();\r\n  \r\n  const create = useMutation({\r\n    mutationFn: createProduct,\r\n    onSuccess: (data) => {\r\n      queryClient.invalidateQueries({ queryKey: productKeys.lists() });\r\n      options.onCreateSuccess?.(data);\r\n    },\r\n    onError: options.onError,\r\n  });\r\n  \r\n  const update = useMutation({\r\n    mutationFn: updateProduct,\r\n    onSuccess: (data, variables) => {\r\n      queryClient.invalidateQueries({ queryKey: productKeys.detail(variables.systemId) });\r\n      queryClient.invalidateQueries({ queryKey: productKeys.lists() });\r\n      options.onUpdateSuccess?.(data);\r\n    },\r\n    onError: options.onError,\r\n  });\r\n  \r\n  const remove = useMutation({\r\n    mutationFn: deleteProduct,\r\n    onSuccess: () => {\r\n      queryClient.invalidateQueries({ queryKey: productKeys.all });\r\n      options.onDeleteSuccess?.();\r\n    },\r\n    onError: options.onError,\r\n  });\r\n  \r\n  return {\r\n    create,\r\n    update,\r\n    remove,\r\n    isCreating: create.isPending,\r\n    isUpdating: update.isPending,\r\n    isDeleting: remove.isPending,\r\n    isMutating: create.isPending || update.isPending || remove.isPending,\r\n  };\r\n}\r\n\r\n/**\r\n * Hook for getting products by category (for filtering)\r\n */\r\nexport function useProductsByCategory(categoryId: string | null | undefined) {\r\n  return useProducts({ \r\n    categoryId: categoryId || undefined, \r\n    limit: 100 \r\n  });\r\n}\r\n\r\n/**\r\n * Hook for getting products by brand\r\n */\r\nexport function useProductsByBrand(brandId: string | null | undefined) {\r\n  return useProducts({ \r\n    brandId: brandId || undefined, \r\n    limit: 100 \r\n  });\r\n}\r\n\r\n/**\r\n * Hook for getting active products only\r\n */\r\nexport function useActiveProducts(params: Omit<ProductsParams, 'status'> = {}) {\r\n  return useProducts({ ...params, status: 'active' });\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 2096, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/products/store.ts"],"sourcesContent":["import { createCrudStore, CrudState } from '../../lib/store-factory';\r\n// REMOVED: import { data as initialData } from './data'; // Mock data no longer used - database is source of truth\r\nimport type { Product } from './types';\r\nimport { type SystemId } from '@/lib/id-types';\r\nimport { asSystemId, asBusinessId } from '../../lib/id-types';\r\nimport { getCurrentUserSystemId } from '../../contexts/auth-context';\r\nimport Fuse from 'fuse.js';\r\nimport {\r\n  getCurrentUserInfo,\r\n  createCreatedEntry,\r\n  createUpdatedEntry,\r\n  createStatusChangedEntry,\r\n  appendHistoryEntry,\r\n  type HistoryEntry\r\n} from '../../lib/activity-history-helper';\r\n\r\nconst baseStore = createCrudStore<Product>([], 'products', {\r\n  businessIdField: 'id',\r\n  getCurrentUser: getCurrentUserSystemId, // ✅ Track who creates/updates\r\n  apiEndpoint: '/api/products',\r\n});\r\n\r\n// ✅ API Sync helpers\r\nconst API_ENDPOINT = '/api/products';\r\n\r\nconst syncToApi = {\r\n  create: async (product: Product) => {\r\n    try {\r\n      const response = await fetch(API_ENDPOINT, {\r\n        method: 'POST',\r\n        credentials: 'include',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify(product),\r\n      });\r\n      if (!response.ok) console.warn('[Product API] Create sync failed');\r\n      else console.log('[Product API] Created:', product.systemId);\r\n    } catch (e) {\r\n      console.warn('[Product API] Create sync error:', e);\r\n    }\r\n  },\r\n  update: async (systemId: SystemId, updates: Partial<Product>) => {\r\n    try {\r\n      const response = await fetch(`${API_ENDPOINT}/${systemId}`, {\r\n        method: 'PATCH',\r\n        credentials: 'include',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify(updates),\r\n      });\r\n      if (!response.ok) console.warn('[Product API] Update sync failed');\r\n      else console.log('[Product API] Updated:', systemId);\r\n    } catch (e) {\r\n      console.warn('[Product API] Update sync error:', e);\r\n    }\r\n  },\r\n  delete: async (systemId: SystemId, hard = false) => {\r\n    try {\r\n      const response = await fetch(`${API_ENDPOINT}/${systemId}`, {\r\n        method: 'DELETE',\r\n        credentials: 'include',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({ hard }),\r\n      });\r\n      if (!response.ok) console.warn('[Product API] Delete sync failed');\r\n      else console.log('[Product API] Deleted:', systemId);\r\n    } catch (e) {\r\n      console.warn('[Product API] Delete sync error:', e);\r\n    }\r\n  },\r\n  restore: async (systemId: SystemId) => {\r\n    try {\r\n      const response = await fetch(`${API_ENDPOINT}/${systemId}/restore`, {\r\n        method: 'POST',\r\n        credentials: 'include',\r\n        headers: { 'Content-Type': 'application/json' },\r\n      });\r\n      if (!response.ok) console.warn('[Product API] Restore sync failed');\r\n      else console.log('[Product API] Restored:', systemId);\r\n    } catch (e) {\r\n      console.warn('[Product API] Restore sync error:', e);\r\n    }\r\n  },\r\n};\r\n\r\n// ✅ Wrap base store methods with API sync\r\nconst originalAdd = baseStore.getState().add;\r\nconst originalUpdate = baseStore.getState().update;\r\nconst originalRemove = baseStore.getState().remove;\r\nconst originalHardDelete = baseStore.getState().hardDelete;\r\nconst originalRestore = baseStore.getState().restore;\r\n\r\nbaseStore.setState({\r\n  add: (item: Omit<Product, 'systemId'>) => {\r\n    const result = originalAdd(item);\r\n    syncToApi.create(result);\r\n    return result;\r\n  },\r\n  update: (systemId: SystemId, updates: Partial<Product>) => {\r\n    originalUpdate(systemId, updates);\r\n    syncToApi.update(systemId, updates);\r\n  },\r\n  remove: (systemId: SystemId) => {\r\n    originalRemove(systemId);\r\n    syncToApi.delete(systemId, false);\r\n  },\r\n  hardDelete: (systemId: SystemId) => {\r\n    originalHardDelete(systemId);\r\n    syncToApi.delete(systemId, true);\r\n  },\r\n  restore: (systemId: SystemId) => {\r\n    originalRestore(systemId);\r\n    syncToApi.restore(systemId);\r\n  },\r\n});\r\n\r\n// Define extended store interface\r\nexport interface ProductStoreState extends CrudState<Product> {\r\n  updateInventory: (productSystemId: SystemId, branchSystemId: SystemId, quantityChange: number) => void;\r\n  commitStock: (productSystemId: SystemId, branchSystemId: SystemId, quantity: number) => void;\r\n  uncommitStock: (productSystemId: SystemId, branchSystemId: SystemId, quantity: number) => void;\r\n  dispatchStock: (productSystemId: SystemId, branchSystemId: SystemId, quantity: number) => void;\r\n  completeDelivery: (productSystemId: SystemId, branchSystemId: SystemId, quantity: number) => void;\r\n  returnStockFromTransit: (productSystemId: SystemId, branchSystemId: SystemId, quantity: number) => void;\r\n  updateLastPurchasePrice: (productSystemId: SystemId, price: number, date: string) => void;\r\n  searchProducts: (query: string, page: number, limit?: number) => Promise<{ items: { value: SystemId; label: string }[], hasNextPage: boolean }>;\r\n}\r\n\r\n// Helper to check if product tracks stock\r\nconst canModifyStock = (product: Product | undefined): boolean => {\r\n  if (!product) return false;\r\n  // Services, digital products, and combos don't track stock directly\r\n  if (product.type === 'service' || product.type === 'digital' || product.type === 'combo') return false;\r\n  // Explicitly disabled stock tracking\r\n  if (product.isStockTracked === false) return false;\r\n  return true;\r\n};\r\n\r\n// Define custom methods\r\nconst updateInventory = (productSystemId: SystemId, branchSystemId: SystemId, quantityChange: number) => {\r\n  baseStore.setState(state => {\r\n    const product = state.data.find(p => p.systemId === productSystemId);\r\n    if (!product) return state;\r\n    \r\n    // Skip if product doesn't track stock\r\n    if (!canModifyStock(product)) {\r\n      console.warn(`[updateInventory] Skipped: Product ${productSystemId} does not track stock`);\r\n      return state;\r\n    }\r\n    \r\n    const oldQuantity = product.inventoryByBranch?.[branchSystemId] || 0;\r\n    const newQuantity = oldQuantity + quantityChange;\r\n    \r\n    // ✅ Removed COMPLAINT_ADJUSTMENT stock history creation\r\n    // Stock history will be created by inventory check balance instead\r\n    \r\n    return {\r\n      data: state.data.map(p => {\r\n        if (p.systemId === productSystemId) {\r\n          const newInventoryByBranch = { ...p.inventoryByBranch };\r\n          newInventoryByBranch[branchSystemId] = newQuantity;\r\n          return {\r\n            ...p,\r\n            inventoryByBranch: newInventoryByBranch,\r\n          };\r\n        }\r\n        return p;\r\n      }),\r\n    };\r\n  });\r\n};\r\n\r\nconst commitStock = (productSystemId: SystemId, branchSystemId: SystemId, quantity: number) => {\r\n  baseStore.setState(state => {\r\n    const product = state.data.find(p => p.systemId === productSystemId);\r\n    if (!canModifyStock(product)) {\r\n      console.warn(`[commitStock] Skipped: Product ${productSystemId} does not track stock`);\r\n      return state;\r\n    }\r\n    return {\r\n      data: state.data.map(p => {\r\n        if (p.systemId === productSystemId) {\r\n          const newCommitted = { ...p.committedByBranch };\r\n          newCommitted[branchSystemId] = (newCommitted[branchSystemId] || 0) + quantity;\r\n          return { ...p, committedByBranch: newCommitted };\r\n        }\r\n        return p;\r\n      }),\r\n    };\r\n  });\r\n};\r\n\r\nconst uncommitStock = (productSystemId: SystemId, branchSystemId: SystemId, quantity: number) => {\r\n  baseStore.setState(state => {\r\n    const product = state.data.find(p => p.systemId === productSystemId);\r\n    if (!canModifyStock(product)) {\r\n      console.warn(`[uncommitStock] Skipped: Product ${productSystemId} does not track stock`);\r\n      return state;\r\n    }\r\n    return {\r\n      data: state.data.map(p => {\r\n        if (p.systemId === productSystemId) {\r\n          const newCommitted = { ...p.committedByBranch };\r\n          newCommitted[branchSystemId] = Math.max(0, (newCommitted[branchSystemId] || 0) - quantity);\r\n          return { ...p, committedByBranch: newCommitted };\r\n        }\r\n        return p;\r\n      }),\r\n    };\r\n  });\r\n};\r\n\r\nconst dispatchStock = (productSystemId: SystemId, branchSystemId: SystemId, quantity: number) => {\r\n  console.log('🔴 [dispatchStock] Called with:', { productSystemId, branchSystemId, quantity });\r\n  \r\n  baseStore.setState(state => {\r\n    const product = state.data.find(p => p.systemId === productSystemId);\r\n    if (!product) {\r\n      console.error('❌ [dispatchStock] Product not found:', productSystemId);\r\n      return state;\r\n    }\r\n    \r\n    // Skip if product doesn't track stock\r\n    if (!canModifyStock(product)) {\r\n      console.warn(`[dispatchStock] Skipped: Product ${productSystemId} does not track stock`);\r\n      return state;\r\n    }\r\n    \r\n    console.log('📦 [dispatchStock] Current inventory:', product.inventoryByBranch);\r\n    console.log('📦 [dispatchStock] Current committed:', product.committedByBranch);\r\n    \r\n    return {\r\n      data: state.data.map(product => {\r\n        if (product.systemId === productSystemId) {\r\n          const newInventory = { ...product.inventoryByBranch };\r\n          const oldInventory = newInventory[branchSystemId] || 0;\r\n          newInventory[branchSystemId] = oldInventory - quantity;\r\n          \r\n          const newCommitted = { ...product.committedByBranch };\r\n          newCommitted[branchSystemId] = Math.max(0, (newCommitted[branchSystemId] || 0) - quantity);\r\n\r\n          const newInTransit = { ...product.inTransitByBranch };\r\n          newInTransit[branchSystemId] = (newInTransit[branchSystemId] || 0) + quantity;\r\n          \r\n          console.log('✅ [dispatchStock] Updated inventory:', {\r\n            old: oldInventory,\r\n            new: newInventory[branchSystemId],\r\n            change: -quantity\r\n          });\r\n          \r\n          return { \r\n            ...product, \r\n            inventoryByBranch: newInventory,\r\n            committedByBranch: newCommitted,\r\n            inTransitByBranch: newInTransit,\r\n          };\r\n        }\r\n        return product;\r\n      }),\r\n    };\r\n  });\r\n  \r\n  console.log('✅ [dispatchStock] Completed');\r\n};\r\n\r\nconst completeDelivery = (productSystemId: SystemId, branchSystemId: SystemId, quantity: number) => {\r\n  baseStore.setState(state => {\r\n    const product = state.data.find(p => p.systemId === productSystemId);\r\n    if (!canModifyStock(product)) {\r\n      return state;\r\n    }\r\n    return {\r\n      data: state.data.map(p => {\r\n        if (p.systemId === productSystemId) {\r\n          const newInTransit = { ...p.inTransitByBranch };\r\n          newInTransit[branchSystemId] = Math.max(0, (newInTransit[branchSystemId] || 0) - quantity);\r\n          return { ...p, inTransitByBranch: newInTransit };\r\n        }\r\n        return p;\r\n      }),\r\n    };\r\n  });\r\n};\r\n\r\nconst returnStockFromTransit = (productSystemId: SystemId, branchSystemId: SystemId, quantity: number) => {\r\n  baseStore.setState(state => {\r\n    const product = state.data.find(p => p.systemId === productSystemId);\r\n    if (!canModifyStock(product)) {\r\n      return state;\r\n    }\r\n    return {\r\n      data: state.data.map(p => {\r\n        if (p.systemId === productSystemId) {\r\n          const newInTransit = { ...p.inTransitByBranch };\r\n          newInTransit[branchSystemId] = Math.max(0, (newInTransit[branchSystemId] || 0) - quantity);\r\n          const newInventory = { ...p.inventoryByBranch };\r\n          newInventory[branchSystemId] = (newInventory[branchSystemId] || 0) + quantity;\r\n          return { ...p, inventoryByBranch: newInventory, inTransitByBranch: newInTransit };\r\n        }\r\n        return p;\r\n      }),\r\n    };\r\n  });\r\n};\r\n\r\nconst updateLastPurchasePrice = (productSystemId: SystemId, price: number, date: string) => {\r\n  baseStore.setState(state => ({\r\n    data: state.data.map(product => {\r\n      if (product.systemId === productSystemId) {\r\n        // Only update if the new date is newer or equal to the existing lastPurchaseDate\r\n        const existingDate = product.lastPurchaseDate ? new Date(product.lastPurchaseDate).getTime() : 0;\r\n        const newDateTs = new Date(date).getTime();\r\n        \r\n        if (newDateTs >= existingDate) {\r\n          return {\r\n            ...product,\r\n            lastPurchasePrice: price,\r\n            lastPurchaseDate: date,\r\n          };\r\n        }\r\n      }\r\n      return product;\r\n    }),\r\n  }));\r\n};\r\n\r\nconst searchProducts = async (query: string, page: number = 1, limit: number = 10): Promise<{ items: { value: SystemId; label: string }[], hasNextPage: boolean }> => {\r\n  const allProducts = baseStore.getState().data;\r\n  \r\n  // ✅ Create fresh Fuse instance with current data (avoid stale data)\r\n  const fuse = new Fuse(allProducts, {\r\n    keys: ['name', 'id', 'sku', 'barcode'],\r\n    threshold: 0.3,\r\n  });\r\n  \r\n  const results = fuse.search(query);\r\n  const startIndex = (page - 1) * limit;\r\n  const endIndex = startIndex + limit;\r\n  const paginatedResults = results.slice(startIndex, endIndex);\r\n\r\n  return {\r\n    items: paginatedResults.map(result => ({\r\n      value: asSystemId(result.item.systemId),\r\n      label: `${result.item.name} (${result.item.id})`,\r\n    })),\r\n    hasNextPage: endIndex < results.length,\r\n  };\r\n};\r\n\r\n// Wrapped add method with activity history logging\r\nconst addProduct = (product: Omit<Product, 'systemId'>) => {\r\n  const userInfo = getCurrentUserInfo();\r\n  const newProduct = baseStore.getState().add(product);\r\n  \r\n  // Add activity history entry\r\n  const historyEntry = createCreatedEntry(\r\n    userInfo,\r\n    `${userInfo.name} đã tạo sản phẩm ${newProduct.name} (${newProduct.id})`\r\n  );\r\n  baseStore.getState().update(newProduct.systemId, {\r\n    ...newProduct,\r\n    activityHistory: [historyEntry]\r\n  });\r\n  \r\n  return newProduct;\r\n};\r\n\r\n// Wrapped update method with activity history logging\r\nconst updateProduct = (systemId: SystemId, updatedProduct: Product) => {\r\n  const userInfo = getCurrentUserInfo();\r\n  const existingProduct = baseStore.getState().data.find(p => p.systemId === systemId);\r\n  const historyEntries: HistoryEntry[] = [];\r\n  \r\n  if (existingProduct) {\r\n    // Track status changes\r\n    if (existingProduct.status !== updatedProduct.status) {\r\n      const statusLabels: Record<string, string> = {\r\n        'active': 'Đang kinh doanh',\r\n        'inactive': 'Ngừng kinh doanh',\r\n        'discontinued': 'Ngừng sản xuất'\r\n      };\r\n      historyEntries.push(createStatusChangedEntry(\r\n        userInfo,\r\n        statusLabels[existingProduct.status || 'active'],\r\n        statusLabels[updatedProduct.status || 'active'],\r\n        `${userInfo.name} đã đổi trạng thái từ \"${statusLabels[existingProduct.status || 'active']}\" sang \"${statusLabels[updatedProduct.status || 'active']}\"`\r\n      ));\r\n    }\r\n    \r\n    // Track field changes\r\n    const fieldsToTrack: Array<{ key: keyof Product; label: string }> = [\r\n      { key: 'name', label: 'Tên sản phẩm' },\r\n      { key: 'id', label: 'Mã SKU' },\r\n      { key: 'description', label: 'Mô tả' },\r\n      { key: 'shortDescription', label: 'Mô tả ngắn' },\r\n      { key: 'type', label: 'Loại sản phẩm' },\r\n      { key: 'categorySystemId', label: 'Danh mục' },\r\n      { key: 'brandSystemId', label: 'Thương hiệu' },\r\n      { key: 'unit', label: 'Đơn vị tính' },\r\n      { key: 'costPrice', label: 'Giá vốn' },\r\n      { key: 'minPrice', label: 'Giá tối thiểu' },\r\n      { key: 'barcode', label: 'Mã vạch' },\r\n      { key: 'primarySupplierSystemId', label: 'Nhà cung cấp chính' },\r\n      { key: 'warrantyPeriodMonths', label: 'Thời hạn bảo hành' },\r\n      { key: 'reorderLevel', label: 'Mức đặt hàng lại' },\r\n      { key: 'safetyStock', label: 'Tồn kho an toàn' },\r\n      { key: 'maxStock', label: 'Tồn kho tối đa' },\r\n    ];\r\n    \r\n    const changes: string[] = [];\r\n    for (const field of fieldsToTrack) {\r\n      const oldVal = existingProduct[field.key];\r\n      const newVal = updatedProduct[field.key];\r\n      if (oldVal !== newVal && !(oldVal === undefined && newVal === undefined)) {\r\n        if (field.key === 'status') continue;\r\n        const oldDisplay = oldVal !== undefined && oldVal !== null && oldVal !== '' ? String(oldVal) : '(trống)';\r\n        const newDisplay = newVal !== undefined && newVal !== null && newVal !== '' ? String(newVal) : '(trống)';\r\n        changes.push(`${field.label}: ${oldDisplay} → ${newDisplay}`);\r\n      }\r\n    }\r\n    \r\n    // Track price changes separately\r\n    if (existingProduct.costPrice !== updatedProduct.costPrice) {\r\n      changes.push(`Giá vốn: ${existingProduct.costPrice?.toLocaleString('vi-VN')} → ${updatedProduct.costPrice?.toLocaleString('vi-VN')}`);\r\n    }\r\n    \r\n    if (changes.length > 0) {\r\n      historyEntries.push(createUpdatedEntry(\r\n        userInfo,\r\n        `${userInfo.name} đã cập nhật: ${changes.join(', ')}`\r\n      ));\r\n    }\r\n  }\r\n  \r\n  const productWithHistory = {\r\n    ...updatedProduct,\r\n    activityHistory: appendHistoryEntry(existingProduct?.activityHistory, ...historyEntries)\r\n  };\r\n  \r\n  baseStore.getState().update(systemId, productWithHistory);\r\n};\r\n\r\n// Export typed hook that includes both base and custom methods\r\nexport const useProductStore = (): ProductStoreState => {\r\n  const state = baseStore();\r\n  return {\r\n    ...state,\r\n    add: addProduct,\r\n    update: updateProduct,\r\n    updateInventory,\r\n    commitStock,\r\n    uncommitStock,\r\n    dispatchStock,\r\n    completeDelivery,\r\n    returnStockFromTransit,\r\n    updateLastPurchasePrice,\r\n    searchProducts,\r\n  };\r\n};\r\n\r\n// Export getState method for non-hook usage\r\nuseProductStore.getState = () => {\r\n  const state = baseStore.getState();\r\n  return {\r\n    ...state,\r\n    add: addProduct,\r\n    update: updateProduct,\r\n    updateInventory,\r\n    commitStock,\r\n    uncommitStock,\r\n    dispatchStock,\r\n    completeDelivery,\r\n    returnStockFromTransit,\r\n    updateLastPurchasePrice,\r\n    searchProducts,\r\n  };\r\n};\r\n\r\n(useProductStore as typeof useProductStore & { subscribe?: typeof baseStore.subscribe }).subscribe = baseStore.subscribe;\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 2610, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/stock-history/store.ts"],"sourcesContent":["import { create } from 'zustand';\r\nimport { formatDate, formatDateTime, formatDateTimeSeconds, formatDateCustom, parseDate, getCurrentDate } from '@/lib/date-utils';\r\nimport type { StockHistoryEntry } from './types';\r\nimport { asSystemId } from '../../lib/id-types';\r\nimport type { SystemId } from '../../lib/id-types';\r\n// REMOVED: import { data as initialData } from './data'; // Mock data no longer used - database is source of truth\r\n\r\n// API sync helpers\r\nasync function syncToAPI(action: 'create', data: any): Promise<boolean> {\r\n  try {\r\n    const response = await fetch('/api/inventory/stock-history', {\r\n      method: 'POST',\r\n      headers: { 'Content-Type': 'application/json' },\r\n      body: JSON.stringify(data),\r\n    });\r\n    \r\n    if (!response.ok) {\r\n      console.error(`[StockHistory API] ${action} failed:`, await response.text());\r\n      return false;\r\n    }\r\n    return true;\r\n  } catch (error) {\r\n    console.error(`[StockHistory API] ${action} error:`, error);\r\n    return false;\r\n  }\r\n}\r\n\r\n// ✨ Migration helper: Convert SKU to systemId for old data\r\nfunction migrateHistoryData(entries: StockHistoryEntry[]): StockHistoryEntry[] {\r\n  // Map SKU → systemId from products\r\n  const skuToSystemId: Record<string, string> = {\r\n    'DV-WEB-01': 'SP00000001',\r\n    'DV-WEB-02': 'SP00000002',\r\n    'DV-WEB-03': 'SP00000003',\r\n    'DV-MKT-01': 'SP00000004',\r\n    'DV-MKT-02': 'SP00000005',\r\n    'DV-MKT-03': 'SP00000006',\r\n    'DV-SEO-01': 'SP00000007',\r\n    'DV-SEO-02': 'SP00000008',\r\n    'DV-IT-01': 'SP00000009',\r\n    'DV-DSN-01': 'SP00000010',\r\n    'SW-CRM-01': 'SP00000011',\r\n    'SW-ERP-01': 'SP00000012',\r\n    'SW-WIN-01': 'SP00000013',\r\n    'SW-OFF-01': 'SP00000014',\r\n    'SW-ADOBE-01': 'SP00000015',\r\n    'HW-SRV-01': 'SP00000016',\r\n    'HW-SRV-02': 'SP00000017',\r\n    'HW-PC-01': 'SP00000018',\r\n    'HW-PC-02': 'SP00000019',\r\n    'HW-LT-01': 'SP00000020',\r\n    'HW-NET-01': 'SP00000021',\r\n    'HW-NET-02': 'SP00000022',\r\n    'HW-CAM-01': 'SP00000023',\r\n    'MISC-HOST-01': 'SP00000024',\r\n    'MISC-HOST-02': 'SP00000025',\r\n    'MISC-SSL-01': 'SP00000026',\r\n    'MISC-DOMAIN-COM': 'SP00000027',\r\n    'MISC-DOMAIN-VN': 'SP00000028',\r\n    'MISC-PRINT-01': 'SP00000029',\r\n    'MISC-PRINT-02': 'SP00000030',\r\n  };\r\n  \r\n  return entries.map(entry => ({\r\n    ...entry,\r\n    productId: asSystemId(skuToSystemId[entry.productId as any] || entry.productId) // Convert or keep if already systemId\r\n  }));\r\n}\r\n\r\ninterface StockHistoryState {\r\n  entries: StockHistoryEntry[];\r\n  initialized: boolean;\r\n  addEntry: (entry: Omit<StockHistoryEntry, 'systemId'>) => void;\r\n  getHistoryForProduct: (productId: SystemId, branchSystemId?: 'all' | SystemId) => StockHistoryEntry[];\r\n  loadFromAPI: () => Promise<void>;\r\n}\r\n\r\nlet entryCounter = 0;\r\n\r\nexport const useStockHistoryStore = create<StockHistoryState>()(\r\n  (set, get) => ({\r\n      entries: [], // Database is source of truth\r\n      initialized: false,\r\n      \r\n      addEntry: (entry) => {\r\n        entryCounter++;\r\n        const newEntry: StockHistoryEntry = {\r\n            ...entry,\r\n            systemId: asSystemId(`HISTORY${String(Date.now()).slice(-6)}_${entryCounter}`),\r\n        };\r\n        set((state) => ({ entries: [...state.entries, newEntry] }));\r\n        // Sync to API\r\n        syncToAPI('create', newEntry).catch(console.error);\r\n      },\r\n      \r\n      getHistoryForProduct: (productId, branchSystemId = 'all') => {\r\n          const productHistory = get().entries.filter(e => e.productId === productId);\r\n          const sortedHistory = productHistory.sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime());\r\n\r\n          if (branchSystemId === 'all') {\r\n            return sortedHistory;\r\n          }\r\n          return sortedHistory.filter(e => e.branchSystemId === branchSystemId);\r\n        },\r\n      \r\n      loadFromAPI: async () => {\r\n        try {\r\n          // NOTE: Use React Query hooks for paginated data. This only loads initial batch.\r\n          const response = await fetch('/api/inventory/stock-history?limit=30');\r\n          if (!response.ok) return;\r\n          const json = await response.json();\r\n          const apiData = json.data || [];\r\n          if (apiData.length > 0) {\r\n            set({ entries: migrateHistoryData(apiData), initialized: true });\r\n          } else {\r\n            set({ initialized: true });\r\n          }\r\n        } catch (error) {\r\n          console.error('[StockHistory API] loadFromAPI error:', error);\r\n        }\r\n      },\r\n    })\r\n);\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 2735, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/cashbook/api/cashbook-api.ts"],"sourcesContent":["/**\r\n * Cashbook API Layer\r\n * Handles all cash account-related API calls\r\n * Note: Cashbook relates to cash-accounts API\r\n */\r\n\r\nimport type { CashAccount } from '../types';\r\n\r\nexport interface CashAccountFilters {\r\n  page?: number;\r\n  limit?: number;\r\n  type?: 'cash' | 'bank';\r\n  isActive?: boolean;\r\n  branchSystemId?: string;\r\n  search?: string;\r\n}\r\n\r\nexport interface CashAccountResponse {\r\n  data: CashAccount[];\r\n  pagination: {\r\n    page: number;\r\n    limit: number;\r\n    total: number;\r\n    totalPages: number;\r\n  };\r\n}\r\n\r\nexport interface CashAccountCreateInput {\r\n  systemId?: string;\r\n  id?: string;\r\n  name: string;\r\n  type: 'cash' | 'bank';\r\n  initialBalance?: number;\r\n  bankAccountNumber?: string;\r\n  bankBranch?: string;\r\n  branchSystemId?: string;\r\n  isActive?: boolean;\r\n  isDefault?: boolean;\r\n  bankName?: string;\r\n  bankCode?: string;\r\n  accountHolder?: string;\r\n  minBalance?: number;\r\n  maxBalance?: number;\r\n  managedBy?: string;\r\n}\r\n\r\nexport interface CashAccountUpdateInput extends Partial<CashAccountCreateInput> {}\r\n\r\nconst BASE_URL = '/api/cash-accounts';\r\n\r\n/**\r\n * Fetch cash accounts with filters\r\n */\r\nexport async function fetchCashAccounts(\r\n  filters: CashAccountFilters = {}\r\n): Promise<CashAccountResponse> {\r\n  const params = new URLSearchParams();\r\n  \r\n  if (filters.page) params.set('page', String(filters.page));\r\n  if (filters.limit) params.set('limit', String(filters.limit));\r\n  if (filters.type) params.set('type', filters.type);\r\n  if (filters.isActive !== undefined) params.set('isActive', String(filters.isActive));\r\n  if (filters.branchSystemId) params.set('branchSystemId', filters.branchSystemId);\r\n  if (filters.search) params.set('search', filters.search);\r\n\r\n  const url = params.toString() ? `${BASE_URL}?${params}` : BASE_URL;\r\n  const response = await fetch(url);\r\n  \r\n  if (!response.ok) {\r\n    throw new Error('Failed to fetch cash accounts');\r\n  }\r\n  \r\n  return response.json();\r\n}\r\n\r\n/**\r\n * Fetch single cash account by ID\r\n */\r\nexport async function fetchCashAccountById(\r\n  systemId: string\r\n): Promise<CashAccount> {\r\n  const response = await fetch(`${BASE_URL}/${systemId}`);\r\n  \r\n  if (!response.ok) {\r\n    throw new Error('Failed to fetch cash account');\r\n  }\r\n  \r\n  return response.json();\r\n}\r\n\r\n/**\r\n * Create new cash account\r\n */\r\nexport async function createCashAccount(\r\n  data: CashAccountCreateInput\r\n): Promise<CashAccount> {\r\n  const response = await fetch(BASE_URL, {\r\n    method: 'POST',\r\n    headers: { 'Content-Type': 'application/json' },\r\n    body: JSON.stringify(data),\r\n  });\r\n  \r\n  if (!response.ok) {\r\n    const error = await response.json().catch(() => ({}));\r\n    throw new Error(error.error || 'Failed to create cash account');\r\n  }\r\n  \r\n  return response.json();\r\n}\r\n\r\n/**\r\n * Update cash account\r\n */\r\nexport async function updateCashAccount(\r\n  systemId: string,\r\n  data: CashAccountUpdateInput\r\n): Promise<CashAccount> {\r\n  const response = await fetch(`${BASE_URL}/${systemId}`, {\r\n    method: 'PATCH',\r\n    headers: { 'Content-Type': 'application/json' },\r\n    body: JSON.stringify(data),\r\n  });\r\n  \r\n  if (!response.ok) {\r\n    const error = await response.json().catch(() => ({}));\r\n    throw new Error(error.error || 'Failed to update cash account');\r\n  }\r\n  \r\n  return response.json();\r\n}\r\n\r\n/**\r\n * Delete cash account\r\n */\r\nexport async function deleteCashAccount(systemId: string): Promise<void> {\r\n  const response = await fetch(`${BASE_URL}/${systemId}`, {\r\n    method: 'DELETE',\r\n  });\r\n  \r\n  if (!response.ok) {\r\n    throw new Error('Failed to delete cash account');\r\n  }\r\n}\r\n\r\n/**\r\n * Set default cash account\r\n */\r\nexport async function setDefaultCashAccount(\r\n  systemId: string\r\n): Promise<CashAccount> {\r\n  const response = await fetch(`${BASE_URL}/${systemId}/set-default`, {\r\n    method: 'POST',\r\n    headers: { 'Content-Type': 'application/json' },\r\n  });\r\n  \r\n  if (!response.ok) {\r\n    throw new Error('Failed to set default cash account');\r\n  }\r\n  \r\n  return response.json();\r\n}\r\n\r\n/**\r\n * Get account balance\r\n */\r\nexport async function fetchAccountBalance(\r\n  systemId: string\r\n): Promise<{\r\n  systemId: string;\r\n  currentBalance: number;\r\n  lastUpdated: string;\r\n}> {\r\n  const response = await fetch(`${BASE_URL}/${systemId}/balance`);\r\n  \r\n  if (!response.ok) {\r\n    throw new Error('Failed to fetch account balance');\r\n  }\r\n  \r\n  return response.json();\r\n}\r\n\r\n/**\r\n * Get all active cash accounts (for dropdown/selection)\r\n */\r\nexport async function fetchActiveCashAccounts(): Promise<CashAccount[]> {\r\n  const response = await fetchCashAccounts({ \r\n    isActive: true, \r\n    limit: 100 \r\n  });\r\n  return response.data;\r\n}\r\n"],"names":[],"mappings":"AAAA;;;;CAIC;;;;;;;;;;;;;;;;;;AA4CD,MAAM,WAAW;AAKV,eAAe,kBACpB,UAA8B,CAAC,CAAC;IAEhC,MAAM,SAAS,IAAI;IAEnB,IAAI,QAAQ,IAAI,EAAE,OAAO,GAAG,CAAC,QAAQ,OAAO,QAAQ,IAAI;IACxD,IAAI,QAAQ,KAAK,EAAE,OAAO,GAAG,CAAC,SAAS,OAAO,QAAQ,KAAK;IAC3D,IAAI,QAAQ,IAAI,EAAE,OAAO,GAAG,CAAC,QAAQ,QAAQ,IAAI;IACjD,IAAI,QAAQ,QAAQ,KAAK,WAAW,OAAO,GAAG,CAAC,YAAY,OAAO,QAAQ,QAAQ;IAClF,IAAI,QAAQ,cAAc,EAAE,OAAO,GAAG,CAAC,kBAAkB,QAAQ,cAAc;IAC/E,IAAI,QAAQ,MAAM,EAAE,OAAO,GAAG,CAAC,UAAU,QAAQ,MAAM;IAEvD,MAAM,MAAM,OAAO,QAAQ,KAAK,GAAG,SAAS,CAAC,EAAE,QAAQ,GAAG;IAC1D,MAAM,WAAW,MAAM,MAAM;IAE7B,IAAI,CAAC,SAAS,EAAE,EAAE;QAChB,MAAM,IAAI,MAAM;IAClB;IAEA,OAAO,SAAS,IAAI;AACtB;AAKO,eAAe,qBACpB,QAAgB;IAEhB,MAAM,WAAW,MAAM,MAAM,GAAG,SAAS,CAAC,EAAE,UAAU;IAEtD,IAAI,CAAC,SAAS,EAAE,EAAE;QAChB,MAAM,IAAI,MAAM;IAClB;IAEA,OAAO,SAAS,IAAI;AACtB;AAKO,eAAe,kBACpB,IAA4B;IAE5B,MAAM,WAAW,MAAM,MAAM,UAAU;QACrC,QAAQ;QACR,SAAS;YAAE,gBAAgB;QAAmB;QAC9C,MAAM,KAAK,SAAS,CAAC;IACvB;IAEA,IAAI,CAAC,SAAS,EAAE,EAAE;QAChB,MAAM,QAAQ,MAAM,SAAS,IAAI,GAAG,KAAK,CAAC,IAAM,CAAC,CAAC,CAAC;QACnD,MAAM,IAAI,MAAM,MAAM,KAAK,IAAI;IACjC;IAEA,OAAO,SAAS,IAAI;AACtB;AAKO,eAAe,kBACpB,QAAgB,EAChB,IAA4B;IAE5B,MAAM,WAAW,MAAM,MAAM,GAAG,SAAS,CAAC,EAAE,UAAU,EAAE;QACtD,QAAQ;QACR,SAAS;YAAE,gBAAgB;QAAmB;QAC9C,MAAM,KAAK,SAAS,CAAC;IACvB;IAEA,IAAI,CAAC,SAAS,EAAE,EAAE;QAChB,MAAM,QAAQ,MAAM,SAAS,IAAI,GAAG,KAAK,CAAC,IAAM,CAAC,CAAC,CAAC;QACnD,MAAM,IAAI,MAAM,MAAM,KAAK,IAAI;IACjC;IAEA,OAAO,SAAS,IAAI;AACtB;AAKO,eAAe,kBAAkB,QAAgB;IACtD,MAAM,WAAW,MAAM,MAAM,GAAG,SAAS,CAAC,EAAE,UAAU,EAAE;QACtD,QAAQ;IACV;IAEA,IAAI,CAAC,SAAS,EAAE,EAAE;QAChB,MAAM,IAAI,MAAM;IAClB;AACF;AAKO,eAAe,sBACpB,QAAgB;IAEhB,MAAM,WAAW,MAAM,MAAM,GAAG,SAAS,CAAC,EAAE,SAAS,YAAY,CAAC,EAAE;QAClE,QAAQ;QACR,SAAS;YAAE,gBAAgB;QAAmB;IAChD;IAEA,IAAI,CAAC,SAAS,EAAE,EAAE;QAChB,MAAM,IAAI,MAAM;IAClB;IAEA,OAAO,SAAS,IAAI;AACtB;AAKO,eAAe,oBACpB,QAAgB;IAMhB,MAAM,WAAW,MAAM,MAAM,GAAG,SAAS,CAAC,EAAE,SAAS,QAAQ,CAAC;IAE9D,IAAI,CAAC,SAAS,EAAE,EAAE;QAChB,MAAM,IAAI,MAAM;IAClB;IAEA,OAAO,SAAS,IAAI;AACtB;AAKO,eAAe;IACpB,MAAM,WAAW,MAAM,kBAAkB;QACvC,UAAU;QACV,OAAO;IACT;IACA,OAAO,SAAS,IAAI;AACtB"}},
    {"offset": {"line": 2849, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/cashbook/hooks/use-cashbook.ts"],"sourcesContent":["/**\r\n * Cashbook React Query Hooks\r\n * Provides data fetching and mutations for cash accounts\r\n */\r\n\r\nimport { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';\r\nimport {\r\n  fetchCashAccounts,\r\n  fetchCashAccountById,\r\n  createCashAccount,\r\n  updateCashAccount,\r\n  deleteCashAccount,\r\n  setDefaultCashAccount,\r\n  fetchAccountBalance,\r\n  fetchActiveCashAccounts,\r\n  type CashAccountFilters,\r\n  type CashAccountCreateInput,\r\n  type CashAccountUpdateInput,\r\n} from '../api/cashbook-api';\r\n\r\n// Query keys factory\r\nexport const cashbookKeys = {\r\n  all: ['cashbook'] as const,\r\n  lists: () => [...cashbookKeys.all, 'list'] as const,\r\n  list: (filters: CashAccountFilters) => [...cashbookKeys.lists(), filters] as const,\r\n  active: () => [...cashbookKeys.all, 'active'] as const,\r\n  details: () => [...cashbookKeys.all, 'detail'] as const,\r\n  detail: (id: string) => [...cashbookKeys.details(), id] as const,\r\n  balance: (id: string) => [...cashbookKeys.all, 'balance', id] as const,\r\n};\r\n\r\n/**\r\n * Hook to fetch cash accounts with filters\r\n */\r\nexport function useCashAccounts(filters: CashAccountFilters = {}) {\r\n  return useQuery({\r\n    queryKey: cashbookKeys.list(filters),\r\n    queryFn: () => fetchCashAccounts(filters),\r\n    staleTime: 1000 * 60 * 5, // 5 minutes - accounts don't change often\r\n  });\r\n}\r\n\r\n/**\r\n * Hook to fetch active cash accounts (for dropdowns)\r\n */\r\nexport function useActiveCashAccounts() {\r\n  return useQuery({\r\n    queryKey: cashbookKeys.active(),\r\n    queryFn: fetchActiveCashAccounts,\r\n    staleTime: 1000 * 60 * 10, // 10 minutes\r\n  });\r\n}\r\n\r\n/**\r\n * Hook to fetch single cash account\r\n */\r\nexport function useCashAccountById(systemId: string | undefined) {\r\n  return useQuery({\r\n    queryKey: cashbookKeys.detail(systemId!),\r\n    queryFn: () => fetchCashAccountById(systemId!),\r\n    enabled: !!systemId,\r\n    staleTime: 1000 * 60 * 5,\r\n  });\r\n}\r\n\r\n/**\r\n * Hook to fetch account balance\r\n */\r\nexport function useCashAccountBalance(systemId: string | undefined) {\r\n  return useQuery({\r\n    queryKey: cashbookKeys.balance(systemId!),\r\n    queryFn: () => fetchAccountBalance(systemId!),\r\n    enabled: !!systemId,\r\n    staleTime: 1000 * 30, // 30 seconds - balance changes frequently\r\n  });\r\n}\r\n\r\ninterface MutationCallbacks {\r\n  onSuccess?: () => void;\r\n  onError?: (error: Error) => void;\r\n}\r\n\r\n/**\r\n * Hook providing cash account mutations\r\n */\r\nexport function useCashAccountMutations(options: MutationCallbacks = {}) {\r\n  const queryClient = useQueryClient();\r\n\r\n  const invalidateCashbook = () => {\r\n    queryClient.invalidateQueries({ queryKey: cashbookKeys.all });\r\n  };\r\n\r\n  const create = useMutation({\r\n    mutationFn: (data: CashAccountCreateInput) => createCashAccount(data),\r\n    onSuccess: () => {\r\n      invalidateCashbook();\r\n      options.onSuccess?.();\r\n    },\r\n    onError: options.onError,\r\n  });\r\n\r\n  const update = useMutation({\r\n    mutationFn: ({ systemId, data }: { systemId: string; data: CashAccountUpdateInput }) =>\r\n      updateCashAccount(systemId, data),\r\n    onSuccess: () => {\r\n      invalidateCashbook();\r\n      options.onSuccess?.();\r\n    },\r\n    onError: options.onError,\r\n  });\r\n\r\n  const remove = useMutation({\r\n    mutationFn: (systemId: string) => deleteCashAccount(systemId),\r\n    onSuccess: () => {\r\n      invalidateCashbook();\r\n      options.onSuccess?.();\r\n    },\r\n    onError: options.onError,\r\n  });\r\n\r\n  const setDefault = useMutation({\r\n    mutationFn: (systemId: string) => setDefaultCashAccount(systemId),\r\n    onSuccess: () => {\r\n      invalidateCashbook();\r\n      options.onSuccess?.();\r\n    },\r\n    onError: options.onError,\r\n  });\r\n\r\n  return {\r\n    create,\r\n    update,\r\n    remove,\r\n    setDefault,\r\n    isLoading:\r\n      create.isPending ||\r\n      update.isPending ||\r\n      remove.isPending ||\r\n      setDefault.isPending,\r\n  };\r\n}\r\n\r\n/**\r\n * Hook to get cash accounts by type\r\n */\r\nexport function useCashAccountsByType(type: 'cash' | 'bank') {\r\n  return useCashAccounts({ type, isActive: true });\r\n}\r\n\r\n// Alias for backward compatibility\r\nexport { useActiveCashAccounts as useCashbookAccounts };\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 3060, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/cashbook/store.ts"],"sourcesContent":["import { create } from 'zustand';\r\n// REMOVED: import { data as initialData } from './data'; // Mock data no longer used - database is source of truth\r\nimport type { CashAccount } from './types';\r\nimport { findNextAvailableBusinessId, generateSystemId, getMaxBusinessIdCounter, getMaxSystemIdCounter, type EntityType } from '../../lib/id-utils';\r\nimport { asBusinessId, asSystemId, type BusinessId, type SystemId } from '../../lib/id-types';\r\n\r\nconst CASH_ACCOUNT_ENTITY: EntityType = 'cash-accounts';\r\nconst SYSTEM_ID_PREFIX = 'ACCOUNT';\r\nconst BUSINESS_ID_PREFIX = 'TK';\r\nconst BUSINESS_ID_DIGITS = 6;\r\n\r\n// API sync helpers\r\nasync function syncToAPI(action: 'create' | 'update' | 'delete', data: any): Promise<boolean> {\r\n  try {\r\n    const endpoint = action === 'create' ? '/api/cash-accounts' : `/api/cash-accounts/${data.systemId}`;\r\n    const method = action === 'create' ? 'POST' : action === 'update' ? 'PATCH' : 'DELETE';\r\n    \r\n    const response = await fetch(endpoint, {\r\n      method,\r\n      headers: { 'Content-Type': 'application/json' },\r\n      body: action !== 'delete' ? JSON.stringify(data) : undefined,\r\n    });\r\n    \r\n    if (!response.ok) {\r\n      console.error(`[Cashbook API] ${action} failed:`, await response.text());\r\n      return false;\r\n    }\r\n    return true;\r\n  } catch (error) {\r\n    console.error(`[Cashbook API] ${action} error:`, error);\r\n    return false;\r\n  }\r\n}\r\n\r\nasync function fetchFromAPI(): Promise<CashAccount[]> {\r\n  try {\r\n    const response = await fetch('/api/cash-accounts?limit=50');\r\n    if (!response.ok) return [];\r\n    const json = await response.json();\r\n    return json.data || [];\r\n  } catch (error) {\r\n    console.error('[Cashbook API] fetch error:', error);\r\n    return [];\r\n  }\r\n}\r\n\r\ninterface CashbookState {\r\n  accounts: CashAccount[];\r\n  initialized: boolean;\r\n  getAccountById: (id: BusinessId) => CashAccount | undefined;\r\n  add: (item: Omit<CashAccount, 'systemId'>) => void;\r\n  update: (systemId: SystemId, item: CashAccount) => void;\r\n  remove: (systemId: SystemId) => void;\r\n  setDefault: (systemId: SystemId) => void;\r\n  loadFromAPI: () => Promise<void>;\r\n}\r\n\r\nconst getNextSystemId = (accounts: CashAccount[]): SystemId => {\r\n  const currentCounter = getMaxSystemIdCounter(accounts, SYSTEM_ID_PREFIX);\r\n  return asSystemId(generateSystemId(CASH_ACCOUNT_ENTITY, currentCounter + 1));\r\n};\r\n\r\nconst ensureBusinessId = (accounts: CashAccount[], provided?: BusinessId): BusinessId => {\r\n  if (provided && provided.trim()) {\r\n    return provided;\r\n  }\r\n\r\n  const existingIds = accounts.map(acc => acc.id as string);\r\n  const startCounter = getMaxBusinessIdCounter(accounts, BUSINESS_ID_PREFIX);\r\n  const { nextId } = findNextAvailableBusinessId(BUSINESS_ID_PREFIX, existingIds, startCounter, BUSINESS_ID_DIGITS);\r\n  return asBusinessId(nextId);\r\n};\r\n\r\nexport const useCashbookStore = create<CashbookState>()(\r\n  (set, get) => ({\r\n      accounts: [],\r\n      initialized: false,\r\n      getAccountById: (id) => get().accounts.find(a => a.id === id),\r\n      \r\n      add: (item) => {\r\n        const newAccount: CashAccount = {\r\n          ...item,\r\n          systemId: getNextSystemId(get().accounts),\r\n          id: ensureBusinessId(get().accounts, item.id),\r\n        };\r\n        set((state) => ({ accounts: [...state.accounts, newAccount] }));\r\n        // Sync to API\r\n        syncToAPI('create', newAccount).catch(console.error);\r\n      },\r\n      \r\n      update: (systemId, updatedItem) => {\r\n        set((state) => ({\r\n          accounts: state.accounts.map((acc) => (acc.systemId === systemId ? updatedItem : acc))\r\n        }));\r\n        // Sync to API\r\n        syncToAPI('update', updatedItem).catch(console.error);\r\n      },\r\n      \r\n      remove: (systemId) => {\r\n        set((state) => ({\r\n          accounts: state.accounts.filter(acc => acc.systemId !== systemId)\r\n        }));\r\n        // Sync to API\r\n        syncToAPI('delete', { systemId }).catch(console.error);\r\n      },\r\n      \r\n      setDefault: (systemId) => {\r\n        set((state) => {\r\n          const targetAccount = state.accounts.find(acc => acc.systemId === systemId);\r\n          if (!targetAccount) return state;\r\n\r\n          const updated = state.accounts.map(acc => ({\r\n            ...acc,\r\n            isDefault: (acc.type === targetAccount.type ? acc.systemId === systemId : acc.isDefault) ?? false\r\n          }));\r\n          \r\n          // Sync updated accounts to API\r\n          updated.forEach(acc => {\r\n            if (acc.type === targetAccount.type) {\r\n              syncToAPI('update', acc).catch(console.error);\r\n            }\r\n          });\r\n          \r\n          return { accounts: updated };\r\n        });\r\n      },\r\n      \r\n      loadFromAPI: async () => {\r\n        const apiData = await fetchFromAPI();\r\n        if (apiData.length > 0) {\r\n          set({ accounts: apiData, initialized: true });\r\n        } else {\r\n          set({ initialized: true });\r\n        }\r\n      },\r\n    })\r\n);\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 3195, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/finance/document-lookups.ts"],"sourcesContent":["import { useTargetGroupStore } from '@/features/settings/target-groups/store';\r\nimport { usePaymentMethodStore } from '@/features/settings/payments/methods/store';\r\nimport { useCashbookStore } from '@/features/cashbook/store';\r\nimport { useReceiptTypeStore } from '@/features/settings/receipt-types/store';\r\nimport { usePaymentTypeStore } from '@/features/settings/payments/types/store';\r\nimport type { TargetGroup } from '@/features/settings/target-groups/types';\r\nimport type { PaymentMethod } from '@/features/settings/payments/methods/types';\r\nimport type { CashAccount } from '@/features/cashbook/types';\r\nimport type { ReceiptType } from '@/features/settings/receipt-types/types';\r\nimport type { PaymentType } from '@/features/settings/payments/types/types';\r\nimport type { SystemId } from '@/lib/id-types';\r\n\r\nconst normalizeName = (value?: string | null) => (value ?? '').trim().toLowerCase();\r\n\r\nexport const DEFAULT_CUSTOMER_GROUP = 'khách hàng';\r\n\r\nexport const pickTargetGroup = (options?: {\r\n  systemId?: SystemId | undefined;\r\n  name?: string | undefined;\r\n  fallbackName?: string | undefined;\r\n}): TargetGroup | null => {\r\n  const groups = useTargetGroupStore.getState().data ?? [];\r\n  if (groups.length === 0) {\r\n    return null;\r\n  }\r\n\r\n  if (options?.systemId) {\r\n    const match = groups.find(group => group.systemId === options.systemId);\r\n    if (match) {\r\n      return match;\r\n    }\r\n  }\r\n\r\n  const lookupNames = [options?.name, options?.fallbackName, DEFAULT_CUSTOMER_GROUP].filter(Boolean) as string[];\r\n  for (const candidate of lookupNames) {\r\n    const normalized = normalizeName(candidate);\r\n    const match = groups.find(group => normalizeName(group.name) === normalized);\r\n    if (match) {\r\n      return match;\r\n    }\r\n  }\r\n\r\n  return groups[0] ?? null;\r\n};\r\n\r\nexport const pickPaymentMethod = (options?: {\r\n  systemId?: SystemId | undefined;\r\n  name?: string | undefined;\r\n}): PaymentMethod | null => {\r\n  const methods = usePaymentMethodStore.getState().data ?? [];\r\n  if (methods.length === 0) {\r\n    return null;\r\n  }\r\n\r\n  if (options?.systemId) {\r\n    const match = methods.find(method => method.systemId === options.systemId);\r\n    if (match) {\r\n      return match;\r\n    }\r\n  }\r\n\r\n  if (options?.name) {\r\n    const normalized = normalizeName(options.name);\r\n    const match = methods.find(method => normalizeName(method.name) === normalized);\r\n    if (match) {\r\n      return match;\r\n    }\r\n  }\r\n\r\n  return methods.find(method => method.isDefault) ?? methods[0] ?? null;\r\n};\r\n\r\nexport const pickAccount = (options: {\r\n  accountSystemId?: SystemId | undefined;\r\n  preferredType?: 'cash' | 'bank' | undefined;\r\n  branchSystemId?: SystemId | undefined;\r\n  paymentMethodName?: string | undefined;\r\n}): CashAccount | null => {\r\n  const { accounts } = useCashbookStore.getState();\r\n  if (!accounts || accounts.length === 0) {\r\n    return null;\r\n  }\r\n\r\n  if (options.accountSystemId) {\r\n    const match = accounts.find(account => account.systemId === options.accountSystemId);\r\n    if (match) {\r\n      return match;\r\n    }\r\n  }\r\n\r\n  let preferredType = options.preferredType;\r\n  if (!preferredType && options.paymentMethodName) {\r\n    const normalizedMethod = normalizeName(options.paymentMethodName);\r\n    preferredType = normalizedMethod === 'tiền mặt' ? 'cash' : normalizedMethod === 'chuyển khoản' ? 'bank' : undefined;\r\n  }\r\n\r\n  const candidates = preferredType ? accounts.filter(account => account.type === preferredType) : accounts;\r\n\r\n  if (candidates.length === 0) {\r\n    return accounts[0];\r\n  }\r\n\r\n  return (\r\n    candidates.find(account => account.branchSystemId && options.branchSystemId && account.branchSystemId === options.branchSystemId) ??\r\n    candidates.find(account => account.isDefault) ??\r\n    candidates[0]\r\n  );\r\n};\r\n\r\nexport const pickReceiptType = (options?: {\r\n  systemId?: SystemId | undefined;\r\n  name?: string | undefined;\r\n}): ReceiptType | null => {\r\n  const types = useReceiptTypeStore.getState().data ?? [];\r\n  if (types.length === 0) {\r\n    return null;\r\n  }\r\n\r\n  if (options?.systemId) {\r\n    const match = types.find(type => type.systemId === options.systemId);\r\n    if (match) {\r\n      return match;\r\n    }\r\n  }\r\n\r\n  if (options?.name) {\r\n    const normalized = normalizeName(options.name);\r\n    const match = types.find(type => normalizeName(type.name) === normalized);\r\n    if (match) {\r\n      return match;\r\n    }\r\n  }\r\n\r\n  return types[0] ?? null;\r\n};\r\n\r\nexport const pickPaymentType = (options?: {\r\n  systemId?: SystemId | undefined;\r\n  name?: string | undefined;\r\n}): PaymentType | null => {\r\n  const types = usePaymentTypeStore.getState().data ?? [];\r\n  if (types.length === 0) {\r\n    return null;\r\n  }\r\n\r\n  if (options?.systemId) {\r\n    const match = types.find(type => type.systemId === options.systemId);\r\n    if (match) {\r\n      return match;\r\n    }\r\n  }\r\n\r\n  if (options?.name) {\r\n    const normalized = normalizeName(options.name);\r\n    const match = types.find(type => normalizeName(type.name) === normalized);\r\n    if (match) {\r\n      return match;\r\n    }\r\n  }\r\n\r\n  return types[0] ?? null;\r\n};\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 3335, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/employees/store.ts"],"sourcesContent":["import { createCrudStore, CrudState } from '../../lib/store-factory';\r\n// REMOVED: import { data as initialData } from './data'; // Mock data no longer used - database is source of truth\r\nimport type { Employee } from './types';\r\nimport type { HistoryEntry } from '../../components/ActivityHistory';\r\nimport Fuse from 'fuse.js';\r\nimport { getCurrentUserSystemId } from '../../contexts/auth-context';\r\nimport { registerBreadcrumbStore } from '../../lib/breadcrumb-generator'; // ✅ NEW\r\nimport { type SystemId } from '../../lib/id-types';\r\nimport { createInMemoryRepository } from '../../repositories/in-memory-repository';\r\nimport { \r\n  createHistoryEntry, \r\n  getCurrentUserInfo,\r\n  appendHistoryEntry \r\n} from '../../lib/activity-history-helper';\r\n\r\ntype EmployeePersistenceAdapter = {\r\n  create: (payload: Omit<Employee, 'systemId'>) => Promise<Employee>;\r\n  update: (systemId: SystemId, payload: Partial<Employee>) => Promise<Employee>;\r\n  softDelete: (systemId: SystemId) => Promise<void>;\r\n  restore: (systemId: SystemId) => Promise<Employee | undefined>;\r\n  hardDelete: (systemId: SystemId) => Promise<void>;\r\n};\r\n\r\nconst baseStore = createCrudStore<Employee>([], 'employees', {\r\n  businessIdField: 'id',\r\n  getCurrentUser: getCurrentUserSystemId, // ✅ Track who creates/updates\r\n  apiEndpoint: '/api/employees',\r\n});\r\n\r\n// ✅ Wrap add method to include activity history\r\nconst originalAdd = baseStore.getState().add;\r\nconst wrappedAdd = (item: Omit<Employee, 'systemId'>): Employee => {\r\n  const userInfo = getCurrentUserInfo();\r\n  const historyEntry = createHistoryEntry(\r\n    'created',\r\n    `${userInfo.name} đã tạo hồ sơ nhân viên ${item.fullName} (${item.id})`,\r\n    userInfo\r\n  );\r\n  \r\n  const newEmployee = originalAdd({\r\n    ...item,\r\n    activityHistory: [historyEntry],\r\n  });\r\n  \r\n  return newEmployee;\r\n};\r\n\r\n// ✅ Wrap update method to include activity history\r\nconst originalUpdate = baseStore.getState().update;\r\nconst wrappedUpdate = (systemId: SystemId, updates: Partial<Employee>): void => {\r\n  const currentEmployee = baseStore.getState().data.find(e => e.systemId === systemId);\r\n  if (!currentEmployee) return;\r\n  \r\n  const userInfo = getCurrentUserInfo();\r\n  const historyEntries: HistoryEntry[] = [];\r\n  \r\n  // Track important field changes\r\n  const trackedFields: { key: keyof Employee; label: string }[] = [\r\n    { key: 'fullName', label: 'họ tên' },\r\n    { key: 'jobTitle', label: 'chức danh' },\r\n    { key: 'department', label: 'phòng ban' },\r\n    { key: 'employmentStatus', label: 'trạng thái làm việc' },\r\n    { key: 'employeeType', label: 'loại nhân viên' },\r\n    { key: 'baseSalary', label: 'lương cơ bản' },\r\n    { key: 'phone', label: 'số điện thoại' },\r\n    { key: 'workEmail', label: 'email công việc' },\r\n    { key: 'role', label: 'vai trò' },\r\n  ];\r\n  \r\n  trackedFields.forEach(({ key, label }) => {\r\n    if (updates[key] !== undefined && updates[key] !== currentEmployee[key]) {\r\n      const oldValue = currentEmployee[key];\r\n      const newValue = updates[key];\r\n      \r\n      // Format values for display\r\n      let oldDisplay = oldValue;\r\n      let newDisplay = newValue;\r\n      \r\n      if (key === 'baseSalary') {\r\n        oldDisplay = new Intl.NumberFormat('vi-VN').format(oldValue as number) + 'đ';\r\n        newDisplay = new Intl.NumberFormat('vi-VN').format(newValue as number) + 'đ';\r\n      }\r\n      \r\n      historyEntries.push(createHistoryEntry(\r\n        'updated',\r\n        `${userInfo.name} đã cập nhật ${label}: \"${oldDisplay || '(trống)'}\" → \"${newDisplay}\"`,\r\n        userInfo,\r\n        { field: key, oldValue, newValue }\r\n      ));\r\n    }\r\n  });\r\n  \r\n  // If status changed specifically\r\n  if (updates.employmentStatus && updates.employmentStatus !== currentEmployee.employmentStatus) {\r\n    historyEntries.push(createHistoryEntry(\r\n      'status_changed',\r\n      `${userInfo.name} đã thay đổi trạng thái làm việc từ \"${currentEmployee.employmentStatus}\" thành \"${updates.employmentStatus}\"`,\r\n      userInfo,\r\n      { field: 'employmentStatus', oldValue: currentEmployee.employmentStatus, newValue: updates.employmentStatus }\r\n    ));\r\n  }\r\n  \r\n  // If no specific changes tracked, add generic update entry\r\n  if (historyEntries.length === 0) {\r\n    historyEntries.push(createHistoryEntry(\r\n      'updated',\r\n      `${userInfo.name} đã cập nhật thông tin nhân viên`,\r\n      userInfo\r\n    ));\r\n  }\r\n  \r\n  const updatedHistory = appendHistoryEntry(currentEmployee.activityHistory, ...historyEntries);\r\n  \r\n  originalUpdate(systemId, {\r\n    ...updates,\r\n    activityHistory: updatedHistory,\r\n  });\r\n};\r\n\r\n// ✅ Override base store methods\r\nbaseStore.setState({\r\n  add: wrappedAdd,\r\n  update: wrappedUpdate,\r\n});\r\n\r\nexport const employeeRepository = createInMemoryRepository<Employee>(() => baseStore.getState());\r\n\r\n// ✅ API-backed persistence adapter - syncs to PostgreSQL\r\nconst API_ENDPOINT = '/api/employees';\r\n\r\nconst persistence: EmployeePersistenceAdapter = {\r\n  create: async (payload) => {\r\n    // First create locally for immediate UI update\r\n    const localResult = await employeeRepository.create(payload);\r\n    \r\n    // Then sync to API (background)\r\n    try {\r\n      const response = await fetch(API_ENDPOINT, {\r\n        method: 'POST',\r\n        credentials: 'include',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({ ...payload, systemId: localResult.systemId }),\r\n      });\r\n      if (!response.ok) {\r\n        console.warn('[Employee API] Create sync failed, data saved locally');\r\n      } else {\r\n        console.log('[Employee API] Created:', localResult.systemId);\r\n      }\r\n    } catch (e) {\r\n      console.warn('[Employee API] Create sync error:', e);\r\n    }\r\n    \r\n    return localResult;\r\n  },\r\n  update: async (systemId, payload) => {\r\n    // First update locally\r\n    const localResult = await employeeRepository.update(systemId, payload);\r\n    \r\n    // Then sync to API\r\n    try {\r\n      const response = await fetch(`${API_ENDPOINT}/${systemId}`, {\r\n        method: 'PATCH',\r\n        credentials: 'include',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify(payload),\r\n      });\r\n      if (!response.ok) {\r\n        console.warn('[Employee API] Update sync failed');\r\n      } else {\r\n        console.log('[Employee API] Updated:', systemId);\r\n      }\r\n    } catch (e) {\r\n      console.warn('[Employee API] Update sync error:', e);\r\n    }\r\n    \r\n    return localResult;\r\n  },\r\n  softDelete: async (systemId) => {\r\n    // First delete locally\r\n    await employeeRepository.softDelete(systemId);\r\n    \r\n    // Then sync to API\r\n    try {\r\n      const response = await fetch(`${API_ENDPOINT}/${systemId}`, {\r\n        method: 'DELETE',\r\n        credentials: 'include',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({ hard: false }),\r\n      });\r\n      if (!response.ok) {\r\n        console.warn('[Employee API] Soft delete sync failed');\r\n      } else {\r\n        console.log('[Employee API] Soft deleted:', systemId);\r\n      }\r\n    } catch (e) {\r\n      console.warn('[Employee API] Soft delete sync error:', e);\r\n    }\r\n  },\r\n  restore: async (systemId) => {\r\n    // First restore locally\r\n    const localResult = await employeeRepository.restore(systemId);\r\n    \r\n    // Then sync to API\r\n    try {\r\n      const response = await fetch(`${API_ENDPOINT}/${systemId}/restore`, {\r\n        method: 'POST',\r\n        credentials: 'include',\r\n        headers: { 'Content-Type': 'application/json' },\r\n      });\r\n      if (!response.ok) {\r\n        console.warn('[Employee API] Restore sync failed');\r\n      } else {\r\n        console.log('[Employee API] Restored:', systemId);\r\n      }\r\n    } catch (e) {\r\n      console.warn('[Employee API] Restore sync error:', e);\r\n    }\r\n    \r\n    return localResult;\r\n  },\r\n  hardDelete: async (systemId) => {\r\n    // First delete locally\r\n    await employeeRepository.hardDelete(systemId);\r\n    \r\n    // Then sync to API\r\n    try {\r\n      const response = await fetch(`${API_ENDPOINT}/${systemId}`, {\r\n        method: 'DELETE',\r\n        credentials: 'include',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({ hard: true }),\r\n      });\r\n      if (!response.ok) {\r\n        console.warn('[Employee API] Hard delete sync failed');\r\n      } else {\r\n        console.log('[Employee API] Hard deleted:', systemId);\r\n      }\r\n    } catch (e) {\r\n      console.warn('[Employee API] Hard delete sync error:', e);\r\n    }\r\n  },\r\n};\r\n\r\n// ✅ Register for breadcrumb auto-generation\r\nregisterBreadcrumbStore('employees', () => baseStore.getState());\r\n\r\n// Define enhanced interface\r\ninterface EmployeeStoreState extends CrudState<Employee> {\r\n  searchEmployees: (query: string, page: number, limit?: number) => Promise<{ items: { value: string; label: string }[], hasNextPage: boolean }>;\r\n  permanentDelete: (systemId: SystemId) => Promise<void>;\r\n  persistence: EmployeePersistenceAdapter;\r\n}\r\n\r\ntype EmployeeStoreHook = (() => EmployeeStoreState) & {\r\n  getState: () => EmployeeStoreState;\r\n  persistence: EmployeePersistenceAdapter;\r\n};\r\n\r\n// Augmented methods\r\nconst augmentedMethods = {\r\n    // FIX: Changed `page: number = 1` to `page: number` to make it a required parameter, matching Combobox prop type.\r\n    // ✅ CRITICAL FIX: Create fresh Fuse instance on each search to avoid stale data\r\n    searchEmployees: async (query: string, page: number, limit: number = 20) => {\r\n        return new Promise<{ items: { value: string; label: string }[], hasNextPage: boolean }>(resolve => {\r\n            setTimeout(() => {\r\n                const allEmployees = baseStore.getState().data;\r\n                \r\n                // ✅ Create fresh Fuse instance with current data\r\n                const fuse = new Fuse(allEmployees, {\r\n                    keys: ['fullName', 'id', 'phone', 'personalEmail', 'workEmail'],\r\n                    threshold: 0.3,\r\n                });\r\n                \r\n                const results = query ? fuse.search(query).map(r => r.item) : allEmployees;\r\n                \r\n                const start = (page - 1) * limit;\r\n                const end = start + limit;\r\n                const paginatedItems = results.slice(start, end);\r\n\r\n                resolve({\r\n                    items: paginatedItems.map(e => ({ value: e.systemId, label: e.fullName })),\r\n                    hasNextPage: end < results.length,\r\n                });\r\n            }, 300);\r\n        });\r\n    },\r\n    permanentDelete: async (systemId: SystemId) => {\r\n        await persistence.hardDelete(systemId);\r\n    }\r\n};\r\n\r\nconst useEmployeeStoreHook = (): EmployeeStoreState => {\r\n  const state = baseStore();\r\n  return {\r\n    ...state,\r\n    ...augmentedMethods, // This includes permanentDelete\r\n    persistence,\r\n  };\r\n};\r\n\r\nexport const useEmployeeStore = useEmployeeStoreHook as EmployeeStoreHook;\r\n\r\n// Export getState for non-hook usage\r\nuseEmployeeStore.getState = (): EmployeeStoreState => {\r\n  const state = baseStore.getState();\r\n  return {\r\n    ...state,\r\n    ...augmentedMethods,\r\n    persistence,\r\n  };\r\n};\r\n\r\nuseEmployeeStore.persistence = persistence;\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 3647, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/receipts/store.ts"],"sourcesContent":["import { create } from 'zustand';\r\nimport { subscribeWithSelector } from 'zustand/middleware';\r\nimport type { Receipt } from './types';\r\nimport type { HistoryEntry } from '../../components/ActivityHistory';\r\nimport { \r\n  findNextAvailableBusinessId, \r\n  generateSystemId, \r\n  getMaxBusinessIdCounter, \r\n  getMaxSystemIdCounter,\r\n  extractCounterFromBusinessId,\r\n  type EntityType \r\n} from '@/lib/id-utils';\r\nimport { asSystemId, asBusinessId, type BusinessId, type SystemId } from '@/lib/id-types';\r\n// REMOVED: import { data as initialData } from './data'; // Mock data no longer used - database is source of truth\r\nimport { pickAccount, pickPaymentMethod, pickReceiptType, pickTargetGroup } from '@/features/finance/document-lookups';\r\nimport { useEmployeeStore } from '../employees/store';\r\nimport { getCurrentUserSystemId } from '../../contexts/auth-context';\r\n\r\n// API sync helpers\r\nasync function syncToAPI(action: 'create' | 'update' | 'delete', data: any): Promise<boolean> {\r\n  try {\r\n    const endpoint = action === 'create' ? '/api/receipts' : `/api/receipts/${data.systemId}`;\r\n    const method = action === 'create' ? 'POST' : action === 'update' ? 'PATCH' : 'DELETE';\r\n    \r\n    const response = await fetch(endpoint, {\r\n      method,\r\n      headers: { 'Content-Type': 'application/json' },\r\n      body: action !== 'delete' ? JSON.stringify(data) : undefined,\r\n    });\r\n    \r\n    if (!response.ok) {\r\n      console.error(`[Receipts API] ${action} failed:`, await response.text());\r\n      return false;\r\n    }\r\n    return true;\r\n  } catch (error) {\r\n    console.error(`[Receipts API] ${action} error:`, error);\r\n    return false;\r\n  }\r\n}\r\n\r\n// Helper to get current user info\r\nconst getCurrentUserInfo = () => {\r\n  const currentUserSystemId = getCurrentUserSystemId?.() || 'SYSTEM';\r\n  const employee = useEmployeeStore.getState().data.find(e => e.systemId === currentUserSystemId);\r\n  return {\r\n    systemId: currentUserSystemId,\r\n    name: employee?.fullName || 'Hệ thống',\r\n    avatar: employee?.avatarUrl,\r\n  };\r\n};\r\n\r\n// Helper to create history entry\r\nconst createHistoryEntry = (\r\n  action: HistoryEntry['action'],\r\n  description: string,\r\n  metadata?: HistoryEntry['metadata']\r\n): HistoryEntry => ({\r\n  id: crypto.randomUUID(),\r\n  action,\r\n  timestamp: new Date(),\r\n  user: getCurrentUserInfo(),\r\n  description,\r\n  metadata,\r\n});\r\n\r\nconst SYSTEM_AUTHOR = asSystemId('SYSTEM');\r\nconst getCurrentReceiptAuthor = (): SystemId => {\r\n  const userId = getCurrentUserSystemId?.();\r\n  return userId ? asSystemId(userId) : SYSTEM_AUTHOR;\r\n};\r\n\r\nexport type ReceiptInput = Omit<Receipt, 'systemId' | 'id'> & { id?: BusinessId };\r\n\r\ninterface ReceiptStore {\r\n  data: Receipt[];\r\n  businessIdCounter: number;\r\n  systemIdCounter: number;\r\n  initialized: boolean;\r\n  add: (item: ReceiptInput) => Receipt;\r\n  addMultiple: (items: ReceiptInput[]) => void;\r\n  update: (systemId: SystemId, item: Receipt) => void;\r\n  remove: (systemId: SystemId) => void;\r\n  findById: (systemId: SystemId) => Receipt | undefined;\r\n  getActive: () => Receipt[];\r\n  cancel: (systemId: SystemId, reason?: string) => void;\r\n  loadFromAPI: () => Promise<void>;\r\n}\r\n\r\nconst RECEIPT_ENTITY: EntityType = 'receipts';\r\nconst SYSTEM_ID_PREFIX = 'RECEIPT';\r\nconst BUSINESS_ID_PREFIX = 'PT';\r\nconst BUSINESS_ID_DIGITS = 6;\r\n\r\nconst normalizeReceiptStatus = (status?: Receipt['status']): Receipt['status'] =>\r\n  status === 'cancelled' ? 'cancelled' : 'completed';\r\n\r\nconst ensureReceiptMetadata = (receipt: Receipt): Receipt => {\r\n  let mutated = false;\r\n  const updates: Partial<Receipt> = {};\r\n\r\n  const targetGroup = pickTargetGroup({\r\n    systemId: receipt.payerTypeSystemId,\r\n    name: receipt.payerTypeName,\r\n  });\r\n  if (targetGroup) {\r\n    if (receipt.payerTypeSystemId !== targetGroup.systemId) {\r\n      updates.payerTypeSystemId = targetGroup.systemId;\r\n      mutated = true;\r\n    }\r\n    if (receipt.payerTypeName !== targetGroup.name) {\r\n      updates.payerTypeName = targetGroup.name;\r\n      mutated = true;\r\n    }\r\n  }\r\n\r\n  const paymentMethod = pickPaymentMethod({\r\n    systemId: receipt.paymentMethodSystemId,\r\n    name: receipt.paymentMethodName,\r\n  });\r\n  if (paymentMethod) {\r\n    if (receipt.paymentMethodSystemId !== paymentMethod.systemId) {\r\n      updates.paymentMethodSystemId = paymentMethod.systemId;\r\n      mutated = true;\r\n    }\r\n    if (receipt.paymentMethodName !== paymentMethod.name) {\r\n      updates.paymentMethodName = paymentMethod.name;\r\n      mutated = true;\r\n    }\r\n  }\r\n\r\n  const account = pickAccount({\r\n    accountSystemId: receipt.accountSystemId,\r\n    branchSystemId: receipt.branchSystemId,\r\n    paymentMethodName: paymentMethod?.name ?? receipt.paymentMethodName,\r\n  });\r\n  if (account && receipt.accountSystemId !== account.systemId) {\r\n    updates.accountSystemId = account.systemId;\r\n    mutated = true;\r\n  }\r\n\r\n  const receiptType = pickReceiptType({\r\n    systemId: receipt.paymentReceiptTypeSystemId,\r\n    name: receipt.paymentReceiptTypeName,\r\n  });\r\n  if (receiptType) {\r\n    if (receipt.paymentReceiptTypeSystemId !== receiptType.systemId) {\r\n      updates.paymentReceiptTypeSystemId = receiptType.systemId;\r\n      mutated = true;\r\n    }\r\n    if (receipt.paymentReceiptTypeName !== receiptType.name) {\r\n      updates.paymentReceiptTypeName = receiptType.name;\r\n      mutated = true;\r\n    }\r\n  }\r\n\r\n  if (!receipt.customerName && receipt.payerName) {\r\n    updates.customerName = receipt.payerName;\r\n    mutated = true;\r\n  }\r\n\r\n  if (!receipt.customerSystemId && receipt.payerSystemId) {\r\n    updates.customerSystemId = receipt.payerSystemId;\r\n    mutated = true;\r\n  }\r\n\r\n  return mutated ? { ...receipt, ...updates } : receipt;\r\n};\r\n\r\nconst backfillReceiptMetadata = (receipts: Receipt[]): Receipt[] => {\r\n  let mutated = false;\r\n  const updated = receipts.map(receipt => {\r\n    const normalized = ensureReceiptMetadata(receipt);\r\n    if (normalized !== receipt) {\r\n      mutated = true;\r\n    }\r\n    return normalized;\r\n  });\r\n  return mutated ? updated : receipts;\r\n};\r\n\r\nconst initialReceipts: Receipt[] = []; // Database is source of truth\r\n\r\nlet systemIdCounter = getMaxSystemIdCounter(initialReceipts, SYSTEM_ID_PREFIX);\r\nlet businessIdCounter = getMaxBusinessIdCounter(initialReceipts, BUSINESS_ID_PREFIX);\r\n\r\nconst getNextSystemId = (): SystemId => {\r\n  systemIdCounter += 1;\r\n  return asSystemId(generateSystemId(RECEIPT_ENTITY, systemIdCounter));\r\n};\r\n\r\nconst ensureReceiptBusinessId = (receipts: Receipt[], provided?: BusinessId | string): BusinessId => {\r\n  if (provided && `${provided}`.trim().length > 0) {\r\n    const normalized = `${provided}`.trim().toUpperCase();\r\n    const parsedCounter = extractCounterFromBusinessId(normalized, BUSINESS_ID_PREFIX);\r\n    if (parsedCounter > businessIdCounter) {\r\n      businessIdCounter = parsedCounter;\r\n    }\r\n    return asBusinessId(normalized);\r\n  }\r\n\r\n  const existingIds = receipts.map(receipt => receipt.id as string).filter(Boolean);\r\n  const { nextId, updatedCounter } = findNextAvailableBusinessId(\r\n    BUSINESS_ID_PREFIX,\r\n    existingIds,\r\n    businessIdCounter,\r\n    BUSINESS_ID_DIGITS\r\n  );\r\n  businessIdCounter = updatedCounter;\r\n  return asBusinessId(nextId);\r\n};\r\n\r\nexport const useReceiptStore = create<ReceiptStore>()(\r\n  subscribeWithSelector(\r\n    (set, get) => ({\r\n      data: initialReceipts,\r\n      businessIdCounter,\r\n      systemIdCounter,\r\n      initialized: false,\r\n      \r\n      add: (item: ReceiptInput): Receipt => {\r\n        let createdReceipt: Receipt | null = null;\r\n        set(state => {\r\n          const systemId = getNextSystemId();\r\n          const id = ensureReceiptBusinessId(state.data, item.id);\r\n          const createdBy = item.createdBy ?? getCurrentReceiptAuthor();\r\n          \r\n          const newReceipt: Receipt = { \r\n            ...item, \r\n            systemId, \r\n            id,\r\n            createdBy,\r\n            createdAt: item.createdAt || new Date().toISOString(),\r\n            status: normalizeReceiptStatus(item.status),\r\n            orderAllocations: item.orderAllocations ?? [],\r\n          };\r\n\r\n          const normalizedReceipt = ensureReceiptMetadata(newReceipt);\r\n          createdReceipt = normalizedReceipt;\r\n\r\n          return { \r\n            data: [...state.data, normalizedReceipt],\r\n            businessIdCounter,\r\n            systemIdCounter\r\n          };\r\n        });\r\n        // Sync to API\r\n        if (createdReceipt) {\r\n          syncToAPI('create', createdReceipt).catch(console.error);\r\n        }\r\n        return createdReceipt!;\r\n      },\r\n      \r\n      addMultiple: (items: ReceiptInput[]) => {\r\n        const created: Receipt[] = [];\r\n        set(state => {\r\n          items.forEach(item => {\r\n            const context = [...state.data, ...created];\r\n            const systemId = getNextSystemId();\r\n            const id = ensureReceiptBusinessId(context, item.id);\r\n            const createdBy = item.createdBy ?? getCurrentReceiptAuthor();\r\n            \r\n            const newReceipt: Receipt = { \r\n              ...item, \r\n              systemId, \r\n              id,\r\n              createdBy,\r\n              createdAt: item.createdAt || new Date().toISOString(),\r\n              status: normalizeReceiptStatus(item.status),\r\n              orderAllocations: item.orderAllocations ?? [],\r\n            };\r\n            created.push(ensureReceiptMetadata(newReceipt));\r\n          });\r\n          \r\n          return { \r\n            data: [...state.data, ...created],\r\n            businessIdCounter,\r\n            systemIdCounter\r\n          };\r\n        });\r\n        // Sync all to API\r\n        created.forEach(receipt => {\r\n          syncToAPI('create', receipt).catch(console.error);\r\n        });\r\n      },\r\n      \r\n      update: (systemId: SystemId, item: Receipt) => {\r\n        const updated = { ...item, status: normalizeReceiptStatus(item.status), updatedAt: new Date().toISOString() };\r\n        set(state => ({\r\n          data: state.data.map(r => r.systemId === systemId ? updated : r),\r\n          businessIdCounter,\r\n          systemIdCounter\r\n        }));\r\n        // Sync to API\r\n        syncToAPI('update', updated).catch(console.error);\r\n      },\r\n      \r\n      remove: (systemId: SystemId) => {\r\n        set(state => ({\r\n          data: state.data.filter(r => r.systemId !== systemId),\r\n          businessIdCounter,\r\n          systemIdCounter\r\n        }));\r\n        // Sync to API\r\n        syncToAPI('delete', { systemId }).catch(console.error);\r\n      },\r\n      \r\n      findById: (systemId: SystemId) => {\r\n        return get().data.find(r => r.systemId === systemId);\r\n      },\r\n      \r\n      getActive: () => {\r\n        return get().data.filter(r => r.status !== 'cancelled');\r\n      },\r\n      \r\n      cancel: (systemId: SystemId, reason?: string) => {\r\n        const receipt = get().findById(systemId);\r\n        if (receipt && receipt.status !== 'cancelled') {\r\n          const historyEntry = createHistoryEntry(\r\n            'cancelled',\r\n            `Đã hủy phiếu thu${reason ? `: ${reason}` : ''}`,\r\n            { oldValue: 'Hoàn thành', newValue: 'Đã hủy', note: reason }\r\n          );\r\n          \r\n          get().update(systemId, {\r\n            ...receipt,\r\n            status: 'cancelled',\r\n            cancelledAt: new Date().toISOString(),\r\n            activityHistory: [...(receipt.activityHistory || []), historyEntry],\r\n          });\r\n        }\r\n      },\r\n      \r\n      loadFromAPI: async () => {\r\n        try {\r\n          // NOTE: Use React Query hooks for paginated data. This only loads initial batch.\r\n          const response = await fetch('/api/receipts?limit=30');\r\n          if (!response.ok) return;\r\n          const json = await response.json();\r\n          const apiData = json.data || [];\r\n          if (apiData.length > 0) {\r\n            const normalized = backfillReceiptMetadata(apiData.map((receipt: Receipt) => ({\r\n              ...receipt,\r\n              status: normalizeReceiptStatus(receipt.status),\r\n            })));\r\n            const nextSystemCounter = getMaxSystemIdCounter(normalized, SYSTEM_ID_PREFIX);\r\n            const nextBusinessCounter = getMaxBusinessIdCounter(normalized, BUSINESS_ID_PREFIX);\r\n            systemIdCounter = nextSystemCounter;\r\n            businessIdCounter = nextBusinessCounter;\r\n            set({ \r\n              data: normalized, \r\n              systemIdCounter, \r\n              businessIdCounter,\r\n              initialized: true \r\n            });\r\n          } else {\r\n            set({ initialized: true });\r\n          }\r\n        } catch (error) {\r\n          console.error('[Receipts API] loadFromAPI error:', error);\r\n        }\r\n      },\r\n    })\r\n  )\r\n);\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 3978, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/purchase-returns/store.ts"],"sourcesContent":["import { formatDateCustom, getCurrentDate } from '../../lib/date-utils';\r\nimport { createCrudStore, type CrudState } from '../../lib/store-factory';\r\n// REMOVED: import { data as initialData } from './data'; // Mock data no longer used - database is source of truth\r\nimport type { PurchaseReturn } from './types';\r\nimport { useProductStore } from '../products/store';\r\nimport { useStockHistoryStore } from '../stock-history/store';\r\nimport { useReceiptStore } from '../receipts/store';\r\nimport { usePurchaseOrderStore } from '../purchase-orders/store';\r\nimport { useCashbookStore } from '../cashbook/store';\r\nimport { useReceiptTypeStore } from '../settings/receipt-types/store';\r\nimport type { Receipt } from '../receipts/types';\r\nimport type { PurchaseOrderRefundStatus } from '../purchase-orders/types';\r\nimport { useInventoryReceiptStore } from '../inventory-receipts/store';\r\nimport { asBusinessId, asSystemId, type SystemId } from '@/lib/id-types';\r\n\r\nconst baseStore = createCrudStore<PurchaseReturn>(\r\n  [],\r\n  'purchase-returns',\r\n  {\r\n    apiEndpoint: '/api/purchase-returns',\r\n  }\r\n);\r\n\r\nconst originalAdd = baseStore.getState().add;\r\n\r\nconst newAdd = (item: Omit<PurchaseReturn, 'systemId'>): PurchaseReturn | undefined => {\r\n    // 1. Get other stores' methods\r\n    const { updateInventory } = useProductStore.getState();\r\n    const { addEntry: addStockHistory } = useStockHistoryStore.getState();\r\n    const { add: addReceipt } = useReceiptStore.getState();\r\n    const { processReturn: updatePOonReturn, data: allPOs } = usePurchaseOrderStore.getState();\r\n    const { accounts } = useCashbookStore.getState();\r\n    const { data: receiptTypes } = useReceiptTypeStore.getState();\r\n    const { data: allReceipts } = useInventoryReceiptStore.getState();\r\n    \r\n    // 2. Add the return record itself\r\n    const newReturn = originalAdd(item);\r\n\r\n    if (!newReturn) {\r\n      return undefined;\r\n    }\r\n\r\n    // 3. Update inventory & create stock history\r\n    newReturn.items.forEach(lineItem => {\r\n        if (lineItem.returnQuantity > 0) {\r\n            const productBeforeUpdate = useProductStore.getState().findById(lineItem.productSystemId);\r\n            const oldStock = productBeforeUpdate?.inventoryByBranch[newReturn.branchSystemId] || 0;\r\n            \r\n            updateInventory(lineItem.productSystemId, newReturn.branchSystemId, -lineItem.returnQuantity);\r\n            addStockHistory({\r\n                productId: lineItem.productSystemId,\r\n                date: new Date().toISOString(),\r\n                employeeName: newReturn.creatorName,\r\n                action: 'Hoàn trả NCC',\r\n                quantityChange: -lineItem.returnQuantity,\r\n                newStockLevel: oldStock - lineItem.returnQuantity,\r\n                documentId: newReturn.id,\r\n                branchSystemId: newReturn.branchSystemId,\r\n                branch: newReturn.branchName,\r\n            });\r\n        }\r\n    });\r\n\r\n    // 4. Create receipt when supplier refunds money (supplier pays company)\r\n    if (newReturn.refundAmount > 0) {\r\n      const receiptCategory = receiptTypes.find(pt => pt.name === 'Nhà cung cấp hoàn tiền');\r\n      if (newReturn.accountSystemId) {\r\n        const account = accounts.find(acc => acc.systemId === newReturn.accountSystemId);\r\n        const issuedAt = formatDateCustom(getCurrentDate(), 'yyyy-MM-dd HH:mm');\r\n\r\n        const refundReceipt: Omit<Receipt, 'systemId'> = {\r\n          id: asBusinessId(''), // Let receipt store auto-generate PT-XXXXXX\r\n          date: issuedAt,\r\n          amount: newReturn.refundAmount,\r\n\r\n          // Payer info (TargetGroup placeholder)\r\n          payerTypeSystemId: asSystemId('NHACUNGCAP'),\r\n          payerTypeName: 'Nhà cung cấp',\r\n          payerName: newReturn.supplierName,\r\n          payerSystemId: newReturn.supplierSystemId,\r\n\r\n          description: `Nhận hoàn tiền cho đơn nhập ${newReturn.purchaseOrderId} (Phiếu trả hàng ${newReturn.id})`,\r\n\r\n          // Payment method placeholders — should map to settings\r\n          paymentMethodSystemId: asSystemId(account?.type === 'cash' ? 'PAYMENT_METHOD_CASH' : 'PAYMENT_METHOD_BANK'),\r\n          paymentMethodName: newReturn.refundMethod,\r\n\r\n          accountSystemId: newReturn.accountSystemId,\r\n          paymentReceiptTypeSystemId: receiptCategory?.systemId ?? asSystemId('RT_SUPPLIER_REFUND'),\r\n          paymentReceiptTypeName: receiptCategory?.name ?? 'Nhà cung cấp hoàn tiền',\r\n\r\n          branchSystemId: newReturn.branchSystemId,\r\n          branchName: newReturn.branchName,\r\n          createdBy: asSystemId('SYSTEM'),\r\n          createdAt: issuedAt,\r\n\r\n          status: 'completed',\r\n          category: 'other',\r\n          affectsDebt: true,\r\n\r\n          purchaseOrderSystemId: newReturn.purchaseOrderSystemId,\r\n          purchaseOrderId: newReturn.purchaseOrderId,\r\n          originalDocumentId: newReturn.id,\r\n        };\r\n\r\n        addReceipt(refundReceipt);\r\n        }\r\n    }\r\n\r\n    // 5. Update the original Purchase Order's status\r\n    const po = allPOs.find(p => asSystemId(p.systemId) === newReturn.purchaseOrderSystemId);\r\n    if (po) {\r\n        // A full check would require summing all returns for this PO.\r\n        const allItems = po.lineItems;\r\n        const poSystemId = asSystemId(po.systemId);\r\n        const allReturnedItems = baseStore.getState().data\r\n        .filter(pr => pr.purchaseOrderSystemId === poSystemId)\r\n            .flatMap(pr => pr.items);\r\n            \r\n      const receiptsForPO = allReceipts.filter(r => r.purchaseOrderSystemId === poSystemId);\r\n\r\n        const isFullReturn = allItems.every(poItem => {\r\n            const totalReceived = receiptsForPO.reduce((sum, receipt) => {\r\n                const receiptItem = receipt.items.find(i => i.productSystemId === poItem.productSystemId);\r\n                return sum + (receiptItem ? Number(receiptItem.receivedQuantity) : 0);\r\n            }, 0);\r\n\r\n            const totalReturned = allReturnedItems\r\n                .filter(returnedItem => returnedItem.productSystemId === poItem.productSystemId)\r\n                .reduce((sum, returnedItem) => sum + returnedItem.returnQuantity, 0);\r\n            \r\n            return totalReturned >= totalReceived;\r\n        });\r\n        \r\n        const existingReturnsForPO = baseStore.getState().data.filter(pr => pr.purchaseOrderSystemId === poSystemId && pr.systemId !== newReturn.systemId);\r\n        const allReturnsForPO = [...existingReturnsForPO, newReturn];\r\n        const totalReturnedValue = allReturnsForPO.reduce((sum, r) => sum + r.totalReturnValue, 0);\r\n        const totalRefunded = allReturnsForPO.reduce((sum, r) => sum + r.refundAmount, 0);\r\n\r\n        let newRefundStatus: PurchaseOrderRefundStatus = po.refundStatus || 'Chưa hoàn tiền';\r\n        if (totalReturnedValue > 0) {\r\n            if (totalRefunded >= totalReturnedValue) {\r\n                newRefundStatus = 'Hoàn tiền toàn bộ';\r\n            } else if (totalRefunded > 0) {\r\n                newRefundStatus = 'Hoàn tiền một phần';\r\n            } else {\r\n                newRefundStatus = 'Chưa hoàn tiền';\r\n            }\r\n        }\r\n\r\n        updatePOonReturn(po.id, isFullReturn, newRefundStatus, newReturn.id, newReturn.creatorName);\r\n    }\r\n\r\n    return newReturn;\r\n};\r\n\r\nconst otherMethods = {\r\n  findByPurchaseOrderSystemId: (purchaseOrderSystemId: SystemId) => {\r\n    return baseStore.getState().data.filter(pr => pr.purchaseOrderSystemId === purchaseOrderSystemId);\r\n  }\r\n};\r\n\r\ntype BaseState = CrudState<PurchaseReturn>;\r\n\r\nexport type PurchaseReturnStoreState = Omit<BaseState, 'add'> & {\r\n  add: typeof newAdd;\r\n  findByPurchaseOrderSystemId: (purchaseOrderSystemId: SystemId) => PurchaseReturn[];\r\n};\r\n\r\nexport const usePurchaseReturnStore = (): PurchaseReturnStoreState => {\r\n  const { add: _unusedAdd, ...rest } = baseStore();\r\n  return {\r\n    ...rest,\r\n    add: newAdd,\r\n    ...otherMethods,\r\n  } as PurchaseReturnStoreState;\r\n};\r\n\r\nusePurchaseReturnStore.getState = (): PurchaseReturnStoreState => {\r\n  const { add: _unusedAdd, ...rest } = baseStore.getState();\r\n  return {\r\n    ...rest,\r\n    add: newAdd,\r\n    ...otherMethods,\r\n  } as PurchaseReturnStoreState;\r\n};\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 4140, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/customers/lifecycle-utils.ts"],"sourcesContent":["import type { Customer, CustomerLifecycleStage } from './types';\r\nimport { formatDate, formatDateTime, formatDateTimeSeconds, formatDateCustom, getCurrentDate, getDaysDiff } from '@/lib/date-utils';\r\n/**\r\n * Tự động tính toán giai đoạn vòng đời khách hàng dựa trên hành vi\r\n */\r\nexport const calculateLifecycleStage = (customer: Customer): CustomerLifecycleStage => {\r\n  const totalOrders = customer.totalOrders || 0;\r\n  const totalSpent = customer.totalSpent || 0;\r\n  const lastPurchaseDate = customer.lastPurchaseDate;\r\n  \r\n  // Nếu chưa mua lần nào\r\n  if (totalOrders === 0) {\r\n    return \"Khách tiềm năng\";\r\n  }\r\n  \r\n  // Tính số ngày từ lần mua cuối\r\n  const daysSinceLastPurchase = lastPurchaseDate \r\n    ? getDaysDiff(getCurrentDate(), new Date(lastPurchaseDate))\r\n    : Infinity;\r\n  \r\n  // Khách đã mất (không mua > 365 ngày)\r\n  if (daysSinceLastPurchase > 365) {\r\n    return \"Mất khách\";\r\n  }\r\n  \r\n  // Không hoạt động (không mua > 180 ngày)\r\n  if (daysSinceLastPurchase > 180) {\r\n    return \"Không hoạt động\";\r\n  }\r\n  \r\n  // Khách VIP: Top 10% spending (>= 50 triệu) và mua >= 5 lần\r\n  if (totalSpent >= 50_000_000 && totalOrders >= 5) {\r\n    return \"Khách VIP\";\r\n  }\r\n  \r\n  // Khách thân thiết: Mua >= 5 lần\r\n  if (totalOrders >= 5) {\r\n    return \"Khách thân thiết\";\r\n  }\r\n  \r\n  // Khách quay lại: Mua 2-4 lần\r\n  if (totalOrders >= 2) {\r\n    return \"Khách quay lại\";\r\n  }\r\n  \r\n  // Khách mới: Mua lần đầu\r\n  return \"Khách mới\";\r\n};\r\n\r\n/**\r\n * Lấy màu badge cho lifecycle stage\r\n */\r\nexport const getLifecycleStageVariant = (stage?: CustomerLifecycleStage): \r\n  'default' | 'secondary' | 'success' | 'warning' | 'destructive' => {\r\n  switch (stage) {\r\n    case \"Khách VIP\":\r\n      return \"success\";\r\n    case \"Khách thân thiết\":\r\n      return \"success\";\r\n    case \"Khách quay lại\":\r\n      return \"default\";\r\n    case \"Khách mới\":\r\n      return \"secondary\";\r\n    case \"Khách tiềm năng\":\r\n      return \"secondary\";\r\n    case \"Không hoạt động\":\r\n      return \"warning\";\r\n    case \"Mất khách\":\r\n      return \"destructive\";\r\n    default:\r\n      return \"secondary\";\r\n  }\r\n};\r\n\r\n/**\r\n * Cập nhật lifecycle stage cho tất cả customers (chạy batch)\r\n */\r\nexport const updateAllCustomerLifecycleStages = (customers: Customer[]): Customer[] => {\r\n  return customers.map(customer => ({\r\n    ...customer,\r\n    lifecycleStage: calculateLifecycleStage(customer)\r\n  }));\r\n};\r\n"],"names":[],"mappings":";;;;;;;;AACA;;AAIO,MAAM,0BAA0B,CAAC;IACtC,MAAM,cAAc,SAAS,WAAW,IAAI;IAC5C,MAAM,aAAa,SAAS,UAAU,IAAI;IAC1C,MAAM,mBAAmB,SAAS,gBAAgB;IAElD,uBAAuB;IACvB,IAAI,gBAAgB,GAAG;QACrB,OAAO;IACT;IAEA,+BAA+B;IAC/B,MAAM,wBAAwB,mBAC1B,IAAA,sIAAW,EAAC,IAAA,yIAAc,KAAI,IAAI,KAAK,qBACvC;IAEJ,sCAAsC;IACtC,IAAI,wBAAwB,KAAK;QAC/B,OAAO;IACT;IAEA,yCAAyC;IACzC,IAAI,wBAAwB,KAAK;QAC/B,OAAO;IACT;IAEA,4DAA4D;IAC5D,IAAI,cAAc,cAAc,eAAe,GAAG;QAChD,OAAO;IACT;IAEA,iCAAiC;IACjC,IAAI,eAAe,GAAG;QACpB,OAAO;IACT;IAEA,8BAA8B;IAC9B,IAAI,eAAe,GAAG;QACpB,OAAO;IACT;IAEA,yBAAyB;IACzB,OAAO;AACT;AAKO,MAAM,2BAA2B,CAAC;IAEvC,OAAQ;QACN,KAAK;YACH,OAAO;QACT,KAAK;YACH,OAAO;QACT,KAAK;YACH,OAAO;QACT,KAAK;YACH,OAAO;QACT,KAAK;YACH,OAAO;QACT,KAAK;YACH,OAAO;QACT,KAAK;YACH,OAAO;QACT;YACE,OAAO;IACX;AACF;AAKO,MAAM,mCAAmC,CAAC;IAC/C,OAAO,UAAU,GAAG,CAAC,CAAA,WAAY,CAAC;YAChC,GAAG,QAAQ;YACX,gBAAgB,wBAAwB;QAC1C,CAAC;AACH"}},
    {"offset": {"line": 4216, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/customers/credit-utils.ts"],"sourcesContent":["import type { Customer } from './types';\r\n\r\nexport type CreditAlertLevel = 'safe' | 'warning' | 'danger' | 'exceeded';\r\n\r\n/**\r\n * Tính mức độ cảnh báo công nợ\r\n */\r\nexport const getCreditAlertLevel = (customer: Customer): CreditAlertLevel => {\r\n  const currentDebt = customer.currentDebt || 0;\r\n  const maxDebt = customer.maxDebt || 0;\r\n  \r\n  // Nếu không có hạn mức hoặc hạn mức = 0, không cảnh báo\r\n  if (maxDebt === 0) return 'safe';\r\n  \r\n  const debtRatio = (currentDebt / maxDebt) * 100;\r\n  \r\n  if (debtRatio >= 100) return 'exceeded';  // Vượt hạn mức\r\n  if (debtRatio >= 90) return 'danger';     // >= 90%\r\n  if (debtRatio >= 70) return 'warning';    // >= 70%\r\n  return 'safe';                             // < 70%\r\n};\r\n\r\n/**\r\n * Lấy variant Badge cho credit alert\r\n */\r\nexport const getCreditAlertBadgeVariant = (level: CreditAlertLevel): \r\n  'default' | 'secondary' | 'success' | 'warning' | 'destructive' => {\r\n  switch (level) {\r\n    case 'exceeded':\r\n    case 'danger':\r\n      return 'destructive';\r\n    case 'warning':\r\n      return 'warning';\r\n    case 'safe':\r\n      return 'success';\r\n    default:\r\n      return 'secondary';\r\n  }\r\n};\r\n\r\n/**\r\n * Lấy text cho credit alert\r\n */\r\nexport const getCreditAlertText = (level: CreditAlertLevel): string => {\r\n  switch (level) {\r\n    case 'exceeded':\r\n      return 'Vượt hạn mức';\r\n    case 'danger':\r\n      return 'Sắp vượt hạn';\r\n    case 'warning':\r\n      return 'Cần theo dõi';\r\n    case 'safe':\r\n      return 'An toàn';\r\n    default:\r\n      return '';\r\n  }\r\n};\r\n\r\n/**\r\n * Kiểm tra xem có thể tạo đơn hàng không (dựa vào công nợ)\r\n */\r\nexport const canCreateOrder = (customer: Customer, orderAmount: number): {\r\n  allowed: boolean;\r\n  reason?: string;\r\n} => {\r\n  const currentDebt = customer.currentDebt || 0;\r\n  const maxDebt = customer.maxDebt || 0;\r\n  \r\n  // Nếu không cho phép công nợ và có công nợ hiện tại\r\n  if (!customer.allowCredit && currentDebt > 0) {\r\n    return {\r\n      allowed: false,\r\n      reason: 'Khách hàng không được phép công nợ và còn nợ cũ'\r\n    };\r\n  }\r\n  \r\n  // Nếu có hạn mức công nợ\r\n  if (maxDebt > 0) {\r\n    const newDebt = currentDebt + orderAmount;\r\n    if (newDebt > maxDebt) {\r\n      return {\r\n        allowed: false,\r\n        reason: `Đơn hàng này sẽ vượt hạn mức công nợ (${formatCurrency(newDebt)} / ${formatCurrency(maxDebt)})`\r\n      };\r\n    }\r\n  }\r\n  \r\n  return { allowed: true };\r\n};\r\n\r\n/**\r\n * Lấy danh sách khách hàng có nguy cơ công nợ cao\r\n */\r\nexport const getHighRiskDebtCustomers = (customers: Customer[]): Customer[] => {\r\n  return customers.filter(customer => {\r\n    const level = getCreditAlertLevel(customer);\r\n    return level === 'danger' || level === 'exceeded';\r\n  }).sort((a, b) => {\r\n    const ratioA = ((a.currentDebt || 0) / (a.maxDebt || 1)) * 100;\r\n    const ratioB = ((b.currentDebt || 0) / (b.maxDebt || 1)) * 100;\r\n    return ratioB - ratioA; // Sort by ratio descending\r\n  });\r\n};\r\n\r\n/**\r\n * Helper format currency\r\n */\r\nconst formatCurrency = (value: number): string => {\r\n  return new Intl.NumberFormat('vi-VN', { \r\n    style: 'currency', \r\n    currency: 'VND' \r\n  }).format(value);\r\n};\r\n"],"names":[],"mappings":";;;;;;;;;;;;AAOO,MAAM,sBAAsB,CAAC;IAClC,MAAM,cAAc,SAAS,WAAW,IAAI;IAC5C,MAAM,UAAU,SAAS,OAAO,IAAI;IAEpC,wDAAwD;IACxD,IAAI,YAAY,GAAG,OAAO;IAE1B,MAAM,YAAY,AAAC,cAAc,UAAW;IAE5C,IAAI,aAAa,KAAK,OAAO,YAAa,eAAe;IACzD,IAAI,aAAa,IAAI,OAAO,UAAc,SAAS;IACnD,IAAI,aAAa,IAAI,OAAO,WAAc,SAAS;IACnD,OAAO,QAAoC,QAAQ;AACrD;AAKO,MAAM,6BAA6B,CAAC;IAEzC,OAAQ;QACN,KAAK;QACL,KAAK;YACH,OAAO;QACT,KAAK;YACH,OAAO;QACT,KAAK;YACH,OAAO;QACT;YACE,OAAO;IACX;AACF;AAKO,MAAM,qBAAqB,CAAC;IACjC,OAAQ;QACN,KAAK;YACH,OAAO;QACT,KAAK;YACH,OAAO;QACT,KAAK;YACH,OAAO;QACT,KAAK;YACH,OAAO;QACT;YACE,OAAO;IACX;AACF;AAKO,MAAM,iBAAiB,CAAC,UAAoB;IAIjD,MAAM,cAAc,SAAS,WAAW,IAAI;IAC5C,MAAM,UAAU,SAAS,OAAO,IAAI;IAEpC,oDAAoD;IACpD,IAAI,CAAC,SAAS,WAAW,IAAI,cAAc,GAAG;QAC5C,OAAO;YACL,SAAS;YACT,QAAQ;QACV;IACF;IAEA,yBAAyB;IACzB,IAAI,UAAU,GAAG;QACf,MAAM,UAAU,cAAc;QAC9B,IAAI,UAAU,SAAS;YACrB,OAAO;gBACL,SAAS;gBACT,QAAQ,CAAC,sCAAsC,EAAE,eAAe,SAAS,GAAG,EAAE,eAAe,SAAS,CAAC,CAAC;YAC1G;QACF;IACF;IAEA,OAAO;QAAE,SAAS;IAAK;AACzB;AAKO,MAAM,2BAA2B,CAAC;IACvC,OAAO,UAAU,MAAM,CAAC,CAAA;QACtB,MAAM,QAAQ,oBAAoB;QAClC,OAAO,UAAU,YAAY,UAAU;IACzC,GAAG,IAAI,CAAC,CAAC,GAAG;QACV,MAAM,SAAS,AAAC,CAAC,EAAE,WAAW,IAAI,CAAC,IAAI,CAAC,EAAE,OAAO,IAAI,CAAC,IAAK;QAC3D,MAAM,SAAS,AAAC,CAAC,EAAE,WAAW,IAAI,CAAC,IAAI,CAAC,EAAE,OAAO,IAAI,CAAC,IAAK;QAC3D,OAAO,SAAS,QAAQ,2BAA2B;IACrD;AACF;AAEA;;CAEC,GACD,MAAM,iBAAiB,CAAC;IACtB,OAAO,IAAI,KAAK,YAAY,CAAC,SAAS;QACpC,OAAO;QACP,UAAU;IACZ,GAAG,MAAM,CAAC;AACZ"}},
    {"offset": {"line": 4315, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/customers/intelligence-utils.ts"],"sourcesContent":["import type { Customer } from './types';\r\nimport { formatDate, formatDateTime, formatDateTimeSeconds, formatDateCustom, getCurrentDate, getDaysDiff } from '@/lib/date-utils';\r\n// RFM Score types\r\nexport type RFMScore = {\r\n  recency: 1 | 2 | 3 | 4 | 5;      // 5 = Best (mua gần đây)\r\n  frequency: 1 | 2 | 3 | 4 | 5;    // 5 = Best (mua thường xuyên)\r\n  monetary: 1 | 2 | 3 | 4 | 5;     // 5 = Best (chi tiêu nhiều)\r\n};\r\n\r\n// Customer Segment based on RFM\r\nexport type CustomerSegment = \r\n  | 'Champions'           // RFM: 5-5-5, 5-4-5, 4-5-5 - Khách hàng tốt nhất\r\n  | 'Loyal Customers'     // RFM: 4-4-4, 4-5-4, 5-4-4 - Khách thân thiết\r\n  | 'Potential Loyalist'  // RFM: 4-3-*, 3-4-*, 5-3-* - Tiềm năng trở thành thân thiết\r\n  | 'New Customers'       // RFM: 5-1-*, 4-1-* - Khách mới\r\n  | 'Promising'           // RFM: 4-2-*, 3-3-* - Đầy hứa hẹn\r\n  | 'Need Attention'      // RFM: 3-2-*, 2-3-* - Cần chú ý\r\n  | 'About To Sleep'      // RFM: 3-1-*, 2-2-* - Sắp ngủ đông\r\n  | 'At Risk'             // RFM: 2-5-*, 2-4-*, 1-3-* - Có nguy cơ\r\n  | 'Cannot Lose Them'    // RFM: 1-5-5, 1-4-5 - Không thể mất\r\n  | 'Hibernating'         // RFM: 2-1-*, 1-2-* - Ngủ đông\r\n  | 'Lost';               // RFM: 1-1-* - Đã mất\r\n\r\n/**\r\n * Tính RFM scores cho một khách hàng\r\n */\r\nexport const calculateRFMScores = (customer: Customer, allCustomers: Customer[]): RFMScore => {\r\n  // Recency: Số ngày từ lần mua cuối\r\n  const daysSinceLastPurchase = customer.lastPurchaseDate \r\n    ? getDaysDiff(getCurrentDate(), new Date(customer.lastPurchaseDate))\r\n    : 999999;\r\n  \r\n  // Frequency: Tổng số đơn hàng\r\n  const frequency = customer.totalOrders || 0;\r\n  \r\n  // Monetary: Tổng chi tiêu\r\n  const monetary = customer.totalSpent || 0;\r\n\r\n  // Calculate percentiles for scoring\r\n  const allRecencies = allCustomers.map(c => \r\n    c.lastPurchaseDate ? getDaysDiff(getCurrentDate(), new Date(c.lastPurchaseDate)) : 999999\r\n  ).sort((a, b) => a - b);\r\n  \r\n  const allFrequencies = allCustomers.map(c => c.totalOrders || 0).sort((a, b) => b - a);\r\n  const allMonetary = allCustomers.map(c => c.totalSpent || 0).sort((a, b) => b - a);\r\n\r\n  // Score Recency (lower is better, so invert)\r\n  const recencyScore = getScore(daysSinceLastPurchase, allRecencies, true) as RFMScore['recency'];\r\n  \r\n  // Score Frequency (higher is better)\r\n  const frequencyScore = getScore(frequency, allFrequencies, false) as RFMScore['frequency'];\r\n  \r\n  // Score Monetary (higher is better)\r\n  const monetaryScore = getScore(monetary, allMonetary, false) as RFMScore['monetary'];\r\n\r\n  return {\r\n    recency: recencyScore,\r\n    frequency: frequencyScore,\r\n    monetary: monetaryScore\r\n  };\r\n};\r\n\r\n/**\r\n * Helper: Tính score 1-5 dựa trên percentile\r\n */\r\nconst getScore = (value: number, sortedValues: number[], invert: boolean): 1 | 2 | 3 | 4 | 5 => {\r\n  const index = sortedValues.indexOf(value);\r\n  if (index === -1) return 1;\r\n  \r\n  const percentile = (index / sortedValues.length) * 100;\r\n  \r\n  let score: number;\r\n  if (percentile >= 80) score = 5;\r\n  else if (percentile >= 60) score = 4;\r\n  else if (percentile >= 40) score = 3;\r\n  else if (percentile >= 20) score = 2;\r\n  else score = 1;\r\n  \r\n  // Invert for recency (lower days = better)\r\n  if (invert) {\r\n    score = 6 - score;\r\n  }\r\n  \r\n  return score as 1 | 2 | 3 | 4 | 5;\r\n};\r\n\r\n/**\r\n * Phân loại segment dựa trên RFM scores\r\n */\r\nexport const getCustomerSegment = (rfm: RFMScore): CustomerSegment => {\r\n  const { recency: R, frequency: F, monetary: M } = rfm;\r\n  \r\n  // Champions: RFM 5-5-5, 5-4-5, 4-5-5, 5-5-4\r\n  if ((R >= 4 && F >= 4 && M >= 4) && (R === 5 || F === 5)) {\r\n    return 'Champions';\r\n  }\r\n  \r\n  // Loyal Customers: RFM 4-4-4, 4-5-4, 5-4-4, 4-4-5\r\n  if (R >= 4 && F >= 4 && M >= 4) {\r\n    return 'Loyal Customers';\r\n  }\r\n  \r\n  // Potential Loyalist: High frequency, good recency\r\n  if (R >= 3 && F >= 3 && M >= 3) {\r\n    return 'Potential Loyalist';\r\n  }\r\n  \r\n  // New Customers: High recency, low frequency\r\n  if (R >= 4 && F <= 2) {\r\n    return 'New Customers';\r\n  }\r\n  \r\n  // Promising: Good recency, moderate frequency\r\n  if (R >= 3 && F >= 2 && F <= 3) {\r\n    return 'Promising';\r\n  }\r\n  \r\n  // Need Attention: Moderate scores\r\n  if (R === 3 && F === 2) {\r\n    return 'Need Attention';\r\n  }\r\n  \r\n  // About To Sleep: Low frequency, moderate recency\r\n  if ((R === 3 || R === 2) && F <= 2) {\r\n    return 'About To Sleep';\r\n  }\r\n  \r\n  // Cannot Lose Them: Low recency but high value\r\n  if (R === 1 && F >= 4 && M >= 4) {\r\n    return 'Cannot Lose Them';\r\n  }\r\n  \r\n  // At Risk: Low recency, good history\r\n  if (R <= 2 && F >= 3) {\r\n    return 'At Risk';\r\n  }\r\n  \r\n  // Hibernating: Low recency and frequency\r\n  if (R <= 2 && F <= 2 && M >= 2) {\r\n    return 'Hibernating';\r\n  }\r\n  \r\n  // Lost: Lowest scores\r\n  return 'Lost';\r\n};\r\n\r\n/**\r\n * Lấy màu badge cho segment\r\n */\r\nexport const getSegmentBadgeVariant = (segment: CustomerSegment): \r\n  'default' | 'secondary' | 'success' | 'warning' | 'destructive' => {\r\n  switch (segment) {\r\n    case 'Champions':\r\n    case 'Loyal Customers':\r\n      return 'success';\r\n    case 'Potential Loyalist':\r\n    case 'Promising':\r\n      return 'default';\r\n    case 'New Customers':\r\n      return 'secondary';\r\n    case 'Need Attention':\r\n    case 'About To Sleep':\r\n      return 'warning';\r\n    case 'At Risk':\r\n    case 'Cannot Lose Them':\r\n    case 'Hibernating':\r\n    case 'Lost':\r\n      return 'destructive';\r\n    default:\r\n      return 'secondary';\r\n  }\r\n};\r\n\r\n/**\r\n * Dịch segment sang tiếng Việt\r\n */\r\nexport const getSegmentLabel = (segment: CustomerSegment): string => {\r\n  const labels: Record<CustomerSegment, string> = {\r\n    'Champions': 'Xuất sắc',\r\n    'Loyal Customers': 'Trung thành',\r\n    'Potential Loyalist': 'Tiềm năng cao',\r\n    'New Customers': 'Khách mới',\r\n    'Promising': 'Hứa hẹn',\r\n    'Need Attention': 'Cần quan tâm',\r\n    'About To Sleep': 'Sắp ngủ đông',\r\n    'At Risk': 'Có nguy cơ',\r\n    'Cannot Lose Them': 'Không thể mất',\r\n    'Hibernating': 'Ngủ đông',\r\n    'Lost': 'Đã mất'\r\n  };\r\n  return labels[segment];\r\n};\r\n\r\n/**\r\n * Tính Customer Health Score (0-100)\r\n * Dựa trên 4 yếu tố: Recency, Frequency, Monetary, Payment Behavior\r\n */\r\nexport const calculateHealthScore = (customer: Customer): number => {\r\n  let score = 0;\r\n  \r\n  // 1. Recency - Thời gian mua gần nhất (30 points)\r\n  const daysSinceLastPurchase = customer.lastPurchaseDate \r\n    ? getDaysDiff(getCurrentDate(), new Date(customer.lastPurchaseDate))\r\n    : Infinity;\r\n    \r\n  if (daysSinceLastPurchase <= 7) score += 30;\r\n  else if (daysSinceLastPurchase <= 30) score += 25;\r\n  else if (daysSinceLastPurchase <= 60) score += 20;\r\n  else if (daysSinceLastPurchase <= 90) score += 15;\r\n  else if (daysSinceLastPurchase <= 180) score += 10;\r\n  else if (daysSinceLastPurchase <= 365) score += 5;\r\n  \r\n  // 2. Frequency - Tần suất mua (25 points)\r\n  const totalOrders = customer.totalOrders || 0;\r\n  if (totalOrders >= 20) score += 25;\r\n  else if (totalOrders >= 10) score += 20;\r\n  else if (totalOrders >= 5) score += 15;\r\n  else if (totalOrders >= 3) score += 10;\r\n  else if (totalOrders >= 1) score += 5;\r\n  \r\n  // 3. Monetary - Tổng chi tiêu (30 points)\r\n  const totalSpent = customer.totalSpent || 0;\r\n  if (totalSpent >= 500_000_000) score += 30;\r\n  else if (totalSpent >= 200_000_000) score += 25;\r\n  else if (totalSpent >= 100_000_000) score += 20;\r\n  else if (totalSpent >= 50_000_000) score += 15;\r\n  else if (totalSpent >= 20_000_000) score += 10;\r\n  else if (totalSpent >= 5_000_000) score += 5;\r\n  \r\n  // 4. Payment Behavior - Hành vi thanh toán (15 points)\r\n  // Dựa trên tỷ lệ nợ hiện tại so với hạn mức\r\n  if (customer.maxDebt && customer.maxDebt > 0) {\r\n    const debtRatio = (customer.currentDebt || 0) / customer.maxDebt;\r\n    if (debtRatio <= 0.2) score += 15;\r\n    else if (debtRatio <= 0.4) score += 12;\r\n    else if (debtRatio <= 0.6) score += 8;\r\n    else if (debtRatio <= 0.8) score += 4;\r\n    // > 80% = 0 điểm\r\n  } else {\r\n    // Không có hạn mức công nợ → xem như thanh toán tốt\r\n    score += 15;\r\n  }\r\n  \r\n  return Math.min(100, score);\r\n};\r\n\r\n/**\r\n * Lấy health score level\r\n */\r\nexport const getHealthScoreLevel = (score: number): {\r\n  level: 'excellent' | 'good' | 'fair' | 'poor' | 'critical';\r\n  label: string;\r\n  variant: 'success' | 'default' | 'warning' | 'destructive';\r\n} => {\r\n  if (score >= 80) return { level: 'excellent', label: 'Xuất sắc', variant: 'success' };\r\n  if (score >= 60) return { level: 'good', label: 'Tốt', variant: 'default' };\r\n  if (score >= 40) return { level: 'fair', label: 'Trung bình', variant: 'warning' };\r\n  if (score >= 20) return { level: 'poor', label: 'Yếu', variant: 'destructive' };\r\n  return { level: 'critical', label: 'Nguy hiểm', variant: 'destructive' };\r\n};\r\n\r\n/**\r\n * Dự đoán Churn Risk\r\n */\r\nexport const calculateChurnRisk = (customer: Customer): {\r\n  risk: 'low' | 'medium' | 'high';\r\n  label: string;\r\n  variant: 'success' | 'warning' | 'destructive';\r\n  reason: string;\r\n} => {\r\n  const daysSinceLastPurchase = customer.lastPurchaseDate \r\n    ? getDaysDiff(getCurrentDate(), new Date(customer.lastPurchaseDate))\r\n    : Infinity;\r\n  \r\n  const totalOrders = customer.totalOrders || 0;\r\n  \r\n  // Nếu khách mới (chưa có đơn hoặc chỉ 1 đơn), dùng default 30 ngày\r\n  // Nếu khách cũ, tính dựa trên thời gian từ createdAt đến lastPurchaseDate / số đơn\r\n  let avgDaysBetweenOrders = 30; // Default\r\n  if (totalOrders > 1 && customer.createdAt && customer.lastPurchaseDate) {\r\n    const customerAge = getDaysDiff(new Date(customer.lastPurchaseDate), new Date(customer.createdAt));\r\n    avgDaysBetweenOrders = Math.max(7, customerAge / (totalOrders - 1)); // Tối thiểu 7 ngày\r\n  }\r\n  \r\n  // Khách vừa mua hàng gần đây (< 7 ngày) = low risk\r\n  if (daysSinceLastPurchase <= 7) {\r\n    return {\r\n      risk: 'low',\r\n      label: 'Nguy cơ thấp',\r\n      variant: 'success',\r\n      reason: 'Khách hàng đang hoạt động tốt'\r\n    };\r\n  }\r\n  \r\n  // High risk: Không mua > 2x thời gian trung bình hoặc > 365 ngày\r\n  if (daysSinceLastPurchase > avgDaysBetweenOrders * 2 || daysSinceLastPurchase > 365) {\r\n    return {\r\n      risk: 'high',\r\n      label: 'Nguy cơ cao',\r\n      variant: 'destructive',\r\n      reason: `Không mua hàng ${Math.floor(daysSinceLastPurchase)} ngày, vượt quá 2x chu kỳ trung bình`\r\n    };\r\n  }\r\n  \r\n  // Medium risk: Không mua > 1.5x thời gian trung bình hoặc > 180 ngày\r\n  if (daysSinceLastPurchase > avgDaysBetweenOrders * 1.5 || daysSinceLastPurchase > 180) {\r\n    return {\r\n      risk: 'medium',\r\n      label: 'Nguy cơ trung bình',\r\n      variant: 'warning',\r\n      reason: `Không mua hàng ${Math.floor(daysSinceLastPurchase)} ngày, đang giảm tần suất`\r\n    };\r\n  }\r\n  \r\n  // Low risk\r\n  return {\r\n    risk: 'low',\r\n    label: 'Nguy cơ thấp',\r\n    variant: 'success',\r\n    reason: 'Khách hàng đang hoạt động tốt'\r\n  };\r\n};\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 4576, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/customers/debt-tracking-utils.ts"],"sourcesContent":["import type { Customer, DebtStatus, DebtTransaction } from './types';\r\nimport { formatDate, formatDateTime, formatDateTimeSeconds, formatDateCustom, getCurrentDate, addDays, getDaysDiff, isDateBefore, toISODate } from '@/lib/date-utils';\r\n/**\r\n * Tính ngày đến hạn dựa trên ngày đơn hàng và payment terms\r\n */\r\nexport const calculateDueDate = (orderDate: string, paymentTermsDays: number): string => {\r\n  return toISODate(addDays(new Date(orderDate), paymentTermsDays));\r\n};\r\n\r\n/**\r\n * Parse payment terms string thành số ngày\r\n * \"NET30\" → 30, \"NET15\" → 15, \"COD\" → 0\r\n */\r\nexport const parsePaymentTerms = (paymentTerms?: string): number => {\r\n  if (!paymentTerms) return 0;\r\n  \r\n  const match = paymentTerms.match(/NET(\\d+)/i);\r\n  if (match) {\r\n    return parseInt(match[1], 10);\r\n  }\r\n  \r\n  if (paymentTerms.toUpperCase() === 'COD') {\r\n    return 0; // COD = thanh toán ngay\r\n  }\r\n  \r\n  return 30; // Default 30 ngày\r\n};\r\n\r\n/**\r\n * Tính số ngày quá hạn (nếu > 0 thì quá hạn)\r\n */\r\nexport const calculateDaysOverdue = (dueDate: string): number => {\r\n  const days = getDaysDiff(getCurrentDate(), new Date(dueDate));\r\n  return days > 0 ? days : 0;\r\n};\r\n\r\n/**\r\n * Tính số ngày còn lại đến hạn (nếu > 0 thì chưa đến hạn)\r\n */\r\nexport const calculateDaysUntilDue = (dueDate: string): number => {\r\n  return getDaysDiff(new Date(dueDate), getCurrentDate());\r\n};\r\n\r\n/**\r\n * Phân loại trạng thái công nợ dựa trên ngày đến hạn\r\n */\r\nexport const getDebtStatus = (dueDate: string, hasDebt: boolean): DebtStatus | null => {\r\n  if (!hasDebt) return null;\r\n  \r\n  const daysUntilDue = calculateDaysUntilDue(dueDate);\r\n  \r\n  // Chưa đến hạn\r\n  if (daysUntilDue > 3) return \"Chưa đến hạn\";\r\n  \r\n  // Sắp đến hạn (1-3 ngày)\r\n  if (daysUntilDue >= 1 && daysUntilDue <= 3) return \"Sắp đến hạn\";\r\n  \r\n  // Đến hạn hôm nay\r\n  if (daysUntilDue === 0) return \"Đến hạn hôm nay\";\r\n  \r\n  // Quá hạn\r\n  const daysOverdue = Math.abs(daysUntilDue);\r\n  \r\n  if (daysOverdue >= 1 && daysOverdue <= 7) return \"Quá hạn 1-7 ngày\";\r\n  if (daysOverdue >= 8 && daysOverdue <= 15) return \"Quá hạn 8-15 ngày\";\r\n  if (daysOverdue >= 16 && daysOverdue <= 30) return \"Quá hạn 16-30 ngày\";\r\n  \r\n  return \"Quá hạn > 30 ngày\";\r\n};\r\n\r\n/**\r\n * Lấy variant cho badge trạng thái công nợ\r\n */\r\nexport const getDebtStatusVariant = (status?: DebtStatus | null): \r\n  'default' | 'secondary' | 'success' | 'warning' | 'destructive' => {\r\n  if (!status) return 'secondary';\r\n  \r\n  switch (status) {\r\n    case \"Chưa đến hạn\":\r\n      return \"secondary\";\r\n    case \"Sắp đến hạn\":\r\n      return \"default\";\r\n    case \"Đến hạn hôm nay\":\r\n      return \"warning\";\r\n    case \"Quá hạn 1-7 ngày\":\r\n      return \"warning\";\r\n    case \"Quá hạn 8-15 ngày\":\r\n    case \"Quá hạn 16-30 ngày\":\r\n    case \"Quá hạn > 30 ngày\":\r\n      return \"destructive\";\r\n    default:\r\n      return \"secondary\";\r\n  }\r\n};\r\n\r\n/**\r\n * Tính toán debt tracking info cho customer\r\n */\r\nexport const calculateDebtTrackingInfo = (customer: Customer): {\r\n  oldestDebtDueDate?: string;\r\n  maxDaysOverdue: number;\r\n  debtStatus?: DebtStatus | null;\r\n} => {\r\n  const debtTransactions = customer.debtTransactions || [];\r\n  const unpaidTransactions = debtTransactions.filter(t => !t.isPaid);\r\n  \r\n  if (unpaidTransactions.length === 0 || !customer.currentDebt || customer.currentDebt === 0) {\r\n    return {\r\n      maxDaysOverdue: 0,\r\n      debtStatus: null\r\n    };\r\n  }\r\n  \r\n  // Tìm giao dịch có dueDate sớm nhất (nợ lâu nhất)\r\n  const oldestTransaction = unpaidTransactions.reduce((oldest, current) => {\r\n    return isDateBefore(new Date(current.dueDate), new Date(oldest.dueDate)) ? current : oldest;\r\n  });\r\n  \r\n  const oldestDebtDueDate = oldestTransaction.dueDate;\r\n  const maxDaysOverdue = calculateDaysOverdue(oldestDebtDueDate);\r\n  const debtStatus = getDebtStatus(oldestDebtDueDate, true);\r\n  \r\n  return {\r\n    oldestDebtDueDate,\r\n    maxDaysOverdue,\r\n    debtStatus\r\n  };\r\n};\r\n\r\n/**\r\n * Lấy danh sách khách hàng có nợ quá hạn, sắp xếp theo mức độ ưu tiên\r\n */\r\nexport const getOverdueDebtCustomers = (customers: Customer[]): Customer[] => {\r\n  return customers\r\n    .filter(c => {\r\n      const info = calculateDebtTrackingInfo(c);\r\n      return info.maxDaysOverdue > 0; // Chỉ lấy KH quá hạn\r\n    })\r\n    .sort((a, b) => {\r\n      const infoA = calculateDebtTrackingInfo(a);\r\n      const infoB = calculateDebtTrackingInfo(b);\r\n      \r\n      // Sắp xếp theo số ngày quá hạn (giảm dần)\r\n      return (infoB.maxDaysOverdue || 0) - (infoA.maxDaysOverdue || 0);\r\n    });\r\n};\r\n\r\n/**\r\n * Lấy danh sách khách hàng sắp đến hạn thanh toán (1-3 ngày)\r\n */\r\nexport const getDueSoonCustomers = (customers: Customer[]): Customer[] => {\r\n  return customers\r\n    .filter(c => {\r\n      const info = calculateDebtTrackingInfo(c);\r\n      if (!info.oldestDebtDueDate) return false;\r\n      \r\n      const daysUntil = calculateDaysUntilDue(info.oldestDebtDueDate);\r\n      return daysUntil >= 1 && daysUntil <= 3;\r\n    })\r\n    .sort((a, b) => {\r\n      const infoA = calculateDebtTrackingInfo(a);\r\n      const infoB = calculateDebtTrackingInfo(b);\r\n      \r\n      const daysA = infoA.oldestDebtDueDate ? calculateDaysUntilDue(infoA.oldestDebtDueDate) : 999;\r\n      const daysB = infoB.oldestDebtDueDate ? calculateDaysUntilDue(infoB.oldestDebtDueDate) : 999;\r\n      \r\n      return daysA - daysB; // Sắp xếp theo ngày đến hạn (tăng dần)\r\n    });\r\n};\r\n\r\n/**\r\n * Tính tổng công nợ quá hạn\r\n */\r\nexport const calculateTotalOverdueDebt = (customers: Customer[]): number => {\r\n  return getOverdueDebtCustomers(customers).reduce((sum, c) => sum + (c.currentDebt || 0), 0);\r\n};\r\n\r\n/**\r\n * Tính tổng công nợ sắp đến hạn\r\n */\r\nexport const calculateTotalDueSoonDebt = (customers: Customer[]): number => {\r\n  return getDueSoonCustomers(customers).reduce((sum, c) => sum + (c.currentDebt || 0), 0);\r\n};\r\n\r\n/**\r\n * Format ngày hiển thị\r\n */\r\nexport const formatDebtDate = (dateString?: string): string => {\r\n  if (!dateString) return '-';\r\n  return formatDate(dateString);\r\n};\r\n\r\n/**\r\n * Helper format currency\r\n */\r\nexport const formatCurrency = (value?: number): string => {\r\n  if (typeof value !== 'number') return '0 ₫';\r\n  return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(value);\r\n};\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 4733, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/customers/store.ts"],"sourcesContent":["import { create } from 'zustand';\r\nimport { createCrudStore, CrudState } from '../../lib/store-factory';\r\n// REMOVED: import { data as initialData } from './data'; // Mock data no longer used - database is source of truth\r\nimport type { Customer } from './types';\r\nimport { SystemId, BusinessId } from '../../lib/id-types';\r\nimport { calculateLifecycleStage } from './lifecycle-utils';\r\nimport { getHighRiskDebtCustomers } from './credit-utils';\r\nimport { \r\n  calculateRFMScores, \r\n  getCustomerSegment, \r\n  calculateHealthScore,\r\n  calculateChurnRisk \r\n} from './intelligence-utils';\r\nimport { getOverdueDebtCustomers, getDueSoonCustomers } from './debt-tracking-utils';\r\nimport Fuse from 'fuse.js';\r\nimport { getCurrentUserSystemId } from '../../contexts/auth-context';\r\nimport {\r\n  getCurrentUserInfo,\r\n  createCreatedEntry,\r\n  createUpdatedEntry,\r\n  createStatusChangedEntry,\r\n  appendHistoryEntry,\r\n  type HistoryEntry\r\n} from '../../lib/activity-history-helper';\r\n\r\nconst baseStore = createCrudStore<Customer>([], 'customers', {\r\n  businessIdField: 'id',\r\n  getCurrentUser: getCurrentUserSystemId, // Track who creates/updates\r\n  apiEndpoint: '/api/customers',\r\n});\r\n\r\n// ✅ API Sync helpers\r\nconst API_ENDPOINT = '/api/customers';\r\n\r\nconst syncToApi = {\r\n  create: async (customer: Customer) => {\r\n    try {\r\n      const response = await fetch(API_ENDPOINT, {\r\n        method: 'POST',\r\n        credentials: 'include',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify(customer),\r\n      });\r\n      if (!response.ok) console.warn('[Customer API] Create sync failed');\r\n      else console.log('[Customer API] Created:', customer.systemId);\r\n    } catch (e) {\r\n      console.warn('[Customer API] Create sync error:', e);\r\n    }\r\n  },\r\n  update: async (systemId: SystemId, updates: Partial<Customer>) => {\r\n    try {\r\n      const response = await fetch(`${API_ENDPOINT}/${systemId}`, {\r\n        method: 'PATCH',\r\n        credentials: 'include',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify(updates),\r\n      });\r\n      if (!response.ok) console.warn('[Customer API] Update sync failed');\r\n      else console.log('[Customer API] Updated:', systemId);\r\n    } catch (e) {\r\n      console.warn('[Customer API] Update sync error:', e);\r\n    }\r\n  },\r\n  delete: async (systemId: SystemId, hard = false) => {\r\n    try {\r\n      const response = await fetch(`${API_ENDPOINT}/${systemId}`, {\r\n        method: 'DELETE',\r\n        credentials: 'include',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({ hard }),\r\n      });\r\n      if (!response.ok) console.warn('[Customer API] Delete sync failed');\r\n      else console.log('[Customer API] Deleted:', systemId);\r\n    } catch (e) {\r\n      console.warn('[Customer API] Delete sync error:', e);\r\n    }\r\n  },\r\n  restore: async (systemId: SystemId) => {\r\n    try {\r\n      const response = await fetch(`${API_ENDPOINT}/${systemId}/restore`, {\r\n        method: 'POST',\r\n        credentials: 'include',\r\n        headers: { 'Content-Type': 'application/json' },\r\n      });\r\n      if (!response.ok) console.warn('[Customer API] Restore sync failed');\r\n      else console.log('[Customer API] Restored:', systemId);\r\n    } catch (e) {\r\n      console.warn('[Customer API] Restore sync error:', e);\r\n    }\r\n  },\r\n};\r\n\r\n// ✅ Wrap base store methods with API sync\r\nconst originalAdd = baseStore.getState().add;\r\nconst originalUpdate = baseStore.getState().update;\r\nconst originalRemove = baseStore.getState().remove;\r\nconst originalHardDelete = baseStore.getState().hardDelete;\r\nconst originalRestore = baseStore.getState().restore;\r\n\r\nbaseStore.setState({\r\n  add: (item: Omit<Customer, 'systemId'>) => {\r\n    const result = originalAdd(item);\r\n    syncToApi.create(result);\r\n    return result;\r\n  },\r\n  update: (systemId: SystemId, updates: Partial<Customer>) => {\r\n    originalUpdate(systemId, updates);\r\n    syncToApi.update(systemId, updates);\r\n  },\r\n  remove: (systemId: SystemId) => {\r\n    originalRemove(systemId);\r\n    syncToApi.delete(systemId, false);\r\n  },\r\n  hardDelete: (systemId: SystemId) => {\r\n    originalHardDelete(systemId);\r\n    syncToApi.delete(systemId, true);\r\n  },\r\n  restore: (systemId: SystemId) => {\r\n    originalRestore(systemId);\r\n    syncToApi.restore(systemId);\r\n  },\r\n});\r\n\r\n// Define enhanced interface\r\ninterface CustomerStoreState extends CrudState<Customer> {\r\n  searchCustomers: (query: string, page: number, limit?: number) => Promise<{ items: { value: string; label: string }[], hasNextPage: boolean }>;\r\n  updateDebt: (systemId: SystemId, amountChange: number) => void;\r\n  incrementOrderStats: (systemId: SystemId, orderValue: number) => void;\r\n  decrementOrderStats: (systemId: SystemId, orderValue: number) => void;\r\n  incrementReturnStats: (systemId: SystemId, quantity: number) => void;\r\n  incrementFailedDeliveryStats: (systemId: SystemId) => void;\r\n  addDebtTransaction: (systemId: SystemId, transaction: import('./types').DebtTransaction) => void;\r\n  addDebtReminder: (systemId: SystemId, reminder: import('./types').DebtReminder) => void;\r\n  updateDebtReminder: (systemId: SystemId, reminderId: SystemId, updates: Partial<import('./types').DebtReminder>) => void;\r\n  removeDebtReminder: (systemId: SystemId, reminderId: SystemId) => void;\r\n  updateDebtTransactionPayment: (systemId: SystemId, orderId: BusinessId, amountPaid: number) => void;\r\n  removeDebtTransaction: (systemId: SystemId, orderId: BusinessId) => void;\r\n  getHighRiskDebtCustomers: () => Customer[];\r\n  updateCustomerIntelligence: () => void; // Batch update RFM, health score, churn risk\r\n  getCustomersBySegment: (segment: string) => Customer[];\r\n  getOverdueDebtCustomers: () => Customer[];\r\n  getDueSoonCustomers: () => Customer[];\r\n    removeMany: (systemIds: SystemId[]) => void;\r\n    updateManyStatus: (systemIds: SystemId[], status: Customer['status']) => void;\r\n    restoreMany: (systemIds: SystemId[]) => void;\r\n}\r\n\r\n// Augmented methods\r\nconst augmentedMethods = {\r\n    searchCustomers: async (query: string, page: number, limit: number = 20) => {\r\n        return new Promise<{ items: { value: string; label: string }[], hasNextPage: boolean }>(resolve => {\r\n            setTimeout(() => {\r\n                const allCustomers = baseStore.getState().data;\r\n                \r\n                // Create fresh Fuse instance with current data (avoid stale data)\r\n                const fuse = new Fuse(allCustomers, {\r\n                    keys: ['name', 'id', 'phone'],\r\n                    threshold: 0.3,\r\n                });\r\n                \r\n                const results = query ? fuse.search(query).map(r => r.item) : allCustomers;\r\n                \r\n                const start = (page - 1) * limit;\r\n                const end = start + limit;\r\n                const paginatedItems = results.slice(start, end);\r\n\r\n                resolve({\r\n                    items: paginatedItems.map(c => ({ value: c.systemId, label: c.name })),\r\n                    hasNextPage: end < results.length,\r\n                });\r\n            }, 300);\r\n        });\r\n    },\r\n    updateDebt: (systemId: SystemId, amountChange: number) => {\r\n        baseStore.setState(state => ({\r\n            data: state.data.map(customer => {\r\n                if (customer.systemId === systemId) {\r\n                    const newDebt = (customer.currentDebt || 0) + amountChange;\r\n                    // Sync to API\r\n                    syncToApi.update(systemId, { currentDebt: newDebt });\r\n                    return {\r\n                        ...customer,\r\n                        currentDebt: newDebt,\r\n                    };\r\n                }\r\n                return customer;\r\n            })\r\n        }));\r\n    },\r\n    incrementOrderStats: (systemId: SystemId, orderValue: number) => {\r\n        const allCustomers = baseStore.getState().getActive();\r\n        \r\n        baseStore.setState(state => ({\r\n            data: state.data.map(customer => {\r\n                if (customer.systemId === systemId) {\r\n                    const updatedCustomer = {\r\n                        ...customer,\r\n                        totalOrders: (customer.totalOrders || 0) + 1,\r\n                        totalSpent: (customer.totalSpent || 0) + orderValue,\r\n                        lastPurchaseDate: new Date().toISOString().split('T')[0],\r\n                    };\r\n                    \r\n                    // Auto-update intelligence after order stats change\r\n                    const rfmScores = calculateRFMScores(updatedCustomer, allCustomers);\r\n                    const segment = getCustomerSegment(rfmScores);\r\n                    const healthScore = calculateHealthScore(updatedCustomer);\r\n                    const churnRisk = calculateChurnRisk(updatedCustomer).risk;\r\n                    const lifecycleStage = calculateLifecycleStage(updatedCustomer);\r\n                    \r\n                    return {\r\n                        ...updatedCustomer,\r\n                        rfmScores,\r\n                        segment,\r\n                        healthScore,\r\n                        churnRisk,\r\n                        lifecycleStage,\r\n                    };\r\n                }\r\n                return customer;\r\n            })\r\n        }));\r\n    },\r\n    decrementOrderStats: (systemId: SystemId, orderValue: number) => {\r\n        const allCustomers = baseStore.getState().getActive();\r\n        \r\n        baseStore.setState(state => ({\r\n            data: state.data.map(customer => {\r\n                if (customer.systemId === systemId) {\r\n                    const updatedCustomer = {\r\n                        ...customer,\r\n                        totalOrders: Math.max(0, (customer.totalOrders || 0) - 1),\r\n                        totalSpent: Math.max(0, (customer.totalSpent || 0) - orderValue),\r\n                    };\r\n                    \r\n                    // Auto-update intelligence after order stats change\r\n                    const rfmScores = calculateRFMScores(updatedCustomer, allCustomers);\r\n                    const segment = getCustomerSegment(rfmScores);\r\n                    const healthScore = calculateHealthScore(updatedCustomer);\r\n                    const churnRisk = calculateChurnRisk(updatedCustomer).risk;\r\n                    const lifecycleStage = calculateLifecycleStage(updatedCustomer);\r\n                    \r\n                    return {\r\n                        ...updatedCustomer,\r\n                        rfmScores,\r\n                        segment,\r\n                        healthScore,\r\n                        churnRisk,\r\n                        lifecycleStage,\r\n                    };\r\n                }\r\n                return customer;\r\n            })\r\n        }));\r\n    },\r\n    incrementReturnStats: (systemId: SystemId, quantity: number) => {\r\n        baseStore.setState(state => ({\r\n            data: state.data.map(customer => {\r\n                if (customer.systemId === systemId) {\r\n                    return {\r\n                        ...customer,\r\n                        totalQuantityReturned: (customer.totalQuantityReturned || 0) + quantity,\r\n                    };\r\n                }\r\n                return customer;\r\n            })\r\n        }));\r\n    },\r\n    incrementFailedDeliveryStats: (systemId: SystemId) => {\r\n        baseStore.setState(state => ({\r\n            data: state.data.map(customer => {\r\n                if (customer.systemId === systemId) {\r\n                    return {\r\n                        ...customer,\r\n                        failedDeliveries: (customer.failedDeliveries || 0) + 1,\r\n                    };\r\n                }\r\n                return customer;\r\n            })\r\n        }));\r\n    },\r\n    addDebtTransaction: (systemId: SystemId, transaction: import('./types').DebtTransaction) => {\r\n        baseStore.setState(state => ({\r\n            data: state.data.map(customer => {\r\n                if (customer.systemId === systemId) {\r\n                    const currentTransactions = customer.debtTransactions || [];\r\n                    // Avoid duplicates\r\n                    if (currentTransactions.some(t => t.orderId === transaction.orderId)) {\r\n                        return customer;\r\n                    }\r\n\r\n                    const outstandingAmount = Math.max(transaction.remainingAmount ?? transaction.amount ?? 0, 0);\r\n                    return {\r\n                        ...customer,\r\n                        currentDebt: Math.max(0, (customer.currentDebt || 0) + outstandingAmount),\r\n                        debtTransactions: [...currentTransactions, transaction],\r\n                    };\r\n                }\r\n                return customer;\r\n            })\r\n        }));\r\n    },\r\n    updateDebtTransactionPayment: (systemId: SystemId, orderId: BusinessId, amountPaid: number) => {\r\n        baseStore.setState(state => ({\r\n            data: state.data.map(customer => {\r\n                if (customer.systemId === systemId && customer.debtTransactions) {\r\n                    let debtDelta = 0;\r\n                    const updatedTransactions = customer.debtTransactions.map(t => {\r\n                        if (t.orderId !== orderId) {\r\n                            return t;\r\n                        }\r\n\r\n                        const currentPaid = t.paidAmount || 0;\r\n                        const currentRemaining = t.remainingAmount ?? Math.max(t.amount - currentPaid, 0);\r\n                        let appliedAmount = amountPaid;\r\n\r\n                        if (appliedAmount > 0) {\r\n                            appliedAmount = Math.min(appliedAmount, currentRemaining);\r\n                        } else if (appliedAmount < 0) {\r\n                            appliedAmount = Math.max(appliedAmount, -currentPaid);\r\n                        }\r\n\r\n                        const newPaidAmount = currentPaid + appliedAmount;\r\n                        const recalculatedRemaining = Math.max(t.amount - newPaidAmount, 0);\r\n                        debtDelta -= appliedAmount;\r\n\r\n                        return {\r\n                            ...t,\r\n                            paidAmount: newPaidAmount,\r\n                            remainingAmount: recalculatedRemaining,\r\n                            isPaid: recalculatedRemaining <= 0,\r\n                            paidDate: recalculatedRemaining <= 0 ? new Date().toISOString().split('T')[0] : t.paidDate,\r\n                        };\r\n                    });\r\n\r\n                    return {\r\n                        ...customer,\r\n                        currentDebt: Math.max(0, (customer.currentDebt || 0) + debtDelta),\r\n                        debtTransactions: updatedTransactions,\r\n                    };\r\n                }\r\n                return customer;\r\n            })\r\n        }));\r\n    },\r\n    removeDebtTransaction: (systemId: SystemId, orderId: BusinessId) => {\r\n        baseStore.setState(state => ({\r\n            data: state.data.map(customer => {\r\n                if (customer.systemId === systemId && customer.debtTransactions) {\r\n                    const transaction = customer.debtTransactions.find(t => t.orderId === orderId);\r\n                    const outstanding = transaction\r\n                        ? Math.max(transaction.remainingAmount ?? (transaction.amount - (transaction.paidAmount || 0)), 0)\r\n                        : 0;\r\n                    return {\r\n                        ...customer,\r\n                        currentDebt: Math.max(0, (customer.currentDebt || 0) - outstanding),\r\n                        debtTransactions: customer.debtTransactions.filter(t => t.orderId !== orderId),\r\n                    };\r\n                }\r\n                return customer;\r\n            })\r\n        }));\r\n    },\r\n    // Add debt reminder (3.3)\r\n    addDebtReminder: (systemId: SystemId, reminder: import('./types').DebtReminder) => {\r\n        baseStore.setState(state => ({\r\n            data: state.data.map(customer => {\r\n                if (customer.systemId === systemId) {\r\n                    const currentReminders = customer.debtReminders || [];\r\n                    return {\r\n                        ...customer,\r\n                        debtReminders: [...currentReminders, reminder],\r\n                    };\r\n                }\r\n                return customer;\r\n            })\r\n        }));\r\n    },\r\n    // Update debt reminder (3.3)\r\n    updateDebtReminder: (systemId: SystemId, reminderId: SystemId, updates: Partial<import('./types').DebtReminder>) => {\r\n        baseStore.setState(state => ({\r\n            data: state.data.map(customer => {\r\n                if (customer.systemId === systemId && customer.debtReminders) {\r\n                    return {\r\n                        ...customer,\r\n                        debtReminders: customer.debtReminders.map(r =>\r\n                            r.systemId === reminderId ? { ...r, ...updates } : r\r\n                        ),\r\n                    };\r\n                }\r\n                return customer;\r\n            })\r\n        }));\r\n    },\r\n    // Remove debt reminder (3.3)\r\n    removeDebtReminder: (systemId: SystemId, reminderId: SystemId) => {\r\n        baseStore.setState(state => ({\r\n            data: state.data.map(customer => {\r\n                if (customer.systemId === systemId && customer.debtReminders) {\r\n                    return {\r\n                        ...customer,\r\n                        debtReminders: customer.debtReminders.filter(r => r.systemId !== reminderId),\r\n                    };\r\n                }\r\n                return customer;\r\n            })\r\n        }));\r\n    },\r\n    // Override add to auto-calculate lifecycle stage and log activity\r\n    add: (customer: Omit<Customer, 'systemId'>) => {\r\n        const userInfo = getCurrentUserInfo();\r\n        const customerWithLifecycle = {\r\n            ...customer,\r\n            lifecycleStage: calculateLifecycleStage(customer as Customer)\r\n        };\r\n        const newCustomer = baseStore.getState().add(customerWithLifecycle);\r\n        \r\n        // Add activity history entry\r\n        const historyEntry = createCreatedEntry(\r\n            userInfo,\r\n            `${userInfo.name} đã tạo khách hàng ${newCustomer.name} (${newCustomer.id})`\r\n        );\r\n        baseStore.getState().update(newCustomer.systemId, {\r\n            ...newCustomer,\r\n            activityHistory: [historyEntry]\r\n        });\r\n        \r\n        return newCustomer;\r\n    },\r\n    // Override update to auto-calculate lifecycle stage and log activity\r\n    update: (systemId: SystemId, updatedCustomer: Customer) => {\r\n        console.log('[CustomerStore] update called:', { systemId, updatedCustomer });\r\n        \r\n        const userInfo = getCurrentUserInfo();\r\n        const existingCustomer = baseStore.getState().data.find(c => c.systemId === systemId);\r\n        const historyEntries: HistoryEntry[] = [];\r\n        \r\n        if (existingCustomer) {\r\n            // Track status changes\r\n            if (existingCustomer.status !== updatedCustomer.status) {\r\n                historyEntries.push(createStatusChangedEntry(\r\n                    userInfo,\r\n                    existingCustomer.status,\r\n                    updatedCustomer.status,\r\n                    `${userInfo.name} đã đổi trạng thái từ \"${existingCustomer.status}\" sang \"${updatedCustomer.status}\"`\r\n                ));\r\n            }\r\n            \r\n            // Track field changes\r\n            const fieldsToTrack: Array<{ key: keyof Customer; label: string }> = [\r\n                { key: 'name', label: 'Tên khách hàng' },\r\n                { key: 'email', label: 'Email' },\r\n                { key: 'phone', label: 'Số điện thoại' },\r\n                { key: 'company', label: 'Công ty' },\r\n                { key: 'taxCode', label: 'Mã số thuế' },\r\n                { key: 'representative', label: 'Người đại diện' },\r\n                { key: 'type', label: 'Loại khách hàng' },\r\n                { key: 'customerGroup', label: 'Nhóm khách hàng' },\r\n                { key: 'lifecycleStage', label: 'Giai đoạn vòng đời' },\r\n                { key: 'maxDebt', label: 'Hạn mức công nợ' },\r\n                { key: 'paymentTerms', label: 'Điều khoản thanh toán' },\r\n                { key: 'creditRating', label: 'Xếp hạng tín dụng' },\r\n                { key: 'pricingLevel', label: 'Mức giá' },\r\n                { key: 'defaultDiscount', label: 'Chiết khấu mặc định' },\r\n                { key: 'accountManagerId', label: 'Nhân viên phụ trách' },\r\n            ];\r\n            \r\n            const changes: string[] = [];\r\n            for (const field of fieldsToTrack) {\r\n                const oldVal = existingCustomer[field.key];\r\n                const newVal = updatedCustomer[field.key];\r\n                if (oldVal !== newVal && !(oldVal === undefined && newVal === undefined)) {\r\n                    // Skip if it's the status field (already tracked above)\r\n                    if (field.key === 'status') continue;\r\n                    const oldDisplay = oldVal !== undefined && oldVal !== null && oldVal !== '' ? String(oldVal) : '(trống)';\r\n                    const newDisplay = newVal !== undefined && newVal !== null && newVal !== '' ? String(newVal) : '(trống)';\r\n                    changes.push(`${field.label}: ${oldDisplay} → ${newDisplay}`);\r\n                }\r\n            }\r\n            \r\n            if (changes.length > 0) {\r\n                historyEntries.push(createUpdatedEntry(\r\n                    userInfo,\r\n                    `${userInfo.name} đã cập nhật: ${changes.join(', ')}`\r\n                ));\r\n            }\r\n        }\r\n        \r\n        const customerWithLifecycle = {\r\n            ...updatedCustomer,\r\n            lifecycleStage: calculateLifecycleStage(updatedCustomer),\r\n            activityHistory: appendHistoryEntry(existingCustomer?.activityHistory, ...historyEntries)\r\n        };\r\n        console.log('[CustomerStore] Calling baseStore.update with:', customerWithLifecycle);\r\n        \r\n        // Call the update function from baseStore directly\r\n        baseStore.getState().update(systemId, customerWithLifecycle);\r\n        \r\n        console.log('[CustomerStore] State after update:', baseStore.getState().data.find(c => c.systemId === systemId));\r\n    },\r\n    // Get customers with high debt risk\r\n    getHighRiskDebtCustomers: () => {\r\n        const activeCustomers = baseStore.getState().getActive();\r\n        return getHighRiskDebtCustomers(activeCustomers);\r\n    },\r\n    // Batch update customer intelligence (RFM, health score, churn risk)\r\n    updateCustomerIntelligence: () => {\r\n        const allCustomers = baseStore.getState().getActive();\r\n        \r\n        baseStore.setState(state => ({\r\n            data: state.data.map(customer => {\r\n                if (customer.isDeleted) return customer;\r\n                \r\n                // Calculate RFM\r\n                const rfmScores = calculateRFMScores(customer, allCustomers);\r\n                const segment = getCustomerSegment(rfmScores);\r\n                \r\n                // Calculate health score\r\n                const healthScore = calculateHealthScore(customer);\r\n                \r\n                // Calculate churn risk\r\n                const churnRisk = calculateChurnRisk(customer).risk;\r\n                \r\n                // Calculate lifecycle stage\r\n                const lifecycleStage = calculateLifecycleStage(customer);\r\n                \r\n                return {\r\n                    ...customer,\r\n                    rfmScores,\r\n                    segment,\r\n                    healthScore,\r\n                    churnRisk,\r\n                    lifecycleStage\r\n                };\r\n            })\r\n        }));\r\n    },\r\n    // Get customers by segment\r\n    getCustomersBySegment: (segment: string) => {\r\n        return baseStore.getState().getActive().filter(c => c.segment === segment);\r\n    },\r\n    // Get customers with overdue debt\r\n    getOverdueDebtCustomers: () => {\r\n        const activeCustomers = baseStore.getState().getActive();\r\n        return getOverdueDebtCustomers(activeCustomers);\r\n    },\r\n    // Get customers with debt due soon\r\n    getDueSoonCustomers: () => {\r\n        const activeCustomers = baseStore.getState().getActive();\r\n        return getDueSoonCustomers(activeCustomers);\r\n    },\r\n    removeMany: (systemIds: SystemId[]) => {\r\n        if (!systemIds.length) return;\r\n        const deletedAtTimestamp = new Date().toISOString();\r\n        baseStore.setState(state => ({\r\n            data: state.data.map(customer =>\r\n                systemIds.includes(customer.systemId)\r\n                    ? { ...customer, isDeleted: true, deletedAt: deletedAtTimestamp }\r\n                    : customer\r\n            )\r\n        }));\r\n    },\r\n    updateManyStatus: (systemIds: SystemId[], status: Customer['status']) => {\r\n        if (!systemIds.length) return;\r\n        baseStore.setState(state => ({\r\n            data: state.data.map(customer =>\r\n                systemIds.includes(customer.systemId)\r\n                    ? { ...customer, status }\r\n                    : customer\r\n            )\r\n        }));\r\n    },\r\n    restoreMany: (systemIds: SystemId[]) => {\r\n        if (!systemIds.length) return;\r\n        baseStore.setState(state => ({\r\n            data: state.data.map(customer =>\r\n                systemIds.includes(customer.systemId)\r\n                    ? { ...customer, isDeleted: false, deletedAt: null }\r\n                    : customer\r\n            )\r\n        }));\r\n    }\r\n};\r\n\r\ntype CustomerStoreSelector<T> = (state: CustomerStoreState) => T;\r\n\r\nlet cachedBaseState: CrudState<Customer> | null = null;\r\nlet cachedCombinedState: CustomerStoreState | null = null;\r\n\r\nconst getCombinedState = (state: CrudState<Customer>): CustomerStoreState => {\r\n    if (cachedBaseState !== state || !cachedCombinedState) {\r\n        cachedBaseState = state;\r\n        cachedCombinedState = { ...state, ...augmentedMethods } as CustomerStoreState;\r\n    }\r\n    return cachedCombinedState!;\r\n};\r\n\r\nconst boundStore = baseStore as unknown as {\r\n    <R>(selector: (state: CrudState<Customer>) => R, equalityFn?: (a: R, b: R) => boolean): R;\r\n    (): CustomerStoreState;\r\n};\r\n\r\nexport const useCustomerStore = <T = CustomerStoreState>(\r\n    selector?: CustomerStoreSelector<T>,\r\n    equalityFn?: (a: T, b: T) => boolean\r\n): T => {\r\n    if (selector) {\r\n        if (equalityFn) {\r\n            return boundStore((state) => selector(getCombinedState(state)), equalityFn);\r\n        }\r\n        return boundStore((state) => selector(getCombinedState(state)));\r\n    }\r\n    return boundStore((state) => getCombinedState(state) as unknown as T);\r\n};\r\n\r\nuseCustomerStore.getState = (): CustomerStoreState => {\r\n    return getCombinedState(baseStore.getState());\r\n};\r\n"],"names":[],"mappings":"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"}}]
}