{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/products/store.ts"],"sourcesContent":["import { createCrudStore, CrudState } from '../../lib/store-factory';\r\n// REMOVED: import { data as initialData } from './data'; // Mock data no longer used - database is source of truth\r\nimport type { Product } from './types';\r\nimport { type SystemId } from '@/lib/id-types';\r\nimport { asSystemId, asBusinessId } from '../../lib/id-types';\r\nimport { getCurrentUserSystemId } from '../../contexts/auth-context';\r\nimport Fuse from 'fuse.js';\r\nimport {\r\n  getCurrentUserInfo,\r\n  createCreatedEntry,\r\n  createUpdatedEntry,\r\n  createStatusChangedEntry,\r\n  appendHistoryEntry,\r\n  type HistoryEntry\r\n} from '../../lib/activity-history-helper';\r\n\r\nconst baseStore = createCrudStore<Product>([], 'products', {\r\n  businessIdField: 'id',\r\n  getCurrentUser: getCurrentUserSystemId, // ‚úÖ Track who creates/updates\r\n  apiEndpoint: '/api/products',\r\n});\r\n\r\n// ‚úÖ API Sync helpers\r\nconst API_ENDPOINT = '/api/products';\r\n\r\nconst syncToApi = {\r\n  create: async (product: Product) => {\r\n    try {\r\n      const response = await fetch(API_ENDPOINT, {\r\n        method: 'POST',\r\n        credentials: 'include',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify(product),\r\n      });\r\n      if (!response.ok) console.warn('[Product API] Create sync failed');\r\n      else console.log('[Product API] Created:', product.systemId);\r\n    } catch (e) {\r\n      console.warn('[Product API] Create sync error:', e);\r\n    }\r\n  },\r\n  update: async (systemId: SystemId, updates: Partial<Product>) => {\r\n    try {\r\n      const response = await fetch(`${API_ENDPOINT}/${systemId}`, {\r\n        method: 'PATCH',\r\n        credentials: 'include',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify(updates),\r\n      });\r\n      if (!response.ok) console.warn('[Product API] Update sync failed');\r\n      else console.log('[Product API] Updated:', systemId);\r\n    } catch (e) {\r\n      console.warn('[Product API] Update sync error:', e);\r\n    }\r\n  },\r\n  delete: async (systemId: SystemId, hard = false) => {\r\n    try {\r\n      const response = await fetch(`${API_ENDPOINT}/${systemId}`, {\r\n        method: 'DELETE',\r\n        credentials: 'include',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({ hard }),\r\n      });\r\n      if (!response.ok) console.warn('[Product API] Delete sync failed');\r\n      else console.log('[Product API] Deleted:', systemId);\r\n    } catch (e) {\r\n      console.warn('[Product API] Delete sync error:', e);\r\n    }\r\n  },\r\n  restore: async (systemId: SystemId) => {\r\n    try {\r\n      const response = await fetch(`${API_ENDPOINT}/${systemId}/restore`, {\r\n        method: 'POST',\r\n        credentials: 'include',\r\n        headers: { 'Content-Type': 'application/json' },\r\n      });\r\n      if (!response.ok) console.warn('[Product API] Restore sync failed');\r\n      else console.log('[Product API] Restored:', systemId);\r\n    } catch (e) {\r\n      console.warn('[Product API] Restore sync error:', e);\r\n    }\r\n  },\r\n};\r\n\r\n// ‚úÖ Wrap base store methods with API sync\r\nconst originalAdd = baseStore.getState().add;\r\nconst originalUpdate = baseStore.getState().update;\r\nconst originalRemove = baseStore.getState().remove;\r\nconst originalHardDelete = baseStore.getState().hardDelete;\r\nconst originalRestore = baseStore.getState().restore;\r\n\r\nbaseStore.setState({\r\n  add: (item: Omit<Product, 'systemId'>) => {\r\n    const result = originalAdd(item);\r\n    syncToApi.create(result);\r\n    return result;\r\n  },\r\n  update: (systemId: SystemId, updates: Partial<Product>) => {\r\n    originalUpdate(systemId, updates);\r\n    syncToApi.update(systemId, updates);\r\n  },\r\n  remove: (systemId: SystemId) => {\r\n    originalRemove(systemId);\r\n    syncToApi.delete(systemId, false);\r\n  },\r\n  hardDelete: (systemId: SystemId) => {\r\n    originalHardDelete(systemId);\r\n    syncToApi.delete(systemId, true);\r\n  },\r\n  restore: (systemId: SystemId) => {\r\n    originalRestore(systemId);\r\n    syncToApi.restore(systemId);\r\n  },\r\n});\r\n\r\n// Define extended store interface\r\nexport interface ProductStoreState extends CrudState<Product> {\r\n  updateInventory: (productSystemId: SystemId, branchSystemId: SystemId, quantityChange: number) => void;\r\n  commitStock: (productSystemId: SystemId, branchSystemId: SystemId, quantity: number) => void;\r\n  uncommitStock: (productSystemId: SystemId, branchSystemId: SystemId, quantity: number) => void;\r\n  dispatchStock: (productSystemId: SystemId, branchSystemId: SystemId, quantity: number) => void;\r\n  completeDelivery: (productSystemId: SystemId, branchSystemId: SystemId, quantity: number) => void;\r\n  returnStockFromTransit: (productSystemId: SystemId, branchSystemId: SystemId, quantity: number) => void;\r\n  updateLastPurchasePrice: (productSystemId: SystemId, price: number, date: string) => void;\r\n  searchProducts: (query: string, page: number, limit?: number) => Promise<{ items: { value: SystemId; label: string }[], hasNextPage: boolean }>;\r\n}\r\n\r\n// Helper to check if product tracks stock\r\nconst canModifyStock = (product: Product | undefined): boolean => {\r\n  if (!product) return false;\r\n  // Services, digital products, and combos don't track stock directly\r\n  if (product.type === 'service' || product.type === 'digital' || product.type === 'combo') return false;\r\n  // Explicitly disabled stock tracking\r\n  if (product.isStockTracked === false) return false;\r\n  return true;\r\n};\r\n\r\n// Define custom methods\r\nconst updateInventory = (productSystemId: SystemId, branchSystemId: SystemId, quantityChange: number) => {\r\n  baseStore.setState(state => {\r\n    const product = state.data.find(p => p.systemId === productSystemId);\r\n    if (!product) return state;\r\n    \r\n    // Skip if product doesn't track stock\r\n    if (!canModifyStock(product)) {\r\n      console.warn(`[updateInventory] Skipped: Product ${productSystemId} does not track stock`);\r\n      return state;\r\n    }\r\n    \r\n    const oldQuantity = product.inventoryByBranch?.[branchSystemId] || 0;\r\n    const newQuantity = oldQuantity + quantityChange;\r\n    \r\n    // ‚úÖ Removed COMPLAINT_ADJUSTMENT stock history creation\r\n    // Stock history will be created by inventory check balance instead\r\n    \r\n    return {\r\n      data: state.data.map(p => {\r\n        if (p.systemId === productSystemId) {\r\n          const newInventoryByBranch = { ...p.inventoryByBranch };\r\n          newInventoryByBranch[branchSystemId] = newQuantity;\r\n          return {\r\n            ...p,\r\n            inventoryByBranch: newInventoryByBranch,\r\n          };\r\n        }\r\n        return p;\r\n      }),\r\n    };\r\n  });\r\n};\r\n\r\nconst commitStock = (productSystemId: SystemId, branchSystemId: SystemId, quantity: number) => {\r\n  baseStore.setState(state => {\r\n    const product = state.data.find(p => p.systemId === productSystemId);\r\n    if (!canModifyStock(product)) {\r\n      console.warn(`[commitStock] Skipped: Product ${productSystemId} does not track stock`);\r\n      return state;\r\n    }\r\n    return {\r\n      data: state.data.map(p => {\r\n        if (p.systemId === productSystemId) {\r\n          const newCommitted = { ...p.committedByBranch };\r\n          newCommitted[branchSystemId] = (newCommitted[branchSystemId] || 0) + quantity;\r\n          return { ...p, committedByBranch: newCommitted };\r\n        }\r\n        return p;\r\n      }),\r\n    };\r\n  });\r\n};\r\n\r\nconst uncommitStock = (productSystemId: SystemId, branchSystemId: SystemId, quantity: number) => {\r\n  baseStore.setState(state => {\r\n    const product = state.data.find(p => p.systemId === productSystemId);\r\n    if (!canModifyStock(product)) {\r\n      console.warn(`[uncommitStock] Skipped: Product ${productSystemId} does not track stock`);\r\n      return state;\r\n    }\r\n    return {\r\n      data: state.data.map(p => {\r\n        if (p.systemId === productSystemId) {\r\n          const newCommitted = { ...p.committedByBranch };\r\n          newCommitted[branchSystemId] = Math.max(0, (newCommitted[branchSystemId] || 0) - quantity);\r\n          return { ...p, committedByBranch: newCommitted };\r\n        }\r\n        return p;\r\n      }),\r\n    };\r\n  });\r\n};\r\n\r\nconst dispatchStock = (productSystemId: SystemId, branchSystemId: SystemId, quantity: number) => {\r\n  console.log('üî¥ [dispatchStock] Called with:', { productSystemId, branchSystemId, quantity });\r\n  \r\n  baseStore.setState(state => {\r\n    const product = state.data.find(p => p.systemId === productSystemId);\r\n    if (!product) {\r\n      console.error('‚ùå [dispatchStock] Product not found:', productSystemId);\r\n      return state;\r\n    }\r\n    \r\n    // Skip if product doesn't track stock\r\n    if (!canModifyStock(product)) {\r\n      console.warn(`[dispatchStock] Skipped: Product ${productSystemId} does not track stock`);\r\n      return state;\r\n    }\r\n    \r\n    console.log('üì¶ [dispatchStock] Current inventory:', product.inventoryByBranch);\r\n    console.log('üì¶ [dispatchStock] Current committed:', product.committedByBranch);\r\n    \r\n    return {\r\n      data: state.data.map(product => {\r\n        if (product.systemId === productSystemId) {\r\n          const newInventory = { ...product.inventoryByBranch };\r\n          const oldInventory = newInventory[branchSystemId] || 0;\r\n          newInventory[branchSystemId] = oldInventory - quantity;\r\n          \r\n          const newCommitted = { ...product.committedByBranch };\r\n          newCommitted[branchSystemId] = Math.max(0, (newCommitted[branchSystemId] || 0) - quantity);\r\n\r\n          const newInTransit = { ...product.inTransitByBranch };\r\n          newInTransit[branchSystemId] = (newInTransit[branchSystemId] || 0) + quantity;\r\n          \r\n          console.log('‚úÖ [dispatchStock] Updated inventory:', {\r\n            old: oldInventory,\r\n            new: newInventory[branchSystemId],\r\n            change: -quantity\r\n          });\r\n          \r\n          return { \r\n            ...product, \r\n            inventoryByBranch: newInventory,\r\n            committedByBranch: newCommitted,\r\n            inTransitByBranch: newInTransit,\r\n          };\r\n        }\r\n        return product;\r\n      }),\r\n    };\r\n  });\r\n  \r\n  console.log('‚úÖ [dispatchStock] Completed');\r\n};\r\n\r\nconst completeDelivery = (productSystemId: SystemId, branchSystemId: SystemId, quantity: number) => {\r\n  baseStore.setState(state => {\r\n    const product = state.data.find(p => p.systemId === productSystemId);\r\n    if (!canModifyStock(product)) {\r\n      return state;\r\n    }\r\n    return {\r\n      data: state.data.map(p => {\r\n        if (p.systemId === productSystemId) {\r\n          const newInTransit = { ...p.inTransitByBranch };\r\n          newInTransit[branchSystemId] = Math.max(0, (newInTransit[branchSystemId] || 0) - quantity);\r\n          return { ...p, inTransitByBranch: newInTransit };\r\n        }\r\n        return p;\r\n      }),\r\n    };\r\n  });\r\n};\r\n\r\nconst returnStockFromTransit = (productSystemId: SystemId, branchSystemId: SystemId, quantity: number) => {\r\n  baseStore.setState(state => {\r\n    const product = state.data.find(p => p.systemId === productSystemId);\r\n    if (!canModifyStock(product)) {\r\n      return state;\r\n    }\r\n    return {\r\n      data: state.data.map(p => {\r\n        if (p.systemId === productSystemId) {\r\n          const newInTransit = { ...p.inTransitByBranch };\r\n          newInTransit[branchSystemId] = Math.max(0, (newInTransit[branchSystemId] || 0) - quantity);\r\n          const newInventory = { ...p.inventoryByBranch };\r\n          newInventory[branchSystemId] = (newInventory[branchSystemId] || 0) + quantity;\r\n          return { ...p, inventoryByBranch: newInventory, inTransitByBranch: newInTransit };\r\n        }\r\n        return p;\r\n      }),\r\n    };\r\n  });\r\n};\r\n\r\nconst updateLastPurchasePrice = (productSystemId: SystemId, price: number, date: string) => {\r\n  baseStore.setState(state => ({\r\n    data: state.data.map(product => {\r\n      if (product.systemId === productSystemId) {\r\n        // Only update if the new date is newer or equal to the existing lastPurchaseDate\r\n        const existingDate = product.lastPurchaseDate ? new Date(product.lastPurchaseDate).getTime() : 0;\r\n        const newDateTs = new Date(date).getTime();\r\n        \r\n        if (newDateTs >= existingDate) {\r\n          return {\r\n            ...product,\r\n            lastPurchasePrice: price,\r\n            lastPurchaseDate: date,\r\n          };\r\n        }\r\n      }\r\n      return product;\r\n    }),\r\n  }));\r\n};\r\n\r\nconst searchProducts = async (query: string, page: number = 1, limit: number = 10): Promise<{ items: { value: SystemId; label: string }[], hasNextPage: boolean }> => {\r\n  const allProducts = baseStore.getState().data;\r\n  \r\n  // ‚úÖ Create fresh Fuse instance with current data (avoid stale data)\r\n  const fuse = new Fuse(allProducts, {\r\n    keys: ['name', 'id', 'sku', 'barcode'],\r\n    threshold: 0.3,\r\n  });\r\n  \r\n  const results = fuse.search(query);\r\n  const startIndex = (page - 1) * limit;\r\n  const endIndex = startIndex + limit;\r\n  const paginatedResults = results.slice(startIndex, endIndex);\r\n\r\n  return {\r\n    items: paginatedResults.map(result => ({\r\n      value: asSystemId(result.item.systemId),\r\n      label: `${result.item.name} (${result.item.id})`,\r\n    })),\r\n    hasNextPage: endIndex < results.length,\r\n  };\r\n};\r\n\r\n// Wrapped add method with activity history logging\r\nconst addProduct = (product: Omit<Product, 'systemId'>) => {\r\n  const userInfo = getCurrentUserInfo();\r\n  const newProduct = baseStore.getState().add(product);\r\n  \r\n  // Add activity history entry\r\n  const historyEntry = createCreatedEntry(\r\n    userInfo,\r\n    `${userInfo.name} ƒë√£ t·∫°o s·∫£n ph·∫©m ${newProduct.name} (${newProduct.id})`\r\n  );\r\n  baseStore.getState().update(newProduct.systemId, {\r\n    ...newProduct,\r\n    activityHistory: [historyEntry]\r\n  });\r\n  \r\n  return newProduct;\r\n};\r\n\r\n// Wrapped update method with activity history logging\r\nconst updateProduct = (systemId: SystemId, updatedProduct: Product) => {\r\n  const userInfo = getCurrentUserInfo();\r\n  const existingProduct = baseStore.getState().data.find(p => p.systemId === systemId);\r\n  const historyEntries: HistoryEntry[] = [];\r\n  \r\n  if (existingProduct) {\r\n    // Track status changes\r\n    if (existingProduct.status !== updatedProduct.status) {\r\n      const statusLabels: Record<string, string> = {\r\n        'active': 'ƒêang kinh doanh',\r\n        'inactive': 'Ng·ª´ng kinh doanh',\r\n        'discontinued': 'Ng·ª´ng s·∫£n xu·∫•t'\r\n      };\r\n      historyEntries.push(createStatusChangedEntry(\r\n        userInfo,\r\n        statusLabels[existingProduct.status || 'active'],\r\n        statusLabels[updatedProduct.status || 'active'],\r\n        `${userInfo.name} ƒë√£ ƒë·ªïi tr·∫°ng th√°i t·ª´ \"${statusLabels[existingProduct.status || 'active']}\" sang \"${statusLabels[updatedProduct.status || 'active']}\"`\r\n      ));\r\n    }\r\n    \r\n    // Track field changes\r\n    const fieldsToTrack: Array<{ key: keyof Product; label: string }> = [\r\n      { key: 'name', label: 'T√™n s·∫£n ph·∫©m' },\r\n      { key: 'id', label: 'M√£ SKU' },\r\n      { key: 'description', label: 'M√¥ t·∫£' },\r\n      { key: 'shortDescription', label: 'M√¥ t·∫£ ng·∫Øn' },\r\n      { key: 'type', label: 'Lo·∫°i s·∫£n ph·∫©m' },\r\n      { key: 'categorySystemId', label: 'Danh m·ª•c' },\r\n      { key: 'brandSystemId', label: 'Th∆∞∆°ng hi·ªáu' },\r\n      { key: 'unit', label: 'ƒê∆°n v·ªã t√≠nh' },\r\n      { key: 'costPrice', label: 'Gi√° v·ªën' },\r\n      { key: 'minPrice', label: 'Gi√° t·ªëi thi·ªÉu' },\r\n      { key: 'barcode', label: 'M√£ v·∫°ch' },\r\n      { key: 'primarySupplierSystemId', label: 'Nh√† cung c·∫•p ch√≠nh' },\r\n      { key: 'warrantyPeriodMonths', label: 'Th·ªùi h·∫°n b·∫£o h√†nh' },\r\n      { key: 'reorderLevel', label: 'M·ª©c ƒë·∫∑t h√†ng l·∫°i' },\r\n      { key: 'safetyStock', label: 'T·ªìn kho an to√†n' },\r\n      { key: 'maxStock', label: 'T·ªìn kho t·ªëi ƒëa' },\r\n    ];\r\n    \r\n    const changes: string[] = [];\r\n    for (const field of fieldsToTrack) {\r\n      const oldVal = existingProduct[field.key];\r\n      const newVal = updatedProduct[field.key];\r\n      if (oldVal !== newVal && !(oldVal === undefined && newVal === undefined)) {\r\n        if (field.key === 'status') continue;\r\n        const oldDisplay = oldVal !== undefined && oldVal !== null && oldVal !== '' ? String(oldVal) : '(tr·ªëng)';\r\n        const newDisplay = newVal !== undefined && newVal !== null && newVal !== '' ? String(newVal) : '(tr·ªëng)';\r\n        changes.push(`${field.label}: ${oldDisplay} ‚Üí ${newDisplay}`);\r\n      }\r\n    }\r\n    \r\n    // Track price changes separately\r\n    if (existingProduct.costPrice !== updatedProduct.costPrice) {\r\n      changes.push(`Gi√° v·ªën: ${existingProduct.costPrice?.toLocaleString('vi-VN')} ‚Üí ${updatedProduct.costPrice?.toLocaleString('vi-VN')}`);\r\n    }\r\n    \r\n    if (changes.length > 0) {\r\n      historyEntries.push(createUpdatedEntry(\r\n        userInfo,\r\n        `${userInfo.name} ƒë√£ c·∫≠p nh·∫≠t: ${changes.join(', ')}`\r\n      ));\r\n    }\r\n  }\r\n  \r\n  const productWithHistory = {\r\n    ...updatedProduct,\r\n    activityHistory: appendHistoryEntry(existingProduct?.activityHistory, ...historyEntries)\r\n  };\r\n  \r\n  baseStore.getState().update(systemId, productWithHistory);\r\n};\r\n\r\n// Export typed hook that includes both base and custom methods\r\nexport const useProductStore = (): ProductStoreState => {\r\n  const state = baseStore();\r\n  return {\r\n    ...state,\r\n    add: addProduct,\r\n    update: updateProduct,\r\n    updateInventory,\r\n    commitStock,\r\n    uncommitStock,\r\n    dispatchStock,\r\n    completeDelivery,\r\n    returnStockFromTransit,\r\n    updateLastPurchasePrice,\r\n    searchProducts,\r\n  };\r\n};\r\n\r\n// Export getState method for non-hook usage\r\nuseProductStore.getState = () => {\r\n  const state = baseStore.getState();\r\n  return {\r\n    ...state,\r\n    add: addProduct,\r\n    update: updateProduct,\r\n    updateInventory,\r\n    commitStock,\r\n    uncommitStock,\r\n    dispatchStock,\r\n    completeDelivery,\r\n    returnStockFromTransit,\r\n    updateLastPurchasePrice,\r\n    searchProducts,\r\n  };\r\n};\r\n\r\n(useProductStore as typeof useProductStore & { subscribe?: typeof baseStore.subscribe }).subscribe = baseStore.subscribe;\r\n"],"names":[],"mappings":";;;;AAAA;AAIA;AACA;AACA;AACA;;;;;;AASA,MAAM,YAAY,IAAA,6IAAe,EAAU,EAAE,EAAE,YAAY;IACzD,iBAAiB;IACjB,gBAAgB,yJAAsB;IACtC,aAAa;AACf;AAEA,qBAAqB;AACrB,MAAM,eAAe;AAErB,MAAM,YAAY;IAChB,QAAQ,OAAO;QACb,IAAI;YACF,MAAM,WAAW,MAAM,MAAM,cAAc;gBACzC,QAAQ;gBACR,aAAa;gBACb,SAAS;oBAAE,gBAAgB;gBAAmB;gBAC9C,MAAM,KAAK,SAAS,CAAC;YACvB;YACA,IAAI,CAAC,SAAS,EAAE,EAAE,QAAQ,IAAI,CAAC;iBAC1B,QAAQ,GAAG,CAAC,0BAA0B,QAAQ,QAAQ;QAC7D,EAAE,OAAO,GAAG;YACV,QAAQ,IAAI,CAAC,oCAAoC;QACnD;IACF;IACA,QAAQ,OAAO,UAAoB;QACjC,IAAI;YACF,MAAM,WAAW,MAAM,MAAM,GAAG,aAAa,CAAC,EAAE,UAAU,EAAE;gBAC1D,QAAQ;gBACR,aAAa;gBACb,SAAS;oBAAE,gBAAgB;gBAAmB;gBAC9C,MAAM,KAAK,SAAS,CAAC;YACvB;YACA,IAAI,CAAC,SAAS,EAAE,EAAE,QAAQ,IAAI,CAAC;iBAC1B,QAAQ,GAAG,CAAC,0BAA0B;QAC7C,EAAE,OAAO,GAAG;YACV,QAAQ,IAAI,CAAC,oCAAoC;QACnD;IACF;IACA,QAAQ,OAAO,UAAoB,OAAO,KAAK;QAC7C,IAAI;YACF,MAAM,WAAW,MAAM,MAAM,GAAG,aAAa,CAAC,EAAE,UAAU,EAAE;gBAC1D,QAAQ;gBACR,aAAa;gBACb,SAAS;oBAAE,gBAAgB;gBAAmB;gBAC9C,MAAM,KAAK,SAAS,CAAC;oBAAE;gBAAK;YAC9B;YACA,IAAI,CAAC,SAAS,EAAE,EAAE,QAAQ,IAAI,CAAC;iBAC1B,QAAQ,GAAG,CAAC,0BAA0B;QAC7C,EAAE,OAAO,GAAG;YACV,QAAQ,IAAI,CAAC,oCAAoC;QACnD;IACF;IACA,SAAS,OAAO;QACd,IAAI;YACF,MAAM,WAAW,MAAM,MAAM,GAAG,aAAa,CAAC,EAAE,SAAS,QAAQ,CAAC,EAAE;gBAClE,QAAQ;gBACR,aAAa;gBACb,SAAS;oBAAE,gBAAgB;gBAAmB;YAChD;YACA,IAAI,CAAC,SAAS,EAAE,EAAE,QAAQ,IAAI,CAAC;iBAC1B,QAAQ,GAAG,CAAC,2BAA2B;QAC9C,EAAE,OAAO,GAAG;YACV,QAAQ,IAAI,CAAC,qCAAqC;QACpD;IACF;AACF;AAEA,0CAA0C;AAC1C,MAAM,cAAc,UAAU,QAAQ,GAAG,GAAG;AAC5C,MAAM,iBAAiB,UAAU,QAAQ,GAAG,MAAM;AAClD,MAAM,iBAAiB,UAAU,QAAQ,GAAG,MAAM;AAClD,MAAM,qBAAqB,UAAU,QAAQ,GAAG,UAAU;AAC1D,MAAM,kBAAkB,UAAU,QAAQ,GAAG,OAAO;AAEpD,UAAU,QAAQ,CAAC;IACjB,KAAK,CAAC;QACJ,MAAM,SAAS,YAAY;QAC3B,UAAU,MAAM,CAAC;QACjB,OAAO;IACT;IACA,QAAQ,CAAC,UAAoB;QAC3B,eAAe,UAAU;QACzB,UAAU,MAAM,CAAC,UAAU;IAC7B;IACA,QAAQ,CAAC;QACP,eAAe;QACf,UAAU,MAAM,CAAC,UAAU;IAC7B;IACA,YAAY,CAAC;QACX,mBAAmB;QACnB,UAAU,MAAM,CAAC,UAAU;IAC7B;IACA,SAAS,CAAC;QACR,gBAAgB;QAChB,UAAU,OAAO,CAAC;IACpB;AACF;AAcA,0CAA0C;AAC1C,MAAM,iBAAiB,CAAC;IACtB,IAAI,CAAC,SAAS,OAAO;IACrB,oEAAoE;IACpE,IAAI,QAAQ,IAAI,KAAK,aAAa,QAAQ,IAAI,KAAK,aAAa,QAAQ,IAAI,KAAK,SAAS,OAAO;IACjG,qCAAqC;IACrC,IAAI,QAAQ,cAAc,KAAK,OAAO,OAAO;IAC7C,OAAO;AACT;AAEA,wBAAwB;AACxB,MAAM,kBAAkB,CAAC,iBAA2B,gBAA0B;IAC5E,UAAU,QAAQ,CAAC,CAAA;QACjB,MAAM,UAAU,MAAM,IAAI,CAAC,IAAI,CAAC,CAAA,IAAK,EAAE,QAAQ,KAAK;QACpD,IAAI,CAAC,SAAS,OAAO;QAErB,sCAAsC;QACtC,IAAI,CAAC,eAAe,UAAU;YAC5B,QAAQ,IAAI,CAAC,CAAC,mCAAmC,EAAE,gBAAgB,qBAAqB,CAAC;YACzF,OAAO;QACT;QAEA,MAAM,cAAc,QAAQ,iBAAiB,EAAE,CAAC,eAAe,IAAI;QACnE,MAAM,cAAc,cAAc;QAElC,wDAAwD;QACxD,mEAAmE;QAEnE,OAAO;YACL,MAAM,MAAM,IAAI,CAAC,GAAG,CAAC,CAAA;gBACnB,IAAI,EAAE,QAAQ,KAAK,iBAAiB;oBAClC,MAAM,uBAAuB;wBAAE,GAAG,EAAE,iBAAiB;oBAAC;oBACtD,oBAAoB,CAAC,eAAe,GAAG;oBACvC,OAAO;wBACL,GAAG,CAAC;wBACJ,mBAAmB;oBACrB;gBACF;gBACA,OAAO;YACT;QACF;IACF;AACF;AAEA,MAAM,cAAc,CAAC,iBAA2B,gBAA0B;IACxE,UAAU,QAAQ,CAAC,CAAA;QACjB,MAAM,UAAU,MAAM,IAAI,CAAC,IAAI,CAAC,CAAA,IAAK,EAAE,QAAQ,KAAK;QACpD,IAAI,CAAC,eAAe,UAAU;YAC5B,QAAQ,IAAI,CAAC,CAAC,+BAA+B,EAAE,gBAAgB,qBAAqB,CAAC;YACrF,OAAO;QACT;QACA,OAAO;YACL,MAAM,MAAM,IAAI,CAAC,GAAG,CAAC,CAAA;gBACnB,IAAI,EAAE,QAAQ,KAAK,iBAAiB;oBAClC,MAAM,eAAe;wBAAE,GAAG,EAAE,iBAAiB;oBAAC;oBAC9C,YAAY,CAAC,eAAe,GAAG,CAAC,YAAY,CAAC,eAAe,IAAI,CAAC,IAAI;oBACrE,OAAO;wBAAE,GAAG,CAAC;wBAAE,mBAAmB;oBAAa;gBACjD;gBACA,OAAO;YACT;QACF;IACF;AACF;AAEA,MAAM,gBAAgB,CAAC,iBAA2B,gBAA0B;IAC1E,UAAU,QAAQ,CAAC,CAAA;QACjB,MAAM,UAAU,MAAM,IAAI,CAAC,IAAI,CAAC,CAAA,IAAK,EAAE,QAAQ,KAAK;QACpD,IAAI,CAAC,eAAe,UAAU;YAC5B,QAAQ,IAAI,CAAC,CAAC,iCAAiC,EAAE,gBAAgB,qBAAqB,CAAC;YACvF,OAAO;QACT;QACA,OAAO;YACL,MAAM,MAAM,IAAI,CAAC,GAAG,CAAC,CAAA;gBACnB,IAAI,EAAE,QAAQ,KAAK,iBAAiB;oBAClC,MAAM,eAAe;wBAAE,GAAG,EAAE,iBAAiB;oBAAC;oBAC9C,YAAY,CAAC,eAAe,GAAG,KAAK,GAAG,CAAC,GAAG,CAAC,YAAY,CAAC,eAAe,IAAI,CAAC,IAAI;oBACjF,OAAO;wBAAE,GAAG,CAAC;wBAAE,mBAAmB;oBAAa;gBACjD;gBACA,OAAO;YACT;QACF;IACF;AACF;AAEA,MAAM,gBAAgB,CAAC,iBAA2B,gBAA0B;IAC1E,QAAQ,GAAG,CAAC,mCAAmC;QAAE;QAAiB;QAAgB;IAAS;IAE3F,UAAU,QAAQ,CAAC,CAAA;QACjB,MAAM,UAAU,MAAM,IAAI,CAAC,IAAI,CAAC,CAAA,IAAK,EAAE,QAAQ,KAAK;QACpD,IAAI,CAAC,SAAS;YACZ,QAAQ,KAAK,CAAC,wCAAwC;YACtD,OAAO;QACT;QAEA,sCAAsC;QACtC,IAAI,CAAC,eAAe,UAAU;YAC5B,QAAQ,IAAI,CAAC,CAAC,iCAAiC,EAAE,gBAAgB,qBAAqB,CAAC;YACvF,OAAO;QACT;QAEA,QAAQ,GAAG,CAAC,yCAAyC,QAAQ,iBAAiB;QAC9E,QAAQ,GAAG,CAAC,yCAAyC,QAAQ,iBAAiB;QAE9E,OAAO;YACL,MAAM,MAAM,IAAI,CAAC,GAAG,CAAC,CAAA;gBACnB,IAAI,QAAQ,QAAQ,KAAK,iBAAiB;oBACxC,MAAM,eAAe;wBAAE,GAAG,QAAQ,iBAAiB;oBAAC;oBACpD,MAAM,eAAe,YAAY,CAAC,eAAe,IAAI;oBACrD,YAAY,CAAC,eAAe,GAAG,eAAe;oBAE9C,MAAM,eAAe;wBAAE,GAAG,QAAQ,iBAAiB;oBAAC;oBACpD,YAAY,CAAC,eAAe,GAAG,KAAK,GAAG,CAAC,GAAG,CAAC,YAAY,CAAC,eAAe,IAAI,CAAC,IAAI;oBAEjF,MAAM,eAAe;wBAAE,GAAG,QAAQ,iBAAiB;oBAAC;oBACpD,YAAY,CAAC,eAAe,GAAG,CAAC,YAAY,CAAC,eAAe,IAAI,CAAC,IAAI;oBAErE,QAAQ,GAAG,CAAC,wCAAwC;wBAClD,KAAK;wBACL,KAAK,YAAY,CAAC,eAAe;wBACjC,QAAQ,CAAC;oBACX;oBAEA,OAAO;wBACL,GAAG,OAAO;wBACV,mBAAmB;wBACnB,mBAAmB;wBACnB,mBAAmB;oBACrB;gBACF;gBACA,OAAO;YACT;QACF;IACF;IAEA,QAAQ,GAAG,CAAC;AACd;AAEA,MAAM,mBAAmB,CAAC,iBAA2B,gBAA0B;IAC7E,UAAU,QAAQ,CAAC,CAAA;QACjB,MAAM,UAAU,MAAM,IAAI,CAAC,IAAI,CAAC,CAAA,IAAK,EAAE,QAAQ,KAAK;QACpD,IAAI,CAAC,eAAe,UAAU;YAC5B,OAAO;QACT;QACA,OAAO;YACL,MAAM,MAAM,IAAI,CAAC,GAAG,CAAC,CAAA;gBACnB,IAAI,EAAE,QAAQ,KAAK,iBAAiB;oBAClC,MAAM,eAAe;wBAAE,GAAG,EAAE,iBAAiB;oBAAC;oBAC9C,YAAY,CAAC,eAAe,GAAG,KAAK,GAAG,CAAC,GAAG,CAAC,YAAY,CAAC,eAAe,IAAI,CAAC,IAAI;oBACjF,OAAO;wBAAE,GAAG,CAAC;wBAAE,mBAAmB;oBAAa;gBACjD;gBACA,OAAO;YACT;QACF;IACF;AACF;AAEA,MAAM,yBAAyB,CAAC,iBAA2B,gBAA0B;IACnF,UAAU,QAAQ,CAAC,CAAA;QACjB,MAAM,UAAU,MAAM,IAAI,CAAC,IAAI,CAAC,CAAA,IAAK,EAAE,QAAQ,KAAK;QACpD,IAAI,CAAC,eAAe,UAAU;YAC5B,OAAO;QACT;QACA,OAAO;YACL,MAAM,MAAM,IAAI,CAAC,GAAG,CAAC,CAAA;gBACnB,IAAI,EAAE,QAAQ,KAAK,iBAAiB;oBAClC,MAAM,eAAe;wBAAE,GAAG,EAAE,iBAAiB;oBAAC;oBAC9C,YAAY,CAAC,eAAe,GAAG,KAAK,GAAG,CAAC,GAAG,CAAC,YAAY,CAAC,eAAe,IAAI,CAAC,IAAI;oBACjF,MAAM,eAAe;wBAAE,GAAG,EAAE,iBAAiB;oBAAC;oBAC9C,YAAY,CAAC,eAAe,GAAG,CAAC,YAAY,CAAC,eAAe,IAAI,CAAC,IAAI;oBACrE,OAAO;wBAAE,GAAG,CAAC;wBAAE,mBAAmB;wBAAc,mBAAmB;oBAAa;gBAClF;gBACA,OAAO;YACT;QACF;IACF;AACF;AAEA,MAAM,0BAA0B,CAAC,iBAA2B,OAAe;IACzE,UAAU,QAAQ,CAAC,CAAA,QAAS,CAAC;YAC3B,MAAM,MAAM,IAAI,CAAC,GAAG,CAAC,CAAA;gBACnB,IAAI,QAAQ,QAAQ,KAAK,iBAAiB;oBACxC,iFAAiF;oBACjF,MAAM,eAAe,QAAQ,gBAAgB,GAAG,IAAI,KAAK,QAAQ,gBAAgB,EAAE,OAAO,KAAK;oBAC/F,MAAM,YAAY,IAAI,KAAK,MAAM,OAAO;oBAExC,IAAI,aAAa,cAAc;wBAC7B,OAAO;4BACL,GAAG,OAAO;4BACV,mBAAmB;4BACnB,kBAAkB;wBACpB;oBACF;gBACF;gBACA,OAAO;YACT;QACF,CAAC;AACH;AAEA,MAAM,iBAAiB,OAAO,OAAe,OAAe,CAAC,EAAE,QAAgB,EAAE;IAC/E,MAAM,cAAc,UAAU,QAAQ,GAAG,IAAI;IAE7C,oEAAoE;IACpE,MAAM,OAAO,IAAI,yJAAI,CAAC,aAAa;QACjC,MAAM;YAAC;YAAQ;YAAM;YAAO;SAAU;QACtC,WAAW;IACb;IAEA,MAAM,UAAU,KAAK,MAAM,CAAC;IAC5B,MAAM,aAAa,CAAC,OAAO,CAAC,IAAI;IAChC,MAAM,WAAW,aAAa;IAC9B,MAAM,mBAAmB,QAAQ,KAAK,CAAC,YAAY;IAEnD,OAAO;QACL,OAAO,iBAAiB,GAAG,CAAC,CAAA,SAAU,CAAC;gBACrC,OAAO,IAAA,mIAAU,EAAC,OAAO,IAAI,CAAC,QAAQ;gBACtC,OAAO,GAAG,OAAO,IAAI,CAAC,IAAI,CAAC,EAAE,EAAE,OAAO,IAAI,CAAC,EAAE,CAAC,CAAC,CAAC;YAClD,CAAC;QACD,aAAa,WAAW,QAAQ,MAAM;IACxC;AACF;AAEA,mDAAmD;AACnD,MAAM,aAAa,CAAC;IAClB,MAAM,WAAW,IAAA,6JAAkB;IACnC,MAAM,aAAa,UAAU,QAAQ,GAAG,GAAG,CAAC;IAE5C,6BAA6B;IAC7B,MAAM,eAAe,IAAA,6JAAkB,EACrC,UACA,GAAG,SAAS,IAAI,CAAC,iBAAiB,EAAE,WAAW,IAAI,CAAC,EAAE,EAAE,WAAW,EAAE,CAAC,CAAC,CAAC;IAE1E,UAAU,QAAQ,GAAG,MAAM,CAAC,WAAW,QAAQ,EAAE;QAC/C,GAAG,UAAU;QACb,iBAAiB;YAAC;SAAa;IACjC;IAEA,OAAO;AACT;AAEA,sDAAsD;AACtD,MAAM,gBAAgB,CAAC,UAAoB;IACzC,MAAM,WAAW,IAAA,6JAAkB;IACnC,MAAM,kBAAkB,UAAU,QAAQ,GAAG,IAAI,CAAC,IAAI,CAAC,CAAA,IAAK,EAAE,QAAQ,KAAK;IAC3E,MAAM,iBAAiC,EAAE;IAEzC,IAAI,iBAAiB;QACnB,uBAAuB;QACvB,IAAI,gBAAgB,MAAM,KAAK,eAAe,MAAM,EAAE;YACpD,MAAM,eAAuC;gBAC3C,UAAU;gBACV,YAAY;gBACZ,gBAAgB;YAClB;YACA,eAAe,IAAI,CAAC,IAAA,mKAAwB,EAC1C,UACA,YAAY,CAAC,gBAAgB,MAAM,IAAI,SAAS,EAChD,YAAY,CAAC,eAAe,MAAM,IAAI,SAAS,EAC/C,GAAG,SAAS,IAAI,CAAC,uBAAuB,EAAE,YAAY,CAAC,gBAAgB,MAAM,IAAI,SAAS,CAAC,QAAQ,EAAE,YAAY,CAAC,eAAe,MAAM,IAAI,SAAS,CAAC,CAAC,CAAC;QAE3J;QAEA,sBAAsB;QACtB,MAAM,gBAA8D;YAClE;gBAAE,KAAK;gBAAQ,OAAO;YAAe;YACrC;gBAAE,KAAK;gBAAM,OAAO;YAAS;YAC7B;gBAAE,KAAK;gBAAe,OAAO;YAAQ;YACrC;gBAAE,KAAK;gBAAoB,OAAO;YAAa;YAC/C;gBAAE,KAAK;gBAAQ,OAAO;YAAgB;YACtC;gBAAE,KAAK;gBAAoB,OAAO;YAAW;YAC7C;gBAAE,KAAK;gBAAiB,OAAO;YAAc;YAC7C;gBAAE,KAAK;gBAAQ,OAAO;YAAc;YACpC;gBAAE,KAAK;gBAAa,OAAO;YAAU;YACrC;gBAAE,KAAK;gBAAY,OAAO;YAAgB;YAC1C;gBAAE,KAAK;gBAAW,OAAO;YAAU;YACnC;gBAAE,KAAK;gBAA2B,OAAO;YAAqB;YAC9D;gBAAE,KAAK;gBAAwB,OAAO;YAAoB;YAC1D;gBAAE,KAAK;gBAAgB,OAAO;YAAmB;YACjD;gBAAE,KAAK;gBAAe,OAAO;YAAkB;YAC/C;gBAAE,KAAK;gBAAY,OAAO;YAAiB;SAC5C;QAED,MAAM,UAAoB,EAAE;QAC5B,KAAK,MAAM,SAAS,cAAe;YACjC,MAAM,SAAS,eAAe,CAAC,MAAM,GAAG,CAAC;YACzC,MAAM,SAAS,cAAc,CAAC,MAAM,GAAG,CAAC;YACxC,IAAI,WAAW,UAAU,CAAC,CAAC,WAAW,aAAa,WAAW,SAAS,GAAG;gBACxE,IAAI,MAAM,GAAG,KAAK,UAAU;gBAC5B,MAAM,aAAa,WAAW,aAAa,WAAW,QAAQ,WAAW,KAAK,OAAO,UAAU;gBAC/F,MAAM,aAAa,WAAW,aAAa,WAAW,QAAQ,WAAW,KAAK,OAAO,UAAU;gBAC/F,QAAQ,IAAI,CAAC,GAAG,MAAM,KAAK,CAAC,EAAE,EAAE,WAAW,GAAG,EAAE,YAAY;YAC9D;QACF;QAEA,iCAAiC;QACjC,IAAI,gBAAgB,SAAS,KAAK,eAAe,SAAS,EAAE;YAC1D,QAAQ,IAAI,CAAC,CAAC,SAAS,EAAE,gBAAgB,SAAS,EAAE,eAAe,SAAS,GAAG,EAAE,eAAe,SAAS,EAAE,eAAe,UAAU;QACtI;QAEA,IAAI,QAAQ,MAAM,GAAG,GAAG;YACtB,eAAe,IAAI,CAAC,IAAA,6JAAkB,EACpC,UACA,GAAG,SAAS,IAAI,CAAC,cAAc,EAAE,QAAQ,IAAI,CAAC,OAAO;QAEzD;IACF;IAEA,MAAM,qBAAqB;QACzB,GAAG,cAAc;QACjB,iBAAiB,IAAA,6JAAkB,EAAC,iBAAiB,oBAAoB;IAC3E;IAEA,UAAU,QAAQ,GAAG,MAAM,CAAC,UAAU;AACxC;AAGO,MAAM,kBAAkB;IAC7B,MAAM,QAAQ;IACd,OAAO;QACL,GAAG,KAAK;QACR,KAAK;QACL,QAAQ;QACR;QACA;QACA;QACA;QACA;QACA;QACA;QACA;IACF;AACF;AAEA,4CAA4C;AAC5C,gBAAgB,QAAQ,GAAG;IACzB,MAAM,QAAQ,UAAU,QAAQ;IAChC,OAAO;QACL,GAAG,KAAK;QACR,KAAK;QACL,QAAQ;QACR;QACA;QACA;QACA;QACA;QACA;QACA;QACA;IACF;AACF;AAEC,gBAAwF,SAAS,GAAG,UAAU,SAAS"}},
    {"offset": {"line": 518, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/customers/lifecycle-utils.ts"],"sourcesContent":["import type { Customer, CustomerLifecycleStage } from './types';\r\nimport { formatDate, formatDateTime, formatDateTimeSeconds, formatDateCustom, getCurrentDate, getDaysDiff } from '@/lib/date-utils';\r\n/**\r\n * T·ª± ƒë·ªông t√≠nh to√°n giai ƒëo·∫°n v√≤ng ƒë·ªùi kh√°ch h√†ng d·ª±a tr√™n h√†nh vi\r\n */\r\nexport const calculateLifecycleStage = (customer: Customer): CustomerLifecycleStage => {\r\n  const totalOrders = customer.totalOrders || 0;\r\n  const totalSpent = customer.totalSpent || 0;\r\n  const lastPurchaseDate = customer.lastPurchaseDate;\r\n  \r\n  // N·∫øu ch∆∞a mua l·∫ßn n√†o\r\n  if (totalOrders === 0) {\r\n    return \"Kh√°ch ti·ªÅm nƒÉng\";\r\n  }\r\n  \r\n  // T√≠nh s·ªë ng√†y t·ª´ l·∫ßn mua cu·ªëi\r\n  const daysSinceLastPurchase = lastPurchaseDate \r\n    ? getDaysDiff(getCurrentDate(), new Date(lastPurchaseDate))\r\n    : Infinity;\r\n  \r\n  // Kh√°ch ƒë√£ m·∫•t (kh√¥ng mua > 365 ng√†y)\r\n  if (daysSinceLastPurchase > 365) {\r\n    return \"M·∫•t kh√°ch\";\r\n  }\r\n  \r\n  // Kh√¥ng ho·∫°t ƒë·ªông (kh√¥ng mua > 180 ng√†y)\r\n  if (daysSinceLastPurchase > 180) {\r\n    return \"Kh√¥ng ho·∫°t ƒë·ªông\";\r\n  }\r\n  \r\n  // Kh√°ch VIP: Top 10% spending (>= 50 tri·ªáu) v√† mua >= 5 l·∫ßn\r\n  if (totalSpent >= 50_000_000 && totalOrders >= 5) {\r\n    return \"Kh√°ch VIP\";\r\n  }\r\n  \r\n  // Kh√°ch th√¢n thi·∫øt: Mua >= 5 l·∫ßn\r\n  if (totalOrders >= 5) {\r\n    return \"Kh√°ch th√¢n thi·∫øt\";\r\n  }\r\n  \r\n  // Kh√°ch quay l·∫°i: Mua 2-4 l·∫ßn\r\n  if (totalOrders >= 2) {\r\n    return \"Kh√°ch quay l·∫°i\";\r\n  }\r\n  \r\n  // Kh√°ch m·ªõi: Mua l·∫ßn ƒë·∫ßu\r\n  return \"Kh√°ch m·ªõi\";\r\n};\r\n\r\n/**\r\n * L·∫•y m√†u badge cho lifecycle stage\r\n */\r\nexport const getLifecycleStageVariant = (stage?: CustomerLifecycleStage): \r\n  'default' | 'secondary' | 'success' | 'warning' | 'destructive' => {\r\n  switch (stage) {\r\n    case \"Kh√°ch VIP\":\r\n      return \"success\";\r\n    case \"Kh√°ch th√¢n thi·∫øt\":\r\n      return \"success\";\r\n    case \"Kh√°ch quay l·∫°i\":\r\n      return \"default\";\r\n    case \"Kh√°ch m·ªõi\":\r\n      return \"secondary\";\r\n    case \"Kh√°ch ti·ªÅm nƒÉng\":\r\n      return \"secondary\";\r\n    case \"Kh√¥ng ho·∫°t ƒë·ªông\":\r\n      return \"warning\";\r\n    case \"M·∫•t kh√°ch\":\r\n      return \"destructive\";\r\n    default:\r\n      return \"secondary\";\r\n  }\r\n};\r\n\r\n/**\r\n * C·∫≠p nh·∫≠t lifecycle stage cho t·∫•t c·∫£ customers (ch·∫°y batch)\r\n */\r\nexport const updateAllCustomerLifecycleStages = (customers: Customer[]): Customer[] => {\r\n  return customers.map(customer => ({\r\n    ...customer,\r\n    lifecycleStage: calculateLifecycleStage(customer)\r\n  }));\r\n};\r\n"],"names":[],"mappings":";;;;;;;;AACA;;AAIO,MAAM,0BAA0B,CAAC;IACtC,MAAM,cAAc,SAAS,WAAW,IAAI;IAC5C,MAAM,aAAa,SAAS,UAAU,IAAI;IAC1C,MAAM,mBAAmB,SAAS,gBAAgB;IAElD,uBAAuB;IACvB,IAAI,gBAAgB,GAAG;QACrB,OAAO;IACT;IAEA,+BAA+B;IAC/B,MAAM,wBAAwB,mBAC1B,IAAA,sIAAW,EAAC,IAAA,yIAAc,KAAI,IAAI,KAAK,qBACvC;IAEJ,sCAAsC;IACtC,IAAI,wBAAwB,KAAK;QAC/B,OAAO;IACT;IAEA,yCAAyC;IACzC,IAAI,wBAAwB,KAAK;QAC/B,OAAO;IACT;IAEA,4DAA4D;IAC5D,IAAI,cAAc,cAAc,eAAe,GAAG;QAChD,OAAO;IACT;IAEA,iCAAiC;IACjC,IAAI,eAAe,GAAG;QACpB,OAAO;IACT;IAEA,8BAA8B;IAC9B,IAAI,eAAe,GAAG;QACpB,OAAO;IACT;IAEA,yBAAyB;IACzB,OAAO;AACT;AAKO,MAAM,2BAA2B,CAAC;IAEvC,OAAQ;QACN,KAAK;YACH,OAAO;QACT,KAAK;YACH,OAAO;QACT,KAAK;YACH,OAAO;QACT,KAAK;YACH,OAAO;QACT,KAAK;YACH,OAAO;QACT,KAAK;YACH,OAAO;QACT,KAAK;YACH,OAAO;QACT;YACE,OAAO;IACX;AACF;AAKO,MAAM,mCAAmC,CAAC;IAC/C,OAAO,UAAU,GAAG,CAAC,CAAA,WAAY,CAAC;YAChC,GAAG,QAAQ;YACX,gBAAgB,wBAAwB;QAC1C,CAAC;AACH"}},
    {"offset": {"line": 594, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/customers/credit-utils.ts"],"sourcesContent":["import type { Customer } from './types';\r\n\r\nexport type CreditAlertLevel = 'safe' | 'warning' | 'danger' | 'exceeded';\r\n\r\n/**\r\n * T√≠nh m·ª©c ƒë·ªô c·∫£nh b√°o c√¥ng n·ª£\r\n */\r\nexport const getCreditAlertLevel = (customer: Customer): CreditAlertLevel => {\r\n  const currentDebt = customer.currentDebt || 0;\r\n  const maxDebt = customer.maxDebt || 0;\r\n  \r\n  // N·∫øu kh√¥ng c√≥ h·∫°n m·ª©c ho·∫∑c h·∫°n m·ª©c = 0, kh√¥ng c·∫£nh b√°o\r\n  if (maxDebt === 0) return 'safe';\r\n  \r\n  const debtRatio = (currentDebt / maxDebt) * 100;\r\n  \r\n  if (debtRatio >= 100) return 'exceeded';  // V∆∞·ª£t h·∫°n m·ª©c\r\n  if (debtRatio >= 90) return 'danger';     // >= 90%\r\n  if (debtRatio >= 70) return 'warning';    // >= 70%\r\n  return 'safe';                             // < 70%\r\n};\r\n\r\n/**\r\n * L·∫•y variant Badge cho credit alert\r\n */\r\nexport const getCreditAlertBadgeVariant = (level: CreditAlertLevel): \r\n  'default' | 'secondary' | 'success' | 'warning' | 'destructive' => {\r\n  switch (level) {\r\n    case 'exceeded':\r\n    case 'danger':\r\n      return 'destructive';\r\n    case 'warning':\r\n      return 'warning';\r\n    case 'safe':\r\n      return 'success';\r\n    default:\r\n      return 'secondary';\r\n  }\r\n};\r\n\r\n/**\r\n * L·∫•y text cho credit alert\r\n */\r\nexport const getCreditAlertText = (level: CreditAlertLevel): string => {\r\n  switch (level) {\r\n    case 'exceeded':\r\n      return 'V∆∞·ª£t h·∫°n m·ª©c';\r\n    case 'danger':\r\n      return 'S·∫Øp v∆∞·ª£t h·∫°n';\r\n    case 'warning':\r\n      return 'C·∫ßn theo d√µi';\r\n    case 'safe':\r\n      return 'An to√†n';\r\n    default:\r\n      return '';\r\n  }\r\n};\r\n\r\n/**\r\n * Ki·ªÉm tra xem c√≥ th·ªÉ t·∫°o ƒë∆°n h√†ng kh√¥ng (d·ª±a v√†o c√¥ng n·ª£)\r\n */\r\nexport const canCreateOrder = (customer: Customer, orderAmount: number): {\r\n  allowed: boolean;\r\n  reason?: string;\r\n} => {\r\n  const currentDebt = customer.currentDebt || 0;\r\n  const maxDebt = customer.maxDebt || 0;\r\n  \r\n  // N·∫øu kh√¥ng cho ph√©p c√¥ng n·ª£ v√† c√≥ c√¥ng n·ª£ hi·ªán t·∫°i\r\n  if (!customer.allowCredit && currentDebt > 0) {\r\n    return {\r\n      allowed: false,\r\n      reason: 'Kh√°ch h√†ng kh√¥ng ƒë∆∞·ª£c ph√©p c√¥ng n·ª£ v√† c√≤n n·ª£ c≈©'\r\n    };\r\n  }\r\n  \r\n  // N·∫øu c√≥ h·∫°n m·ª©c c√¥ng n·ª£\r\n  if (maxDebt > 0) {\r\n    const newDebt = currentDebt + orderAmount;\r\n    if (newDebt > maxDebt) {\r\n      return {\r\n        allowed: false,\r\n        reason: `ƒê∆°n h√†ng n√†y s·∫Ω v∆∞·ª£t h·∫°n m·ª©c c√¥ng n·ª£ (${formatCurrency(newDebt)} / ${formatCurrency(maxDebt)})`\r\n      };\r\n    }\r\n  }\r\n  \r\n  return { allowed: true };\r\n};\r\n\r\n/**\r\n * L·∫•y danh s√°ch kh√°ch h√†ng c√≥ nguy c∆° c√¥ng n·ª£ cao\r\n */\r\nexport const getHighRiskDebtCustomers = (customers: Customer[]): Customer[] => {\r\n  return customers.filter(customer => {\r\n    const level = getCreditAlertLevel(customer);\r\n    return level === 'danger' || level === 'exceeded';\r\n  }).sort((a, b) => {\r\n    const ratioA = ((a.currentDebt || 0) / (a.maxDebt || 1)) * 100;\r\n    const ratioB = ((b.currentDebt || 0) / (b.maxDebt || 1)) * 100;\r\n    return ratioB - ratioA; // Sort by ratio descending\r\n  });\r\n};\r\n\r\n/**\r\n * Helper format currency\r\n */\r\nconst formatCurrency = (value: number): string => {\r\n  return new Intl.NumberFormat('vi-VN', { \r\n    style: 'currency', \r\n    currency: 'VND' \r\n  }).format(value);\r\n};\r\n"],"names":[],"mappings":";;;;;;;;;;;;AAOO,MAAM,sBAAsB,CAAC;IAClC,MAAM,cAAc,SAAS,WAAW,IAAI;IAC5C,MAAM,UAAU,SAAS,OAAO,IAAI;IAEpC,wDAAwD;IACxD,IAAI,YAAY,GAAG,OAAO;IAE1B,MAAM,YAAY,AAAC,cAAc,UAAW;IAE5C,IAAI,aAAa,KAAK,OAAO,YAAa,eAAe;IACzD,IAAI,aAAa,IAAI,OAAO,UAAc,SAAS;IACnD,IAAI,aAAa,IAAI,OAAO,WAAc,SAAS;IACnD,OAAO,QAAoC,QAAQ;AACrD;AAKO,MAAM,6BAA6B,CAAC;IAEzC,OAAQ;QACN,KAAK;QACL,KAAK;YACH,OAAO;QACT,KAAK;YACH,OAAO;QACT,KAAK;YACH,OAAO;QACT;YACE,OAAO;IACX;AACF;AAKO,MAAM,qBAAqB,CAAC;IACjC,OAAQ;QACN,KAAK;YACH,OAAO;QACT,KAAK;YACH,OAAO;QACT,KAAK;YACH,OAAO;QACT,KAAK;YACH,OAAO;QACT;YACE,OAAO;IACX;AACF;AAKO,MAAM,iBAAiB,CAAC,UAAoB;IAIjD,MAAM,cAAc,SAAS,WAAW,IAAI;IAC5C,MAAM,UAAU,SAAS,OAAO,IAAI;IAEpC,oDAAoD;IACpD,IAAI,CAAC,SAAS,WAAW,IAAI,cAAc,GAAG;QAC5C,OAAO;YACL,SAAS;YACT,QAAQ;QACV;IACF;IAEA,yBAAyB;IACzB,IAAI,UAAU,GAAG;QACf,MAAM,UAAU,cAAc;QAC9B,IAAI,UAAU,SAAS;YACrB,OAAO;gBACL,SAAS;gBACT,QAAQ,CAAC,sCAAsC,EAAE,eAAe,SAAS,GAAG,EAAE,eAAe,SAAS,CAAC,CAAC;YAC1G;QACF;IACF;IAEA,OAAO;QAAE,SAAS;IAAK;AACzB;AAKO,MAAM,2BAA2B,CAAC;IACvC,OAAO,UAAU,MAAM,CAAC,CAAA;QACtB,MAAM,QAAQ,oBAAoB;QAClC,OAAO,UAAU,YAAY,UAAU;IACzC,GAAG,IAAI,CAAC,CAAC,GAAG;QACV,MAAM,SAAS,AAAC,CAAC,EAAE,WAAW,IAAI,CAAC,IAAI,CAAC,EAAE,OAAO,IAAI,CAAC,IAAK;QAC3D,MAAM,SAAS,AAAC,CAAC,EAAE,WAAW,IAAI,CAAC,IAAI,CAAC,EAAE,OAAO,IAAI,CAAC,IAAK;QAC3D,OAAO,SAAS,QAAQ,2BAA2B;IACrD;AACF;AAEA;;CAEC,GACD,MAAM,iBAAiB,CAAC;IACtB,OAAO,IAAI,KAAK,YAAY,CAAC,SAAS;QACpC,OAAO;QACP,UAAU;IACZ,GAAG,MAAM,CAAC;AACZ"}},
    {"offset": {"line": 693, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/customers/intelligence-utils.ts"],"sourcesContent":["import type { Customer } from './types';\r\nimport { formatDate, formatDateTime, formatDateTimeSeconds, formatDateCustom, getCurrentDate, getDaysDiff } from '@/lib/date-utils';\r\n// RFM Score types\r\nexport type RFMScore = {\r\n  recency: 1 | 2 | 3 | 4 | 5;      // 5 = Best (mua g·∫ßn ƒë√¢y)\r\n  frequency: 1 | 2 | 3 | 4 | 5;    // 5 = Best (mua th∆∞·ªùng xuy√™n)\r\n  monetary: 1 | 2 | 3 | 4 | 5;     // 5 = Best (chi ti√™u nhi·ªÅu)\r\n};\r\n\r\n// Customer Segment based on RFM\r\nexport type CustomerSegment = \r\n  | 'Champions'           // RFM: 5-5-5, 5-4-5, 4-5-5 - Kh√°ch h√†ng t·ªët nh·∫•t\r\n  | 'Loyal Customers'     // RFM: 4-4-4, 4-5-4, 5-4-4 - Kh√°ch th√¢n thi·∫øt\r\n  | 'Potential Loyalist'  // RFM: 4-3-*, 3-4-*, 5-3-* - Ti·ªÅm nƒÉng tr·ªü th√†nh th√¢n thi·∫øt\r\n  | 'New Customers'       // RFM: 5-1-*, 4-1-* - Kh√°ch m·ªõi\r\n  | 'Promising'           // RFM: 4-2-*, 3-3-* - ƒê·∫ßy h·ª©a h·∫πn\r\n  | 'Need Attention'      // RFM: 3-2-*, 2-3-* - C·∫ßn ch√∫ √Ω\r\n  | 'About To Sleep'      // RFM: 3-1-*, 2-2-* - S·∫Øp ng·ªß ƒë√¥ng\r\n  | 'At Risk'             // RFM: 2-5-*, 2-4-*, 1-3-* - C√≥ nguy c∆°\r\n  | 'Cannot Lose Them'    // RFM: 1-5-5, 1-4-5 - Kh√¥ng th·ªÉ m·∫•t\r\n  | 'Hibernating'         // RFM: 2-1-*, 1-2-* - Ng·ªß ƒë√¥ng\r\n  | 'Lost';               // RFM: 1-1-* - ƒê√£ m·∫•t\r\n\r\n/**\r\n * T√≠nh RFM scores cho m·ªôt kh√°ch h√†ng\r\n */\r\nexport const calculateRFMScores = (customer: Customer, allCustomers: Customer[]): RFMScore => {\r\n  // Recency: S·ªë ng√†y t·ª´ l·∫ßn mua cu·ªëi\r\n  const daysSinceLastPurchase = customer.lastPurchaseDate \r\n    ? getDaysDiff(getCurrentDate(), new Date(customer.lastPurchaseDate))\r\n    : 999999;\r\n  \r\n  // Frequency: T·ªïng s·ªë ƒë∆°n h√†ng\r\n  const frequency = customer.totalOrders || 0;\r\n  \r\n  // Monetary: T·ªïng chi ti√™u\r\n  const monetary = customer.totalSpent || 0;\r\n\r\n  // Calculate percentiles for scoring\r\n  const allRecencies = allCustomers.map(c => \r\n    c.lastPurchaseDate ? getDaysDiff(getCurrentDate(), new Date(c.lastPurchaseDate)) : 999999\r\n  ).sort((a, b) => a - b);\r\n  \r\n  const allFrequencies = allCustomers.map(c => c.totalOrders || 0).sort((a, b) => b - a);\r\n  const allMonetary = allCustomers.map(c => c.totalSpent || 0).sort((a, b) => b - a);\r\n\r\n  // Score Recency (lower is better, so invert)\r\n  const recencyScore = getScore(daysSinceLastPurchase, allRecencies, true) as RFMScore['recency'];\r\n  \r\n  // Score Frequency (higher is better)\r\n  const frequencyScore = getScore(frequency, allFrequencies, false) as RFMScore['frequency'];\r\n  \r\n  // Score Monetary (higher is better)\r\n  const monetaryScore = getScore(monetary, allMonetary, false) as RFMScore['monetary'];\r\n\r\n  return {\r\n    recency: recencyScore,\r\n    frequency: frequencyScore,\r\n    monetary: monetaryScore\r\n  };\r\n};\r\n\r\n/**\r\n * Helper: T√≠nh score 1-5 d·ª±a tr√™n percentile\r\n */\r\nconst getScore = (value: number, sortedValues: number[], invert: boolean): 1 | 2 | 3 | 4 | 5 => {\r\n  const index = sortedValues.indexOf(value);\r\n  if (index === -1) return 1;\r\n  \r\n  const percentile = (index / sortedValues.length) * 100;\r\n  \r\n  let score: number;\r\n  if (percentile >= 80) score = 5;\r\n  else if (percentile >= 60) score = 4;\r\n  else if (percentile >= 40) score = 3;\r\n  else if (percentile >= 20) score = 2;\r\n  else score = 1;\r\n  \r\n  // Invert for recency (lower days = better)\r\n  if (invert) {\r\n    score = 6 - score;\r\n  }\r\n  \r\n  return score as 1 | 2 | 3 | 4 | 5;\r\n};\r\n\r\n/**\r\n * Ph√¢n lo·∫°i segment d·ª±a tr√™n RFM scores\r\n */\r\nexport const getCustomerSegment = (rfm: RFMScore): CustomerSegment => {\r\n  const { recency: R, frequency: F, monetary: M } = rfm;\r\n  \r\n  // Champions: RFM 5-5-5, 5-4-5, 4-5-5, 5-5-4\r\n  if ((R >= 4 && F >= 4 && M >= 4) && (R === 5 || F === 5)) {\r\n    return 'Champions';\r\n  }\r\n  \r\n  // Loyal Customers: RFM 4-4-4, 4-5-4, 5-4-4, 4-4-5\r\n  if (R >= 4 && F >= 4 && M >= 4) {\r\n    return 'Loyal Customers';\r\n  }\r\n  \r\n  // Potential Loyalist: High frequency, good recency\r\n  if (R >= 3 && F >= 3 && M >= 3) {\r\n    return 'Potential Loyalist';\r\n  }\r\n  \r\n  // New Customers: High recency, low frequency\r\n  if (R >= 4 && F <= 2) {\r\n    return 'New Customers';\r\n  }\r\n  \r\n  // Promising: Good recency, moderate frequency\r\n  if (R >= 3 && F >= 2 && F <= 3) {\r\n    return 'Promising';\r\n  }\r\n  \r\n  // Need Attention: Moderate scores\r\n  if (R === 3 && F === 2) {\r\n    return 'Need Attention';\r\n  }\r\n  \r\n  // About To Sleep: Low frequency, moderate recency\r\n  if ((R === 3 || R === 2) && F <= 2) {\r\n    return 'About To Sleep';\r\n  }\r\n  \r\n  // Cannot Lose Them: Low recency but high value\r\n  if (R === 1 && F >= 4 && M >= 4) {\r\n    return 'Cannot Lose Them';\r\n  }\r\n  \r\n  // At Risk: Low recency, good history\r\n  if (R <= 2 && F >= 3) {\r\n    return 'At Risk';\r\n  }\r\n  \r\n  // Hibernating: Low recency and frequency\r\n  if (R <= 2 && F <= 2 && M >= 2) {\r\n    return 'Hibernating';\r\n  }\r\n  \r\n  // Lost: Lowest scores\r\n  return 'Lost';\r\n};\r\n\r\n/**\r\n * L·∫•y m√†u badge cho segment\r\n */\r\nexport const getSegmentBadgeVariant = (segment: CustomerSegment): \r\n  'default' | 'secondary' | 'success' | 'warning' | 'destructive' => {\r\n  switch (segment) {\r\n    case 'Champions':\r\n    case 'Loyal Customers':\r\n      return 'success';\r\n    case 'Potential Loyalist':\r\n    case 'Promising':\r\n      return 'default';\r\n    case 'New Customers':\r\n      return 'secondary';\r\n    case 'Need Attention':\r\n    case 'About To Sleep':\r\n      return 'warning';\r\n    case 'At Risk':\r\n    case 'Cannot Lose Them':\r\n    case 'Hibernating':\r\n    case 'Lost':\r\n      return 'destructive';\r\n    default:\r\n      return 'secondary';\r\n  }\r\n};\r\n\r\n/**\r\n * D·ªãch segment sang ti·∫øng Vi·ªát\r\n */\r\nexport const getSegmentLabel = (segment: CustomerSegment): string => {\r\n  const labels: Record<CustomerSegment, string> = {\r\n    'Champions': 'Xu·∫•t s·∫Øc',\r\n    'Loyal Customers': 'Trung th√†nh',\r\n    'Potential Loyalist': 'Ti·ªÅm nƒÉng cao',\r\n    'New Customers': 'Kh√°ch m·ªõi',\r\n    'Promising': 'H·ª©a h·∫πn',\r\n    'Need Attention': 'C·∫ßn quan t√¢m',\r\n    'About To Sleep': 'S·∫Øp ng·ªß ƒë√¥ng',\r\n    'At Risk': 'C√≥ nguy c∆°',\r\n    'Cannot Lose Them': 'Kh√¥ng th·ªÉ m·∫•t',\r\n    'Hibernating': 'Ng·ªß ƒë√¥ng',\r\n    'Lost': 'ƒê√£ m·∫•t'\r\n  };\r\n  return labels[segment];\r\n};\r\n\r\n/**\r\n * T√≠nh Customer Health Score (0-100)\r\n * D·ª±a tr√™n 4 y·∫øu t·ªë: Recency, Frequency, Monetary, Payment Behavior\r\n */\r\nexport const calculateHealthScore = (customer: Customer): number => {\r\n  let score = 0;\r\n  \r\n  // 1. Recency - Th·ªùi gian mua g·∫ßn nh·∫•t (30 points)\r\n  const daysSinceLastPurchase = customer.lastPurchaseDate \r\n    ? getDaysDiff(getCurrentDate(), new Date(customer.lastPurchaseDate))\r\n    : Infinity;\r\n    \r\n  if (daysSinceLastPurchase <= 7) score += 30;\r\n  else if (daysSinceLastPurchase <= 30) score += 25;\r\n  else if (daysSinceLastPurchase <= 60) score += 20;\r\n  else if (daysSinceLastPurchase <= 90) score += 15;\r\n  else if (daysSinceLastPurchase <= 180) score += 10;\r\n  else if (daysSinceLastPurchase <= 365) score += 5;\r\n  \r\n  // 2. Frequency - T·∫ßn su·∫•t mua (25 points)\r\n  const totalOrders = customer.totalOrders || 0;\r\n  if (totalOrders >= 20) score += 25;\r\n  else if (totalOrders >= 10) score += 20;\r\n  else if (totalOrders >= 5) score += 15;\r\n  else if (totalOrders >= 3) score += 10;\r\n  else if (totalOrders >= 1) score += 5;\r\n  \r\n  // 3. Monetary - T·ªïng chi ti√™u (30 points)\r\n  const totalSpent = customer.totalSpent || 0;\r\n  if (totalSpent >= 500_000_000) score += 30;\r\n  else if (totalSpent >= 200_000_000) score += 25;\r\n  else if (totalSpent >= 100_000_000) score += 20;\r\n  else if (totalSpent >= 50_000_000) score += 15;\r\n  else if (totalSpent >= 20_000_000) score += 10;\r\n  else if (totalSpent >= 5_000_000) score += 5;\r\n  \r\n  // 4. Payment Behavior - H√†nh vi thanh to√°n (15 points)\r\n  // D·ª±a tr√™n t·ª∑ l·ªá n·ª£ hi·ªán t·∫°i so v·ªõi h·∫°n m·ª©c\r\n  if (customer.maxDebt && customer.maxDebt > 0) {\r\n    const debtRatio = (customer.currentDebt || 0) / customer.maxDebt;\r\n    if (debtRatio <= 0.2) score += 15;\r\n    else if (debtRatio <= 0.4) score += 12;\r\n    else if (debtRatio <= 0.6) score += 8;\r\n    else if (debtRatio <= 0.8) score += 4;\r\n    // > 80% = 0 ƒëi·ªÉm\r\n  } else {\r\n    // Kh√¥ng c√≥ h·∫°n m·ª©c c√¥ng n·ª£ ‚Üí xem nh∆∞ thanh to√°n t·ªët\r\n    score += 15;\r\n  }\r\n  \r\n  return Math.min(100, score);\r\n};\r\n\r\n/**\r\n * L·∫•y health score level\r\n */\r\nexport const getHealthScoreLevel = (score: number): {\r\n  level: 'excellent' | 'good' | 'fair' | 'poor' | 'critical';\r\n  label: string;\r\n  variant: 'success' | 'default' | 'warning' | 'destructive';\r\n} => {\r\n  if (score >= 80) return { level: 'excellent', label: 'Xu·∫•t s·∫Øc', variant: 'success' };\r\n  if (score >= 60) return { level: 'good', label: 'T·ªët', variant: 'default' };\r\n  if (score >= 40) return { level: 'fair', label: 'Trung b√¨nh', variant: 'warning' };\r\n  if (score >= 20) return { level: 'poor', label: 'Y·∫øu', variant: 'destructive' };\r\n  return { level: 'critical', label: 'Nguy hi·ªÉm', variant: 'destructive' };\r\n};\r\n\r\n/**\r\n * D·ª± ƒëo√°n Churn Risk\r\n */\r\nexport const calculateChurnRisk = (customer: Customer): {\r\n  risk: 'low' | 'medium' | 'high';\r\n  label: string;\r\n  variant: 'success' | 'warning' | 'destructive';\r\n  reason: string;\r\n} => {\r\n  const daysSinceLastPurchase = customer.lastPurchaseDate \r\n    ? getDaysDiff(getCurrentDate(), new Date(customer.lastPurchaseDate))\r\n    : Infinity;\r\n  \r\n  const totalOrders = customer.totalOrders || 0;\r\n  \r\n  // N·∫øu kh√°ch m·ªõi (ch∆∞a c√≥ ƒë∆°n ho·∫∑c ch·ªâ 1 ƒë∆°n), d√πng default 30 ng√†y\r\n  // N·∫øu kh√°ch c≈©, t√≠nh d·ª±a tr√™n th·ªùi gian t·ª´ createdAt ƒë·∫øn lastPurchaseDate / s·ªë ƒë∆°n\r\n  let avgDaysBetweenOrders = 30; // Default\r\n  if (totalOrders > 1 && customer.createdAt && customer.lastPurchaseDate) {\r\n    const customerAge = getDaysDiff(new Date(customer.lastPurchaseDate), new Date(customer.createdAt));\r\n    avgDaysBetweenOrders = Math.max(7, customerAge / (totalOrders - 1)); // T·ªëi thi·ªÉu 7 ng√†y\r\n  }\r\n  \r\n  // Kh√°ch v·ª´a mua h√†ng g·∫ßn ƒë√¢y (< 7 ng√†y) = low risk\r\n  if (daysSinceLastPurchase <= 7) {\r\n    return {\r\n      risk: 'low',\r\n      label: 'Nguy c∆° th·∫•p',\r\n      variant: 'success',\r\n      reason: 'Kh√°ch h√†ng ƒëang ho·∫°t ƒë·ªông t·ªët'\r\n    };\r\n  }\r\n  \r\n  // High risk: Kh√¥ng mua > 2x th·ªùi gian trung b√¨nh ho·∫∑c > 365 ng√†y\r\n  if (daysSinceLastPurchase > avgDaysBetweenOrders * 2 || daysSinceLastPurchase > 365) {\r\n    return {\r\n      risk: 'high',\r\n      label: 'Nguy c∆° cao',\r\n      variant: 'destructive',\r\n      reason: `Kh√¥ng mua h√†ng ${Math.floor(daysSinceLastPurchase)} ng√†y, v∆∞·ª£t qu√° 2x chu k·ª≥ trung b√¨nh`\r\n    };\r\n  }\r\n  \r\n  // Medium risk: Kh√¥ng mua > 1.5x th·ªùi gian trung b√¨nh ho·∫∑c > 180 ng√†y\r\n  if (daysSinceLastPurchase > avgDaysBetweenOrders * 1.5 || daysSinceLastPurchase > 180) {\r\n    return {\r\n      risk: 'medium',\r\n      label: 'Nguy c∆° trung b√¨nh',\r\n      variant: 'warning',\r\n      reason: `Kh√¥ng mua h√†ng ${Math.floor(daysSinceLastPurchase)} ng√†y, ƒëang gi·∫£m t·∫ßn su·∫•t`\r\n    };\r\n  }\r\n  \r\n  // Low risk\r\n  return {\r\n    risk: 'low',\r\n    label: 'Nguy c∆° th·∫•p',\r\n    variant: 'success',\r\n    reason: 'Kh√°ch h√†ng ƒëang ho·∫°t ƒë·ªông t·ªët'\r\n  };\r\n};\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 954, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/customers/debt-tracking-utils.ts"],"sourcesContent":["import type { Customer, DebtStatus, DebtTransaction } from './types';\r\nimport { formatDate, formatDateTime, formatDateTimeSeconds, formatDateCustom, getCurrentDate, addDays, getDaysDiff, isDateBefore, toISODate } from '@/lib/date-utils';\r\n/**\r\n * T√≠nh ng√†y ƒë·∫øn h·∫°n d·ª±a tr√™n ng√†y ƒë∆°n h√†ng v√† payment terms\r\n */\r\nexport const calculateDueDate = (orderDate: string, paymentTermsDays: number): string => {\r\n  return toISODate(addDays(new Date(orderDate), paymentTermsDays));\r\n};\r\n\r\n/**\r\n * Parse payment terms string th√†nh s·ªë ng√†y\r\n * \"NET30\" ‚Üí 30, \"NET15\" ‚Üí 15, \"COD\" ‚Üí 0\r\n */\r\nexport const parsePaymentTerms = (paymentTerms?: string): number => {\r\n  if (!paymentTerms) return 0;\r\n  \r\n  const match = paymentTerms.match(/NET(\\d+)/i);\r\n  if (match) {\r\n    return parseInt(match[1], 10);\r\n  }\r\n  \r\n  if (paymentTerms.toUpperCase() === 'COD') {\r\n    return 0; // COD = thanh to√°n ngay\r\n  }\r\n  \r\n  return 30; // Default 30 ng√†y\r\n};\r\n\r\n/**\r\n * T√≠nh s·ªë ng√†y qu√° h·∫°n (n·∫øu > 0 th√¨ qu√° h·∫°n)\r\n */\r\nexport const calculateDaysOverdue = (dueDate: string): number => {\r\n  const days = getDaysDiff(getCurrentDate(), new Date(dueDate));\r\n  return days > 0 ? days : 0;\r\n};\r\n\r\n/**\r\n * T√≠nh s·ªë ng√†y c√≤n l·∫°i ƒë·∫øn h·∫°n (n·∫øu > 0 th√¨ ch∆∞a ƒë·∫øn h·∫°n)\r\n */\r\nexport const calculateDaysUntilDue = (dueDate: string): number => {\r\n  return getDaysDiff(new Date(dueDate), getCurrentDate());\r\n};\r\n\r\n/**\r\n * Ph√¢n lo·∫°i tr·∫°ng th√°i c√¥ng n·ª£ d·ª±a tr√™n ng√†y ƒë·∫øn h·∫°n\r\n */\r\nexport const getDebtStatus = (dueDate: string, hasDebt: boolean): DebtStatus | null => {\r\n  if (!hasDebt) return null;\r\n  \r\n  const daysUntilDue = calculateDaysUntilDue(dueDate);\r\n  \r\n  // Ch∆∞a ƒë·∫øn h·∫°n\r\n  if (daysUntilDue > 3) return \"Ch∆∞a ƒë·∫øn h·∫°n\";\r\n  \r\n  // S·∫Øp ƒë·∫øn h·∫°n (1-3 ng√†y)\r\n  if (daysUntilDue >= 1 && daysUntilDue <= 3) return \"S·∫Øp ƒë·∫øn h·∫°n\";\r\n  \r\n  // ƒê·∫øn h·∫°n h√¥m nay\r\n  if (daysUntilDue === 0) return \"ƒê·∫øn h·∫°n h√¥m nay\";\r\n  \r\n  // Qu√° h·∫°n\r\n  const daysOverdue = Math.abs(daysUntilDue);\r\n  \r\n  if (daysOverdue >= 1 && daysOverdue <= 7) return \"Qu√° h·∫°n 1-7 ng√†y\";\r\n  if (daysOverdue >= 8 && daysOverdue <= 15) return \"Qu√° h·∫°n 8-15 ng√†y\";\r\n  if (daysOverdue >= 16 && daysOverdue <= 30) return \"Qu√° h·∫°n 16-30 ng√†y\";\r\n  \r\n  return \"Qu√° h·∫°n > 30 ng√†y\";\r\n};\r\n\r\n/**\r\n * L·∫•y variant cho badge tr·∫°ng th√°i c√¥ng n·ª£\r\n */\r\nexport const getDebtStatusVariant = (status?: DebtStatus | null): \r\n  'default' | 'secondary' | 'success' | 'warning' | 'destructive' => {\r\n  if (!status) return 'secondary';\r\n  \r\n  switch (status) {\r\n    case \"Ch∆∞a ƒë·∫øn h·∫°n\":\r\n      return \"secondary\";\r\n    case \"S·∫Øp ƒë·∫øn h·∫°n\":\r\n      return \"default\";\r\n    case \"ƒê·∫øn h·∫°n h√¥m nay\":\r\n      return \"warning\";\r\n    case \"Qu√° h·∫°n 1-7 ng√†y\":\r\n      return \"warning\";\r\n    case \"Qu√° h·∫°n 8-15 ng√†y\":\r\n    case \"Qu√° h·∫°n 16-30 ng√†y\":\r\n    case \"Qu√° h·∫°n > 30 ng√†y\":\r\n      return \"destructive\";\r\n    default:\r\n      return \"secondary\";\r\n  }\r\n};\r\n\r\n/**\r\n * T√≠nh to√°n debt tracking info cho customer\r\n */\r\nexport const calculateDebtTrackingInfo = (customer: Customer): {\r\n  oldestDebtDueDate?: string;\r\n  maxDaysOverdue: number;\r\n  debtStatus?: DebtStatus | null;\r\n} => {\r\n  const debtTransactions = customer.debtTransactions || [];\r\n  const unpaidTransactions = debtTransactions.filter(t => !t.isPaid);\r\n  \r\n  if (unpaidTransactions.length === 0 || !customer.currentDebt || customer.currentDebt === 0) {\r\n    return {\r\n      maxDaysOverdue: 0,\r\n      debtStatus: null\r\n    };\r\n  }\r\n  \r\n  // T√¨m giao d·ªãch c√≥ dueDate s·ªõm nh·∫•t (n·ª£ l√¢u nh·∫•t)\r\n  const oldestTransaction = unpaidTransactions.reduce((oldest, current) => {\r\n    return isDateBefore(new Date(current.dueDate), new Date(oldest.dueDate)) ? current : oldest;\r\n  });\r\n  \r\n  const oldestDebtDueDate = oldestTransaction.dueDate;\r\n  const maxDaysOverdue = calculateDaysOverdue(oldestDebtDueDate);\r\n  const debtStatus = getDebtStatus(oldestDebtDueDate, true);\r\n  \r\n  return {\r\n    oldestDebtDueDate,\r\n    maxDaysOverdue,\r\n    debtStatus\r\n  };\r\n};\r\n\r\n/**\r\n * L·∫•y danh s√°ch kh√°ch h√†ng c√≥ n·ª£ qu√° h·∫°n, s·∫Øp x·∫øp theo m·ª©c ƒë·ªô ∆∞u ti√™n\r\n */\r\nexport const getOverdueDebtCustomers = (customers: Customer[]): Customer[] => {\r\n  return customers\r\n    .filter(c => {\r\n      const info = calculateDebtTrackingInfo(c);\r\n      return info.maxDaysOverdue > 0; // Ch·ªâ l·∫•y KH qu√° h·∫°n\r\n    })\r\n    .sort((a, b) => {\r\n      const infoA = calculateDebtTrackingInfo(a);\r\n      const infoB = calculateDebtTrackingInfo(b);\r\n      \r\n      // S·∫Øp x·∫øp theo s·ªë ng√†y qu√° h·∫°n (gi·∫£m d·∫ßn)\r\n      return (infoB.maxDaysOverdue || 0) - (infoA.maxDaysOverdue || 0);\r\n    });\r\n};\r\n\r\n/**\r\n * L·∫•y danh s√°ch kh√°ch h√†ng s·∫Øp ƒë·∫øn h·∫°n thanh to√°n (1-3 ng√†y)\r\n */\r\nexport const getDueSoonCustomers = (customers: Customer[]): Customer[] => {\r\n  return customers\r\n    .filter(c => {\r\n      const info = calculateDebtTrackingInfo(c);\r\n      if (!info.oldestDebtDueDate) return false;\r\n      \r\n      const daysUntil = calculateDaysUntilDue(info.oldestDebtDueDate);\r\n      return daysUntil >= 1 && daysUntil <= 3;\r\n    })\r\n    .sort((a, b) => {\r\n      const infoA = calculateDebtTrackingInfo(a);\r\n      const infoB = calculateDebtTrackingInfo(b);\r\n      \r\n      const daysA = infoA.oldestDebtDueDate ? calculateDaysUntilDue(infoA.oldestDebtDueDate) : 999;\r\n      const daysB = infoB.oldestDebtDueDate ? calculateDaysUntilDue(infoB.oldestDebtDueDate) : 999;\r\n      \r\n      return daysA - daysB; // S·∫Øp x·∫øp theo ng√†y ƒë·∫øn h·∫°n (tƒÉng d·∫ßn)\r\n    });\r\n};\r\n\r\n/**\r\n * T√≠nh t·ªïng c√¥ng n·ª£ qu√° h·∫°n\r\n */\r\nexport const calculateTotalOverdueDebt = (customers: Customer[]): number => {\r\n  return getOverdueDebtCustomers(customers).reduce((sum, c) => sum + (c.currentDebt || 0), 0);\r\n};\r\n\r\n/**\r\n * T√≠nh t·ªïng c√¥ng n·ª£ s·∫Øp ƒë·∫øn h·∫°n\r\n */\r\nexport const calculateTotalDueSoonDebt = (customers: Customer[]): number => {\r\n  return getDueSoonCustomers(customers).reduce((sum, c) => sum + (c.currentDebt || 0), 0);\r\n};\r\n\r\n/**\r\n * Format ng√†y hi·ªÉn th·ªã\r\n */\r\nexport const formatDebtDate = (dateString?: string): string => {\r\n  if (!dateString) return '-';\r\n  return formatDate(dateString);\r\n};\r\n\r\n/**\r\n * Helper format currency\r\n */\r\nexport const formatCurrency = (value?: number): string => {\r\n  if (typeof value !== 'number') return '0 ‚Ç´';\r\n  return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(value);\r\n};\r\n"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;AACA;;AAIO,MAAM,mBAAmB,CAAC,WAAmB;IAClD,OAAO,IAAA,oIAAS,EAAC,IAAA,kIAAO,EAAC,IAAI,KAAK,YAAY;AAChD;AAMO,MAAM,oBAAoB,CAAC;IAChC,IAAI,CAAC,cAAc,OAAO;IAE1B,MAAM,QAAQ,aAAa,KAAK,CAAC;IACjC,IAAI,OAAO;QACT,OAAO,SAAS,KAAK,CAAC,EAAE,EAAE;IAC5B;IAEA,IAAI,aAAa,WAAW,OAAO,OAAO;QACxC,OAAO,GAAG,wBAAwB;IACpC;IAEA,OAAO,IAAI,kBAAkB;AAC/B;AAKO,MAAM,uBAAuB,CAAC;IACnC,MAAM,OAAO,IAAA,sIAAW,EAAC,IAAA,yIAAc,KAAI,IAAI,KAAK;IACpD,OAAO,OAAO,IAAI,OAAO;AAC3B;AAKO,MAAM,wBAAwB,CAAC;IACpC,OAAO,IAAA,sIAAW,EAAC,IAAI,KAAK,UAAU,IAAA,yIAAc;AACtD;AAKO,MAAM,gBAAgB,CAAC,SAAiB;IAC7C,IAAI,CAAC,SAAS,OAAO;IAErB,MAAM,eAAe,sBAAsB;IAE3C,eAAe;IACf,IAAI,eAAe,GAAG,OAAO;IAE7B,yBAAyB;IACzB,IAAI,gBAAgB,KAAK,gBAAgB,GAAG,OAAO;IAEnD,kBAAkB;IAClB,IAAI,iBAAiB,GAAG,OAAO;IAE/B,UAAU;IACV,MAAM,cAAc,KAAK,GAAG,CAAC;IAE7B,IAAI,eAAe,KAAK,eAAe,GAAG,OAAO;IACjD,IAAI,eAAe,KAAK,eAAe,IAAI,OAAO;IAClD,IAAI,eAAe,MAAM,eAAe,IAAI,OAAO;IAEnD,OAAO;AACT;AAKO,MAAM,uBAAuB,CAAC;IAEnC,IAAI,CAAC,QAAQ,OAAO;IAEpB,OAAQ;QACN,KAAK;YACH,OAAO;QACT,KAAK;YACH,OAAO;QACT,KAAK;YACH,OAAO;QACT,KAAK;YACH,OAAO;QACT,KAAK;QACL,KAAK;QACL,KAAK;YACH,OAAO;QACT;YACE,OAAO;IACX;AACF;AAKO,MAAM,4BAA4B,CAAC;IAKxC,MAAM,mBAAmB,SAAS,gBAAgB,IAAI,EAAE;IACxD,MAAM,qBAAqB,iBAAiB,MAAM,CAAC,CAAA,IAAK,CAAC,EAAE,MAAM;IAEjE,IAAI,mBAAmB,MAAM,KAAK,KAAK,CAAC,SAAS,WAAW,IAAI,SAAS,WAAW,KAAK,GAAG;QAC1F,OAAO;YACL,gBAAgB;YAChB,YAAY;QACd;IACF;IAEA,kDAAkD;IAClD,MAAM,oBAAoB,mBAAmB,MAAM,CAAC,CAAC,QAAQ;QAC3D,OAAO,IAAA,uIAAY,EAAC,IAAI,KAAK,QAAQ,OAAO,GAAG,IAAI,KAAK,OAAO,OAAO,KAAK,UAAU;IACvF;IAEA,MAAM,oBAAoB,kBAAkB,OAAO;IACnD,MAAM,iBAAiB,qBAAqB;IAC5C,MAAM,aAAa,cAAc,mBAAmB;IAEpD,OAAO;QACL;QACA;QACA;IACF;AACF;AAKO,MAAM,0BAA0B,CAAC;IACtC,OAAO,UACJ,MAAM,CAAC,CAAA;QACN,MAAM,OAAO,0BAA0B;QACvC,OAAO,KAAK,cAAc,GAAG,GAAG,qBAAqB;IACvD,GACC,IAAI,CAAC,CAAC,GAAG;QACR,MAAM,QAAQ,0BAA0B;QACxC,MAAM,QAAQ,0BAA0B;QAExC,0CAA0C;QAC1C,OAAO,CAAC,MAAM,cAAc,IAAI,CAAC,IAAI,CAAC,MAAM,cAAc,IAAI,CAAC;IACjE;AACJ;AAKO,MAAM,sBAAsB,CAAC;IAClC,OAAO,UACJ,MAAM,CAAC,CAAA;QACN,MAAM,OAAO,0BAA0B;QACvC,IAAI,CAAC,KAAK,iBAAiB,EAAE,OAAO;QAEpC,MAAM,YAAY,sBAAsB,KAAK,iBAAiB;QAC9D,OAAO,aAAa,KAAK,aAAa;IACxC,GACC,IAAI,CAAC,CAAC,GAAG;QACR,MAAM,QAAQ,0BAA0B;QACxC,MAAM,QAAQ,0BAA0B;QAExC,MAAM,QAAQ,MAAM,iBAAiB,GAAG,sBAAsB,MAAM,iBAAiB,IAAI;QACzF,MAAM,QAAQ,MAAM,iBAAiB,GAAG,sBAAsB,MAAM,iBAAiB,IAAI;QAEzF,OAAO,QAAQ,OAAO,uCAAuC;IAC/D;AACJ;AAKO,MAAM,4BAA4B,CAAC;IACxC,OAAO,wBAAwB,WAAW,MAAM,CAAC,CAAC,KAAK,IAAM,MAAM,CAAC,EAAE,WAAW,IAAI,CAAC,GAAG;AAC3F;AAKO,MAAM,4BAA4B,CAAC;IACxC,OAAO,oBAAoB,WAAW,MAAM,CAAC,CAAC,KAAK,IAAM,MAAM,CAAC,EAAE,WAAW,IAAI,CAAC,GAAG;AACvF;AAKO,MAAM,iBAAiB,CAAC;IAC7B,IAAI,CAAC,YAAY,OAAO;IACxB,OAAO,IAAA,qIAAU,EAAC;AACpB;AAKO,MAAM,iBAAiB,CAAC;IAC7B,IAAI,OAAO,UAAU,UAAU,OAAO;IACtC,OAAO,IAAI,KAAK,YAAY,CAAC,SAAS;QAAE,OAAO;QAAY,UAAU;IAAM,GAAG,MAAM,CAAC;AACvF"}},
    {"offset": {"line": 1111, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/customers/store.ts"],"sourcesContent":["import { create } from 'zustand';\r\nimport { createCrudStore, CrudState } from '../../lib/store-factory';\r\n// REMOVED: import { data as initialData } from './data'; // Mock data no longer used - database is source of truth\r\nimport type { Customer } from './types';\r\nimport { SystemId, BusinessId } from '../../lib/id-types';\r\nimport { calculateLifecycleStage } from './lifecycle-utils';\r\nimport { getHighRiskDebtCustomers } from './credit-utils';\r\nimport { \r\n  calculateRFMScores, \r\n  getCustomerSegment, \r\n  calculateHealthScore,\r\n  calculateChurnRisk \r\n} from './intelligence-utils';\r\nimport { getOverdueDebtCustomers, getDueSoonCustomers } from './debt-tracking-utils';\r\nimport Fuse from 'fuse.js';\r\nimport { getCurrentUserSystemId } from '../../contexts/auth-context';\r\nimport {\r\n  getCurrentUserInfo,\r\n  createCreatedEntry,\r\n  createUpdatedEntry,\r\n  createStatusChangedEntry,\r\n  appendHistoryEntry,\r\n  type HistoryEntry\r\n} from '../../lib/activity-history-helper';\r\n\r\nconst baseStore = createCrudStore<Customer>([], 'customers', {\r\n  businessIdField: 'id',\r\n  getCurrentUser: getCurrentUserSystemId, // Track who creates/updates\r\n  apiEndpoint: '/api/customers',\r\n});\r\n\r\n// ‚úÖ API Sync helpers\r\nconst API_ENDPOINT = '/api/customers';\r\n\r\nconst syncToApi = {\r\n  create: async (customer: Customer) => {\r\n    try {\r\n      const response = await fetch(API_ENDPOINT, {\r\n        method: 'POST',\r\n        credentials: 'include',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify(customer),\r\n      });\r\n      if (!response.ok) console.warn('[Customer API] Create sync failed');\r\n      else console.log('[Customer API] Created:', customer.systemId);\r\n    } catch (e) {\r\n      console.warn('[Customer API] Create sync error:', e);\r\n    }\r\n  },\r\n  update: async (systemId: SystemId, updates: Partial<Customer>) => {\r\n    try {\r\n      const response = await fetch(`${API_ENDPOINT}/${systemId}`, {\r\n        method: 'PATCH',\r\n        credentials: 'include',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify(updates),\r\n      });\r\n      if (!response.ok) console.warn('[Customer API] Update sync failed');\r\n      else console.log('[Customer API] Updated:', systemId);\r\n    } catch (e) {\r\n      console.warn('[Customer API] Update sync error:', e);\r\n    }\r\n  },\r\n  delete: async (systemId: SystemId, hard = false) => {\r\n    try {\r\n      const response = await fetch(`${API_ENDPOINT}/${systemId}`, {\r\n        method: 'DELETE',\r\n        credentials: 'include',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({ hard }),\r\n      });\r\n      if (!response.ok) console.warn('[Customer API] Delete sync failed');\r\n      else console.log('[Customer API] Deleted:', systemId);\r\n    } catch (e) {\r\n      console.warn('[Customer API] Delete sync error:', e);\r\n    }\r\n  },\r\n  restore: async (systemId: SystemId) => {\r\n    try {\r\n      const response = await fetch(`${API_ENDPOINT}/${systemId}/restore`, {\r\n        method: 'POST',\r\n        credentials: 'include',\r\n        headers: { 'Content-Type': 'application/json' },\r\n      });\r\n      if (!response.ok) console.warn('[Customer API] Restore sync failed');\r\n      else console.log('[Customer API] Restored:', systemId);\r\n    } catch (e) {\r\n      console.warn('[Customer API] Restore sync error:', e);\r\n    }\r\n  },\r\n};\r\n\r\n// ‚úÖ Wrap base store methods with API sync\r\nconst originalAdd = baseStore.getState().add;\r\nconst originalUpdate = baseStore.getState().update;\r\nconst originalRemove = baseStore.getState().remove;\r\nconst originalHardDelete = baseStore.getState().hardDelete;\r\nconst originalRestore = baseStore.getState().restore;\r\n\r\nbaseStore.setState({\r\n  add: (item: Omit<Customer, 'systemId'>) => {\r\n    const result = originalAdd(item);\r\n    syncToApi.create(result);\r\n    return result;\r\n  },\r\n  update: (systemId: SystemId, updates: Partial<Customer>) => {\r\n    originalUpdate(systemId, updates);\r\n    syncToApi.update(systemId, updates);\r\n  },\r\n  remove: (systemId: SystemId) => {\r\n    originalRemove(systemId);\r\n    syncToApi.delete(systemId, false);\r\n  },\r\n  hardDelete: (systemId: SystemId) => {\r\n    originalHardDelete(systemId);\r\n    syncToApi.delete(systemId, true);\r\n  },\r\n  restore: (systemId: SystemId) => {\r\n    originalRestore(systemId);\r\n    syncToApi.restore(systemId);\r\n  },\r\n});\r\n\r\n// Define enhanced interface\r\ninterface CustomerStoreState extends CrudState<Customer> {\r\n  searchCustomers: (query: string, page: number, limit?: number) => Promise<{ items: { value: string; label: string }[], hasNextPage: boolean }>;\r\n  updateDebt: (systemId: SystemId, amountChange: number) => void;\r\n  incrementOrderStats: (systemId: SystemId, orderValue: number) => void;\r\n  decrementOrderStats: (systemId: SystemId, orderValue: number) => void;\r\n  incrementReturnStats: (systemId: SystemId, quantity: number) => void;\r\n  incrementFailedDeliveryStats: (systemId: SystemId) => void;\r\n  addDebtTransaction: (systemId: SystemId, transaction: import('./types').DebtTransaction) => void;\r\n  addDebtReminder: (systemId: SystemId, reminder: import('./types').DebtReminder) => void;\r\n  updateDebtReminder: (systemId: SystemId, reminderId: SystemId, updates: Partial<import('./types').DebtReminder>) => void;\r\n  removeDebtReminder: (systemId: SystemId, reminderId: SystemId) => void;\r\n  updateDebtTransactionPayment: (systemId: SystemId, orderId: BusinessId, amountPaid: number) => void;\r\n  removeDebtTransaction: (systemId: SystemId, orderId: BusinessId) => void;\r\n  getHighRiskDebtCustomers: () => Customer[];\r\n  updateCustomerIntelligence: () => void; // Batch update RFM, health score, churn risk\r\n  getCustomersBySegment: (segment: string) => Customer[];\r\n  getOverdueDebtCustomers: () => Customer[];\r\n  getDueSoonCustomers: () => Customer[];\r\n    removeMany: (systemIds: SystemId[]) => void;\r\n    updateManyStatus: (systemIds: SystemId[], status: Customer['status']) => void;\r\n    restoreMany: (systemIds: SystemId[]) => void;\r\n}\r\n\r\n// Augmented methods\r\nconst augmentedMethods = {\r\n    searchCustomers: async (query: string, page: number, limit: number = 20) => {\r\n        return new Promise<{ items: { value: string; label: string }[], hasNextPage: boolean }>(resolve => {\r\n            setTimeout(() => {\r\n                const allCustomers = baseStore.getState().data;\r\n                \r\n                // Create fresh Fuse instance with current data (avoid stale data)\r\n                const fuse = new Fuse(allCustomers, {\r\n                    keys: ['name', 'id', 'phone'],\r\n                    threshold: 0.3,\r\n                });\r\n                \r\n                const results = query ? fuse.search(query).map(r => r.item) : allCustomers;\r\n                \r\n                const start = (page - 1) * limit;\r\n                const end = start + limit;\r\n                const paginatedItems = results.slice(start, end);\r\n\r\n                resolve({\r\n                    items: paginatedItems.map(c => ({ value: c.systemId, label: c.name })),\r\n                    hasNextPage: end < results.length,\r\n                });\r\n            }, 300);\r\n        });\r\n    },\r\n    updateDebt: (systemId: SystemId, amountChange: number) => {\r\n        baseStore.setState(state => ({\r\n            data: state.data.map(customer => {\r\n                if (customer.systemId === systemId) {\r\n                    const newDebt = (customer.currentDebt || 0) + amountChange;\r\n                    // Sync to API\r\n                    syncToApi.update(systemId, { currentDebt: newDebt });\r\n                    return {\r\n                        ...customer,\r\n                        currentDebt: newDebt,\r\n                    };\r\n                }\r\n                return customer;\r\n            })\r\n        }));\r\n    },\r\n    incrementOrderStats: (systemId: SystemId, orderValue: number) => {\r\n        const allCustomers = baseStore.getState().getActive();\r\n        \r\n        baseStore.setState(state => ({\r\n            data: state.data.map(customer => {\r\n                if (customer.systemId === systemId) {\r\n                    const updatedCustomer = {\r\n                        ...customer,\r\n                        totalOrders: (customer.totalOrders || 0) + 1,\r\n                        totalSpent: (customer.totalSpent || 0) + orderValue,\r\n                        lastPurchaseDate: new Date().toISOString().split('T')[0],\r\n                    };\r\n                    \r\n                    // Auto-update intelligence after order stats change\r\n                    const rfmScores = calculateRFMScores(updatedCustomer, allCustomers);\r\n                    const segment = getCustomerSegment(rfmScores);\r\n                    const healthScore = calculateHealthScore(updatedCustomer);\r\n                    const churnRisk = calculateChurnRisk(updatedCustomer).risk;\r\n                    const lifecycleStage = calculateLifecycleStage(updatedCustomer);\r\n                    \r\n                    return {\r\n                        ...updatedCustomer,\r\n                        rfmScores,\r\n                        segment,\r\n                        healthScore,\r\n                        churnRisk,\r\n                        lifecycleStage,\r\n                    };\r\n                }\r\n                return customer;\r\n            })\r\n        }));\r\n    },\r\n    decrementOrderStats: (systemId: SystemId, orderValue: number) => {\r\n        const allCustomers = baseStore.getState().getActive();\r\n        \r\n        baseStore.setState(state => ({\r\n            data: state.data.map(customer => {\r\n                if (customer.systemId === systemId) {\r\n                    const updatedCustomer = {\r\n                        ...customer,\r\n                        totalOrders: Math.max(0, (customer.totalOrders || 0) - 1),\r\n                        totalSpent: Math.max(0, (customer.totalSpent || 0) - orderValue),\r\n                    };\r\n                    \r\n                    // Auto-update intelligence after order stats change\r\n                    const rfmScores = calculateRFMScores(updatedCustomer, allCustomers);\r\n                    const segment = getCustomerSegment(rfmScores);\r\n                    const healthScore = calculateHealthScore(updatedCustomer);\r\n                    const churnRisk = calculateChurnRisk(updatedCustomer).risk;\r\n                    const lifecycleStage = calculateLifecycleStage(updatedCustomer);\r\n                    \r\n                    return {\r\n                        ...updatedCustomer,\r\n                        rfmScores,\r\n                        segment,\r\n                        healthScore,\r\n                        churnRisk,\r\n                        lifecycleStage,\r\n                    };\r\n                }\r\n                return customer;\r\n            })\r\n        }));\r\n    },\r\n    incrementReturnStats: (systemId: SystemId, quantity: number) => {\r\n        baseStore.setState(state => ({\r\n            data: state.data.map(customer => {\r\n                if (customer.systemId === systemId) {\r\n                    return {\r\n                        ...customer,\r\n                        totalQuantityReturned: (customer.totalQuantityReturned || 0) + quantity,\r\n                    };\r\n                }\r\n                return customer;\r\n            })\r\n        }));\r\n    },\r\n    incrementFailedDeliveryStats: (systemId: SystemId) => {\r\n        baseStore.setState(state => ({\r\n            data: state.data.map(customer => {\r\n                if (customer.systemId === systemId) {\r\n                    return {\r\n                        ...customer,\r\n                        failedDeliveries: (customer.failedDeliveries || 0) + 1,\r\n                    };\r\n                }\r\n                return customer;\r\n            })\r\n        }));\r\n    },\r\n    addDebtTransaction: (systemId: SystemId, transaction: import('./types').DebtTransaction) => {\r\n        baseStore.setState(state => ({\r\n            data: state.data.map(customer => {\r\n                if (customer.systemId === systemId) {\r\n                    const currentTransactions = customer.debtTransactions || [];\r\n                    // Avoid duplicates\r\n                    if (currentTransactions.some(t => t.orderId === transaction.orderId)) {\r\n                        return customer;\r\n                    }\r\n\r\n                    const outstandingAmount = Math.max(transaction.remainingAmount ?? transaction.amount ?? 0, 0);\r\n                    return {\r\n                        ...customer,\r\n                        currentDebt: Math.max(0, (customer.currentDebt || 0) + outstandingAmount),\r\n                        debtTransactions: [...currentTransactions, transaction],\r\n                    };\r\n                }\r\n                return customer;\r\n            })\r\n        }));\r\n    },\r\n    updateDebtTransactionPayment: (systemId: SystemId, orderId: BusinessId, amountPaid: number) => {\r\n        baseStore.setState(state => ({\r\n            data: state.data.map(customer => {\r\n                if (customer.systemId === systemId && customer.debtTransactions) {\r\n                    let debtDelta = 0;\r\n                    const updatedTransactions = customer.debtTransactions.map(t => {\r\n                        if (t.orderId !== orderId) {\r\n                            return t;\r\n                        }\r\n\r\n                        const currentPaid = t.paidAmount || 0;\r\n                        const currentRemaining = t.remainingAmount ?? Math.max(t.amount - currentPaid, 0);\r\n                        let appliedAmount = amountPaid;\r\n\r\n                        if (appliedAmount > 0) {\r\n                            appliedAmount = Math.min(appliedAmount, currentRemaining);\r\n                        } else if (appliedAmount < 0) {\r\n                            appliedAmount = Math.max(appliedAmount, -currentPaid);\r\n                        }\r\n\r\n                        const newPaidAmount = currentPaid + appliedAmount;\r\n                        const recalculatedRemaining = Math.max(t.amount - newPaidAmount, 0);\r\n                        debtDelta -= appliedAmount;\r\n\r\n                        return {\r\n                            ...t,\r\n                            paidAmount: newPaidAmount,\r\n                            remainingAmount: recalculatedRemaining,\r\n                            isPaid: recalculatedRemaining <= 0,\r\n                            paidDate: recalculatedRemaining <= 0 ? new Date().toISOString().split('T')[0] : t.paidDate,\r\n                        };\r\n                    });\r\n\r\n                    return {\r\n                        ...customer,\r\n                        currentDebt: Math.max(0, (customer.currentDebt || 0) + debtDelta),\r\n                        debtTransactions: updatedTransactions,\r\n                    };\r\n                }\r\n                return customer;\r\n            })\r\n        }));\r\n    },\r\n    removeDebtTransaction: (systemId: SystemId, orderId: BusinessId) => {\r\n        baseStore.setState(state => ({\r\n            data: state.data.map(customer => {\r\n                if (customer.systemId === systemId && customer.debtTransactions) {\r\n                    const transaction = customer.debtTransactions.find(t => t.orderId === orderId);\r\n                    const outstanding = transaction\r\n                        ? Math.max(transaction.remainingAmount ?? (transaction.amount - (transaction.paidAmount || 0)), 0)\r\n                        : 0;\r\n                    return {\r\n                        ...customer,\r\n                        currentDebt: Math.max(0, (customer.currentDebt || 0) - outstanding),\r\n                        debtTransactions: customer.debtTransactions.filter(t => t.orderId !== orderId),\r\n                    };\r\n                }\r\n                return customer;\r\n            })\r\n        }));\r\n    },\r\n    // Add debt reminder (3.3)\r\n    addDebtReminder: (systemId: SystemId, reminder: import('./types').DebtReminder) => {\r\n        baseStore.setState(state => ({\r\n            data: state.data.map(customer => {\r\n                if (customer.systemId === systemId) {\r\n                    const currentReminders = customer.debtReminders || [];\r\n                    return {\r\n                        ...customer,\r\n                        debtReminders: [...currentReminders, reminder],\r\n                    };\r\n                }\r\n                return customer;\r\n            })\r\n        }));\r\n    },\r\n    // Update debt reminder (3.3)\r\n    updateDebtReminder: (systemId: SystemId, reminderId: SystemId, updates: Partial<import('./types').DebtReminder>) => {\r\n        baseStore.setState(state => ({\r\n            data: state.data.map(customer => {\r\n                if (customer.systemId === systemId && customer.debtReminders) {\r\n                    return {\r\n                        ...customer,\r\n                        debtReminders: customer.debtReminders.map(r =>\r\n                            r.systemId === reminderId ? { ...r, ...updates } : r\r\n                        ),\r\n                    };\r\n                }\r\n                return customer;\r\n            })\r\n        }));\r\n    },\r\n    // Remove debt reminder (3.3)\r\n    removeDebtReminder: (systemId: SystemId, reminderId: SystemId) => {\r\n        baseStore.setState(state => ({\r\n            data: state.data.map(customer => {\r\n                if (customer.systemId === systemId && customer.debtReminders) {\r\n                    return {\r\n                        ...customer,\r\n                        debtReminders: customer.debtReminders.filter(r => r.systemId !== reminderId),\r\n                    };\r\n                }\r\n                return customer;\r\n            })\r\n        }));\r\n    },\r\n    // Override add to auto-calculate lifecycle stage and log activity\r\n    add: (customer: Omit<Customer, 'systemId'>) => {\r\n        const userInfo = getCurrentUserInfo();\r\n        const customerWithLifecycle = {\r\n            ...customer,\r\n            lifecycleStage: calculateLifecycleStage(customer as Customer)\r\n        };\r\n        const newCustomer = baseStore.getState().add(customerWithLifecycle);\r\n        \r\n        // Add activity history entry\r\n        const historyEntry = createCreatedEntry(\r\n            userInfo,\r\n            `${userInfo.name} ƒë√£ t·∫°o kh√°ch h√†ng ${newCustomer.name} (${newCustomer.id})`\r\n        );\r\n        baseStore.getState().update(newCustomer.systemId, {\r\n            ...newCustomer,\r\n            activityHistory: [historyEntry]\r\n        });\r\n        \r\n        return newCustomer;\r\n    },\r\n    // Override update to auto-calculate lifecycle stage and log activity\r\n    update: (systemId: SystemId, updatedCustomer: Customer) => {\r\n        console.log('[CustomerStore] update called:', { systemId, updatedCustomer });\r\n        \r\n        const userInfo = getCurrentUserInfo();\r\n        const existingCustomer = baseStore.getState().data.find(c => c.systemId === systemId);\r\n        const historyEntries: HistoryEntry[] = [];\r\n        \r\n        if (existingCustomer) {\r\n            // Track status changes\r\n            if (existingCustomer.status !== updatedCustomer.status) {\r\n                historyEntries.push(createStatusChangedEntry(\r\n                    userInfo,\r\n                    existingCustomer.status,\r\n                    updatedCustomer.status,\r\n                    `${userInfo.name} ƒë√£ ƒë·ªïi tr·∫°ng th√°i t·ª´ \"${existingCustomer.status}\" sang \"${updatedCustomer.status}\"`\r\n                ));\r\n            }\r\n            \r\n            // Track field changes\r\n            const fieldsToTrack: Array<{ key: keyof Customer; label: string }> = [\r\n                { key: 'name', label: 'T√™n kh√°ch h√†ng' },\r\n                { key: 'email', label: 'Email' },\r\n                { key: 'phone', label: 'S·ªë ƒëi·ªán tho·∫°i' },\r\n                { key: 'company', label: 'C√¥ng ty' },\r\n                { key: 'taxCode', label: 'M√£ s·ªë thu·∫ø' },\r\n                { key: 'representative', label: 'Ng∆∞·ªùi ƒë·∫°i di·ªán' },\r\n                { key: 'type', label: 'Lo·∫°i kh√°ch h√†ng' },\r\n                { key: 'customerGroup', label: 'Nh√≥m kh√°ch h√†ng' },\r\n                { key: 'lifecycleStage', label: 'Giai ƒëo·∫°n v√≤ng ƒë·ªùi' },\r\n                { key: 'maxDebt', label: 'H·∫°n m·ª©c c√¥ng n·ª£' },\r\n                { key: 'paymentTerms', label: 'ƒêi·ªÅu kho·∫£n thanh to√°n' },\r\n                { key: 'creditRating', label: 'X·∫øp h·∫°ng t√≠n d·ª•ng' },\r\n                { key: 'pricingLevel', label: 'M·ª©c gi√°' },\r\n                { key: 'defaultDiscount', label: 'Chi·∫øt kh·∫•u m·∫∑c ƒë·ªãnh' },\r\n                { key: 'accountManagerId', label: 'Nh√¢n vi√™n ph·ª• tr√°ch' },\r\n            ];\r\n            \r\n            const changes: string[] = [];\r\n            for (const field of fieldsToTrack) {\r\n                const oldVal = existingCustomer[field.key];\r\n                const newVal = updatedCustomer[field.key];\r\n                if (oldVal !== newVal && !(oldVal === undefined && newVal === undefined)) {\r\n                    // Skip if it's the status field (already tracked above)\r\n                    if (field.key === 'status') continue;\r\n                    const oldDisplay = oldVal !== undefined && oldVal !== null && oldVal !== '' ? String(oldVal) : '(tr·ªëng)';\r\n                    const newDisplay = newVal !== undefined && newVal !== null && newVal !== '' ? String(newVal) : '(tr·ªëng)';\r\n                    changes.push(`${field.label}: ${oldDisplay} ‚Üí ${newDisplay}`);\r\n                }\r\n            }\r\n            \r\n            if (changes.length > 0) {\r\n                historyEntries.push(createUpdatedEntry(\r\n                    userInfo,\r\n                    `${userInfo.name} ƒë√£ c·∫≠p nh·∫≠t: ${changes.join(', ')}`\r\n                ));\r\n            }\r\n        }\r\n        \r\n        const customerWithLifecycle = {\r\n            ...updatedCustomer,\r\n            lifecycleStage: calculateLifecycleStage(updatedCustomer),\r\n            activityHistory: appendHistoryEntry(existingCustomer?.activityHistory, ...historyEntries)\r\n        };\r\n        console.log('[CustomerStore] Calling baseStore.update with:', customerWithLifecycle);\r\n        \r\n        // Call the update function from baseStore directly\r\n        baseStore.getState().update(systemId, customerWithLifecycle);\r\n        \r\n        console.log('[CustomerStore] State after update:', baseStore.getState().data.find(c => c.systemId === systemId));\r\n    },\r\n    // Get customers with high debt risk\r\n    getHighRiskDebtCustomers: () => {\r\n        const activeCustomers = baseStore.getState().getActive();\r\n        return getHighRiskDebtCustomers(activeCustomers);\r\n    },\r\n    // Batch update customer intelligence (RFM, health score, churn risk)\r\n    updateCustomerIntelligence: () => {\r\n        const allCustomers = baseStore.getState().getActive();\r\n        \r\n        baseStore.setState(state => ({\r\n            data: state.data.map(customer => {\r\n                if (customer.isDeleted) return customer;\r\n                \r\n                // Calculate RFM\r\n                const rfmScores = calculateRFMScores(customer, allCustomers);\r\n                const segment = getCustomerSegment(rfmScores);\r\n                \r\n                // Calculate health score\r\n                const healthScore = calculateHealthScore(customer);\r\n                \r\n                // Calculate churn risk\r\n                const churnRisk = calculateChurnRisk(customer).risk;\r\n                \r\n                // Calculate lifecycle stage\r\n                const lifecycleStage = calculateLifecycleStage(customer);\r\n                \r\n                return {\r\n                    ...customer,\r\n                    rfmScores,\r\n                    segment,\r\n                    healthScore,\r\n                    churnRisk,\r\n                    lifecycleStage\r\n                };\r\n            })\r\n        }));\r\n    },\r\n    // Get customers by segment\r\n    getCustomersBySegment: (segment: string) => {\r\n        return baseStore.getState().getActive().filter(c => c.segment === segment);\r\n    },\r\n    // Get customers with overdue debt\r\n    getOverdueDebtCustomers: () => {\r\n        const activeCustomers = baseStore.getState().getActive();\r\n        return getOverdueDebtCustomers(activeCustomers);\r\n    },\r\n    // Get customers with debt due soon\r\n    getDueSoonCustomers: () => {\r\n        const activeCustomers = baseStore.getState().getActive();\r\n        return getDueSoonCustomers(activeCustomers);\r\n    },\r\n    removeMany: (systemIds: SystemId[]) => {\r\n        if (!systemIds.length) return;\r\n        const deletedAtTimestamp = new Date().toISOString();\r\n        baseStore.setState(state => ({\r\n            data: state.data.map(customer =>\r\n                systemIds.includes(customer.systemId)\r\n                    ? { ...customer, isDeleted: true, deletedAt: deletedAtTimestamp }\r\n                    : customer\r\n            )\r\n        }));\r\n    },\r\n    updateManyStatus: (systemIds: SystemId[], status: Customer['status']) => {\r\n        if (!systemIds.length) return;\r\n        baseStore.setState(state => ({\r\n            data: state.data.map(customer =>\r\n                systemIds.includes(customer.systemId)\r\n                    ? { ...customer, status }\r\n                    : customer\r\n            )\r\n        }));\r\n    },\r\n    restoreMany: (systemIds: SystemId[]) => {\r\n        if (!systemIds.length) return;\r\n        baseStore.setState(state => ({\r\n            data: state.data.map(customer =>\r\n                systemIds.includes(customer.systemId)\r\n                    ? { ...customer, isDeleted: false, deletedAt: null }\r\n                    : customer\r\n            )\r\n        }));\r\n    }\r\n};\r\n\r\ntype CustomerStoreSelector<T> = (state: CustomerStoreState) => T;\r\n\r\nlet cachedBaseState: CrudState<Customer> | null = null;\r\nlet cachedCombinedState: CustomerStoreState | null = null;\r\n\r\nconst getCombinedState = (state: CrudState<Customer>): CustomerStoreState => {\r\n    if (cachedBaseState !== state || !cachedCombinedState) {\r\n        cachedBaseState = state;\r\n        cachedCombinedState = { ...state, ...augmentedMethods } as CustomerStoreState;\r\n    }\r\n    return cachedCombinedState!;\r\n};\r\n\r\nconst boundStore = baseStore as unknown as {\r\n    <R>(selector: (state: CrudState<Customer>) => R, equalityFn?: (a: R, b: R) => boolean): R;\r\n    (): CustomerStoreState;\r\n};\r\n\r\nexport const useCustomerStore = <T = CustomerStoreState>(\r\n    selector?: CustomerStoreSelector<T>,\r\n    equalityFn?: (a: T, b: T) => boolean\r\n): T => {\r\n    if (selector) {\r\n        if (equalityFn) {\r\n            return boundStore((state) => selector(getCombinedState(state)), equalityFn);\r\n        }\r\n        return boundStore((state) => selector(getCombinedState(state)));\r\n    }\r\n    return boundStore((state) => getCombinedState(state) as unknown as T);\r\n};\r\n\r\nuseCustomerStore.getState = (): CustomerStoreState => {\r\n    return getCombinedState(baseStore.getState());\r\n};\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1721, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/employees/store.ts"],"sourcesContent":["import { createCrudStore, CrudState } from '../../lib/store-factory';\r\n// REMOVED: import { data as initialData } from './data'; // Mock data no longer used - database is source of truth\r\nimport type { Employee } from './types';\r\nimport type { HistoryEntry } from '../../components/ActivityHistory';\r\nimport Fuse from 'fuse.js';\r\nimport { getCurrentUserSystemId } from '../../contexts/auth-context';\r\nimport { registerBreadcrumbStore } from '../../lib/breadcrumb-generator'; // ‚úÖ NEW\r\nimport { type SystemId } from '../../lib/id-types';\r\nimport { createInMemoryRepository } from '../../repositories/in-memory-repository';\r\nimport { \r\n  createHistoryEntry, \r\n  getCurrentUserInfo,\r\n  appendHistoryEntry \r\n} from '../../lib/activity-history-helper';\r\n\r\ntype EmployeePersistenceAdapter = {\r\n  create: (payload: Omit<Employee, 'systemId'>) => Promise<Employee>;\r\n  update: (systemId: SystemId, payload: Partial<Employee>) => Promise<Employee>;\r\n  softDelete: (systemId: SystemId) => Promise<void>;\r\n  restore: (systemId: SystemId) => Promise<Employee | undefined>;\r\n  hardDelete: (systemId: SystemId) => Promise<void>;\r\n};\r\n\r\nconst baseStore = createCrudStore<Employee>([], 'employees', {\r\n  businessIdField: 'id',\r\n  getCurrentUser: getCurrentUserSystemId, // ‚úÖ Track who creates/updates\r\n  apiEndpoint: '/api/employees',\r\n});\r\n\r\n// ‚úÖ Wrap add method to include activity history\r\nconst originalAdd = baseStore.getState().add;\r\nconst wrappedAdd = (item: Omit<Employee, 'systemId'>): Employee => {\r\n  const userInfo = getCurrentUserInfo();\r\n  const historyEntry = createHistoryEntry(\r\n    'created',\r\n    `${userInfo.name} ƒë√£ t·∫°o h·ªì s∆° nh√¢n vi√™n ${item.fullName} (${item.id})`,\r\n    userInfo\r\n  );\r\n  \r\n  const newEmployee = originalAdd({\r\n    ...item,\r\n    activityHistory: [historyEntry],\r\n  });\r\n  \r\n  return newEmployee;\r\n};\r\n\r\n// ‚úÖ Wrap update method to include activity history\r\nconst originalUpdate = baseStore.getState().update;\r\nconst wrappedUpdate = (systemId: SystemId, updates: Partial<Employee>): void => {\r\n  const currentEmployee = baseStore.getState().data.find(e => e.systemId === systemId);\r\n  if (!currentEmployee) return;\r\n  \r\n  const userInfo = getCurrentUserInfo();\r\n  const historyEntries: HistoryEntry[] = [];\r\n  \r\n  // Track important field changes\r\n  const trackedFields: { key: keyof Employee; label: string }[] = [\r\n    { key: 'fullName', label: 'h·ªç t√™n' },\r\n    { key: 'jobTitle', label: 'ch·ª©c danh' },\r\n    { key: 'department', label: 'ph√≤ng ban' },\r\n    { key: 'employmentStatus', label: 'tr·∫°ng th√°i l√†m vi·ªác' },\r\n    { key: 'employeeType', label: 'lo·∫°i nh√¢n vi√™n' },\r\n    { key: 'baseSalary', label: 'l∆∞∆°ng c∆° b·∫£n' },\r\n    { key: 'phone', label: 's·ªë ƒëi·ªán tho·∫°i' },\r\n    { key: 'workEmail', label: 'email c√¥ng vi·ªác' },\r\n    { key: 'role', label: 'vai tr√≤' },\r\n  ];\r\n  \r\n  trackedFields.forEach(({ key, label }) => {\r\n    if (updates[key] !== undefined && updates[key] !== currentEmployee[key]) {\r\n      const oldValue = currentEmployee[key];\r\n      const newValue = updates[key];\r\n      \r\n      // Format values for display\r\n      let oldDisplay = oldValue;\r\n      let newDisplay = newValue;\r\n      \r\n      if (key === 'baseSalary') {\r\n        oldDisplay = new Intl.NumberFormat('vi-VN').format(oldValue as number) + 'ƒë';\r\n        newDisplay = new Intl.NumberFormat('vi-VN').format(newValue as number) + 'ƒë';\r\n      }\r\n      \r\n      historyEntries.push(createHistoryEntry(\r\n        'updated',\r\n        `${userInfo.name} ƒë√£ c·∫≠p nh·∫≠t ${label}: \"${oldDisplay || '(tr·ªëng)'}\" ‚Üí \"${newDisplay}\"`,\r\n        userInfo,\r\n        { field: key, oldValue, newValue }\r\n      ));\r\n    }\r\n  });\r\n  \r\n  // If status changed specifically\r\n  if (updates.employmentStatus && updates.employmentStatus !== currentEmployee.employmentStatus) {\r\n    historyEntries.push(createHistoryEntry(\r\n      'status_changed',\r\n      `${userInfo.name} ƒë√£ thay ƒë·ªïi tr·∫°ng th√°i l√†m vi·ªác t·ª´ \"${currentEmployee.employmentStatus}\" th√†nh \"${updates.employmentStatus}\"`,\r\n      userInfo,\r\n      { field: 'employmentStatus', oldValue: currentEmployee.employmentStatus, newValue: updates.employmentStatus }\r\n    ));\r\n  }\r\n  \r\n  // If no specific changes tracked, add generic update entry\r\n  if (historyEntries.length === 0) {\r\n    historyEntries.push(createHistoryEntry(\r\n      'updated',\r\n      `${userInfo.name} ƒë√£ c·∫≠p nh·∫≠t th√¥ng tin nh√¢n vi√™n`,\r\n      userInfo\r\n    ));\r\n  }\r\n  \r\n  const updatedHistory = appendHistoryEntry(currentEmployee.activityHistory, ...historyEntries);\r\n  \r\n  originalUpdate(systemId, {\r\n    ...updates,\r\n    activityHistory: updatedHistory,\r\n  });\r\n};\r\n\r\n// ‚úÖ Override base store methods\r\nbaseStore.setState({\r\n  add: wrappedAdd,\r\n  update: wrappedUpdate,\r\n});\r\n\r\nexport const employeeRepository = createInMemoryRepository<Employee>(() => baseStore.getState());\r\n\r\n// ‚úÖ API-backed persistence adapter - syncs to PostgreSQL\r\nconst API_ENDPOINT = '/api/employees';\r\n\r\nconst persistence: EmployeePersistenceAdapter = {\r\n  create: async (payload) => {\r\n    // First create locally for immediate UI update\r\n    const localResult = await employeeRepository.create(payload);\r\n    \r\n    // Then sync to API (background)\r\n    try {\r\n      const response = await fetch(API_ENDPOINT, {\r\n        method: 'POST',\r\n        credentials: 'include',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({ ...payload, systemId: localResult.systemId }),\r\n      });\r\n      if (!response.ok) {\r\n        console.warn('[Employee API] Create sync failed, data saved locally');\r\n      } else {\r\n        console.log('[Employee API] Created:', localResult.systemId);\r\n      }\r\n    } catch (e) {\r\n      console.warn('[Employee API] Create sync error:', e);\r\n    }\r\n    \r\n    return localResult;\r\n  },\r\n  update: async (systemId, payload) => {\r\n    // First update locally\r\n    const localResult = await employeeRepository.update(systemId, payload);\r\n    \r\n    // Then sync to API\r\n    try {\r\n      const response = await fetch(`${API_ENDPOINT}/${systemId}`, {\r\n        method: 'PATCH',\r\n        credentials: 'include',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify(payload),\r\n      });\r\n      if (!response.ok) {\r\n        console.warn('[Employee API] Update sync failed');\r\n      } else {\r\n        console.log('[Employee API] Updated:', systemId);\r\n      }\r\n    } catch (e) {\r\n      console.warn('[Employee API] Update sync error:', e);\r\n    }\r\n    \r\n    return localResult;\r\n  },\r\n  softDelete: async (systemId) => {\r\n    // First delete locally\r\n    await employeeRepository.softDelete(systemId);\r\n    \r\n    // Then sync to API\r\n    try {\r\n      const response = await fetch(`${API_ENDPOINT}/${systemId}`, {\r\n        method: 'DELETE',\r\n        credentials: 'include',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({ hard: false }),\r\n      });\r\n      if (!response.ok) {\r\n        console.warn('[Employee API] Soft delete sync failed');\r\n      } else {\r\n        console.log('[Employee API] Soft deleted:', systemId);\r\n      }\r\n    } catch (e) {\r\n      console.warn('[Employee API] Soft delete sync error:', e);\r\n    }\r\n  },\r\n  restore: async (systemId) => {\r\n    // First restore locally\r\n    const localResult = await employeeRepository.restore(systemId);\r\n    \r\n    // Then sync to API\r\n    try {\r\n      const response = await fetch(`${API_ENDPOINT}/${systemId}/restore`, {\r\n        method: 'POST',\r\n        credentials: 'include',\r\n        headers: { 'Content-Type': 'application/json' },\r\n      });\r\n      if (!response.ok) {\r\n        console.warn('[Employee API] Restore sync failed');\r\n      } else {\r\n        console.log('[Employee API] Restored:', systemId);\r\n      }\r\n    } catch (e) {\r\n      console.warn('[Employee API] Restore sync error:', e);\r\n    }\r\n    \r\n    return localResult;\r\n  },\r\n  hardDelete: async (systemId) => {\r\n    // First delete locally\r\n    await employeeRepository.hardDelete(systemId);\r\n    \r\n    // Then sync to API\r\n    try {\r\n      const response = await fetch(`${API_ENDPOINT}/${systemId}`, {\r\n        method: 'DELETE',\r\n        credentials: 'include',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({ hard: true }),\r\n      });\r\n      if (!response.ok) {\r\n        console.warn('[Employee API] Hard delete sync failed');\r\n      } else {\r\n        console.log('[Employee API] Hard deleted:', systemId);\r\n      }\r\n    } catch (e) {\r\n      console.warn('[Employee API] Hard delete sync error:', e);\r\n    }\r\n  },\r\n};\r\n\r\n// ‚úÖ Register for breadcrumb auto-generation\r\nregisterBreadcrumbStore('employees', () => baseStore.getState());\r\n\r\n// Define enhanced interface\r\ninterface EmployeeStoreState extends CrudState<Employee> {\r\n  searchEmployees: (query: string, page: number, limit?: number) => Promise<{ items: { value: string; label: string }[], hasNextPage: boolean }>;\r\n  permanentDelete: (systemId: SystemId) => Promise<void>;\r\n  persistence: EmployeePersistenceAdapter;\r\n}\r\n\r\ntype EmployeeStoreHook = (() => EmployeeStoreState) & {\r\n  getState: () => EmployeeStoreState;\r\n  persistence: EmployeePersistenceAdapter;\r\n};\r\n\r\n// Augmented methods\r\nconst augmentedMethods = {\r\n    // FIX: Changed `page: number = 1` to `page: number` to make it a required parameter, matching Combobox prop type.\r\n    // ‚úÖ CRITICAL FIX: Create fresh Fuse instance on each search to avoid stale data\r\n    searchEmployees: async (query: string, page: number, limit: number = 20) => {\r\n        return new Promise<{ items: { value: string; label: string }[], hasNextPage: boolean }>(resolve => {\r\n            setTimeout(() => {\r\n                const allEmployees = baseStore.getState().data;\r\n                \r\n                // ‚úÖ Create fresh Fuse instance with current data\r\n                const fuse = new Fuse(allEmployees, {\r\n                    keys: ['fullName', 'id', 'phone', 'personalEmail', 'workEmail'],\r\n                    threshold: 0.3,\r\n                });\r\n                \r\n                const results = query ? fuse.search(query).map(r => r.item) : allEmployees;\r\n                \r\n                const start = (page - 1) * limit;\r\n                const end = start + limit;\r\n                const paginatedItems = results.slice(start, end);\r\n\r\n                resolve({\r\n                    items: paginatedItems.map(e => ({ value: e.systemId, label: e.fullName })),\r\n                    hasNextPage: end < results.length,\r\n                });\r\n            }, 300);\r\n        });\r\n    },\r\n    permanentDelete: async (systemId: SystemId) => {\r\n        await persistence.hardDelete(systemId);\r\n    }\r\n};\r\n\r\nconst useEmployeeStoreHook = (): EmployeeStoreState => {\r\n  const state = baseStore();\r\n  return {\r\n    ...state,\r\n    ...augmentedMethods, // This includes permanentDelete\r\n    persistence,\r\n  };\r\n};\r\n\r\nexport const useEmployeeStore = useEmployeeStoreHook as EmployeeStoreHook;\r\n\r\n// Export getState for non-hook usage\r\nuseEmployeeStore.getState = (): EmployeeStoreState => {\r\n  const state = baseStore.getState();\r\n  return {\r\n    ...state,\r\n    ...augmentedMethods,\r\n    persistence,\r\n  };\r\n};\r\n\r\nuseEmployeeStore.persistence = persistence;\r\n"],"names":[],"mappings":"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"}}]
}