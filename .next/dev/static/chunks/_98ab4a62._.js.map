{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/lib/id-utils.ts"],"sourcesContent":["/**\r\n * ID Utilities\r\n * Helpers for generating and validating IDs (systemId & business id)\r\n */\r\n\r\nimport { getPrefix, type EntityType } from './smart-prefix';\r\nimport { ID_CONFIG } from './id-config';\r\n\r\n// Re-export EntityType for convenience\r\nexport type { EntityType } from './smart-prefix';\r\n\r\n/**\r\n * Generate SystemId (6 digits, immutable, internal use only)\r\n * Format: SYSTEMID_PREFIX + 6 digits (e.g., \"EMP000001\", \"CUSTOMER000001\", \"ORDER000001\")\r\n * Uses systemIdPrefix from ID_CONFIG (English full words)\r\n */\r\nexport function generateSystemId(entityType: EntityType, counter: number): string {\r\n  const config = ID_CONFIG[entityType];\r\n  if (!config) {\r\n    throw new Error(`No configuration found for entity type: ${entityType}`);\r\n  }\r\n  const prefix = config.systemIdPrefix;\r\n  const digitCount = config.digitCount || 6;\r\n  return `${prefix}${String(counter).padStart(digitCount, '0')}`;\r\n}\r\n\r\n/**\r\n * Generate Business ID (6 digits, user-facing, editable)\r\n * Format: PREFIX + 6 digits (e.g., \"NV000001\", \"KH000001\", \"CTV000001\")\r\n * All entities use same 6-digit format for consistency\r\n * \r\n * @param entityType - Entity type from smart-prefix\r\n * @param counter - Current counter value\r\n * @param customId - Optional custom ID from user input\r\n * @returns Generated ID or validated custom ID\r\n */\r\nexport function generateBusinessId(\r\n  entityType: EntityType, \r\n  counter: number,\r\n  customId?: string\r\n): string {\r\n  // If user provided custom ID, validate and return it\r\n  if (customId && customId.trim()) {\r\n    const sanitized = sanitizeBusinessId(customId);\r\n    if (!sanitized) {\r\n      throw new Error('Mã không hợp lệ! Chỉ được phép sử dụng chữ cái và số.');\r\n    }\r\n    return sanitized;\r\n  }\r\n  \r\n  // Otherwise, auto-generate\r\n  const prefix = getPrefix(entityType);\r\n  return `${prefix}${String(counter).padStart(6, '0')}`;\r\n}\r\n\r\n/**\r\n * Sanitize business ID\r\n * - Remove special characters (keep only letters and numbers)\r\n * - Convert to uppercase\r\n * - Trim whitespace\r\n * \r\n * @param id - Raw user input\r\n * @returns Sanitized ID or null if invalid\r\n */\r\nexport function sanitizeBusinessId(id: string): string | null {\r\n  if (!id || typeof id !== 'string') return null;\r\n  \r\n  // Remove all special characters, keep only alphanumeric\r\n  const cleaned = id.trim().replace(/[^a-zA-Z0-9]/g, '');\r\n  \r\n  if (!cleaned) return null;\r\n  \r\n  // Convert to uppercase for consistency\r\n  return cleaned.toUpperCase();\r\n}\r\n\r\n/**\r\n * Validate business ID uniqueness (case-insensitive)\r\n * \r\n * @param id - ID to check\r\n * @param existingIds - Array of existing IDs in the system\r\n * @param currentId - Current ID (for edit mode, to exclude self)\r\n * @returns true if unique, false if duplicate\r\n */\r\nexport function isBusinessIdUnique(\r\n  id: string,\r\n  existingIds: string[],\r\n  currentId?: string\r\n): boolean {\r\n  if (!id) return false;\r\n  \r\n  const normalizedId = id.toUpperCase();\r\n  const normalizedCurrentId = currentId?.toUpperCase();\r\n  \r\n  return !existingIds.some(existingId => {\r\n    // ✅ Filter out empty/undefined IDs\r\n    if (!existingId || existingId.trim() === '') return false;\r\n    \r\n    const normalizedExisting = existingId.toUpperCase();\r\n    // Skip self-comparison in edit mode\r\n    if (normalizedCurrentId && normalizedExisting === normalizedCurrentId) {\r\n      return false;\r\n    }\r\n    return normalizedExisting === normalizedId;\r\n  });\r\n}\r\n\r\n/**\r\n * Extract counter from system ID\r\n * Used to initialize counter when loading from localStorage\r\n * Supports both 6, 7 and 8 digits\r\n * \r\n * @param systemId - System ID to parse (e.g., \"EMP000001\", \"CUSTOMER000001\", \"WARRANTY0000001\")\r\n * @param prefix - Expected systemIdPrefix (e.g., \"EMP\", \"CUSTOMER\", \"WARRANTY\")\r\n * @returns Counter value or 0 if invalid\r\n */\r\nexport function extractCounterFromSystemId(systemId: string, prefix: string): number {\r\n  if (!systemId || typeof systemId !== 'string') return 0;\r\n  \r\n  // Try different digit counts (most entities use 6 digits, some use 7-8)\r\n  const regex8 = new RegExp(`^${prefix}(\\\\d{8})$`);\r\n  const regex7 = new RegExp(`^${prefix}(\\\\d{7})$`);\r\n  const regex6 = new RegExp(`^${prefix}(\\\\d{6})$`);\r\n  \r\n  const match8 = systemId.match(regex8);\r\n  if (match8) return parseInt(match8[1], 10);\r\n  \r\n  const match7 = systemId.match(regex7);\r\n  if (match7) return parseInt(match7[1], 10);\r\n  \r\n  const match6 = systemId.match(regex6);\r\n  if (match6) return parseInt(match6[1], 10);\r\n  \r\n  return 0;\r\n}\r\n\r\n/**\r\n * Extract counter from business ID\r\n * Used to initialize counter when loading from localStorage\r\n * \r\n * @param businessId - Business ID to parse (e.g., \"NV000001\")\r\n * @param prefix - Expected prefix (e.g., \"NV\")\r\n * @returns Counter value or 0 if invalid\r\n */\r\nexport function extractCounterFromBusinessId(businessId: string, prefix: string): number {\r\n  if (!businessId || typeof businessId !== 'string') return 0;\r\n  const regex = new RegExp(`^${prefix}(\\\\d+)$`);\r\n  const match = businessId.match(regex);\r\n  return match ? parseInt(match[1], 10) : 0;\r\n}\r\n\r\n/**\r\n * Get max counter from array of items (for systemId)\r\n * \r\n * @param items - Array of items with systemId\r\n * @param prefix - Prefix to match\r\n * @returns Maximum counter value\r\n */\r\nexport function getMaxSystemIdCounter<T extends { systemId: string }>(\r\n  items: T[],\r\n  prefix: string\r\n): number {\r\n  if (!items || !Array.isArray(items)) return 0;\r\n  \r\n  let maxCounter = 0;\r\n  \r\n  items.forEach(item => {\r\n    if (!item || !item.systemId) return;\r\n    const counter = extractCounterFromSystemId(item.systemId, prefix);\r\n    if (counter > maxCounter) {\r\n      maxCounter = counter;\r\n    }\r\n  });\r\n  \r\n  return maxCounter;\r\n}\r\n\r\n/**\r\n * Get max counter from array of items (for business id)\r\n * Only counts auto-generated IDs (PREFIX + digits)\r\n * \r\n * @param items - Array of items with id\r\n * @param prefix - Prefix to match\r\n * @returns Maximum counter value\r\n */\r\nexport function getMaxBusinessIdCounter<T extends { id: string }>(\r\n  items: T[],\r\n  prefix: string\r\n): number {\r\n  if (!items || !Array.isArray(items)) return 0;\r\n  \r\n  let maxCounter = 0;\r\n  \r\n  items.forEach(item => {\r\n    if (!item || !item.id) return;\r\n    const counter = extractCounterFromBusinessId(item.id, prefix);\r\n    if (counter > maxCounter) {\r\n      maxCounter = counter;\r\n    }\r\n  });\r\n  \r\n  return maxCounter;\r\n}\r\n\r\n/**\r\n * Format ID for display\r\n * Adds spacing for readability\r\n * \r\n * @param id - ID to format\r\n * @returns Formatted ID (e.g., \"NV-000001\", \"KH-000123\")\r\n */\r\nexport function formatIdForDisplay(id: string): string {\r\n  // Match pattern: PREFIX followed by numbers\r\n  const match = id.match(/^([A-Z]+)(\\d+)$/);\r\n  if (!match) return id;\r\n  \r\n  const [, prefix, numbers] = match;\r\n  return `${prefix}-${numbers}`;\r\n}\r\n\r\n/**\r\n * Validate ID format\r\n * Check if ID follows valid pattern (letters + numbers only)\r\n * \r\n * @param id - ID to validate\r\n * @returns true if valid format\r\n */\r\nexport function isValidIdFormat(id: string): boolean {\r\n  if (!id || typeof id !== 'string') return false;\r\n  \r\n  // Only alphanumeric characters allowed\r\n  const regex = /^[A-Z0-9]+$/i;\r\n  return regex.test(id);\r\n}\r\n\r\n/**\r\n * Generate suggested IDs based on entity type\r\n * Useful for autocomplete or placeholder text\r\n * \r\n * @param entityType - Entity type\r\n * @param counter - Current counter\r\n * @param count - Number of suggestions\r\n * @returns Array of suggested IDs\r\n */\r\nexport function generateSuggestedIds(\r\n  entityType: EntityType,\r\n  counter: number,\r\n  count: number = 3\r\n): string[] {\r\n  const suggestions: string[] = [];\r\n  const prefix = getPrefix(entityType);\r\n  \r\n  for (let i = 0; i < count; i++) {\r\n    suggestions.push(`${prefix}${String(counter + i + 1).padStart(6, '0')}`);\r\n  }\r\n  \r\n  return suggestions;\r\n}\r\n\r\n/**\r\n * ✨ Find next available business ID\r\n * Checks existing IDs and increments counter until finding a unique ID\r\n * \r\n * @param prefix - ID prefix (e.g., 'PT', 'PC', 'NV')\r\n * @param existingIds - Array of existing business IDs\r\n * @param startCounter - Starting counter value\r\n * @param digitCount - Number of digits (default: 6)\r\n * @returns Object with nextId and updatedCounter\r\n */\r\nexport function findNextAvailableBusinessId(\r\n  prefix: string,\r\n  existingIds: string[],\r\n  startCounter: number,\r\n  digitCount: number = 6\r\n): { nextId: string; updatedCounter: number } {\r\n  let counter = startCounter;\r\n  let nextId: string;\r\n  \r\n  // Keep incrementing until we find a unique ID\r\n  do {\r\n    counter++;\r\n    nextId = `${prefix}${String(counter).padStart(digitCount, '0')}`;\r\n  } while (existingIds.some(id => id === nextId));\r\n  \r\n  return {\r\n    nextId,\r\n    updatedCounter: counter\r\n  };\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 167, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/lib/store-factory.ts"],"sourcesContent":["import { create } from 'zustand';\r\n// persist, createJSONStorage removed - database is now source of truth\r\nimport { \r\n  generateSystemId, \r\n  generateBusinessId, \r\n  isBusinessIdUnique,\r\n  getMaxSystemIdCounter,\r\n  getMaxBusinessIdCounter,\r\n  findNextAvailableBusinessId,\r\n  type EntityType \r\n} from './id-utils';\r\nimport { getPrefix } from './smart-prefix';\r\nimport { ID_CONFIG, type SystemId, type BusinessId, createSystemId, createBusinessId as brandBusinessId } from './id-config';\r\n\r\nconst SYSTEM_FALLBACK_ID: SystemId = createSystemId('SYS000000');\r\n\r\nconst asSystemIdFallback = (): SystemId => SYSTEM_FALLBACK_ID;\r\n\r\n// ✅ API Sync helper for store-factory\r\nasync function syncToAPI<T>(\r\n  apiEndpoint: string,\r\n  action: 'create' | 'update' | 'delete' | 'restore',\r\n  data: T | { systemId: SystemId },\r\n  systemId?: SystemId\r\n): Promise<boolean> {\r\n  try {\r\n    const endpoint = action === 'create' \r\n      ? apiEndpoint \r\n      : `${apiEndpoint}/${systemId || (data as any).systemId}`;\r\n    \r\n    const method = action === 'create' ? 'POST' \r\n      : action === 'update' ? 'PATCH' \r\n      : action === 'delete' ? 'DELETE'\r\n      : 'PATCH'; // restore uses PATCH\r\n    \r\n    const response = await fetch(endpoint, {\r\n      method,\r\n      headers: { 'Content-Type': 'application/json' },\r\n      credentials: 'include',\r\n      body: action !== 'delete' ? JSON.stringify(data) : undefined,\r\n    });\r\n    \r\n    if (!response.ok) {\r\n      console.warn(`[Store Factory API] ${action} failed for ${apiEndpoint}:`, response.status);\r\n    }\r\n    return response.ok;\r\n  } catch (error) {\r\n    console.error(`[Store Factory API] ${action} error for ${apiEndpoint}:`, error);\r\n    return false;\r\n  }\r\n}\r\n\r\n// Item with SystemId (branded type)\r\nexport type ItemWithSystemId = { systemId: SystemId; [key: string]: any };\r\n\r\n// ✅ Counter state for ID generation\r\nexport type CounterState = {\r\n  systemId: number;\r\n  businessId: number;\r\n};\r\n\r\nexport type CrudState<T extends ItemWithSystemId> = {\r\n  data: T[];\r\n  _counters: CounterState; // ✅ Persisted counters\r\n  _initialized: boolean; // ✅ Track if loaded from API\r\n  add: (item: Omit<T, 'systemId'>) => T;\r\n  addMultiple: (items: Omit<T, 'systemId'>[]) => void;\r\n  update: (systemId: SystemId, item: Partial<T>) => void; // ✅ Accept partial updates\r\n  remove: (systemId: SystemId) => void; // ✅ Branded type\r\n  hardDelete: (systemId: SystemId) => void; // ✅ Branded type\r\n  restore: (systemId: SystemId) => void; // ✅ Branded type\r\n  findById: (systemId: SystemId | string) => T | undefined; // ✅ Branded type\r\n  getActive: () => T[];\r\n  getDeleted: () => T[];\r\n  loadFromAPI: () => Promise<void>; // ✅ Load data from database\r\n};\r\n\r\nexport const createCrudStore = <T extends ItemWithSystemId>(\r\n  _initialData: T[], // @deprecated - Kept for backward compatibility but NO LONGER USED\r\n  entityType: EntityType, // Changed from idPrefix to entityType\r\n  options?: {\r\n    businessIdField?: keyof T; // Field name for business ID (default: 'id')\r\n    persistKey?: string; // @deprecated - No longer used, kept for backward compatibility\r\n    getCurrentUser?: () => string | undefined; // Function to get current user systemId\r\n    apiEndpoint?: string; // ✅ API endpoint for database sync (e.g., '/api/employees')\r\n  }\r\n) => {\r\n  const businessPrefix = getPrefix(entityType); // Vietnamese prefix for Business ID (NV, KH, DH)\r\n  const config = ID_CONFIG[entityType];\r\n  const systemIdPrefix = config?.systemIdPrefix || entityType.toUpperCase(); // English prefix for SystemId (EMP, CUSTOMER, ORDER)\r\n  \r\n  const businessIdField = options?.businessIdField ?? 'id';\r\n  // const persistKey = options?.persistKey; // @deprecated - No longer used\r\n  const getCurrentUser = options?.getCurrentUser;\r\n  const apiEndpoint = options?.apiEndpoint;\r\n\r\n  // ✅ CHANGED: Start with empty array - database is source of truth\r\n  // Mock data files (data.ts) are NO LONGER USED for runtime\r\n  const normalizedInitialData: T[] = [];\r\n\r\n  const storeConfig = (set: any, get: any) => ({\r\n    data: normalizedInitialData, // ✅ Start empty - data loaded via React Query\r\n    // ✅ Counters start at 0 - will be initialized from API via loadFromAPI()\r\n    _counters: {\r\n      systemId: 0,\r\n      businessId: 0\r\n    },\r\n    _initialized: false, // ✅ Track API initialization\r\n    add: (item: Omit<T, 'systemId'>): T => {\r\n        // ✅ Get counters from state (persisted)\r\n        const currentCounters = get()._counters;\r\n        const newSystemIdCounter = currentCounters.systemId + 1;\r\n        const newSystemId = createSystemId(generateSystemId(entityType, newSystemIdCounter));\r\n        \r\n        // Generate or validate Business ID (if field exists)\r\n        let finalItem = { ...item } as any;\r\n        let newBusinessIdCounter = currentCounters.businessId;\r\n        \r\n        if (businessIdField in item) {\r\n          const customId = (item as any)[businessIdField];\r\n          const existingIds = get().data.map((d: any) => d[businessIdField]);\r\n          \r\n          // ✅ If customId provided, validate uniqueness\r\n          if (customId && customId.trim()) {\r\n            if (!isBusinessIdUnique(customId, existingIds)) {\r\n              throw new Error(`Mã \"${customId}\" đã tồn tại! Vui lòng sử dụng mã khác.`);\r\n            }\r\n            finalItem[businessIdField] = customId.trim().toUpperCase();\r\n          } else {\r\n            // ✅ Auto-generate with findNextAvailableBusinessId\r\n            const digitCount = 6; // All entities use 6 digits\r\n            const result = findNextAvailableBusinessId(businessPrefix, existingIds, newBusinessIdCounter, digitCount);\r\n            finalItem[businessIdField] = result.nextId;\r\n            newBusinessIdCounter = result.updatedCounter;\r\n          }\r\n        }\r\n        \r\n        const now = new Date().toISOString();\r\n        const currentUser = getCurrentUser?.();\r\n        const newItem = { \r\n          ...finalItem, \r\n          systemId: newSystemId, // ✅ Branded SystemId\r\n          createdAt: finalItem.createdAt || now,\r\n          updatedAt: now,\r\n          createdBy: finalItem.createdBy || currentUser,\r\n          updatedBy: currentUser,\r\n        } as unknown as T;\r\n        \r\n        // ✅ Update both data and counters atomically\r\n        set((state: any) => ({ \r\n          data: [...state.data, newItem],\r\n          _counters: {\r\n            systemId: newSystemIdCounter,\r\n            businessId: newBusinessIdCounter\r\n          }\r\n        }));\r\n        \r\n        // ✅ Sync to API in background\r\n        if (apiEndpoint) {\r\n          syncToAPI(apiEndpoint, 'create', newItem).catch(console.error);\r\n        }\r\n        \r\n        return newItem;\r\n    },\r\n    addMultiple: (items: Omit<T, 'systemId'>[]) => \r\n        set((state: any) => {\r\n            const now = new Date().toISOString();\r\n            const currentUser = getCurrentUser?.();\r\n            const newItems: T[] = [];\r\n            const digitCount = 6; // All entities use 6 digits\r\n            \r\n            // ✅ Start from current counters\r\n            let currentSystemIdCounter = state._counters.systemId;\r\n            let currentBusinessIdCounter = state._counters.businessId;\r\n            \r\n            items.forEach(item => {\r\n                // ✅ Generate SystemId from current counter\r\n                currentSystemIdCounter++;\r\n                const newSystemId = createSystemId(generateSystemId(entityType, currentSystemIdCounter));\r\n                \r\n                // Generate or validate Business ID (if field exists)\r\n                let finalItem = { ...item } as any;\r\n                if (businessIdField in item) {\r\n                  const customId = (item as any)[businessIdField];\r\n                  \r\n                  // Collect existing IDs (from state + already added in this batch)\r\n                  const existingIds = [\r\n                    ...state.data.map((d: any) => d[businessIdField]),\r\n                    ...newItems.map((d: any) => d[businessIdField])\r\n                  ];\r\n                  \r\n                  // ✅ If customId provided, validate uniqueness\r\n                  if (customId && customId.trim()) {\r\n                    if (!isBusinessIdUnique(customId, existingIds)) {\r\n                      throw new Error(`Mã \"${customId}\" đã tồn tại! Vui lòng sử dụng mã khác.`);\r\n                    }\r\n                    finalItem[businessIdField] = customId.trim().toUpperCase();\r\n                  } else {\r\n                    // ✅ Auto-generate with findNextAvailableBusinessId\r\n                    const result = findNextAvailableBusinessId(businessPrefix, existingIds, currentBusinessIdCounter, digitCount);\r\n                    finalItem[businessIdField] = result.nextId;\r\n                    currentBusinessIdCounter = result.updatedCounter;\r\n                  }\r\n                }\r\n                \r\n                newItems.push({ \r\n                  ...finalItem, \r\n                  systemId: newSystemId,\r\n                  createdAt: now,\r\n                  updatedAt: now,\r\n                  createdBy: currentUser,\r\n                  updatedBy: currentUser,\r\n                } as unknown as T);\r\n            });\r\n            \r\n            // ✅ Update both data and counters\r\n            const result = { \r\n              data: [...state.data, ...newItems],\r\n              _counters: {\r\n                systemId: currentSystemIdCounter,\r\n                businessId: currentBusinessIdCounter\r\n              }\r\n            };\r\n            \r\n            // ✅ Sync to API in background (batch)\r\n            if (apiEndpoint) {\r\n              newItems.forEach(item => {\r\n                syncToAPI(apiEndpoint, 'create', item).catch(console.error);\r\n              });\r\n            }\r\n            \r\n            return result;\r\n        }),\r\n    update: (systemId: SystemId, updatedItem: Partial<T>) => {\r\n      // Validate unique business ID (case-insensitive, skip self)\r\n      if (businessIdField in updatedItem) {\r\n        const businessId = (updatedItem as any)[businessIdField];\r\n        const existingIds = get().data\r\n          .filter((d: any) => d.systemId !== systemId)\r\n          .map((d: any) => d[businessIdField]);\r\n        \r\n        if (businessId && !isBusinessIdUnique(businessId, existingIds)) {\r\n          throw new Error(`Mã \"${businessId}\" đã tồn tại! Vui lòng sử dụng mã khác.`);\r\n        }\r\n      }\r\n\r\n      const now = new Date().toISOString();\r\n      const currentUser = getCurrentUser?.();\r\n      set((state: any) => ({\r\n        data: state.data.map((item: T) =>\r\n          item.systemId === systemId \r\n            ? { ...item, ...updatedItem, updatedAt: now, updatedBy: currentUser } as T\r\n            : item\r\n        ),\r\n      }));\r\n      \r\n      // ✅ Sync to API in background\r\n      if (apiEndpoint) {\r\n        const fullItem = get().data.find((item: T) => item.systemId === systemId);\r\n        if (fullItem) {\r\n          syncToAPI(apiEndpoint, 'update', fullItem, systemId).catch(console.error);\r\n        }\r\n      }\r\n    },\r\n    remove: (systemId: SystemId) => {\r\n      // Soft delete - mark as deleted\r\n      const now = new Date().toISOString();\r\n      set((state: any) => ({\r\n        data: state.data.map((item: T) =>\r\n          item.systemId === systemId\r\n            ? { ...item, isDeleted: true, deletedAt: now } as T\r\n            : item\r\n        ),\r\n      }));\r\n      \r\n      // ✅ Sync to API in background\r\n      if (apiEndpoint) {\r\n        const item = get().data.find((item: T) => item.systemId === systemId);\r\n        if (item) {\r\n          syncToAPI(apiEndpoint, 'update', { ...item, isDeleted: true, deletedAt: now }, systemId).catch(console.error);\r\n        }\r\n      }\r\n    },\r\n    hardDelete: (systemId: SystemId) => {\r\n      // Permanent delete - remove from array\r\n      set((state: any) => ({\r\n        data: state.data.filter((item: T) => item.systemId !== systemId),\r\n      }));\r\n      \r\n      // ✅ Sync to API in background\r\n      if (apiEndpoint) {\r\n        syncToAPI(apiEndpoint, 'delete', { systemId }, systemId).catch(console.error);\r\n      }\r\n    },\r\n    restore: (systemId: SystemId) => {\r\n      // Restore soft-deleted item\r\n      set((state: any) => ({\r\n        data: state.data.map((item: T) =>\r\n          item.systemId === systemId\r\n            ? { ...item, isDeleted: false, deletedAt: null } as T\r\n            : item\r\n        ),\r\n      }));\r\n      \r\n      // ✅ Sync to API in background\r\n      if (apiEndpoint) {\r\n        const item = get().data.find((item: T) => item.systemId === systemId);\r\n        if (item) {\r\n          syncToAPI(apiEndpoint, 'restore', { ...item, isDeleted: false, deletedAt: null }, systemId).catch(console.error);\r\n        }\r\n      }\r\n    },\r\n    getActive: () => get().data.filter((item: any) => !item.isDeleted),\r\n    getDeleted: () => get().data.filter((item: any) => item.isDeleted),\r\n    findById: (id: SystemId | string) => get().data.find((item: T) => item.systemId === id || (item as any).id === id),\r\n    \r\n    // ✅ Load data from database API - OPTIMIZED: No more limit=10000!\r\n    // This is now only used for counter initialization, NOT for loading all data\r\n    // Use React Query hooks for data fetching with proper pagination\r\n    loadFromAPI: async () => {\r\n      if (!apiEndpoint) return;\r\n      if (get()._initialized) return;\r\n      \r\n      try {\r\n        // Only fetch minimal data needed to initialize counters\r\n        // Actual data loading should be done via React Query hooks\r\n        const response = await fetch(`${apiEndpoint}?limit=1&sortBy=systemId&sortOrder=desc`, {\r\n          credentials: 'include',\r\n        });\r\n        if (response.ok) {\r\n          const json = await response.json();\r\n          const pagination = json.pagination || {};\r\n          const lastItem = json.data?.[0];\r\n          \r\n          // Initialize counters from the latest item (highest IDs)\r\n          const newCounters = {\r\n            systemId: lastItem ? getMaxSystemIdCounter([lastItem], systemIdPrefix) : 0,\r\n            businessId: (lastItem && options?.businessIdField)\r\n              ? getMaxBusinessIdCounter([lastItem] as any[], businessPrefix)\r\n              : 0\r\n          };\r\n          \r\n          set({ \r\n            data: [], // Don't store data in Zustand anymore - use React Query\r\n            _counters: newCounters,\r\n            _initialized: true \r\n          });\r\n          \r\n          console.log(`[Store Factory] ${apiEndpoint} initialized. Total records: ${pagination.total || 'unknown'}`);\r\n        }\r\n      } catch (error) {\r\n        console.error(`[Store Factory] loadFromAPI error for ${apiEndpoint}:`, error);\r\n        // Still mark as initialized to prevent infinite retry\r\n        set({ _initialized: true });\r\n      }\r\n    },\r\n  });\r\n\r\n  // ✅ SIMPLIFIED: No localStorage persistence, database is source of truth\r\n  // Data is loaded via ApiSyncProvider on app init\r\n  return create<CrudState<T>>(storeConfig);\r\n};\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 478, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/attendance/store.ts"],"sourcesContent":["import { create } from 'zustand';\r\nimport type { AttendanceDataRow, AttendanceDayKey, DailyRecord } from './types';\r\nimport type { SystemId } from '../../lib/id-types';\r\n\r\n// API sync helper\r\nasync function syncToAPI(action: 'save' | 'lock' | 'unlock', data: any): Promise<boolean> {\r\n  try {\r\n    const endpoint = '/api/attendance';\r\n    const method = action === 'save' ? 'POST' : 'PATCH';\r\n    \r\n    const response = await fetch(endpoint, {\r\n      method,\r\n      headers: { 'Content-Type': 'application/json' },\r\n      body: JSON.stringify({ action, ...data }),\r\n    });\r\n    \r\n    if (!response.ok) {\r\n      console.error(`[Attendance API] ${action} failed:`, await response.text());\r\n      return false;\r\n    }\r\n    return true;\r\n  } catch (error) {\r\n    console.error(`[Attendance API] ${action} error:`, error);\r\n    return false;\r\n  }\r\n}\r\n\r\nasync function fetchFromAPI(monthKey: string): Promise<AttendanceDataRow[] | null> {\r\n  try {\r\n    const [year, month] = monthKey.split('-');\r\n    const fromDate = `${year}-${month}-01`;\r\n    const lastDay = new Date(parseInt(year), parseInt(month), 0).getDate();\r\n    const toDate = `${year}-${month}-${lastDay}`;\r\n    \r\n    // Attendance is filtered by month, so 500 records should cover most cases\r\n    const response = await fetch(`/api/attendance?fromDate=${fromDate}&toDate=${toDate}&limit=500`);\r\n    if (!response.ok) return null;\r\n    \r\n    const json = await response.json();\r\n    return json.data || null;\r\n  } catch (error) {\r\n    console.error('[Attendance API] fetch error:', error);\r\n    return null;\r\n  }\r\n}\r\n\r\ntype AttendanceStoreState = {\r\n  lockedMonths: Record<string, boolean>; // key: \"YYYY-MM\"\r\n  toggleLock: (monthYear: string) => void;\r\n  lockMonth: (monthYear: string) => void;\r\n  unlockMonth: (monthYear: string) => void;\r\n  \r\n  // Data storage\r\n  attendanceData: Record<string, AttendanceDataRow[]>; // key: \"YYYY-MM\"\r\n  saveAttendanceData: (monthKey: string, data: AttendanceDataRow[]) => void;\r\n  getAttendanceData: (monthKey: string) => AttendanceDataRow[] | null;\r\n  updateEmployeeRecord: (\r\n    monthKey: string,\r\n    employeeSystemId: SystemId,\r\n    dayKey: AttendanceDayKey,\r\n    record: DailyRecord\r\n  ) => void;\r\n  \r\n  // API sync\r\n  loadFromAPI: (monthKey: string) => Promise<void>;\r\n  initialized: boolean;\r\n};\r\n\r\nexport const useAttendanceStore = create<AttendanceStoreState>()(\r\n  (set, get) => ({\r\n      lockedMonths: {},\r\n      initialized: false,\r\n      \r\n      lockMonth: (monthYear) => {\r\n        set((state) => ({\r\n          lockedMonths: {\r\n            ...state.lockedMonths,\r\n            [monthYear]: true,\r\n          },\r\n        }));\r\n        // Sync to API\r\n        syncToAPI('lock', { monthYear }).catch(console.error);\r\n      },\r\n      unlockMonth: (monthYear) => {\r\n        set((state) => {\r\n          if (!state.lockedMonths[monthYear]) {\r\n            return state;\r\n          }\r\n          const nextLocked = { ...state.lockedMonths };\r\n          delete nextLocked[monthYear];\r\n          return { lockedMonths: nextLocked };\r\n        });\r\n        // Sync to API\r\n        syncToAPI('unlock', { monthYear }).catch(console.error);\r\n      },\r\n      toggleLock: (monthYear) => {\r\n        const isLocked = Boolean(get().lockedMonths[monthYear]);\r\n        if (isLocked) {\r\n          get().unlockMonth(monthYear);\r\n        } else {\r\n          get().lockMonth(monthYear);\r\n        }\r\n      },\r\n      \r\n      // Data management\r\n      attendanceData: {},\r\n      saveAttendanceData: (monthKey, data) => {\r\n        set((state) => ({\r\n          attendanceData: {\r\n            ...state.attendanceData,\r\n            [monthKey]: data,\r\n          },\r\n        }));\r\n        // Sync to API\r\n        syncToAPI('save', { monthKey, data }).catch(console.error);\r\n      },\r\n      getAttendanceData: (monthKey) => {\r\n        return get().attendanceData[monthKey] || null;\r\n      },\r\n      updateEmployeeRecord: (monthKey, employeeSystemId, dayKey, record) => {\r\n        set((state) => {\r\n          const monthData = state.attendanceData[monthKey];\r\n          if (!monthData) return state;\r\n          \r\n          const updatedData = monthData.map(emp => {\r\n            if (emp.employeeSystemId === employeeSystemId) {\r\n              return { ...emp, [dayKey]: record };\r\n            }\r\n            return emp;\r\n          });\r\n          \r\n          return {\r\n            attendanceData: {\r\n              ...state.attendanceData,\r\n              [monthKey]: updatedData,\r\n            },\r\n          };\r\n        });\r\n        // Sync single record to API\r\n        syncToAPI('save', { monthKey, employeeSystemId, dayKey, record }).catch(console.error);\r\n      },\r\n      \r\n      // Load from API\r\n      loadFromAPI: async (monthKey: string) => {\r\n        const apiData = await fetchFromAPI(monthKey);\r\n        if (apiData && apiData.length > 0) {\r\n          set((state) => ({\r\n            attendanceData: {\r\n              ...state.attendanceData,\r\n              [monthKey]: apiData,\r\n            },\r\n            initialized: true,\r\n          }));\r\n        }\r\n      },\r\n    })\r\n);\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 633, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/lib/id-types.ts"],"sourcesContent":["/**\r\n * Type-safe ID System\r\n * \r\n * Prevents mixing systemId with business ID at compile time\r\n */\r\n\r\n// Branded types for type safety\r\nexport type SystemId = string & { readonly __brand: 'SystemId' };\r\nexport type BusinessId = string & { readonly __brand: 'BusinessId' };\r\n\r\n/**\r\n * Create a SystemId from a string\r\n * Use this when you know for sure it's a systemId\r\n */\r\nexport function asSystemId(id: string): SystemId {\r\n  return id as SystemId;\r\n}\r\n\r\n/**\r\n * Create a BusinessId from a string\r\n * Use this when you know for sure it's a business ID\r\n */\r\nexport function asBusinessId(id: string): BusinessId {\r\n  return id as BusinessId;\r\n}\r\n\r\n/**\r\n * Check if a string is a valid systemId format\r\n */\r\nexport function isSystemIdFormat(id: string): boolean {\r\n  // SystemId: 8 digits + prefix (e.g., NV00000001, VOUCHER00000123)\r\n  return /^[A-Z]+\\d{8}$/.test(id);\r\n}\r\n\r\n/**\r\n * Check if a string is a valid business ID format\r\n */\r\nexport function isBusinessIdFormat(id: string): boolean {\r\n  // Business ID: shorter, variable length (e.g., NV001, PT000001)\r\n  return /^[A-Z]+\\d{3,6}$/.test(id);\r\n}\r\n\r\n/**\r\n * Safely convert unknown ID to proper type\r\n */\r\nexport function parseId(id: string): { type: 'system' | 'business'; value: SystemId | BusinessId } {\r\n  if (isSystemIdFormat(id)) {\r\n    return { type: 'system', value: asSystemId(id) };\r\n  }\r\n  if (isBusinessIdFormat(id)) {\r\n    return { type: 'business', value: asBusinessId(id) };\r\n  }\r\n  throw new Error(`Invalid ID format: ${id}`);\r\n}\r\n\r\n/**\r\n * ID Pair - Always keep systemId and businessId together\r\n */\r\nexport interface IDPair {\r\n  systemId: SystemId;\r\n  businessId: BusinessId;\r\n}\r\n\r\n/**\r\n * Entity with dual IDs\r\n */\r\nexport interface DualIDEntity {\r\n  systemId: SystemId;\r\n  id: BusinessId;\r\n}\r\n\r\n/**\r\n * Store methods with type-safe IDs\r\n */\r\nexport interface TypeSafeStore<T extends DualIDEntity> {\r\n  /** Find by systemId (for queries, relationships) */\r\n  findBySystemId(systemId: SystemId): T | null;\r\n  \r\n  /** Find by business ID (for user input, display) */\r\n  findByBusinessId(businessId: BusinessId): T | null;\r\n  \r\n  /** Update by systemId (always use systemId for updates) */\r\n  updateBySystemId(systemId: SystemId, updates: Partial<T>): void;\r\n  \r\n  /** Delete by systemId (always use systemId for deletes) */\r\n  deleteBySystemId(systemId: SystemId): void;\r\n}\r\n\r\n/**\r\n * Route params with type-safe IDs\r\n */\r\nexport interface RouteParams {\r\n  systemId?: SystemId;\r\n  id?: BusinessId;\r\n}\r\n\r\n/**\r\n * Link builder - always uses systemId\r\n */\r\nexport function buildEntityLink(path: string, entity: DualIDEntity): string {\r\n  return path.replace(':systemId', entity.systemId);\r\n}\r\n\r\n/**\r\n * Display ID - always uses business ID\r\n */\r\nexport function getDisplayId(entity: DualIDEntity): string {\r\n  return entity.id;\r\n}\r\n\r\n/**\r\n * Runtime guard: ensures a string is valid SystemId format and casts it\r\n * Logs warning if format is invalid\r\n */\r\nexport function ensureSystemId(id: string, context?: string): SystemId {\r\n  if (!isSystemIdFormat(id)) {\r\n    console.warn(`[ensureSystemId] Invalid SystemId format: \"${id}\"${context ? ` in ${context}` : ''}`);\r\n  }\r\n  return asSystemId(id);\r\n}\r\n\r\n/**\r\n * Runtime guard: ensures a string is valid BusinessId format and casts it\r\n * Logs warning if format is invalid\r\n */\r\nexport function ensureBusinessId(id: string, context?: string): BusinessId {\r\n  if (!isBusinessIdFormat(id)) {\r\n    console.warn(`[ensureBusinessId] Invalid BusinessId format: \"${id}\"${context ? ` in ${context}` : ''}`);\r\n  }\r\n  return asBusinessId(id);\r\n}\r\n"],"names":[],"mappings":"AAAA;;;;CAIC,GAED,gCAAgC;;;;;;;;;;;;;;;;;;;;;AAQzB,SAAS,WAAW,EAAU;IACnC,OAAO;AACT;AAMO,SAAS,aAAa,EAAU;IACrC,OAAO;AACT;AAKO,SAAS,iBAAiB,EAAU;IACzC,kEAAkE;IAClE,OAAO,gBAAgB,IAAI,CAAC;AAC9B;AAKO,SAAS,mBAAmB,EAAU;IAC3C,gEAAgE;IAChE,OAAO,kBAAkB,IAAI,CAAC;AAChC;AAKO,SAAS,QAAQ,EAAU;IAChC,IAAI,iBAAiB,KAAK;QACxB,OAAO;YAAE,MAAM;YAAU,OAAO,WAAW;QAAI;IACjD;IACA,IAAI,mBAAmB,KAAK;QAC1B,OAAO;YAAE,MAAM;YAAY,OAAO,aAAa;QAAI;IACrD;IACA,MAAM,IAAI,MAAM,CAAC,mBAAmB,EAAE,IAAI;AAC5C;AA8CO,SAAS,gBAAgB,IAAY,EAAE,MAAoB;IAChE,OAAO,KAAK,OAAO,CAAC,aAAa,OAAO,QAAQ;AAClD;AAKO,SAAS,aAAa,MAAoB;IAC/C,OAAO,OAAO,EAAE;AAClB;AAMO,SAAS,eAAe,EAAU,EAAE,OAAgB;IACzD,IAAI,CAAC,iBAAiB,KAAK;QACzB,QAAQ,IAAI,CAAC,CAAC,2CAA2C,EAAE,GAAG,CAAC,EAAE,UAAU,CAAC,IAAI,EAAE,SAAS,GAAG,IAAI;IACpG;IACA,OAAO,WAAW;AACpB;AAMO,SAAS,iBAAiB,EAAU,EAAE,OAAgB;IAC3D,IAAI,CAAC,mBAAmB,KAAK;QAC3B,QAAQ,IAAI,CAAC,CAAC,+CAA+C,EAAE,GAAG,CAAC,EAAE,UAAU,CAAC,IAAI,EAAE,SAAS,GAAG,IAAI;IACxG;IACA,OAAO,aAAa;AACtB"}},
    {"offset": {"line": 712, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/settings/employees/employee-settings-store.ts"],"sourcesContent":["import { create } from 'zustand';\r\nimport type { EmployeeSettings, LeaveType, SalaryComponent, WorkShift } from './types';\r\nimport { getCurrentUserSystemId } from '../../../contexts/auth-context';\r\nimport { generateSystemId, getMaxBusinessIdCounter, getMaxSystemIdCounter, findNextAvailableBusinessId } from '../../../lib/id-utils';\r\nimport { getPrefix, type EntityType } from '../../../lib/smart-prefix';\r\nimport { getEntityConfig } from '../../../lib/id-config';\r\nimport { asBusinessId, asSystemId, type BusinessId, type SystemId } from '@/lib/id-types';\r\n\r\nconst SETTINGS_ENTITY_MAP = {\r\n  workShifts: 'work-shifts',\r\n  leaveTypes: 'leave-types',\r\n  salaryComponents: 'salary-components',\r\n} as const;\r\n\r\ntype SettingsEntityKey = keyof typeof SETTINGS_ENTITY_MAP;\r\ntype SettingsEntityType = (typeof SETTINGS_ENTITY_MAP)[SettingsEntityKey];\r\n\r\ntype CounterState = {\r\n  systemId: number;\r\n  businessId: number;\r\n};\r\n\r\ntype SettingsCounters = Record<SettingsEntityType, CounterState>;\r\n\r\nconst defaultSettings: EmployeeSettings = {\r\n  workStartTime: '08:30',\r\n  workEndTime: '18:00',\r\n  lunchBreakDuration: 90, // 1.5 giờ = 90 phút\r\n  lunchBreakStart: '12:00',\r\n  lunchBreakEnd: '13:30',\r\n  workingDays: [1, 2, 3, 4, 5, 6], // Thứ 2 - Thứ 7 (Mon-Sat)\r\n  workShifts: [\r\n    {\r\n      systemId: asSystemId('WSHIFT000001'),\r\n      id: asBusinessId('CA000001'),\r\n      name: 'Ca hành chính',\r\n      startTime: '08:30',\r\n      endTime: '18:00',\r\n      applicableDepartmentSystemIds: [],\r\n    },\r\n    {\r\n      systemId: asSystemId('WSHIFT000002'),\r\n      id: asBusinessId('CA000002'),\r\n      name: 'Ca tối',\r\n      startTime: '14:00',\r\n      endTime: '22:00',\r\n      applicableDepartmentSystemIds: [],\r\n    },\r\n  ],\r\n  otHourlyRate: 25000,  // 25k/giờ làm thêm ngày thường\r\n  otRateWeekend: 1.5,   // Hệ số x1.5 cuối tuần\r\n  otRateHoliday: 3,     // Hệ số x3 ngày lễ\r\n  allowedLateMinutes: 5, // Sau 5 phút mới tính là đi trễ\r\n  latePenaltyTiers: [\r\n    { fromMinutes: 5, toMinutes: 10, amount: 10000 },   // 5-10 phút: 10k\r\n    { fromMinutes: 10, toMinutes: 30, amount: 20000 },  // 10-30 phút: 20k\r\n    { fromMinutes: 30, toMinutes: 60, amount: 50000 },  // 30-60 phút: 50k\r\n    { fromMinutes: 60, toMinutes: null, amount: 100000 }, // >60 phút: 100k\r\n  ],\r\n  earlyLeavePenaltyTiers: [\r\n    { fromMinutes: 5, toMinutes: 10, amount: 10000 },\r\n    { fromMinutes: 10, toMinutes: 30, amount: 20000 },\r\n    { fromMinutes: 30, toMinutes: 60, amount: 50000 },\r\n    { fromMinutes: 60, toMinutes: null, amount: 100000 },\r\n  ],\r\n  leaveTypes: [\r\n    {\r\n      systemId: asSystemId('LEAVETYPE000001'),\r\n      id: asBusinessId('LP000001'),\r\n      name: 'Nghỉ phép năm',\r\n      numberOfDays: 12,\r\n      isPaid: true,\r\n      requiresAttachment: false,\r\n      applicableGender: 'All',\r\n      applicableDepartmentSystemIds: [],\r\n    },\r\n    {\r\n      systemId: asSystemId('LEAVETYPE000002'),\r\n      id: asBusinessId('LP000002'),\r\n      name: 'Nghỉ bệnh',\r\n      numberOfDays: 7,\r\n      isPaid: true,\r\n      requiresAttachment: true,\r\n      applicableGender: 'All',\r\n      applicableDepartmentSystemIds: [],\r\n    },\r\n  ],\r\n  baseAnnualLeaveDays: 12,\r\n  annualLeaveSeniorityBonus: {\r\n    years: 5,\r\n    additionalDays: 1,\r\n  },\r\n  allowRollover: false,\r\n  rolloverExpirationDate: '03-31',\r\n  salaryComponents: [\r\n    // =============================================\r\n    // NHÓM THU NHẬP (EARNINGS)\r\n    // =============================================\r\n    {\r\n      systemId: asSystemId('SALCOMP000001'),\r\n      id: asBusinessId('SC000001'),\r\n      name: 'Lương cơ bản',\r\n      description: 'Lương theo ngày công thực tế = Lương HĐ × (Ngày công / Ngày chuẩn)',\r\n      category: 'earning',\r\n      type: 'formula',\r\n      formula: 'baseSalary * (workDays / standardWorkDays)',\r\n      taxable: true,\r\n      partOfSocialInsurance: true,\r\n      isActive: true,\r\n      sortOrder: 1,\r\n      applicableDepartmentSystemIds: [],\r\n    },\r\n    {\r\n      systemId: asSystemId('SALCOMP000002'),\r\n      id: asBusinessId('SC000002'),\r\n      name: 'Phụ cấp ăn trưa',\r\n      description: 'Phụ cấp theo ngày công thực tế = Ngày công × Mức tiền/ngày (không tính thuế)',\r\n      category: 'earning',\r\n      type: 'formula',\r\n      formula: 'workDays * mealAllowancePerDay',\r\n      taxable: false,\r\n      partOfSocialInsurance: false,\r\n      isActive: true,\r\n      sortOrder: 2,\r\n      applicableDepartmentSystemIds: [],\r\n    },\r\n    {\r\n      systemId: asSystemId('SALCOMP000003'),\r\n      id: asBusinessId('SC000003'),\r\n      name: 'Phụ cấp xăng xe',\r\n      description: 'Phụ cấp đi lại, xăng xe hàng tháng',\r\n      category: 'earning',\r\n      type: 'fixed',\r\n      amount: 500000,\r\n      taxable: false,\r\n      partOfSocialInsurance: false,\r\n      isActive: true,\r\n      sortOrder: 3,\r\n      applicableDepartmentSystemIds: [],\r\n    },\r\n    {\r\n      systemId: asSystemId('SALCOMP000004'),\r\n      id: asBusinessId('SC000004'),\r\n      name: 'Phụ cấp điện thoại',\r\n      description: 'Phụ cấp liên lạc, điện thoại công việc',\r\n      category: 'earning',\r\n      type: 'fixed',\r\n      amount: 300000,\r\n      taxable: false,\r\n      partOfSocialInsurance: false,\r\n      isActive: true,\r\n      sortOrder: 4,\r\n      applicableDepartmentSystemIds: [],\r\n    },\r\n    {\r\n      systemId: asSystemId('SALCOMP000005'),\r\n      id: asBusinessId('SC000005'),\r\n      name: 'Phụ cấp chức vụ',\r\n      description: 'Phụ cấp trách nhiệm theo chức vụ quản lý',\r\n      category: 'earning',\r\n      type: 'fixed',\r\n      amount: 2000000,\r\n      taxable: true,\r\n      partOfSocialInsurance: true,\r\n      isActive: true,\r\n      sortOrder: 5,\r\n      applicableDepartmentSystemIds: [],\r\n    },\r\n    {\r\n      systemId: asSystemId('SALCOMP000006'),\r\n      id: asBusinessId('SC000006'),\r\n      name: 'Phụ cấp thâm niên',\r\n      description: 'Phụ cấp theo số năm làm việc tại công ty',\r\n      category: 'earning',\r\n      type: 'fixed',\r\n      amount: 500000,\r\n      taxable: true,\r\n      partOfSocialInsurance: false,\r\n      isActive: true,\r\n      sortOrder: 6,\r\n      applicableDepartmentSystemIds: [],\r\n    },\r\n    {\r\n      systemId: asSystemId('SALCOMP000007'),\r\n      id: asBusinessId('SC000007'),\r\n      name: 'Phụ cấp độc hại',\r\n      description: 'Phụ cấp cho công việc trong môi trường độc hại, nguy hiểm',\r\n      category: 'earning',\r\n      type: 'fixed',\r\n      amount: 1000000,\r\n      taxable: true,\r\n      partOfSocialInsurance: true,\r\n      isActive: false,\r\n      sortOrder: 7,\r\n      applicableDepartmentSystemIds: [],\r\n    },\r\n    {\r\n      systemId: asSystemId('SALCOMP000008'),\r\n      id: asBusinessId('SC000008'),\r\n      name: 'Thưởng chuyên cần',\r\n      description: 'Thưởng đi làm đầy đủ, không nghỉ phép trong tháng',\r\n      category: 'earning',\r\n      type: 'fixed',\r\n      amount: 500000,\r\n      taxable: true,\r\n      partOfSocialInsurance: false,\r\n      isActive: true,\r\n      sortOrder: 8,\r\n      applicableDepartmentSystemIds: [],\r\n    },\r\n    {\r\n      systemId: asSystemId('SALCOMP000009'),\r\n      id: asBusinessId('SC000009'),\r\n      name: 'Thưởng KPI',\r\n      description: 'Thưởng hoàn thành chỉ tiêu KPI tháng',\r\n      category: 'earning',\r\n      type: 'formula',\r\n      formula: '[LUONG_CO_BAN] * 0.1',\r\n      taxable: true,\r\n      partOfSocialInsurance: false,\r\n      isActive: true,\r\n      sortOrder: 9,\r\n      applicableDepartmentSystemIds: [],\r\n    },\r\n    // =============================================\r\n    // NHÓM LÀM THÊM GIỜ (OT) - Chi tiết theo loại ngày\r\n    // =============================================\r\n    {\r\n      systemId: asSystemId('SALCOMP000010'),\r\n      id: asBusinessId('SC000010'),\r\n      name: 'Làm thêm ngày thường',\r\n      description: 'Tiền làm thêm sau giờ tan làm (18:00) các ngày trong tuần. Công thức: Giờ OT x Tiền/giờ',\r\n      category: 'earning',\r\n      type: 'formula',\r\n      formula: 'otPayWeekday',\r\n      taxable: true,\r\n      partOfSocialInsurance: false,\r\n      isActive: true,\r\n      sortOrder: 10,\r\n      applicableDepartmentSystemIds: [],\r\n    },\r\n    {\r\n      systemId: asSystemId('SALCOMP000020'),\r\n      id: asBusinessId('SC000020'),\r\n      name: 'Làm thêm cuối tuần',\r\n      description: 'Tiền làm thêm thứ 7 & Chủ nhật. Công thức: Giờ OT x Tiền/giờ x Hệ số cuối tuần (1.5)',\r\n      category: 'earning',\r\n      type: 'formula',\r\n      formula: 'otPayWeekend',\r\n      taxable: true,\r\n      partOfSocialInsurance: false,\r\n      isActive: true,\r\n      sortOrder: 11,\r\n      applicableDepartmentSystemIds: [],\r\n    },\r\n    {\r\n      systemId: asSystemId('SALCOMP000021'),\r\n      id: asBusinessId('SC000021'),\r\n      name: 'Làm thêm ngày lễ',\r\n      description: 'Tiền làm thêm các ngày lễ. Công thức: Giờ OT x Tiền/giờ x Hệ số ngày lễ (3)',\r\n      category: 'earning',\r\n      type: 'formula',\r\n      formula: 'otPayHoliday',\r\n      taxable: true,\r\n      partOfSocialInsurance: false,\r\n      isActive: true,\r\n      sortOrder: 12,\r\n      applicableDepartmentSystemIds: [],\r\n    },\r\n    {\r\n      systemId: asSystemId('SALCOMP000011'),\r\n      id: asBusinessId('SC000011'),\r\n      name: 'Hoa hồng bán hàng',\r\n      description: 'Hoa hồng theo doanh số bán hàng (áp dụng cho bộ phận Kinh doanh)',\r\n      category: 'earning',\r\n      type: 'fixed',\r\n      amount: 0,\r\n      taxable: true,\r\n      partOfSocialInsurance: false,\r\n      isActive: true,\r\n      sortOrder: 13,\r\n      applicableDepartmentSystemIds: [],\r\n    },\r\n    // =============================================\r\n    // NHÓM KHẤU TRỪ (DEDUCTIONS)\r\n    // =============================================\r\n    {\r\n      systemId: asSystemId('SALCOMP000012'),\r\n      id: asBusinessId('SC000012'),\r\n      name: 'Khấu trừ đi trễ',\r\n      description: 'Trừ lương theo số lần/phút đi trễ trong tháng',\r\n      category: 'deduction',\r\n      type: 'fixed',\r\n      amount: 0,\r\n      taxable: false,\r\n      partOfSocialInsurance: false,\r\n      isActive: true,\r\n      sortOrder: 20,\r\n      applicableDepartmentSystemIds: [],\r\n    },\r\n    {\r\n      systemId: asSystemId('SALCOMP000013'),\r\n      id: asBusinessId('SC000013'),\r\n      name: 'Khấu trừ nghỉ không phép',\r\n      description: 'Trừ lương theo số ngày nghỉ không phép',\r\n      category: 'deduction',\r\n      type: 'formula',\r\n      formula: '[NGAY_NGHI_KHONG_PHEP] * ([LUONG_CO_BAN] / [NGAY_CONG_CHUAN])',\r\n      taxable: false,\r\n      partOfSocialInsurance: false,\r\n      isActive: true,\r\n      sortOrder: 21,\r\n      applicableDepartmentSystemIds: [],\r\n    },\r\n    {\r\n      systemId: asSystemId('SALCOMP000014'),\r\n      id: asBusinessId('SC000014'),\r\n      name: 'Tạm ứng lương',\r\n      description: 'Khấu trừ khoản tạm ứng lương đã nhận trước',\r\n      category: 'deduction',\r\n      type: 'fixed',\r\n      amount: 0,\r\n      taxable: false,\r\n      partOfSocialInsurance: false,\r\n      isActive: true,\r\n      sortOrder: 22,\r\n      applicableDepartmentSystemIds: [],\r\n    },\r\n    {\r\n      systemId: asSystemId('SALCOMP000015'),\r\n      id: asBusinessId('SC000015'),\r\n      name: 'Khấu trừ công nợ',\r\n      description: 'Khấu trừ các khoản nợ công ty (vay, mượn...)',\r\n      category: 'deduction',\r\n      type: 'fixed',\r\n      amount: 0,\r\n      taxable: false,\r\n      partOfSocialInsurance: false,\r\n      isActive: false,\r\n      sortOrder: 23,\r\n      applicableDepartmentSystemIds: [],\r\n    },\r\n    // =============================================\r\n    // NHÓM ĐÓNG GÓP (CONTRIBUTIONS) - Tự động tính\r\n    // =============================================\r\n    {\r\n      systemId: asSystemId('SALCOMP000016'),\r\n      id: asBusinessId('SC000016'),\r\n      name: 'BHXH (NV đóng)',\r\n      description: 'Bảo hiểm xã hội phần người lao động đóng (8%)',\r\n      category: 'contribution',\r\n      type: 'formula',\r\n      formula: '[LUONG_DONG_BHXH] * 0.08',\r\n      taxable: false,\r\n      partOfSocialInsurance: false,\r\n      isActive: true,\r\n      sortOrder: 30,\r\n      applicableDepartmentSystemIds: [],\r\n    },\r\n    {\r\n      systemId: asSystemId('SALCOMP000017'),\r\n      id: asBusinessId('SC000017'),\r\n      name: 'BHYT (NV đóng)',\r\n      description: 'Bảo hiểm y tế phần người lao động đóng (1.5%)',\r\n      category: 'contribution',\r\n      type: 'formula',\r\n      formula: '[LUONG_DONG_BHXH] * 0.015',\r\n      taxable: false,\r\n      partOfSocialInsurance: false,\r\n      isActive: true,\r\n      sortOrder: 31,\r\n      applicableDepartmentSystemIds: [],\r\n    },\r\n    {\r\n      systemId: asSystemId('SALCOMP000018'),\r\n      id: asBusinessId('SC000018'),\r\n      name: 'BHTN (NV đóng)',\r\n      description: 'Bảo hiểm thất nghiệp phần người lao động đóng (1%)',\r\n      category: 'contribution',\r\n      type: 'formula',\r\n      formula: '[LUONG_DONG_BHXH] * 0.01',\r\n      taxable: false,\r\n      partOfSocialInsurance: false,\r\n      isActive: true,\r\n      sortOrder: 32,\r\n      applicableDepartmentSystemIds: [],\r\n    },\r\n    {\r\n      systemId: asSystemId('SALCOMP000019'),\r\n      id: asBusinessId('SC000019'),\r\n      name: 'Công đoàn phí',\r\n      description: 'Phí công đoàn hàng tháng (1% lương cơ bản)',\r\n      category: 'contribution',\r\n      type: 'formula',\r\n      formula: '[LUONG_CO_BAN] * 0.01',\r\n      taxable: false,\r\n      partOfSocialInsurance: false,\r\n      isActive: false,\r\n      sortOrder: 33,\r\n      applicableDepartmentSystemIds: [],\r\n    },\r\n  ],\r\n  payrollCycle: 'monthly',\r\n  payday: 5,\r\n  payrollLockDate: 5,\r\n  \r\n  // =============================================\r\n  // CÀI ĐẶT BẢO HIỂM (Luật BHXH 2024)\r\n  // =============================================\r\n  insuranceRates: {\r\n    socialInsurance: {\r\n      employeeRate: 8,      // BHXH NV đóng 8%\r\n      employerRate: 17.5,   // BHXH DN đóng 17.5%\r\n    },\r\n    healthInsurance: {\r\n      employeeRate: 1.5,    // BHYT NV đóng 1.5%\r\n      employerRate: 3,      // BHYT DN đóng 3%\r\n    },\r\n    unemploymentInsurance: {\r\n      employeeRate: 1,      // BHTN NV đóng 1%\r\n      employerRate: 1,      // BHTN DN đóng 1%\r\n    },\r\n    // Trần đóng BHXH = 20 x lương cơ sở (từ 1/7/2024)\r\n    insuranceSalaryCap: 46800000,   // 20 x 2,340,000\r\n    baseSalaryReference: 2340000,    // Lương cơ sở từ 1/7/2024\r\n  },\r\n  \r\n  // =============================================\r\n  // CÀI ĐẶT THUẾ TNCN (Luật thuế TNCN hiện hành)\r\n  // =============================================\r\n  taxSettings: {\r\n    personalDeduction: 11000000,    // Giảm trừ bản thân 11 triệu/tháng\r\n    dependentDeduction: 4400000,    // Giảm trừ mỗi người phụ thuộc 4.4 triệu/tháng\r\n    // Biểu thuế lũy tiến từng phần (theo thu nhập tính thuế/tháng)\r\n    taxBrackets: [\r\n      { fromAmount: 0, toAmount: 5000000, rate: 5 },\r\n      { fromAmount: 5000000, toAmount: 10000000, rate: 10 },\r\n      { fromAmount: 10000000, toAmount: 18000000, rate: 15 },\r\n      { fromAmount: 18000000, toAmount: 32000000, rate: 20 },\r\n      { fromAmount: 32000000, toAmount: 52000000, rate: 25 },\r\n      { fromAmount: 52000000, toAmount: 80000000, rate: 30 },\r\n      { fromAmount: 80000000, toAmount: null, rate: 35 },\r\n    ],\r\n  },\r\n  \r\n  // =============================================\r\n  // LƯƠNG TỐI THIỂU VÙNG (NĐ 74/2024/NĐ-CP từ 1/7/2024)\r\n  // =============================================\r\n  minimumWage: {\r\n    region1: 4960000,   // Vùng I\r\n    region2: 4410000,   // Vùng II\r\n    region3: 3860000,   // Vùng III\r\n    region4: 3450000,   // Vùng IV\r\n  },\r\n  \r\n  // Số ngày công chuẩn trong tháng\r\n  standardWorkDays: 26,\r\n  \r\n  // Phụ cấp ăn trưa theo ngày công\r\n  mealAllowancePerDay: 30000, // 30k/ngày\r\n};\r\n\r\ntype EmployeeSettingsState = {\r\n  settings: EmployeeSettings;\r\n  counters: SettingsCounters;\r\n  initialized: boolean;\r\n  setSettings: (settings: EmployeeSettings) => void;\r\n  getShiftBySystemId: (systemId: SystemId) => WorkShift | undefined;\r\n  getLeaveTypes: () => LeaveType[];\r\n  getSalaryComponents: () => SalaryComponent[];\r\n  getDefaultPayrollWindow: () => {\r\n    cycle: EmployeeSettings['payrollCycle'];\r\n    payday: number;\r\n    lockDate: number;\r\n  };\r\n  loadFromAPI: () => Promise<void>;\r\n};\r\n\r\nconst cloneSettings = (payload?: EmployeeSettings): EmployeeSettings => ({\r\n  ...defaultSettings,\r\n  ...payload,\r\n  annualLeaveSeniorityBonus: {\r\n    ...defaultSettings.annualLeaveSeniorityBonus,\r\n    ...(payload?.annualLeaveSeniorityBonus ?? {}),\r\n  },\r\n  workShifts: (payload?.workShifts ?? defaultSettings.workShifts).map((shift) => ({ ...shift })),\r\n  leaveTypes: (payload?.leaveTypes ?? defaultSettings.leaveTypes).map((type) => ({ ...type })),\r\n  salaryComponents: (payload?.salaryComponents ?? defaultSettings.salaryComponents).map((component) => ({ ...component })),\r\n});\r\n\r\nconst computeCounter = <T extends { systemId?: SystemId; id?: BusinessId }>(\r\n  items: T[],\r\n  entityType: EntityType\r\n): CounterState => {\r\n  const config = getEntityConfig(entityType);\r\n  const systemItems = items\r\n    .filter((item): item is T & { systemId: SystemId } => Boolean(item.systemId))\r\n    .map(({ systemId }) => ({ systemId }));\r\n  const businessItems = items\r\n    .filter((item): item is T & { id: BusinessId } => Boolean(item.id))\r\n    .map(({ id }) => ({ id }));\r\n  return {\r\n    systemId: getMaxSystemIdCounter(systemItems, config.systemIdPrefix),\r\n    businessId: getMaxBusinessIdCounter(businessItems, getPrefix(entityType)),\r\n  };\r\n};\r\n\r\nconst buildCounters = (settings: EmployeeSettings): SettingsCounters => ({\r\n  'work-shifts': computeCounter(settings.workShifts, 'work-shifts'),\r\n  'leave-types': computeCounter(settings.leaveTypes, 'leave-types'),\r\n  'salary-components': computeCounter(settings.salaryComponents, 'salary-components'),\r\n});\r\n\r\ntype BaseSettingsEntity = {\r\n  systemId?: SystemId;\r\n  id?: BusinessId;\r\n  createdAt?: string;\r\n  createdBy?: SystemId;\r\n  updatedAt?: string;\r\n  updatedBy?: SystemId;\r\n  applicableDepartmentSystemIds?: SystemId[];\r\n};\r\n\r\nconst normalizeCollection = <T extends BaseSettingsEntity>(\r\n  items: T[],\r\n  entityType: SettingsEntityType,\r\n  counters: SettingsCounters,\r\n  currentUser?: SystemId\r\n): { records: T[]; counters: SettingsCounters } => {\r\n  let systemCounter = counters[entityType]?.systemId ?? 0;\r\n  let businessCounter = counters[entityType]?.businessId ?? 0;\r\n  const prefix = getPrefix(entityType);\r\n  const config = getEntityConfig(entityType);\r\n  const allKnownIds = new Set<string>(\r\n    items\r\n      .map((item) => item.id?.toUpperCase())\r\n      .filter((id): id is string => Boolean(id))\r\n  );\r\n  const usedIds = new Set<string>();\r\n  const now = new Date().toISOString();\r\n\r\n  const records = items.map((item) => {\r\n    let systemId = item.systemId;\r\n    const hasValidSystemId = Boolean(systemId && systemId.startsWith(config.systemIdPrefix));\r\n    const isNew = !hasValidSystemId;\r\n    if (!hasValidSystemId) {\r\n      systemCounter += 1;\r\n      systemId = asSystemId(generateSystemId(entityType, systemCounter));\r\n    }\r\n\r\n    let businessIdString = item.id ? String(item.id).toUpperCase() : undefined;\r\n    const hasValidBusinessId = Boolean(businessIdString && businessIdString.startsWith(prefix));\r\n    if (!hasValidBusinessId || (businessIdString && usedIds.has(businessIdString))) {\r\n      const { nextId, updatedCounter } = findNextAvailableBusinessId(prefix, Array.from(allKnownIds), businessCounter);\r\n      businessIdString = nextId;\r\n      businessCounter = updatedCounter;\r\n    }\r\n    if (!businessIdString) {\r\n      businessCounter += 1;\r\n      businessIdString = `${prefix}${String(businessCounter).padStart(config.digitCount, '0')}`;\r\n    }\r\n\r\n    allKnownIds.add(businessIdString);\r\n    usedIds.add(businessIdString);\r\n\r\n    const resolvedSystemId = systemId ?? asSystemId(generateSystemId(entityType, systemCounter));\r\n    const resolvedBusinessId = asBusinessId(businessIdString);\r\n\r\n    const createdAt = item.createdAt ?? now;\r\n    const createdBy = item.createdBy ?? (isNew && currentUser ? currentUser : item.createdBy);\r\n\r\n    return {\r\n      ...item,\r\n      systemId: resolvedSystemId,\r\n      id: resolvedBusinessId,\r\n      applicableDepartmentSystemIds: item.applicableDepartmentSystemIds ?? [],\r\n      createdAt,\r\n      createdBy,\r\n      updatedAt: now,\r\n      updatedBy: currentUser ?? item.updatedBy,\r\n    } as T;\r\n  });\r\n\r\n  return {\r\n    records,\r\n    counters: {\r\n      ...counters,\r\n      [entityType]: {\r\n        systemId: systemCounter,\r\n        businessId: businessCounter,\r\n      },\r\n    },\r\n  };\r\n};\r\n\r\nconst normalizeSettings = (\r\n  incoming: EmployeeSettings,\r\n  counters: SettingsCounters,\r\n  currentUser?: SystemId\r\n): { settings: EmployeeSettings; counters: SettingsCounters } => {\r\n  let nextCounters = { ...counters };\r\n  const normalizedShifts = normalizeCollection(incoming.workShifts, 'work-shifts', nextCounters, currentUser);\r\n  nextCounters = normalizedShifts.counters;\r\n  const normalizedLeaves = normalizeCollection(incoming.leaveTypes, 'leave-types', nextCounters, currentUser);\r\n  nextCounters = normalizedLeaves.counters;\r\n  const normalizedComponents = normalizeCollection(incoming.salaryComponents, 'salary-components', nextCounters, currentUser);\r\n\r\n  return {\r\n    settings: {\r\n      ...incoming,\r\n      workShifts: normalizedShifts.records,\r\n      leaveTypes: normalizedLeaves.records,\r\n      salaryComponents: normalizedComponents.records,\r\n    },\r\n    counters: normalizedComponents.counters,\r\n  };\r\n};\r\n\r\nconst buildInitialState = () => {\r\n  const cloned = cloneSettings(defaultSettings);\r\n  const counters = buildCounters(cloned);\r\n  return normalizeSettings(cloned, counters);\r\n};\r\n\r\nconst initialState = buildInitialState();\r\n\r\n// API sync helper\r\nasync function syncSettingsToAPI(settings: EmployeeSettings): Promise<boolean> {\r\n  try {\r\n    const response = await fetch('/api/settings/employees', {\r\n      method: 'PUT',\r\n      headers: { 'Content-Type': 'application/json' },\r\n      body: JSON.stringify(settings),\r\n    });\r\n    return response.ok;\r\n  } catch (error) {\r\n    console.error('[Employee Settings API] sync error:', error);\r\n    return false;\r\n  }\r\n}\r\n\r\nexport const useEmployeeSettingsStore = create<EmployeeSettingsState>()(\r\n  (set, get) => ({\r\n      settings: initialState.settings,\r\n      counters: initialState.counters,\r\n      initialized: false,\r\n      setSettings: (payload) => {\r\n        const cloned = cloneSettings(payload);\r\n        const currentUser = getCurrentUserSystemId();\r\n        const normalized = normalizeSettings(\r\n          cloned,\r\n          get().counters,\r\n          currentUser ? asSystemId(currentUser) : undefined\r\n        );\r\n        set(normalized);\r\n        \r\n        // Sync to API\r\n        syncSettingsToAPI(normalized.settings).catch(console.error);\r\n      },\r\n      getShiftBySystemId: (systemId) => get().settings.workShifts.find((shift) => shift.systemId === systemId),\r\n      getLeaveTypes: () => get().settings.leaveTypes,\r\n      getSalaryComponents: () => get().settings.salaryComponents,\r\n      getDefaultPayrollWindow: () => {\r\n        const current = get().settings;\r\n        return {\r\n          cycle: current.payrollCycle,\r\n          payday: current.payday,\r\n          lockDate: current.payrollLockDate,\r\n        };\r\n      },\r\n      \r\n      loadFromAPI: async () => {\r\n        if (get().initialized) return;\r\n        \r\n        try {\r\n          const response = await fetch('/api/settings/employees');\r\n          if (response.ok) {\r\n            const json = await response.json();\r\n            const settings = json.data || json.settings;\r\n            if (settings) {\r\n              const cloned = cloneSettings(settings);\r\n              const counters = buildCounters(cloned);\r\n              const normalized = normalizeSettings(cloned, counters);\r\n              set({ ...normalized, initialized: true });\r\n            } else {\r\n              set({ initialized: true });\r\n            }\r\n          }\r\n        } catch (error) {\r\n          console.error('[Employee Settings Store] loadFromAPI error:', error);\r\n        }\r\n      },\r\n    })\r\n);\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1419, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/attendance/utils.ts"],"sourcesContent":["import { formatDate, formatDateTime, formatDateTimeSeconds, formatDateCustom, parseDate, getCurrentDate, toISODate, isValidDate, isDateAfter, getStartOfDay, getEndOfDay, getDayOfWeek } from '../../lib/date-utils';\r\nimport type { AttendanceDataRow, DailyRecord, AnyAttendanceDataRow } from './types';\r\nimport type { EmployeeSettings } from '../settings/employees/types';\r\nimport type { Employee } from '../employees/types';\r\nimport type { SystemId, BusinessId } from '../../lib/id-types';\r\n\r\n/**\r\n * Initialize empty attendance data for employees\r\n * Creates attendance rows with default status (weekend/absent) based on working days\r\n * NO mock data - just empty structure ready for real data input\r\n */\r\nexport function initializeEmptyAttendance(\r\n  employees: Employee[],\r\n  year: number,\r\n  month: number,\r\n  settings: EmployeeSettings\r\n): AttendanceDataRow[] {\r\n  const daysInMonth = new Date(year, month, 0).getDate();\r\n  \r\n  return employees.map((emp) => {\r\n    const row: AnyAttendanceDataRow = {\r\n      systemId: emp.systemId,\r\n      employeeSystemId: emp.systemId,\r\n      employeeId: emp.id,\r\n      fullName: emp.fullName,\r\n      department: emp.department,\r\n      workDays: 0,\r\n      leaveDays: 0,\r\n      absentDays: 0,\r\n      lateArrivals: 0,\r\n      earlyDepartures: 0,\r\n      otHours: 0,\r\n      otHoursWeekday: 0,\r\n      otHoursWeekend: 0,\r\n      otHoursHoliday: 0,\r\n    };\r\n\r\n    // Initialize each day with default status\r\n    for (let d = 1; d <= daysInMonth; d++) {\r\n      const workDate = new Date(year, month - 1, d);\r\n      const dayOfWeek = getDayOfWeek(workDate);\r\n      const isWorkingDay = dayOfWeek !== null && settings.workingDays.includes(dayOfWeek);\r\n      \r\n      row[`day_${d}`] = {\r\n        status: isWorkingDay ? 'absent' : 'weekend',\r\n      };\r\n    }\r\n\r\n    return row as AttendanceDataRow;\r\n  });\r\n}\r\n\r\n// Function to convert Excel serial time number to HH:mm format\r\nexport function excelSerialToTime(serial: any): string {\r\n    if (typeof serial === 'string') {\r\n        // If it's already a time string, just ensure format\r\n        const parts = serial.split(':');\r\n        if (parts.length >= 2) {\r\n            return `${parts[0].padStart(2, '0')}:${parts[1].padStart(2, '0')}`;\r\n        }\r\n        return '';\r\n    }\r\n    if (typeof serial !== 'number' || serial < 0 || serial > 1) {\r\n        // It might be a Date object from cellDates:true\r\n        if (serial instanceof Date) {\r\n            // Use local time (getHours/getMinutes) for Vietnam timezone GMT+7\r\n            const hours = serial.getHours();\r\n            const minutes = serial.getMinutes();\r\n            return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;\r\n        }\r\n        return ''; // Invalid time serial\r\n    }\r\n    const totalSeconds = Math.round(serial * 86400);\r\n    const hours = Math.floor(totalSeconds / 3600);\r\n    const minutes = Math.floor((totalSeconds % 3600) / 60);\r\n    return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;\r\n}\r\n\r\n\r\nexport function recalculateSummary(\r\n    row: AnyAttendanceDataRow, \r\n    year: number, \r\n    month: number, \r\n    settings: EmployeeSettings\r\n): Pick<AttendanceDataRow, 'workDays' | 'leaveDays' | 'absentDays' | 'lateArrivals' | 'earlyDepartures' | 'otHours' | 'otHoursWeekday' | 'otHoursWeekend' | 'otHoursHoliday'> {\r\n    let totalWorkMinutes = 0; // Tổng phút làm việc trong giờ hành chính (8:30-18:00)\r\n    let leaveDays = 0;\r\n    let absentDays = 0;\r\n    let lateArrivals = 0;\r\n    let earlyDepartures = 0;\r\n    \r\n    // OT theo loại ngày\r\n    let otMinutesWeekday = 0;  // Làm thêm ngày thường (sau 18h)\r\n    let otMinutesWeekend = 0;  // Làm thêm cuối tuần\r\n    let otMinutesHoliday = 0;  // Làm thêm ngày lễ\r\n    \r\n    const daysInMonth = new Date(year, month, 0).getDate();\r\n    \r\n    // Tính số giờ làm việc tiêu chuẩn 1 ngày (trừ nghỉ trưa)\r\n    // VD: 8:30-18:00 = 9.5h, trừ nghỉ trưa 1.5h = 8h\r\n    const workStartParts = settings.workStartTime.split(':').map(Number);\r\n    const workEndParts = settings.workEndTime.split(':').map(Number);\r\n    const workStartMinutes = workStartParts[0] * 60 + workStartParts[1];\r\n    const workEndMinutes = workEndParts[0] * 60 + workEndParts[1];\r\n    const standardDayMinutes = workEndMinutes - workStartMinutes - settings.lunchBreakDuration;\r\n    \r\n    // Lấy giờ nghỉ trưa từ settings (nếu có), fallback về hardcode\r\n    const lunchStartParts = (settings.lunchBreakStart || '12:00').split(':').map(Number);\r\n    const lunchEndParts = (settings.lunchBreakEnd || '13:30').split(':').map(Number);\r\n    const lunchStartMinutes = lunchStartParts[0] * 60 + lunchStartParts[1];\r\n    const lunchEndMinutes = lunchEndParts[0] * 60 + lunchEndParts[1];\r\n\r\n    for (let d = 1; d <= daysInMonth; d++) {\r\n        const record = row[`day_${d}`] as DailyRecord;\r\n        const workDate = new Date(year, month - 1, d);\r\n        const dayOfWeek = getDayOfWeek(workDate);\r\n        const isWorkingDay = dayOfWeek !== null && settings.workingDays.includes(dayOfWeek);\r\n        const isWeekend = dayOfWeek === 0 || dayOfWeek === 6; // CN = 0, T7 = 6\r\n        const isHoliday = record?.status === 'holiday';\r\n\r\n        if (record) {\r\n            // Xử lý cho ngày làm việc (thứ 2-6)\r\n            if (isWorkingDay) {\r\n                // Tính giờ làm việc thực tế từ checkIn/checkOut\r\n                if (record.checkIn && record.checkOut) {\r\n                    const workDateStr = toISODate(workDate);\r\n                    const checkInTime = new Date(`${workDateStr}T${record.checkIn}`);\r\n                    const checkOutTime = new Date(`${workDateStr}T${record.checkOut}`);\r\n                    \r\n                    if (isValidDate(checkInTime) && isValidDate(checkOutTime) && isDateAfter(checkOutTime, checkInTime)) {\r\n                        const checkInMins = checkInTime.getHours() * 60 + checkInTime.getMinutes();\r\n                        const checkOutMins = checkOutTime.getHours() * 60 + checkOutTime.getMinutes();\r\n                        \r\n                        // ===== TÍNH GIỜ CÔNG (trong giờ hành chính 8:30-18:00) =====\r\n                        // Giờ vào tính công = max(checkIn, workStart)\r\n                        const effectiveStartMins = Math.max(checkInMins, workStartMinutes);\r\n                        // Giờ ra tính công = min(checkOut, workEnd)\r\n                        const effectiveEndMins = Math.min(checkOutMins, workEndMinutes);\r\n                        \r\n                        let workedMinutes = effectiveEndMins - effectiveStartMins;\r\n                        \r\n                        // Trừ nghỉ trưa nếu làm qua giờ nghỉ trưa\r\n                        if (effectiveStartMins < lunchStartMinutes && effectiveEndMins > lunchEndMinutes) {\r\n                            workedMinutes -= settings.lunchBreakDuration;\r\n                        } else if (effectiveStartMins < lunchEndMinutes && effectiveEndMins > lunchStartMinutes) {\r\n                            // Nếu chỉ chạm 1 phần giờ nghỉ trưa\r\n                            const overlapStart = Math.max(effectiveStartMins, lunchStartMinutes);\r\n                            const overlapEnd = Math.min(effectiveEndMins, lunchEndMinutes);\r\n                            workedMinutes -= Math.max(0, overlapEnd - overlapStart);\r\n                        }\r\n                        \r\n                        totalWorkMinutes += Math.max(0, workedMinutes);\r\n                        \r\n                        // ===== TÍNH GIỜ LÀM THÊM (sau giờ tan làm 18:00) =====\r\n                        if (checkOutMins > workEndMinutes) {\r\n                            const otMinutes = checkOutMins - workEndMinutes;\r\n                            if (isHoliday) {\r\n                                otMinutesHoliday += otMinutes;\r\n                            } else {\r\n                                otMinutesWeekday += otMinutes;\r\n                            }\r\n                        }\r\n                        \r\n                        // Early departure calculation - ra trước giờ tan làm\r\n                        if (checkOutMins < workEndMinutes) {\r\n                            earlyDepartures++;\r\n                        }\r\n                    }\r\n                }\r\n                \r\n                // Đếm ngày nghỉ phép\r\n                if (record.status === 'leave') {\r\n                    leaveDays += 1;\r\n                }\r\n\r\n                // Late arrival calculation\r\n                if (record.checkIn) {\r\n                    const workDateStr = toISODate(workDate);\r\n                    const checkInTime = new Date(`${workDateStr}T${record.checkIn}`);\r\n                    const workStartTime = new Date(`${workDateStr}T${settings.workStartTime}`);\r\n                    const allowedLateTime = new Date(workStartTime.getTime() + settings.allowedLateMinutes * 60000);\r\n\r\n                    if (isDateAfter(checkInTime, allowedLateTime)) {\r\n                        lateArrivals++;\r\n                    }\r\n                }\r\n            }\r\n            \r\n            // ===== XỬ LÝ LÀM THÊM CUỐI TUẦN / NGÀY LỄ =====\r\n            // Nếu là cuối tuần hoặc ngày lễ mà có checkIn/checkOut → tính toàn bộ là OT\r\n            if ((isWeekend || isHoliday) && record.checkIn && record.checkOut) {\r\n                const workDateStr = toISODate(workDate);\r\n                const checkInTime = new Date(`${workDateStr}T${record.checkIn}`);\r\n                const checkOutTime = new Date(`${workDateStr}T${record.checkOut}`);\r\n                \r\n                if (isValidDate(checkInTime) && isValidDate(checkOutTime) && isDateAfter(checkOutTime, checkInTime)) {\r\n                    let otMinutes = (checkOutTime.getTime() - checkInTime.getTime()) / 60000;\r\n                    \r\n                    // Trừ nghỉ trưa nếu làm qua trưa\r\n                    const checkInMins = checkInTime.getHours() * 60 + checkInTime.getMinutes();\r\n                    const checkOutMins = checkOutTime.getHours() * 60 + checkOutTime.getMinutes();\r\n                    if (checkInMins < lunchStartMinutes && checkOutMins > lunchEndMinutes) {\r\n                        otMinutes -= settings.lunchBreakDuration;\r\n                    }\r\n                    \r\n                    if (isHoliday) {\r\n                        otMinutesHoliday += Math.max(0, otMinutes);\r\n                    } else {\r\n                        otMinutesWeekend += Math.max(0, otMinutes);\r\n                    }\r\n                }\r\n            }\r\n            \r\n            // OT từ cột overtimeCheckIn/overtimeCheckOut riêng (nếu có)\r\n            if (record.overtimeCheckIn && record.overtimeCheckOut) {\r\n                const workDateStr = toISODate(workDate);\r\n                const otStartDate = new Date(`${workDateStr}T${record.overtimeCheckIn}`);\r\n                const otEndDate = new Date(`${workDateStr}T${record.overtimeCheckOut}`);\r\n                if (isValidDate(otStartDate) && isValidDate(otEndDate) && isDateAfter(otEndDate, otStartDate)) {\r\n                    const diffInMinutes = (otEndDate.getTime() - otStartDate.getTime()) / 60000;\r\n                    if (isHoliday) {\r\n                        otMinutesHoliday += diffInMinutes;\r\n                    } else if (isWeekend) {\r\n                        otMinutesWeekend += diffInMinutes;\r\n                    } else {\r\n                        otMinutesWeekday += diffInMinutes;\r\n                    }\r\n                }\r\n            }\r\n        }\r\n    }\r\n    \r\n    // Tính số công = Tổng giờ làm / Giờ tiêu chuẩn 1 ngày (tối đa = số ngày làm việc trong tháng)\r\n    const workDays = standardDayMinutes > 0 \r\n        ? parseFloat((totalWorkMinutes / standardDayMinutes).toFixed(2))\r\n        : 0;\r\n    \r\n    // Tính ngày vắng = Tổng ngày làm việc trong tháng - ngày có công - ngày phép\r\n    const totalWorkingDaysInMonth = Array.from({ length: daysInMonth }, (_, i) => {\r\n        const d = new Date(year, month - 1, i + 1);\r\n        const dow = getDayOfWeek(d);\r\n        return dow !== null && settings.workingDays.includes(dow) ? 1 : 0;\r\n    }).reduce((a, b) => a + b, 0);\r\n    \r\n    absentDays = Math.max(0, totalWorkingDaysInMonth - Math.ceil(workDays) - leaveDays);\r\n    \r\n    // Convert OT từ phút sang giờ\r\n    const otHoursWeekday = parseFloat((otMinutesWeekday / 60).toFixed(2));\r\n    const otHoursWeekend = parseFloat((otMinutesWeekend / 60).toFixed(2));\r\n    const otHoursHoliday = parseFloat((otMinutesHoliday / 60).toFixed(2));\r\n    const otHours = parseFloat((otHoursWeekday + otHoursWeekend + otHoursHoliday).toFixed(2));\r\n    \r\n    return {\r\n        workDays,\r\n        leaveDays,\r\n        absentDays,\r\n        lateArrivals,\r\n        earlyDepartures,\r\n        otHours,\r\n        otHoursWeekday,\r\n        otHoursWeekend,\r\n        otHoursHoliday,\r\n    };\r\n}\r\n\r\n/**\r\n * Tính tiền làm thêm (OT) dựa trên số giờ và cài đặt\r\n * \r\n * Công thức:\r\n * - Ngày thường: otHoursWeekday * otHourlyRate (VNĐ/giờ)\r\n * - Cuối tuần: otHoursWeekend * otHourlyRate * otRateWeekend (hệ số 1.5)\r\n * - Ngày lễ: otHoursHoliday * otHourlyRate * otRateHoliday (hệ số 3)\r\n * \r\n * VD: settings.otHourlyRate = 25000, otRateWeekend = 1.5, otRateHoliday = 3\r\n * - 2 giờ OT ngày thường = 2 * 25000 = 50,000 VNĐ\r\n * - 2 giờ OT cuối tuần = 2 * 25000 * 1.5 = 75,000 VNĐ\r\n * - 2 giờ OT ngày lễ = 2 * 25000 * 3 = 150,000 VNĐ\r\n */\r\nexport function calculateOvertimePay(\r\n    otHoursWeekday: number,\r\n    otHoursWeekend: number,\r\n    otHoursHoliday: number,\r\n    settings: EmployeeSettings\r\n): {\r\n    weekdayPay: number;\r\n    weekendPay: number;\r\n    holidayPay: number;\r\n    totalOtPay: number;\r\n} {\r\n    const hourlyRate = settings.otHourlyRate || 0;\r\n    \r\n    // Ngày thường: tiền/giờ * số giờ\r\n    const weekdayPay = otHoursWeekday * hourlyRate;\r\n    \r\n    // Cuối tuần: tiền/giờ * hệ số cuối tuần * số giờ\r\n    const weekendPay = otHoursWeekend * hourlyRate * (settings.otRateWeekend || 1.5);\r\n    \r\n    // Ngày lễ: tiền/giờ * hệ số ngày lễ * số giờ  \r\n    const holidayPay = otHoursHoliday * hourlyRate * (settings.otRateHoliday || 3);\r\n    \r\n    const totalOtPay = weekdayPay + weekendPay + holidayPay;\r\n    \r\n    return {\r\n        weekdayPay: Math.round(weekdayPay),\r\n        weekendPay: Math.round(weekendPay),\r\n        holidayPay: Math.round(holidayPay),\r\n        totalOtPay: Math.round(totalOtPay),\r\n    };\r\n}\r\n\r\n/**\r\n * Tính tiền OT từ AttendanceDataRow\r\n */\r\nexport function calculateOvertimePayFromRow(\r\n    row: AttendanceDataRow,\r\n    settings: EmployeeSettings\r\n): ReturnType<typeof calculateOvertimePay> {\r\n    return calculateOvertimePay(\r\n        row.otHoursWeekday || 0,\r\n        row.otHoursWeekend || 0,\r\n        row.otHoursHoliday || 0,\r\n        settings\r\n    );\r\n}"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1668, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/leaves/leave-sync-service.ts"],"sourcesContent":["import type { LeaveRequest } from './types';\r\nimport type { AttendanceDayKey, AttendanceDataRow, AnyAttendanceDataRow, DailyRecord } from '../attendance/types';\r\nimport { useAttendanceStore } from '../attendance/store';\r\nimport { useEmployeeSettingsStore } from '../settings/employees/employee-settings-store';\r\nimport { recalculateSummary } from '../attendance/utils';\r\nimport { getCurrentDate } from '../../lib/date-utils';\r\n\r\nconst LEAVE_NOTE_PREFIX = '[LEAVE:';\r\n\r\ntype DayContext = {\r\n  date: Date;\r\n  dayOfMonth: number;\r\n};\r\n\r\ntype MonthDayMap = Map<string, DayContext[]>;\r\n\r\nconst buildMonthKey = (date: Date) => `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;\r\n\r\nconst buildLeaveNote = (leave: LeaveRequest) => {\r\n  const description = `${LEAVE_NOTE_PREFIX}${leave.systemId}] ${leave.leaveTypeName}`;\r\n  return leave.reason ? `${description} - ${leave.reason}` : description;\r\n};\r\n\r\nconst isSameLeaveNote = (record: DailyRecord | undefined, leave: LeaveRequest) => {\r\n  if (!record?.notes) return false;\r\n  return record.notes.includes(`${LEAVE_NOTE_PREFIX}${leave.systemId}]`);\r\n};\r\n\r\nconst cloneDate = (input: Date) => new Date(input.getFullYear(), input.getMonth(), input.getDate());\r\n\r\nconst parseLeaveBoundary = (value: string): Date => {\r\n  const parsed = new Date(`${value}T00:00:00`);\r\n  return Number.isNaN(parsed.getTime()) ? new Date() : parsed;\r\n};\r\n\r\nconst collectWorkingDays = (leave: LeaveRequest): MonthDayMap => {\r\n  const workingDays = new Set(useEmployeeSettingsStore.getState().settings.workingDays);\r\n  if (!leave.startDate || !leave.endDate) return new Map();\r\n\r\n  let start = parseLeaveBoundary(leave.startDate);\r\n  let end = parseLeaveBoundary(leave.endDate);\r\n  if (start > end) {\r\n    const temp = start;\r\n    start = end;\r\n    end = temp;\r\n  }\r\n\r\n  const monthMap: MonthDayMap = new Map();\r\n  for (let cursor = cloneDate(start); cursor <= end; cursor.setDate(cursor.getDate() + 1)) {\r\n    const dayOfWeek = cursor.getDay();\r\n    if (!workingDays.has(dayOfWeek)) {\r\n      continue;\r\n    }\r\n\r\n    const monthKey = buildMonthKey(cursor);\r\n    const entry: DayContext = { date: cloneDate(cursor), dayOfMonth: cursor.getDate() };\r\n    const existing = monthMap.get(monthKey);\r\n    if (existing) {\r\n      existing.push(entry);\r\n    } else {\r\n      monthMap.set(monthKey, [entry]);\r\n    }\r\n  }\r\n\r\n  return monthMap;\r\n};\r\n\r\nconst buildLeaveRecord = (leave: LeaveRequest): DailyRecord => ({\r\n  status: 'leave',\r\n  notes: buildLeaveNote(leave),\r\n});\r\n\r\nconst buildRevertedRecord = (context: DayContext): DailyRecord => {\r\n  const today = getCurrentDate();\r\n  if (context.date > today) {\r\n    return { status: 'future' };\r\n  }\r\n  return { status: 'absent' };\r\n};\r\n\r\nconst applyUpdatesForMonth = (monthKey: string, days: DayContext[], leave: LeaveRequest, mode: 'apply' | 'clear') => {\r\n  if (days.length === 0) return;\r\n\r\n  const attendanceStore = useAttendanceStore.getState();\r\n  const monthData = attendanceStore.getAttendanceData(monthKey);\r\n  if (!monthData?.length) return;\r\n\r\n  const [yearStr, monthStr] = monthKey.split('-');\r\n  const year = Number(yearStr) || new Date().getFullYear();\r\n  const month = Number(monthStr) || new Date().getMonth() + 1;\r\n  const settings = useEmployeeSettingsStore.getState().settings;\r\n\r\n  let didChange = false;\r\n  const updatedRows: AttendanceDataRow[] = monthData.map((row) => {\r\n    if (row.employeeSystemId !== leave.employeeSystemId) {\r\n      return row;\r\n    }\r\n\r\n    let rowChanged = false;\r\n    const mutableRow: AnyAttendanceDataRow = { ...row };\r\n\r\n    days.forEach((ctx) => {\r\n      const dayKey = `day_${ctx.dayOfMonth}` as AttendanceDayKey;\r\n      const currentRecord = mutableRow[dayKey] as DailyRecord | undefined;\r\n\r\n      if (mode === 'apply') {\r\n        mutableRow[dayKey] = buildLeaveRecord(leave);\r\n        rowChanged = true;\r\n        return;\r\n      }\r\n\r\n      if (mode === 'clear' && currentRecord && isSameLeaveNote(currentRecord, leave)) {\r\n        mutableRow[dayKey] = buildRevertedRecord(ctx);\r\n        rowChanged = true;\r\n      }\r\n    });\r\n\r\n    if (!rowChanged) {\r\n      return row;\r\n    }\r\n\r\n    didChange = true;\r\n    const summary = recalculateSummary(mutableRow, year, month, settings);\r\n    return { ...mutableRow, ...summary } as AttendanceDataRow;\r\n  });\r\n\r\n  if (didChange) {\r\n    attendanceStore.saveAttendanceData(monthKey, updatedRows);\r\n  }\r\n};\r\n\r\nexport const leaveAttendanceSync = {\r\n  apply(leave: LeaveRequest) {\r\n    const monthMap = collectWorkingDays(leave);\r\n    monthMap.forEach((days, monthKey) => applyUpdatesForMonth(monthKey, days, leave, 'apply'));\r\n  },\r\n  clear(leave: LeaveRequest) {\r\n    const monthMap = collectWorkingDays(leave);\r\n    monthMap.forEach((days, monthKey) => applyUpdatesForMonth(monthKey, days, leave, 'clear'));\r\n  },\r\n};\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1804, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/repositories/in-memory-repository.ts"],"sourcesContent":["import type { SystemId } from '../lib/id-types';\r\nimport type { CrudState, ItemWithSystemId } from '../lib/store-factory';\r\nimport type { CrudRepository } from './types';\r\n\r\n/**\r\n * Adapter mặc định dùng trực tiếp Zustand store để giả lập tầng persistence.\r\n * Giữ cùng signature với repository interface để sau này thay bằng API/DB dễ dàng.\r\n */\r\nexport const createInMemoryRepository = <TEntity extends ItemWithSystemId>(\r\n  stateGetter: () => CrudState<TEntity>\r\n): CrudRepository<TEntity, Omit<TEntity, 'systemId'>, Partial<TEntity>> => {\r\n  const getStore = () => stateGetter();\r\n\r\n  const ensureEntity = (systemId: SystemId): TEntity => {\r\n    const entity = getStore().findById(systemId);\r\n    if (!entity) {\r\n      throw new Error(`Không tìm thấy entity với systemId=${systemId}`);\r\n    }\r\n    return entity;\r\n  };\r\n\r\n  return {\r\n    async list() {\r\n      return [...getStore().data];\r\n    },\r\n    async getById(systemId) {\r\n      return getStore().findById(systemId);\r\n    },\r\n    async create(payload) {\r\n      return getStore().add(payload as Omit<TEntity, 'systemId'>);\r\n    },\r\n    async update(systemId, payload) {\r\n      ensureEntity(systemId);\r\n      getStore().update(systemId, payload);\r\n      return ensureEntity(systemId);\r\n    },\r\n    async softDelete(systemId) {\r\n      ensureEntity(systemId);\r\n      getStore().remove(systemId);\r\n    },\r\n    async restore(systemId) {\r\n      ensureEntity(systemId);\r\n      getStore().restore(systemId);\r\n      return getStore().findById(systemId);\r\n    },\r\n    async hardDelete(systemId) {\r\n      ensureEntity(systemId);\r\n      getStore().hardDelete(systemId);\r\n    },\r\n  };\r\n};\r\n"],"names":[],"mappings":";;;;AAQO,MAAM,2BAA2B,CACtC;IAEA,MAAM,WAAW,IAAM;IAEvB,MAAM,eAAe,CAAC;QACpB,MAAM,SAAS,WAAW,QAAQ,CAAC;QACnC,IAAI,CAAC,QAAQ;YACX,MAAM,IAAI,MAAM,CAAC,mCAAmC,EAAE,UAAU;QAClE;QACA,OAAO;IACT;IAEA,OAAO;QACL,MAAM;YACJ,OAAO;mBAAI,WAAW,IAAI;aAAC;QAC7B;QACA,MAAM,SAAQ,QAAQ;YACpB,OAAO,WAAW,QAAQ,CAAC;QAC7B;QACA,MAAM,QAAO,OAAO;YAClB,OAAO,WAAW,GAAG,CAAC;QACxB;QACA,MAAM,QAAO,QAAQ,EAAE,OAAO;YAC5B,aAAa;YACb,WAAW,MAAM,CAAC,UAAU;YAC5B,OAAO,aAAa;QACtB;QACA,MAAM,YAAW,QAAQ;YACvB,aAAa;YACb,WAAW,MAAM,CAAC;QACpB;QACA,MAAM,SAAQ,QAAQ;YACpB,aAAa;YACb,WAAW,OAAO,CAAC;YACnB,OAAO,WAAW,QAAQ,CAAC;QAC7B;QACA,MAAM,YAAW,QAAQ;YACvB,aAAa;YACb,WAAW,UAAU,CAAC;QACxB;IACF;AACF"}},
    {"offset": {"line": 1856, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/lib/activity-history-helper.ts"],"sourcesContent":["/**\r\n * Activity History Helper\r\n * \r\n * Helper để tạo các entry lịch sử hoạt động một cách nhất quán\r\n * Dùng chung cho tất cả các modules trong hệ thống\r\n * \r\n * NOTE: Đã remove import useEmployeeStore để tránh circular dependency\r\n * và cải thiện compile time\r\n */\r\n\r\nimport type { HistoryEntry } from '../components/ActivityHistory';\r\nimport { getCurrentUserInfo as getAuthUserInfo } from '../contexts/auth-context';\r\nimport type { SystemId } from './id-types';\r\n\r\n// Re-export HistoryEntry type for convenience\r\nexport type { HistoryEntry } from '../components/ActivityHistory';\r\n\r\n/**\r\n * Lấy thông tin người dùng hiện tại từ auth context\r\n * NOTE: Avatar lookup từ employee store đã bị remove để tránh circular dependency\r\n */\r\nexport function getCurrentUserInfo(): { systemId: string; name: string; avatar?: string } {\r\n  const authInfo = getAuthUserInfo();\r\n  \r\n  return {\r\n    systemId: authInfo.systemId || 'SYSTEM',\r\n    name: authInfo.name || 'Hệ thống',\r\n    avatar: undefined, // Avatar will be fetched by component if needed\r\n  };\r\n}\r\n\r\n/**\r\n * Lấy thông tin nhân viên từ systemId\r\n * NOTE: This function now requires employee data to be passed in\r\n * to avoid circular dependency with employee store\r\n */\r\nexport function getEmployeeInfoFromData(\r\n  employeeSystemId: SystemId | string,\r\n  employees: Array<{ systemId: string; fullName: string; avatarUrl?: string }>\r\n): { systemId: string; name: string; avatar?: string } {\r\n  const employee = employees.find(e => e.systemId === employeeSystemId);\r\n  \r\n  if (employee) {\r\n    return {\r\n      systemId: employee.systemId,\r\n      name: employee.fullName,\r\n      avatar: employee.avatarUrl,\r\n    };\r\n  }\r\n  \r\n  // Fallback to system\r\n  return {\r\n    systemId: String(employeeSystemId) || 'SYSTEM',\r\n    name: 'Hệ thống',\r\n  };\r\n}\r\n\r\n/**\r\n * @deprecated Use getEmployeeInfoFromData instead\r\n */\r\nexport function getEmployeeInfo(employeeSystemId: SystemId | string): { systemId: string; name: string; avatar?: string } {\r\n  // Return minimal info without employee store lookup\r\n  return {\r\n    systemId: String(employeeSystemId) || 'SYSTEM',\r\n    name: 'Hệ thống',\r\n  };\r\n}\r\n\r\n/**\r\n * Tạo một history entry mới\r\n */\r\nexport function createHistoryEntry(\r\n  action: HistoryEntry['action'],\r\n  userOrDescription: { systemId: string; name: string; avatar?: string } | string,\r\n  descriptionOrMetadata?: string | HistoryEntry['metadata'],\r\n  metadata?: HistoryEntry['metadata']\r\n): HistoryEntry {\r\n  const hasUserObject = typeof userOrDescription === 'object' && userOrDescription !== null;\r\n  const user = hasUserObject ? userOrDescription : getCurrentUserInfo();\r\n  const description = (hasUserObject ? descriptionOrMetadata : userOrDescription) as string | undefined;\r\n  const meta = (hasUserObject ? metadata : descriptionOrMetadata) as HistoryEntry['metadata'] | undefined;\r\n\r\n  return {\r\n    id: `history-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,\r\n    action,\r\n    timestamp: new Date(),\r\n    user: {\r\n      systemId: user.systemId,\r\n      name: user.name,\r\n      avatar: user.avatar,\r\n    },\r\n    description: description ?? '',\r\n    metadata: meta,\r\n  };\r\n}\r\n\r\n/**\r\n * Tạo history entry cho action \"created\"\r\n */\r\nexport function createCreatedEntry(\r\n  user: { systemId: string; name: string; avatar?: string },\r\n  description: string\r\n): HistoryEntry {\r\n  return createHistoryEntry('created', user, description);\r\n}\r\n\r\n/**\r\n * Tạo history entry cho action \"updated\"\r\n */\r\nexport function createUpdatedEntry(\r\n  user: { systemId: string; name: string; avatar?: string },\r\n  description: string\r\n): HistoryEntry {\r\n  return createHistoryEntry('updated', user, description);\r\n}\r\n\r\n/**\r\n * Tạo history entry cho action \"status_changed\"\r\n */\r\nexport function createStatusChangedEntry(\r\n  user: { systemId: string; name: string; avatar?: string },\r\n  oldStatus: string,\r\n  newStatus: string,\r\n  description: string\r\n): HistoryEntry {\r\n  return createHistoryEntry(\r\n    'status_changed',\r\n    user,\r\n    description,\r\n    { field: 'status', oldValue: oldStatus, newValue: newStatus }\r\n  );\r\n}\r\n\r\n/**\r\n * Tạo history entry cho action \"deleted\"\r\n */\r\nexport function createDeletedEntry(\r\n  user: { systemId: string; name: string; avatar?: string },\r\n  description: string\r\n): HistoryEntry {\r\n  return createHistoryEntry('deleted', user, description);\r\n}\r\n\r\n/**\r\n * Tạo history entry cho action \"assigned\"\r\n */\r\nexport function createAssignedEntry(\r\n  user: { systemId: string; name: string; avatar?: string },\r\n  description: string\r\n): HistoryEntry {\r\n  return createHistoryEntry('assigned', user, description);\r\n}\r\n\r\n/**\r\n * Tạo history entry cho action \"payment_made\"\r\n */\r\nexport function createPaymentEntry(\r\n  user: { systemId: string; name: string; avatar?: string },\r\n  description: string\r\n): HistoryEntry {\r\n  return createHistoryEntry('payment_made', user, description);\r\n}\r\n\r\n/**\r\n * Tạo history entry cho action \"comment_added\"\r\n */\r\nexport function createCommentEntry(\r\n  user: { systemId: string; name: string; avatar?: string },\r\n  description: string\r\n): HistoryEntry {\r\n  return createHistoryEntry('comment_added', user, description);\r\n}\r\n\r\n/**\r\n * Tạo history entry cho action \"cancelled\"\r\n */\r\nexport function createCancelledEntry(\r\n  user: { systemId: string; name: string; avatar?: string },\r\n  description: string\r\n): HistoryEntry {\r\n  return createHistoryEntry('cancelled', user, description);\r\n}\r\n\r\n/**\r\n * Tạo history entry cho action \"verified\"\r\n */\r\nexport function createVerifiedEntry(\r\n  user: { systemId: string; name: string; avatar?: string },\r\n  description: string\r\n): HistoryEntry {\r\n  return createHistoryEntry('verified', user, description);\r\n}\r\n\r\n/**\r\n * Tạo history entry cho action \"ended\"\r\n */\r\nexport function createEndedEntry(\r\n  user: { systemId: string; name: string; avatar?: string },\r\n  description: string\r\n): HistoryEntry {\r\n  return createHistoryEntry('ended', user, description);\r\n}\r\n\r\n/**\r\n * Tạo history entry cho action \"reopened\"\r\n */\r\nexport function createReopenedEntry(\r\n  user: { systemId: string; name: string; avatar?: string },\r\n  description: string\r\n): HistoryEntry {\r\n  return createHistoryEntry('reopened', user, description);\r\n}\r\n\r\n/**\r\n * Tạo history entry cho product actions\r\n */\r\nexport function createProductEntry(\r\n  user: { systemId: string; name: string; avatar?: string },\r\n  action: 'product_added' | 'product_updated' | 'product_removed',\r\n  description: string\r\n): HistoryEntry {\r\n  return createHistoryEntry(action, user, description);\r\n}\r\n\r\n/**\r\n * Helper để append history entry vào existing array\r\n */\r\nexport function appendHistoryEntry(\r\n  existingHistory: HistoryEntry[] | undefined,\r\n  ...newEntries: HistoryEntry[]\r\n): HistoryEntry[] {\r\n  return [...(existingHistory || []), ...newEntries];\r\n}\r\n\r\n/**\r\n * Helper để tạo nhiều history entries cùng lúc\r\n */\r\nexport function createBulkUpdateEntries(\r\n  user: { systemId: string; name: string; avatar?: string },\r\n  changes: Array<{ field: string; description: string }>\r\n): HistoryEntry[] {\r\n  return changes.map(change => createHistoryEntry('updated', user, change.description));\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 2008, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/employees/store.ts"],"sourcesContent":["import { createCrudStore, CrudState } from '../../lib/store-factory';\r\n// REMOVED: import { data as initialData } from './data'; // Mock data no longer used - database is source of truth\r\nimport type { Employee } from './types';\r\nimport type { HistoryEntry } from '../../components/ActivityHistory';\r\nimport Fuse from 'fuse.js';\r\nimport { getCurrentUserSystemId } from '../../contexts/auth-context';\r\nimport { registerBreadcrumbStore } from '../../lib/breadcrumb-generator'; // ✅ NEW\r\nimport { type SystemId } from '../../lib/id-types';\r\nimport { createInMemoryRepository } from '../../repositories/in-memory-repository';\r\nimport { \r\n  createHistoryEntry, \r\n  getCurrentUserInfo,\r\n  appendHistoryEntry \r\n} from '../../lib/activity-history-helper';\r\n\r\ntype EmployeePersistenceAdapter = {\r\n  create: (payload: Omit<Employee, 'systemId'>) => Promise<Employee>;\r\n  update: (systemId: SystemId, payload: Partial<Employee>) => Promise<Employee>;\r\n  softDelete: (systemId: SystemId) => Promise<void>;\r\n  restore: (systemId: SystemId) => Promise<Employee | undefined>;\r\n  hardDelete: (systemId: SystemId) => Promise<void>;\r\n};\r\n\r\nconst baseStore = createCrudStore<Employee>([], 'employees', {\r\n  businessIdField: 'id',\r\n  getCurrentUser: getCurrentUserSystemId, // ✅ Track who creates/updates\r\n  apiEndpoint: '/api/employees',\r\n});\r\n\r\n// ✅ Wrap add method to include activity history\r\nconst originalAdd = baseStore.getState().add;\r\nconst wrappedAdd = (item: Omit<Employee, 'systemId'>): Employee => {\r\n  const userInfo = getCurrentUserInfo();\r\n  const historyEntry = createHistoryEntry(\r\n    'created',\r\n    `${userInfo.name} đã tạo hồ sơ nhân viên ${item.fullName} (${item.id})`,\r\n    userInfo\r\n  );\r\n  \r\n  const newEmployee = originalAdd({\r\n    ...item,\r\n    activityHistory: [historyEntry],\r\n  });\r\n  \r\n  return newEmployee;\r\n};\r\n\r\n// ✅ Wrap update method to include activity history\r\nconst originalUpdate = baseStore.getState().update;\r\nconst wrappedUpdate = (systemId: SystemId, updates: Partial<Employee>): void => {\r\n  const currentEmployee = baseStore.getState().data.find(e => e.systemId === systemId);\r\n  if (!currentEmployee) return;\r\n  \r\n  const userInfo = getCurrentUserInfo();\r\n  const historyEntries: HistoryEntry[] = [];\r\n  \r\n  // Track important field changes\r\n  const trackedFields: { key: keyof Employee; label: string }[] = [\r\n    { key: 'fullName', label: 'họ tên' },\r\n    { key: 'jobTitle', label: 'chức danh' },\r\n    { key: 'department', label: 'phòng ban' },\r\n    { key: 'employmentStatus', label: 'trạng thái làm việc' },\r\n    { key: 'employeeType', label: 'loại nhân viên' },\r\n    { key: 'baseSalary', label: 'lương cơ bản' },\r\n    { key: 'phone', label: 'số điện thoại' },\r\n    { key: 'workEmail', label: 'email công việc' },\r\n    { key: 'role', label: 'vai trò' },\r\n  ];\r\n  \r\n  trackedFields.forEach(({ key, label }) => {\r\n    if (updates[key] !== undefined && updates[key] !== currentEmployee[key]) {\r\n      const oldValue = currentEmployee[key];\r\n      const newValue = updates[key];\r\n      \r\n      // Format values for display\r\n      let oldDisplay = oldValue;\r\n      let newDisplay = newValue;\r\n      \r\n      if (key === 'baseSalary') {\r\n        oldDisplay = new Intl.NumberFormat('vi-VN').format(oldValue as number) + 'đ';\r\n        newDisplay = new Intl.NumberFormat('vi-VN').format(newValue as number) + 'đ';\r\n      }\r\n      \r\n      historyEntries.push(createHistoryEntry(\r\n        'updated',\r\n        `${userInfo.name} đã cập nhật ${label}: \"${oldDisplay || '(trống)'}\" → \"${newDisplay}\"`,\r\n        userInfo,\r\n        { field: key, oldValue, newValue }\r\n      ));\r\n    }\r\n  });\r\n  \r\n  // If status changed specifically\r\n  if (updates.employmentStatus && updates.employmentStatus !== currentEmployee.employmentStatus) {\r\n    historyEntries.push(createHistoryEntry(\r\n      'status_changed',\r\n      `${userInfo.name} đã thay đổi trạng thái làm việc từ \"${currentEmployee.employmentStatus}\" thành \"${updates.employmentStatus}\"`,\r\n      userInfo,\r\n      { field: 'employmentStatus', oldValue: currentEmployee.employmentStatus, newValue: updates.employmentStatus }\r\n    ));\r\n  }\r\n  \r\n  // If no specific changes tracked, add generic update entry\r\n  if (historyEntries.length === 0) {\r\n    historyEntries.push(createHistoryEntry(\r\n      'updated',\r\n      `${userInfo.name} đã cập nhật thông tin nhân viên`,\r\n      userInfo\r\n    ));\r\n  }\r\n  \r\n  const updatedHistory = appendHistoryEntry(currentEmployee.activityHistory, ...historyEntries);\r\n  \r\n  originalUpdate(systemId, {\r\n    ...updates,\r\n    activityHistory: updatedHistory,\r\n  });\r\n};\r\n\r\n// ✅ Override base store methods\r\nbaseStore.setState({\r\n  add: wrappedAdd,\r\n  update: wrappedUpdate,\r\n});\r\n\r\nexport const employeeRepository = createInMemoryRepository<Employee>(() => baseStore.getState());\r\n\r\n// ✅ API-backed persistence adapter - syncs to PostgreSQL\r\nconst API_ENDPOINT = '/api/employees';\r\n\r\nconst persistence: EmployeePersistenceAdapter = {\r\n  create: async (payload) => {\r\n    // First create locally for immediate UI update\r\n    const localResult = await employeeRepository.create(payload);\r\n    \r\n    // Then sync to API (background)\r\n    try {\r\n      const response = await fetch(API_ENDPOINT, {\r\n        method: 'POST',\r\n        credentials: 'include',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({ ...payload, systemId: localResult.systemId }),\r\n      });\r\n      if (!response.ok) {\r\n        console.warn('[Employee API] Create sync failed, data saved locally');\r\n      } else {\r\n        console.log('[Employee API] Created:', localResult.systemId);\r\n      }\r\n    } catch (e) {\r\n      console.warn('[Employee API] Create sync error:', e);\r\n    }\r\n    \r\n    return localResult;\r\n  },\r\n  update: async (systemId, payload) => {\r\n    // First update locally\r\n    const localResult = await employeeRepository.update(systemId, payload);\r\n    \r\n    // Then sync to API\r\n    try {\r\n      const response = await fetch(`${API_ENDPOINT}/${systemId}`, {\r\n        method: 'PATCH',\r\n        credentials: 'include',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify(payload),\r\n      });\r\n      if (!response.ok) {\r\n        console.warn('[Employee API] Update sync failed');\r\n      } else {\r\n        console.log('[Employee API] Updated:', systemId);\r\n      }\r\n    } catch (e) {\r\n      console.warn('[Employee API] Update sync error:', e);\r\n    }\r\n    \r\n    return localResult;\r\n  },\r\n  softDelete: async (systemId) => {\r\n    // First delete locally\r\n    await employeeRepository.softDelete(systemId);\r\n    \r\n    // Then sync to API\r\n    try {\r\n      const response = await fetch(`${API_ENDPOINT}/${systemId}`, {\r\n        method: 'DELETE',\r\n        credentials: 'include',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({ hard: false }),\r\n      });\r\n      if (!response.ok) {\r\n        console.warn('[Employee API] Soft delete sync failed');\r\n      } else {\r\n        console.log('[Employee API] Soft deleted:', systemId);\r\n      }\r\n    } catch (e) {\r\n      console.warn('[Employee API] Soft delete sync error:', e);\r\n    }\r\n  },\r\n  restore: async (systemId) => {\r\n    // First restore locally\r\n    const localResult = await employeeRepository.restore(systemId);\r\n    \r\n    // Then sync to API\r\n    try {\r\n      const response = await fetch(`${API_ENDPOINT}/${systemId}/restore`, {\r\n        method: 'POST',\r\n        credentials: 'include',\r\n        headers: { 'Content-Type': 'application/json' },\r\n      });\r\n      if (!response.ok) {\r\n        console.warn('[Employee API] Restore sync failed');\r\n      } else {\r\n        console.log('[Employee API] Restored:', systemId);\r\n      }\r\n    } catch (e) {\r\n      console.warn('[Employee API] Restore sync error:', e);\r\n    }\r\n    \r\n    return localResult;\r\n  },\r\n  hardDelete: async (systemId) => {\r\n    // First delete locally\r\n    await employeeRepository.hardDelete(systemId);\r\n    \r\n    // Then sync to API\r\n    try {\r\n      const response = await fetch(`${API_ENDPOINT}/${systemId}`, {\r\n        method: 'DELETE',\r\n        credentials: 'include',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({ hard: true }),\r\n      });\r\n      if (!response.ok) {\r\n        console.warn('[Employee API] Hard delete sync failed');\r\n      } else {\r\n        console.log('[Employee API] Hard deleted:', systemId);\r\n      }\r\n    } catch (e) {\r\n      console.warn('[Employee API] Hard delete sync error:', e);\r\n    }\r\n  },\r\n};\r\n\r\n// ✅ Register for breadcrumb auto-generation\r\nregisterBreadcrumbStore('employees', () => baseStore.getState());\r\n\r\n// Define enhanced interface\r\ninterface EmployeeStoreState extends CrudState<Employee> {\r\n  searchEmployees: (query: string, page: number, limit?: number) => Promise<{ items: { value: string; label: string }[], hasNextPage: boolean }>;\r\n  permanentDelete: (systemId: SystemId) => Promise<void>;\r\n  persistence: EmployeePersistenceAdapter;\r\n}\r\n\r\ntype EmployeeStoreHook = (() => EmployeeStoreState) & {\r\n  getState: () => EmployeeStoreState;\r\n  persistence: EmployeePersistenceAdapter;\r\n};\r\n\r\n// Augmented methods\r\nconst augmentedMethods = {\r\n    // FIX: Changed `page: number = 1` to `page: number` to make it a required parameter, matching Combobox prop type.\r\n    // ✅ CRITICAL FIX: Create fresh Fuse instance on each search to avoid stale data\r\n    searchEmployees: async (query: string, page: number, limit: number = 20) => {\r\n        return new Promise<{ items: { value: string; label: string }[], hasNextPage: boolean }>(resolve => {\r\n            setTimeout(() => {\r\n                const allEmployees = baseStore.getState().data;\r\n                \r\n                // ✅ Create fresh Fuse instance with current data\r\n                const fuse = new Fuse(allEmployees, {\r\n                    keys: ['fullName', 'id', 'phone', 'personalEmail', 'workEmail'],\r\n                    threshold: 0.3,\r\n                });\r\n                \r\n                const results = query ? fuse.search(query).map(r => r.item) : allEmployees;\r\n                \r\n                const start = (page - 1) * limit;\r\n                const end = start + limit;\r\n                const paginatedItems = results.slice(start, end);\r\n\r\n                resolve({\r\n                    items: paginatedItems.map(e => ({ value: e.systemId, label: e.fullName })),\r\n                    hasNextPage: end < results.length,\r\n                });\r\n            }, 300);\r\n        });\r\n    },\r\n    permanentDelete: async (systemId: SystemId) => {\r\n        await persistence.hardDelete(systemId);\r\n    }\r\n};\r\n\r\nconst useEmployeeStoreHook = (): EmployeeStoreState => {\r\n  const state = baseStore();\r\n  return {\r\n    ...state,\r\n    ...augmentedMethods, // This includes permanentDelete\r\n    persistence,\r\n  };\r\n};\r\n\r\nexport const useEmployeeStore = useEmployeeStoreHook as EmployeeStoreHook;\r\n\r\n// Export getState for non-hook usage\r\nuseEmployeeStore.getState = (): EmployeeStoreState => {\r\n  const state = baseStore.getState();\r\n  return {\r\n    ...state,\r\n    ...augmentedMethods,\r\n    persistence,\r\n  };\r\n};\r\n\r\nuseEmployeeStore.persistence = persistence;\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 2320, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/leaves/leave-quota-service.ts"],"sourcesContent":["import type { LeaveRequest } from './types';\r\nimport type { LeaveType } from '../settings/employees/types';\r\nimport { useEmployeeStore } from '../employees/store';\r\nimport { useEmployeeSettingsStore } from '../settings/employees/employee-settings-store';\r\nimport { getCurrentDate } from '../../lib/date-utils';\r\n\r\nconst clampNonNegative = (value: number) => (Number.isFinite(value) && value > 0 ? value : 0);\r\n\r\nconst resolveDelta = (leave: LeaveRequest) => {\r\n  const days = Number(leave.numberOfDays) || 0;\r\n  return days > 0 ? days : 0;\r\n};\r\n\r\ntype LeaveTypeMetadata = {\r\n  isPaid: boolean;\r\n  countsTowardsAnnual: boolean;\r\n};\r\n\r\nconst isAnnualLeaveType = (leaveType?: LeaveType | null) => {\r\n  if (!leaveType) return false;\r\n  const normalizedName = leaveType.name?.toLowerCase() ?? '';\r\n  const annualKeywords = ['phép năm', 'phep nam', 'annual'];\r\n  return annualKeywords.some((keyword) => normalizedName.includes(keyword));\r\n};\r\n\r\nconst resolveLeaveTypeMetadata = (leave: LeaveRequest): LeaveTypeMetadata => {\r\n  const settings = useEmployeeSettingsStore.getState().settings;\r\n  const matchedType = settings.leaveTypes.find((type) => {\r\n    if (leave.leaveTypeSystemId && type.systemId === leave.leaveTypeSystemId) return true;\r\n    if (leave.leaveTypeId && type.id === leave.leaveTypeId) return true;\r\n    return false;\r\n  });\r\n\r\n  const isPaid = typeof leave.leaveTypeIsPaid === 'boolean'\r\n    ? leave.leaveTypeIsPaid\r\n    : matchedType?.isPaid ?? true;\r\n\r\n  const countsTowardsAnnual = matchedType\r\n    ? isAnnualLeaveType(matchedType)\r\n    : isPaid;\r\n\r\n  return {\r\n    isPaid,\r\n    countsTowardsAnnual,\r\n  } satisfies LeaveTypeMetadata;\r\n};\r\n\r\nconst getServiceYears = (hireDate?: string) => {\r\n  if (!hireDate) return 0;\r\n  const parsed = new Date(hireDate);\r\n  if (Number.isNaN(parsed.getTime())) return 0;\r\n  const today = getCurrentDate();\r\n  let years = today.getFullYear() - parsed.getFullYear();\r\n  const hasNotReachedAnniversary =\r\n    today.getMonth() < parsed.getMonth() ||\r\n    (today.getMonth() === parsed.getMonth() && today.getDate() < parsed.getDate());\r\n  if (hasNotReachedAnniversary) {\r\n    years -= 1;\r\n  }\r\n  return Math.max(years, 0);\r\n};\r\n\r\nconst computeAnnualQuota = (employeeHireDate?: string) => {\r\n  const { baseAnnualLeaveDays, annualLeaveSeniorityBonus } = useEmployeeSettingsStore.getState().settings;\r\n  const base = baseAnnualLeaveDays ?? 0;\r\n  if (!annualLeaveSeniorityBonus) {\r\n    return clampNonNegative(base);\r\n  }\r\n  const years = getServiceYears(employeeHireDate);\r\n  const bonusInterval = annualLeaveSeniorityBonus.years || 0;\r\n  const bonusValue = annualLeaveSeniorityBonus.additionalDays || 0;\r\n  const bonusMultiplier = bonusInterval > 0 ? Math.floor(years / bonusInterval) : 0;\r\n  const bonus = bonusMultiplier * bonusValue;\r\n  return clampNonNegative(base + bonus);\r\n};\r\n\r\nconst adjustLeaveUsage = (leave: LeaveRequest, delta: number) => {\r\n  if (!delta) return;\r\n  const employeeStore = useEmployeeStore.getState();\r\n  const employee = employeeStore.findById(leave.employeeSystemId);\r\n  if (!employee) return;\r\n\r\n  const { isPaid, countsTowardsAnnual } = resolveLeaveTypeMetadata(leave);\r\n  const totalDelta = delta;\r\n  const paidDelta = isPaid ? delta : 0;\r\n  const unpaidDelta = isPaid ? 0 : delta;\r\n  const annualDelta = countsTowardsAnnual ? delta : 0;\r\n\r\n  const nextLeaveTaken = clampNonNegative((employee.leaveTaken ?? 0) + totalDelta);\r\n  const nextPaid = clampNonNegative((employee.paidLeaveTaken ?? 0) + paidDelta);\r\n  const nextUnpaid = clampNonNegative((employee.unpaidLeaveTaken ?? 0) + unpaidDelta);\r\n  const nextAnnual = clampNonNegative((employee.annualLeaveTaken ?? 0) + annualDelta);\r\n  const quota = computeAnnualQuota(employee.hireDate);\r\n  const nextBalance = clampNonNegative(quota - nextAnnual);\r\n\r\n  const hasChanges =\r\n    nextLeaveTaken !== (employee.leaveTaken ?? 0) ||\r\n    nextPaid !== (employee.paidLeaveTaken ?? 0) ||\r\n    nextUnpaid !== (employee.unpaidLeaveTaken ?? 0) ||\r\n    nextAnnual !== (employee.annualLeaveTaken ?? 0) ||\r\n    nextBalance !== (employee.annualLeaveBalance ?? quota);\r\n\r\n  if (!hasChanges) return;\r\n\r\n  employeeStore.update(leave.employeeSystemId, {\r\n    ...employee,\r\n    leaveTaken: nextLeaveTaken,\r\n    paidLeaveTaken: nextPaid,\r\n    unpaidLeaveTaken: nextUnpaid,\r\n    annualLeaveTaken: nextAnnual,\r\n    annualLeaveBalance: nextBalance,\r\n  });\r\n};\r\n\r\nexport const leaveQuotaSync = {\r\n  apply(leave: LeaveRequest) {\r\n    const delta = resolveDelta(leave);\r\n    if (!delta) return;\r\n    adjustLeaveUsage(leave, delta);\r\n  },\r\n  clear(leave: LeaveRequest) {\r\n    const delta = resolveDelta(leave);\r\n    if (!delta) return;\r\n    adjustLeaveUsage(leave, -delta);\r\n  },\r\n};\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 2430, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/leaves/store.ts"],"sourcesContent":["import { createCrudStore, type CrudState } from '../../lib/store-factory';\r\n// REMOVED: import { data as initialData } from './data'; // Mock data no longer used - database is source of truth\r\nimport type { LeaveRequest } from './types';\r\nimport { leaveAttendanceSync } from './leave-sync-service';\r\nimport { leaveQuotaSync } from './leave-quota-service';\r\n\r\nexport type LeaveStoreState = CrudState<LeaveRequest>;\r\n\r\nconst baseStore = createCrudStore<LeaveRequest>([], 'leaves', {\r\n\tbusinessIdField: 'id',\r\n\tapiEndpoint: '/api/leaves',\r\n});\r\n\r\nconst isApproved = (leave?: LeaveRequest | null): leave is LeaveRequest =>\r\n\tBoolean(leave && leave.status === 'Đã duyệt');\r\n\r\nconst snapshotLeave = (leave?: LeaveRequest | null): LeaveRequest | undefined =>\r\n\tleave ? { ...leave } : undefined;\r\n\r\nconst syncApprovedLeave = {\r\n\tapply: (leave: LeaveRequest) => {\r\n\t\tleaveAttendanceSync.apply(leave);\r\n\t\tleaveQuotaSync.apply(leave);\r\n\t},\r\n\tclear: (leave: LeaveRequest) => {\r\n\t\tleaveAttendanceSync.clear(leave);\r\n\t\tleaveQuotaSync.clear(leave);\r\n\t},\r\n};\r\n\r\nconst syncAwareActions: Pick<LeaveStoreState, 'add' | 'update' | 'remove' | 'restore' | 'hardDelete'> = {\r\n\tadd: (payload) => {\r\n\t\tconst created = baseStore.getState().add(payload);\r\n\t\tif (isApproved(created)) {\r\n\t\t\tsyncApprovedLeave.apply(created);\r\n\t\t}\r\n\t\treturn created;\r\n\t},\r\n\tupdate: (systemId, next) => {\r\n\t\tconst store = baseStore.getState();\r\n\t\tconst previous = snapshotLeave(store.findById(systemId));\r\n\t\tstore.update(systemId, next);\r\n\t\tconst updated = snapshotLeave(baseStore.getState().findById(systemId));\r\n\t\tif (isApproved(previous)) {\r\n\t\t\tsyncApprovedLeave.clear(previous);\r\n\t\t}\r\n\t\tif (isApproved(updated)) {\r\n\t\t\tsyncApprovedLeave.apply(updated);\r\n\t\t}\r\n\t},\r\n\tremove: (systemId) => {\r\n\t\tconst store = baseStore.getState();\r\n\t\tconst target = snapshotLeave(store.findById(systemId));\r\n\t\tstore.remove(systemId);\r\n\t\tif (isApproved(target)) {\r\n\t\t\tsyncApprovedLeave.clear(target);\r\n\t\t}\r\n\t},\r\n\trestore: (systemId) => {\r\n\t\tconst store = baseStore.getState();\r\n\t\tstore.restore(systemId);\r\n\t\tconst restored = snapshotLeave(baseStore.getState().findById(systemId));\r\n\t\tif (isApproved(restored)) {\r\n\t\t\tsyncApprovedLeave.apply(restored);\r\n\t\t}\r\n\t},\r\n\thardDelete: (systemId) => {\r\n\t\tconst store = baseStore.getState();\r\n\t\tconst target = snapshotLeave(store.findById(systemId));\r\n\t\tstore.hardDelete(systemId);\r\n\t\tif (isApproved(target)) {\r\n\t\t\tsyncApprovedLeave.clear(target);\r\n\t\t}\r\n\t},\r\n};\r\n\r\nconst withSync = (state: LeaveStoreState): LeaveStoreState => ({\r\n\t...state,\r\n\t...syncAwareActions,\r\n});\r\n\r\nexport const useLeaveStore = () => withSync(baseStore());\r\n\r\nuseLeaveStore.getState = () => withSync(baseStore.getState());\r\n"],"names":[],"mappings":";;;;AAAA;AAGA;AACA;;;;AAIA,MAAM,YAAY,IAAA,6IAAe,EAAe,EAAE,EAAE,UAAU;IAC7D,iBAAiB;IACjB,aAAa;AACd;AAEA,MAAM,aAAa,CAAC,QACnB,QAAQ,SAAS,MAAM,MAAM,KAAK;AAEnC,MAAM,gBAAgB,CAAC,QACtB,QAAQ;QAAE,GAAG,KAAK;IAAC,IAAI;AAExB,MAAM,oBAAoB;IACzB,OAAO,CAAC;QACP,wKAAmB,CAAC,KAAK,CAAC;QAC1B,oKAAc,CAAC,KAAK,CAAC;IACtB;IACA,OAAO,CAAC;QACP,wKAAmB,CAAC,KAAK,CAAC;QAC1B,oKAAc,CAAC,KAAK,CAAC;IACtB;AACD;AAEA,MAAM,mBAAkG;IACvG,KAAK,CAAC;QACL,MAAM,UAAU,UAAU,QAAQ,GAAG,GAAG,CAAC;QACzC,IAAI,WAAW,UAAU;YACxB,kBAAkB,KAAK,CAAC;QACzB;QACA,OAAO;IACR;IACA,QAAQ,CAAC,UAAU;QAClB,MAAM,QAAQ,UAAU,QAAQ;QAChC,MAAM,WAAW,cAAc,MAAM,QAAQ,CAAC;QAC9C,MAAM,MAAM,CAAC,UAAU;QACvB,MAAM,UAAU,cAAc,UAAU,QAAQ,GAAG,QAAQ,CAAC;QAC5D,IAAI,WAAW,WAAW;YACzB,kBAAkB,KAAK,CAAC;QACzB;QACA,IAAI,WAAW,UAAU;YACxB,kBAAkB,KAAK,CAAC;QACzB;IACD;IACA,QAAQ,CAAC;QACR,MAAM,QAAQ,UAAU,QAAQ;QAChC,MAAM,SAAS,cAAc,MAAM,QAAQ,CAAC;QAC5C,MAAM,MAAM,CAAC;QACb,IAAI,WAAW,SAAS;YACvB,kBAAkB,KAAK,CAAC;QACzB;IACD;IACA,SAAS,CAAC;QACT,MAAM,QAAQ,UAAU,QAAQ;QAChC,MAAM,OAAO,CAAC;QACd,MAAM,WAAW,cAAc,UAAU,QAAQ,GAAG,QAAQ,CAAC;QAC7D,IAAI,WAAW,WAAW;YACzB,kBAAkB,KAAK,CAAC;QACzB;IACD;IACA,YAAY,CAAC;QACZ,MAAM,QAAQ,UAAU,QAAQ;QAChC,MAAM,SAAS,cAAc,MAAM,QAAQ,CAAC;QAC5C,MAAM,UAAU,CAAC;QACjB,IAAI,WAAW,SAAS;YACvB,kBAAkB,KAAK,CAAC;QACzB;IACD;AACD;AAEA,MAAM,WAAW,CAAC,QAA4C,CAAC;QAC9D,GAAG,KAAK;QACR,GAAG,gBAAgB;IACpB,CAAC;AAEM,MAAM,gBAAgB,IAAM,SAAS;AAE5C,cAAc,QAAQ,GAAG,IAAM,SAAS,UAAU,QAAQ"}},
    {"offset": {"line": 2516, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/components/ui/card.tsx"],"sourcesContent":["import * as React from \"react\"\n\nimport { cn } from \"../../lib/utils\"\n\nconst Card = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\n      \"rounded-lg border border-border bg-card text-card-foreground shadow-sm\",\n      className\n    )}\n    {...props}\n  />\n))\nCard.displayName = \"Card\"\n\nconst CardHeader = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"flex flex-col space-y-1.5 p-6\", className)}\n    {...props}\n  />\n))\nCardHeader.displayName = \"CardHeader\"\n\nconst CardTitle = React.forwardRef<\n  HTMLHeadingElement,\n  React.HTMLAttributes<HTMLHeadingElement>\n>(({ className, ...props }, ref) => (\n  <h3\n    ref={ref}\n    className={cn(\n      \"text-h3 font-semibold leading-none tracking-tight\",\n      className\n    )}\n    {...props}\n  />\n))\nCardTitle.displayName = \"CardTitle\"\n\nconst CardDescription = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nCardDescription.displayName = \"CardDescription\"\n\nconst CardContent = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div ref={ref} className={cn(\"p-6 pt-0\", className)} {...props} />\n))\nCardContent.displayName = \"CardContent\"\n\nconst CardFooter = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"flex items-center p-6 pt-0\", className)}\n    {...props}\n  />\n))\nCardFooter.displayName = \"CardFooter\"\n\nexport { Card, CardHeader, CardFooter, CardTitle, CardDescription, CardContent }\n"],"names":[],"mappings":";;;;;;;;;;;;;;;AAAA;AAEA;;;;AAEA,MAAM,qBAAO,2KAAgB,MAG3B,CAAC,EAAE,SAAS,EAAE,GAAG,OAAO,EAAE,oBAC1B,6LAAC;QACC,KAAK;QACL,WAAW,IAAA,qHAAE,EACX,0EACA;QAED,GAAG,KAAK;;;;;;;AAGb,KAAK,WAAW,GAAG;AAEnB,MAAM,2BAAa,2KAAgB,OAGjC,CAAC,EAAE,SAAS,EAAE,GAAG,OAAO,EAAE,oBAC1B,6LAAC;QACC,KAAK;QACL,WAAW,IAAA,qHAAE,EAAC,iCAAiC;QAC9C,GAAG,KAAK;;;;;;;AAGb,WAAW,WAAW,GAAG;AAEzB,MAAM,0BAAY,2KAAgB,OAGhC,CAAC,EAAE,SAAS,EAAE,GAAG,OAAO,EAAE,oBAC1B,6LAAC;QACC,KAAK;QACL,WAAW,IAAA,qHAAE,EACX,qDACA;QAED,GAAG,KAAK;;;;;;;AAGb,UAAU,WAAW,GAAG;AAExB,MAAM,gCAAkB,2KAAgB,OAGtC,CAAC,EAAE,SAAS,EAAE,GAAG,OAAO,EAAE,oBAC1B,6LAAC;QACC,KAAK;QACL,WAAW,IAAA,qHAAE,EAAC,iCAAiC;QAC9C,GAAG,KAAK;;;;;;;AAGb,gBAAgB,WAAW,GAAG;AAE9B,MAAM,4BAAc,2KAAgB,OAGlC,CAAC,EAAE,SAAS,EAAE,GAAG,OAAO,EAAE,oBAC1B,6LAAC;QAAI,KAAK;QAAK,WAAW,IAAA,qHAAE,EAAC,YAAY;QAAa,GAAG,KAAK;;;;;;;AAEhE,YAAY,WAAW,GAAG;AAE1B,MAAM,2BAAa,2KAAgB,QAGjC,CAAC,EAAE,SAAS,EAAE,GAAG,OAAO,EAAE,oBAC1B,6LAAC;QACC,KAAK;QACL,WAAW,IAAA,qHAAE,EAAC,8BAA8B;QAC3C,GAAG,KAAK;;;;;;;AAGb,WAAW,WAAW,GAAG"}},
    {"offset": {"line": 2623, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/components/ui/detail-field.tsx"],"sourcesContent":["import * as React from 'react';\r\nimport { cn } from '../../lib/utils';\r\n\r\nexport const DetailField = ({ label, value, children, className }: { label: string, value?: React.ReactNode, children?: React.ReactNode, className?: string }) => {\r\n    const content = value ?? children;\r\n    \r\n    return (\r\n        <div className={cn(\"grid grid-cols-1 sm:grid-cols-3 gap-1 sm:gap-4 py-2 border-b\", className)}>\r\n            <dt className=\"text-sm font-medium text-muted-foreground\">{label}</dt>\r\n            <dd className=\"col-span-2 text-sm text-foreground break-words\">\r\n                {(content !== null && content !== undefined && content !== '') ? content : '-'}\r\n            </dd>\r\n        </div>\r\n    );\r\n};\r\n"],"names":[],"mappings":";;;;;AACA;;;AAEO,MAAM,cAAc,CAAC,EAAE,KAAK,EAAE,KAAK,EAAE,QAAQ,EAAE,SAAS,EAA8F;IACzJ,MAAM,UAAU,SAAS;IAEzB,qBACI,6LAAC;QAAI,WAAW,IAAA,qHAAE,EAAC,gEAAgE;;0BAC/E,6LAAC;gBAAG,WAAU;0BAA6C;;;;;;0BAC3D,6LAAC;gBAAG,WAAU;0BACT,AAAC,YAAY,QAAQ,YAAY,aAAa,YAAY,KAAM,UAAU;;;;;;;;;;;;AAI3F;KAXa"}},
    {"offset": {"line": 2669, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/components/ui/textarea.tsx"],"sourcesContent":["import * as React from \"react\"\r\n\r\nimport { cn } from \"../../lib/utils\"\r\n\r\nconst Textarea = React.forwardRef<\r\n  HTMLTextAreaElement,\r\n  React.ComponentProps<\"textarea\">\r\n>(({ className, ...props }, ref) => {\r\n  return (\r\n    <textarea\r\n      className={cn(\r\n        \"flex min-h-[80px] w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm\",\r\n        className\r\n      )}\r\n      ref={ref}\r\n      {...props}\r\n    />\r\n  )\r\n})\r\nTextarea.displayName = \"Textarea\"\r\n\r\nexport { Textarea }\r\n"],"names":[],"mappings":";;;;;AAAA;AAEA;;;;AAEA,MAAM,yBAAW,2KAAgB,MAG/B,CAAC,EAAE,SAAS,EAAE,GAAG,OAAO,EAAE;IAC1B,qBACE,6LAAC;QACC,WAAW,IAAA,qHAAE,EACX,qTACA;QAEF,KAAK;QACJ,GAAG,KAAK;;;;;;AAGf;;AACA,SAAS,WAAW,GAAG"}},
    {"offset": {"line": 2703, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/lib/api-config.ts"],"sourcesContent":["/**\r\n * API Configuration Utilities\r\n * \r\n * Centralized configuration for API endpoints.\r\n * All API URLs should use these utilities instead of hardcoding.\r\n */\r\n\r\n/**\r\n * Get the API base URL from environment variables\r\n * Falls back to localhost:3001 for development\r\n */\r\nexport function getApiBaseUrl(): string {\r\n  // Use relative path to leverage Vite proxy in development\r\n  // This avoids CORS issues when frontend (5173) talks to backend (3001)\r\n  if ((import.meta as any).env?.DEV) {\r\n    return '/api';\r\n  }\r\n  return (import.meta as any).env?.VITE_API_BASE_URL || 'http://localhost:3001/api';\r\n}\r\n\r\n/**\r\n * Get the base URL without /api suffix\r\n * Falls back to localhost:3001 for development\r\n */\r\nexport function getBaseUrl(): string {\r\n  const apiUrl = getApiBaseUrl();\r\n  return apiUrl.replace('/api', '');\r\n}\r\n\r\n/**\r\n * Build a full file URL from a relative path\r\n * @param relativePath - Relative file path (e.g., \"/uploads/documents/file.pdf\")\r\n * @returns Full URL to the file\r\n */\r\nexport function getFileUrl(relativePath: string): string {\r\n  if (!relativePath) return '';\r\n  \r\n  // If already a full URL, return as is\r\n  if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {\r\n    return relativePath;\r\n  }\r\n  \r\n  // Build full URL\r\n  const baseUrl = getBaseUrl();\r\n  return `${baseUrl}${relativePath}`;\r\n}\r\n\r\n/**\r\n * Build an API endpoint URL\r\n * @param endpoint - API endpoint path (e.g., \"/employees/documents\")\r\n * @returns Full API URL\r\n */\r\nexport function getApiUrl(endpoint: string): string {\r\n  const apiBaseUrl = getApiBaseUrl();\r\n  return `${apiBaseUrl}${endpoint}`;\r\n}\r\n"],"names":[],"mappings":"AAAA;;;;;CAKC,GAED;;;CAGC;;;;;;;;;;;;;;;AACM,SAAS;IACd,0DAA0D;IAC1D,uEAAuE;IACvE,IAAI,8BAAqB,GAAG,EAAE,KAAK;QACjC,OAAO;IACT;IACA,OAAO,8BAAqB,GAAG,EAAE,qBAAqB;AACxD;AAMO,SAAS;IACd,MAAM,SAAS;IACf,OAAO,OAAO,OAAO,CAAC,QAAQ;AAChC;AAOO,SAAS,WAAW,YAAoB;IAC7C,IAAI,CAAC,cAAc,OAAO;IAE1B,sCAAsC;IACtC,IAAI,aAAa,UAAU,CAAC,cAAc,aAAa,UAAU,CAAC,aAAa;QAC7E,OAAO;IACT;IAEA,iBAAiB;IACjB,MAAM,UAAU;IAChB,OAAO,GAAG,UAAU,cAAc;AACpC;AAOO,SAAS,UAAU,QAAgB;IACxC,MAAM,aAAa;IACnB,OAAO,GAAG,aAAa,UAAU;AACnC"}},
    {"offset": {"line": 2759, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/lib/file-upload-api.ts"],"sourcesContent":["// API client để giao tiếp với server - Staging System\r\nimport { getApiBaseUrl } from './api-config';\r\n\r\nconst API_BASE_URL = getApiBaseUrl();\r\n\r\nexport type StagingFile = {\r\n  id: string;\r\n  sessionId: string;\r\n  name: string; // Display name (smart filename với metadata)\r\n  originalName: string; // Tên file gốc\r\n  slug: string; // URL-safe slug\r\n  filename: string; // Tên file hệ thống (UUID) - cần cho preview URL\r\n  size: number;\r\n  type: string;\r\n  url: string;\r\n  status: 'staging' | 'permanent'; // ✅ Support both staging and permanent files\r\n  uploadedAt: string;\r\n  metadata: string; // Smart filename metadata\r\n};\r\n\r\nexport type ServerFile = {\r\n  id: string;\r\n  employeeId: string;\r\n  documentType: string;\r\n  documentName: string;\r\n  name: string; // Display name\r\n  originalName: string; // Tên file gốc\r\n  slug: string; // URL-safe slug\r\n  filename: string; // Tên file hệ thống\r\n  size: number;\r\n  type: string;\r\n  url: string;\r\n  uploadedAt: string;\r\n  confirmedAt?: string;\r\n  metadata: string; // Smart filename metadata\r\n};\r\n\r\nexport type UploadedAsset = {\r\n  id: string;\r\n  name: string;\r\n  size: number;\r\n  type: string;\r\n  url: string;\r\n  uploadedAt: string;\r\n};\r\n\r\nexport type UploadedFile = {\r\n  id: string;\r\n  name: string;\r\n  filename?: string;\r\n  type: string;\r\n  size: number;\r\n  url: string;\r\n  uploadedAt?: string;\r\n  metadata?: Record<string, unknown>;\r\n};\r\n\r\nexport class FileUploadAPI {\r\n  // Upload files vào staging (tạm thời)\r\n  static async uploadToStaging(files: File[], sessionId?: string): Promise<{\r\n    files: StagingFile[];\r\n    sessionId: string;\r\n  }> {\r\n    const formData = new FormData();\r\n    \r\n    files.forEach(file => {\r\n      formData.append('files', file);\r\n    });\r\n\r\n    // CRITICAL FIX: sessionId in FormData doesn't work with multer\r\n    // Send via query params instead\r\n    const url = sessionId \r\n      ? `${API_BASE_URL}/staging/upload?sessionId=${encodeURIComponent(sessionId)}`\r\n      : `${API_BASE_URL}/staging/upload`;\r\n\r\n    console.log('📤 Uploading to:', url);\r\n    console.log('📦 Files:', files.map(f => `${f.name} (${(f.size / 1024).toFixed(1)}KB)`));\r\n\r\n    let response;\r\n    try {\r\n      response = await fetch(url, {\r\n        method: 'POST',\r\n        body: formData,\r\n      });\r\n    } catch (fetchError) {\r\n      console.error('❌ Network fetch failed:', fetchError);\r\n      throw new Error(`Không thể kết nối đến server (${API_BASE_URL}). Vui lòng kiểm tra server có đang chạy.`);\r\n    }\r\n\r\n    if (!response.ok) {\r\n      const errorText = await response.text();\r\n      console.error('❌ Server error:', response.status, errorText);\r\n      throw new Error(`Server error (${response.status}): ${errorText}`);\r\n    }\r\n\r\n    const result = await response.json();\r\n    \r\n    if (!result.success) {\r\n      throw new Error(result.message || 'Staging upload failed');\r\n    }\r\n\r\n    return {\r\n      files: result.files,\r\n      sessionId: result.sessionId\r\n    };\r\n  }\r\n\r\n  // Confirm staging files → permanent với smart filename\r\n  // NOTE: entitySystemId MUST be immutable (systemId) to avoid broken references\r\n  static async confirmStagingFiles(\r\n    sessionId: string,\r\n    entitySystemId: string,\r\n    documentType: string,\r\n    documentName: string,\r\n    metadata?: Record<string, any>\r\n  ): Promise<ServerFile[]> {\r\n    const response = await fetch(\r\n      `${API_BASE_URL}/staging/confirm/${sessionId}/${entitySystemId}/${documentType}/${encodeURIComponent(documentName)}`,\r\n      { \r\n        method: 'POST',\r\n        headers: {\r\n          'Content-Type': 'application/json'\r\n        },\r\n        body: JSON.stringify({ metadata })\r\n      }\r\n    );\r\n\r\n    const result = await response.json();\r\n    \r\n    if (!result.success) {\r\n      throw new Error(result.message || 'Confirm failed');\r\n    }\r\n\r\n    return result.files;\r\n  }\r\n\r\n  // Lấy staging files theo session\r\n  static async getStagingFiles(sessionId: string): Promise<StagingFile[]> {\r\n    const response = await fetch(`${API_BASE_URL}/staging/files/${sessionId}`);\r\n    const result = await response.json();\r\n    \r\n    if (!result.success) {\r\n      throw new Error(result.message || 'Failed to fetch staging files');\r\n    }\r\n\r\n    return result.files;\r\n  }\r\n\r\n  // Xóa staging files (cancel)\r\n  static async deleteStagingFiles(sessionId: string): Promise<void> {\r\n    const response = await fetch(`${API_BASE_URL}/staging/${sessionId}`, {\r\n      method: 'DELETE',\r\n    });\r\n\r\n    const result = await response.json();\r\n    \r\n    if (!result.success) {\r\n      throw new Error(result.message || 'Delete staging failed');\r\n    }\r\n  }\r\n\r\n  // Upload files lên server (legacy - direct permanent)\r\n  // NOTE: employeeId MUST be the systemId (immutable), NOT the business ID\r\n  static async uploadFiles(\r\n    employeeId: string, // ⚠️ MUST use systemId (e.g., \"NV00000001\"), NOT business ID\r\n    documentType: string,\r\n    documentName: string,\r\n    files: File[]\r\n  ): Promise<ServerFile[]> {\r\n    const formData = new FormData();\r\n    \r\n    files.forEach(file => {\r\n      formData.append('files', file);\r\n    });\r\n\r\n    const response = await fetch(\r\n      `${API_BASE_URL}/upload/${employeeId}/${documentType}/${encodeURIComponent(documentName)}`,\r\n      {\r\n        method: 'POST',\r\n        body: formData,\r\n      }\r\n    );\r\n\r\n    const result = await response.json();\r\n    \r\n    if (!result.success) {\r\n      throw new Error(result.message || 'Upload failed');\r\n    }\r\n\r\n    return result.files;\r\n  }\r\n\r\n  // Lấy danh sách file permanent\r\n  // NOTE: employeeId MUST be the systemId (immutable), NOT the business ID\r\n  static async getFiles(\r\n    employeeId: string, // ⚠️ MUST use systemId (e.g., \"NV00000001\"), NOT business ID\r\n    documentType?: string\r\n  ): Promise<ServerFile[]> {\r\n    try {\r\n      const url = documentType \r\n        ? `${API_BASE_URL}/files/${employeeId}/${documentType}`\r\n        : `${API_BASE_URL}/files/${employeeId}`;\r\n\r\n      const response = await fetch(url);\r\n      \r\n      // Check if response is ok\r\n      if (!response.ok) {\r\n        return []; // Return empty array instead of throwing\r\n      }\r\n      \r\n      const result = await response.json();\r\n      \r\n      if (!result.success) {\r\n        return []; // Return empty array instead of throwing\r\n      }\r\n\r\n      return result.files || [];\r\n    } catch (error) {\r\n      return []; // Return empty array on network error\r\n    }\r\n  }\r\n\r\n  // Xóa file permanent\r\n  static async deleteFile(fileId: string): Promise<void> {\r\n    const response = await fetch(`${API_BASE_URL}/files/${fileId}`, {\r\n      method: 'DELETE',\r\n    });\r\n\r\n    const result = await response.json();\r\n    \r\n    if (!result.success) {\r\n      throw new Error(result.message || 'Delete failed');\r\n    }\r\n  }\r\n\r\n  // Lấy URL file để hiển thị (bao gồm staging và permanent)\r\n  static getFileUrl(file: StagingFile | ServerFile): string {\r\n    // ✅ Return relative path to use Vite proxy - avoid CORS\r\n    // Server already returns relative path like /api/staging/files/...\r\n    return file.url;\r\n  }\r\n\r\n  // Thống kê storage (chỉ permanent files)\r\n  static async getStorageInfo(): Promise<{\r\n    totalFiles: number;\r\n    totalSize: number;\r\n    totalSizeMB: number;\r\n  }> {\r\n    const response = await fetch(`${API_BASE_URL}/storage/info`);\r\n    const result = await response.json();\r\n    \r\n    if (!result.success) {\r\n      throw new Error('Failed to get storage info');\r\n    }\r\n\r\n    return result.stats;\r\n  }\r\n\r\n  // Helper: Generate session ID cho staging\r\n  static generateSessionId(): string {\r\n    return `session_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\r\n  }\r\n\r\n  static async getProductFiles(productId: string): Promise<ServerFile[]> {\r\n    return this.getFiles(productId, 'products');\r\n  }\r\n\r\n  // Get customer files (images)\r\n  static async getCustomerFiles(customerId: string): Promise<ServerFile[]> {\r\n    try {\r\n      const response = await fetch(`${API_BASE_URL}/files/customers/${customerId}`);\r\n      \r\n      if (!response.ok) {\r\n        return [];\r\n      }\r\n      \r\n      const result = await response.json();\r\n      \r\n      if (!result.success) {\r\n        return [];\r\n      }\r\n\r\n      return result.files || [];\r\n    } catch (error) {\r\n      console.error('Failed to get customer files:', error);\r\n      return [];\r\n    }\r\n  }\r\n\r\n  // Get customer contract files\r\n  static async getCustomerContractFiles(customerId: string): Promise<ServerFile[]> {\r\n    try {\r\n      const response = await fetch(`${API_BASE_URL}/files/customers/${customerId}/contracts`);\r\n      \r\n      if (!response.ok) {\r\n        return [];\r\n      }\r\n      \r\n      const result = await response.json();\r\n      \r\n      if (!result.success) {\r\n        return [];\r\n      }\r\n\r\n      return result.files || [];\r\n    } catch (error) {\r\n      console.error('Failed to get customer contract files:', error);\r\n      return [];\r\n    }\r\n  }\r\n\r\n  // Confirm customer contract files from staging to permanent\r\n  static async confirmCustomerContractFiles(\r\n    sessionId: string,\r\n    customerId: string,\r\n    customerData?: Record<string, any>\r\n  ): Promise<ServerFile[]> {\r\n    const response = await fetch(\r\n      `${API_BASE_URL}/staging/confirm/${sessionId}/customers/${customerId}/contracts`,\r\n      { \r\n        method: 'POST',\r\n        headers: {\r\n          'Content-Type': 'application/json'\r\n        },\r\n        body: JSON.stringify({ customerData })\r\n      }\r\n    );\r\n\r\n    const result = await response.json();\r\n    \r\n    if (!result.success) {\r\n      throw new Error(result.message || 'Confirm customer contract files failed');\r\n    }\r\n\r\n    return result.files;\r\n  }\r\n\r\n  // Confirm customer images from staging to permanent\r\n  static async confirmCustomerImages(\r\n    sessionId: string,\r\n    customerId: string,\r\n    customerData?: {\r\n      name?: string;\r\n      [key: string]: any;\r\n    }\r\n  ): Promise<ServerFile[]> {\r\n    const response = await fetch(\r\n      `${API_BASE_URL}/staging/confirm/${sessionId}/customers/${customerId}`,\r\n      { \r\n        method: 'POST',\r\n        headers: {\r\n          'Content-Type': 'application/json'\r\n        },\r\n        body: JSON.stringify({ customerData })\r\n      }\r\n    );\r\n\r\n    const result = await response.json();\r\n    \r\n    if (!result.success) {\r\n      throw new Error(result.message || 'Confirm customer images failed');\r\n    }\r\n\r\n    return result.files;\r\n  }\r\n\r\n  // Confirm warranty images from staging to permanent\r\n  static async confirmWarrantyImages(\r\n    sessionId: string,\r\n    warrantyId: string,\r\n    imageType: 'received' | 'processed',\r\n    warrantyData?: {\r\n      customerName?: string;\r\n      [key: string]: any;\r\n    }\r\n  ): Promise<ServerFile[]> {\r\n    const response = await fetch(\r\n      `${API_BASE_URL}/staging/confirm/${sessionId}/warranty/${warrantyId}/${imageType}`,\r\n      { \r\n        method: 'POST',\r\n        headers: {\r\n          'Content-Type': 'application/json'\r\n        },\r\n        body: JSON.stringify({ warrantyData })\r\n      }\r\n    );\r\n\r\n    const result = await response.json();\r\n    \r\n    if (!result.success) {\r\n      throw new Error(result.message || 'Confirm warranty images failed');\r\n    }\r\n\r\n    return result.files;\r\n  }\r\n\r\n  // Delete staging session (cleanup on cancel)\r\n  static async deleteStagingSession(sessionId: string): Promise<void> {\r\n    const response = await fetch(\r\n      `${API_BASE_URL}/staging/${sessionId}`,\r\n      { method: 'DELETE' }\r\n    );\r\n\r\n    const result = await response.json();\r\n    \r\n    if (!result.success) {\r\n      throw new Error(result.message || 'Delete staging session failed');\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Upload ảnh từ TipTap Editor vào STAGING\r\n   * Ảnh sẽ được move sang permanent khi entity được save\r\n   * \r\n   * @param file - File ảnh cần upload\r\n   * @param sessionId - Session ID để group các ảnh cùng editor\r\n   * @returns StagingFile với URL tạm thời\r\n   */\r\n  static async uploadEditorImageToStaging(file: File, sessionId?: string): Promise<{\r\n    file: StagingFile;\r\n    sessionId: string;\r\n  }> {\r\n    const result = await FileUploadAPI.uploadToStaging([file], sessionId);\r\n    return {\r\n      file: result.files[0],\r\n      sessionId: result.sessionId,\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Confirm ảnh editor từ staging sang permanent\r\n   * Đồng thời replace staging URLs trong HTML content bằng permanent URLs\r\n   * \r\n   * @param sessionId - Editor staging session\r\n   * @param entityId - ID của entity (category, product, etc.)\r\n   * @param entityType - Loại entity ('categories', 'products', etc.)\r\n   * @param htmlContent - Nội dung HTML cần update URLs\r\n   * @returns Updated HTML với permanent URLs\r\n   */\r\n  static async confirmEditorImages(\r\n    sessionId: string,\r\n    entityId: string,\r\n    entityType: string,\r\n    htmlContent: string\r\n  ): Promise<{ html: string; files: ServerFile[] }> {\r\n    // Confirm staging files\r\n    const confirmedFiles = await FileUploadAPI.confirmStagingFiles(\r\n      sessionId,\r\n      entityId,\r\n      entityType,\r\n      'editor-images',\r\n      { source: 'tiptap-editor' }\r\n    );\r\n\r\n    // Replace staging URLs with permanent URLs in HTML\r\n    let updatedHtml = htmlContent;\r\n    for (const file of confirmedFiles) {\r\n      // Staging URL pattern: /api/staging/preview/{sessionId}/{filename}\r\n      // Find and replace with permanent URL\r\n      const stagingPattern = new RegExp(\r\n        `/api/staging/preview/[^/]+/${file.filename.replace(/[.*+?^${}()|[\\]\\\\]/g, '\\\\$&')}`,\r\n        'g'\r\n      );\r\n      updatedHtml = updatedHtml.replace(stagingPattern, file.url);\r\n    }\r\n\r\n    return {\r\n      html: updatedHtml,\r\n      files: confirmedFiles,\r\n    };\r\n  }\r\n\r\n  static async uploadCommentImage(file: File): Promise<UploadedAsset> {\r\n    const formData = new FormData();\r\n    formData.append('image', file);\r\n\r\n    const response = await fetch(`${API_BASE_URL}/comments/upload-image`, {\r\n      method: 'POST',\r\n      body: formData,\r\n    });\r\n\r\n    const result = await response.json();\r\n    if (!response.ok || !result.success) {\r\n      throw new Error(result.message || 'Upload ảnh bình luận thất bại');\r\n    }\r\n\r\n    return FileUploadAPI.mapDirectUpload(result.file, file.name);\r\n  }\r\n\r\n  static async uploadPrintTemplateImage(file: File): Promise<UploadedAsset> {\r\n    const formData = new FormData();\r\n    formData.append('image', file);\r\n\r\n    const response = await fetch(`${API_BASE_URL}/print-templates/upload-image`, {\r\n      method: 'POST',\r\n      body: formData,\r\n    });\r\n\r\n    const result = await response.json();\r\n    if (!response.ok || !result.success) {\r\n      throw new Error(result.message || 'Upload ảnh mẫu in thất bại');\r\n    }\r\n\r\n    return FileUploadAPI.mapDirectUpload(result.file, file.name);\r\n  }\r\n\r\n  static async uploadComplaintCommentImage(complaintId: string, file: File): Promise<UploadedAsset> {\r\n    const formData = new FormData();\r\n    formData.append('image', file);\r\n\r\n    const response = await fetch(`${API_BASE_URL}/complaints/${complaintId}/comments/upload`, {\r\n      method: 'POST',\r\n      body: formData,\r\n    });\r\n\r\n    const result = await response.json();\r\n    if (!response.ok || !result.success) {\r\n      throw new Error(result.message || 'Upload ảnh khiếu nại thất bại');\r\n    }\r\n\r\n    return FileUploadAPI.mapDirectUpload(result.file, file.name);\r\n  }\r\n\r\n  static async uploadTaskEvidence(taskId: string, files: File[]): Promise<UploadedAsset[]> {\r\n    if (files.length === 0) {\r\n      return [];\r\n    }\r\n\r\n    const formData = new FormData();\r\n    files.forEach((file) => formData.append('files', file));\r\n\r\n    const response = await fetch(`${API_BASE_URL}/tasks/${taskId}/evidence`, {\r\n      method: 'POST',\r\n      body: formData,\r\n    });\r\n\r\n    const result = await response.json();\r\n    if (!response.ok || !result.success) {\r\n      throw new Error(result.message || 'Upload bằng chứng công việc thất bại');\r\n    }\r\n\r\n    return (result.files || []).map((file: any, index: number) =>\r\n      FileUploadAPI.mapDirectUpload(file, files[index]?.name || `evidence-${index}`)\r\n    );\r\n  }\r\n\r\n  private static mapDirectUpload(file: any, fallbackName: string): UploadedAsset {\r\n    return {\r\n      id: file.id,\r\n      name: file.originalName || file.name || fallbackName,\r\n      size: file.size || file.filesize || 0,\r\n      type: file.mimetype || file.type || 'application/octet-stream',\r\n      url: file.url,\r\n      uploadedAt: file.uploadedAt || new Date().toISOString(),\r\n    };\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 3119, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/components/ui/mention-combobox.tsx"],"sourcesContent":["/**\r\n * Mention Combobox for TipTap Editor\r\n * \r\n * Virtualized dropdown with search for @mention functionality\r\n * Optimized for 100+ employees\r\n */\r\n\r\nimport * as React from 'react';\r\nimport { useVirtualizer } from '@tanstack/react-virtual';\r\nimport { cn } from '../../lib/utils';\r\nimport { Avatar, AvatarFallback } from './avatar';\r\nimport { Check } from 'lucide-react';\r\n\r\nexport interface MentionOption {\r\n  id: string;\r\n  label: string;\r\n  avatar?: string;\r\n}\r\n\r\ninterface MentionComboboxProps {\r\n  items: MentionOption[];\r\n  selectedIndex: number;\r\n  onSelect: (index: number) => void;\r\n  onKeyDown: (event: KeyboardEvent) => boolean;\r\n}\r\n\r\nexport class MentionCombobox {\r\n  items: MentionOption[];\r\n  selectedIndex: number;\r\n  element: HTMLElement;\r\n  command: any;\r\n  query: string;\r\n  virtualizer: any;\r\n  parentRef: HTMLDivElement | null;\r\n\r\n  constructor(props: any) {\r\n    this.items = props.items;\r\n    this.command = props.command;\r\n    this.query = '';\r\n    this.selectedIndex = 0;\r\n    this.parentRef = null;\r\n    this.element = document.createElement('div');\r\n    this.element.className = 'bg-popover text-popover-foreground border border-border rounded-md shadow-lg overflow-hidden z-50';\r\n    this.element.style.width = '320px';\r\n    this.element.style.maxHeight = '420px';\r\n    this.render();\r\n  }\r\n\r\n  render() {\r\n    if (this.items.length === 0) {\r\n      this.element.innerHTML = `\r\n        <div class=\"p-4 text-center\">\r\n          <div class=\"text-sm text-muted-foreground\">Không tìm thấy nhân viên</div>\r\n          <div class=\"text-xs text-muted-foreground mt-1\">Thử tìm kiếm với từ khóa khác</div>\r\n        </div>\r\n      `;\r\n      return;\r\n    }\r\n\r\n    // Header\r\n    const headerHtml = `\r\n      <div class=\"border-b border-border bg-muted/30 px-3 py-2 flex items-center justify-between sticky top-0 z-10\">\r\n        <div class=\"text-xs font-medium text-muted-foreground flex items-center gap-2\">\r\n          <svg class=\"h-3.5 w-3.5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n            <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z\" />\r\n          </svg>\r\n          <span>Tag nhân viên • ${this.items.length} người</span>\r\n        </div>\r\n      </div>\r\n    `;\r\n\r\n    // Virtualized list - Render all items\r\n    const itemsHtml = this.items\r\n      .map((item, index) => {\r\n        const isSelected = index === this.selectedIndex;\r\n        const avatarInitial = item.label ? item.label[0].toUpperCase() : '?';\r\n        \r\n        return `\r\n          <button\r\n            type=\"button\"\r\n            class=\"mention-item flex items-center gap-3 w-full px-3 py-2.5 text-sm transition-all ${\r\n              isSelected \r\n                ? 'bg-accent text-accent-foreground' \r\n                : 'hover:bg-accent/50'\r\n            }\"\r\n            data-index=\"${index}\"\r\n            data-id=\"${item.id}\"\r\n          >\r\n            ${\r\n              item.avatar \r\n                ? `<img src=\"${item.avatar}\" alt=\"${item.label}\" class=\"w-9 h-9 rounded-full object-cover flex-shrink-0 border border-border\" />` \r\n                : `<div class=\"w-9 h-9 rounded-full bg-primary/10 text-primary flex items-center justify-center text-sm font-semibold flex-shrink-0 border border-primary/20\">${avatarInitial}</div>`\r\n            }\r\n            <span class=\"font-medium truncate flex-1 text-left\">${item.label}</span>\r\n            ${isSelected ? '<svg class=\"h-4 w-4 text-primary flex-shrink-0\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\"><path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M5 13l4 4L19 7\"></path></svg>' : ''}\r\n          </button>\r\n        `;\r\n      })\r\n      .join('');\r\n\r\n    this.element.innerHTML = `\r\n      ${headerHtml}\r\n      <div class=\"overflow-y-auto scrollbar-thin\" style=\"max-height: 380px;\" data-scroll-container>\r\n        ${itemsHtml}\r\n      </div>\r\n    `;\r\n\r\n    // Add click event listeners\r\n    this.element.querySelectorAll('.mention-item').forEach((btn, index) => {\r\n      btn.addEventListener('click', (e) => {\r\n        e.preventDefault();\r\n        e.stopPropagation();\r\n        this.selectItem(index);\r\n      });\r\n      \r\n      btn.addEventListener('mousedown', (e) => {\r\n        e.preventDefault();\r\n      });\r\n      \r\n      // Hover to highlight\r\n      btn.addEventListener('mouseenter', () => {\r\n        this.selectedIndex = index;\r\n        this.updateSelection();\r\n      });\r\n    });\r\n    \r\n    // Auto scroll to selected item\r\n    this.scrollToSelected();\r\n  }\r\n  \r\n  updateSelection() {\r\n    const buttons = this.element.querySelectorAll('.mention-item');\r\n    buttons.forEach((btn, index) => {\r\n      if (index === this.selectedIndex) {\r\n        btn.classList.add('bg-accent', 'text-accent-foreground');\r\n        btn.classList.remove('hover:bg-accent/50');\r\n        // Add checkmark\r\n        const hasCheck = btn.querySelector('svg');\r\n        if (!hasCheck) {\r\n          btn.innerHTML = btn.innerHTML + '<svg class=\"h-4 w-4 text-primary flex-shrink-0\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\"><path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M5 13l4 4L19 7\"></path></svg>';\r\n        }\r\n      } else {\r\n        btn.classList.remove('bg-accent', 'text-accent-foreground');\r\n        btn.classList.add('hover:bg-accent/50');\r\n        // Remove checkmark\r\n        const check = btn.querySelector('svg');\r\n        if (check) check.remove();\r\n      }\r\n    });\r\n    this.scrollToSelected();\r\n  }\r\n  \r\n  scrollToSelected() {\r\n    const scrollContainer = this.element.querySelector('[data-scroll-container]') as HTMLElement;\r\n    const buttons = this.element.querySelectorAll('.mention-item');\r\n    const selectedButton = buttons[this.selectedIndex] as HTMLElement;\r\n    \r\n    if (scrollContainer && selectedButton) {\r\n      const containerRect = scrollContainer.getBoundingClientRect();\r\n      const itemRect = selectedButton.getBoundingClientRect();\r\n      const scrollTop = scrollContainer.scrollTop;\r\n      \r\n      const itemTop = itemRect.top - containerRect.top + scrollTop;\r\n      const itemBottom = itemTop + itemRect.height;\r\n      \r\n      const visibleTop = scrollTop;\r\n      const visibleBottom = scrollTop + scrollContainer.clientHeight;\r\n      \r\n      if (itemTop < visibleTop) {\r\n        scrollContainer.scrollTop = itemTop - 8; // 8px padding\r\n      } else if (itemBottom > visibleBottom) {\r\n        scrollContainer.scrollTop = itemBottom - scrollContainer.clientHeight + 8;\r\n      }\r\n    }\r\n  }\r\n\r\n  updateProps(props: any) {\r\n    this.items = props.items;\r\n    this.command = props.command;\r\n    this.selectedIndex = 0;\r\n    this.render();\r\n  }\r\n\r\n  onKeyDown({ event }: { event: KeyboardEvent }) {\r\n    if (event.key === 'ArrowUp') {\r\n      this.upHandler();\r\n      return true;\r\n    }\r\n    if (event.key === 'ArrowDown') {\r\n      this.downHandler();\r\n      return true;\r\n    }\r\n    if (event.key === 'Enter') {\r\n      this.enterHandler();\r\n      return true;\r\n    }\r\n    return false;\r\n  }\r\n\r\n  upHandler() {\r\n    this.selectedIndex = (this.selectedIndex + this.items.length - 1) % this.items.length;\r\n    this.updateSelection();\r\n  }\r\n\r\n  downHandler() {\r\n    this.selectedIndex = (this.selectedIndex + 1) % this.items.length;\r\n    this.updateSelection();\r\n  }\r\n\r\n  enterHandler() {\r\n    this.selectItem(this.selectedIndex);\r\n  }\r\n\r\n  selectItem(index: number) {\r\n    const item = this.items[index];\r\n    if (item && this.command) {\r\n      this.command({ id: item.id, label: item.label });\r\n    }\r\n  }\r\n\r\n  destroy() {\r\n    this.element.remove();\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 3303, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/components/ui/comment-editor.tsx"],"sourcesContent":["/**\r\n * Comment Editor - Simplified TipTap for comments\r\n * \r\n * Features:\r\n * - @mention employees\r\n * - Upload/paste/drop images → direct to server (no staging)\r\n * - Rich text formatting\r\n * - Enter to submit\r\n * \r\n * Use this for: Comments, quick notes, chat-like UX\r\n * For rich content (category, product descriptions), use TipTapEditor instead\r\n */\r\n\r\nimport * as React from 'react';\r\nimport { useEditor, EditorContent } from '@tiptap/react';\r\nimport StarterKit from '@tiptap/starter-kit';\r\nimport Image from '@tiptap/extension-image';\r\nimport Mention from '@tiptap/extension-mention';\r\nimport Placeholder from '@tiptap/extension-placeholder';\r\nimport { cn } from '../../lib/utils';\r\nimport { FileUploadAPI } from '../../lib/file-upload-api';\r\nimport { Bold, Italic, Image as ImageIcon, AtSign, Upload, Loader2 } from 'lucide-react';\r\nimport { Button } from './button';\r\nimport { toast } from 'sonner';\r\nimport tippy from 'tippy.js';\r\nimport 'tippy.js/dist/tippy.css';\r\nimport { MentionCombobox } from './mention-combobox';\r\n\r\nexport interface CommentEditorProps {\r\n  content?: string;\r\n  onChange?: (content: string, contentText: string) => void;\r\n  placeholder?: string;\r\n  mentions?: Array<{ id: string; label: string; avatar?: string }>;\r\n  onImageUpload?: (file: File) => Promise<string>; // Custom uploader\r\n  disabled?: boolean;\r\n  className?: string;\r\n  minHeight?: string;\r\n  onSubmit?: () => void; // Enter to submit\r\n  maxImageSize?: number; // Max image size in bytes (default 5MB)\r\n}\r\n\r\nexport function CommentEditor({\r\n  content = '',\r\n  onChange,\r\n  placeholder = 'Viết bình luận...',\r\n  mentions = [],\r\n  onImageUpload,\r\n  disabled = false,\r\n  className,\r\n  minHeight = '80px',\r\n  onSubmit,\r\n  maxImageSize = 5 * 1024 * 1024, // 5MB default\r\n}: CommentEditorProps) {\r\n  const fileInputRef = React.useRef<HTMLInputElement>(null);\r\n  const [isUploading, setIsUploading] = React.useState(false);\r\n  const [isDragging, setIsDragging] = React.useState(false);\r\n  const dragCounterRef = React.useRef(0);\r\n\r\n  // Default uploader - direct to comments folder\r\n  const defaultUploader = React.useCallback(async (file: File): Promise<string> => {\r\n    const asset = await FileUploadAPI.uploadCommentImage(file);\r\n    return asset.url;\r\n  }, []);\r\n\r\n  // Use custom uploader or default\r\n  const uploadImage = onImageUpload || defaultUploader;\r\n\r\n  // Validate and upload image\r\n  const handleImageFile = React.useCallback(async (file: File, source: 'select' | 'paste' | 'drop') => {\r\n    if (!file.type.startsWith('image/')) {\r\n      toast.error('Chỉ chấp nhận file ảnh');\r\n      return;\r\n    }\r\n\r\n    if (file.size > maxImageSize) {\r\n      const maxMB = Math.round(maxImageSize / 1024 / 1024);\r\n      toast.error('Ảnh quá lớn', { description: `Kích thước tối đa ${maxMB}MB` });\r\n      return;\r\n    }\r\n\r\n    setIsUploading(true);\r\n    try {\r\n      const url = await uploadImage(file);\r\n      editor?.chain().focus().setImage({ src: url }).run();\r\n      toast.success(source === 'paste' ? 'Đã dán ảnh' : source === 'drop' ? 'Đã thả ảnh' : 'Đã thêm ảnh');\r\n    } catch (error) {\r\n      console.error('Upload failed:', error);\r\n      toast.error('Không thể tải ảnh lên');\r\n    } finally {\r\n      setIsUploading(false);\r\n    }\r\n  }, [uploadImage, maxImageSize]);\r\n\r\n  const editor = useEditor({\r\n    immediatelyRender: false, // Fix SSR hydration mismatch\r\n    extensions: [\r\n      StarterKit,\r\n      Image.configure({\r\n        inline: true,\r\n        allowBase64: false, // No base64!\r\n      }),\r\n      Placeholder.configure({\r\n        placeholder,\r\n      }),\r\n      Mention.configure({\r\n        HTMLAttributes: {\r\n          class: 'mention',\r\n        },\r\n        suggestion: {\r\n          items: ({ query }) => {\r\n            return mentions.filter(item => \r\n              item.label.toLowerCase().includes(query.toLowerCase())\r\n            );\r\n          },\r\n          render: () => {\r\n            let component: any;\r\n            let popup: any;\r\n\r\n            return {\r\n              onStart: (props: any) => {\r\n                component = new MentionCombobox(props);\r\n                popup = tippy('body', {\r\n                  getReferenceClientRect: props.clientRect,\r\n                  appendTo: () => document.body,\r\n                  content: component.element,\r\n                  showOnCreate: true,\r\n                  interactive: true,\r\n                  trigger: 'manual',\r\n                  placement: 'bottom-start',\r\n                  theme: 'mention',\r\n                  maxWidth: 'none',\r\n                });\r\n              },\r\n              onUpdate(props: any) {\r\n                component.updateProps(props);\r\n                popup[0].setProps({\r\n                  getReferenceClientRect: props.clientRect,\r\n                });\r\n              },\r\n              onKeyDown(props: any) {\r\n                if (props.event.key === 'Escape') {\r\n                  popup[0].hide();\r\n                  return true;\r\n                }\r\n                return component.onKeyDown(props);\r\n              },\r\n              onExit() {\r\n                popup[0].destroy();\r\n                component.destroy();\r\n              },\r\n            };\r\n          },\r\n        },\r\n      }),\r\n    ],\r\n    content,\r\n    editable: !disabled,\r\n    onUpdate: ({ editor }) => {\r\n      const html = editor.getHTML();\r\n      const text = editor.getText();\r\n      onChange?.(html, text);\r\n    },\r\n    editorProps: {\r\n      handleKeyDown: (view, event) => {\r\n        // Enter to submit (without Shift)\r\n        if (event.key === 'Enter' && !event.shiftKey && onSubmit) {\r\n          event.preventDefault();\r\n          onSubmit();\r\n          return true;\r\n        }\r\n        return false;\r\n      },\r\n    },\r\n  });\r\n\r\n  // Handle image upload from file input\r\n  const handleImageSelect = async (e: React.ChangeEvent<HTMLInputElement>) => {\r\n    const file = e.target.files?.[0];\r\n    if (file) {\r\n      await handleImageFile(file, 'select');\r\n    }\r\n    if (fileInputRef.current) {\r\n      fileInputRef.current.value = '';\r\n    }\r\n  };\r\n\r\n  // Handle paste image\r\n  React.useEffect(() => {\r\n    if (!editor) return;\r\n\r\n    const handlePaste = async (event: ClipboardEvent) => {\r\n      const items = event.clipboardData?.items;\r\n      if (!items) return;\r\n\r\n      for (const item of Array.from(items)) {\r\n        if (item.type.startsWith('image/')) {\r\n          event.preventDefault();\r\n          const file = item.getAsFile();\r\n          if (file) {\r\n            await handleImageFile(file, 'paste');\r\n          }\r\n          break;\r\n        }\r\n      }\r\n    };\r\n\r\n    const editorElement = editor.view.dom;\r\n    editorElement.addEventListener('paste', handlePaste as any);\r\n    return () => {\r\n      editorElement.removeEventListener('paste', handlePaste as any);\r\n    };\r\n  }, [editor, handleImageFile]);\r\n\r\n  // Handle drag & drop\r\n  const handleDragEnter = React.useCallback((e: React.DragEvent) => {\r\n    e.preventDefault();\r\n    e.stopPropagation();\r\n    dragCounterRef.current++;\r\n    if (e.dataTransfer?.types.includes('Files')) {\r\n      setIsDragging(true);\r\n    }\r\n  }, []);\r\n\r\n  const handleDragLeave = React.useCallback((e: React.DragEvent) => {\r\n    e.preventDefault();\r\n    e.stopPropagation();\r\n    dragCounterRef.current--;\r\n    if (dragCounterRef.current === 0) {\r\n      setIsDragging(false);\r\n    }\r\n  }, []);\r\n\r\n  const handleDragOver = React.useCallback((e: React.DragEvent) => {\r\n    e.preventDefault();\r\n    e.stopPropagation();\r\n  }, []);\r\n\r\n  const handleDrop = React.useCallback(async (e: React.DragEvent) => {\r\n    e.preventDefault();\r\n    e.stopPropagation();\r\n    setIsDragging(false);\r\n    dragCounterRef.current = 0;\r\n\r\n    const files = Array.from(e.dataTransfer?.files || []);\r\n    const imageFile = files.find(f => f.type.startsWith('image/'));\r\n    \r\n    if (imageFile) {\r\n      await handleImageFile(imageFile, 'drop');\r\n    }\r\n  }, [handleImageFile]);\r\n\r\n  // Sync content prop with editor state\r\n  React.useEffect(() => {\r\n    if (!editor) return;\r\n    const currentContent = editor.getHTML();\r\n    if (content !== currentContent) {\r\n      editor.commands.setContent(content);\r\n    }\r\n  }, [editor, content]);\r\n\r\n  if (!editor) {\r\n    return null;\r\n  }\r\n\r\n  return (\r\n    <div \r\n      className={cn(\r\n        'border border-border rounded-lg bg-background relative',\r\n        isDragging && 'ring-2 ring-primary border-primary',\r\n        className\r\n      )}\r\n      onDragEnter={handleDragEnter}\r\n      onDragLeave={handleDragLeave}\r\n      onDragOver={handleDragOver}\r\n      onDrop={handleDrop}\r\n    >\r\n      {/* Drag overlay */}\r\n      {isDragging && (\r\n        <div className=\"absolute inset-0 z-10 bg-primary/10 flex items-center justify-center rounded-lg pointer-events-none\">\r\n          <div className=\"flex flex-col items-center gap-2 text-primary\">\r\n            <Upload className=\"h-6 w-6\" />\r\n            <span className=\"text-sm font-medium\">Thả ảnh vào đây</span>\r\n          </div>\r\n        </div>\r\n      )}\r\n      \r\n      {/* Toolbar - Compact */}\r\n      <div className=\"flex items-center gap-0.5 p-1.5 border-b border-border bg-muted/30\">\r\n        <Button\r\n          type=\"button\"\r\n          variant=\"ghost\"\r\n          size=\"sm\"\r\n          onClick={() => editor.chain().focus().toggleBold().run()}\r\n          className={cn('h-7 w-7 p-0', editor.isActive('bold') && 'bg-muted')}\r\n          disabled={disabled}\r\n          title=\"Bold\"\r\n        >\r\n          <Bold className=\"h-3.5 w-3.5\" />\r\n        </Button>\r\n        <Button\r\n          type=\"button\"\r\n          variant=\"ghost\"\r\n          size=\"sm\"\r\n          onClick={() => editor.chain().focus().toggleItalic().run()}\r\n          className={cn('h-7 w-7 p-0', editor.isActive('italic') && 'bg-muted')}\r\n          disabled={disabled}\r\n          title=\"Italic\"\r\n        >\r\n          <Italic className=\"h-3.5 w-3.5\" />\r\n        </Button>\r\n        <div className=\"w-px h-5 bg-border mx-0.5\" />\r\n        <Button\r\n          type=\"button\"\r\n          variant=\"ghost\"\r\n          size=\"sm\"\r\n          onClick={() => fileInputRef.current?.click()}\r\n          className=\"h-7 w-7 p-0\"\r\n          disabled={disabled || isUploading}\r\n          title=\"Thêm ảnh\"\r\n        >\r\n          {isUploading ? (\r\n            <Loader2 className=\"h-3.5 w-3.5 animate-spin\" />\r\n          ) : (\r\n            <ImageIcon className=\"h-3.5 w-3.5\" />\r\n          )}\r\n        </Button>\r\n        <Button\r\n          type=\"button\"\r\n          variant=\"ghost\"\r\n          size=\"sm\"\r\n          onClick={() => editor.chain().focus().insertContent('@').run()}\r\n          className=\"h-7 w-7 p-0\"\r\n          disabled={disabled}\r\n          title=\"Tag người (@)\"\r\n        >\r\n          <AtSign className=\"h-3.5 w-3.5\" />\r\n        </Button>\r\n        <input\r\n          ref={fileInputRef}\r\n          type=\"file\"\r\n          accept=\"image/*\"\r\n          onChange={handleImageSelect}\r\n          className=\"hidden\"\r\n        />\r\n      </div>\r\n\r\n      {/* Editor Content */}\r\n      <div\r\n        onClick={() => editor?.commands.focus()}\r\n        className=\"cursor-text\"\r\n        style={{ minHeight }}\r\n      >\r\n        <EditorContent\r\n          editor={editor}\r\n          className={cn('prose prose-sm max-w-none p-2', disabled && 'opacity-50')}\r\n        />\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 3786, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/components/Comments.tsx"],"sourcesContent":["import * as React from 'react';\r\nimport { Card, CardHeader, CardTitle, CardContent } from './ui/card';\r\nimport { Button } from './ui/button';\r\nimport { Textarea } from './ui/textarea';\r\nimport { CommentEditor } from './ui/comment-editor';\r\nimport { Avatar, AvatarFallback, AvatarImage } from './ui/avatar';\r\nimport { Badge } from './ui/badge';\r\nimport { MessageSquare, Reply, Edit2, Trash2, Send, FileText } from 'lucide-react';\r\nimport { cn } from '../lib/utils';\r\nimport { formatDistanceToNow } from 'date-fns';\r\nimport { vi } from 'date-fns/locale';\r\n\r\nexport interface Comment<AuthorId extends string = string, CommentId extends string = string> {\r\n  id: CommentId;\r\n  content: string;\r\n  author: {\r\n    systemId: AuthorId;\r\n    name: string;\r\n    avatar?: string | undefined;\r\n  };\r\n  createdAt: Date | string;\r\n  updatedAt?: Date | string | undefined;\r\n  parentId?: CommentId | undefined; // For replies\r\n  attachments?: (\r\n    {\r\n      id: string;\r\n      name: string;\r\n      url: string;\r\n      type: string;\r\n    }[] | string[]\r\n  ) | undefined;\r\n}\r\n\r\ninterface CommentsProps<\r\n  EntityId extends string = string,\r\n  AuthorId extends string = string,\r\n  CommentId extends string = string\r\n> {\r\n  entityType: string;\r\n  entityId: EntityId;\r\n  comments: Comment<AuthorId, CommentId>[];\r\n  onAddComment?: (content: string, parentIdOrAttachments?: CommentId | string[], parentId?: CommentId) => void;\r\n  onUpdateComment?: (commentId: CommentId, content: string) => void;\r\n  onDeleteComment?: (commentId: CommentId) => void;\r\n  readOnly?: boolean;\r\n  currentUser?: {\r\n    systemId: AuthorId;\r\n    name: string;\r\n    avatar?: string;\r\n  } | undefined;\r\n  title?: string;\r\n  placeholder?: string;\r\n  className?: string;\r\n  // Local storage for draft comments\r\n  enableDraftSaving?: boolean;\r\n  // Mentionable users for @tag functionality\r\n  mentions?: Array<{ id: string; label: string; avatar?: string }>;\r\n}\r\n\r\n/**\r\n * Generic Comments Component\r\n * \r\n * Dùng chung cho: Warranty, Orders, Complaints, Projects...\r\n * \r\n * Features:\r\n * - Add/edit/delete comments\r\n * - Threaded replies (parent-child)\r\n * - Draft saving (in-memory, per session)\r\n * - Rich text display\r\n * - Attachments support\r\n * - Relative timestamps\r\n * - User avatars\r\n * \r\n * Usage:\r\n * ```tsx\r\n * <Comments\r\n *   entityType=\"warranty\"\r\n *   entityId={ticket.systemId}\r\n *   comments={ticket.comments}\r\n *   onAddComment={(content, parentId) => addComment(content, parentId)}\r\n *   onUpdateComment={(id, content) => updateComment(id, content)}\r\n *   onDeleteComment={(id) => deleteComment(id)}\r\n *   currentUser={currentUser}\r\n * />\r\n * ```\r\n */\r\nexport function Comments<\r\n  EntityId extends string = string,\r\n  AuthorId extends string = string,\r\n  CommentId extends string = string\r\n>({\r\n  entityType,\r\n  entityId,\r\n  comments = [],\r\n  onAddComment,\r\n  onUpdateComment,\r\n  onDeleteComment,\r\n  readOnly = false,\r\n  currentUser,\r\n  title = 'Bình luận',\r\n  placeholder = 'Nhập bình luận...',\r\n  className,\r\n  enableDraftSaving = true,\r\n  mentions = [],\r\n}: CommentsProps<EntityId, AuthorId, CommentId>) {\r\n  const [newComment, setNewComment] = React.useState('');\r\n  const [newCommentText, setNewCommentText] = React.useState(''); // Plain text version\r\n  const [editingId, setEditingId] = React.useState<CommentId | null>(null);\r\n  const [editContent, setEditContent] = React.useState('');\r\n  const [replyingTo, setReplyingTo] = React.useState<CommentId | null>(null);\r\n  const [replyContent, setReplyContent] = React.useState('');\r\n\r\n  // Draft key for reference (no longer uses localStorage)\r\n  // Drafts are now kept in-memory only for the current session\r\n  // This is intentional - drafts don't need to persist across browser sessions\r\n\r\n  // Organize comments into tree structure\r\n  const commentTree = React.useMemo(() => {\r\n    const topLevel = comments.filter((c) => !c.parentId);\r\n    const childrenMap = new Map<CommentId, Comment<AuthorId, CommentId>[]>();\r\n\r\n    comments.forEach((comment) => {\r\n      if (!comment.parentId) {\r\n        return;\r\n      }\r\n      const siblings = childrenMap.get(comment.parentId) || [];\r\n      siblings.push(comment);\r\n      childrenMap.set(comment.parentId, siblings);\r\n    });\r\n\r\n    return { topLevel, childrenMap };\r\n  }, [comments]);\r\n\r\n  const handleAddComment = () => {\r\n    if (!newCommentText.trim() || !onAddComment) return;\r\n    \r\n    onAddComment(newComment.trim(), undefined, undefined); // Send HTML content\r\n    setNewComment('');\r\n    setNewCommentText('');\r\n    // Draft is cleared automatically when state is reset\r\n  };\r\n\r\n  const handleAddReply = (parentId: CommentId) => {\r\n    if (!replyContent.trim() || !onAddComment) return;\r\n    \r\n    onAddComment(replyContent.trim(), undefined, parentId);\r\n    setReplyContent('');\r\n    setReplyingTo(null);\r\n  };\r\n\r\n  const handleUpdateComment = (commentId: CommentId) => {\r\n    if (!editContent.trim() || !onUpdateComment) return;\r\n    \r\n    onUpdateComment(commentId, editContent.trim());\r\n    setEditingId(null);\r\n    setEditContent('');\r\n  };\r\n\r\n  const handleDeleteComment = (commentId: CommentId) => {\r\n    if (!onDeleteComment) return;\r\n    \r\n    if (confirm('Bạn có chắc muốn xóa bình luận này?')) {\r\n      onDeleteComment(commentId);\r\n    }\r\n  };\r\n\r\n  const startEdit = (comment: Comment<AuthorId, CommentId>) => {\r\n    setEditingId(comment.id);\r\n    setEditContent(comment.content);\r\n  };\r\n\r\n  const cancelEdit = () => {\r\n    setEditingId(null);\r\n    setEditContent('');\r\n  };\r\n\r\n  const startReply = (commentId: CommentId) => {\r\n    setReplyingTo(commentId);\r\n    setReplyContent('');\r\n  };\r\n\r\n  const cancelReply = () => {\r\n    setReplyingTo(null);\r\n    setReplyContent('');\r\n  };\r\n\r\n  const renderComment = (comment: Comment<AuthorId, CommentId>, depth: number = 0) => {\r\n    const isEditing = editingId === comment.id;\r\n    const isReplying = replyingTo === comment.id;\r\n    const isOwn = currentUser?.systemId === comment.author.systemId;\r\n    const children = commentTree.childrenMap.get(comment.id) || [];\r\n    const createdAtDate = new Date(comment.createdAt);\r\n    const updatedAtDate = comment.updatedAt ? new Date(comment.updatedAt) : null;\r\n\r\n    return (\r\n      <div key={comment.id} className={cn(\"space-y-2\", depth > 0 && \"ml-12\")}>\r\n        <div className=\"flex gap-3\">\r\n          {/* Avatar */}\r\n          <Avatar className=\"h-8 w-8 flex-shrink-0\">\r\n            <AvatarImage src={comment.author.avatar} />\r\n            <AvatarFallback>{comment.author.name.charAt(0)}</AvatarFallback>\r\n          </Avatar>\r\n\r\n          <div className=\"flex-1 min-w-0 space-y-1\">\r\n            {/* Header */}\r\n            <div className=\"flex items-center gap-2 flex-wrap\">\r\n              <span className=\"font-medium text-sm\">{comment.author.name}</span>\r\n              <span className=\"text-xs text-muted-foreground\">\r\n                {formatDistanceToNow(createdAtDate, {\r\n                  addSuffix: true,\r\n                  locale: vi,\r\n                })}\r\n              </span>\r\n              {updatedAtDate && updatedAtDate.getTime() > createdAtDate.getTime() && (\r\n                <Badge variant=\"outline\" className=\"text-xs\">Đã chỉnh sửa</Badge>\r\n              )}\r\n            </div>\r\n\r\n            {/* Content */}\r\n            {isEditing ? (\r\n              <div className=\"space-y-2\">\r\n                <Textarea\r\n                  value={editContent}\r\n                  onChange={(e) => setEditContent(e.target.value)}\r\n                  onKeyDown={(e) => {\r\n                    if (e.key === 'Enter' && !e.shiftKey) {\r\n                      e.preventDefault();\r\n                      if (editContent.trim()) {\r\n                        handleUpdateComment(comment.id);\r\n                      }\r\n                    } else if (e.key === 'Escape') {\r\n                      cancelEdit();\r\n                    }\r\n                  }}\r\n                  className=\"min-h-[80px]\"\r\n                  autoFocus\r\n                />\r\n                <div className=\"flex gap-2\">\r\n                  <Button size=\"sm\" onClick={() => handleUpdateComment(comment.id)}>\r\n                    Lưu\r\n                  </Button>\r\n                  <Button size=\"sm\" variant=\"outline\" onClick={cancelEdit}>\r\n                    Hủy\r\n                  </Button>\r\n                </div>\r\n              </div>\r\n            ) : (\r\n              <>\r\n                <div \r\n                  className=\"text-sm bg-muted/30 p-3 rounded-md prose prose-sm max-w-none [&_.mention]:text-primary [&_.mention]:font-medium\"\r\n                  dangerouslySetInnerHTML={{ __html: comment.content }}\r\n                />\r\n\r\n                {/* Attachments */}\r\n                {comment.attachments && comment.attachments.length > 0 && (\r\n                  <div className=\"flex flex-wrap gap-2 mt-2\">\r\n                    {comment.attachments.map((file) => (\r\n                      <a\r\n                        key={file.id}\r\n                        href={file.url}\r\n                        target=\"_blank\"\r\n                        rel=\"noopener noreferrer\"\r\n                        className=\"flex items-center gap-2 px-3 py-1.5 bg-muted rounded-md hover:bg-muted/80 transition-colors text-sm\"\r\n                      >\r\n                        <FileText className=\"h-4 w-4\" />\r\n                        {file.name}\r\n                      </a>\r\n                    ))}\r\n                  </div>\r\n                )}\r\n\r\n                {/* Actions - Only reply allowed, no edit/delete to preserve data */}\r\n                {!readOnly && (\r\n                  <div className=\"flex items-center gap-2 text-xs\">\r\n                    {onAddComment && (\r\n                      <Button\r\n                        variant=\"ghost\"\r\n                        size=\"sm\"\r\n                        onClick={() => startReply(comment.id)}\r\n                        className=\"h-7 px-2\"\r\n                      >\r\n                        <Reply className=\"h-3 w-3 mr-1\" />\r\n                        Trả lời\r\n                      </Button>\r\n                    )}\r\n                  </div>\r\n                )}\r\n              </>\r\n            )}\r\n\r\n            {/* Reply form */}\r\n            {isReplying && (\r\n              <div className=\"space-y-2 pt-2\">\r\n                <Textarea\r\n                  value={replyContent}\r\n                  onChange={(e) => setReplyContent(e.target.value)}\r\n                  onKeyDown={(e) => {\r\n                    if (e.key === 'Enter' && !e.shiftKey) {\r\n                      e.preventDefault();\r\n                      if (replyContent.trim()) {\r\n                        handleAddReply(comment.id);\r\n                      }\r\n                    } else if (e.key === 'Escape') {\r\n                      cancelReply();\r\n                    }\r\n                  }}\r\n                  placeholder={`Trả lời ${comment.author.name}...`}\r\n                  className=\"min-h-[80px]\"\r\n                  autoFocus\r\n                />\r\n                <div className=\"flex gap-2\">\r\n                  <Button size=\"sm\" onClick={() => handleAddReply(comment.id)}>\r\n                    <Send className=\"h-4 w-4 mr-2\" />\r\n                    Gửi\r\n                  </Button>\r\n                  <Button size=\"sm\" variant=\"outline\" onClick={cancelReply}>\r\n                    Hủy\r\n                  </Button>\r\n                </div>\r\n              </div>\r\n            )}\r\n          </div>\r\n        </div>\r\n\r\n        {/* Render replies */}\r\n        {children.length > 0 && (\r\n          <div className=\"space-y-2\">\r\n            {children.map(child => renderComment(child, depth + 1))}\r\n          </div>\r\n        )}\r\n      </div>\r\n    );\r\n  };\r\n\r\n  return (\r\n    <Card className={className}>\r\n      <CardHeader>\r\n        <CardTitle className=\"text-h5 flex items-center gap-2\">\r\n          <MessageSquare className=\"h-4 w-4\" />\r\n          {title}\r\n          <Badge variant=\"secondary\" className=\"ml-auto\">\r\n            {comments.length}\r\n          </Badge>\r\n        </CardTitle>\r\n      </CardHeader>\r\n\r\n      <CardContent className=\"space-y-4\">\r\n        {/* Add new comment */}\r\n        {!readOnly && onAddComment && (\r\n          <div className=\"space-y-2\">\r\n            <CommentEditor\r\n              content={newComment}\r\n              onChange={(html, text) => {\r\n                setNewComment(html);\r\n                setNewCommentText(text);\r\n              }}\r\n              placeholder={placeholder}\r\n              mentions={mentions}\r\n              onSubmit={handleAddComment}\r\n              minHeight=\"80px\"\r\n            />\r\n            <Button onClick={handleAddComment} disabled={!newCommentText.trim()}>\r\n              <Send className=\"h-4 w-4 mr-2\" />\r\n              Gửi bình luận\r\n            </Button>\r\n          </div>\r\n        )}\r\n\r\n        {/* Comments list */}\r\n        {commentTree.topLevel.length === 0 ? (\r\n          <div className=\"text-sm text-muted-foreground text-center py-8\">\r\n            Chưa có bình luận nào\r\n          </div>\r\n        ) : (\r\n          <div className=\"space-y-4\">\r\n            {commentTree.topLevel.map(comment => renderComment(comment))}\r\n          </div>\r\n        )}\r\n      </CardContent>\r\n    </Card>\r\n  );\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 4308, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/components/DatabaseComments.tsx"],"sourcesContent":["/**\r\n * Database-backed Comments Component\r\n * Wrapper cho Comments component, lưu vào database\r\n */\r\n\r\n'use client'\r\n\r\nimport * as React from 'react'\r\nimport { Comments, type Comment as CommentType } from './Comments'\r\nimport { useAuth } from '@/contexts/auth-context'\r\nimport { asSystemId, type SystemId } from '@/lib/id-types'\r\n\r\ninterface DatabaseCommentsProps {\r\n  entityType: string  // e.g., 'supplier', 'stock_transfer', 'leave'\r\n  entityId: string    // ID of the entity\r\n  className?: string\r\n}\r\n\r\nconst API_BASE = '/api/comments'\r\n\r\n/**\r\n * Comments component với database backend\r\n * Data được lưu trực tiếp vào PostgreSQL qua API\r\n */\r\nexport function DatabaseComments({ entityType, entityId, className }: DatabaseCommentsProps) {\r\n  const { user, employee } = useAuth()\r\n  const [comments, setComments] = React.useState<CommentType<SystemId>[]>([])\r\n  const [isLoading, setIsLoading] = React.useState(true)\r\n\r\n  // Load comments from database\r\n  React.useEffect(() => {\r\n    const loadComments = async () => {\r\n      try {\r\n        // Load from database API\r\n        const res = await fetch(\r\n          `${API_BASE}?entityType=${encodeURIComponent(entityType)}&entityId=${encodeURIComponent(entityId)}`\r\n        )\r\n        \r\n        if (res.ok) {\r\n          const data = await res.json()\r\n          \r\n          if (data && data.length > 0) {\r\n            // Transform API data to component format\r\n            const transformed = data.map((c: any) => ({\r\n              id: asSystemId(c.systemId),\r\n              content: c.content,\r\n              author: {\r\n                systemId: asSystemId(c.createdBy || 'system'),\r\n                name: c.createdByName || 'Hệ thống',\r\n              },\r\n              createdAt: c.createdAt,\r\n              updatedAt: c.updatedAt,\r\n              attachments: c.attachments || [],\r\n            }))\r\n            setComments(transformed)\r\n          }\r\n        }\r\n      } catch (error) {\r\n        console.error(`Error loading comments for ${entityType}/${entityId}:`, error)\r\n      } finally {\r\n        setIsLoading(false)\r\n      }\r\n    }\r\n\r\n    if (entityId) {\r\n      loadComments()\r\n    }\r\n  }, [entityType, entityId])\r\n\r\n  // Add comment\r\n  const handleAddComment = React.useCallback(async (\r\n    content: string,\r\n    attachments?: string[],\r\n    parentId?: string\r\n  ) => {\r\n    const tempId = asSystemId(`temp-${Date.now()}`)\r\n    const newComment: CommentType<SystemId> = {\r\n      id: tempId,\r\n      content,\r\n      author: {\r\n        systemId: employee?.systemId ? asSystemId(employee.systemId) : asSystemId('system'),\r\n        name: employee?.fullName || user?.fullName || 'Hệ thống',\r\n        avatar: employee?.avatar,\r\n      },\r\n      createdAt: new Date().toISOString(),\r\n      attachments,\r\n      parentId: parentId as SystemId | undefined,\r\n    }\r\n\r\n    // Optimistic update\r\n    setComments(prev => [...prev, newComment])\r\n\r\n    // Save to database\r\n    try {\r\n      const res = await fetch(API_BASE, {\r\n        method: 'POST',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({\r\n          entityType,\r\n          entityId,\r\n          content,\r\n          attachments: attachments || [],\r\n          createdBy: user?.systemId || employee?.systemId,\r\n          createdByName: employee?.fullName || user?.fullName,\r\n        }),\r\n      })\r\n\r\n      if (res.ok) {\r\n        const saved = await res.json()\r\n        // Update with real ID\r\n        setComments(prev => prev.map(c => \r\n          c.id === tempId \r\n            ? { ...c, id: asSystemId(saved.systemId) }\r\n            : c\r\n        ))\r\n      }\r\n    } catch (error) {\r\n      console.error('Error saving comment:', error)\r\n    }\r\n  }, [entityType, entityId, user, employee])\r\n\r\n  // Update comment\r\n  const handleUpdateComment = React.useCallback((commentId: string, content: string) => {\r\n    setComments(prev => prev.map(c => \r\n      c.id === commentId \r\n        ? { ...c, content, updatedAt: new Date().toISOString() } \r\n        : c\r\n    ))\r\n    // Note: API update not implemented yet\r\n  }, [])\r\n\r\n  // Delete comment\r\n  const handleDeleteComment = React.useCallback(async (commentId: string) => {\r\n    // Optimistic delete\r\n    setComments(prev => prev.filter(c => c.id !== commentId))\r\n\r\n    // Delete from database\r\n    try {\r\n      await fetch(`${API_BASE}?systemId=${encodeURIComponent(commentId)}`, {\r\n        method: 'DELETE',\r\n      })\r\n    } catch (error) {\r\n      console.error('Error deleting comment:', error)\r\n    }\r\n  }, [])\r\n\r\n  if (isLoading) {\r\n    return <div className=\"p-4 text-muted-foreground\">Đang tải bình luận...</div>\r\n  }\r\n\r\n  return (\r\n    <Comments\r\n      comments={comments}\r\n      onAddComment={handleAddComment}\r\n      onUpdateComment={handleUpdateComment}\r\n      onDeleteComment={handleDeleteComment}\r\n      entityType={entityType}\r\n      entityId={entityId}\r\n      className={className}\r\n    />\r\n  )\r\n}\r\n\r\n/**\r\n * Migrate localStorage comments to database\r\n */\r\nasync function migrateComments(\r\n  entityType: string,\r\n  entityId: string,\r\n  comments: CommentType<SystemId>[]\r\n): Promise<void> {\r\n  try {\r\n    for (const comment of comments) {\r\n      await fetch(API_BASE, {\r\n        method: 'POST',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({\r\n          entityType,\r\n          entityId,\r\n          content: comment.content,\r\n          attachments: comment.attachments || [],\r\n          createdBy: comment.author?.systemId,\r\n          createdByName: comment.author?.name,\r\n        }),\r\n      })\r\n    }\r\n    console.log(`[Migration] Successfully migrated ${comments.length} comments to database`)\r\n  } catch (error) {\r\n    console.error(`[Migration] Failed to migrate comments:`, error)\r\n  }\r\n}\r\n\r\nexport default DatabaseComments\r\n"],"names":[],"mappings":";;;;;;;AAOA;AACA;AACA;AACA;;;AAVA;;;CAGC,GAED;;;;;AAaA,MAAM,WAAW;AAMV,SAAS,iBAAiB,EAAE,UAAU,EAAE,QAAQ,EAAE,SAAS,EAAyB;;IACzF,MAAM,EAAE,IAAI,EAAE,QAAQ,EAAE,GAAG,IAAA,0IAAO;IAClC,MAAM,CAAC,UAAU,YAAY,GAAG,yKAAc,CAA0B,EAAE;IAC1E,MAAM,CAAC,WAAW,aAAa,GAAG,yKAAc,CAAC;IAEjD,8BAA8B;IAC9B,0KAAe;sCAAC;YACd,MAAM;2DAAe;oBACnB,IAAI;wBACF,yBAAyB;wBACzB,MAAM,MAAM,MAAM,MAChB,GAAG,SAAS,YAAY,EAAE,mBAAmB,YAAY,UAAU,EAAE,mBAAmB,WAAW;wBAGrG,IAAI,IAAI,EAAE,EAAE;4BACV,MAAM,OAAO,MAAM,IAAI,IAAI;4BAE3B,IAAI,QAAQ,KAAK,MAAM,GAAG,GAAG;gCAC3B,yCAAyC;gCACzC,MAAM,cAAc,KAAK,GAAG;2FAAC,CAAC,IAAW,CAAC;4CACxC,IAAI,IAAA,mIAAU,EAAC,EAAE,QAAQ;4CACzB,SAAS,EAAE,OAAO;4CAClB,QAAQ;gDACN,UAAU,IAAA,mIAAU,EAAC,EAAE,SAAS,IAAI;gDACpC,MAAM,EAAE,aAAa,IAAI;4CAC3B;4CACA,WAAW,EAAE,SAAS;4CACtB,WAAW,EAAE,SAAS;4CACtB,aAAa,EAAE,WAAW,IAAI,EAAE;wCAClC,CAAC;;gCACD,YAAY;4BACd;wBACF;oBACF,EAAE,OAAO,OAAO;wBACd,QAAQ,KAAK,CAAC,CAAC,2BAA2B,EAAE,WAAW,CAAC,EAAE,SAAS,CAAC,CAAC,EAAE;oBACzE,SAAU;wBACR,aAAa;oBACf;gBACF;;YAEA,IAAI,UAAU;gBACZ;YACF;QACF;qCAAG;QAAC;QAAY;KAAS;IAEzB,cAAc;IACd,MAAM,mBAAmB,4KAAiB;0DAAC,OACzC,SACA,aACA;YAEA,MAAM,SAAS,IAAA,mIAAU,EAAC,CAAC,KAAK,EAAE,KAAK,GAAG,IAAI;YAC9C,MAAM,aAAoC;gBACxC,IAAI;gBACJ;gBACA,QAAQ;oBACN,UAAU,UAAU,WAAW,IAAA,mIAAU,EAAC,SAAS,QAAQ,IAAI,IAAA,mIAAU,EAAC;oBAC1E,MAAM,UAAU,YAAY,MAAM,YAAY;oBAC9C,QAAQ,UAAU;gBACpB;gBACA,WAAW,IAAI,OAAO,WAAW;gBACjC;gBACA,UAAU;YACZ;YAEA,oBAAoB;YACpB;kEAAY,CAAA,OAAQ;2BAAI;wBAAM;qBAAW;;YAEzC,mBAAmB;YACnB,IAAI;gBACF,MAAM,MAAM,MAAM,MAAM,UAAU;oBAChC,QAAQ;oBACR,SAAS;wBAAE,gBAAgB;oBAAmB;oBAC9C,MAAM,KAAK,SAAS,CAAC;wBACnB;wBACA;wBACA;wBACA,aAAa,eAAe,EAAE;wBAC9B,WAAW,MAAM,YAAY,UAAU;wBACvC,eAAe,UAAU,YAAY,MAAM;oBAC7C;gBACF;gBAEA,IAAI,IAAI,EAAE,EAAE;oBACV,MAAM,QAAQ,MAAM,IAAI,IAAI;oBAC5B,sBAAsB;oBACtB;0EAAY,CAAA,OAAQ,KAAK,GAAG;kFAAC,CAAA,IAC3B,EAAE,EAAE,KAAK,SACL;wCAAE,GAAG,CAAC;wCAAE,IAAI,IAAA,mIAAU,EAAC,MAAM,QAAQ;oCAAE,IACvC;;;gBAER;YACF,EAAE,OAAO,OAAO;gBACd,QAAQ,KAAK,CAAC,yBAAyB;YACzC;QACF;yDAAG;QAAC;QAAY;QAAU;QAAM;KAAS;IAEzC,iBAAiB;IACjB,MAAM,sBAAsB,4KAAiB;6DAAC,CAAC,WAAmB;YAChE;qEAAY,CAAA,OAAQ,KAAK,GAAG;6EAAC,CAAA,IAC3B,EAAE,EAAE,KAAK,YACL;gCAAE,GAAG,CAAC;gCAAE;gCAAS,WAAW,IAAI,OAAO,WAAW;4BAAG,IACrD;;;QAEN,uCAAuC;QACzC;4DAAG,EAAE;IAEL,iBAAiB;IACjB,MAAM,sBAAsB,4KAAiB;6DAAC,OAAO;YACnD,oBAAoB;YACpB;qEAAY,CAAA,OAAQ,KAAK,MAAM;6EAAC,CAAA,IAAK,EAAE,EAAE,KAAK;;;YAE9C,uBAAuB;YACvB,IAAI;gBACF,MAAM,MAAM,GAAG,SAAS,UAAU,EAAE,mBAAmB,YAAY,EAAE;oBACnE,QAAQ;gBACV;YACF,EAAE,OAAO,OAAO;gBACd,QAAQ,KAAK,CAAC,2BAA2B;YAC3C;QACF;4DAAG,EAAE;IAEL,IAAI,WAAW;QACb,qBAAO,6LAAC;YAAI,WAAU;sBAA4B;;;;;;IACpD;IAEA,qBACE,6LAAC,sIAAQ;QACP,UAAU;QACV,cAAc;QACd,iBAAiB;QACjB,iBAAiB;QACjB,YAAY;QACZ,UAAU;QACV,WAAW;;;;;;AAGjB;GAzIgB;;QACa,0IAAO;;;KADpB;AA2IhB;;CAEC,GACD,eAAe,gBACb,UAAkB,EAClB,QAAgB,EAChB,QAAiC;IAEjC,IAAI;QACF,KAAK,MAAM,WAAW,SAAU;YAC9B,MAAM,MAAM,UAAU;gBACpB,QAAQ;gBACR,SAAS;oBAAE,gBAAgB;gBAAmB;gBAC9C,MAAM,KAAK,SAAS,CAAC;oBACnB;oBACA;oBACA,SAAS,QAAQ,OAAO;oBACxB,aAAa,QAAQ,WAAW,IAAI,EAAE;oBACtC,WAAW,QAAQ,MAAM,EAAE;oBAC3B,eAAe,QAAQ,MAAM,EAAE;gBACjC;YACF;QACF;QACA,QAAQ,GAAG,CAAC,CAAC,kCAAkC,EAAE,SAAS,MAAM,CAAC,qBAAqB,CAAC;IACzF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,CAAC,uCAAuC,CAAC,EAAE;IAC3D;AACF;uCAEe"}},
    {"offset": {"line": 4538, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/components/ui/select.tsx"],"sourcesContent":["import * as React from \"react\"\r\nimport * as SelectPrimitive from \"@radix-ui/react-select\"\r\nimport { Check, ChevronDown, ChevronUp } from \"lucide-react\"\r\n\r\nimport { cn } from \"../../lib/utils\"\r\nimport { useModal } from \"../../contexts/modal-context\"\r\n\r\ntype BaseSelectProps = React.ComponentPropsWithoutRef<typeof SelectPrimitive.Root>\r\n\r\ntype SelectProps = Omit<BaseSelectProps, \"value\" | \"defaultValue\"> & {\r\n  value?: string | undefined\r\n  defaultValue?: string | undefined\r\n}\r\n\r\nconst Select = ({ value, defaultValue, ...props }: SelectProps) => {\r\n  const controlledProps: Partial<BaseSelectProps> = {}\r\n\r\n  if (value !== undefined) {\r\n    controlledProps.value = value\r\n  }\r\n\r\n  if (defaultValue !== undefined) {\r\n    controlledProps.defaultValue = defaultValue\r\n  }\r\n\r\n  return <SelectPrimitive.Root {...props} {...controlledProps} />\r\n}\r\nSelect.displayName = SelectPrimitive.Root.displayName\r\n\r\nconst SelectGroup = SelectPrimitive.Group\r\n\r\nconst SelectValue = SelectPrimitive.Value\r\n\r\nconst SelectTrigger = React.forwardRef<\r\n  React.ElementRef<typeof SelectPrimitive.Trigger>,\r\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Trigger>\r\n>(({ className, children, ...props }, ref) => (\r\n  <SelectPrimitive.Trigger\r\n    ref={ref}\r\n    className={cn(\r\n      \"flex h-9 w-full items-center justify-between rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background data-[placeholder]:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 [&>span]:line-clamp-1\",\r\n      className\r\n    )}\r\n    {...props}\r\n  >\r\n    {children}\r\n    <SelectPrimitive.Icon asChild>\r\n      <ChevronDown className=\"h-4 w-4 opacity-50\" />\r\n    </SelectPrimitive.Icon>\r\n  </SelectPrimitive.Trigger>\r\n))\r\nSelectTrigger.displayName = SelectPrimitive.Trigger.displayName\r\n\r\nconst SelectScrollUpButton = React.forwardRef<\r\n  React.ElementRef<typeof SelectPrimitive.ScrollUpButton>,\r\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollUpButton>\r\n>(({ className, ...props }, ref) => (\r\n  <SelectPrimitive.ScrollUpButton\r\n    ref={ref}\r\n    className={cn(\r\n      \"flex cursor-default items-center justify-center py-1\",\r\n      className\r\n    )}\r\n    {...props}\r\n  >\r\n    <ChevronUp className=\"h-4 w-4\" />\r\n  </SelectPrimitive.ScrollUpButton>\r\n))\r\nSelectScrollUpButton.displayName = SelectPrimitive.ScrollUpButton.displayName\r\n\r\nconst SelectScrollDownButton = React.forwardRef<\r\n  React.ElementRef<typeof SelectPrimitive.ScrollDownButton>,\r\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollDownButton>\r\n>(({ className, ...props }, ref) => (\r\n  <SelectPrimitive.ScrollDownButton\r\n    ref={ref}\r\n    className={cn(\r\n      \"flex cursor-default items-center justify-center py-1\",\r\n      className\r\n    )}\r\n    {...props}\r\n  >\r\n    <ChevronDown className=\"h-4 w-4\" />\r\n  </SelectPrimitive.ScrollDownButton>\r\n))\r\nSelectScrollDownButton.displayName =\r\n  SelectPrimitive.ScrollDownButton.displayName\r\n\r\nconst SelectContent = React.forwardRef<\r\n  React.ElementRef<typeof SelectPrimitive.Content>,\r\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Content>\r\n>(({ className, children, position = \"popper\", ...props }, ref) => {\r\n  const modalId = React.useId();\r\n  const [isOpen, setIsOpen] = React.useState(false);\r\n  const { zIndex } = useModal(modalId, isOpen, 'select');\r\n\r\n  React.useEffect(() => {\r\n    const content = ref && 'current' in ref ? ref.current : null;\r\n    if (!content) return;\r\n\r\n    const observer = new MutationObserver((mutations) => {\r\n      mutations.forEach((mutation) => {\r\n        if (mutation.type === 'attributes' && mutation.attributeName === 'data-state') {\r\n          const target = mutation.target as HTMLElement;\r\n          const state = target.getAttribute('data-state');\r\n          setIsOpen(state === 'open');\r\n        }\r\n      });\r\n    });\r\n\r\n    observer.observe(content, { attributes: true, attributeFilter: ['data-state'] });\r\n\r\n    return () => observer.disconnect();\r\n  }, [ref]);\r\n\r\n  return (\r\n    <SelectPrimitive.Portal>\r\n      <SelectPrimitive.Content\r\n        ref={ref}\r\n        className={cn(\r\n          \"relative max-h-[--radix-select-content-available-height] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border border-border bg-popover text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-select-content-transform-origin]\",\r\n          position === \"popper\" &&\r\n            \"data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1\",\r\n          className\r\n        )}\r\n        style={{ zIndex }}\r\n        position={position}\r\n        {...props}\r\n      >\r\n        <SelectScrollUpButton />\r\n        <SelectPrimitive.Viewport\r\n          className={cn(\r\n            \"p-1\",\r\n            position === \"popper\" &&\r\n              \"h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)]\"\r\n          )}\r\n        >\r\n          {children}\r\n        </SelectPrimitive.Viewport>\r\n        <SelectScrollDownButton />\r\n      </SelectPrimitive.Content>\r\n    </SelectPrimitive.Portal>\r\n  );\r\n})\r\nSelectContent.displayName = SelectPrimitive.Content.displayName\r\n\r\nconst SelectLabel = React.forwardRef<\r\n  React.ElementRef<typeof SelectPrimitive.Label>,\r\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Label>\r\n>(({ className, ...props }, ref) => (\r\n  <SelectPrimitive.Label\r\n    ref={ref}\r\n    className={cn(\"py-1.5 pl-8 pr-2 text-sm font-semibold\", className)}\r\n    {...props}\r\n  />\r\n))\r\nSelectLabel.displayName = SelectPrimitive.Label.displayName\r\n\r\nconst SelectItem = React.forwardRef<\r\n  React.ElementRef<typeof SelectPrimitive.Item>,\r\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Item>\r\n>(({ className, children, ...props }, ref) => (\r\n  <SelectPrimitive.Item\r\n    ref={ref}\r\n    className={cn(\r\n      \"relative flex w-full cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\r\n      className\r\n    )}\r\n    {...props}\r\n  >\r\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\r\n      <SelectPrimitive.ItemIndicator>\r\n        <Check className=\"h-4 w-4\" />\r\n      </SelectPrimitive.ItemIndicator>\r\n    </span>\r\n\r\n    <SelectPrimitive.ItemText>{children}</SelectPrimitive.ItemText>\r\n  </SelectPrimitive.Item>\r\n))\r\nSelectItem.displayName = SelectPrimitive.Item.displayName\r\n\r\nconst SelectSeparator = React.forwardRef<\r\n  React.ElementRef<typeof SelectPrimitive.Separator>,\r\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Separator>\r\n>(({ className, ...props }, ref) => (\r\n  <SelectPrimitive.Separator\r\n    ref={ref}\r\n    className={cn(\"-mx-1 my-1 h-px bg-muted\", className)}\r\n    {...props}\r\n  />\r\n))\r\nSelectSeparator.displayName = SelectPrimitive.Separator.displayName\r\n\r\nexport {\r\n  Select,\r\n  SelectGroup,\r\n  SelectValue,\r\n  SelectTrigger,\r\n  SelectContent,\r\n  SelectLabel,\r\n  SelectItem,\r\n  SelectSeparator,\r\n  SelectScrollUpButton,\r\n  SelectScrollDownButton,\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 4829, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/components/ActivityHistory.tsx"],"sourcesContent":["import * as React from 'react';\r\nimport { Card, CardHeader, CardTitle, CardContent } from './ui/card';\r\nimport { Badge } from './ui/badge';\r\nimport { Avatar, AvatarFallback, AvatarImage } from './ui/avatar';\r\nimport { Input } from './ui/input';\r\nimport {\r\n  Select,\r\n  SelectContent,\r\n  SelectItem,\r\n  SelectTrigger,\r\n  SelectValue,\r\n} from './ui/select';\r\nimport {\r\n  History,\r\n  Plus,\r\n  Edit,\r\n  Trash2,\r\n  CheckCircle2,\r\n  XCircle,\r\n  Clock,\r\n  User,\r\n  Package,\r\n  DollarSign,\r\n  FileText,\r\n  AlertCircle,\r\n  ArrowRight,\r\n  Filter,\r\n} from 'lucide-react';\r\nimport { cn } from '../lib/utils';\r\nimport { formatDistanceToNow } from 'date-fns';\r\nimport { vi } from 'date-fns/locale';\r\nimport { formatDateForDisplay, formatDateTimeForDisplay } from '@/lib/date-utils';\r\n\r\nexport interface HistoryEntry {\r\n  id: string;\r\n  action:\r\n    | 'created'\r\n    | 'updated'\r\n    | 'deleted'\r\n    | 'status_changed'\r\n    | 'assigned'\r\n    | 'product_added'\r\n    | 'product_updated'\r\n    | 'product_removed'\r\n    | 'payment_made'\r\n    | 'comment_added'\r\n    | 'attachment_added'\r\n    // Complaint-specific actions\r\n    | 'verified'\r\n    | 'verified-correct'\r\n    | 'verified-incorrect'\r\n    | 'investigated'\r\n    | 'resolved'\r\n    | 'rejected'\r\n    | 'cancelled'\r\n    | 'ended'\r\n    | 'reopened'\r\n    | 'commented'\r\n    | 'custom';\r\n  timestamp: Date;\r\n  user: {\r\n    systemId: string;\r\n    name: string;\r\n    avatar?: string | undefined;\r\n  };\r\n  description: string;\r\n  content?: React.ReactNode;\r\n  metadata?: {\r\n    oldValue?: any;\r\n    newValue?: any;\r\n    field?: string | undefined;\r\n    [key: string]: any;\r\n  } | undefined;\r\n}\r\n\r\ninterface ActivityHistoryProps {\r\n  history: HistoryEntry[];\r\n  title?: string;\r\n  emptyMessage?: string;\r\n  className?: string;\r\n  // Filter options\r\n  showFilters?: boolean;\r\n  filterableActions?: string[];\r\n  filterableUsers?: { systemId: string; name: string }[];\r\n  // Display options\r\n  showUser?: boolean;\r\n  showTimestamp?: boolean;\r\n  showMetadata?: boolean;\r\n  groupByDate?: boolean;\r\n  maxHeight?: string;\r\n}\r\n\r\n/**\r\n * Generic Activity History Component\r\n * \r\n * Dùng chung cho: Warranty, Orders, Complaints, Projects...\r\n * \r\n * Features:\r\n * - Display timeline of actions\r\n * - Filter by action type, user, date range\r\n * - Group by date\r\n * - Show old/new values for updates\r\n * - User avatars\r\n * - Relative timestamps\r\n * - Scrollable with max height\r\n * \r\n * Usage:\r\n * ```tsx\r\n * <ActivityHistory\r\n *   history={ticket.history}\r\n *   showFilters\r\n *   groupByDate\r\n *   filterableActions={['created', 'status_changed', 'updated']}\r\n *   title=\"Lịch sử thao tác\"\r\n * />\r\n * ```\r\n */\r\nexport function ActivityHistory({\r\n  history = [],\r\n  title = 'Lịch sử thao tác',\r\n  emptyMessage = 'Chưa có lịch sử nào',\r\n  className,\r\n  showFilters = true,\r\n  filterableActions,\r\n  filterableUsers,\r\n  showUser = true,\r\n  showTimestamp = true,\r\n  showMetadata = true,\r\n  groupByDate = false,\r\n  maxHeight = '600px',\r\n}: ActivityHistoryProps) {\r\n  const [filterAction, setFilterAction] = React.useState<string>('all');\r\n  const [filterUser, setFilterUser] = React.useState<string>('all');\r\n  const [searchQuery, setSearchQuery] = React.useState('');\r\n\r\n  // Filter history\r\n  const filteredHistory = React.useMemo(() => {\r\n    let filtered = [...history];\r\n\r\n    // Filter by action\r\n    if (filterAction !== 'all') {\r\n      filtered = filtered.filter(h => h.action === filterAction);\r\n    }\r\n\r\n    // Filter by user\r\n    if (filterUser !== 'all') {\r\n      filtered = filtered.filter(h => h.user.systemId === filterUser);\r\n    }\r\n\r\n    // Search in description\r\n    if (searchQuery) {\r\n      filtered = filtered.filter(h =>\r\n        h.description.toLowerCase().includes(searchQuery.toLowerCase())\r\n      );\r\n    }\r\n\r\n    // Sort by timestamp (newest first)\r\n    filtered.sort((a, b) => new Date(b.timestamp).getTime() - new Date(a.timestamp).getTime());\r\n\r\n    return filtered;\r\n  }, [history, filterAction, filterUser, searchQuery]);\r\n\r\n  // Group by date if enabled\r\n  const groupedHistory = React.useMemo(() => {\r\n    if (!groupByDate) return null;\r\n\r\n    const groups = new Map<string, HistoryEntry[]>();\r\n    \r\n    filteredHistory.forEach(entry => {\r\n      const date = formatDateForDisplay(entry.timestamp);\r\n      const group = groups.get(date) || [];\r\n      group.push(entry);\r\n      groups.set(date, group);\r\n    });\r\n\r\n    return groups;\r\n  }, [filteredHistory, groupByDate]);\r\n\r\n  // Get action icon and color\r\n  const getActionStyle = (action: string) => {\r\n    const styles: Record<string, { icon: any; color: string; bgColor: string }> = {\r\n      created: { icon: Plus, color: 'text-green-600', bgColor: 'bg-green-100' },\r\n      updated: { icon: Edit, color: 'text-blue-600', bgColor: 'bg-blue-100' },\r\n      deleted: { icon: Trash2, color: 'text-red-600', bgColor: 'bg-red-100' },\r\n      status_changed: { icon: CheckCircle2, color: 'text-purple-600', bgColor: 'bg-purple-100' },\r\n      assigned: { icon: User, color: 'text-orange-600', bgColor: 'bg-orange-100' },\r\n      product_added: { icon: Package, color: 'text-teal-600', bgColor: 'bg-teal-100' },\r\n      product_updated: { icon: Package, color: 'text-blue-600', bgColor: 'bg-blue-100' },\r\n      product_removed: { icon: Package, color: 'text-red-600', bgColor: 'bg-red-100' },\r\n      payment_made: { icon: DollarSign, color: 'text-green-600', bgColor: 'bg-green-100' },\r\n      comment_added: { icon: FileText, color: 'text-gray-600', bgColor: 'bg-gray-100' },\r\n      attachment_added: { icon: FileText, color: 'text-indigo-600', bgColor: 'bg-indigo-100' },\r\n      \r\n      // Complaint-specific actions\r\n      verified: { icon: CheckCircle2, color: 'text-blue-600', bgColor: 'bg-blue-100' },\r\n      'verified-correct': { icon: CheckCircle2, color: 'text-green-600', bgColor: 'bg-green-100' },\r\n      'verified-incorrect': { icon: XCircle, color: 'text-red-600', bgColor: 'bg-red-100' },\r\n      investigated: { icon: AlertCircle, color: 'text-blue-600', bgColor: 'bg-blue-100' },\r\n      resolved: { icon: CheckCircle2, color: 'text-green-600', bgColor: 'bg-green-100' },\r\n      rejected: { icon: XCircle, color: 'text-red-600', bgColor: 'bg-red-100' },\r\n      cancelled: { icon: XCircle, color: 'text-red-600', bgColor: 'bg-red-100' },\r\n      ended: { icon: CheckCircle2, color: 'text-green-600', bgColor: 'bg-green-100' },\r\n      reopened: { icon: History, color: 'text-purple-600', bgColor: 'bg-purple-100' },\r\n      commented: { icon: FileText, color: 'text-gray-600', bgColor: 'bg-gray-100' },\r\n      \r\n      custom: { icon: AlertCircle, color: 'text-gray-600', bgColor: 'bg-gray-100' },\r\n    };\r\n\r\n    return styles[action] || styles.custom;\r\n  };\r\n\r\n  const renderHistoryEntry = (entry: HistoryEntry, showDate: boolean = false) => {\r\n    const style = getActionStyle(entry.action);\r\n    const Icon = style.icon;\r\n\r\n    return (\r\n      <div key={entry.id} className=\"flex gap-3 pb-4 last:pb-0\">\r\n        {/* Icon */}\r\n        <div className={cn('flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center', style.bgColor)}>\r\n          <Icon className={cn('h-4 w-4', style.color)} />\r\n        </div>\r\n\r\n        {/* Content */}\r\n        <div className=\"flex-1 min-w-0 space-y-1\">\r\n          {/* Description */}\r\n          <div className=\"text-sm\">{entry.content ?? entry.description}</div>\r\n\r\n          {/* Metadata - Note (e.g. reopen reason) */}\r\n          {showMetadata && entry.metadata?.note && (\r\n            <div className=\"text-sm text-muted-foreground italic border-l-2 border-muted pl-3 mt-1\">\r\n              {entry.metadata.note}\r\n            </div>\r\n          )}\r\n\r\n          {/* Metadata - old/new values */}\r\n          {showMetadata && entry.metadata && (entry.metadata.oldValue || entry.metadata.newValue) && (\r\n            <div className=\"flex items-center gap-2 text-xs text-muted-foreground\">\r\n              {entry.metadata.oldValue && (\r\n                <span className=\"px-2 py-0.5 bg-red-100 text-red-700 rounded\">\r\n                  {String(entry.metadata.oldValue)}\r\n                </span>\r\n              )}\r\n              {entry.metadata.oldValue && entry.metadata.newValue && (\r\n                <ArrowRight className=\"h-3 w-3\" />\r\n              )}\r\n              {entry.metadata.newValue && (\r\n                <span className=\"px-2 py-0.5 bg-green-100 text-green-700 rounded\">\r\n                  {String(entry.metadata.newValue)}\r\n                </span>\r\n              )}\r\n            </div>\r\n          )}\r\n\r\n          {/* User & Timestamp */}\r\n          <div className=\"flex items-center gap-2 text-xs text-muted-foreground flex-wrap\">\r\n            {showUser && (\r\n              <>\r\n                <Avatar className=\"h-5 w-5\">\r\n                  <AvatarImage src={entry.user.avatar} />\r\n                  <AvatarFallback className=\"text-[10px]\">\r\n                    {entry.user.name.charAt(0)}\r\n                  </AvatarFallback>\r\n                </Avatar>\r\n                <span className=\"font-medium\">{entry.user.name}</span>\r\n              </>\r\n            )}\r\n\r\n            {showTimestamp && (\r\n              <>\r\n                <Clock className=\"h-3 w-3\" />\r\n                <span>\r\n                  {formatDistanceToNow(new Date(entry.timestamp), {\r\n                    addSuffix: true,\r\n                    locale: vi,\r\n                  })}\r\n                </span>\r\n                {showDate && (\r\n                  <span className=\"text-[10px]\">\r\n                    ({formatDateTimeForDisplay(entry.timestamp)})\r\n                  </span>\r\n                )}\r\n              </>\r\n            )}\r\n          </div>\r\n        </div>\r\n      </div>\r\n    );\r\n  };\r\n\r\n  return (\r\n    <Card className={className}>\r\n      <CardHeader>\r\n        <div className=\"flex items-center justify-between gap-2\">\r\n          <CardTitle className=\"text-h5 flex items-center gap-2\">\r\n            <History className=\"h-4 w-4\" />\r\n            {title}\r\n          </CardTitle>\r\n          <Badge variant=\"secondary\">{filteredHistory.length}</Badge>\r\n        </div>\r\n\r\n        {/* Filters */}\r\n        {showFilters && (\r\n          <div className=\"grid grid-cols-1 md:grid-cols-3 gap-2 mt-4\">\r\n            {/* Search */}\r\n            <Input\r\n              placeholder=\"Tìm kiếm...\"\r\n              value={searchQuery}\r\n              onChange={(e) => setSearchQuery(e.target.value)}\r\n              className=\"h-9\"\r\n            />\r\n\r\n            {/* Filter by action */}\r\n            {filterableActions && (\r\n              <Select value={filterAction} onValueChange={setFilterAction}>\r\n                <SelectTrigger className=\"h-9\">\r\n                  <Filter className=\"h-4 w-4 mr-2\" />\r\n                  <SelectValue placeholder=\"Loại hành động\" />\r\n                </SelectTrigger>\r\n                <SelectContent>\r\n                  <SelectItem value=\"all\">Tất cả hành động</SelectItem>\r\n                  {filterableActions.map(action => (\r\n                    <SelectItem key={action} value={action}>\r\n                      {action.replace(/_/g, ' ')}\r\n                    </SelectItem>\r\n                  ))}\r\n                </SelectContent>\r\n              </Select>\r\n            )}\r\n\r\n            {/* Filter by user */}\r\n            {filterableUsers && (\r\n              <Select value={filterUser} onValueChange={setFilterUser}>\r\n                <SelectTrigger className=\"h-9\">\r\n                  <User className=\"h-4 w-4 mr-2\" />\r\n                  <SelectValue placeholder=\"Người thực hiện\" />\r\n                </SelectTrigger>\r\n                <SelectContent>\r\n                  <SelectItem value=\"all\">Tất cả</SelectItem>\r\n                  {filterableUsers.map(user => (\r\n                    <SelectItem key={user.systemId} value={user.systemId}>\r\n                      {user.name}\r\n                    </SelectItem>\r\n                  ))}\r\n                </SelectContent>\r\n              </Select>\r\n            )}\r\n          </div>\r\n        )}\r\n      </CardHeader>\r\n\r\n      <CardContent>\r\n        {filteredHistory.length === 0 ? (\r\n          <div className=\"text-sm text-muted-foreground text-center py-8\">\r\n            {emptyMessage}\r\n          </div>\r\n        ) : (\r\n          <div\r\n            className=\"space-y-0 overflow-y-auto pr-2\"\r\n            style={{ maxHeight }}\r\n          >\r\n            {groupByDate && groupedHistory ? (\r\n              // Grouped by date\r\n              Array.from(groupedHistory.entries()).map(([date, entries]) => (\r\n                <div key={date} className=\"mb-6 last:mb-0\">\r\n                  <div className=\"sticky top-0 bg-background z-10 pb-2 mb-2\">\r\n                    <Badge variant=\"outline\" className=\"text-xs\">\r\n                      {date}\r\n                    </Badge>\r\n                  </div>\r\n                  <div className=\"space-y-0 relative before:absolute before:left-4 before:top-2 before:bottom-2 before:w-px before:bg-border\">\r\n                    {entries.map(entry => renderHistoryEntry(entry, true))}\r\n                  </div>\r\n                </div>\r\n              ))\r\n            ) : (\r\n              // Flat list with timeline\r\n              <div className=\"relative before:absolute before:left-4 before:top-2 before:bottom-2 before:w-px before:bg-border\">\r\n                {filteredHistory.map(entry => renderHistoryEntry(entry, true))}\r\n              </div>\r\n            )}\r\n          </div>\r\n        )}\r\n      </CardContent>\r\n    </Card>\r\n  );\r\n}\r\n"],"names":[],"mappings":";;;;;AAAA;AACA;AACA;AACA;AACA;AACA;AAOA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAgBA;AACA;AACA;AACA;;;;;;;;;;;;;;AAsFO,SAAS,gBAAgB,EAC9B,UAAU,EAAE,EACZ,QAAQ,kBAAkB,EAC1B,eAAe,qBAAqB,EACpC,SAAS,EACT,cAAc,IAAI,EAClB,iBAAiB,EACjB,eAAe,EACf,WAAW,IAAI,EACf,gBAAgB,IAAI,EACpB,eAAe,IAAI,EACnB,cAAc,KAAK,EACnB,YAAY,OAAO,EACE;;IACrB,MAAM,CAAC,cAAc,gBAAgB,GAAG,yKAAc,CAAS;IAC/D,MAAM,CAAC,YAAY,cAAc,GAAG,yKAAc,CAAS;IAC3D,MAAM,CAAC,aAAa,eAAe,GAAG,yKAAc,CAAC;IAErD,iBAAiB;IACjB,MAAM,kBAAkB,wKAAa;oDAAC;YACpC,IAAI,WAAW;mBAAI;aAAQ;YAE3B,mBAAmB;YACnB,IAAI,iBAAiB,OAAO;gBAC1B,WAAW,SAAS,MAAM;gEAAC,CAAA,IAAK,EAAE,MAAM,KAAK;;YAC/C;YAEA,iBAAiB;YACjB,IAAI,eAAe,OAAO;gBACxB,WAAW,SAAS,MAAM;gEAAC,CAAA,IAAK,EAAE,IAAI,CAAC,QAAQ,KAAK;;YACtD;YAEA,wBAAwB;YACxB,IAAI,aAAa;gBACf,WAAW,SAAS,MAAM;gEAAC,CAAA,IACzB,EAAE,WAAW,CAAC,WAAW,GAAG,QAAQ,CAAC,YAAY,WAAW;;YAEhE;YAEA,mCAAmC;YACnC,SAAS,IAAI;4DAAC,CAAC,GAAG,IAAM,IAAI,KAAK,EAAE,SAAS,EAAE,OAAO,KAAK,IAAI,KAAK,EAAE,SAAS,EAAE,OAAO;;YAEvF,OAAO;QACT;mDAAG;QAAC;QAAS;QAAc;QAAY;KAAY;IAEnD,2BAA2B;IAC3B,MAAM,iBAAiB,wKAAa;mDAAC;YACnC,IAAI,CAAC,aAAa,OAAO;YAEzB,MAAM,SAAS,IAAI;YAEnB,gBAAgB,OAAO;2DAAC,CAAA;oBACtB,MAAM,OAAO,IAAA,+IAAoB,EAAC,MAAM,SAAS;oBACjD,MAAM,QAAQ,OAAO,GAAG,CAAC,SAAS,EAAE;oBACpC,MAAM,IAAI,CAAC;oBACX,OAAO,GAAG,CAAC,MAAM;gBACnB;;YAEA,OAAO;QACT;kDAAG;QAAC;QAAiB;KAAY;IAEjC,4BAA4B;IAC5B,MAAM,iBAAiB,CAAC;QACtB,MAAM,SAAwE;YAC5E,SAAS;gBAAE,MAAM,6MAAI;gBAAE,OAAO;gBAAkB,SAAS;YAAe;YACxE,SAAS;gBAAE,MAAM,sNAAI;gBAAE,OAAO;gBAAiB,SAAS;YAAc;YACtE,SAAS;gBAAE,MAAM,uNAAM;gBAAE,OAAO;gBAAgB,SAAS;YAAa;YACtE,gBAAgB;gBAAE,MAAM,wOAAY;gBAAE,OAAO;gBAAmB,SAAS;YAAgB;YACzF,UAAU;gBAAE,MAAM,6MAAI;gBAAE,OAAO;gBAAmB,SAAS;YAAgB;YAC3E,eAAe;gBAAE,MAAM,sNAAO;gBAAE,OAAO;gBAAiB,SAAS;YAAc;YAC/E,iBAAiB;gBAAE,MAAM,sNAAO;gBAAE,OAAO;gBAAiB,SAAS;YAAc;YACjF,iBAAiB;gBAAE,MAAM,sNAAO;gBAAE,OAAO;gBAAgB,SAAS;YAAa;YAC/E,cAAc;gBAAE,MAAM,mOAAU;gBAAE,OAAO;gBAAkB,SAAS;YAAe;YACnF,eAAe;gBAAE,MAAM,6NAAQ;gBAAE,OAAO;gBAAiB,SAAS;YAAc;YAChF,kBAAkB;gBAAE,MAAM,6NAAQ;gBAAE,OAAO;gBAAmB,SAAS;YAAgB;YAEvF,6BAA6B;YAC7B,UAAU;gBAAE,MAAM,wOAAY;gBAAE,OAAO;gBAAiB,SAAS;YAAc;YAC/E,oBAAoB;gBAAE,MAAM,wOAAY;gBAAE,OAAO;gBAAkB,SAAS;YAAe;YAC3F,sBAAsB;gBAAE,MAAM,0NAAO;gBAAE,OAAO;gBAAgB,SAAS;YAAa;YACpF,cAAc;gBAAE,MAAM,sOAAW;gBAAE,OAAO;gBAAiB,SAAS;YAAc;YAClF,UAAU;gBAAE,MAAM,wOAAY;gBAAE,OAAO;gBAAkB,SAAS;YAAe;YACjF,UAAU;gBAAE,MAAM,0NAAO;gBAAE,OAAO;gBAAgB,SAAS;YAAa;YACxE,WAAW;gBAAE,MAAM,0NAAO;gBAAE,OAAO;gBAAgB,SAAS;YAAa;YACzE,OAAO;gBAAE,MAAM,wOAAY;gBAAE,OAAO;gBAAkB,SAAS;YAAe;YAC9E,UAAU;gBAAE,MAAM,sNAAO;gBAAE,OAAO;gBAAmB,SAAS;YAAgB;YAC9E,WAAW;gBAAE,MAAM,6NAAQ;gBAAE,OAAO;gBAAiB,SAAS;YAAc;YAE5E,QAAQ;gBAAE,MAAM,sOAAW;gBAAE,OAAO;gBAAiB,SAAS;YAAc;QAC9E;QAEA,OAAO,MAAM,CAAC,OAAO,IAAI,OAAO,MAAM;IACxC;IAEA,MAAM,qBAAqB,CAAC,OAAqB,WAAoB,KAAK;QACxE,MAAM,QAAQ,eAAe,MAAM,MAAM;QACzC,MAAM,OAAO,MAAM,IAAI;QAEvB,qBACE,6LAAC;YAAmB,WAAU;;8BAE5B,6LAAC;oBAAI,WAAW,IAAA,qHAAE,EAAC,uEAAuE,MAAM,OAAO;8BACrG,cAAA,6LAAC;wBAAK,WAAW,IAAA,qHAAE,EAAC,WAAW,MAAM,KAAK;;;;;;;;;;;8BAI5C,6LAAC;oBAAI,WAAU;;sCAEb,6LAAC;4BAAI,WAAU;sCAAW,MAAM,OAAO,IAAI,MAAM,WAAW;;;;;;wBAG3D,gBAAgB,MAAM,QAAQ,EAAE,sBAC/B,6LAAC;4BAAI,WAAU;sCACZ,MAAM,QAAQ,CAAC,IAAI;;;;;;wBAKvB,gBAAgB,MAAM,QAAQ,IAAI,CAAC,MAAM,QAAQ,CAAC,QAAQ,IAAI,MAAM,QAAQ,CAAC,QAAQ,mBACpF,6LAAC;4BAAI,WAAU;;gCACZ,MAAM,QAAQ,CAAC,QAAQ,kBACtB,6LAAC;oCAAK,WAAU;8CACb,OAAO,MAAM,QAAQ,CAAC,QAAQ;;;;;;gCAGlC,MAAM,QAAQ,CAAC,QAAQ,IAAI,MAAM,QAAQ,CAAC,QAAQ,kBACjD,6LAAC,mOAAU;oCAAC,WAAU;;;;;;gCAEvB,MAAM,QAAQ,CAAC,QAAQ,kBACtB,6LAAC;oCAAK,WAAU;8CACb,OAAO,MAAM,QAAQ,CAAC,QAAQ;;;;;;;;;;;;sCAOvC,6LAAC;4BAAI,WAAU;;gCACZ,0BACC;;sDACE,6LAAC,wIAAM;4CAAC,WAAU;;8DAChB,6LAAC,6IAAW;oDAAC,KAAK,MAAM,IAAI,CAAC,MAAM;;;;;;8DACnC,6LAAC,gJAAc;oDAAC,WAAU;8DACvB,MAAM,IAAI,CAAC,IAAI,CAAC,MAAM,CAAC;;;;;;;;;;;;sDAG5B,6LAAC;4CAAK,WAAU;sDAAe,MAAM,IAAI,CAAC,IAAI;;;;;;;;gCAIjD,+BACC;;sDACE,6LAAC,gNAAK;4CAAC,WAAU;;;;;;sDACjB,6LAAC;sDACE,IAAA,4KAAmB,EAAC,IAAI,KAAK,MAAM,SAAS,GAAG;gDAC9C,WAAW;gDACX,QAAQ,oJAAE;4CACZ;;;;;;wCAED,0BACC,6LAAC;4CAAK,WAAU;;gDAAc;gDAC1B,IAAA,mJAAwB,EAAC,MAAM,SAAS;gDAAE;;;;;;;;;;;;;;;;;;;;;;WA9DhD,MAAM,EAAE;;;;;IAuEtB;IAEA,qBACE,6LAAC,oIAAI;QAAC,WAAW;;0BACf,6LAAC,0IAAU;;kCACT,6LAAC;wBAAI,WAAU;;0CACb,6LAAC,yIAAS;gCAAC,WAAU;;kDACnB,6LAAC,sNAAO;wCAAC,WAAU;;;;;;oCAClB;;;;;;;0CAEH,6LAAC,sIAAK;gCAAC,SAAQ;0CAAa,gBAAgB,MAAM;;;;;;;;;;;;oBAInD,6BACC,6LAAC;wBAAI,WAAU;;0CAEb,6LAAC,sIAAK;gCACJ,aAAY;gCACZ,OAAO;gCACP,UAAU,CAAC,IAAM,eAAe,EAAE,MAAM,CAAC,KAAK;gCAC9C,WAAU;;;;;;4BAIX,mCACC,6LAAC,wIAAM;gCAAC,OAAO;gCAAc,eAAe;;kDAC1C,6LAAC,+IAAa;wCAAC,WAAU;;0DACvB,6LAAC,mNAAM;gDAAC,WAAU;;;;;;0DAClB,6LAAC,6IAAW;gDAAC,aAAY;;;;;;;;;;;;kDAE3B,6LAAC,+IAAa;;0DACZ,6LAAC,4IAAU;gDAAC,OAAM;0DAAM;;;;;;4CACvB,kBAAkB,GAAG,CAAC,CAAA,uBACrB,6LAAC,4IAAU;oDAAc,OAAO;8DAC7B,OAAO,OAAO,CAAC,MAAM;mDADP;;;;;;;;;;;;;;;;;4BASxB,iCACC,6LAAC,wIAAM;gCAAC,OAAO;gCAAY,eAAe;;kDACxC,6LAAC,+IAAa;wCAAC,WAAU;;0DACvB,6LAAC,6MAAI;gDAAC,WAAU;;;;;;0DAChB,6LAAC,6IAAW;gDAAC,aAAY;;;;;;;;;;;;kDAE3B,6LAAC,+IAAa;;0DACZ,6LAAC,4IAAU;gDAAC,OAAM;0DAAM;;;;;;4CACvB,gBAAgB,GAAG,CAAC,CAAA,qBACnB,6LAAC,4IAAU;oDAAqB,OAAO,KAAK,QAAQ;8DACjD,KAAK,IAAI;mDADK,KAAK,QAAQ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;0BAW5C,6LAAC,2IAAW;0BACT,gBAAgB,MAAM,KAAK,kBAC1B,6LAAC;oBAAI,WAAU;8BACZ;;;;;yCAGH,6LAAC;oBACC,WAAU;oBACV,OAAO;wBAAE;oBAAU;8BAElB,eAAe,iBACd,kBAAkB;oBAClB,MAAM,IAAI,CAAC,eAAe,OAAO,IAAI,GAAG,CAAC,CAAC,CAAC,MAAM,QAAQ,iBACvD,6LAAC;4BAAe,WAAU;;8CACxB,6LAAC;oCAAI,WAAU;8CACb,cAAA,6LAAC,sIAAK;wCAAC,SAAQ;wCAAU,WAAU;kDAChC;;;;;;;;;;;8CAGL,6LAAC;oCAAI,WAAU;8CACZ,QAAQ,GAAG,CAAC,CAAA,QAAS,mBAAmB,OAAO;;;;;;;2BAP1C;;;;oCAYZ,0BAA0B;kCAC1B,6LAAC;wBAAI,WAAU;kCACZ,gBAAgB,GAAG,CAAC,CAAA,QAAS,mBAAmB,OAAO;;;;;;;;;;;;;;;;;;;;;;AAQxE;GA5QgB;KAAA"}},
    {"offset": {"line": 5471, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/leaves/detail-page.tsx"],"sourcesContent":["'use client'\r\n\r\nimport * as React from 'react';\r\nimport { useParams, useRouter } from 'next/navigation';\r\nimport { formatDate, formatDateTime, formatDateTimeSeconds, formatDateCustom, parseDate, getCurrentDate } from '@/lib/date-utils';\r\nimport { useLeaveStore } from './store';\r\nimport { usePageHeader } from '../../contexts/page-header-context';\r\nimport { asSystemId, type SystemId } from '@/lib/id-types';\r\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from '../../components/ui/card';\r\nimport { Button } from '../../components/ui/button';\r\nimport { Edit } from 'lucide-react';\r\nimport { DetailField } from '../../components/ui/detail-field';\r\nimport { Badge } from '../../components/ui/badge';\r\nimport { DatabaseComments } from '../../components/DatabaseComments';\r\nimport { ActivityHistory, type HistoryEntry } from '../../components/ActivityHistory';\r\nimport { useAuth } from '../../contexts/auth-context';\r\nimport type { LeaveStatus } from './types';\r\n\r\nconst statusVariants: Record<LeaveStatus, \"success\" | \"warning\" | \"destructive\"> = {\r\n    \"Chờ duyệt\": \"warning\",\r\n    \"Đã duyệt\": \"success\",\r\n    \"Đã từ chối\": \"destructive\",\r\n};\r\n\r\nexport function LeaveDetailPage() {\r\n  const params = useParams<{ systemId: string }>();\r\n  const systemId = params?.systemId;\r\n  const router = useRouter();\r\n  const { findById } = useLeaveStore();\r\n  const { employee: authEmployee } = useAuth();\r\n  const request = React.useMemo(() => (systemId ? findById(asSystemId(systemId)) : null), [systemId, findById]);\r\n\r\n\r\n\r\n  const headerActions = React.useMemo(() => {\r\n    if (!request) return [];\r\n    return [\r\n      <Button\r\n        key=\"edit\"\r\n        size=\"sm\"\r\n        className=\"h-9\"\r\n        onClick={() => router.push('/leaves')}\r\n      >\r\n        <Edit className=\"mr-2 h-4 w-4\" />\r\n        Sửa đơn\r\n      </Button>\r\n    ];\r\n  }, [request, router]);\r\n\r\n  const statusBadge = React.useMemo(() => {\r\n    if (!request) return undefined;\r\n    return <Badge variant={statusVariants[request.status]}>{request.status}</Badge>;\r\n  }, [request]);\r\n\r\n  usePageHeader({\r\n    title: request ? `Đơn nghỉ phép ${request.id}` : 'Chi tiết đơn nghỉ phép',\r\n    breadcrumb: [\r\n      { label: 'Trang chủ', href: '/', isCurrent: false },\r\n      { label: 'Nghỉ phép', href: '/leaves', isCurrent: false },\r\n      { label: request?.id || 'Chi tiết', href: '', isCurrent: true }\r\n    ],\r\n    badge: statusBadge,\r\n    actions: headerActions,\r\n  });\r\n\r\n  if (!request) {\r\n    return (\r\n        <div className=\"text-center p-8\">\r\n            <h2 className=\"text-h3 font-bold\">Không tìm thấy đơn nghỉ phép</h2>\r\n            <Button onClick={() => router.push('/leaves')} className=\"mt-4\">Quay về danh sách</Button>\r\n        </div>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <>\r\n    <Card>\r\n      <CardHeader>\r\n        <CardTitle className=\"text-h4\">Thông tin đơn</CardTitle>\r\n        <CardDescription>\r\n          Thời gian nghỉ: {formatDate(request.startDate)} - {formatDate(request.endDate)}\r\n        </CardDescription>\r\n      </CardHeader>\r\n      <CardContent>\r\n          <dl>\r\n            <DetailField label=\"Ngày tạo đơn\" value={formatDate(request.requestDate)} />\r\n            <DetailField label=\"Loại phép\" value={request.leaveTypeName} />\r\n            <DetailField label=\"Thời gian nghỉ\" value={`${formatDate(request.startDate)} - ${formatDate(request.endDate)}`} />\r\n            <DetailField label=\"Số ngày nghỉ\" value={`${request.numberOfDays} ngày`} />\r\n            <DetailField label=\"Lý do\" value={request.reason} />\r\n            <DetailField label=\"Trạng thái\">\r\n                <Badge variant={statusVariants[request.status]}>{request.status}</Badge>\r\n            </DetailField>\r\n          </dl>\r\n      </CardContent>\r\n    </Card>\r\n\r\n    {/* Comments */}\r\n    <DatabaseComments\r\n      entityType=\"leave\"\r\n      entityId={request.systemId}\r\n    />\r\n\r\n    {/* Activity History */}\r\n    <ActivityHistory\r\n      history={request.activityHistory || []}\r\n      title=\"Lịch sử hoạt động\"\r\n      emptyMessage=\"Chưa có lịch sử hoạt động\"\r\n      groupByDate\r\n      maxHeight=\"400px\"\r\n    />\r\n    </>\r\n  );\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 5769, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/app/%28authenticated%29/leaves/%5BsystemId%5D/page.tsx"],"sourcesContent":["\"use client\"\r\nimport { LeaveDetailPage } from '@/features/leaves/detail-page'\r\nexport default LeaveDetailPage\r\n"],"names":[],"mappings":";;;;AACA;AADA;;uCAEe,2JAAe"}}]
}