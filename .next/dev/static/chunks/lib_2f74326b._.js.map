{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/lib/id-utils.ts"],"sourcesContent":["/**\r\n * ID Utilities\r\n * Helpers for generating and validating IDs (systemId & business id)\r\n */\r\n\r\nimport { getPrefix, type EntityType } from './smart-prefix';\r\nimport { ID_CONFIG } from './id-config';\r\n\r\n// Re-export EntityType for convenience\r\nexport type { EntityType } from './smart-prefix';\r\n\r\n/**\r\n * Generate SystemId (6 digits, immutable, internal use only)\r\n * Format: SYSTEMID_PREFIX + 6 digits (e.g., \"EMP000001\", \"CUSTOMER000001\", \"ORDER000001\")\r\n * Uses systemIdPrefix from ID_CONFIG (English full words)\r\n */\r\nexport function generateSystemId(entityType: EntityType, counter: number): string {\r\n  const config = ID_CONFIG[entityType];\r\n  if (!config) {\r\n    throw new Error(`No configuration found for entity type: ${entityType}`);\r\n  }\r\n  const prefix = config.systemIdPrefix;\r\n  const digitCount = config.digitCount || 6;\r\n  return `${prefix}${String(counter).padStart(digitCount, '0')}`;\r\n}\r\n\r\n/**\r\n * Generate Business ID (6 digits, user-facing, editable)\r\n * Format: PREFIX + 6 digits (e.g., \"NV000001\", \"KH000001\", \"CTV000001\")\r\n * All entities use same 6-digit format for consistency\r\n * \r\n * @param entityType - Entity type from smart-prefix\r\n * @param counter - Current counter value\r\n * @param customId - Optional custom ID from user input\r\n * @returns Generated ID or validated custom ID\r\n */\r\nexport function generateBusinessId(\r\n  entityType: EntityType, \r\n  counter: number,\r\n  customId?: string\r\n): string {\r\n  // If user provided custom ID, validate and return it\r\n  if (customId && customId.trim()) {\r\n    const sanitized = sanitizeBusinessId(customId);\r\n    if (!sanitized) {\r\n      throw new Error('Mã không hợp lệ! Chỉ được phép sử dụng chữ cái và số.');\r\n    }\r\n    return sanitized;\r\n  }\r\n  \r\n  // Otherwise, auto-generate\r\n  const prefix = getPrefix(entityType);\r\n  return `${prefix}${String(counter).padStart(6, '0')}`;\r\n}\r\n\r\n/**\r\n * Sanitize business ID\r\n * - Remove special characters (keep only letters and numbers)\r\n * - Convert to uppercase\r\n * - Trim whitespace\r\n * \r\n * @param id - Raw user input\r\n * @returns Sanitized ID or null if invalid\r\n */\r\nexport function sanitizeBusinessId(id: string): string | null {\r\n  if (!id || typeof id !== 'string') return null;\r\n  \r\n  // Remove all special characters, keep only alphanumeric\r\n  const cleaned = id.trim().replace(/[^a-zA-Z0-9]/g, '');\r\n  \r\n  if (!cleaned) return null;\r\n  \r\n  // Convert to uppercase for consistency\r\n  return cleaned.toUpperCase();\r\n}\r\n\r\n/**\r\n * Validate business ID uniqueness (case-insensitive)\r\n * \r\n * @param id - ID to check\r\n * @param existingIds - Array of existing IDs in the system\r\n * @param currentId - Current ID (for edit mode, to exclude self)\r\n * @returns true if unique, false if duplicate\r\n */\r\nexport function isBusinessIdUnique(\r\n  id: string,\r\n  existingIds: string[],\r\n  currentId?: string\r\n): boolean {\r\n  if (!id) return false;\r\n  \r\n  const normalizedId = id.toUpperCase();\r\n  const normalizedCurrentId = currentId?.toUpperCase();\r\n  \r\n  return !existingIds.some(existingId => {\r\n    // ✅ Filter out empty/undefined IDs\r\n    if (!existingId || existingId.trim() === '') return false;\r\n    \r\n    const normalizedExisting = existingId.toUpperCase();\r\n    // Skip self-comparison in edit mode\r\n    if (normalizedCurrentId && normalizedExisting === normalizedCurrentId) {\r\n      return false;\r\n    }\r\n    return normalizedExisting === normalizedId;\r\n  });\r\n}\r\n\r\n/**\r\n * Extract counter from system ID\r\n * Used to initialize counter when loading from localStorage\r\n * Supports both 6, 7 and 8 digits\r\n * \r\n * @param systemId - System ID to parse (e.g., \"EMP000001\", \"CUSTOMER000001\", \"WARRANTY0000001\")\r\n * @param prefix - Expected systemIdPrefix (e.g., \"EMP\", \"CUSTOMER\", \"WARRANTY\")\r\n * @returns Counter value or 0 if invalid\r\n */\r\nexport function extractCounterFromSystemId(systemId: string, prefix: string): number {\r\n  if (!systemId || typeof systemId !== 'string') return 0;\r\n  \r\n  // Try different digit counts (most entities use 6 digits, some use 7-8)\r\n  const regex8 = new RegExp(`^${prefix}(\\\\d{8})$`);\r\n  const regex7 = new RegExp(`^${prefix}(\\\\d{7})$`);\r\n  const regex6 = new RegExp(`^${prefix}(\\\\d{6})$`);\r\n  \r\n  const match8 = systemId.match(regex8);\r\n  if (match8) return parseInt(match8[1], 10);\r\n  \r\n  const match7 = systemId.match(regex7);\r\n  if (match7) return parseInt(match7[1], 10);\r\n  \r\n  const match6 = systemId.match(regex6);\r\n  if (match6) return parseInt(match6[1], 10);\r\n  \r\n  return 0;\r\n}\r\n\r\n/**\r\n * Extract counter from business ID\r\n * Used to initialize counter when loading from localStorage\r\n * \r\n * @param businessId - Business ID to parse (e.g., \"NV000001\")\r\n * @param prefix - Expected prefix (e.g., \"NV\")\r\n * @returns Counter value or 0 if invalid\r\n */\r\nexport function extractCounterFromBusinessId(businessId: string, prefix: string): number {\r\n  if (!businessId || typeof businessId !== 'string') return 0;\r\n  const regex = new RegExp(`^${prefix}(\\\\d+)$`);\r\n  const match = businessId.match(regex);\r\n  return match ? parseInt(match[1], 10) : 0;\r\n}\r\n\r\n/**\r\n * Get max counter from array of items (for systemId)\r\n * \r\n * @param items - Array of items with systemId\r\n * @param prefix - Prefix to match\r\n * @returns Maximum counter value\r\n */\r\nexport function getMaxSystemIdCounter<T extends { systemId: string }>(\r\n  items: T[],\r\n  prefix: string\r\n): number {\r\n  if (!items || !Array.isArray(items)) return 0;\r\n  \r\n  let maxCounter = 0;\r\n  \r\n  items.forEach(item => {\r\n    if (!item || !item.systemId) return;\r\n    const counter = extractCounterFromSystemId(item.systemId, prefix);\r\n    if (counter > maxCounter) {\r\n      maxCounter = counter;\r\n    }\r\n  });\r\n  \r\n  return maxCounter;\r\n}\r\n\r\n/**\r\n * Get max counter from array of items (for business id)\r\n * Only counts auto-generated IDs (PREFIX + digits)\r\n * \r\n * @param items - Array of items with id\r\n * @param prefix - Prefix to match\r\n * @returns Maximum counter value\r\n */\r\nexport function getMaxBusinessIdCounter<T extends { id: string }>(\r\n  items: T[],\r\n  prefix: string\r\n): number {\r\n  if (!items || !Array.isArray(items)) return 0;\r\n  \r\n  let maxCounter = 0;\r\n  \r\n  items.forEach(item => {\r\n    if (!item || !item.id) return;\r\n    const counter = extractCounterFromBusinessId(item.id, prefix);\r\n    if (counter > maxCounter) {\r\n      maxCounter = counter;\r\n    }\r\n  });\r\n  \r\n  return maxCounter;\r\n}\r\n\r\n/**\r\n * Format ID for display\r\n * Adds spacing for readability\r\n * \r\n * @param id - ID to format\r\n * @returns Formatted ID (e.g., \"NV-000001\", \"KH-000123\")\r\n */\r\nexport function formatIdForDisplay(id: string): string {\r\n  // Match pattern: PREFIX followed by numbers\r\n  const match = id.match(/^([A-Z]+)(\\d+)$/);\r\n  if (!match) return id;\r\n  \r\n  const [, prefix, numbers] = match;\r\n  return `${prefix}-${numbers}`;\r\n}\r\n\r\n/**\r\n * Validate ID format\r\n * Check if ID follows valid pattern (letters + numbers only)\r\n * \r\n * @param id - ID to validate\r\n * @returns true if valid format\r\n */\r\nexport function isValidIdFormat(id: string): boolean {\r\n  if (!id || typeof id !== 'string') return false;\r\n  \r\n  // Only alphanumeric characters allowed\r\n  const regex = /^[A-Z0-9]+$/i;\r\n  return regex.test(id);\r\n}\r\n\r\n/**\r\n * Generate suggested IDs based on entity type\r\n * Useful for autocomplete or placeholder text\r\n * \r\n * @param entityType - Entity type\r\n * @param counter - Current counter\r\n * @param count - Number of suggestions\r\n * @returns Array of suggested IDs\r\n */\r\nexport function generateSuggestedIds(\r\n  entityType: EntityType,\r\n  counter: number,\r\n  count: number = 3\r\n): string[] {\r\n  const suggestions: string[] = [];\r\n  const prefix = getPrefix(entityType);\r\n  \r\n  for (let i = 0; i < count; i++) {\r\n    suggestions.push(`${prefix}${String(counter + i + 1).padStart(6, '0')}`);\r\n  }\r\n  \r\n  return suggestions;\r\n}\r\n\r\n/**\r\n * ✨ Find next available business ID\r\n * Checks existing IDs and increments counter until finding a unique ID\r\n * \r\n * @param prefix - ID prefix (e.g., 'PT', 'PC', 'NV')\r\n * @param existingIds - Array of existing business IDs\r\n * @param startCounter - Starting counter value\r\n * @param digitCount - Number of digits (default: 6)\r\n * @returns Object with nextId and updatedCounter\r\n */\r\nexport function findNextAvailableBusinessId(\r\n  prefix: string,\r\n  existingIds: string[],\r\n  startCounter: number,\r\n  digitCount: number = 6\r\n): { nextId: string; updatedCounter: number } {\r\n  let counter = startCounter;\r\n  let nextId: string;\r\n  \r\n  // Keep incrementing until we find a unique ID\r\n  do {\r\n    counter++;\r\n    nextId = `${prefix}${String(counter).padStart(digitCount, '0')}`;\r\n  } while (existingIds.some(id => id === nextId));\r\n  \r\n  return {\r\n    nextId,\r\n    updatedCounter: counter\r\n  };\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 167, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/lib/store-factory.ts"],"sourcesContent":["import { create } from 'zustand';\r\n// persist, createJSONStorage removed - database is now source of truth\r\nimport { \r\n  generateSystemId, \r\n  generateBusinessId, \r\n  isBusinessIdUnique,\r\n  getMaxSystemIdCounter,\r\n  getMaxBusinessIdCounter,\r\n  findNextAvailableBusinessId,\r\n  type EntityType \r\n} from './id-utils';\r\nimport { getPrefix } from './smart-prefix';\r\nimport { ID_CONFIG, type SystemId, type BusinessId, createSystemId, createBusinessId as brandBusinessId } from './id-config';\r\n\r\nconst SYSTEM_FALLBACK_ID: SystemId = createSystemId('SYS000000');\r\n\r\nconst asSystemIdFallback = (): SystemId => SYSTEM_FALLBACK_ID;\r\n\r\n// ✅ API Sync helper for store-factory\r\nasync function syncToAPI<T>(\r\n  apiEndpoint: string,\r\n  action: 'create' | 'update' | 'delete' | 'restore',\r\n  data: T | { systemId: SystemId },\r\n  systemId?: SystemId\r\n): Promise<boolean> {\r\n  try {\r\n    const endpoint = action === 'create' \r\n      ? apiEndpoint \r\n      : `${apiEndpoint}/${systemId || (data as any).systemId}`;\r\n    \r\n    const method = action === 'create' ? 'POST' \r\n      : action === 'update' ? 'PATCH' \r\n      : action === 'delete' ? 'DELETE'\r\n      : 'PATCH'; // restore uses PATCH\r\n    \r\n    const response = await fetch(endpoint, {\r\n      method,\r\n      headers: { 'Content-Type': 'application/json' },\r\n      credentials: 'include',\r\n      body: action !== 'delete' ? JSON.stringify(data) : undefined,\r\n    });\r\n    \r\n    if (!response.ok) {\r\n      console.warn(`[Store Factory API] ${action} failed for ${apiEndpoint}:`, response.status);\r\n    }\r\n    return response.ok;\r\n  } catch (error) {\r\n    console.error(`[Store Factory API] ${action} error for ${apiEndpoint}:`, error);\r\n    return false;\r\n  }\r\n}\r\n\r\n// Item with SystemId (branded type)\r\nexport type ItemWithSystemId = { systemId: SystemId; [key: string]: any };\r\n\r\n// ✅ Counter state for ID generation\r\nexport type CounterState = {\r\n  systemId: number;\r\n  businessId: number;\r\n};\r\n\r\nexport type CrudState<T extends ItemWithSystemId> = {\r\n  data: T[];\r\n  _counters: CounterState; // ✅ Persisted counters\r\n  _initialized: boolean; // ✅ Track if loaded from API\r\n  add: (item: Omit<T, 'systemId'>) => T;\r\n  addMultiple: (items: Omit<T, 'systemId'>[]) => void;\r\n  update: (systemId: SystemId, item: Partial<T>) => void; // ✅ Accept partial updates\r\n  remove: (systemId: SystemId) => void; // ✅ Branded type\r\n  hardDelete: (systemId: SystemId) => void; // ✅ Branded type\r\n  restore: (systemId: SystemId) => void; // ✅ Branded type\r\n  findById: (systemId: SystemId | string) => T | undefined; // ✅ Branded type\r\n  getActive: () => T[];\r\n  getDeleted: () => T[];\r\n  loadFromAPI: () => Promise<void>; // ✅ Load data from database\r\n};\r\n\r\nexport const createCrudStore = <T extends ItemWithSystemId>(\r\n  _initialData: T[], // @deprecated - Kept for backward compatibility but NO LONGER USED\r\n  entityType: EntityType, // Changed from idPrefix to entityType\r\n  options?: {\r\n    businessIdField?: keyof T; // Field name for business ID (default: 'id')\r\n    persistKey?: string; // @deprecated - No longer used, kept for backward compatibility\r\n    getCurrentUser?: () => string | undefined; // Function to get current user systemId\r\n    apiEndpoint?: string; // ✅ API endpoint for database sync (e.g., '/api/employees')\r\n  }\r\n) => {\r\n  const businessPrefix = getPrefix(entityType); // Vietnamese prefix for Business ID (NV, KH, DH)\r\n  const config = ID_CONFIG[entityType];\r\n  const systemIdPrefix = config?.systemIdPrefix || entityType.toUpperCase(); // English prefix for SystemId (EMP, CUSTOMER, ORDER)\r\n  \r\n  const businessIdField = options?.businessIdField ?? 'id';\r\n  // const persistKey = options?.persistKey; // @deprecated - No longer used\r\n  const getCurrentUser = options?.getCurrentUser;\r\n  const apiEndpoint = options?.apiEndpoint;\r\n\r\n  // ✅ CHANGED: Start with empty array - database is source of truth\r\n  // Mock data files (data.ts) are NO LONGER USED for runtime\r\n  const normalizedInitialData: T[] = [];\r\n\r\n  const storeConfig = (set: any, get: any) => ({\r\n    data: normalizedInitialData, // ✅ Start empty - data loaded via React Query\r\n    // ✅ Counters start at 0 - will be initialized from API via loadFromAPI()\r\n    _counters: {\r\n      systemId: 0,\r\n      businessId: 0\r\n    },\r\n    _initialized: false, // ✅ Track API initialization\r\n    add: (item: Omit<T, 'systemId'>): T => {\r\n        // ✅ Get counters from state (persisted)\r\n        const currentCounters = get()._counters;\r\n        const newSystemIdCounter = currentCounters.systemId + 1;\r\n        const newSystemId = createSystemId(generateSystemId(entityType, newSystemIdCounter));\r\n        \r\n        // Generate or validate Business ID (if field exists)\r\n        let finalItem = { ...item } as any;\r\n        let newBusinessIdCounter = currentCounters.businessId;\r\n        \r\n        if (businessIdField in item) {\r\n          const customId = (item as any)[businessIdField];\r\n          const existingIds = get().data.map((d: any) => d[businessIdField]);\r\n          \r\n          // ✅ If customId provided, validate uniqueness\r\n          if (customId && customId.trim()) {\r\n            if (!isBusinessIdUnique(customId, existingIds)) {\r\n              throw new Error(`Mã \"${customId}\" đã tồn tại! Vui lòng sử dụng mã khác.`);\r\n            }\r\n            finalItem[businessIdField] = customId.trim().toUpperCase();\r\n          } else {\r\n            // ✅ Auto-generate with findNextAvailableBusinessId\r\n            const digitCount = 6; // All entities use 6 digits\r\n            const result = findNextAvailableBusinessId(businessPrefix, existingIds, newBusinessIdCounter, digitCount);\r\n            finalItem[businessIdField] = result.nextId;\r\n            newBusinessIdCounter = result.updatedCounter;\r\n          }\r\n        }\r\n        \r\n        const now = new Date().toISOString();\r\n        const currentUser = getCurrentUser?.();\r\n        const newItem = { \r\n          ...finalItem, \r\n          systemId: newSystemId, // ✅ Branded SystemId\r\n          createdAt: finalItem.createdAt || now,\r\n          updatedAt: now,\r\n          createdBy: finalItem.createdBy || currentUser,\r\n          updatedBy: currentUser,\r\n        } as unknown as T;\r\n        \r\n        // ✅ Update both data and counters atomically\r\n        set((state: any) => ({ \r\n          data: [...state.data, newItem],\r\n          _counters: {\r\n            systemId: newSystemIdCounter,\r\n            businessId: newBusinessIdCounter\r\n          }\r\n        }));\r\n        \r\n        // ✅ Sync to API in background\r\n        if (apiEndpoint) {\r\n          syncToAPI(apiEndpoint, 'create', newItem).catch(console.error);\r\n        }\r\n        \r\n        return newItem;\r\n    },\r\n    addMultiple: (items: Omit<T, 'systemId'>[]) => \r\n        set((state: any) => {\r\n            const now = new Date().toISOString();\r\n            const currentUser = getCurrentUser?.();\r\n            const newItems: T[] = [];\r\n            const digitCount = 6; // All entities use 6 digits\r\n            \r\n            // ✅ Start from current counters\r\n            let currentSystemIdCounter = state._counters.systemId;\r\n            let currentBusinessIdCounter = state._counters.businessId;\r\n            \r\n            items.forEach(item => {\r\n                // ✅ Generate SystemId from current counter\r\n                currentSystemIdCounter++;\r\n                const newSystemId = createSystemId(generateSystemId(entityType, currentSystemIdCounter));\r\n                \r\n                // Generate or validate Business ID (if field exists)\r\n                let finalItem = { ...item } as any;\r\n                if (businessIdField in item) {\r\n                  const customId = (item as any)[businessIdField];\r\n                  \r\n                  // Collect existing IDs (from state + already added in this batch)\r\n                  const existingIds = [\r\n                    ...state.data.map((d: any) => d[businessIdField]),\r\n                    ...newItems.map((d: any) => d[businessIdField])\r\n                  ];\r\n                  \r\n                  // ✅ If customId provided, validate uniqueness\r\n                  if (customId && customId.trim()) {\r\n                    if (!isBusinessIdUnique(customId, existingIds)) {\r\n                      throw new Error(`Mã \"${customId}\" đã tồn tại! Vui lòng sử dụng mã khác.`);\r\n                    }\r\n                    finalItem[businessIdField] = customId.trim().toUpperCase();\r\n                  } else {\r\n                    // ✅ Auto-generate with findNextAvailableBusinessId\r\n                    const result = findNextAvailableBusinessId(businessPrefix, existingIds, currentBusinessIdCounter, digitCount);\r\n                    finalItem[businessIdField] = result.nextId;\r\n                    currentBusinessIdCounter = result.updatedCounter;\r\n                  }\r\n                }\r\n                \r\n                newItems.push({ \r\n                  ...finalItem, \r\n                  systemId: newSystemId,\r\n                  createdAt: now,\r\n                  updatedAt: now,\r\n                  createdBy: currentUser,\r\n                  updatedBy: currentUser,\r\n                } as unknown as T);\r\n            });\r\n            \r\n            // ✅ Update both data and counters\r\n            const result = { \r\n              data: [...state.data, ...newItems],\r\n              _counters: {\r\n                systemId: currentSystemIdCounter,\r\n                businessId: currentBusinessIdCounter\r\n              }\r\n            };\r\n            \r\n            // ✅ Sync to API in background (batch)\r\n            if (apiEndpoint) {\r\n              newItems.forEach(item => {\r\n                syncToAPI(apiEndpoint, 'create', item).catch(console.error);\r\n              });\r\n            }\r\n            \r\n            return result;\r\n        }),\r\n    update: (systemId: SystemId, updatedItem: Partial<T>) => {\r\n      // Validate unique business ID (case-insensitive, skip self)\r\n      if (businessIdField in updatedItem) {\r\n        const businessId = (updatedItem as any)[businessIdField];\r\n        const existingIds = get().data\r\n          .filter((d: any) => d.systemId !== systemId)\r\n          .map((d: any) => d[businessIdField]);\r\n        \r\n        if (businessId && !isBusinessIdUnique(businessId, existingIds)) {\r\n          throw new Error(`Mã \"${businessId}\" đã tồn tại! Vui lòng sử dụng mã khác.`);\r\n        }\r\n      }\r\n\r\n      const now = new Date().toISOString();\r\n      const currentUser = getCurrentUser?.();\r\n      set((state: any) => ({\r\n        data: state.data.map((item: T) =>\r\n          item.systemId === systemId \r\n            ? { ...item, ...updatedItem, updatedAt: now, updatedBy: currentUser } as T\r\n            : item\r\n        ),\r\n      }));\r\n      \r\n      // ✅ Sync to API in background\r\n      if (apiEndpoint) {\r\n        const fullItem = get().data.find((item: T) => item.systemId === systemId);\r\n        if (fullItem) {\r\n          syncToAPI(apiEndpoint, 'update', fullItem, systemId).catch(console.error);\r\n        }\r\n      }\r\n    },\r\n    remove: (systemId: SystemId) => {\r\n      // Soft delete - mark as deleted\r\n      const now = new Date().toISOString();\r\n      set((state: any) => ({\r\n        data: state.data.map((item: T) =>\r\n          item.systemId === systemId\r\n            ? { ...item, isDeleted: true, deletedAt: now } as T\r\n            : item\r\n        ),\r\n      }));\r\n      \r\n      // ✅ Sync to API in background\r\n      if (apiEndpoint) {\r\n        const item = get().data.find((item: T) => item.systemId === systemId);\r\n        if (item) {\r\n          syncToAPI(apiEndpoint, 'update', { ...item, isDeleted: true, deletedAt: now }, systemId).catch(console.error);\r\n        }\r\n      }\r\n    },\r\n    hardDelete: (systemId: SystemId) => {\r\n      // Permanent delete - remove from array\r\n      set((state: any) => ({\r\n        data: state.data.filter((item: T) => item.systemId !== systemId),\r\n      }));\r\n      \r\n      // ✅ Sync to API in background\r\n      if (apiEndpoint) {\r\n        syncToAPI(apiEndpoint, 'delete', { systemId }, systemId).catch(console.error);\r\n      }\r\n    },\r\n    restore: (systemId: SystemId) => {\r\n      // Restore soft-deleted item\r\n      set((state: any) => ({\r\n        data: state.data.map((item: T) =>\r\n          item.systemId === systemId\r\n            ? { ...item, isDeleted: false, deletedAt: null } as T\r\n            : item\r\n        ),\r\n      }));\r\n      \r\n      // ✅ Sync to API in background\r\n      if (apiEndpoint) {\r\n        const item = get().data.find((item: T) => item.systemId === systemId);\r\n        if (item) {\r\n          syncToAPI(apiEndpoint, 'restore', { ...item, isDeleted: false, deletedAt: null }, systemId).catch(console.error);\r\n        }\r\n      }\r\n    },\r\n    getActive: () => get().data.filter((item: any) => !item.isDeleted),\r\n    getDeleted: () => get().data.filter((item: any) => item.isDeleted),\r\n    findById: (id: SystemId | string) => get().data.find((item: T) => item.systemId === id || (item as any).id === id),\r\n    \r\n    // ✅ Load data from database API - OPTIMIZED: No more limit=10000!\r\n    // This is now only used for counter initialization, NOT for loading all data\r\n    // Use React Query hooks for data fetching with proper pagination\r\n    loadFromAPI: async () => {\r\n      if (!apiEndpoint) return;\r\n      if (get()._initialized) return;\r\n      \r\n      try {\r\n        // Only fetch minimal data needed to initialize counters\r\n        // Actual data loading should be done via React Query hooks\r\n        const response = await fetch(`${apiEndpoint}?limit=1&sortBy=systemId&sortOrder=desc`, {\r\n          credentials: 'include',\r\n        });\r\n        if (response.ok) {\r\n          const json = await response.json();\r\n          const pagination = json.pagination || {};\r\n          const lastItem = json.data?.[0];\r\n          \r\n          // Initialize counters from the latest item (highest IDs)\r\n          const newCounters = {\r\n            systemId: lastItem ? getMaxSystemIdCounter([lastItem], systemIdPrefix) : 0,\r\n            businessId: (lastItem && options?.businessIdField)\r\n              ? getMaxBusinessIdCounter([lastItem] as any[], businessPrefix)\r\n              : 0\r\n          };\r\n          \r\n          set({ \r\n            data: [], // Don't store data in Zustand anymore - use React Query\r\n            _counters: newCounters,\r\n            _initialized: true \r\n          });\r\n          \r\n          console.log(`[Store Factory] ${apiEndpoint} initialized. Total records: ${pagination.total || 'unknown'}`);\r\n        }\r\n      } catch (error) {\r\n        console.error(`[Store Factory] loadFromAPI error for ${apiEndpoint}:`, error);\r\n        // Still mark as initialized to prevent infinite retry\r\n        set({ _initialized: true });\r\n      }\r\n    },\r\n  });\r\n\r\n  // ✅ SIMPLIFIED: No localStorage persistence, database is source of truth\r\n  // Data is loaded via ApiSyncProvider on app init\r\n  return create<CrudState<T>>(storeConfig);\r\n};\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 478, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/lib/activity-history-helper.ts"],"sourcesContent":["/**\r\n * Activity History Helper\r\n * \r\n * Helper để tạo các entry lịch sử hoạt động một cách nhất quán\r\n * Dùng chung cho tất cả các modules trong hệ thống\r\n * \r\n * NOTE: Đã remove import useEmployeeStore để tránh circular dependency\r\n * và cải thiện compile time\r\n */\r\n\r\nimport type { HistoryEntry } from '../components/ActivityHistory';\r\nimport { getCurrentUserInfo as getAuthUserInfo } from '../contexts/auth-context';\r\nimport type { SystemId } from './id-types';\r\n\r\n// Re-export HistoryEntry type for convenience\r\nexport type { HistoryEntry } from '../components/ActivityHistory';\r\n\r\n/**\r\n * Lấy thông tin người dùng hiện tại từ auth context\r\n * NOTE: Avatar lookup từ employee store đã bị remove để tránh circular dependency\r\n */\r\nexport function getCurrentUserInfo(): { systemId: string; name: string; avatar?: string } {\r\n  const authInfo = getAuthUserInfo();\r\n  \r\n  return {\r\n    systemId: authInfo.systemId || 'SYSTEM',\r\n    name: authInfo.name || 'Hệ thống',\r\n    avatar: undefined, // Avatar will be fetched by component if needed\r\n  };\r\n}\r\n\r\n/**\r\n * Lấy thông tin nhân viên từ systemId\r\n * NOTE: This function now requires employee data to be passed in\r\n * to avoid circular dependency with employee store\r\n */\r\nexport function getEmployeeInfoFromData(\r\n  employeeSystemId: SystemId | string,\r\n  employees: Array<{ systemId: string; fullName: string; avatarUrl?: string }>\r\n): { systemId: string; name: string; avatar?: string } {\r\n  const employee = employees.find(e => e.systemId === employeeSystemId);\r\n  \r\n  if (employee) {\r\n    return {\r\n      systemId: employee.systemId,\r\n      name: employee.fullName,\r\n      avatar: employee.avatarUrl,\r\n    };\r\n  }\r\n  \r\n  // Fallback to system\r\n  return {\r\n    systemId: String(employeeSystemId) || 'SYSTEM',\r\n    name: 'Hệ thống',\r\n  };\r\n}\r\n\r\n/**\r\n * @deprecated Use getEmployeeInfoFromData instead\r\n */\r\nexport function getEmployeeInfo(employeeSystemId: SystemId | string): { systemId: string; name: string; avatar?: string } {\r\n  // Return minimal info without employee store lookup\r\n  return {\r\n    systemId: String(employeeSystemId) || 'SYSTEM',\r\n    name: 'Hệ thống',\r\n  };\r\n}\r\n\r\n/**\r\n * Tạo một history entry mới\r\n */\r\nexport function createHistoryEntry(\r\n  action: HistoryEntry['action'],\r\n  userOrDescription: { systemId: string; name: string; avatar?: string } | string,\r\n  descriptionOrMetadata?: string | HistoryEntry['metadata'],\r\n  metadata?: HistoryEntry['metadata']\r\n): HistoryEntry {\r\n  const hasUserObject = typeof userOrDescription === 'object' && userOrDescription !== null;\r\n  const user = hasUserObject ? userOrDescription : getCurrentUserInfo();\r\n  const description = (hasUserObject ? descriptionOrMetadata : userOrDescription) as string | undefined;\r\n  const meta = (hasUserObject ? metadata : descriptionOrMetadata) as HistoryEntry['metadata'] | undefined;\r\n\r\n  return {\r\n    id: `history-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,\r\n    action,\r\n    timestamp: new Date(),\r\n    user: {\r\n      systemId: user.systemId,\r\n      name: user.name,\r\n      avatar: user.avatar,\r\n    },\r\n    description: description ?? '',\r\n    metadata: meta,\r\n  };\r\n}\r\n\r\n/**\r\n * Tạo history entry cho action \"created\"\r\n */\r\nexport function createCreatedEntry(\r\n  user: { systemId: string; name: string; avatar?: string },\r\n  description: string\r\n): HistoryEntry {\r\n  return createHistoryEntry('created', user, description);\r\n}\r\n\r\n/**\r\n * Tạo history entry cho action \"updated\"\r\n */\r\nexport function createUpdatedEntry(\r\n  user: { systemId: string; name: string; avatar?: string },\r\n  description: string\r\n): HistoryEntry {\r\n  return createHistoryEntry('updated', user, description);\r\n}\r\n\r\n/**\r\n * Tạo history entry cho action \"status_changed\"\r\n */\r\nexport function createStatusChangedEntry(\r\n  user: { systemId: string; name: string; avatar?: string },\r\n  oldStatus: string,\r\n  newStatus: string,\r\n  description: string\r\n): HistoryEntry {\r\n  return createHistoryEntry(\r\n    'status_changed',\r\n    user,\r\n    description,\r\n    { field: 'status', oldValue: oldStatus, newValue: newStatus }\r\n  );\r\n}\r\n\r\n/**\r\n * Tạo history entry cho action \"deleted\"\r\n */\r\nexport function createDeletedEntry(\r\n  user: { systemId: string; name: string; avatar?: string },\r\n  description: string\r\n): HistoryEntry {\r\n  return createHistoryEntry('deleted', user, description);\r\n}\r\n\r\n/**\r\n * Tạo history entry cho action \"assigned\"\r\n */\r\nexport function createAssignedEntry(\r\n  user: { systemId: string; name: string; avatar?: string },\r\n  description: string\r\n): HistoryEntry {\r\n  return createHistoryEntry('assigned', user, description);\r\n}\r\n\r\n/**\r\n * Tạo history entry cho action \"payment_made\"\r\n */\r\nexport function createPaymentEntry(\r\n  user: { systemId: string; name: string; avatar?: string },\r\n  description: string\r\n): HistoryEntry {\r\n  return createHistoryEntry('payment_made', user, description);\r\n}\r\n\r\n/**\r\n * Tạo history entry cho action \"comment_added\"\r\n */\r\nexport function createCommentEntry(\r\n  user: { systemId: string; name: string; avatar?: string },\r\n  description: string\r\n): HistoryEntry {\r\n  return createHistoryEntry('comment_added', user, description);\r\n}\r\n\r\n/**\r\n * Tạo history entry cho action \"cancelled\"\r\n */\r\nexport function createCancelledEntry(\r\n  user: { systemId: string; name: string; avatar?: string },\r\n  description: string\r\n): HistoryEntry {\r\n  return createHistoryEntry('cancelled', user, description);\r\n}\r\n\r\n/**\r\n * Tạo history entry cho action \"verified\"\r\n */\r\nexport function createVerifiedEntry(\r\n  user: { systemId: string; name: string; avatar?: string },\r\n  description: string\r\n): HistoryEntry {\r\n  return createHistoryEntry('verified', user, description);\r\n}\r\n\r\n/**\r\n * Tạo history entry cho action \"ended\"\r\n */\r\nexport function createEndedEntry(\r\n  user: { systemId: string; name: string; avatar?: string },\r\n  description: string\r\n): HistoryEntry {\r\n  return createHistoryEntry('ended', user, description);\r\n}\r\n\r\n/**\r\n * Tạo history entry cho action \"reopened\"\r\n */\r\nexport function createReopenedEntry(\r\n  user: { systemId: string; name: string; avatar?: string },\r\n  description: string\r\n): HistoryEntry {\r\n  return createHistoryEntry('reopened', user, description);\r\n}\r\n\r\n/**\r\n * Tạo history entry cho product actions\r\n */\r\nexport function createProductEntry(\r\n  user: { systemId: string; name: string; avatar?: string },\r\n  action: 'product_added' | 'product_updated' | 'product_removed',\r\n  description: string\r\n): HistoryEntry {\r\n  return createHistoryEntry(action, user, description);\r\n}\r\n\r\n/**\r\n * Helper để append history entry vào existing array\r\n */\r\nexport function appendHistoryEntry(\r\n  existingHistory: HistoryEntry[] | undefined,\r\n  ...newEntries: HistoryEntry[]\r\n): HistoryEntry[] {\r\n  return [...(existingHistory || []), ...newEntries];\r\n}\r\n\r\n/**\r\n * Helper để tạo nhiều history entries cùng lúc\r\n */\r\nexport function createBulkUpdateEntries(\r\n  user: { systemId: string; name: string; avatar?: string },\r\n  changes: Array<{ field: string; description: string }>\r\n): HistoryEntry[] {\r\n  return changes.map(change => createHistoryEntry('updated', user, change.description));\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 630, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/lib/id-types.ts"],"sourcesContent":["/**\r\n * Type-safe ID System\r\n * \r\n * Prevents mixing systemId with business ID at compile time\r\n */\r\n\r\n// Branded types for type safety\r\nexport type SystemId = string & { readonly __brand: 'SystemId' };\r\nexport type BusinessId = string & { readonly __brand: 'BusinessId' };\r\n\r\n/**\r\n * Create a SystemId from a string\r\n * Use this when you know for sure it's a systemId\r\n */\r\nexport function asSystemId(id: string): SystemId {\r\n  return id as SystemId;\r\n}\r\n\r\n/**\r\n * Create a BusinessId from a string\r\n * Use this when you know for sure it's a business ID\r\n */\r\nexport function asBusinessId(id: string): BusinessId {\r\n  return id as BusinessId;\r\n}\r\n\r\n/**\r\n * Check if a string is a valid systemId format\r\n */\r\nexport function isSystemIdFormat(id: string): boolean {\r\n  // SystemId: 8 digits + prefix (e.g., NV00000001, VOUCHER00000123)\r\n  return /^[A-Z]+\\d{8}$/.test(id);\r\n}\r\n\r\n/**\r\n * Check if a string is a valid business ID format\r\n */\r\nexport function isBusinessIdFormat(id: string): boolean {\r\n  // Business ID: shorter, variable length (e.g., NV001, PT000001)\r\n  return /^[A-Z]+\\d{3,6}$/.test(id);\r\n}\r\n\r\n/**\r\n * Safely convert unknown ID to proper type\r\n */\r\nexport function parseId(id: string): { type: 'system' | 'business'; value: SystemId | BusinessId } {\r\n  if (isSystemIdFormat(id)) {\r\n    return { type: 'system', value: asSystemId(id) };\r\n  }\r\n  if (isBusinessIdFormat(id)) {\r\n    return { type: 'business', value: asBusinessId(id) };\r\n  }\r\n  throw new Error(`Invalid ID format: ${id}`);\r\n}\r\n\r\n/**\r\n * ID Pair - Always keep systemId and businessId together\r\n */\r\nexport interface IDPair {\r\n  systemId: SystemId;\r\n  businessId: BusinessId;\r\n}\r\n\r\n/**\r\n * Entity with dual IDs\r\n */\r\nexport interface DualIDEntity {\r\n  systemId: SystemId;\r\n  id: BusinessId;\r\n}\r\n\r\n/**\r\n * Store methods with type-safe IDs\r\n */\r\nexport interface TypeSafeStore<T extends DualIDEntity> {\r\n  /** Find by systemId (for queries, relationships) */\r\n  findBySystemId(systemId: SystemId): T | null;\r\n  \r\n  /** Find by business ID (for user input, display) */\r\n  findByBusinessId(businessId: BusinessId): T | null;\r\n  \r\n  /** Update by systemId (always use systemId for updates) */\r\n  updateBySystemId(systemId: SystemId, updates: Partial<T>): void;\r\n  \r\n  /** Delete by systemId (always use systemId for deletes) */\r\n  deleteBySystemId(systemId: SystemId): void;\r\n}\r\n\r\n/**\r\n * Route params with type-safe IDs\r\n */\r\nexport interface RouteParams {\r\n  systemId?: SystemId;\r\n  id?: BusinessId;\r\n}\r\n\r\n/**\r\n * Link builder - always uses systemId\r\n */\r\nexport function buildEntityLink(path: string, entity: DualIDEntity): string {\r\n  return path.replace(':systemId', entity.systemId);\r\n}\r\n\r\n/**\r\n * Display ID - always uses business ID\r\n */\r\nexport function getDisplayId(entity: DualIDEntity): string {\r\n  return entity.id;\r\n}\r\n\r\n/**\r\n * Runtime guard: ensures a string is valid SystemId format and casts it\r\n * Logs warning if format is invalid\r\n */\r\nexport function ensureSystemId(id: string, context?: string): SystemId {\r\n  if (!isSystemIdFormat(id)) {\r\n    console.warn(`[ensureSystemId] Invalid SystemId format: \"${id}\"${context ? ` in ${context}` : ''}`);\r\n  }\r\n  return asSystemId(id);\r\n}\r\n\r\n/**\r\n * Runtime guard: ensures a string is valid BusinessId format and casts it\r\n * Logs warning if format is invalid\r\n */\r\nexport function ensureBusinessId(id: string, context?: string): BusinessId {\r\n  if (!isBusinessIdFormat(id)) {\r\n    console.warn(`[ensureBusinessId] Invalid BusinessId format: \"${id}\"${context ? ` in ${context}` : ''}`);\r\n  }\r\n  return asBusinessId(id);\r\n}\r\n"],"names":[],"mappings":"AAAA;;;;CAIC,GAED,gCAAgC;;;;;;;;;;;;;;;;;;;;;AAQzB,SAAS,WAAW,EAAU;IACnC,OAAO;AACT;AAMO,SAAS,aAAa,EAAU;IACrC,OAAO;AACT;AAKO,SAAS,iBAAiB,EAAU;IACzC,kEAAkE;IAClE,OAAO,gBAAgB,IAAI,CAAC;AAC9B;AAKO,SAAS,mBAAmB,EAAU;IAC3C,gEAAgE;IAChE,OAAO,kBAAkB,IAAI,CAAC;AAChC;AAKO,SAAS,QAAQ,EAAU;IAChC,IAAI,iBAAiB,KAAK;QACxB,OAAO;YAAE,MAAM;YAAU,OAAO,WAAW;QAAI;IACjD;IACA,IAAI,mBAAmB,KAAK;QAC1B,OAAO;YAAE,MAAM;YAAY,OAAO,aAAa;QAAI;IACrD;IACA,MAAM,IAAI,MAAM,CAAC,mBAAmB,EAAE,IAAI;AAC5C;AA8CO,SAAS,gBAAgB,IAAY,EAAE,MAAoB;IAChE,OAAO,KAAK,OAAO,CAAC,aAAa,OAAO,QAAQ;AAClD;AAKO,SAAS,aAAa,MAAoB;IAC/C,OAAO,OAAO,EAAE;AAClB;AAMO,SAAS,eAAe,EAAU,EAAE,OAAgB;IACzD,IAAI,CAAC,iBAAiB,KAAK;QACzB,QAAQ,IAAI,CAAC,CAAC,2CAA2C,EAAE,GAAG,CAAC,EAAE,UAAU,CAAC,IAAI,EAAE,SAAS,GAAG,IAAI;IACpG;IACA,OAAO,WAAW;AACpB;AAMO,SAAS,iBAAiB,EAAU,EAAE,OAAgB;IAC3D,IAAI,CAAC,mBAAmB,KAAK;QAC3B,QAAQ,IAAI,CAAC,CAAC,+CAA+C,EAAE,GAAG,CAAC,EAAE,UAAU,CAAC,IAAI,EAAE,SAAS,GAAG,IAAI;IACxG;IACA,OAAO,aAAa;AACtB"}},
    {"offset": {"line": 709, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/lib/attendance-snapshot-service.ts"],"sourcesContent":["import { useAttendanceStore } from '../features/attendance/store';\r\nimport type { AttendanceDataRow } from '../features/attendance/types';\r\nimport type { SystemId, BusinessId } from './id-types';\r\n\r\ntype SnapshotQuery = {\r\n  monthKey: string;\r\n  employeeSystemId: SystemId;\r\n};\r\n\r\nexport type AttendanceSnapshot = {\r\n  monthKey: string;\r\n  employeeSystemId: SystemId;\r\n  employeeId: BusinessId;\r\n  fullName: string;\r\n  department: AttendanceDataRow['department'];\r\n  totals: {\r\n    workDays: number;\r\n    leaveDays: number;\r\n    absentDays: number;\r\n    lateArrivals: number;\r\n    earlyDepartures: number;\r\n    otHours: number;\r\n    // Chi tiết OT theo loại ngày\r\n    otHoursWeekday?: number;   // Làm thêm ngày thường (sau giờ tan làm)\r\n    otHoursWeekend?: number;   // Làm thêm cuối tuần\r\n    otHoursHoliday?: number;   // Làm thêm ngày lễ\r\n  };\r\n  locked: boolean;\r\n  status: 'pending' | 'locked';\r\n  generatedAt: string;\r\n};\r\n\r\nconst buildSnapshot = (\r\n  row: AttendanceDataRow,\r\n  query: SnapshotQuery,\r\n  locked: boolean\r\n): AttendanceSnapshot => ({\r\n  monthKey: query.monthKey,\r\n  employeeSystemId: query.employeeSystemId,\r\n  employeeId: row.employeeId,\r\n  fullName: row.fullName,\r\n  department: row.department,\r\n  totals: {\r\n    workDays: row.workDays,\r\n    leaveDays: row.leaveDays,\r\n    absentDays: row.absentDays,\r\n    lateArrivals: row.lateArrivals,\r\n    earlyDepartures: row.earlyDepartures,\r\n    otHours: row.otHours,\r\n    otHoursWeekday: row.otHoursWeekday ?? 0,\r\n    otHoursWeekend: row.otHoursWeekend ?? 0,\r\n    otHoursHoliday: row.otHoursHoliday ?? 0,\r\n  },\r\n  locked,\r\n  status: locked ? 'locked' : 'pending',\r\n  generatedAt: new Date().toISOString(),\r\n});\r\n\r\nconst getLatestLockedMonthKey = () => {\r\n  const { lockedMonths } = useAttendanceStore.getState();\r\n  const lockedKeys = Object.entries(lockedMonths)\r\n    .filter(([, isLocked]) => Boolean(isLocked))\r\n    .map(([monthKey]) => monthKey)\r\n    .sort()\r\n    .reverse();\r\n  return lockedKeys[0];\r\n};\r\n\r\nexport const attendanceSnapshotService = {\r\n  getSnapshot({ monthKey, employeeSystemId }: SnapshotQuery): AttendanceSnapshot | null {\r\n    const state = useAttendanceStore.getState();\r\n    const monthRows = state.attendanceData[monthKey];\r\n    if (!monthRows?.length) {\r\n      return null;\r\n    }\r\n    const targetRow = monthRows.find((row) => row.employeeSystemId === employeeSystemId);\r\n    if (!targetRow) {\r\n      return null;\r\n    }\r\n    const locked = Boolean(state.lockedMonths[monthKey]);\r\n    return buildSnapshot(targetRow, { monthKey, employeeSystemId }, locked);\r\n  },\r\n  getLatestLockedSnapshot(employeeSystemId: SystemId): AttendanceSnapshot | null {\r\n    const latestLockedKey = getLatestLockedMonthKey();\r\n    if (!latestLockedKey) {\r\n      return null;\r\n    }\r\n    return this.getSnapshot({ monthKey: latestLockedKey, employeeSystemId });\r\n  },\r\n};\r\n"],"names":[],"mappings":";;;;AAAA;;AAgCA,MAAM,gBAAgB,CACpB,KACA,OACA,SACuB,CAAC;QACxB,UAAU,MAAM,QAAQ;QACxB,kBAAkB,MAAM,gBAAgB;QACxC,YAAY,IAAI,UAAU;QAC1B,UAAU,IAAI,QAAQ;QACtB,YAAY,IAAI,UAAU;QAC1B,QAAQ;YACN,UAAU,IAAI,QAAQ;YACtB,WAAW,IAAI,SAAS;YACxB,YAAY,IAAI,UAAU;YAC1B,cAAc,IAAI,YAAY;YAC9B,iBAAiB,IAAI,eAAe;YACpC,SAAS,IAAI,OAAO;YACpB,gBAAgB,IAAI,cAAc,IAAI;YACtC,gBAAgB,IAAI,cAAc,IAAI;YACtC,gBAAgB,IAAI,cAAc,IAAI;QACxC;QACA;QACA,QAAQ,SAAS,WAAW;QAC5B,aAAa,IAAI,OAAO,WAAW;IACrC,CAAC;AAED,MAAM,0BAA0B;IAC9B,MAAM,EAAE,YAAY,EAAE,GAAG,wJAAkB,CAAC,QAAQ;IACpD,MAAM,aAAa,OAAO,OAAO,CAAC,cAC/B,MAAM,CAAC,CAAC,GAAG,SAAS,GAAK,QAAQ,WACjC,GAAG,CAAC,CAAC,CAAC,SAAS,GAAK,UACpB,IAAI,GACJ,OAAO;IACV,OAAO,UAAU,CAAC,EAAE;AACtB;AAEO,MAAM,4BAA4B;IACvC,aAAY,EAAE,QAAQ,EAAE,gBAAgB,EAAiB;QACvD,MAAM,QAAQ,wJAAkB,CAAC,QAAQ;QACzC,MAAM,YAAY,MAAM,cAAc,CAAC,SAAS;QAChD,IAAI,CAAC,WAAW,QAAQ;YACtB,OAAO;QACT;QACA,MAAM,YAAY,UAAU,IAAI,CAAC,CAAC,MAAQ,IAAI,gBAAgB,KAAK;QACnE,IAAI,CAAC,WAAW;YACd,OAAO;QACT;QACA,MAAM,SAAS,QAAQ,MAAM,YAAY,CAAC,SAAS;QACnD,OAAO,cAAc,WAAW;YAAE;YAAU;QAAiB,GAAG;IAClE;IACA,yBAAwB,gBAA0B;QAChD,MAAM,kBAAkB;QACxB,IAAI,CAAC,iBAAiB;YACpB,OAAO;QACT;QACA,OAAO,IAAI,CAAC,WAAW,CAAC;YAAE,UAAU;YAAiB;QAAiB;IACxE;AACF"}},
    {"offset": {"line": 776, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/lib/print-service.ts"],"sourcesContent":["import { usePrintTemplateStore } from '@/features/settings/printer/store';\r\nimport { TemplateType, PaperSize } from '@/features/settings/printer/types';\r\nimport { formatDateForDisplay, formatTimeForDisplay, formatDateTimeForDisplay } from '@/lib/date-utils';\r\nimport { getGeneralSettingsSync } from '@/lib/settings-cache';\r\n\r\n// ============================================\r\n// HELPER FUNCTIONS\r\n// ============================================\r\n\r\n/**\r\n * Lấy general-settings từ cache (loaded from database)\r\n */\r\nexport function getGeneralSettings(): {\r\n  companyName?: string;\r\n  companyAddress?: string;\r\n  phoneNumber?: string;\r\n  email?: string;\r\n  website?: string;\r\n  taxCode?: string;\r\n  logoUrl?: string;\r\n  storeName?: string;\r\n  storeAddress?: string;\r\n  storePhone?: string;\r\n} | null {\r\n  try {\r\n    const settings = getGeneralSettingsSync();\r\n    return {\r\n      companyName: settings.storeName,\r\n      companyAddress: settings.storeAddress,\r\n      phoneNumber: settings.storePhone,\r\n      storeName: settings.storeName,\r\n      storeAddress: settings.storeAddress,\r\n      storePhone: settings.storePhone,\r\n      logoUrl: settings.logoUrl,\r\n    };\r\n  } catch (e) { /* ignore */ }\r\n  return null;\r\n}\r\n\r\n/**\r\n * Lấy logo từ general-settings (fallback khi storeInfo không có logo)\r\n */\r\nexport function getStoreLogo(storeInfoLogo?: string): string | undefined {\r\n  if (storeInfoLogo) return storeInfoLogo;\r\n  try {\r\n    const settings = getGeneralSettingsSync();\r\n    return settings.logoUrl || undefined;\r\n  } catch (e) { /* ignore */ }\r\n  return undefined;\r\n}\r\n\r\n/**\r\n * Format số tiền theo định dạng VN\r\n */\r\nexport function formatCurrency(amount: number | undefined | null): string {\r\n  if (amount === undefined || amount === null) return '0';\r\n  return new Intl.NumberFormat('vi-VN').format(amount);\r\n}\r\n\r\n/**\r\n * Chuyển số sang chữ tiếng Việt\r\n */\r\nexport function numberToWords(amount: number | undefined | null): string {\r\n  if (!amount || amount === 0) return 'Không đồng';\r\n  \r\n  const units = ['', 'một', 'hai', 'ba', 'bốn', 'năm', 'sáu', 'bảy', 'tám', 'chín'];\r\n  const positions = ['', 'nghìn', 'triệu', 'tỷ', 'nghìn tỷ', 'triệu tỷ'];\r\n  \r\n  const readThreeDigits = (num: number): string => {\r\n    const hundred = Math.floor(num / 100);\r\n    const ten = Math.floor((num % 100) / 10);\r\n    const unit = num % 10;\r\n    \r\n    let result = '';\r\n    \r\n    if (hundred > 0) {\r\n      result += units[hundred] + ' trăm ';\r\n    }\r\n    \r\n    if (ten > 1) {\r\n      result += units[ten] + ' mươi ';\r\n      if (unit === 1) {\r\n        result += 'mốt ';\r\n      } else if (unit === 5) {\r\n        result += 'lăm ';\r\n      } else if (unit > 0) {\r\n        result += units[unit] + ' ';\r\n      }\r\n    } else if (ten === 1) {\r\n      result += 'mười ';\r\n      if (unit === 5) {\r\n        result += 'lăm ';\r\n      } else if (unit > 0) {\r\n        result += units[unit] + ' ';\r\n      }\r\n    } else if (ten === 0 && hundred > 0 && unit > 0) {\r\n      result += 'lẻ ' + units[unit] + ' ';\r\n    } else if (unit > 0) {\r\n      result += units[unit] + ' ';\r\n    }\r\n    \r\n    return result.trim();\r\n  };\r\n  \r\n  let result = '';\r\n  let num = Math.abs(Math.round(amount));\r\n  let posIndex = 0;\r\n  \r\n  while (num > 0) {\r\n    const threeDigits = num % 1000;\r\n    if (threeDigits > 0) {\r\n      const words = readThreeDigits(threeDigits);\r\n      result = words + ' ' + positions[posIndex] + ' ' + result;\r\n    }\r\n    num = Math.floor(num / 1000);\r\n    posIndex++;\r\n  }\r\n  \r\n  result = result.trim();\r\n  // Capitalize first letter\r\n  result = result.charAt(0).toUpperCase() + result.slice(1) + ' đồng';\r\n  \r\n  if (amount < 0) {\r\n    result = 'Âm ' + result;\r\n  }\r\n  \r\n  return result;\r\n}\r\n\r\n/**\r\n * Format ngày theo định dạng dd/MM/yyyy\r\n * Uses centralized date-utils for consistent formatting\r\n */\r\nexport function formatDate(date: string | Date | undefined | null): string {\r\n  return formatDateForDisplay(date);\r\n}\r\n\r\n/**\r\n * Format giờ theo định dạng HH:mm\r\n * Uses centralized date-utils for consistent formatting\r\n */\r\nexport function formatTime(date: string | Date | undefined | null): string {\r\n  return formatTimeForDisplay(date);\r\n}\r\n\r\n/**\r\n * Format ngày giờ đầy đủ\r\n * Uses centralized date-utils for consistent formatting\r\n */\r\nexport function formatDateTime(date: string | Date | undefined | null): string {\r\n  return formatDateTimeForDisplay(date);\r\n}\r\n\r\n// ============================================\r\n// PRINT SERVICE\r\n// ============================================\r\n\r\n/**\r\n * CSS styles cho in ấn\r\n */\r\nconst PRINT_STYLES = `\r\n  * { box-sizing: border-box; }\r\n  body { \r\n    font-family: 'Times New Roman', Times, serif;\r\n    font-size: 13px;\r\n    line-height: 1.5;\r\n    margin: 0;\r\n    padding: 20px;\r\n    color: #000;\r\n  }\r\n  h1, h2, h3, h4 { margin: 0.5em 0; }\r\n  h2 { font-size: 18px; font-weight: bold; }\r\n  p { margin: 0.3em 0; }\r\n  table { \r\n    width: 100%; \r\n    border-collapse: collapse; \r\n    margin: 10px 0;\r\n  }\r\n  th, td { \r\n    border: 1px solid #333; \r\n    padding: 6px 8px; \r\n    text-align: left;\r\n    vertical-align: top;\r\n  }\r\n  th { \r\n    background: #f0f0f0; \r\n    font-weight: bold;\r\n  }\r\n  strong { font-weight: bold; }\r\n  em { font-style: italic; }\r\n  hr { border: none; border-top: 1px solid #333; margin: 10px 0; }\r\n  ul { margin: 0.5em 0; padding-left: 25px; list-style-type: disc; }\r\n  ol { margin: 0.5em 0; padding-left: 25px; list-style-type: decimal; }\r\n  li { margin: 0.2em 0; display: list-item; }\r\n  img { max-width: 100%; height: auto; }\r\n  @media print { \r\n    body { padding: 0; } \r\n    @page { margin: 15mm; }\r\n  }\r\n`;\r\n\r\n/**\r\n * Interface cho dữ liệu in\r\n */\r\nexport interface PrintData {\r\n  [key: string]: string | number | boolean | undefined | null | PrintLineItem[];\r\n}\r\n\r\nexport interface PrintLineItem {\r\n  [key: string]: string | number | boolean | undefined | null;\r\n}\r\n\r\n/**\r\n * Replace tất cả variables trong template với data\r\n */\r\nexport function replaceVariables(template: string, data: PrintData): string {\r\n  let result = template;\r\n  \r\n  // Replace các biến đơn lẻ\r\n  Object.entries(data).forEach(([key, value]) => {\r\n    // Nếu không phải array (line items), replace trực tiếp\r\n    if (!Array.isArray(value)) {\r\n      const placeholder = key.startsWith('{') ? key : `{${key}}`;\r\n      const stringValue = value?.toString() || '';\r\n      result = result.split(placeholder).join(stringValue);\r\n    }\r\n  });\r\n  \r\n  return result;\r\n}\r\n\r\n/**\r\n * Tạo HTML rows cho line items (sản phẩm trong đơn hàng)\r\n * Template row sẽ được nhân bản cho mỗi item\r\n */\r\nexport function generateLineItemsHtml(\r\n  templateRow: string, \r\n  items: PrintLineItem[],\r\n  startIndex: number = 1\r\n): string {\r\n  return items.map((item, index) => {\r\n    let row = templateRow;\r\n    \r\n    // Replace {line_stt} với số thứ tự\r\n    row = row.replace(/{line_stt}/g, (startIndex + index).toString());\r\n    \r\n    // Replace các biến line_* khác\r\n    Object.entries(item).forEach(([key, value]) => {\r\n      const placeholder = key.startsWith('{') ? key : `{${key}}`;\r\n      const stringValue = value?.toString() || '';\r\n      row = row.split(placeholder).join(stringValue);\r\n    });\r\n    \r\n    return row;\r\n  }).join('\\n');\r\n}\r\n\r\n/**\r\n * Tạo nội dung HTML để in từ template và data\r\n */\r\nexport function generatePrintHtml(\r\n  templateType: TemplateType,\r\n  data: PrintData,\r\n  branchId?: string\r\n): string {\r\n  const store = usePrintTemplateStore.getState();\r\n  const defaultSize = store.getDefaultSize(templateType);\r\n  const template = store.getTemplate(templateType, defaultSize, branchId);\r\n  \r\n  let html = template.content;\r\n  \r\n  // Replace variables\r\n  html = replaceVariables(html, data);\r\n  \r\n  return html;\r\n}\r\n\r\n/**\r\n * In document với template\r\n */\r\nexport function printDocument(\r\n  templateType: TemplateType,\r\n  data: PrintData,\r\n  options?: {\r\n    branchId?: string;\r\n    paperSize?: PaperSize;\r\n    title?: string;\r\n  }\r\n): void {\r\n  const store = usePrintTemplateStore.getState();\r\n  const paperSize = options?.paperSize || store.getDefaultSize(templateType);\r\n  const template = store.getTemplate(templateType, paperSize, options?.branchId);\r\n  \r\n  // Generate HTML content\r\n  let html = replaceVariables(template.content, data);\r\n  \r\n  // Tạo iframe ẩn để in\r\n  const printFrame = document.createElement('iframe');\r\n  printFrame.style.position = 'absolute';\r\n  printFrame.style.top = '-10000px';\r\n  printFrame.style.left = '-10000px';\r\n  document.body.appendChild(printFrame);\r\n  \r\n  const printDoc = printFrame.contentDocument || printFrame.contentWindow?.document;\r\n  if (printDoc) {\r\n    const title = options?.title || `In ${templateType}`;\r\n    \r\n    printDoc.write(`\r\n      <!DOCTYPE html>\r\n      <html>\r\n      <head>\r\n        <title>${title}</title>\r\n        <style>${PRINT_STYLES}</style>\r\n      </head>\r\n      <body>${html}</body>\r\n      </html>\r\n    `);\r\n    printDoc.close();\r\n    \r\n    // Đợi load xong rồi in\r\n    setTimeout(() => {\r\n      printFrame.contentWindow?.print();\r\n      // Xóa iframe sau khi in\r\n      setTimeout(() => {\r\n        if (document.body.contains(printFrame)) {\r\n          document.body.removeChild(printFrame);\r\n        }\r\n      }, 1000);\r\n    }, 100);\r\n  }\r\n}\r\n\r\n/**\r\n * Preview document (trả về HTML string)\r\n */\r\nexport function getPreviewHtml(\r\n  templateType: TemplateType,\r\n  data: PrintData,\r\n  options?: {\r\n    branchId?: string;\r\n    paperSize?: PaperSize;\r\n  }\r\n): string {\r\n  const store = usePrintTemplateStore.getState();\r\n  const paperSize = options?.paperSize || store.getDefaultSize(templateType);\r\n  const template = store.getTemplate(templateType, paperSize, options?.branchId);\r\n  \r\n  return replaceVariables(template.content, data);\r\n}\r\n\r\n// ============================================\r\n// DATA MAPPERS - Chuyển đổi data từ entity sang print data\r\n// ============================================\r\n\r\n/**\r\n * Base interface cho store settings (cần import từ settings store)\r\n */\r\nexport interface StoreSettings {\r\n  name?: string;\r\n  address?: string;\r\n  phone?: string;\r\n  hotline?: string;\r\n  email?: string;\r\n  logo?: string;\r\n  fax?: string;\r\n  province?: string;\r\n  website?: string;\r\n  taxCode?: string;\r\n}\r\n\r\n/**\r\n * Tạo data cho thông tin cửa hàng\r\n */\r\nexport function getStoreData(settings: StoreSettings): PrintData {\r\n  const now = new Date();\r\n  const logo = getStoreLogo(settings.logo);\r\n  return {\r\n    '{store_logo}': logo \r\n      ? `<img src=\"${logo}\" alt=\"Logo\" style=\"max-height:60px\"/>` \r\n      : '',\r\n    '{store_name}': settings.name || '',\r\n    '{store_address}': settings.address || '',\r\n    '{store_phone_number}': settings.phone || '',\r\n    '{hotline}': settings.hotline || settings.phone || '',\r\n    '{store_hotline}': settings.hotline || settings.phone || '',\r\n    '{store_email}': settings.email || '',\r\n    '{store_fax}': settings.fax || '',\r\n    '{store_website}': settings.website || '',\r\n    '{store_tax_code}': settings.taxCode || '',\r\n    // Print timestamp - always inject current time\r\n    '{print_date}': formatDate(now),\r\n    '{print_time}': formatTime(now),\r\n  };\r\n}\r\n\r\n/**\r\n * Export default cho tiện import\r\n */\r\nexport const PrintService = {\r\n  formatCurrency,\r\n  numberToWords,\r\n  formatDate,\r\n  formatTime,\r\n  formatDateTime,\r\n  replaceVariables,\r\n  generateLineItemsHtml,\r\n  generatePrintHtml,\r\n  printDocument,\r\n  getPreviewHtml,\r\n  getStoreData,\r\n  getStoreLogo,\r\n};\r\n\r\nexport default PrintService;\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1089, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/lib/use-print.ts"],"sourcesContent":["/**\r\n * Hook để sử dụng Print Service trong các component\r\n */\r\n\r\nimport * as React from 'react';\r\nimport type { TemplateType, PaperSize } from '../features/settings/printer/types';\r\nimport { \r\n  PrintData, \r\n  PrintLineItem,\r\n  replaceVariables,\r\n} from './print-service';\r\nimport { usePrintTemplateStore } from '../features/settings/printer/store';\r\n\r\ninterface PrintOptions {\r\n  /** Dữ liệu để thay thế biến trong template */\r\n  data: PrintData;\r\n  /** Line items (sản phẩm, hàng hóa) */\r\n  lineItems?: PrintLineItem[];\r\n  /** Khổ giấy cụ thể (nếu muốn override default) */\r\n  paperSize?: PaperSize;\r\n  /** Branch ID cụ thể (nếu muốn override current branch) */\r\n  branchId?: string;\r\n}\r\n\r\ninterface UsePrintResult {\r\n  /** Hàm in tài liệu */\r\n  print: (type: TemplateType, options: PrintOptions) => void;\r\n  /** Hàm in nhiều tài liệu cùng lúc (gộp thành 1 document) */\r\n  printMultiple: (type: TemplateType, optionsList: PrintOptions[]) => void;\r\n  /** Hàm in nhiều loại tài liệu khác nhau cùng lúc (gộp thành 1 popup) */\r\n  printMixedDocuments: (documents: Array<{ type: TemplateType; options: PrintOptions }>) => void;\r\n  /** Hàm lấy HTML preview */\r\n  getPreview: (type: TemplateType, options: PrintOptions) => string;\r\n  /** Kiểm tra template có tồn tại không */\r\n  hasTemplate: (type: TemplateType, paperSize?: PaperSize) => boolean;\r\n  /** Lấy danh sách khổ giấy có template */\r\n  getAvailableSizes: (type: TemplateType) => PaperSize[];\r\n  /** Lấy khổ giấy mặc định cho loại template */\r\n  getDefaultSize: (type: TemplateType) => PaperSize;\r\n  /** Đang loading template store */\r\n  isLoading: boolean;\r\n}\r\n\r\n/**\r\n * Kiểm tra giá trị có \"empty\" không (null, undefined, '', '0', 0)\r\n */\r\nfunction isEmptyValue(value: unknown): boolean {\r\n  if (value === undefined || value === null || value === '') return true;\r\n  // Coi '0' và các biến thể như empty\r\n  const strValue = String(value).trim();\r\n  if (strValue === '0' || strValue === '0đ' || strValue === '0 đ') return true;\r\n  return false;\r\n}\r\n\r\n/**\r\n * Xử lý các điều kiện trong template\r\n * Hỗ trợ:\r\n * - {{#if has_tax}}...{{/if}} - Điều kiện boolean\r\n * - {{#if_empty {field}}}...{{/if_empty}} - Nếu field rỗng\r\n * - {{#if_not_empty {field}}}...{{/if_not_empty}} - Nếu field không rỗng\r\n * - {{#if_gt {field} value}}...{{/if_gt}} - Nếu field > value (greater than)\r\n */\r\nfunction processConditionals(html: string, data: PrintData, lineItems?: PrintLineItem[]): string {\r\n  let result = html;\r\n\r\n  // 1. Xử lý {{#if_not_empty {field}}}...{{/if_not_empty}}\r\n  const ifNotEmptyPattern = /\\{\\{#if_not_empty\\s+\\{([^}]+)\\}\\}\\}([\\s\\S]*?)\\{\\{\\/if_not_empty\\}\\}/gi;\r\n  result = result.replace(ifNotEmptyPattern, (match, field, content) => {\r\n    const key = `{${field}}`;\r\n    const value = data[key];\r\n    if (!isEmptyValue(value)) {\r\n      return content;\r\n    }\r\n    return '';\r\n  });\r\n\r\n  // 2. Xử lý {{#if_empty {field}}}...{{/if_empty}}\r\n  const ifEmptyPattern = /\\{\\{#if_empty\\s+\\{([^}]+)\\}\\}\\}([\\s\\S]*?)\\{\\{\\/if_empty\\}\\}/gi;\r\n  result = result.replace(ifEmptyPattern, (match, field, content) => {\r\n    const key = `{${field}}`;\r\n    const value = data[key];\r\n    if (isEmptyValue(value)) {\r\n      return content;\r\n    }\r\n    return '';\r\n  });\r\n\r\n  // 3. Xử lý {{#if_gt {field} value}}...{{/if_gt}} (greater than 0)\r\n  const ifGtPattern = /\\{\\{#if_gt\\s+\\{([^}]+)\\}\\s+(\\d+)\\}\\}([\\s\\S]*?)\\{\\{\\/if_gt\\}\\}/gi;\r\n  result = result.replace(ifGtPattern, (match, field, compareValue, content) => {\r\n    const key = `{${field}}`;\r\n    const value = data[key];\r\n    // Parse số từ giá trị (loại bỏ dấu chấm, đ, etc.)\r\n    const numValue = parseFloat((value || '0').toString().replace(/[^\\d.-]/g, ''));\r\n    const numCompare = parseFloat(compareValue);\r\n    if (numValue > numCompare) {\r\n      return content;\r\n    }\r\n    return '';\r\n  });\r\n\r\n  // 4. Xử lý {{#if has_tax}}...{{/if}} - Boolean conditions\r\n  // has_tax = true nếu total_tax > 0\r\n  const hasTax = !isEmptyValue(data['{total_tax}']);\r\n  const hasDiscount = !isEmptyValue(data['{total_discount}']);\r\n  const hasDeliveryFee = !isEmptyValue(data['{delivery_fee}']);\r\n  const hasNote = !isEmptyValue(data['{order_note}']);\r\n\r\n  const booleanConditions: Record<string, boolean> = {\r\n    'has_tax': hasTax,\r\n    'has_discount': hasDiscount,\r\n    'has_delivery_fee': hasDeliveryFee,\r\n    'has_note': hasNote,\r\n    'has_shipping_address': !isEmptyValue(data['{shipping_address}']),\r\n    'has_customer_email': !isEmptyValue(data['{customer_email}']),\r\n    'has_customer_phone': !isEmptyValue(data['{customer_phone_number}']),\r\n  };\r\n\r\n  // Xử lý {{#if condition}}...{{/if}}\r\n  const ifPattern = /\\{\\{#if\\s+(\\w+)\\}\\}([\\s\\S]*?)\\{\\{\\/if\\}\\}/gi;\r\n  result = result.replace(ifPattern, (match, condition, content) => {\r\n    if (booleanConditions[condition]) {\r\n      return content;\r\n    }\r\n    return '';\r\n  });\r\n\r\n  // 5. Xử lý {{#unless condition}}...{{/unless}} (ngược lại với if)\r\n  const unlessPattern = /\\{\\{#unless\\s+(\\w+)\\}\\}([\\s\\S]*?)\\{\\{\\/unless\\}\\}/gi;\r\n  result = result.replace(unlessPattern, (match, condition, content) => {\r\n    if (!booleanConditions[condition]) {\r\n      return content;\r\n    }\r\n    return '';\r\n  });\r\n\r\n  return result;\r\n}\r\n\r\n/**\r\n * Xử lý điều kiện cho line items\r\n * Ví dụ: {{#line_if_not_empty {line_tax_amount}}}...{{/line_if_not_empty}}\r\n */\r\nfunction processLineItemConditionals(rowHtml: string, item: PrintLineItem): string {\r\n  let result = rowHtml;\r\n\r\n  // Xử lý {{#line_if_not_empty {field}}}...{{/line_if_not_empty}}\r\n  const lineIfNotEmptyPattern = /\\{\\{#line_if_not_empty\\s+\\{([^}]+)\\}\\}\\}([\\s\\S]*?)\\{\\{\\/line_if_not_empty\\}\\}/gi;\r\n  result = result.replace(lineIfNotEmptyPattern, (match, field, content) => {\r\n    const key = `{${field}}`;\r\n    const value = item[key];\r\n    if (!isEmptyValue(value)) {\r\n      return content;\r\n    }\r\n    return '';\r\n  });\r\n\r\n  // Xử lý {{#line_if_empty {field}}}...{{/line_if_empty}}\r\n  const lineIfEmptyPattern = /\\{\\{#line_if_empty\\s+\\{([^}]+)\\}\\}\\}([\\s\\S]*?)\\{\\{\\/line_if_empty\\}\\}/gi;\r\n  result = result.replace(lineIfEmptyPattern, (match, field, content) => {\r\n    const key = `{${field}}`;\r\n    const value = item[key];\r\n    if (isEmptyValue(value)) {\r\n      return content;\r\n    }\r\n    return '';\r\n  });\r\n\r\n  return result;\r\n}\r\n\r\n/**\r\n * Hook để sử dụng chức năng in trong các trang\r\n * @param currentBranchId - ID của branch hiện tại (optional)\r\n * @example\r\n * const { print, getPreview } = usePrint(currentBranch?.systemId);\r\n * \r\n * // In đơn hàng\r\n * print('order', {\r\n *   data: mapOrderToPrintData(order, storeSettings),\r\n *   lineItems: mapOrderLineItems(order.items),\r\n * });\r\n */\r\nexport function usePrint(currentBranchId?: string): UsePrintResult {\r\n  const templateStore = usePrintTemplateStore();\r\n  const [isLoading] = React.useState(false);\r\n\r\n  const getTemplateContent = React.useCallback((\r\n    type: TemplateType, \r\n    paperSize?: PaperSize, \r\n    branchId?: string\r\n  ): string | null => {\r\n    // Xác định paperSize sử dụng\r\n    const size = paperSize || templateStore.getDefaultSize(type);\r\n    const branch = branchId || currentBranchId;\r\n\r\n    // Lấy template\r\n    const template = templateStore.getTemplate(type, size, branch);\r\n    if (template?.content) {\r\n      return template.content;\r\n    }\r\n\r\n    // Fallback: thử lấy template không có branch\r\n    const defaultTemplate = templateStore.getTemplate(type, size);\r\n    return defaultTemplate?.content || null;\r\n  }, [templateStore, currentBranchId]);\r\n\r\n  const processTemplate = React.useCallback((\r\n    templateContent: string,\r\n    data: PrintData,\r\n    lineItems?: PrintLineItem[]\r\n  ): string => {\r\n    // Bước 1: Xử lý line items nếu có\r\n    let html = templateContent;\r\n    \r\n    console.log('[processTemplate] Starting, lineItems count:', lineItems?.length);\r\n    \r\n    if (lineItems && lineItems.length > 0) {\r\n      // === XỬ LÝ CÚ PHÁP {{#line_items}}...{{/line_items}} ===\r\n      // Dành cho template lặp toàn bộ section (mỗi employee 1 page)\r\n      const lineItemsBlockPattern = /\\{\\{#line_items\\}\\}([\\s\\S]*?)\\{\\{\\/line_items\\}\\}/gi;\r\n      const lineItemsBlockMatch = html.match(lineItemsBlockPattern);\r\n      \r\n      console.log('[processTemplate] Block match found:', !!lineItemsBlockMatch, lineItemsBlockMatch?.length);\r\n      \r\n      if (lineItemsBlockMatch && lineItemsBlockMatch.length > 0) {\r\n        // Có block {{#line_items}} - lặp cả block cho mỗi item\r\n        html = html.replace(lineItemsBlockPattern, (match, blockContent) => {\r\n          return lineItems.map((item, index) => {\r\n            let itemHtml = blockContent;\r\n            \r\n            // Thêm {line_index}\r\n            itemHtml = itemHtml.replace(/\\{line_index\\}/g, String(index + 1));\r\n            \r\n            // Replace các biến từ item (line item data)\r\n            Object.entries(item).forEach(([key, value]) => {\r\n              const placeholder = key.startsWith('{') ? key : `{${key}}`;\r\n              const regex = new RegExp(placeholder.replace(/[{}]/g, '\\\\$&'), 'g');\r\n              itemHtml = itemHtml.replace(regex, value?.toString() || '');\r\n            });\r\n            \r\n            // Replace các biến global (data) cho mỗi item page\r\n            Object.entries(data).forEach(([key, value]) => {\r\n              const placeholder = key.startsWith('{') ? key : `{${key}}`;\r\n              const regex = new RegExp(placeholder.replace(/[{}]/g, '\\\\$&'), 'g');\r\n              itemHtml = itemHtml.replace(regex, value?.toString() || '');\r\n            });\r\n            \r\n            return itemHtml;\r\n          }).join('\\n');\r\n        });\r\n        \r\n        // Đã xử lý xong line items theo block mode, skip table mode\r\n      } else {\r\n        // === XỬ LÝ TABLE MODE (cũ) ===\r\n        // Tìm tất cả các table trong template\r\n        const tablePattern = /<table[^>]*>[\\s\\S]*?<\\/table>/gi;\r\n        const tables = html.match(tablePattern);\r\n      \r\n        if (tables) {\r\n          // Tìm table chứa {line_stt} - đây là bảng line items\r\n          const lineItemsTable = tables.find(table => table.includes('{line_stt}'));\r\n        \r\n          if (lineItemsTable) {\r\n            // Tìm tbody trong table này\r\n            let tbodyMatch = lineItemsTable.match(/<tbody[^>]*>([\\s\\S]*?)<\\/tbody>/i);\r\n          \r\n            // Nếu không có tbody, có thể table chỉ có tr trực tiếp\r\n            // (một số template không dùng thead/tbody)\r\n            if (!tbodyMatch) {\r\n              // Tìm tất cả tr trong table (trừ tr trong thead)\r\n              const theadMatch = lineItemsTable.match(/<thead[^>]*>[\\s\\S]*?<\\/thead>/i);\r\n              let tableWithoutThead = lineItemsTable;\r\n              if (theadMatch) {\r\n                tableWithoutThead = lineItemsTable.replace(theadMatch[0], '');\r\n              }\r\n            \r\n              // Tìm tr chứa {line_stt}\r\n              const rowPattern = /<tr[^>]*>[\\s\\S]*?\\{line_stt\\}[\\s\\S]*?<\\/tr>/i;\r\n              const rowMatch = tableWithoutThead.match(rowPattern);\r\n            \r\n              if (rowMatch) {\r\n                const templateRow = rowMatch[0];\r\n              \r\n                // Tạo các row mới từ template\r\n                const rowsHtml = lineItems.map((item) => {\r\n                  let row = templateRow;\r\n                \r\n                  // Xử lý điều kiện cho line item trước\r\n                  row = processLineItemConditionals(row, item);\r\n                \r\n                  Object.entries(item).forEach(([key, value]) => {\r\n                    const placeholder = key.startsWith('{') ? key : `{${key}}`;\r\n                    const regex = new RegExp(placeholder.replace(/[{}]/g, '\\\\$&'), 'g');\r\n                    row = row.replace(regex, value?.toString() || '');\r\n                  });\r\n                  return row;\r\n                }).join('\\n    ');\r\n              \r\n                // Thay thế row mẫu bằng các rows mới\r\n                const newTable = lineItemsTable.replace(templateRow, rowsHtml);\r\n                html = html.replace(lineItemsTable, newTable);\r\n              }\r\n            } else {\r\n              // Có tbody - xử lý như cũ\r\n              const tbodyContent = tbodyMatch[1];\r\n            \r\n              // Tìm TẤT CẢ các row trong tbody\r\n              const allRowsPattern = /<tr[^>]*>[\\s\\S]*?<\\/tr>/gi;\r\n              const allRows = tbodyContent.match(allRowsPattern);\r\n            \r\n              if (allRows && allRows.length > 0) {\r\n                // Tìm row chứa {line_stt} - đây là row mẫu\r\n                const templateRow = allRows.find(row => row.includes('{line_stt}')) || allRows[0];\r\n              \r\n                // Tạo các row mới từ template\r\n                const rowsHtml = lineItems.map((item) => {\r\n                  let row = templateRow;\r\n                \r\n                  // Xử lý điều kiện cho line item trước\r\n                  row = processLineItemConditionals(row, item);\r\n                \r\n                  // Replace từng biến trong item\r\n                  Object.entries(item).forEach(([key, value]) => {\r\n                    const placeholder = key.startsWith('{') ? key : `{${key}}`;\r\n                    const regex = new RegExp(placeholder.replace(/[{}]/g, '\\\\$&'), 'g');\r\n                    row = row.replace(regex, value?.toString() || '');\r\n                  });\r\n                \r\n                  return row;\r\n                }).join('\\n    ');\r\n              \r\n                // Tạo tbody mới\r\n                const newTbody = `<tbody>\\n    ${rowsHtml}\\n  </tbody>`;\r\n              \r\n                // Thay thế tbody cũ trong table\r\n                const newTable = lineItemsTable.replace(tbodyMatch[0], newTbody);\r\n              \r\n                // Thay thế table cũ bằng table mới trong html\r\n                html = html.replace(lineItemsTable, newTable);\r\n              }\r\n            }\r\n          }\r\n        }\r\n      } // End of else (TABLE MODE)\r\n    }\r\n\r\n    // Bước 2: Xử lý các điều kiện (conditionals)\r\n    html = processConditionals(html, data, lineItems);\r\n\r\n    // Bước 3: Thay thế các biến còn lại\r\n    html = replaceVariables(html, data);\r\n\r\n    return html;\r\n  }, []);\r\n\r\n  const print = React.useCallback((type: TemplateType, options: PrintOptions) => {\r\n    const { data, lineItems, paperSize, branchId } = options;\r\n\r\n    console.log('[usePrint] Starting print for type:', type);\r\n    console.log('[usePrint] Data keys:', Object.keys(data));\r\n    console.log('[usePrint] LineItems count:', lineItems?.length || 0);\r\n\r\n    // Lấy template content\r\n    const size = paperSize || templateStore.getDefaultSize(type);\r\n    const templateContent = getTemplateContent(type, size, branchId);\r\n    \r\n    if (!templateContent) {\r\n      console.error(`[usePrint] No template found for type: ${type}`);\r\n      return;\r\n    }\r\n\r\n    console.log('[usePrint] Template found, length:', templateContent.length);\r\n\r\n    // Xử lý template\r\n    let html: string;\r\n    try {\r\n      html = processTemplate(templateContent, data, lineItems);\r\n      console.log('[usePrint] Template processed, html length:', html.length);\r\n    } catch (err) {\r\n      console.error('[usePrint] Error processing template:', err);\r\n      return;\r\n    }\r\n\r\n    // Tạo iframe ẩn để in\r\n    const printFrame = document.createElement('iframe');\r\n    printFrame.style.position = 'absolute';\r\n    printFrame.style.top = '-10000px';\r\n    printFrame.style.left = '-10000px';\r\n    document.body.appendChild(printFrame);\r\n    \r\n    const printDoc = printFrame.contentDocument || printFrame.contentWindow?.document;\r\n    if (printDoc) {\r\n      // CSS cơ bản cho print - giống với Settings preview\r\n      const printCSS = `\r\n        body { font-family: Arial, sans-serif; font-size: 12px; line-height: 1.5; }\r\n        table { width: 100%; border-collapse: collapse; margin: 8px 0; }\r\n        th, td { border: 1px solid #333; padding: 6px 8px; }\r\n        th { background-color: #f5f5f5; font-weight: bold; }\r\n        .text-center, [style*=\"text-align: center\"] { text-align: center; }\r\n        .text-right, [style*=\"text-align: right\"] { text-align: right; }\r\n        img { max-width: 100%; height: auto; }\r\n        h1, h2, h3 { margin: 8px 0; }\r\n        p { margin: 4px 0; }\r\n      `;\r\n      \r\n      printDoc.write(`\r\n        <!DOCTYPE html>\r\n        <html>\r\n        <head>\r\n          <title>In ${type}</title>\r\n          <style>${printCSS}</style>\r\n        </head>\r\n        <body>${html}</body>\r\n        </html>\r\n      `);\r\n      printDoc.close();\r\n      \r\n      // Đợi load xong rồi in\r\n      setTimeout(() => {\r\n        printFrame.contentWindow?.print();\r\n        // Xóa iframe sau khi in\r\n        setTimeout(() => {\r\n          if (document.body.contains(printFrame)) {\r\n            document.body.removeChild(printFrame);\r\n          }\r\n        }, 1000);\r\n      }, 100);\r\n    }\r\n  }, [getTemplateContent, processTemplate]);\r\n\r\n  /**\r\n   * In nhiều tài liệu cùng lúc - gộp thành 1 document với page break giữa các tài liệu\r\n   */\r\n  const printMultiple = React.useCallback((type: TemplateType, optionsList: PrintOptions[]) => {\r\n    if (optionsList.length === 0) return;\r\n\r\n    // Lấy template content (dùng paperSize của item đầu tiên hoặc default)\r\n    const firstOptions = optionsList[0];\r\n    const size = firstOptions.paperSize || templateStore.getDefaultSize(type);\r\n    const templateContent = getTemplateContent(type, size, firstOptions.branchId);\r\n    \r\n    if (!templateContent) {\r\n      console.error(`[usePrint] No template found for type: ${type}`);\r\n      return;\r\n    }\r\n\r\n    // Xử lý từng document và gộp lại với page break\r\n    const allHtmlParts = optionsList.map((options, index) => {\r\n      const html = processTemplate(templateContent, options.data, options.lineItems);\r\n      // Thêm page break sau mỗi document (trừ document cuối)\r\n      if (index < optionsList.length - 1) {\r\n        return `<div class=\"print-page\" style=\"page-break-after: always; break-after: page;\">${html}</div>`;\r\n      }\r\n      return `<div class=\"print-page-last\">${html}</div>`;\r\n    });\r\n\r\n    const combinedHtml = allHtmlParts.join('\\n');\r\n\r\n    // Tạo iframe ẩn để in\r\n    const printFrame = document.createElement('iframe');\r\n    printFrame.style.position = 'absolute';\r\n    printFrame.style.top = '-10000px';\r\n    printFrame.style.left = '-10000px';\r\n    document.body.appendChild(printFrame);\r\n    \r\n    const printDoc = printFrame.contentDocument || printFrame.contentWindow?.document;\r\n    if (printDoc) {\r\n      // CSS cơ bản cho print với page break\r\n      const printCSS = `\r\n        * { box-sizing: border-box; }\r\n        body { font-family: Arial, sans-serif; font-size: 12px; line-height: 1.5; margin: 0; padding: 0; }\r\n        table { width: 100%; border-collapse: collapse; margin: 8px 0; }\r\n        th, td { border: 1px solid #333; padding: 6px 8px; }\r\n        th { background-color: #f5f5f5; font-weight: bold; }\r\n        .text-center, [style*=\"text-align: center\"] { text-align: center; }\r\n        .text-right, [style*=\"text-align: right\"] { text-align: right; }\r\n        img { max-width: 100%; height: auto; }\r\n        h1, h2, h3 { margin: 8px 0; }\r\n        p { margin: 4px 0; }\r\n        .print-page { \r\n          page-break-after: always !important; \r\n          break-after: page !important;\r\n          page-break-inside: avoid;\r\n        }\r\n        .print-page-last { \r\n          page-break-after: auto; \r\n        }\r\n        @media print {\r\n          .print-page { \r\n            page-break-after: always !important; \r\n            break-after: page !important;\r\n          }\r\n          .print-page-last { \r\n            page-break-after: auto; \r\n          }\r\n        }\r\n      `;\r\n      \r\n      printDoc.write(`\r\n        <!DOCTYPE html>\r\n        <html>\r\n        <head>\r\n          <title>In ${optionsList.length} ${type}</title>\r\n          <style>${printCSS}</style>\r\n        </head>\r\n        <body>${combinedHtml}</body>\r\n        </html>\r\n      `);\r\n      printDoc.close();\r\n      \r\n      // Đợi load xong rồi in\r\n      setTimeout(() => {\r\n        printFrame.contentWindow?.print();\r\n        // Xóa iframe sau khi in\r\n        setTimeout(() => {\r\n          if (document.body.contains(printFrame)) {\r\n            document.body.removeChild(printFrame);\r\n          }\r\n        }, 1000);\r\n      }, 100);\r\n    }\r\n  }, [templateStore, getTemplateContent, processTemplate]);\r\n\r\n  /**\r\n   * In nhiều loại tài liệu khác nhau cùng lúc - gộp thành 1 popup duy nhất\r\n   * Ví dụ: In đơn hàng + phiếu giao hàng + phiếu đóng gói trong 1 lần\r\n   */\r\n  const printMixedDocuments = React.useCallback((documents: Array<{ type: TemplateType; options: PrintOptions }>) => {\r\n    if (documents.length === 0) return;\r\n\r\n    // Xử lý từng document và gộp lại với page break\r\n    const allHtmlParts: string[] = [];\r\n    \r\n    documents.forEach((doc, docIndex) => {\r\n      const { type, options } = doc;\r\n      const { data, lineItems, paperSize, branchId } = options;\r\n      \r\n      // Lấy template content cho loại này\r\n      const size = paperSize || templateStore.getDefaultSize(type);\r\n      const templateContent = getTemplateContent(type, size, branchId);\r\n      \r\n      if (!templateContent) {\r\n        console.warn(`[printMixedDocuments] No template found for type: ${type}, skipping`);\r\n        return;\r\n      }\r\n      \r\n      const html = processTemplate(templateContent, data, lineItems);\r\n      \r\n      // Thêm page break sau mỗi document (trừ document cuối)\r\n      if (docIndex < documents.length - 1) {\r\n        allHtmlParts.push(`<div class=\"print-page\" style=\"page-break-after: always; break-after: page;\">${html}</div>`);\r\n      } else {\r\n        allHtmlParts.push(`<div class=\"print-page-last\">${html}</div>`);\r\n      }\r\n    });\r\n\r\n    if (allHtmlParts.length === 0) {\r\n      console.error('[printMixedDocuments] No documents to print');\r\n      return;\r\n    }\r\n\r\n    const combinedHtml = allHtmlParts.join('\\n');\r\n\r\n    // Tạo iframe ẩn để in\r\n    const printFrame = document.createElement('iframe');\r\n    printFrame.style.position = 'absolute';\r\n    printFrame.style.top = '-10000px';\r\n    printFrame.style.left = '-10000px';\r\n    document.body.appendChild(printFrame);\r\n    \r\n    const printDoc = printFrame.contentDocument || printFrame.contentWindow?.document;\r\n    if (printDoc) {\r\n      // CSS cơ bản cho print với page break\r\n      const printCSS = `\r\n        * { box-sizing: border-box; }\r\n        body { font-family: Arial, sans-serif; font-size: 12px; line-height: 1.5; margin: 0; padding: 0; }\r\n        table { width: 100%; border-collapse: collapse; margin: 8px 0; }\r\n        th, td { border: 1px solid #333; padding: 6px 8px; }\r\n        th { background-color: #f5f5f5; font-weight: bold; }\r\n        .text-center, [style*=\"text-align: center\"] { text-align: center; }\r\n        .text-right, [style*=\"text-align: right\"] { text-align: right; }\r\n        img { max-width: 100%; height: auto; }\r\n        h1, h2, h3 { margin: 8px 0; }\r\n        p { margin: 4px 0; }\r\n        .print-page { \r\n          page-break-after: always !important; \r\n          break-after: page !important;\r\n          page-break-inside: avoid;\r\n        }\r\n        .print-page-last { \r\n          page-break-after: auto; \r\n        }\r\n        @media print {\r\n          .print-page { \r\n            page-break-after: always !important; \r\n            break-after: page !important;\r\n          }\r\n          .print-page-last { \r\n            page-break-after: auto; \r\n          }\r\n        }\r\n      `;\r\n      \r\n      printDoc.write(`\r\n        <!DOCTYPE html>\r\n        <html>\r\n        <head>\r\n          <title>In ${documents.length} tài liệu</title>\r\n          <style>${printCSS}</style>\r\n        </head>\r\n        <body>${combinedHtml}</body>\r\n        </html>\r\n      `);\r\n      printDoc.close();\r\n      \r\n      // Đợi load xong rồi in\r\n      setTimeout(() => {\r\n        printFrame.contentWindow?.print();\r\n        // Xóa iframe sau khi in\r\n        setTimeout(() => {\r\n          if (document.body.contains(printFrame)) {\r\n            document.body.removeChild(printFrame);\r\n          }\r\n        }, 1000);\r\n      }, 100);\r\n    }\r\n  }, [templateStore, getTemplateContent, processTemplate]);\r\n\r\n  const getPreview = React.useCallback((type: TemplateType, options: PrintOptions): string => {\r\n    const { data, lineItems, paperSize, branchId } = options;\r\n\r\n    // Lấy template content\r\n    const templateContent = getTemplateContent(type, paperSize, branchId);\r\n    if (!templateContent) {\r\n      return '<p style=\"color: red;\">Không tìm thấy mẫu in</p>';\r\n    }\r\n\r\n    // Xử lý template\r\n    return processTemplate(templateContent, data, lineItems);\r\n  }, [getTemplateContent, processTemplate]);\r\n\r\n  const hasTemplate = React.useCallback((type: TemplateType, paperSize?: PaperSize): boolean => {\r\n    const size = paperSize || templateStore.getDefaultSize(type);\r\n    const template = templateStore.getTemplate(type, size, currentBranchId);\r\n    return !!template?.content;\r\n  }, [templateStore, currentBranchId]);\r\n\r\n  const getAvailableSizes = React.useCallback((type: TemplateType): PaperSize[] => {\r\n    const sizes: PaperSize[] = ['K57', 'K80', 'A4', 'A5'];\r\n    return sizes.filter(size => {\r\n      const template = templateStore.getTemplate(type, size, currentBranchId);\r\n      return !!template?.content;\r\n    });\r\n  }, [templateStore, currentBranchId]);\r\n\r\n  const getDefaultSize = React.useCallback((type: TemplateType): PaperSize => {\r\n    return templateStore.getDefaultSize(type);\r\n  }, [templateStore]);\r\n\r\n  return {\r\n    print,\r\n    printMultiple,\r\n    printMixedDocuments,\r\n    getPreview,\r\n    hasTemplate,\r\n    getAvailableSizes,\r\n    getDefaultSize,\r\n    isLoading,\r\n  };\r\n}\r\n\r\nexport type { PrintOptions, UsePrintResult };\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1717, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/lib/print-mappers/types.ts"],"sourcesContent":["/**\r\n * Print Mappers - Shared Types\r\n * Types và utilities dùng chung cho tất cả mappers\r\n */\r\n\r\nexport { \r\n  formatCurrency, \r\n  numberToWords, \r\n  formatDate, \r\n  formatTime,\r\n  getStoreData,\r\n} from '../print-service';\r\n\r\nexport type { \r\n  PrintData, \r\n  PrintLineItem, \r\n  StoreSettings\r\n} from '../print-service';\r\n\r\n/**\r\n * Helper: Ẩn 4 số giữa của SĐT\r\n * VD: 0912345678 -> 0912***678\r\n */\r\nexport const hidePhoneMiddle = (phone?: string): string => {\r\n  if (!phone || phone.length < 8) return phone || '';\r\n  return phone.slice(0, 4) + '***' + phone.slice(-3);\r\n};\r\n\r\n/**\r\n * Helper: Format ngày dạng chữ\r\n * VD: 05/12/2025 -> Ngày 05 tháng 12 năm 2025\r\n * Note: This is a specific Vietnamese text format, not using date-utils\r\n */\r\nexport const formatDateText = (date?: string | Date): string => {\r\n  if (!date) return '';\r\n  const d = typeof date === 'string' ? new Date(date) : date;\r\n  if (isNaN(d.getTime())) return '';\r\n  const day = d.getDate();\r\n  const month = d.getMonth() + 1;\r\n  const year = d.getFullYear();\r\n  return `Ngày ${day} tháng ${month} năm ${year}`;\r\n};\r\n"],"names":[],"mappings":";;;;;;AAAA;;;CAGC,GAED;;AAkBO,MAAM,kBAAkB,CAAC;IAC9B,IAAI,CAAC,SAAS,MAAM,MAAM,GAAG,GAAG,OAAO,SAAS;IAChD,OAAO,MAAM,KAAK,CAAC,GAAG,KAAK,QAAQ,MAAM,KAAK,CAAC,CAAC;AAClD;AAOO,MAAM,iBAAiB,CAAC;IAC7B,IAAI,CAAC,MAAM,OAAO;IAClB,MAAM,IAAI,OAAO,SAAS,WAAW,IAAI,KAAK,QAAQ;IACtD,IAAI,MAAM,EAAE,OAAO,KAAK,OAAO;IAC/B,MAAM,MAAM,EAAE,OAAO;IACrB,MAAM,QAAQ,EAAE,QAAQ,KAAK;IAC7B,MAAM,OAAO,EAAE,WAAW;IAC1B,OAAO,CAAC,KAAK,EAAE,IAAI,OAAO,EAAE,MAAM,KAAK,EAAE,MAAM;AACjD"}},
    {"offset": {"line": 1748, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/lib/print-mappers/payroll.mapper.ts"],"sourcesContent":["/**\r\n * Payroll Mapper - Bảng lương & Phiếu lương\r\n * Đồng bộ với variables/bang-luong.ts\r\n */\r\n\r\nimport { \r\n  PrintData, \r\n  PrintLineItem,\r\n  formatCurrency, \r\n  numberToWords, \r\n  formatDate,\r\n  formatTime,\r\n  getStoreData,\r\n  StoreSettings\r\n} from './types';\r\n\r\n// Helper: Format số khấu trừ (có dấu âm khi > 0, không dấu khi = 0)\r\nconst formatDeduction = (value: number | undefined): string => {\r\n  if (!value || value === 0) return '0';\r\n  return `-${formatCurrency(value)}`;\r\n};\r\n\r\n// ============================================\r\n// TYPES\r\n// ============================================\r\n\r\nexport interface PayrollBatchForPrint {\r\n  // Thông tin cơ bản\r\n  code: string;\r\n  title: string;\r\n  status: string;\r\n  \r\n  // Kỳ lương\r\n  payPeriod: string; // MM/yyyy\r\n  payPeriodStart?: string | Date;\r\n  payPeriodEnd?: string | Date;\r\n  payrollDate: string | Date;\r\n  referenceMonths?: string[]; // ['2024-01', '2024-02']\r\n  \r\n  // Tổng kết\r\n  totalEmployees: number;\r\n  totalGross: number;\r\n  totalEarnings: number;\r\n  totalDeductions: number;\r\n  totalContributions: number;\r\n  totalNet: number;\r\n  \r\n  // Tổng bảo hiểm & Thuế (cho template in)\r\n  totalInsurance: number;      // Tổng BH nhân viên đóng\r\n  totalTax: number;            // Tổng thuế TNCN\r\n  \r\n  // Audit\r\n  createdAt: string | Date;\r\n  createdBy?: string;\r\n  lockedAt?: string | Date;\r\n  lockedBy?: string;\r\n  notes?: string;\r\n  \r\n  // Chi tiết nhân viên\r\n  payslips?: PayslipForPrint[];\r\n}\r\n\r\nexport interface PayslipForPrint {\r\n  // Thông tin phiếu\r\n  code: string;\r\n  batchCode?: string;\r\n  batchTitle?: string;\r\n  payPeriod?: string;\r\n  payrollDate?: string | Date;\r\n  \r\n  // Thông tin nhân viên\r\n  employeeCode: string;\r\n  employeeName: string;\r\n  departmentName?: string;\r\n  position?: string;\r\n  \r\n  // Thông tin chấm công\r\n  workDays?: number;\r\n  standardWorkDays?: number;\r\n  leaveDays?: number;\r\n  absentDays?: number;\r\n  otHours?: number;\r\n  otHoursWeekday?: number;\r\n  otHoursWeekend?: number;\r\n  otHoursHoliday?: number;\r\n  lateArrivals?: number;\r\n  earlyDepartures?: number;\r\n  \r\n  // Chi tiết lương\r\n  earnings: number;\r\n  deductions: number;\r\n  contributions: number;\r\n  taxableIncome: number;\r\n  socialInsuranceBase: number;\r\n  netPay: number;\r\n  \r\n  // Bảo hiểm chi tiết (NV đóng)\r\n  totalEmployeeInsurance: number;\r\n  employeeSocialInsurance: number;\r\n  employeeHealthInsurance: number;\r\n  employeeUnemploymentInsurance: number;\r\n  \r\n  // Thuế TNCN\r\n  personalIncomeTax: number;\r\n  \r\n  // Khấu trừ phạt & khác\r\n  penaltyDeductions?: number;\r\n  otherDeductions?: number;\r\n  \r\n  // Giảm trừ gia cảnh\r\n  personalDeduction: number;\r\n  dependentDeduction: number;\r\n  numberOfDependents: number;\r\n  \r\n  // Components\r\n  components?: PayrollComponentForPrint[];\r\n}\r\n\r\nexport interface PayrollComponentForPrint {\r\n  code?: string;\r\n  name: string;\r\n  category: 'earning' | 'deduction' | 'contribution';\r\n  amount: number;\r\n  // Thông tin để tạo công thức\r\n  calculationType?: 'fixed' | 'formula';\r\n  formula?: string;\r\n  metadata?: {\r\n    context?: {\r\n      baseSalary?: number;\r\n      workDays?: number;\r\n      standardWorkDays?: number;\r\n      otHoursWeekday?: number;\r\n      otHoursWeekend?: number;\r\n      otHoursHoliday?: number;\r\n      otPayWeekday?: number;\r\n      otPayWeekend?: number;\r\n      otPayHoliday?: number;\r\n      // OT rate settings\r\n      otHourlyRate?: number;\r\n      otRateWeekend?: number;\r\n      otRateHoliday?: number;\r\n      // Phụ cấp ăn trưa\r\n      mealAllowancePerDay?: number;\r\n    };\r\n    [key: string]: unknown;\r\n  };\r\n}\r\n\r\n// ============================================\r\n// BATCH MAPPER (Tổng bảng lương)\r\n// ============================================\r\n\r\nconst STATUS_MAP: Record<string, string> = {\r\n  'draft': 'Nháp',\r\n  'reviewed': 'Đã duyệt',\r\n  'locked': 'Đã khóa',\r\n};\r\n\r\nexport function mapPayrollBatchToPrintData(batch: PayrollBatchForPrint, storeSettings: StoreSettings): PrintData {\r\n  return {\r\n    ...getStoreData(storeSettings),\r\n    \r\n    // === THÔNG TIN BẢNG LƯƠNG ===\r\n    '{batch_code}': batch.code,\r\n    '{batch_title}': batch.title,\r\n    '{batch_status}': STATUS_MAP[batch.status] || batch.status,\r\n    '{pay_period}': batch.payPeriod,\r\n    '{pay_period_start}': formatDate(batch.payPeriodStart),\r\n    '{pay_period_end}': formatDate(batch.payPeriodEnd),\r\n    '{payroll_date}': formatDate(batch.payrollDate),\r\n    '{reference_months}': batch.referenceMonths?.join(', ') || '',\r\n    '{created_on}': formatDate(batch.createdAt),\r\n    '{created_by}': batch.createdBy || '',\r\n    '{locked_on}': formatDate(batch.lockedAt),\r\n    '{locked_by}': batch.lockedBy || '',\r\n    '{notes}': batch.notes || '',\r\n    \r\n    // === TỔNG KẾT ===\r\n    '{total_employees}': String(batch.totalEmployees),\r\n    '{total_gross}': formatCurrency(batch.totalGross),\r\n    '{total_gross_text}': numberToWords(batch.totalGross),\r\n    '{total_earnings}': formatCurrency(batch.totalEarnings),\r\n    '{total_deductions}': formatCurrency(batch.totalDeductions),\r\n    '{total_contributions}': formatCurrency(batch.totalContributions),\r\n    '{total_insurance}': formatCurrency(batch.totalInsurance),\r\n    '{total_tax}': formatCurrency(batch.totalTax),\r\n    '{total_net}': formatCurrency(batch.totalNet),\r\n    '{total_net_text}': numberToWords(batch.totalNet),\r\n  };\r\n}\r\n\r\nexport function mapPayrollBatchLineItems(payslips?: PayslipForPrint[]): PrintLineItem[] {\r\n  if (!payslips?.length) return [];\r\n  \r\n  return payslips.map((slip, index) => ({\r\n    '{line_stt}': String(index + 1),\r\n    '{employee_code}': slip.employeeCode,\r\n    '{employee_name}': slip.employeeName,\r\n    '{department_name}': slip.departmentName || '',\r\n    '{earnings}': formatCurrency(slip.earnings),\r\n    '{deductions}': formatCurrency(slip.deductions),\r\n    '{contributions}': formatCurrency(slip.contributions),\r\n    '{total_insurance}': formatDeduction(slip.totalEmployeeInsurance),\r\n    '{personal_income_tax}': formatDeduction(slip.personalIncomeTax),\r\n    '{net_pay}': formatCurrency(slip.netPay),\r\n  }));\r\n}\r\n\r\n// ============================================\r\n// PAYSLIP MAPPER (Phiếu lương cá nhân)\r\n// ============================================\r\n\r\nconst COMPONENT_CATEGORY_MAP: Record<string, string> = {\r\n  'earning': 'Khoản cộng',\r\n  'deduction': 'Khoản trừ',\r\n  'contribution': 'Đóng góp',\r\n};\r\n\r\nexport function mapPayslipToPrintData(payslip: PayslipForPrint, storeSettings: StoreSettings): PrintData {\r\n  return {\r\n    ...getStoreData(storeSettings),\r\n    \r\n    // === THÔNG TIN PHIẾU LƯƠNG ===\r\n    '{payslip_code}': payslip.code,\r\n    '{batch_code}': payslip.batchCode || '',\r\n    '{batch_title}': payslip.batchTitle || '',\r\n    '{pay_period}': payslip.payPeriod || '',\r\n    '{payroll_date}': formatDate(payslip.payrollDate),\r\n    \r\n    // === THÔNG TIN NHÂN VIÊN ===\r\n    '{employee_code}': payslip.employeeCode,\r\n    '{employee_name}': payslip.employeeName,\r\n    '{department_name}': payslip.departmentName || '',\r\n    '{position}': payslip.position || '',\r\n    \r\n    // === THÔNG TIN CHẤM CÔNG ===\r\n    '{work_days}': String(payslip.workDays ?? 0),\r\n    '{standard_work_days}': String(payslip.standardWorkDays ?? 26),\r\n    '{leave_days}': String(payslip.leaveDays ?? 0),\r\n    '{absent_days}': String(payslip.absentDays ?? 0),\r\n    '{ot_hours}': String(payslip.otHours ?? 0),\r\n    '{ot_hours_weekday}': String(payslip.otHoursWeekday ?? 0),\r\n    '{ot_hours_weekend}': String(payslip.otHoursWeekend ?? 0),\r\n    '{ot_hours_holiday}': String(payslip.otHoursHoliday ?? 0),\r\n    '{late_arrivals}': String(payslip.lateArrivals ?? 0),\r\n    '{early_departures}': String(payslip.earlyDepartures ?? 0),\r\n    \r\n    // === CHI TIẾT LƯƠNG ===\r\n    '{total_earnings}': formatCurrency(payslip.earnings),\r\n    '{total_deductions}': formatCurrency(payslip.deductions),\r\n    '{total_contributions}': formatCurrency(payslip.contributions),\r\n    '{total_insurance}': formatDeduction(payslip.totalEmployeeInsurance),\r\n    \r\n    // === BẢO HIỂM CHI TIẾT ===\r\n    '{bhxh_amount}': formatDeduction(payslip.employeeSocialInsurance),\r\n    '{bhyt_amount}': formatDeduction(payslip.employeeHealthInsurance),\r\n    '{bhtn_amount}': formatDeduction(payslip.employeeUnemploymentInsurance),\r\n    \r\n    // === GIẢM TRỪ GIA CẢNH ===\r\n    '{personal_deduction}': formatCurrency(payslip.personalDeduction),\r\n    '{dependent_deduction}': formatCurrency(payslip.dependentDeduction),\r\n    '{dependents_count}': String(payslip.numberOfDependents || 0),\r\n    \r\n    // === THUẾ & THỰC LĨNH ===\r\n    '{personal_income_tax}': formatDeduction(payslip.personalIncomeTax),\r\n    '{taxable_income}': formatCurrency(payslip.taxableIncome),\r\n    '{social_insurance_base}': formatCurrency(payslip.socialInsuranceBase),\r\n    '{penalty_deductions}': formatDeduction(payslip.penaltyDeductions),\r\n    '{other_deductions}': formatDeduction(payslip.otherDeductions),\r\n    '{net_pay}': formatCurrency(payslip.netPay),\r\n    '{net_pay_text}': numberToWords(payslip.netPay),\r\n  };\r\n}\r\n\r\n/**\r\n * Tạo công thức đọc được cho component\r\n * Ví dụ: \"35,000,000 × (16.98 / 26)\" hoặc \"Cố định\"\r\n */\r\nfunction formatComponentFormula(comp: PayrollComponentForPrint): string {\r\n  // Fixed amount\r\n  if (comp.calculationType === 'fixed' || !comp.formula) {\r\n    return 'Cố định';\r\n  }\r\n  \r\n  const ctx = comp.metadata?.context;\r\n  if (!ctx) return comp.formula || '';\r\n  \r\n  // Lương cơ bản: baseSalary × (workDays / standardWorkDays)\r\n  if (comp.formula?.includes('baseSalary') && comp.formula?.includes('workDays')) {\r\n    const baseSalary = ctx.baseSalary ?? 0;\r\n    const workDays = ctx.workDays ?? 0;\r\n    const standardWorkDays = ctx.standardWorkDays ?? 26;\r\n    return `${formatCurrency(baseSalary)} × (${workDays} / ${standardWorkDays})`;\r\n  }\r\n  \r\n  // Phụ cấp ăn trưa: workDays × mealAllowancePerDay\r\n  if (comp.formula?.includes('mealAllowancePerDay') || comp.name.toLowerCase().includes('ăn trưa')) {\r\n    const workDays = ctx.workDays ?? 0;\r\n    const mealAllowancePerDay = ctx.mealAllowancePerDay ?? 30000;\r\n    return `${workDays} ngày × ${formatCurrency(mealAllowancePerDay)}`;\r\n  }\r\n  \r\n  // OT ngày thường (không có hệ số, chỉ nhân hourlyRate)\r\n  if (comp.formula?.includes('otPayWeekday') || comp.name.toLowerCase().includes('ngày thường')) {\r\n    const hours = ctx.otHoursWeekday ?? 0;\r\n    const hourlyRate = ctx.otHourlyRate ?? 0;\r\n    if (hours > 0 && hourlyRate > 0) {\r\n      return `${hours}h × ${formatCurrency(hourlyRate)}`;\r\n    }\r\n    return hours > 0 ? `${hours}h OT` : '—';\r\n  }\r\n  \r\n  // OT cuối tuần (hourlyRate × hệ số)\r\n  if (comp.formula?.includes('otPayWeekend') || comp.name.toLowerCase().includes('cuối tuần')) {\r\n    const hours = ctx.otHoursWeekend ?? 0;\r\n    const hourlyRate = ctx.otHourlyRate ?? 0;\r\n    const rate = ctx.otRateWeekend ?? 2;\r\n    if (hours > 0 && hourlyRate > 0) {\r\n      return `${hours}h × ${formatCurrency(hourlyRate)} × ${rate}`;\r\n    }\r\n    return hours > 0 ? `${hours}h OT` : '—';\r\n  }\r\n  \r\n  // OT ngày lễ (hourlyRate × hệ số)\r\n  if (comp.formula?.includes('otPayHoliday') || comp.name.toLowerCase().includes('ngày lễ')) {\r\n    const hours = ctx.otHoursHoliday ?? 0;\r\n    const hourlyRate = ctx.otHourlyRate ?? 0;\r\n    const rate = ctx.otRateHoliday ?? 3;\r\n    if (hours > 0 && hourlyRate > 0) {\r\n      return `${hours}h × ${formatCurrency(hourlyRate)} × ${rate}`;\r\n    }\r\n    return hours > 0 ? `${hours}h OT` : '—';\r\n  }\r\n  \r\n  // Fallback - hiển thị formula gốc nếu có\r\n  return comp.formula || 'Cố định';\r\n}\r\n\r\nexport function mapPayslipComponentLineItems(components?: PayrollComponentForPrint[]): PrintLineItem[] {\r\n  if (!components?.length) return [];\r\n  \r\n  return components.map((comp, index) => ({\r\n    '{line_stt}': String(index + 1),\r\n    '{component_code}': comp.code || '',\r\n    '{component_name}': comp.name,\r\n    '{component_category}': COMPONENT_CATEGORY_MAP[comp.category] || comp.category,\r\n    '{component_formula}': formatComponentFormula(comp),    '{component_amount}': formatCurrency(comp.amount),\r\n  }));\r\n}"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1951, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/lib/print/payroll-print-helper.ts"],"sourcesContent":["/**\r\n * Payroll Print Helper\r\n * Helpers để chuẩn bị dữ liệu in cho bảng lương và phiếu lương\r\n */\r\n\r\nimport type { Branch } from '../../features/settings/branches/types';\r\nimport type { Employee } from '../../features/employees/types';\r\nimport { attendanceSnapshotService } from '../attendance-snapshot-service';\r\nimport { \r\n  PayrollBatchForPrint,\r\n  PayslipForPrint,\r\n  PayrollComponentForPrint,\r\n  mapPayrollBatchToPrintData, \r\n  mapPayrollBatchLineItems,\r\n  mapPayslipToPrintData,\r\n  mapPayslipComponentLineItems,\r\n} from '../print-mappers/payroll.mapper';\r\nimport { StoreSettings, getStoreLogo, getGeneralSettings } from '../print-service';\r\nimport type { PayrollBatch, Payslip, PayrollComponentEntry, PayrollTotals } from '../payroll-types';\r\nimport type { SystemId } from '../id-types';\r\n\r\n// ============================================\r\n// INTERFACES\r\n// ============================================\r\n\r\n// Interface cho PayrollBatch - flexible\r\ninterface PayrollBatchLike {\r\n  systemId: string;\r\n  id: string;\r\n  title: string;\r\n  status: 'draft' | 'reviewed' | 'locked' | 'cancelled';\r\n  payPeriod?: {\r\n    monthKey?: string;\r\n    startDate?: string;\r\n    endDate?: string;\r\n  };\r\n  payrollDate?: string;\r\n  referenceAttendanceMonthKeys?: string[];\r\n  totalGross?: number;\r\n  totalNet?: number;\r\n  createdAt?: string;\r\n  createdBy?: SystemId;\r\n  reviewedAt?: string;\r\n  reviewedBy?: SystemId;\r\n  lockedAt?: string;\r\n  lockedBy?: SystemId;\r\n  notes?: string;\r\n}\r\n\r\n// Interface cho Payslip - flexible\r\ninterface PayslipLike {\r\n  systemId: string;\r\n  id: string;\r\n  batchSystemId?: string;\r\n  employeeSystemId: string;\r\n  employeeId?: string;\r\n  departmentSystemId?: string;\r\n  periodMonthKey?: string;\r\n  components?: PayrollComponentEntry[];\r\n  totals: PayrollTotals;\r\n  lockedAt?: string;\r\n}\r\n\r\n// ============================================\r\n// CONVERTERS\r\n// ============================================\r\n\r\n/**\r\n * Chuyển đổi PayrollBatch entity sang PayrollBatchForPrint\r\n */\r\nexport function convertPayrollBatchForPrint(\r\n  batch: PayrollBatchLike,\r\n  payslips: PayslipLike[],\r\n  options: {\r\n    employeeLookup?: Record<SystemId, { fullName?: string; id?: string; department?: string }>;\r\n    departmentLookup?: Record<SystemId, { name?: string }>;\r\n    creatorName?: string;\r\n    lockerName?: string;\r\n  } = {}\r\n): PayrollBatchForPrint {\r\n  const { employeeLookup = {}, departmentLookup = {}, creatorName, lockerName } = options;\r\n\r\n  // Calculate totals from payslips\r\n  const totalEarnings = payslips.reduce((sum, p) => sum + p.totals.earnings, 0);\r\n  const totalDeductions = payslips.reduce((sum, p) => sum + p.totals.deductions, 0);\r\n  const totalContributions = payslips.reduce((sum, p) => sum + p.totals.contributions, 0);\r\n  const totalInsurance = payslips.reduce((sum, p) => sum + (p.totals.totalEmployeeInsurance || 0), 0);\r\n  const totalTax = payslips.reduce((sum, p) => sum + (p.totals.personalIncomeTax || 0), 0);\r\n\r\n  // Convert payslips\r\n  const payslipsForPrint: PayslipForPrint[] = payslips.map(payslip => {\r\n    const employee = employeeLookup[payslip.employeeSystemId as SystemId];\r\n    const departmentName = payslip.departmentSystemId\r\n      ? departmentLookup[payslip.departmentSystemId as SystemId]?.name\r\n      : (employee as { departmentName?: string })?.departmentName;\r\n\r\n    return {\r\n      code: payslip.id || payslip.systemId,\r\n      batchCode: batch.id,\r\n      batchTitle: batch.title,\r\n      payPeriod: batch.payPeriod?.monthKey,\r\n      payrollDate: batch.payrollDate,\r\n      employeeCode: employee?.id || payslip.employeeId || '',\r\n      employeeName: employee?.fullName || `Nhân viên ${payslip.employeeId || payslip.employeeSystemId}`,\r\n      departmentName: departmentName || 'Không xác định',\r\n      earnings: payslip.totals.earnings,\r\n      deductions: payslip.totals.deductions,\r\n      contributions: payslip.totals.contributions,\r\n      taxableIncome: payslip.totals.taxableIncome,\r\n      socialInsuranceBase: payslip.totals.socialInsuranceBase,\r\n      netPay: payslip.totals.netPay,\r\n      // Bảo hiểm chi tiết\r\n      totalEmployeeInsurance: payslip.totals.totalEmployeeInsurance || 0,\r\n      employeeSocialInsurance: payslip.totals.employeeSocialInsurance || 0,\r\n      employeeHealthInsurance: payslip.totals.employeeHealthInsurance || 0,\r\n      employeeUnemploymentInsurance: payslip.totals.employeeUnemploymentInsurance || 0,\r\n      // Thuế TNCN\r\n      personalIncomeTax: payslip.totals.personalIncomeTax || 0,\r\n      // Khấu trừ phạt & khác\r\n      penaltyDeductions: payslip.totals.penaltyDeductions || 0,\r\n      otherDeductions: payslip.totals.otherDeductions || 0,\r\n      // Giảm trừ gia cảnh\r\n      personalDeduction: payslip.totals.personalDeduction || 0,\r\n      dependentDeduction: payslip.totals.dependentDeduction || 0,\r\n      numberOfDependents: payslip.totals.numberOfDependents || 0,\r\n      components: payslip.components?.map(c => ({\r\n        code: c.componentId,\r\n        name: c.label,\r\n        category: c.category,\r\n        amount: c.amount,\r\n      })),\r\n    };\r\n  });\r\n\r\n  return {\r\n    code: batch.id,\r\n    title: batch.title,\r\n    status: batch.status,\r\n    payPeriod: batch.payPeriod?.monthKey || '',\r\n    payPeriodStart: batch.payPeriod?.startDate,\r\n    payPeriodEnd: batch.payPeriod?.endDate,\r\n    payrollDate: batch.payrollDate || '',\r\n    referenceMonths: batch.referenceAttendanceMonthKeys,\r\n    totalEmployees: payslips.length,\r\n    totalGross: batch.totalGross || 0,\r\n    totalEarnings,\r\n    totalDeductions,\r\n    totalContributions,\r\n    totalInsurance,\r\n    totalTax,\r\n    totalNet: batch.totalNet || 0,\r\n    createdAt: batch.createdAt || '',\r\n    createdBy: creatorName,\r\n    lockedAt: batch.lockedAt,\r\n    lockedBy: lockerName,\r\n    notes: batch.notes,\r\n    payslips: payslipsForPrint,\r\n  };\r\n}\r\n\r\n/**\r\n * Chuyển đổi Payslip entity sang PayslipForPrint (cho in phiếu lương cá nhân)\r\n */\r\nexport function convertPayslipForPrint(\r\n  payslip: PayslipLike,\r\n  batch: PayrollBatchLike,\r\n  options: {\r\n    employee?: { fullName?: string; id?: string; department?: string; position?: string };\r\n    departmentName?: string;\r\n  } = {}\r\n): PayslipForPrint {\r\n  const { employee, departmentName } = options;\r\n\r\n  // Lấy attendance info: từ totals trước, nếu không có thì lấy từ snapshot\r\n  let attendance = {\r\n    workDays: payslip.totals.workDays,\r\n    standardWorkDays: payslip.totals.standardWorkDays ?? 26,\r\n    leaveDays: payslip.totals.leaveDays ?? 0,\r\n    absentDays: payslip.totals.absentDays ?? 0,\r\n    otHours: payslip.totals.otHours ?? 0,\r\n    otHoursWeekday: payslip.totals.otHoursWeekday ?? 0,\r\n    otHoursWeekend: payslip.totals.otHoursWeekend ?? 0,\r\n    otHoursHoliday: payslip.totals.otHoursHoliday ?? 0,\r\n    lateArrivals: payslip.totals.lateArrivals ?? 0,\r\n    earlyDepartures: payslip.totals.earlyDepartures ?? 0,\r\n  };\r\n\r\n  // Nếu totals không có workDays (dữ liệu cũ), thử lấy từ attendance snapshot\r\n  if (attendance.workDays === undefined || attendance.workDays === null) {\r\n    const monthKey = payslip.periodMonthKey || batch.payPeriod?.monthKey;\r\n    if (monthKey) {\r\n      const snapshot = attendanceSnapshotService.getSnapshot({\r\n        monthKey,\r\n        employeeSystemId: payslip.employeeSystemId as SystemId,\r\n      });\r\n      if (snapshot) {\r\n        attendance = {\r\n          workDays: snapshot.totals.workDays,\r\n          standardWorkDays: 26,\r\n          leaveDays: snapshot.totals.leaveDays,\r\n          absentDays: snapshot.totals.absentDays,\r\n          otHours: snapshot.totals.otHours,\r\n          otHoursWeekday: snapshot.totals.otHoursWeekday ?? 0,\r\n          otHoursWeekend: snapshot.totals.otHoursWeekend ?? 0,\r\n          otHoursHoliday: snapshot.totals.otHoursHoliday ?? 0,\r\n          lateArrivals: snapshot.totals.lateArrivals,\r\n          earlyDepartures: snapshot.totals.earlyDepartures,\r\n        };\r\n      }\r\n    }\r\n  }\r\n\r\n  return {\r\n    code: payslip.id || payslip.systemId,\r\n    batchCode: batch.id,\r\n    batchTitle: batch.title,\r\n    payPeriod: batch.payPeriod?.monthKey,\r\n    payrollDate: batch.payrollDate,\r\n    employeeCode: employee?.id || payslip.employeeId || '',\r\n    employeeName: employee?.fullName || `Nhân viên ${payslip.employeeId || payslip.employeeSystemId}`,\r\n    departmentName: departmentName || employee?.department || 'Không xác định',\r\n    position: employee?.position,\r\n    // Thông tin chấm công (từ attendance object đã resolve)\r\n    workDays: attendance.workDays,\r\n    standardWorkDays: attendance.standardWorkDays,\r\n    leaveDays: attendance.leaveDays,\r\n    absentDays: attendance.absentDays,\r\n    otHours: attendance.otHours,\r\n    otHoursWeekday: attendance.otHoursWeekday,\r\n    otHoursWeekend: attendance.otHoursWeekend,\r\n    otHoursHoliday: attendance.otHoursHoliday,\r\n    lateArrivals: attendance.lateArrivals,\r\n    earlyDepartures: attendance.earlyDepartures,\r\n    // Chi tiết lương\r\n    earnings: payslip.totals.earnings,\r\n    deductions: payslip.totals.deductions,\r\n    contributions: payslip.totals.contributions,\r\n    taxableIncome: payslip.totals.taxableIncome,\r\n    socialInsuranceBase: payslip.totals.socialInsuranceBase,\r\n    netPay: payslip.totals.netPay,\r\n    // Bảo hiểm chi tiết\r\n    totalEmployeeInsurance: payslip.totals.totalEmployeeInsurance || 0,\r\n    employeeSocialInsurance: payslip.totals.employeeSocialInsurance || 0,\r\n    employeeHealthInsurance: payslip.totals.employeeHealthInsurance || 0,\r\n    employeeUnemploymentInsurance: payslip.totals.employeeUnemploymentInsurance || 0,\r\n    // Thuế TNCN\r\n    personalIncomeTax: payslip.totals.personalIncomeTax || 0,\r\n    // Khấu trừ phạt & khác\r\n    penaltyDeductions: payslip.totals.penaltyDeductions || 0,\r\n    otherDeductions: payslip.totals.otherDeductions || 0,\r\n    // Giảm trừ gia cảnh\r\n    personalDeduction: payslip.totals.personalDeduction || 0,\r\n    dependentDeduction: payslip.totals.dependentDeduction || 0,\r\n    numberOfDependents: payslip.totals.numberOfDependents || 0,\r\n    components: payslip.components?.map(c => ({\r\n      code: c.componentId,\r\n      name: c.label,\r\n      category: c.category,\r\n      amount: c.amount,\r\n      calculationType: c.calculationType,\r\n      formula: c.formula,\r\n      metadata: c.metadata as PayrollComponentForPrint['metadata'],\r\n    })),\r\n  };\r\n}\r\n\r\n/**\r\n * Tạo StoreSettings từ storeInfo\r\n */\r\nexport function createStoreSettings(storeInfo?: {\r\n  companyName?: string;\r\n  brandName?: string;\r\n  hotline?: string;\r\n  email?: string;\r\n  website?: string;\r\n  taxCode?: string;\r\n  headquartersAddress?: string;\r\n  province?: string;\r\n  logo?: string;\r\n}): StoreSettings {\r\n  const generalSettings = getGeneralSettings();\r\n  \r\n  // Fallback: lấy từ store nếu storeInfo rỗng\r\n  let storeInfoFromStorage: typeof storeInfo | null = null;\r\n  if (!storeInfo?.companyName && !storeInfo?.brandName) {\r\n    try {\r\n      // Import store dynamically để tránh circular dependency\r\n      const { useStoreInfoStore } = require('@/features/settings/store-info/store-info-store');\r\n      storeInfoFromStorage = useStoreInfoStore.getState().info;\r\n    } catch (e) { /* ignore */ }\r\n  }\r\n  \r\n  const info = storeInfo?.companyName || storeInfo?.brandName ? storeInfo : storeInfoFromStorage;\r\n  \r\n  return {\r\n    name: info?.companyName || info?.brandName || generalSettings?.companyName || '',\r\n    address: info?.headquartersAddress || generalSettings?.companyAddress || '',\r\n    phone: info?.hotline || generalSettings?.phoneNumber || '',\r\n    email: info?.email || generalSettings?.email || '',\r\n    website: info?.website,\r\n    taxCode: info?.taxCode,\r\n    province: info?.province,\r\n    logo: getStoreLogo(info?.logo),\r\n  };\r\n}\r\n\r\n// Re-export mappers\r\nexport {\r\n  mapPayrollBatchToPrintData,\r\n  mapPayrollBatchLineItems,\r\n  mapPayslipToPrintData,\r\n  mapPayslipComponentLineItems,\r\n};\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 2165, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/lib/print-mappers/attendance.mapper.ts"],"sourcesContent":["/**\r\n * Attendance Mapper - Bảng chấm công\r\n * Đồng bộ với variables/bang-cham-cong.ts\r\n */\r\n\r\nimport { \r\n  PrintData, \r\n  PrintLineItem,\r\n  formatCurrency, \r\n  formatDate,\r\n  formatTime,\r\n  getStoreData,\r\n  StoreSettings\r\n} from './types';\r\n\r\n// ============================================\r\n// TYPES\r\n// ============================================\r\n\r\nexport type AttendanceStatus = 'present' | 'absent' | 'leave' | 'half-day' | 'weekend' | 'holiday' | 'future';\r\n\r\nexport interface DailyAttendanceRecord {\r\n  day: number;\r\n  dayOfWeek?: string;\r\n  status: AttendanceStatus;\r\n  checkIn?: string;\r\n  checkOut?: string;\r\n  overtimeCheckIn?: string;\r\n  overtimeCheckOut?: string;\r\n  notes?: string;\r\n}\r\n\r\nexport interface AttendanceSheetForPrint {\r\n  // Thông tin kỳ\r\n  monthKey: string; // yyyy-MM\r\n  month?: number;\r\n  year?: number;\r\n  departmentName?: string;\r\n  isLocked?: boolean;\r\n  \r\n  // Audit\r\n  createdAt?: string | Date;\r\n  createdBy?: string;\r\n  \r\n  // Tổng kết\r\n  totalEmployees: number;\r\n  totalWorkDays: number;\r\n  totalLeaveDays: number;\r\n  totalAbsentDays: number;\r\n  totalLateArrivals: number;\r\n  totalEarlyDepartures: number;\r\n  totalOtHours: number;\r\n  \r\n  // Chi tiết nhân viên\r\n  employees?: AttendanceEmployeeForPrint[];\r\n}\r\n\r\nexport interface AttendanceEmployeeForPrint {\r\n  employeeCode: string;\r\n  employeeName: string;\r\n  departmentName?: string;\r\n  workDays: number;\r\n  leaveDays: number;\r\n  absentDays: number;\r\n  lateArrivals: number;\r\n  earlyDepartures: number;\r\n  otHours: number;\r\n  // Dữ liệu từng ngày (day_1 đến day_31)\r\n  dailyRecords?: Record<string, AttendanceStatus | string>;\r\n  // Chi tiết giờ vào/ra (checkin_1 đến checkin_31, checkout_1 đến checkout_31)\r\n  dailyCheckIn?: Record<string, string>;\r\n  dailyCheckOut?: Record<string, string>;\r\n  dailyOtIn?: Record<string, string>;\r\n  dailyOtOut?: Record<string, string>;\r\n  dailyNotes?: Record<string, string>;\r\n}\r\n\r\n// Chi tiết chấm công từng nhân viên (để in chi tiết cá nhân)\r\nexport interface AttendanceDetailForPrint {\r\n  // Thông tin kỳ\r\n  monthKey: string;\r\n  \r\n  // Thông tin nhân viên\r\n  employeeCode: string;\r\n  employeeName: string;\r\n  departmentName?: string;\r\n  \r\n  // Tổng kết\r\n  workDays: number;\r\n  leaveDays: number;\r\n  absentDays: number;\r\n  lateArrivals: number;\r\n  earlyDepartures: number;\r\n  otHours: number;\r\n  \r\n  // Chi tiết từng ngày\r\n  dailyDetails?: DailyAttendanceRecord[];\r\n}\r\n\r\n// ============================================\r\n// STATUS MAPS\r\n// ============================================\r\n\r\nconst STATUS_MAP: Record<AttendanceStatus, string> = {\r\n  'present': 'Có mặt',\r\n  'absent': 'Vắng',\r\n  'leave': 'Nghỉ phép',\r\n  'half-day': 'Nửa ngày',\r\n  'weekend': 'Cuối tuần',\r\n  'holiday': 'Nghỉ lễ',\r\n  'future': '-',\r\n};\r\n\r\nconst STATUS_SHORT_MAP: Record<AttendanceStatus, string> = {\r\n  'present': '✓',\r\n  'absent': 'X',\r\n  'leave': 'P',\r\n  'half-day': '½',\r\n  'weekend': '-',\r\n  'holiday': 'L',\r\n  'future': '-',\r\n};\r\n\r\nconst DAY_OF_WEEK_MAP: Record<number, string> = {\r\n  0: 'CN',\r\n  1: 'T2',\r\n  2: 'T3',\r\n  3: 'T4',\r\n  4: 'T5',\r\n  5: 'T6',\r\n  6: 'T7',\r\n};\r\n\r\n// ============================================\r\n// SHEET MAPPER (Bảng chấm công tổng)\r\n// ============================================\r\n\r\nexport function mapAttendanceSheetToPrintData(\r\n  sheet: AttendanceSheetForPrint, \r\n  storeSettings: StoreSettings\r\n): PrintData {\r\n  const [year, month] = sheet.monthKey.split('-').map(Number);\r\n  \r\n  return {\r\n    ...getStoreData(storeSettings),\r\n    \r\n    // === THÔNG TIN BẢNG CHẤM CÔNG ===\r\n    '{month_year}': `${month}/${year}`,\r\n    '{month}': String(month),\r\n    '{year}': String(year),\r\n    '{department_name}': sheet.departmentName || 'Tất cả phòng ban',\r\n    '{is_locked}': sheet.isLocked ? 'Đã khóa' : 'Đang mở',\r\n    '{created_on}': formatDate(sheet.createdAt),\r\n    '{created_by}': sheet.createdBy || '',\r\n    \r\n    // === TỔNG KẾT ===\r\n    '{total_employees}': String(sheet.totalEmployees),\r\n    '{total_work_days}': String(sheet.totalWorkDays),\r\n    '{total_leave_days}': String(sheet.totalLeaveDays),\r\n    '{total_absent_days}': String(sheet.totalAbsentDays),\r\n    '{total_late_arrivals}': String(sheet.totalLateArrivals),\r\n    '{total_early_departures}': String(sheet.totalEarlyDepartures),\r\n    '{total_ot_hours}': String(sheet.totalOtHours),\r\n  };\r\n}\r\n\r\nexport function mapAttendanceSheetLineItems(\r\n  employees?: AttendanceEmployeeForPrint[],\r\n  monthKey?: string\r\n): PrintLineItem[] {\r\n  if (!employees?.length) return [];\r\n  \r\n  // Parse year and month for day of week calculation\r\n  const [year, month] = monthKey ? monthKey.split('-').map(Number) : [new Date().getFullYear(), new Date().getMonth() + 1];\r\n  \r\n  return employees.map((emp, index) => {\r\n    const lineItem: PrintLineItem = {\r\n      '{line_index}': String(index + 1),\r\n      '{employee_code}': emp.employeeCode,\r\n      '{employee_name}': emp.employeeName,\r\n      '{department_name}': emp.departmentName || '',\r\n      '{work_days}': String(emp.workDays),\r\n      '{leave_days}': String(emp.leaveDays),\r\n      '{absent_days}': String(emp.absentDays),\r\n      '{late_arrivals}': String(emp.lateArrivals),\r\n      '{early_departures}': String(emp.earlyDepartures),\r\n      '{ot_hours}': String(emp.otHours),\r\n    };\r\n    \r\n    // Add day_1 to day_31 with all details\r\n    for (let d = 1; d <= 31; d++) {\r\n      const dayKey = `day_${d}`;\r\n      const status = emp.dailyRecords?.[dayKey] as AttendanceStatus | undefined;\r\n      \r\n      // Day status (short form)\r\n      lineItem[`{${dayKey}}`] = status ? STATUS_SHORT_MAP[status] || status : '';\r\n      \r\n      // Day of week\r\n      const date = new Date(year, month - 1, d);\r\n      const isValidDate = date.getMonth() === month - 1; // Check if day exists in month\r\n      lineItem[`{dow_${d}}`] = isValidDate ? DAY_OF_WEEK_MAP[date.getDay()] || '' : '';\r\n      \r\n      // Check-in/out times\r\n      lineItem[`{checkin_${d}}`] = emp.dailyCheckIn?.[dayKey] || '';\r\n      lineItem[`{checkout_${d}}`] = emp.dailyCheckOut?.[dayKey] || '';\r\n      \r\n      // OT times  \r\n      lineItem[`{ot_in_${d}}`] = emp.dailyOtIn?.[dayKey] || '';\r\n      lineItem[`{ot_out_${d}}`] = emp.dailyOtOut?.[dayKey] || '';\r\n      \r\n      // Notes\r\n      lineItem[`{note_${d}}`] = emp.dailyNotes?.[dayKey] || '';\r\n    }\r\n    \r\n    return lineItem;\r\n  });\r\n}\r\n\r\n// ============================================\r\n// DETAIL MAPPER (Chi tiết chấm công cá nhân)\r\n// ============================================\r\n\r\nexport function mapAttendanceDetailToPrintData(\r\n  detail: AttendanceDetailForPrint,\r\n  storeSettings: StoreSettings\r\n): PrintData {\r\n  const [year, month] = detail.monthKey.split('-').map(Number);\r\n  \r\n  return {\r\n    ...getStoreData(storeSettings),\r\n    \r\n    // === THÔNG TIN NHÂN VIÊN ===\r\n    '{employee_code}': detail.employeeCode,\r\n    '{employee_name}': detail.employeeName,\r\n    '{department_name}': detail.departmentName || '',\r\n    \r\n    // === THÔNG TIN KỲ ===\r\n    '{month_year}': `${month}/${year}`,\r\n    \r\n    // === TỔNG KẾT ===\r\n    '{work_days}': String(detail.workDays),\r\n    '{leave_days}': String(detail.leaveDays),\r\n    '{absent_days}': String(detail.absentDays),\r\n    '{late_arrivals}': String(detail.lateArrivals),\r\n    '{early_departures}': String(detail.earlyDepartures),\r\n    '{ot_hours}': String(detail.otHours),\r\n  };\r\n}\r\n\r\nexport function mapAttendanceDetailLineItems(\r\n  dailyDetails?: DailyAttendanceRecord[]\r\n): PrintLineItem[] {\r\n  if (!dailyDetails?.length) return [];\r\n  \r\n  return dailyDetails.map((record, index) => ({\r\n    '{line_index}': String(index + 1),\r\n    '{day}': String(record.day),\r\n    '{day_of_week}': record.dayOfWeek || getDayOfWeekLabel(record.day),\r\n    '{status}': STATUS_MAP[record.status] || record.status,\r\n    '{check_in}': record.checkIn || '',\r\n    '{check_out}': record.checkOut || '',\r\n    '{ot_check_in}': record.overtimeCheckIn || '',\r\n    '{ot_check_out}': record.overtimeCheckOut || '',\r\n    '{notes}': record.notes || '',\r\n  }));\r\n}\r\n\r\n// Helper to get day of week label from day number (requires year/month context)\r\nfunction getDayOfWeekLabel(day: number, year?: number, month?: number): string {\r\n  if (!year || !month) return '';\r\n  const date = new Date(year, month - 1, day);\r\n  return DAY_OF_WEEK_MAP[date.getDay()] || '';\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 2321, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/lib/print/attendance-print-helper.ts"],"sourcesContent":["/**\r\n * Attendance Print Helper\r\n * Helpers để chuẩn bị dữ liệu in cho bảng chấm công\r\n */\r\n\r\nimport type { Branch } from '../../features/settings/branches/types';\r\nimport type { Employee } from '../../features/employees/types';\r\nimport { \r\n  AttendanceSheetForPrint,\r\n  AttendanceEmployeeForPrint,\r\n  AttendanceDetailForPrint,\r\n  DailyAttendanceRecord,\r\n  AttendanceStatus,\r\n  mapAttendanceSheetToPrintData, \r\n  mapAttendanceSheetLineItems,\r\n  mapAttendanceDetailToPrintData,\r\n  mapAttendanceDetailLineItems,\r\n} from '../print-mappers/attendance.mapper';\r\nimport { StoreSettings, getStoreLogo, getGeneralSettings } from '../print-service';\r\nimport type { SystemId } from '../id-types';\r\n\r\n// ============================================\r\n// INTERFACES\r\n// ============================================\r\n\r\n// Interface cho DailyRecord từ attendance store\r\ninterface DailyRecordLike {\r\n  status: AttendanceStatus;\r\n  checkIn?: string;\r\n  checkOut?: string;\r\n  overtimeCheckIn?: string;\r\n  overtimeCheckOut?: string;\r\n  notes?: string;\r\n}\r\n\r\n// Interface cho AttendanceDataRow từ attendance page\r\ninterface AttendanceDataRowLike {\r\n  systemId: string;\r\n  employeeSystemId: string;\r\n  employeeId: string;\r\n  fullName: string;\r\n  department?: string;\r\n  workDays: number;\r\n  leaveDays: number;\r\n  absentDays: number;\r\n  lateArrivals: number;\r\n  earlyDepartures: number;\r\n  otHours: number;\r\n  [key: `day_${number}`]: DailyRecordLike | undefined;\r\n}\r\n\r\n// ============================================\r\n// CONVERTERS\r\n// ============================================\r\n\r\n/**\r\n * Chuyển đổi danh sách AttendanceDataRow sang AttendanceSheetForPrint\r\n */\r\nexport function convertAttendanceSheetForPrint(\r\n  monthKey: string,\r\n  attendanceData: AttendanceDataRowLike[],\r\n  options: {\r\n    isLocked?: boolean;\r\n    departmentName?: string;\r\n    createdBy?: string;\r\n  } = {}\r\n): AttendanceSheetForPrint {\r\n  const { isLocked, departmentName, createdBy } = options;\r\n\r\n  // Calculate totals\r\n  const totalWorkDays = attendanceData.reduce((sum, row) => sum + (row.workDays || 0), 0);\r\n  const totalLeaveDays = attendanceData.reduce((sum, row) => sum + (row.leaveDays || 0), 0);\r\n  const totalAbsentDays = attendanceData.reduce((sum, row) => sum + (row.absentDays || 0), 0);\r\n  const totalLateArrivals = attendanceData.reduce((sum, row) => sum + (row.lateArrivals || 0), 0);\r\n  const totalEarlyDepartures = attendanceData.reduce((sum, row) => sum + (row.earlyDepartures || 0), 0);\r\n  const totalOtHours = attendanceData.reduce((sum, row) => sum + (row.otHours || 0), 0);\r\n\r\n  // Convert employees\r\n  const employees: AttendanceEmployeeForPrint[] = attendanceData.map(row => {\r\n    const dailyRecords: Record<string, AttendanceStatus | string> = {};\r\n    const dailyCheckIn: Record<string, string> = {};\r\n    const dailyCheckOut: Record<string, string> = {};\r\n    const dailyOtIn: Record<string, string> = {};\r\n    const dailyOtOut: Record<string, string> = {};\r\n    const dailyNotes: Record<string, string> = {};\r\n    \r\n    // Extract day_1 to day_31\r\n    for (let d = 1; d <= 31; d++) {\r\n      const dayKey = `day_${d}` as keyof AttendanceDataRowLike;\r\n      const record = row[dayKey] as DailyRecordLike | undefined;\r\n      if (record) {\r\n        dailyRecords[`day_${d}`] = record.status;\r\n        if (record.checkIn) dailyCheckIn[`day_${d}`] = record.checkIn;\r\n        if (record.checkOut) dailyCheckOut[`day_${d}`] = record.checkOut;\r\n        if (record.overtimeCheckIn) dailyOtIn[`day_${d}`] = record.overtimeCheckIn;\r\n        if (record.overtimeCheckOut) dailyOtOut[`day_${d}`] = record.overtimeCheckOut;\r\n        if (record.notes) dailyNotes[`day_${d}`] = record.notes;\r\n      }\r\n    }\r\n\r\n    return {\r\n      employeeCode: row.employeeId || '',\r\n      employeeName: row.fullName || '',\r\n      departmentName: row.department || '',\r\n      workDays: row.workDays || 0,\r\n      leaveDays: row.leaveDays || 0,\r\n      absentDays: row.absentDays || 0,\r\n      lateArrivals: row.lateArrivals || 0,\r\n      earlyDepartures: row.earlyDepartures || 0,\r\n      otHours: row.otHours || 0,\r\n      dailyRecords,\r\n      dailyCheckIn,\r\n      dailyCheckOut,\r\n      dailyOtIn,\r\n      dailyOtOut,\r\n      dailyNotes,\r\n    };\r\n  });\r\n\r\n  const [year, month] = monthKey.split('-').map(Number);\r\n\r\n  return {\r\n    monthKey,\r\n    month,\r\n    year,\r\n    departmentName,\r\n    isLocked,\r\n    createdBy,\r\n    totalEmployees: attendanceData.length,\r\n    totalWorkDays,\r\n    totalLeaveDays,\r\n    totalAbsentDays,\r\n    totalLateArrivals,\r\n    totalEarlyDepartures,\r\n    totalOtHours,\r\n    employees,\r\n  };\r\n}\r\n\r\n/**\r\n * Chuyển đổi AttendanceDataRow sang AttendanceDetailForPrint (cho in chi tiết cá nhân)\r\n */\r\nexport function convertAttendanceDetailForPrint(\r\n  monthKey: string,\r\n  row: AttendanceDataRowLike\r\n): AttendanceDetailForPrint {\r\n  const [year, month] = monthKey.split('-').map(Number);\r\n  const daysInMonth = new Date(year, month, 0).getDate();\r\n  \r\n  // Extract daily details\r\n  const dailyDetails: DailyAttendanceRecord[] = [];\r\n  \r\n  for (let d = 1; d <= daysInMonth; d++) {\r\n    const dayKey = `day_${d}` as keyof AttendanceDataRowLike;\r\n    const record = row[dayKey] as DailyRecordLike | undefined;\r\n    \r\n    if (record) {\r\n      const date = new Date(year, month - 1, d);\r\n      const dayOfWeekMap: Record<number, string> = {\r\n        0: 'CN', 1: 'T2', 2: 'T3', 3: 'T4', 4: 'T5', 5: 'T6', 6: 'T7',\r\n      };\r\n      \r\n      dailyDetails.push({\r\n        day: d,\r\n        dayOfWeek: dayOfWeekMap[date.getDay()] || '',\r\n        status: record.status,\r\n        checkIn: record.checkIn,\r\n        checkOut: record.checkOut,\r\n        overtimeCheckIn: record.overtimeCheckIn,\r\n        overtimeCheckOut: record.overtimeCheckOut,\r\n        notes: record.notes,\r\n      });\r\n    }\r\n  }\r\n\r\n  return {\r\n    monthKey,\r\n    employeeCode: row.employeeId || '',\r\n    employeeName: row.fullName || '',\r\n    departmentName: row.department || '',\r\n    workDays: row.workDays || 0,\r\n    leaveDays: row.leaveDays || 0,\r\n    absentDays: row.absentDays || 0,\r\n    lateArrivals: row.lateArrivals || 0,\r\n    earlyDepartures: row.earlyDepartures || 0,\r\n    otHours: row.otHours || 0,\r\n    dailyDetails,\r\n  };\r\n}\r\n\r\n/**\r\n * Tạo StoreSettings từ storeInfo\r\n */\r\nexport function createStoreSettings(storeInfo?: {\r\n  companyName?: string;\r\n  brandName?: string;\r\n  hotline?: string;\r\n  email?: string;\r\n  website?: string;\r\n  taxCode?: string;\r\n  headquartersAddress?: string;\r\n  province?: string;\r\n  logo?: string;\r\n}): StoreSettings {\r\n  const generalSettings = getGeneralSettings();\r\n  return {\r\n    name: storeInfo?.companyName || storeInfo?.brandName || generalSettings?.companyName || '',\r\n    address: storeInfo?.headquartersAddress || generalSettings?.companyAddress || '',\r\n    phone: storeInfo?.hotline || generalSettings?.phoneNumber || '',\r\n    email: storeInfo?.email || generalSettings?.email || '',\r\n    website: storeInfo?.website,\r\n    taxCode: storeInfo?.taxCode,\r\n    province: storeInfo?.province,\r\n    logo: getStoreLogo(storeInfo?.logo),\r\n  };\r\n}\r\n\r\n// Re-export mappers\r\nexport {\r\n  mapAttendanceSheetToPrintData,\r\n  mapAttendanceSheetLineItems,\r\n  mapAttendanceDetailToPrintData,\r\n  mapAttendanceDetailLineItems,\r\n};\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 2468, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/lib/print-mappers/penalty.mapper.ts"],"sourcesContent":["/**\r\n * Penalty Mapper - Phiếu phạt\r\n * Đồng bộ với variables/phieu-phat.ts\r\n */\r\n\r\nimport { \r\n  PrintData, \r\n  formatCurrency,\r\n  numberToWords,\r\n  formatDate,\r\n  formatTime,\r\n  getStoreData,\r\n  StoreSettings\r\n} from './types';\r\n\r\nexport interface PenaltyForPrint {\r\n  // Thông tin cơ bản\r\n  code: string;\r\n  createdAt: string | Date;\r\n  modifiedAt?: string | Date;\r\n  createdBy?: string;\r\n  \r\n  // Thông tin chi nhánh\r\n  location?: {\r\n    name?: string;\r\n    address?: string;\r\n    province?: string;\r\n    phone?: string;\r\n  };\r\n  \r\n  // Thông tin nhân viên\r\n  employeeName: string;\r\n  employeeCode?: string;\r\n  employeePhone?: string;\r\n  employeeEmail?: string;\r\n  employeePosition?: string;\r\n  department?: string;\r\n  \r\n  // Thông tin vi phạm\r\n  penaltyDate: string | Date;\r\n  violationType?: string;\r\n  violationDescription?: string;\r\n  violationEvidence?: string;\r\n  violationCount?: number;\r\n  \r\n  // Thông tin phạt\r\n  penaltyType: string;\r\n  penaltyLevel?: string;\r\n  reason: string;\r\n  amount: number;\r\n  deductionMethod?: string;\r\n  deductionPeriod?: string;\r\n  \r\n  // Phê duyệt\r\n  status?: string;\r\n  approvedBy?: string;\r\n  approvedAt?: string | Date;\r\n  rejectedBy?: string;\r\n  rejectedAt?: string | Date;\r\n  rejectionReason?: string;\r\n  \r\n  // Thông tin bổ sung\r\n  witnessName?: string;\r\n  witnessSignature?: string;\r\n  employeeAcknowledgement?: boolean;\r\n  employeeSignatureDate?: string | Date;\r\n  \r\n  note?: string;\r\n}\r\n\r\nexport function mapPenaltyToPrintData(penalty: PenaltyForPrint, storeSettings: StoreSettings): PrintData {\r\n  return {\r\n    ...getStoreData(storeSettings),\r\n    \r\n    // === THÔNG TIN CHI NHÁNH ===\r\n    '{location_name}': penalty.location?.name || storeSettings.name || '',\r\n    '{location_address}': penalty.location?.address || storeSettings.address || '',\r\n    '{location_province}': penalty.location?.province || '',\r\n    '{location_phone}': penalty.location?.phone || storeSettings.phone || '',\r\n    '{store_province}': storeSettings.province || '',\r\n    \r\n    // === THÔNG TIN PHIẾU PHẠT ===\r\n    '{penalty_code}': penalty.code,\r\n    '{created_on}': formatDate(penalty.createdAt),\r\n    '{created_on_time}': formatTime(penalty.createdAt),\r\n    '{modified_on}': formatDate(penalty.modifiedAt),\r\n    '{account_name}': penalty.createdBy || '',\r\n    \r\n    // === THÔNG TIN NHÂN VIÊN ===\r\n    '{employee_name}': penalty.employeeName,\r\n    '{employee_code}': penalty.employeeCode || '',\r\n    '{employee_phone}': penalty.employeePhone || '',\r\n    '{employee_email}': penalty.employeeEmail || '',\r\n    '{employee_position}': penalty.employeePosition || '',\r\n    '{position_name}': penalty.employeePosition || '',\r\n    '{department_name}': penalty.department || '',\r\n    '{department}': penalty.department || '',\r\n    \r\n    // === THÔNG TIN VI PHẠM ===\r\n    '{penalty_date}': formatDate(penalty.penaltyDate),\r\n    '{penalty_date_time}': formatTime(penalty.penaltyDate),\r\n    '{violation_date}': formatDate(penalty.penaltyDate),\r\n    '{violation_type}': penalty.violationType || '',\r\n    '{violation_description}': penalty.violationDescription || '',\r\n    '{violation_evidence}': penalty.violationEvidence || '',\r\n    '{evidence}': penalty.violationEvidence || '',\r\n    '{violation_count}': penalty.violationCount?.toString() || '',\r\n    \r\n    // === THÔNG TIN PHẠT ===\r\n    '{penalty_type}': penalty.penaltyType,\r\n    '{penalty_level}': penalty.penaltyLevel || '',\r\n    '{penalty_reason}': penalty.reason,\r\n    '{reason}': penalty.reason,\r\n    '{penalty_amount}': formatCurrency(penalty.amount),\r\n    '{amount}': formatCurrency(penalty.amount),\r\n    '{penalty_amount_text}': numberToWords(penalty.amount),\r\n    '{deduction_method}': penalty.deductionMethod || 'Trừ lương',\r\n    '{deduction_period}': penalty.deductionPeriod || '',\r\n    \r\n    // === PHÊ DUYỆT ===\r\n    '{status}': penalty.status || '',\r\n    '{approved_by}': penalty.approvedBy || '',\r\n    '{approved_on}': formatDate(penalty.approvedAt),\r\n    '{approved_on_time}': formatTime(penalty.approvedAt),\r\n    '{rejected_by}': penalty.rejectedBy || '',\r\n    '{rejected_on}': formatDate(penalty.rejectedAt),\r\n    '{rejection_reason}': penalty.rejectionReason || '',\r\n    \r\n    // === THÔNG TIN BỔ SUNG ===\r\n    '{witness_name}': penalty.witnessName || '',\r\n    '{witness_signature}': penalty.witnessSignature || '',\r\n    '{employee_acknowledgement}': penalty.employeeAcknowledgement ? 'Đã xác nhận' : '',\r\n    '{employee_signature_date}': formatDate(penalty.employeeSignatureDate),\r\n    \r\n    '{penalty_note}': penalty.note || '',\r\n    '{note}': penalty.note || '',\r\n  };\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;;;CAGC,GAED;AAAA;;AAiEO,SAAS,sBAAsB,OAAwB,EAAE,aAA4B;IAC1F,OAAO;QACL,GAAG,IAAA,0IAAY,EAAC,cAAc;QAE9B,8BAA8B;QAC9B,mBAAmB,QAAQ,QAAQ,EAAE,QAAQ,cAAc,IAAI,IAAI;QACnE,sBAAsB,QAAQ,QAAQ,EAAE,WAAW,cAAc,OAAO,IAAI;QAC5E,uBAAuB,QAAQ,QAAQ,EAAE,YAAY;QACrD,oBAAoB,QAAQ,QAAQ,EAAE,SAAS,cAAc,KAAK,IAAI;QACtE,oBAAoB,cAAc,QAAQ,IAAI;QAE9C,+BAA+B;QAC/B,kBAAkB,QAAQ,IAAI;QAC9B,gBAAgB,IAAA,wIAAU,EAAC,QAAQ,SAAS;QAC5C,qBAAqB,IAAA,wIAAU,EAAC,QAAQ,SAAS;QACjD,iBAAiB,IAAA,wIAAU,EAAC,QAAQ,UAAU;QAC9C,kBAAkB,QAAQ,SAAS,IAAI;QAEvC,8BAA8B;QAC9B,mBAAmB,QAAQ,YAAY;QACvC,mBAAmB,QAAQ,YAAY,IAAI;QAC3C,oBAAoB,QAAQ,aAAa,IAAI;QAC7C,oBAAoB,QAAQ,aAAa,IAAI;QAC7C,uBAAuB,QAAQ,gBAAgB,IAAI;QACnD,mBAAmB,QAAQ,gBAAgB,IAAI;QAC/C,qBAAqB,QAAQ,UAAU,IAAI;QAC3C,gBAAgB,QAAQ,UAAU,IAAI;QAEtC,4BAA4B;QAC5B,kBAAkB,IAAA,wIAAU,EAAC,QAAQ,WAAW;QAChD,uBAAuB,IAAA,wIAAU,EAAC,QAAQ,WAAW;QACrD,oBAAoB,IAAA,wIAAU,EAAC,QAAQ,WAAW;QAClD,oBAAoB,QAAQ,aAAa,IAAI;QAC7C,2BAA2B,QAAQ,oBAAoB,IAAI;QAC3D,wBAAwB,QAAQ,iBAAiB,IAAI;QACrD,cAAc,QAAQ,iBAAiB,IAAI;QAC3C,qBAAqB,QAAQ,cAAc,EAAE,cAAc;QAE3D,yBAAyB;QACzB,kBAAkB,QAAQ,WAAW;QACrC,mBAAmB,QAAQ,YAAY,IAAI;QAC3C,oBAAoB,QAAQ,MAAM;QAClC,YAAY,QAAQ,MAAM;QAC1B,oBAAoB,IAAA,4IAAc,EAAC,QAAQ,MAAM;QACjD,YAAY,IAAA,4IAAc,EAAC,QAAQ,MAAM;QACzC,yBAAyB,IAAA,2IAAa,EAAC,QAAQ,MAAM;QACrD,sBAAsB,QAAQ,eAAe,IAAI;QACjD,sBAAsB,QAAQ,eAAe,IAAI;QAEjD,oBAAoB;QACpB,YAAY,QAAQ,MAAM,IAAI;QAC9B,iBAAiB,QAAQ,UAAU,IAAI;QACvC,iBAAiB,IAAA,wIAAU,EAAC,QAAQ,UAAU;QAC9C,sBAAsB,IAAA,wIAAU,EAAC,QAAQ,UAAU;QACnD,iBAAiB,QAAQ,UAAU,IAAI;QACvC,iBAAiB,IAAA,wIAAU,EAAC,QAAQ,UAAU;QAC9C,sBAAsB,QAAQ,eAAe,IAAI;QAEjD,4BAA4B;QAC5B,kBAAkB,QAAQ,WAAW,IAAI;QACzC,uBAAuB,QAAQ,gBAAgB,IAAI;QACnD,8BAA8B,QAAQ,uBAAuB,GAAG,gBAAgB;QAChF,6BAA6B,IAAA,wIAAU,EAAC,QAAQ,qBAAqB;QAErE,kBAAkB,QAAQ,IAAI,IAAI;QAClC,UAAU,QAAQ,IAAI,IAAI;IAC5B;AACF"}},
    {"offset": {"line": 2545, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/lib/print/penalty-print-helper.ts"],"sourcesContent":["/**\r\n * Penalty Print Helper\r\n * Helpers để chuẩn bị dữ liệu in cho phiếu phạt\r\n */\r\n\r\nimport type { Branch } from '../../features/settings/branches/types';\r\nimport type { Employee } from '../../features/employees/types';\r\nimport { \r\n  PenaltyForPrint, \r\n  mapPenaltyToPrintData, \r\n} from '../print-mappers/penalty.mapper';\r\nimport { StoreSettings, getStoreLogo, getGeneralSettings } from '../print-service';\r\n\r\n// Interface cho penalty - flexible để nhận nhiều type\r\ninterface PenaltyLike {\r\n  systemId: string;\r\n  id: string;\r\n  employeeSystemId?: string;\r\n  employeeName: string;\r\n  employeeCode?: string;\r\n  employeeDepartment?: string;\r\n  employeePosition?: string;\r\n  branchSystemId?: string;\r\n  branchName?: string;\r\n  type?: string;\r\n  category?: string;\r\n  penaltyTypeSystemId?: string;\r\n  penaltyTypeName?: string;\r\n  amount: number;\r\n  reason: string;\r\n  description?: string;\r\n  penaltyDate?: string;\r\n  issueDate?: string;\r\n  status?: string;\r\n  createdAt?: string;\r\n  createdBy?: string;\r\n  createdByName?: string;\r\n  issuerSystemId?: string;\r\n  issuerName?: string;\r\n  approvedAt?: string;\r\n  approvedBy?: string;\r\n  approvedByName?: string;\r\n  note?: string;\r\n}\r\n\r\n/**\r\n * Chuyển đổi Penalty entity sang PenaltyForPrint\r\n */\r\nexport function convertPenaltyForPrint(\r\n  penalty: PenaltyLike,\r\n  options: {\r\n    branch?: Branch | null;\r\n    employee?: Employee | null;\r\n    issuer?: Employee | null;\r\n    creator?: Employee | null;\r\n    approver?: Employee | null;\r\n  } = {}\r\n): PenaltyForPrint {\r\n  const { branch, employee, issuer, creator, approver } = options;\r\n\r\n  // Map trạng thái sang tiếng Việt\r\n  const statusMap: Record<string, string> = {\r\n    'draft': 'Nháp',\r\n    'pending': 'Chờ duyệt',\r\n    'approved': 'Đã duyệt',\r\n    'executed': 'Đã thực hiện',\r\n    'cancelled': 'Đã hủy',\r\n  };\r\n\r\n  const typeMap: Record<string, string> = {\r\n    'late': 'Đi muộn',\r\n    'absent': 'Vắng mặt',\r\n    'violation': 'Vi phạm nội quy',\r\n    'performance': 'Hiệu suất kém',\r\n    'other': 'Khác',\r\n  };\r\n\r\n  return {\r\n    // Thông tin cơ bản\r\n    code: penalty.id,\r\n    createdAt: penalty.createdAt,\r\n    penaltyDate: penalty.penaltyDate || penalty.issueDate,\r\n    createdBy: issuer?.fullName || creator?.fullName || penalty.issuerName || penalty.createdByName,\r\n    approvedAt: penalty.approvedAt,\r\n    approvedBy: approver?.fullName || penalty.approvedByName,\r\n    \r\n    // Trạng thái\r\n    status: penalty.status ? (statusMap[penalty.status] || penalty.status) : undefined,\r\n    penaltyType: penalty.penaltyTypeName || (penalty.type ? (typeMap[penalty.type] || penalty.type) : undefined),\r\n    \r\n    // Chi nhánh\r\n    location: branch ? {\r\n      name: branch.name,\r\n      address: branch.address,\r\n      province: branch.province,\r\n    } : penalty.branchName ? {\r\n      name: penalty.branchName,\r\n    } : undefined,\r\n    \r\n    // Nhân viên bị phạt\r\n    employeeName: employee?.fullName || penalty.employeeName,\r\n    employeeCode: employee?.id || penalty.employeeCode,\r\n    department: employee?.department || penalty.employeeDepartment,\r\n    employeePosition: employee?.jobTitle || penalty.employeePosition,\r\n    \r\n    // Nội dung phạt\r\n    amount: penalty.amount,\r\n    reason: penalty.reason,\r\n    violationDescription: penalty.description,\r\n    \r\n    note: penalty.note,\r\n  };\r\n}\r\n\r\n/**\r\n * Tạo StoreSettings từ storeInfo\r\n */\r\nexport function createStoreSettings(storeInfo?: {\r\n  companyName?: string;\r\n  brandName?: string;\r\n  hotline?: string;\r\n  email?: string;\r\n  website?: string;\r\n  taxCode?: string;\r\n  headquartersAddress?: string;\r\n  province?: string;\r\n  logo?: string;\r\n}): StoreSettings {\r\n  // Fallback lấy từ general-settings nếu storeInfo trống\r\n  const generalSettings = getGeneralSettings();\r\n  return {\r\n    name: storeInfo?.companyName || storeInfo?.brandName || generalSettings?.companyName || '',\r\n    address: storeInfo?.headquartersAddress || generalSettings?.companyAddress || '',\r\n    phone: storeInfo?.hotline || generalSettings?.phoneNumber || '',\r\n    email: storeInfo?.email || generalSettings?.email || '',\r\n    website: storeInfo?.website,\r\n    taxCode: storeInfo?.taxCode,\r\n    province: storeInfo?.province,\r\n    logo: getStoreLogo(storeInfo?.logo),\r\n  };\r\n}\r\n\r\n// Re-export mappers\r\nexport {\r\n  mapPenaltyToPrintData,\r\n};\r\n"],"names":[],"mappings":"AAAA;;;CAGC;;;;;;AAID;AAIA;;;AAqCO,SAAS,uBACd,OAAoB,EACpB,UAMI,CAAC,CAAC;IAEN,MAAM,EAAE,MAAM,EAAE,QAAQ,EAAE,MAAM,EAAE,OAAO,EAAE,QAAQ,EAAE,GAAG;IAExD,iCAAiC;IACjC,MAAM,YAAoC;QACxC,SAAS;QACT,WAAW;QACX,YAAY;QACZ,YAAY;QACZ,aAAa;IACf;IAEA,MAAM,UAAkC;QACtC,QAAQ;QACR,UAAU;QACV,aAAa;QACb,eAAe;QACf,SAAS;IACX;IAEA,OAAO;QACL,mBAAmB;QACnB,MAAM,QAAQ,EAAE;QAChB,WAAW,QAAQ,SAAS;QAC5B,aAAa,QAAQ,WAAW,IAAI,QAAQ,SAAS;QACrD,WAAW,QAAQ,YAAY,SAAS,YAAY,QAAQ,UAAU,IAAI,QAAQ,aAAa;QAC/F,YAAY,QAAQ,UAAU;QAC9B,YAAY,UAAU,YAAY,QAAQ,cAAc;QAExD,aAAa;QACb,QAAQ,QAAQ,MAAM,GAAI,SAAS,CAAC,QAAQ,MAAM,CAAC,IAAI,QAAQ,MAAM,GAAI;QACzE,aAAa,QAAQ,eAAe,IAAI,CAAC,QAAQ,IAAI,GAAI,OAAO,CAAC,QAAQ,IAAI,CAAC,IAAI,QAAQ,IAAI,GAAI,SAAS;QAE3G,YAAY;QACZ,UAAU,SAAS;YACjB,MAAM,OAAO,IAAI;YACjB,SAAS,OAAO,OAAO;YACvB,UAAU,OAAO,QAAQ;QAC3B,IAAI,QAAQ,UAAU,GAAG;YACvB,MAAM,QAAQ,UAAU;QAC1B,IAAI;QAEJ,oBAAoB;QACpB,cAAc,UAAU,YAAY,QAAQ,YAAY;QACxD,cAAc,UAAU,MAAM,QAAQ,YAAY;QAClD,YAAY,UAAU,cAAc,QAAQ,kBAAkB;QAC9D,kBAAkB,UAAU,YAAY,QAAQ,gBAAgB;QAEhE,gBAAgB;QAChB,QAAQ,QAAQ,MAAM;QACtB,QAAQ,QAAQ,MAAM;QACtB,sBAAsB,QAAQ,WAAW;QAEzC,MAAM,QAAQ,IAAI;IACpB;AACF;AAKO,SAAS,oBAAoB,SAUnC;IACC,uDAAuD;IACvD,MAAM,kBAAkB,IAAA,gJAAkB;IAC1C,OAAO;QACL,MAAM,WAAW,eAAe,WAAW,aAAa,iBAAiB,eAAe;QACxF,SAAS,WAAW,uBAAuB,iBAAiB,kBAAkB;QAC9E,OAAO,WAAW,WAAW,iBAAiB,eAAe;QAC7D,OAAO,WAAW,SAAS,iBAAiB,SAAS;QACrD,SAAS,WAAW;QACpB,SAAS,WAAW;QACpB,UAAU,WAAW;QACrB,MAAM,IAAA,0IAAY,EAAC,WAAW;IAChC;AACF"}},
    {"offset": {"line": 2628, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/lib/print-mappers/leave.mapper.ts"],"sourcesContent":["/**\r\n * Leave Mapper - Đơn nghỉ phép\r\n * Đồng bộ với variables/don-nghi-phep.ts\r\n */\r\n\r\nimport { \r\n  PrintData, \r\n  formatCurrency,\r\n  numberToWords,\r\n  formatDate,\r\n  formatTime,\r\n  getStoreData,\r\n  StoreSettings\r\n} from './types';\r\n\r\nexport interface LeaveForPrint {\r\n  // Thông tin cơ bản\r\n  code: string;\r\n  createdAt?: string | Date;\r\n  requestDate?: string | Date;\r\n  createdBy?: string;\r\n  \r\n  // Thông tin chi nhánh\r\n  location?: {\r\n    name?: string;\r\n    address?: string;\r\n    province?: string;\r\n    phone?: string;\r\n  };\r\n  \r\n  // Thông tin nhân viên\r\n  employeeName: string;\r\n  employeeCode?: string;\r\n  employeePhone?: string;\r\n  employeeEmail?: string;\r\n  employeePosition?: string;\r\n  department?: string;\r\n  \r\n  // Thông tin nghỉ phép\r\n  leaveTypeName: string;\r\n  leaveTypeIsPaid?: boolean;\r\n  startDate: string | Date;\r\n  endDate: string | Date;\r\n  numberOfDays: number;\r\n  reason: string;\r\n  \r\n  // Phê duyệt\r\n  status?: string;\r\n  approvedBy?: string;\r\n  approvedAt?: string | Date;\r\n  rejectedBy?: string;\r\n  rejectedAt?: string | Date;\r\n  rejectionReason?: string;\r\n  \r\n  note?: string;\r\n}\r\n\r\nexport function mapLeaveToPrintData(leave: LeaveForPrint, storeSettings: StoreSettings): PrintData {\r\n  return {\r\n    ...getStoreData(storeSettings),\r\n    \r\n    // === THÔNG TIN CHI NHÁNH ===\r\n    '{location_name}': leave.location?.name || storeSettings.name || '',\r\n    '{location_address}': leave.location?.address || storeSettings.address || '',\r\n    '{location_province}': leave.location?.province || '',\r\n    '{location_phone}': leave.location?.phone || storeSettings.phone || '',\r\n    '{store_province}': storeSettings.province || '',\r\n    \r\n    // === THÔNG TIN ĐƠN NGHỈ PHÉP ===\r\n    '{leave_code}': leave.code,\r\n    '{created_on}': formatDate(leave.createdAt || leave.requestDate),\r\n    '{created_on_time}': formatTime(leave.createdAt),\r\n    '{request_date}': formatDate(leave.requestDate),\r\n    '{account_name}': leave.createdBy || '',\r\n    \r\n    // === THÔNG TIN NHÂN VIÊN ===\r\n    '{employee_name}': leave.employeeName,\r\n    '{employee_code}': leave.employeeCode || '',\r\n    '{employee_phone}': leave.employeePhone || '',\r\n    '{employee_email}': leave.employeeEmail || '',\r\n    '{employee_position}': leave.employeePosition || '',\r\n    '{position_name}': leave.employeePosition || '',\r\n    '{department_name}': leave.department || '',\r\n    '{department}': leave.department || '',\r\n    \r\n    // === THÔNG TIN NGHỈ PHÉP ===\r\n    '{leave_type}': leave.leaveTypeName,\r\n    '{leave_type_name}': leave.leaveTypeName,\r\n    '{leave_paid}': leave.leaveTypeIsPaid ? 'Có lương' : 'Không lương',\r\n    '{start_date}': formatDate(leave.startDate),\r\n    '{end_date}': formatDate(leave.endDate),\r\n    '{date_range}': `${formatDate(leave.startDate)} - ${formatDate(leave.endDate)}`,\r\n    '{number_of_days}': String(leave.numberOfDays),\r\n    '{reason}': leave.reason,\r\n    \r\n    // === TRẠNG THÁI ===\r\n    '{status}': leave.status || '',\r\n    '{approved_by}': leave.approvedBy || '',\r\n    '{approved_date}': formatDate(leave.approvedAt),\r\n    '{rejected_by}': leave.rejectedBy || '',\r\n    '{rejected_date}': formatDate(leave.rejectedAt),\r\n    '{rejection_reason}': leave.rejectionReason || '',\r\n    \r\n    // === GHI CHÚ ===\r\n    '{note}': leave.note || '',\r\n  };\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;;;CAGC,GAED;AAAA;;AAoDO,SAAS,oBAAoB,KAAoB,EAAE,aAA4B;IACpF,OAAO;QACL,GAAG,IAAA,0IAAY,EAAC,cAAc;QAE9B,8BAA8B;QAC9B,mBAAmB,MAAM,QAAQ,EAAE,QAAQ,cAAc,IAAI,IAAI;QACjE,sBAAsB,MAAM,QAAQ,EAAE,WAAW,cAAc,OAAO,IAAI;QAC1E,uBAAuB,MAAM,QAAQ,EAAE,YAAY;QACnD,oBAAoB,MAAM,QAAQ,EAAE,SAAS,cAAc,KAAK,IAAI;QACpE,oBAAoB,cAAc,QAAQ,IAAI;QAE9C,kCAAkC;QAClC,gBAAgB,MAAM,IAAI;QAC1B,gBAAgB,IAAA,wIAAU,EAAC,MAAM,SAAS,IAAI,MAAM,WAAW;QAC/D,qBAAqB,IAAA,wIAAU,EAAC,MAAM,SAAS;QAC/C,kBAAkB,IAAA,wIAAU,EAAC,MAAM,WAAW;QAC9C,kBAAkB,MAAM,SAAS,IAAI;QAErC,8BAA8B;QAC9B,mBAAmB,MAAM,YAAY;QACrC,mBAAmB,MAAM,YAAY,IAAI;QACzC,oBAAoB,MAAM,aAAa,IAAI;QAC3C,oBAAoB,MAAM,aAAa,IAAI;QAC3C,uBAAuB,MAAM,gBAAgB,IAAI;QACjD,mBAAmB,MAAM,gBAAgB,IAAI;QAC7C,qBAAqB,MAAM,UAAU,IAAI;QACzC,gBAAgB,MAAM,UAAU,IAAI;QAEpC,8BAA8B;QAC9B,gBAAgB,MAAM,aAAa;QACnC,qBAAqB,MAAM,aAAa;QACxC,gBAAgB,MAAM,eAAe,GAAG,aAAa;QACrD,gBAAgB,IAAA,wIAAU,EAAC,MAAM,SAAS;QAC1C,cAAc,IAAA,wIAAU,EAAC,MAAM,OAAO;QACtC,gBAAgB,GAAG,IAAA,wIAAU,EAAC,MAAM,SAAS,EAAE,GAAG,EAAE,IAAA,wIAAU,EAAC,MAAM,OAAO,GAAG;QAC/E,oBAAoB,OAAO,MAAM,YAAY;QAC7C,YAAY,MAAM,MAAM;QAExB,qBAAqB;QACrB,YAAY,MAAM,MAAM,IAAI;QAC5B,iBAAiB,MAAM,UAAU,IAAI;QACrC,mBAAmB,IAAA,wIAAU,EAAC,MAAM,UAAU;QAC9C,iBAAiB,MAAM,UAAU,IAAI;QACrC,mBAAmB,IAAA,wIAAU,EAAC,MAAM,UAAU;QAC9C,sBAAsB,MAAM,eAAe,IAAI;QAE/C,kBAAkB;QAClB,UAAU,MAAM,IAAI,IAAI;IAC1B;AACF"}},
    {"offset": {"line": 2689, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/lib/print/leave-print-helper.ts"],"sourcesContent":["/**\r\n * Leave Print Helper\r\n * Helpers để chuẩn bị dữ liệu in cho đơn nghỉ phép\r\n */\r\n\r\nimport type { Branch } from '../../features/settings/branches/types';\r\nimport type { Employee } from '../../features/employees/types';\r\nimport { \r\n  LeaveForPrint, \r\n  mapLeaveToPrintData, \r\n} from '../print-mappers/leave.mapper';\r\nimport { StoreSettings, getStoreLogo, getGeneralSettings } from '../print-service';\r\n\r\n// Interface cho leave - flexible để nhận nhiều type\r\ninterface LeaveLike {\r\n  systemId: string;\r\n  id: string;\r\n  employeeSystemId?: string;\r\n  employeeId?: string;\r\n  employeeName: string;\r\n  employeeCode?: string;\r\n  employeeDepartment?: string;\r\n  employeePosition?: string;\r\n  branchSystemId?: string;\r\n  branchName?: string;\r\n  leaveTypeSystemId?: string;\r\n  leaveTypeName: string;\r\n  leaveTypeIsPaid?: boolean;\r\n  startDate: string;\r\n  endDate: string;\r\n  numberOfDays: number;\r\n  reason: string;\r\n  status?: string;\r\n  requestDate?: string;\r\n  createdAt?: string;\r\n  createdBy?: string;\r\n  createdByName?: string;\r\n  approvedAt?: string;\r\n  approvedBy?: string;\r\n  approvedByName?: string;\r\n  rejectedAt?: string;\r\n  rejectedBy?: string;\r\n  rejectedByName?: string;\r\n  rejectionReason?: string;\r\n  note?: string;\r\n}\r\n\r\n/**\r\n * Chuyển đổi Leave entity sang LeaveForPrint\r\n */\r\nexport function convertLeaveForPrint(\r\n  leave: LeaveLike,\r\n  options: {\r\n    branch?: Branch | null;\r\n    employee?: Employee | null;\r\n    creator?: Employee | null;\r\n    approver?: Employee | null;\r\n  } = {}\r\n): LeaveForPrint {\r\n  const { branch, employee, creator, approver } = options;\r\n\r\n  return {\r\n    // Thông tin cơ bản\r\n    code: leave.id,\r\n    createdAt: leave.createdAt,\r\n    requestDate: leave.requestDate,\r\n    createdBy: creator?.fullName || leave.createdByName,\r\n    \r\n    // Chi nhánh\r\n    location: branch ? {\r\n      name: branch.name,\r\n      address: branch.address,\r\n      province: branch.province,\r\n    } : leave.branchName ? {\r\n      name: leave.branchName,\r\n    } : undefined,\r\n    \r\n    // Nhân viên\r\n    employeeName: employee?.fullName || leave.employeeName,\r\n    employeeCode: employee?.id || leave.employeeId || leave.employeeCode,\r\n    department: employee?.department || leave.employeeDepartment,\r\n    employeePosition: employee?.jobTitle || leave.employeePosition,\r\n    \r\n    // Thông tin nghỉ phép\r\n    leaveTypeName: leave.leaveTypeName,\r\n    leaveTypeIsPaid: leave.leaveTypeIsPaid,\r\n    startDate: leave.startDate,\r\n    endDate: leave.endDate,\r\n    numberOfDays: leave.numberOfDays,\r\n    reason: leave.reason,\r\n    \r\n    // Trạng thái\r\n    status: leave.status,\r\n    approvedBy: approver?.fullName || leave.approvedByName,\r\n    approvedAt: leave.approvedAt,\r\n    rejectedBy: leave.rejectedByName,\r\n    rejectedAt: leave.rejectedAt,\r\n    rejectionReason: leave.rejectionReason,\r\n    \r\n    note: leave.note,\r\n  };\r\n}\r\n\r\n/**\r\n * Tạo StoreSettings từ storeInfo\r\n */\r\nexport function createStoreSettings(storeInfo?: {\r\n  companyName?: string;\r\n  brandName?: string;\r\n  hotline?: string;\r\n  email?: string;\r\n  website?: string;\r\n  taxCode?: string;\r\n  headquartersAddress?: string;\r\n  province?: string;\r\n  logo?: string;\r\n}): StoreSettings {\r\n  // Fallback lấy từ general-settings nếu storeInfo trống\r\n  const generalSettings = getGeneralSettings();\r\n  return {\r\n    name: storeInfo?.companyName || storeInfo?.brandName || generalSettings?.companyName || '',\r\n    address: storeInfo?.headquartersAddress || generalSettings?.companyAddress || '',\r\n    phone: storeInfo?.hotline || generalSettings?.phoneNumber || '',\r\n    email: storeInfo?.email || generalSettings?.email || '',\r\n    website: storeInfo?.website,\r\n    taxCode: storeInfo?.taxCode,\r\n    province: storeInfo?.province,\r\n    logo: getStoreLogo(storeInfo?.logo),\r\n  };\r\n}\r\n\r\n// Re-export mappers\r\nexport {\r\n  mapLeaveToPrintData,\r\n};\r\n"],"names":[],"mappings":"AAAA;;;CAGC;;;;;;AAID;AAIA;;;AAuCO,SAAS,qBACd,KAAgB,EAChB,UAKI,CAAC,CAAC;IAEN,MAAM,EAAE,MAAM,EAAE,QAAQ,EAAE,OAAO,EAAE,QAAQ,EAAE,GAAG;IAEhD,OAAO;QACL,mBAAmB;QACnB,MAAM,MAAM,EAAE;QACd,WAAW,MAAM,SAAS;QAC1B,aAAa,MAAM,WAAW;QAC9B,WAAW,SAAS,YAAY,MAAM,aAAa;QAEnD,YAAY;QACZ,UAAU,SAAS;YACjB,MAAM,OAAO,IAAI;YACjB,SAAS,OAAO,OAAO;YACvB,UAAU,OAAO,QAAQ;QAC3B,IAAI,MAAM,UAAU,GAAG;YACrB,MAAM,MAAM,UAAU;QACxB,IAAI;QAEJ,YAAY;QACZ,cAAc,UAAU,YAAY,MAAM,YAAY;QACtD,cAAc,UAAU,MAAM,MAAM,UAAU,IAAI,MAAM,YAAY;QACpE,YAAY,UAAU,cAAc,MAAM,kBAAkB;QAC5D,kBAAkB,UAAU,YAAY,MAAM,gBAAgB;QAE9D,sBAAsB;QACtB,eAAe,MAAM,aAAa;QAClC,iBAAiB,MAAM,eAAe;QACtC,WAAW,MAAM,SAAS;QAC1B,SAAS,MAAM,OAAO;QACtB,cAAc,MAAM,YAAY;QAChC,QAAQ,MAAM,MAAM;QAEpB,aAAa;QACb,QAAQ,MAAM,MAAM;QACpB,YAAY,UAAU,YAAY,MAAM,cAAc;QACtD,YAAY,MAAM,UAAU;QAC5B,YAAY,MAAM,cAAc;QAChC,YAAY,MAAM,UAAU;QAC5B,iBAAiB,MAAM,eAAe;QAEtC,MAAM,MAAM,IAAI;IAClB;AACF;AAKO,SAAS,oBAAoB,SAUnC;IACC,uDAAuD;IACvD,MAAM,kBAAkB,IAAA,gJAAkB;IAC1C,OAAO;QACL,MAAM,WAAW,eAAe,WAAW,aAAa,iBAAiB,eAAe;QACxF,SAAS,WAAW,uBAAuB,iBAAiB,kBAAkB;QAC9E,OAAO,WAAW,WAAW,iBAAiB,eAAe;QAC7D,OAAO,WAAW,SAAS,iBAAiB,SAAS;QACrD,SAAS,WAAW;QACpB,SAAS,WAAW;QACpB,UAAU,WAAW;QACrB,MAAM,IAAA,0IAAY,EAAC,WAAW;IAChC;AACF"}},
    {"offset": {"line": 2762, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/lib/api-config.ts"],"sourcesContent":["/**\r\n * API Configuration Utilities\r\n * \r\n * Centralized configuration for API endpoints.\r\n * All API URLs should use these utilities instead of hardcoding.\r\n */\r\n\r\n/**\r\n * Get the API base URL from environment variables\r\n * Falls back to localhost:3001 for development\r\n */\r\nexport function getApiBaseUrl(): string {\r\n  // Use relative path to leverage Vite proxy in development\r\n  // This avoids CORS issues when frontend (5173) talks to backend (3001)\r\n  if ((import.meta as any).env?.DEV) {\r\n    return '/api';\r\n  }\r\n  return (import.meta as any).env?.VITE_API_BASE_URL || 'http://localhost:3001/api';\r\n}\r\n\r\n/**\r\n * Get the base URL without /api suffix\r\n * Falls back to localhost:3001 for development\r\n */\r\nexport function getBaseUrl(): string {\r\n  const apiUrl = getApiBaseUrl();\r\n  return apiUrl.replace('/api', '');\r\n}\r\n\r\n/**\r\n * Build a full file URL from a relative path\r\n * @param relativePath - Relative file path (e.g., \"/uploads/documents/file.pdf\")\r\n * @returns Full URL to the file\r\n */\r\nexport function getFileUrl(relativePath: string): string {\r\n  if (!relativePath) return '';\r\n  \r\n  // If already a full URL, return as is\r\n  if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {\r\n    return relativePath;\r\n  }\r\n  \r\n  // Build full URL\r\n  const baseUrl = getBaseUrl();\r\n  return `${baseUrl}${relativePath}`;\r\n}\r\n\r\n/**\r\n * Build an API endpoint URL\r\n * @param endpoint - API endpoint path (e.g., \"/employees/documents\")\r\n * @returns Full API URL\r\n */\r\nexport function getApiUrl(endpoint: string): string {\r\n  const apiBaseUrl = getApiBaseUrl();\r\n  return `${apiBaseUrl}${endpoint}`;\r\n}\r\n"],"names":[],"mappings":"AAAA;;;;;CAKC,GAED;;;CAGC;;;;;;;;;;;;;;;AACM,SAAS;IACd,0DAA0D;IAC1D,uEAAuE;IACvE,IAAI,8BAAqB,GAAG,EAAE,KAAK;QACjC,OAAO;IACT;IACA,OAAO,8BAAqB,GAAG,EAAE,qBAAqB;AACxD;AAMO,SAAS;IACd,MAAM,SAAS;IACf,OAAO,OAAO,OAAO,CAAC,QAAQ;AAChC;AAOO,SAAS,WAAW,YAAoB;IAC7C,IAAI,CAAC,cAAc,OAAO;IAE1B,sCAAsC;IACtC,IAAI,aAAa,UAAU,CAAC,cAAc,aAAa,UAAU,CAAC,aAAa;QAC7E,OAAO;IACT;IAEA,iBAAiB;IACjB,MAAM,UAAU;IAChB,OAAO,GAAG,UAAU,cAAc;AACpC;AAOO,SAAS,UAAU,QAAgB;IACxC,MAAM,aAAa;IACnB,OAAO,GAAG,aAAa,UAAU;AACnC"}},
    {"offset": {"line": 2818, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/lib/file-upload-api.ts"],"sourcesContent":["// API client để giao tiếp với server - Staging System\r\nimport { getApiBaseUrl } from './api-config';\r\n\r\nconst API_BASE_URL = getApiBaseUrl();\r\n\r\nexport type StagingFile = {\r\n  id: string;\r\n  sessionId: string;\r\n  name: string; // Display name (smart filename với metadata)\r\n  originalName: string; // Tên file gốc\r\n  slug: string; // URL-safe slug\r\n  filename: string; // Tên file hệ thống (UUID) - cần cho preview URL\r\n  size: number;\r\n  type: string;\r\n  url: string;\r\n  status: 'staging' | 'permanent'; // ✅ Support both staging and permanent files\r\n  uploadedAt: string;\r\n  metadata: string; // Smart filename metadata\r\n};\r\n\r\nexport type ServerFile = {\r\n  id: string;\r\n  employeeId: string;\r\n  documentType: string;\r\n  documentName: string;\r\n  name: string; // Display name\r\n  originalName: string; // Tên file gốc\r\n  slug: string; // URL-safe slug\r\n  filename: string; // Tên file hệ thống\r\n  size: number;\r\n  type: string;\r\n  url: string;\r\n  uploadedAt: string;\r\n  confirmedAt?: string;\r\n  metadata: string; // Smart filename metadata\r\n};\r\n\r\nexport type UploadedAsset = {\r\n  id: string;\r\n  name: string;\r\n  size: number;\r\n  type: string;\r\n  url: string;\r\n  uploadedAt: string;\r\n};\r\n\r\nexport type UploadedFile = {\r\n  id: string;\r\n  name: string;\r\n  filename?: string;\r\n  type: string;\r\n  size: number;\r\n  url: string;\r\n  uploadedAt?: string;\r\n  metadata?: Record<string, unknown>;\r\n};\r\n\r\nexport class FileUploadAPI {\r\n  // Upload files vào staging (tạm thời)\r\n  static async uploadToStaging(files: File[], sessionId?: string): Promise<{\r\n    files: StagingFile[];\r\n    sessionId: string;\r\n  }> {\r\n    const formData = new FormData();\r\n    \r\n    files.forEach(file => {\r\n      formData.append('files', file);\r\n    });\r\n\r\n    // CRITICAL FIX: sessionId in FormData doesn't work with multer\r\n    // Send via query params instead\r\n    const url = sessionId \r\n      ? `${API_BASE_URL}/staging/upload?sessionId=${encodeURIComponent(sessionId)}`\r\n      : `${API_BASE_URL}/staging/upload`;\r\n\r\n    console.log('📤 Uploading to:', url);\r\n    console.log('📦 Files:', files.map(f => `${f.name} (${(f.size / 1024).toFixed(1)}KB)`));\r\n\r\n    let response;\r\n    try {\r\n      response = await fetch(url, {\r\n        method: 'POST',\r\n        body: formData,\r\n      });\r\n    } catch (fetchError) {\r\n      console.error('❌ Network fetch failed:', fetchError);\r\n      throw new Error(`Không thể kết nối đến server (${API_BASE_URL}). Vui lòng kiểm tra server có đang chạy.`);\r\n    }\r\n\r\n    if (!response.ok) {\r\n      const errorText = await response.text();\r\n      console.error('❌ Server error:', response.status, errorText);\r\n      throw new Error(`Server error (${response.status}): ${errorText}`);\r\n    }\r\n\r\n    const result = await response.json();\r\n    \r\n    if (!result.success) {\r\n      throw new Error(result.message || 'Staging upload failed');\r\n    }\r\n\r\n    return {\r\n      files: result.files,\r\n      sessionId: result.sessionId\r\n    };\r\n  }\r\n\r\n  // Confirm staging files → permanent với smart filename\r\n  // NOTE: entitySystemId MUST be immutable (systemId) to avoid broken references\r\n  static async confirmStagingFiles(\r\n    sessionId: string,\r\n    entitySystemId: string,\r\n    documentType: string,\r\n    documentName: string,\r\n    metadata?: Record<string, any>\r\n  ): Promise<ServerFile[]> {\r\n    const response = await fetch(\r\n      `${API_BASE_URL}/staging/confirm/${sessionId}/${entitySystemId}/${documentType}/${encodeURIComponent(documentName)}`,\r\n      { \r\n        method: 'POST',\r\n        headers: {\r\n          'Content-Type': 'application/json'\r\n        },\r\n        body: JSON.stringify({ metadata })\r\n      }\r\n    );\r\n\r\n    const result = await response.json();\r\n    \r\n    if (!result.success) {\r\n      throw new Error(result.message || 'Confirm failed');\r\n    }\r\n\r\n    return result.files;\r\n  }\r\n\r\n  // Lấy staging files theo session\r\n  static async getStagingFiles(sessionId: string): Promise<StagingFile[]> {\r\n    const response = await fetch(`${API_BASE_URL}/staging/files/${sessionId}`);\r\n    const result = await response.json();\r\n    \r\n    if (!result.success) {\r\n      throw new Error(result.message || 'Failed to fetch staging files');\r\n    }\r\n\r\n    return result.files;\r\n  }\r\n\r\n  // Xóa staging files (cancel)\r\n  static async deleteStagingFiles(sessionId: string): Promise<void> {\r\n    const response = await fetch(`${API_BASE_URL}/staging/${sessionId}`, {\r\n      method: 'DELETE',\r\n    });\r\n\r\n    const result = await response.json();\r\n    \r\n    if (!result.success) {\r\n      throw new Error(result.message || 'Delete staging failed');\r\n    }\r\n  }\r\n\r\n  // Upload files lên server (legacy - direct permanent)\r\n  // NOTE: employeeId MUST be the systemId (immutable), NOT the business ID\r\n  static async uploadFiles(\r\n    employeeId: string, // ⚠️ MUST use systemId (e.g., \"NV00000001\"), NOT business ID\r\n    documentType: string,\r\n    documentName: string,\r\n    files: File[]\r\n  ): Promise<ServerFile[]> {\r\n    const formData = new FormData();\r\n    \r\n    files.forEach(file => {\r\n      formData.append('files', file);\r\n    });\r\n\r\n    const response = await fetch(\r\n      `${API_BASE_URL}/upload/${employeeId}/${documentType}/${encodeURIComponent(documentName)}`,\r\n      {\r\n        method: 'POST',\r\n        body: formData,\r\n      }\r\n    );\r\n\r\n    const result = await response.json();\r\n    \r\n    if (!result.success) {\r\n      throw new Error(result.message || 'Upload failed');\r\n    }\r\n\r\n    return result.files;\r\n  }\r\n\r\n  // Lấy danh sách file permanent\r\n  // NOTE: employeeId MUST be the systemId (immutable), NOT the business ID\r\n  static async getFiles(\r\n    employeeId: string, // ⚠️ MUST use systemId (e.g., \"NV00000001\"), NOT business ID\r\n    documentType?: string\r\n  ): Promise<ServerFile[]> {\r\n    try {\r\n      const url = documentType \r\n        ? `${API_BASE_URL}/files/${employeeId}/${documentType}`\r\n        : `${API_BASE_URL}/files/${employeeId}`;\r\n\r\n      const response = await fetch(url);\r\n      \r\n      // Check if response is ok\r\n      if (!response.ok) {\r\n        return []; // Return empty array instead of throwing\r\n      }\r\n      \r\n      const result = await response.json();\r\n      \r\n      if (!result.success) {\r\n        return []; // Return empty array instead of throwing\r\n      }\r\n\r\n      return result.files || [];\r\n    } catch (error) {\r\n      return []; // Return empty array on network error\r\n    }\r\n  }\r\n\r\n  // Xóa file permanent\r\n  static async deleteFile(fileId: string): Promise<void> {\r\n    const response = await fetch(`${API_BASE_URL}/files/${fileId}`, {\r\n      method: 'DELETE',\r\n    });\r\n\r\n    const result = await response.json();\r\n    \r\n    if (!result.success) {\r\n      throw new Error(result.message || 'Delete failed');\r\n    }\r\n  }\r\n\r\n  // Lấy URL file để hiển thị (bao gồm staging và permanent)\r\n  static getFileUrl(file: StagingFile | ServerFile): string {\r\n    // ✅ Return relative path to use Vite proxy - avoid CORS\r\n    // Server already returns relative path like /api/staging/files/...\r\n    return file.url;\r\n  }\r\n\r\n  // Thống kê storage (chỉ permanent files)\r\n  static async getStorageInfo(): Promise<{\r\n    totalFiles: number;\r\n    totalSize: number;\r\n    totalSizeMB: number;\r\n  }> {\r\n    const response = await fetch(`${API_BASE_URL}/storage/info`);\r\n    const result = await response.json();\r\n    \r\n    if (!result.success) {\r\n      throw new Error('Failed to get storage info');\r\n    }\r\n\r\n    return result.stats;\r\n  }\r\n\r\n  // Helper: Generate session ID cho staging\r\n  static generateSessionId(): string {\r\n    return `session_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\r\n  }\r\n\r\n  static async getProductFiles(productId: string): Promise<ServerFile[]> {\r\n    return this.getFiles(productId, 'products');\r\n  }\r\n\r\n  // Get customer files (images)\r\n  static async getCustomerFiles(customerId: string): Promise<ServerFile[]> {\r\n    try {\r\n      const response = await fetch(`${API_BASE_URL}/files/customers/${customerId}`);\r\n      \r\n      if (!response.ok) {\r\n        return [];\r\n      }\r\n      \r\n      const result = await response.json();\r\n      \r\n      if (!result.success) {\r\n        return [];\r\n      }\r\n\r\n      return result.files || [];\r\n    } catch (error) {\r\n      console.error('Failed to get customer files:', error);\r\n      return [];\r\n    }\r\n  }\r\n\r\n  // Get customer contract files\r\n  static async getCustomerContractFiles(customerId: string): Promise<ServerFile[]> {\r\n    try {\r\n      const response = await fetch(`${API_BASE_URL}/files/customers/${customerId}/contracts`);\r\n      \r\n      if (!response.ok) {\r\n        return [];\r\n      }\r\n      \r\n      const result = await response.json();\r\n      \r\n      if (!result.success) {\r\n        return [];\r\n      }\r\n\r\n      return result.files || [];\r\n    } catch (error) {\r\n      console.error('Failed to get customer contract files:', error);\r\n      return [];\r\n    }\r\n  }\r\n\r\n  // Confirm customer contract files from staging to permanent\r\n  static async confirmCustomerContractFiles(\r\n    sessionId: string,\r\n    customerId: string,\r\n    customerData?: Record<string, any>\r\n  ): Promise<ServerFile[]> {\r\n    const response = await fetch(\r\n      `${API_BASE_URL}/staging/confirm/${sessionId}/customers/${customerId}/contracts`,\r\n      { \r\n        method: 'POST',\r\n        headers: {\r\n          'Content-Type': 'application/json'\r\n        },\r\n        body: JSON.stringify({ customerData })\r\n      }\r\n    );\r\n\r\n    const result = await response.json();\r\n    \r\n    if (!result.success) {\r\n      throw new Error(result.message || 'Confirm customer contract files failed');\r\n    }\r\n\r\n    return result.files;\r\n  }\r\n\r\n  // Confirm customer images from staging to permanent\r\n  static async confirmCustomerImages(\r\n    sessionId: string,\r\n    customerId: string,\r\n    customerData?: {\r\n      name?: string;\r\n      [key: string]: any;\r\n    }\r\n  ): Promise<ServerFile[]> {\r\n    const response = await fetch(\r\n      `${API_BASE_URL}/staging/confirm/${sessionId}/customers/${customerId}`,\r\n      { \r\n        method: 'POST',\r\n        headers: {\r\n          'Content-Type': 'application/json'\r\n        },\r\n        body: JSON.stringify({ customerData })\r\n      }\r\n    );\r\n\r\n    const result = await response.json();\r\n    \r\n    if (!result.success) {\r\n      throw new Error(result.message || 'Confirm customer images failed');\r\n    }\r\n\r\n    return result.files;\r\n  }\r\n\r\n  // Confirm warranty images from staging to permanent\r\n  static async confirmWarrantyImages(\r\n    sessionId: string,\r\n    warrantyId: string,\r\n    imageType: 'received' | 'processed',\r\n    warrantyData?: {\r\n      customerName?: string;\r\n      [key: string]: any;\r\n    }\r\n  ): Promise<ServerFile[]> {\r\n    const response = await fetch(\r\n      `${API_BASE_URL}/staging/confirm/${sessionId}/warranty/${warrantyId}/${imageType}`,\r\n      { \r\n        method: 'POST',\r\n        headers: {\r\n          'Content-Type': 'application/json'\r\n        },\r\n        body: JSON.stringify({ warrantyData })\r\n      }\r\n    );\r\n\r\n    const result = await response.json();\r\n    \r\n    if (!result.success) {\r\n      throw new Error(result.message || 'Confirm warranty images failed');\r\n    }\r\n\r\n    return result.files;\r\n  }\r\n\r\n  // Delete staging session (cleanup on cancel)\r\n  static async deleteStagingSession(sessionId: string): Promise<void> {\r\n    const response = await fetch(\r\n      `${API_BASE_URL}/staging/${sessionId}`,\r\n      { method: 'DELETE' }\r\n    );\r\n\r\n    const result = await response.json();\r\n    \r\n    if (!result.success) {\r\n      throw new Error(result.message || 'Delete staging session failed');\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Upload ảnh từ TipTap Editor vào STAGING\r\n   * Ảnh sẽ được move sang permanent khi entity được save\r\n   * \r\n   * @param file - File ảnh cần upload\r\n   * @param sessionId - Session ID để group các ảnh cùng editor\r\n   * @returns StagingFile với URL tạm thời\r\n   */\r\n  static async uploadEditorImageToStaging(file: File, sessionId?: string): Promise<{\r\n    file: StagingFile;\r\n    sessionId: string;\r\n  }> {\r\n    const result = await FileUploadAPI.uploadToStaging([file], sessionId);\r\n    return {\r\n      file: result.files[0],\r\n      sessionId: result.sessionId,\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Confirm ảnh editor từ staging sang permanent\r\n   * Đồng thời replace staging URLs trong HTML content bằng permanent URLs\r\n   * \r\n   * @param sessionId - Editor staging session\r\n   * @param entityId - ID của entity (category, product, etc.)\r\n   * @param entityType - Loại entity ('categories', 'products', etc.)\r\n   * @param htmlContent - Nội dung HTML cần update URLs\r\n   * @returns Updated HTML với permanent URLs\r\n   */\r\n  static async confirmEditorImages(\r\n    sessionId: string,\r\n    entityId: string,\r\n    entityType: string,\r\n    htmlContent: string\r\n  ): Promise<{ html: string; files: ServerFile[] }> {\r\n    // Confirm staging files\r\n    const confirmedFiles = await FileUploadAPI.confirmStagingFiles(\r\n      sessionId,\r\n      entityId,\r\n      entityType,\r\n      'editor-images',\r\n      { source: 'tiptap-editor' }\r\n    );\r\n\r\n    // Replace staging URLs with permanent URLs in HTML\r\n    let updatedHtml = htmlContent;\r\n    for (const file of confirmedFiles) {\r\n      // Staging URL pattern: /api/staging/preview/{sessionId}/{filename}\r\n      // Find and replace with permanent URL\r\n      const stagingPattern = new RegExp(\r\n        `/api/staging/preview/[^/]+/${file.filename.replace(/[.*+?^${}()|[\\]\\\\]/g, '\\\\$&')}`,\r\n        'g'\r\n      );\r\n      updatedHtml = updatedHtml.replace(stagingPattern, file.url);\r\n    }\r\n\r\n    return {\r\n      html: updatedHtml,\r\n      files: confirmedFiles,\r\n    };\r\n  }\r\n\r\n  static async uploadCommentImage(file: File): Promise<UploadedAsset> {\r\n    const formData = new FormData();\r\n    formData.append('image', file);\r\n\r\n    const response = await fetch(`${API_BASE_URL}/comments/upload-image`, {\r\n      method: 'POST',\r\n      body: formData,\r\n    });\r\n\r\n    const result = await response.json();\r\n    if (!response.ok || !result.success) {\r\n      throw new Error(result.message || 'Upload ảnh bình luận thất bại');\r\n    }\r\n\r\n    return FileUploadAPI.mapDirectUpload(result.file, file.name);\r\n  }\r\n\r\n  static async uploadPrintTemplateImage(file: File): Promise<UploadedAsset> {\r\n    const formData = new FormData();\r\n    formData.append('image', file);\r\n\r\n    const response = await fetch(`${API_BASE_URL}/print-templates/upload-image`, {\r\n      method: 'POST',\r\n      body: formData,\r\n    });\r\n\r\n    const result = await response.json();\r\n    if (!response.ok || !result.success) {\r\n      throw new Error(result.message || 'Upload ảnh mẫu in thất bại');\r\n    }\r\n\r\n    return FileUploadAPI.mapDirectUpload(result.file, file.name);\r\n  }\r\n\r\n  static async uploadComplaintCommentImage(complaintId: string, file: File): Promise<UploadedAsset> {\r\n    const formData = new FormData();\r\n    formData.append('image', file);\r\n\r\n    const response = await fetch(`${API_BASE_URL}/complaints/${complaintId}/comments/upload`, {\r\n      method: 'POST',\r\n      body: formData,\r\n    });\r\n\r\n    const result = await response.json();\r\n    if (!response.ok || !result.success) {\r\n      throw new Error(result.message || 'Upload ảnh khiếu nại thất bại');\r\n    }\r\n\r\n    return FileUploadAPI.mapDirectUpload(result.file, file.name);\r\n  }\r\n\r\n  static async uploadTaskEvidence(taskId: string, files: File[]): Promise<UploadedAsset[]> {\r\n    if (files.length === 0) {\r\n      return [];\r\n    }\r\n\r\n    const formData = new FormData();\r\n    files.forEach((file) => formData.append('files', file));\r\n\r\n    const response = await fetch(`${API_BASE_URL}/tasks/${taskId}/evidence`, {\r\n      method: 'POST',\r\n      body: formData,\r\n    });\r\n\r\n    const result = await response.json();\r\n    if (!response.ok || !result.success) {\r\n      throw new Error(result.message || 'Upload bằng chứng công việc thất bại');\r\n    }\r\n\r\n    return (result.files || []).map((file: any, index: number) =>\r\n      FileUploadAPI.mapDirectUpload(file, files[index]?.name || `evidence-${index}`)\r\n    );\r\n  }\r\n\r\n  private static mapDirectUpload(file: any, fallbackName: string): UploadedAsset {\r\n    return {\r\n      id: file.id,\r\n      name: file.originalName || file.name || fallbackName,\r\n      size: file.size || file.filesize || 0,\r\n      type: file.mimetype || file.type || 'application/octet-stream',\r\n      url: file.url,\r\n      uploadedAt: file.uploadedAt || new Date().toISOString(),\r\n    };\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 3178, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/lib/settings-sync-helper.ts"],"sourcesContent":["/**\r\n * Settings API Sync Helper\r\n * \r\n * Helper functions to sync settings stores with PostgreSQL API\r\n */\r\n\r\nconst API_BASE = '/api/settings';\r\n\r\nexport interface SettingSyncConfig {\r\n  group: string;\r\n  key?: string;\r\n}\r\n\r\n/**\r\n * Fetch settings from API by group\r\n */\r\nexport async function fetchSettingsFromAPI<T>(config: SettingSyncConfig): Promise<T | null> {\r\n  try {\r\n    const params = new URLSearchParams();\r\n    params.set('group', config.group);\r\n    if (config.key) {\r\n      params.set('key', config.key);\r\n    }\r\n    \r\n    const response = await fetch(`${API_BASE}?${params.toString()}`);\r\n    if (!response.ok) {\r\n      throw new Error(`Failed to fetch settings: ${response.statusText}`);\r\n    }\r\n    \r\n    const data = await response.json();\r\n    \r\n    // If specific key requested, return the value\r\n    if (config.key && data.value !== undefined) {\r\n      return data.value as T;\r\n    }\r\n    \r\n    // Return grouped data for the specified group\r\n    return data.grouped?.[config.group] as T || null;\r\n  } catch (error) {\r\n    console.error(`[Settings Sync] Error fetching ${config.group}:`, error);\r\n    return null;\r\n  }\r\n}\r\n\r\n/**\r\n * Save settings to API\r\n */\r\nexport async function saveSettingsToAPI(\r\n  group: string,\r\n  key: string,\r\n  value: any,\r\n  description?: string\r\n): Promise<boolean> {\r\n  try {\r\n    const response = await fetch(API_BASE, {\r\n      method: 'POST',\r\n      headers: {\r\n        'Content-Type': 'application/json',\r\n      },\r\n      body: JSON.stringify({\r\n        group,\r\n        key,\r\n        value: typeof value === 'object' ? JSON.stringify(value) : value,\r\n        description,\r\n      }),\r\n    });\r\n    \r\n    if (!response.ok) {\r\n      throw new Error(`Failed to save setting: ${response.statusText}`);\r\n    }\r\n    \r\n    return true;\r\n  } catch (error) {\r\n    console.error(`[Settings Sync] Error saving ${group}.${key}:`, error);\r\n    return false;\r\n  }\r\n}\r\n\r\n/**\r\n * Bulk save settings to API\r\n */\r\nexport async function bulkSaveSettingsToAPI(\r\n  group: string,\r\n  settings: Record<string, any>\r\n): Promise<boolean> {\r\n  try {\r\n    const settingsArray = Object.entries(settings).map(([key, value]) => ({\r\n      group,\r\n      key,\r\n      value: typeof value === 'object' ? JSON.stringify(value) : value,\r\n    }));\r\n    \r\n    const response = await fetch(API_BASE, {\r\n      method: 'PUT',\r\n      headers: {\r\n        'Content-Type': 'application/json',\r\n      },\r\n      body: JSON.stringify({ settings: settingsArray }),\r\n    });\r\n    \r\n    if (!response.ok) {\r\n      throw new Error(`Failed to bulk save settings: ${response.statusText}`);\r\n    }\r\n    \r\n    return true;\r\n  } catch (error) {\r\n    console.error(`[Settings Sync] Error bulk saving ${group}:`, error);\r\n    return false;\r\n  }\r\n}\r\n\r\n/**\r\n * Create a settings sync middleware for Zustand stores\r\n * This wraps store actions to also sync to API\r\n */\r\nexport function createSettingsSyncMiddleware(group: string) {\r\n  return (setter: Function) => {\r\n    return (partialState: any) => {\r\n      // Apply local state first\r\n      setter(partialState);\r\n      \r\n      // Sync to API in background\r\n      if (typeof partialState === 'object' && partialState !== null) {\r\n        bulkSaveSettingsToAPI(group, partialState).catch(console.error);\r\n      }\r\n    };\r\n  };\r\n}\r\n\r\n/**\r\n * Hook to initialize settings from API\r\n */\r\nexport async function initializeSettingsFromAPI<T>(\r\n  group: string,\r\n  setSettings: (settings: T) => void,\r\n  defaultSettings: T\r\n): Promise<void> {\r\n  const apiSettings = await fetchSettingsFromAPI<T>({ group });\r\n  \r\n  if (apiSettings) {\r\n    // Parse JSON strings back to objects if needed\r\n    const parsedSettings = Object.entries(apiSettings).reduce((acc, [key, value]) => {\r\n      try {\r\n        if (typeof value === 'string' && (value.startsWith('{') || value.startsWith('['))) {\r\n          acc[key as keyof T] = JSON.parse(value);\r\n        } else {\r\n          acc[key as keyof T] = value as T[keyof T];\r\n        }\r\n      } catch {\r\n        acc[key as keyof T] = value as T[keyof T];\r\n      }\r\n      return acc;\r\n    }, {} as T);\r\n    \r\n    setSettings({ ...defaultSettings, ...parsedSettings });\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 3309, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/lib/active-timer-sync.ts"],"sourcesContent":["/**\r\n * Active Timer Sync Utilities\r\n * \r\n * Sync active timer with database as source of truth\r\n * Uses in-memory cache for fast synchronous access\r\n * \r\n * NOTE: localStorage has been removed - all data comes from API/database\r\n */\r\n\r\ninterface ActiveTimerData {\r\n  taskId: string\r\n  startedAt: string\r\n  description?: string\r\n}\r\n\r\n// In-memory cache for fast synchronous access\r\nlet timerCache: ActiveTimerData | null = null\r\n\r\n/**\r\n * Save timer to database\r\n */\r\nexport async function saveActiveTimer(\r\n  userId: string,\r\n  taskId: string,\r\n  startedAt: string,\r\n  description?: string\r\n): Promise<boolean> {\r\n  // Update in-memory cache\r\n  timerCache = { taskId, startedAt, description }\r\n\r\n  // Save to database for persistence\r\n  try {\r\n    const res = await fetch('/api/active-timer', {\r\n      method: 'POST',\r\n      headers: { 'Content-Type': 'application/json' },\r\n      body: JSON.stringify({\r\n        userId,\r\n        taskId,\r\n        startTime: startedAt,\r\n        description,\r\n      }),\r\n    })\r\n    return res.ok\r\n  } catch (error) {\r\n    console.error('Failed to save active timer to database:', error)\r\n    return false\r\n  }\r\n}\r\n\r\n/**\r\n * Remove timer from database\r\n */\r\nexport async function removeActiveTimer(userId: string): Promise<boolean> {\r\n  // Clear in-memory cache\r\n  timerCache = null\r\n\r\n  // Remove from database\r\n  try {\r\n    const res = await fetch(`/api/active-timer?userId=${userId}`, {\r\n      method: 'DELETE',\r\n    })\r\n    return res.ok\r\n  } catch (error) {\r\n    console.error('Failed to remove active timer from database:', error)\r\n    return false\r\n  }\r\n}\r\n\r\n/**\r\n * Load timer from database\r\n */\r\nexport async function loadActiveTimer(userId: string): Promise<ActiveTimerData | null> {\r\n  // Return from cache if available\r\n  if (timerCache) {\r\n    return timerCache\r\n  }\r\n\r\n  // Fetch from database\r\n  try {\r\n    const res = await fetch(`/api/active-timer?userId=${userId}`)\r\n    if (res.ok) {\r\n      const data = await res.json()\r\n      if (data?.taskId && data?.startTime) {\r\n        const timerData: ActiveTimerData = {\r\n          taskId: data.taskId,\r\n          startedAt: data.startTime,\r\n          description: data.description,\r\n        }\r\n        \r\n        // Update cache\r\n        timerCache = timerData\r\n        \r\n        return timerData\r\n      }\r\n    }\r\n  } catch (error) {\r\n    console.error('Failed to load active timer from database:', error)\r\n  }\r\n\r\n  return null\r\n}\r\n\r\n/**\r\n * Get timer from cache only (synchronous)\r\n */\r\nexport function getActiveTimerSync(): ActiveTimerData | null {\r\n  return timerCache\r\n}\r\n"],"names":[],"mappings":"AAAA;;;;;;;CAOC;;;;;;;;;;AAQD,8CAA8C;AAC9C,IAAI,aAAqC;AAKlC,eAAe,gBACpB,MAAc,EACd,MAAc,EACd,SAAiB,EACjB,WAAoB;IAEpB,yBAAyB;IACzB,aAAa;QAAE;QAAQ;QAAW;IAAY;IAE9C,mCAAmC;IACnC,IAAI;QACF,MAAM,MAAM,MAAM,MAAM,qBAAqB;YAC3C,QAAQ;YACR,SAAS;gBAAE,gBAAgB;YAAmB;YAC9C,MAAM,KAAK,SAAS,CAAC;gBACnB;gBACA;gBACA,WAAW;gBACX;YACF;QACF;QACA,OAAO,IAAI,EAAE;IACf,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,4CAA4C;QAC1D,OAAO;IACT;AACF;AAKO,eAAe,kBAAkB,MAAc;IACpD,wBAAwB;IACxB,aAAa;IAEb,uBAAuB;IACvB,IAAI;QACF,MAAM,MAAM,MAAM,MAAM,CAAC,yBAAyB,EAAE,QAAQ,EAAE;YAC5D,QAAQ;QACV;QACA,OAAO,IAAI,EAAE;IACf,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,gDAAgD;QAC9D,OAAO;IACT;AACF;AAKO,eAAe,gBAAgB,MAAc;IAClD,iCAAiC;IACjC,IAAI,YAAY;QACd,OAAO;IACT;IAEA,sBAAsB;IACtB,IAAI;QACF,MAAM,MAAM,MAAM,MAAM,CAAC,yBAAyB,EAAE,QAAQ;QAC5D,IAAI,IAAI,EAAE,EAAE;YACV,MAAM,OAAO,MAAM,IAAI,IAAI;YAC3B,IAAI,MAAM,UAAU,MAAM,WAAW;gBACnC,MAAM,YAA6B;oBACjC,QAAQ,KAAK,MAAM;oBACnB,WAAW,KAAK,SAAS;oBACzB,aAAa,KAAK,WAAW;gBAC/B;gBAEA,eAAe;gBACf,aAAa;gBAEb,OAAO;YACT;QACF;IACF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,8CAA8C;IAC9D;IAEA,OAAO;AACT;AAKO,SAAS;IACd,OAAO;AACT"}},
    {"offset": {"line": 3405, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/lib/security-utils.ts"],"sourcesContent":["/**\r\n * Security utilities for handling sensitive data\r\n * \r\n * ⚠️ IMPORTANT: These are CLIENT-SIDE utilities for basic protection.\r\n * Real password hashing MUST be done on the server with bcrypt/argon2.\r\n * These functions are for:\r\n * 1. Preventing plain-text storage in localStorage during development\r\n * 2. Adding a layer of obfuscation until backend is implemented\r\n */\r\n\r\n/**\r\n * Simple hash for client-side obfuscation (NOT cryptographically secure)\r\n * Should be replaced with server-side bcrypt when backend is ready\r\n */\r\nexport async function hashPassword(password: string): Promise<string> {\r\n  // Use SubtleCrypto for SHA-256 hash\r\n  const encoder = new TextEncoder();\r\n  const data = encoder.encode(password);\r\n  const hashBuffer = await crypto.subtle.digest('SHA-256', data);\r\n  const hashArray = Array.from(new Uint8Array(hashBuffer));\r\n  const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');\r\n  \r\n  // Prefix to indicate this is a hashed password\r\n  return `sha256:${hashHex}`;\r\n}\r\n\r\n/**\r\n * Check if a string is already hashed\r\n */\r\nexport function isPasswordHashed(value: string): boolean {\r\n  return value.startsWith('sha256:') || value.startsWith('$2b$'); // SHA-256 or bcrypt\r\n}\r\n\r\n/**\r\n * Verify password against stored hash (client-side only)\r\n */\r\nexport async function verifyPassword(password: string, storedHash: string): Promise<boolean> {\r\n  if (!isPasswordHashed(storedHash)) {\r\n    // Legacy plain text - compare directly (for migration)\r\n    return password === storedHash;\r\n  }\r\n  \r\n  if (storedHash.startsWith('sha256:')) {\r\n    const hashedInput = await hashPassword(password);\r\n    return hashedInput === storedHash;\r\n  }\r\n  \r\n  // bcrypt would need to be verified server-side\r\n  return false;\r\n}\r\n\r\n/**\r\n * Sanitize input to prevent XSS\r\n * Removes or escapes potentially dangerous characters\r\n */\r\nexport function sanitizeInput(input: string): string {\r\n  if (!input) return '';\r\n  \r\n  return input\r\n    .replace(/[<>]/g, '') // Remove < > to prevent HTML injection\r\n    .replace(/javascript:/gi, '') // Remove javascript: protocol\r\n    .replace(/on\\w+=/gi, '') // Remove event handlers like onclick=\r\n    .trim();\r\n}\r\n\r\n/**\r\n * Sanitize object fields recursively\r\n */\r\nexport function sanitizeObject<T extends Record<string, unknown>>(obj: T): T {\r\n  const result: Record<string, unknown> = {};\r\n  \r\n  for (const [key, value] of Object.entries(obj)) {\r\n    if (typeof value === 'string') {\r\n      result[key] = sanitizeInput(value);\r\n    } else if (value && typeof value === 'object' && !Array.isArray(value)) {\r\n      result[key] = sanitizeObject(value as Record<string, unknown>);\r\n    } else if (Array.isArray(value)) {\r\n      result[key] = value.map(item => \r\n        typeof item === 'string' \r\n          ? sanitizeInput(item)\r\n          : typeof item === 'object' && item !== null\r\n            ? sanitizeObject(item as Record<string, unknown>)\r\n            : item\r\n      );\r\n    } else {\r\n      result[key] = value;\r\n    }\r\n  }\r\n  \r\n  return result as T;\r\n}\r\n\r\n/**\r\n * Validate email format\r\n */\r\nexport function isValidEmail(email: string): boolean {\r\n  const emailRegex = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;\r\n  return emailRegex.test(email);\r\n}\r\n\r\n/**\r\n * Validate password strength\r\n */\r\nexport function validatePasswordStrength(password: string): {\r\n  isValid: boolean;\r\n  errors: string[];\r\n} {\r\n  const errors: string[] = [];\r\n  \r\n  if (password.length < 6) {\r\n    errors.push('Mật khẩu phải có ít nhất 6 ký tự');\r\n  }\r\n  \r\n  if (password.length > 128) {\r\n    errors.push('Mật khẩu không được quá 128 ký tự');\r\n  }\r\n  \r\n  // Optional: Add more strength checks\r\n  // if (!/[A-Z]/.test(password)) {\r\n  //   errors.push('Mật khẩu cần có ít nhất 1 chữ in hoa');\r\n  // }\r\n  // if (!/[0-9]/.test(password)) {\r\n  //   errors.push('Mật khẩu cần có ít nhất 1 số');\r\n  // }\r\n  \r\n  return {\r\n    isValid: errors.length === 0,\r\n    errors\r\n  };\r\n}\r\n\r\n/**\r\n * Rate limiting helper (for future use with API calls)\r\n * Stores attempt counts in memory\r\n */\r\nconst rateLimitStore = new Map<string, { count: number; resetTime: number }>();\r\n\r\nexport function checkRateLimit(key: string, maxAttempts: number = 5, windowMs: number = 60000): {\r\n  allowed: boolean;\r\n  remainingAttempts: number;\r\n  resetTime: number;\r\n} {\r\n  const now = Date.now();\r\n  const entry = rateLimitStore.get(key);\r\n  \r\n  if (!entry || now > entry.resetTime) {\r\n    // First attempt or window expired\r\n    rateLimitStore.set(key, { count: 1, resetTime: now + windowMs });\r\n    return { allowed: true, remainingAttempts: maxAttempts - 1, resetTime: now + windowMs };\r\n  }\r\n  \r\n  if (entry.count >= maxAttempts) {\r\n    return { allowed: false, remainingAttempts: 0, resetTime: entry.resetTime };\r\n  }\r\n  \r\n  entry.count++;\r\n  return { allowed: true, remainingAttempts: maxAttempts - entry.count, resetTime: entry.resetTime };\r\n}\r\n\r\nexport function resetRateLimit(key: string): void {\r\n  rateLimitStore.delete(key);\r\n}\r\n"],"names":[],"mappings":"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"}}]
}