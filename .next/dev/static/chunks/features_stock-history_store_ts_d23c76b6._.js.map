{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/stock-history/store.ts"],"sourcesContent":["import { create } from 'zustand';\r\nimport { formatDate, formatDateTime, formatDateTimeSeconds, formatDateCustom, parseDate, getCurrentDate } from '@/lib/date-utils';\r\nimport type { StockHistoryEntry } from './types';\r\nimport { asSystemId } from '../../lib/id-types';\r\nimport type { SystemId } from '../../lib/id-types';\r\n// REMOVED: import { data as initialData } from './data'; // Mock data no longer used - database is source of truth\r\n\r\n// API sync helpers\r\nasync function syncToAPI(action: 'create', data: any): Promise<boolean> {\r\n  try {\r\n    const response = await fetch('/api/inventory/stock-history', {\r\n      method: 'POST',\r\n      headers: { 'Content-Type': 'application/json' },\r\n      body: JSON.stringify(data),\r\n    });\r\n    \r\n    if (!response.ok) {\r\n      console.error(`[StockHistory API] ${action} failed:`, await response.text());\r\n      return false;\r\n    }\r\n    return true;\r\n  } catch (error) {\r\n    console.error(`[StockHistory API] ${action} error:`, error);\r\n    return false;\r\n  }\r\n}\r\n\r\n// ✨ Migration helper: Convert SKU to systemId for old data\r\nfunction migrateHistoryData(entries: StockHistoryEntry[]): StockHistoryEntry[] {\r\n  // Map SKU → systemId from products\r\n  const skuToSystemId: Record<string, string> = {\r\n    'DV-WEB-01': 'SP00000001',\r\n    'DV-WEB-02': 'SP00000002',\r\n    'DV-WEB-03': 'SP00000003',\r\n    'DV-MKT-01': 'SP00000004',\r\n    'DV-MKT-02': 'SP00000005',\r\n    'DV-MKT-03': 'SP00000006',\r\n    'DV-SEO-01': 'SP00000007',\r\n    'DV-SEO-02': 'SP00000008',\r\n    'DV-IT-01': 'SP00000009',\r\n    'DV-DSN-01': 'SP00000010',\r\n    'SW-CRM-01': 'SP00000011',\r\n    'SW-ERP-01': 'SP00000012',\r\n    'SW-WIN-01': 'SP00000013',\r\n    'SW-OFF-01': 'SP00000014',\r\n    'SW-ADOBE-01': 'SP00000015',\r\n    'HW-SRV-01': 'SP00000016',\r\n    'HW-SRV-02': 'SP00000017',\r\n    'HW-PC-01': 'SP00000018',\r\n    'HW-PC-02': 'SP00000019',\r\n    'HW-LT-01': 'SP00000020',\r\n    'HW-NET-01': 'SP00000021',\r\n    'HW-NET-02': 'SP00000022',\r\n    'HW-CAM-01': 'SP00000023',\r\n    'MISC-HOST-01': 'SP00000024',\r\n    'MISC-HOST-02': 'SP00000025',\r\n    'MISC-SSL-01': 'SP00000026',\r\n    'MISC-DOMAIN-COM': 'SP00000027',\r\n    'MISC-DOMAIN-VN': 'SP00000028',\r\n    'MISC-PRINT-01': 'SP00000029',\r\n    'MISC-PRINT-02': 'SP00000030',\r\n  };\r\n  \r\n  return entries.map(entry => ({\r\n    ...entry,\r\n    productId: asSystemId(skuToSystemId[entry.productId as any] || entry.productId) // Convert or keep if already systemId\r\n  }));\r\n}\r\n\r\ninterface StockHistoryState {\r\n  entries: StockHistoryEntry[];\r\n  initialized: boolean;\r\n  addEntry: (entry: Omit<StockHistoryEntry, 'systemId'>) => void;\r\n  getHistoryForProduct: (productId: SystemId, branchSystemId?: 'all' | SystemId) => StockHistoryEntry[];\r\n  loadFromAPI: () => Promise<void>;\r\n}\r\n\r\nlet entryCounter = 0;\r\n\r\nexport const useStockHistoryStore = create<StockHistoryState>()(\r\n  (set, get) => ({\r\n      entries: [], // Database is source of truth\r\n      initialized: false,\r\n      \r\n      addEntry: (entry) => {\r\n        entryCounter++;\r\n        const newEntry: StockHistoryEntry = {\r\n            ...entry,\r\n            systemId: asSystemId(`HISTORY${String(Date.now()).slice(-6)}_${entryCounter}`),\r\n        };\r\n        set((state) => ({ entries: [...state.entries, newEntry] }));\r\n        // Sync to API\r\n        syncToAPI('create', newEntry).catch(console.error);\r\n      },\r\n      \r\n      getHistoryForProduct: (productId, branchSystemId = 'all') => {\r\n          const productHistory = get().entries.filter(e => e.productId === productId);\r\n          const sortedHistory = productHistory.sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime());\r\n\r\n          if (branchSystemId === 'all') {\r\n            return sortedHistory;\r\n          }\r\n          return sortedHistory.filter(e => e.branchSystemId === branchSystemId);\r\n        },\r\n      \r\n      loadFromAPI: async () => {\r\n        try {\r\n          // NOTE: Use React Query hooks for paginated data. This only loads initial batch.\r\n          const response = await fetch('/api/inventory/stock-history?limit=30');\r\n          if (!response.ok) return;\r\n          const json = await response.json();\r\n          const apiData = json.data || [];\r\n          if (apiData.length > 0) {\r\n            set({ entries: migrateHistoryData(apiData), initialized: true });\r\n          } else {\r\n            set({ initialized: true });\r\n          }\r\n        } catch (error) {\r\n          console.error('[StockHistory API] loadFromAPI error:', error);\r\n        }\r\n      },\r\n    })\r\n);\r\n"],"names":[],"mappings":"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"}}]
}