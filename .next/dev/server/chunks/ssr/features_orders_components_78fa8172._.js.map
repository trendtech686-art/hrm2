{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/orders/components/packaging-info.tsx"],"sourcesContent":["import * as React from 'react';\r\nimport Link from 'next/link';\r\nimport { formatDate, formatDateTime, formatDateTimeSeconds, formatDateCustom, parseDate, getCurrentDate } from '@/lib/date-utils';\r\nimport type { Order, Packaging, PackagingStatus, OrderDeliveryStatus } from '../types';\r\nimport { Button } from '../../../components/ui/button';\r\nimport { DetailField } from '../../../components/ui/detail-field';\r\nimport { DropdownMenu, DropdownMenuContent, DropdownMenuItem, DropdownMenuTrigger } from '../../../components/ui/dropdown-menu';\r\nimport { cn } from '../../../lib/utils';\r\nimport { Truck, PackageSearch, PackageCheck, Ban, Edit, Printer, ChevronRight, ChevronDown, Copy, Check, Info, AlertCircle, Tag, FileText } from 'lucide-react';\r\nimport { Separator } from '../../../components/ui/separator';\r\nimport { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from '../../../components/ui/tooltip';\r\nimport { Badge } from '../../../components/ui/badge';\r\nimport { getGHTKStatusVariant, getGHTKStatusText } from '../../../lib/ghtk-constants';\r\nimport { useAllEmployees } from '../../employees/hooks/use-all-employees';\r\nimport { useAllShipments } from '../../shipments/hooks/use-all-shipments';\r\nimport { useAllBranches } from '../../settings/branches/hooks/use-all-branches';\r\nimport { useCustomers } from '../../customers/hooks/use-customers';\r\nimport { usePrint } from '@/lib/use-print';\r\nimport { mapPackingToPrintData, mapPackingLineItems } from '@/lib/print-mappers/packing.mapper';\r\nimport { mapShippingLabelToPrintData } from '@/lib/print-mappers/shipping-label.mapper';\r\nimport { mapDeliveryToPrintData, mapDeliveryLineItems } from '@/lib/print-mappers/delivery.mapper';\r\nimport type { SystemId } from '@/lib/id-types';\r\nconst formatCurrency = (value?: number) => {\r\n    if (typeof value !== 'number' || isNaN(value)) return '0';\r\n    return new Intl.NumberFormat('vi-VN').format(value);\r\n};\r\n\r\n\r\n\r\nconst packagingStatusIcons: Record<PackagingStatus, React.ElementType> = {\r\n    'Chờ đóng gói': PackageSearch,\r\n    'Đã đóng gói': PackageCheck,\r\n    'Hủy đóng gói': Ban,\r\n};\r\n\r\nconst packagingStatusColors: Record<PackagingStatus, string> = {\r\n    'Chờ đóng gói': 'text-amber-500',\r\n    'Đã đóng gói': 'text-green-500',\r\n    'Hủy đóng gói': 'text-red-500',\r\n};\r\n\r\ninterface PackagingInfoProps {\r\n    order: Order;\r\n    packaging: Packaging;\r\n    isActionable: boolean;\r\n    onConfirmPackaging: () => void;\r\n    onCancelPackaging: () => void;\r\n    onOpenShipmentDialog: () => void;\r\n    onInStorePickup: () => void;\r\n    onDispatch: () => void;\r\n    onCompleteDelivery: () => void;\r\n    onFailDelivery: () => void;\r\n    onCancelDelivery: () => void;\r\n    onCancelGHTKShipment?: (() => void) | undefined; // NEW: Cancel GHTK shipment\r\n}\r\n\r\nexport function PackagingInfo({\r\n    order,\r\n    packaging,\r\n    isActionable,\r\n    onConfirmPackaging,\r\n    onCancelPackaging,\r\n    onOpenShipmentDialog,\r\n    onInStorePickup,\r\n    onDispatch,\r\n    onCompleteDelivery,\r\n    onFailDelivery,\r\n    onCancelDelivery,\r\n    onCancelGHTKShipment,\r\n}: PackagingInfoProps) {\r\n    // ✅ If cancelled, default to collapsed\r\n    const isCancelled = packaging.deliveryStatus === 'Đã hủy' || packaging.status === 'Hủy đóng gói';\r\n    const [isExpanded, setIsExpanded] = React.useState(!isCancelled);\r\n    const [isCopied, setIsCopied] = React.useState(false);\r\n    const { data: employees } = useAllEmployees();\r\n    const { data: shipments } = useAllShipments();\r\n    const { data: branches } = useAllBranches();\r\n    const { data: customersData } = useCustomers({ limit: 100 });\r\n    const customers = customersData?.data || [];\r\n    \r\n    // Helper functions replacing store methods\r\n    const findEmployeeById = React.useCallback((id: string) => employees.find(e => e.systemId === id), [employees]);\r\n    const findBranchById = React.useCallback((id: string) => branches.find(b => b.systemId === id), [branches]);\r\n    const findCustomerById = React.useCallback((id: string) => customers.find(c => c.systemId === id), [customers]);\r\n    const findShipmentByPackagingSystemId = React.useCallback((id: string) => shipments.find(s => s.packagingSystemId === id), [shipments]);\r\n    const findShipmentByTrackingCode = React.useCallback((code: string) => shipments.find(s => s.trackingCode === code), [shipments]);\r\n    \r\n    // Print functionality\r\n    const branch = findBranchById(order.branchSystemId);\r\n    const customer = findCustomerById(order.customerSystemId);\r\n    const { print } = usePrint(order.branchSystemId);\r\n    \r\n    // Find shipment by trackingCode first (more reliable), fallback to packagingSystemId\r\n    const shipment = React.useMemo(() => {\r\n        if (packaging.trackingCode) {\r\n            const byTrackingCode = findShipmentByTrackingCode(packaging.trackingCode);\r\n            if (byTrackingCode) return byTrackingCode;\r\n        }\r\n        return findShipmentByPackagingSystemId(packaging.systemId);\r\n    }, [packaging.systemId, packaging.trackingCode, findShipmentByPackagingSystemId, findShipmentByTrackingCode]);\r\n\r\n    const renderEmployeeLink = React.useCallback((employeeId?: SystemId, employeeName?: string) => {\r\n        const resolvedName = employeeName || (employeeId ? findEmployeeById(employeeId)?.fullName : undefined);\r\n        if (!employeeId && !resolvedName) {\r\n            return '---';\r\n        }\r\n\r\n        if (!employeeId) {\r\n            return resolvedName;\r\n        }\r\n\r\n        return (\r\n            <Link href={`/employees/${employeeId}`} className=\"text-primary hover:underline\">\r\n                {resolvedName || employeeId}\r\n            </Link>\r\n        );\r\n    }, [findEmployeeById]);\r\n\r\n    const displayStatusText = React.useMemo(() => {\r\n        // ✅ If delivery is cancelled, always show \"Đã hủy\"\r\n        if (packaging.deliveryStatus === 'Đã hủy') {\r\n            return 'Đã hủy';\r\n        }\r\n        \r\n        if (packaging.partnerStatus) {\r\n            return packaging.partnerStatus;\r\n        }\r\n        const deliverySpecificStatuses: OrderDeliveryStatus[] = ['Chờ lấy hàng', 'Đang giao hàng', 'Đã giao hàng', 'Chờ giao lại'];\r\n        if (packaging.deliveryStatus && deliverySpecificStatuses.includes(packaging.deliveryStatus)) {\r\n            return packaging.deliveryStatus;\r\n        }\r\n        return packaging.status;\r\n    }, [packaging.partnerStatus, packaging.deliveryStatus, packaging.status]);\r\n\r\n    // ✅ Use appropriate icon and color for cancelled status\r\n    const Icon = (packaging.deliveryStatus === 'Đã hủy' || packaging.status === 'Hủy đóng gói') \r\n        ? Ban \r\n        : (packaging.deliveryStatus && !['Chờ đóng gói', 'Đã đóng gói'].includes(packaging.deliveryStatus) ? Truck : packagingStatusIcons[packaging.status]);\r\n    \r\n    const color = (packaging.deliveryStatus === 'Đã hủy' || packaging.status === 'Hủy đóng gói')\r\n        ? 'text-red-500'\r\n        : (packaging.deliveryStatus && !['Chờ đóng gói', 'Đã đóng gói'].includes(packaging.deliveryStatus) ? 'text-primary' : packagingStatusColors[packaging.status]);\r\n    \r\n    const getDisplayDateForPackage = (pkg: Packaging, order: Order) => {\r\n        if (pkg.status === 'Hủy đóng gói') {\r\n            return pkg.cancelDate || pkg.requestDate;\r\n        }\r\n        switch (pkg.deliveryStatus) {\r\n            case 'Đã giao hàng':\r\n                return pkg.deliveredDate || order.completedDate || pkg.confirmDate || pkg.requestDate;\r\n            case 'Đang giao hàng':\r\n                return order.dispatchedDate || pkg.confirmDate || pkg.requestDate;\r\n            default: // Chờ lấy hàng, Đã đóng gói, Chờ đóng gói\r\n                if (pkg.status === 'Đã đóng gói') {\r\n                    return pkg.confirmDate || pkg.requestDate;\r\n                }\r\n                return pkg.requestDate;\r\n        }\r\n    };\r\n    const displayDate = getDisplayDateForPackage(packaging, order);\r\n\r\n    const handleCopy = () => {\r\n        if (packaging.trackingCode) {\r\n            navigator.clipboard.writeText(packaging.trackingCode);\r\n            setIsCopied(true);\r\n            setTimeout(() => setIsCopied(false), 2000);\r\n        }\r\n    };\r\n\r\n    // === PRINT HANDLERS ===\r\n    const storeSettings = React.useMemo(() => ({\r\n        name: branch?.name || '',\r\n        address: branch?.address || '',\r\n        phone: branch?.phone || '',\r\n        province: branch?.province || '',\r\n    }), [branch]);\r\n\r\n    // Helper to safely get address fields\r\n    const getShippingAddressField = React.useCallback(<T extends keyof import('../types').OrderAddress>(\r\n        field: T\r\n    ): import('../types').OrderAddress[T] | undefined => {\r\n        if (typeof order.shippingAddress === 'string') return undefined;\r\n        return order.shippingAddress?.[field];\r\n    }, [order.shippingAddress]);\r\n\r\n    const getFormattedShippingAddress = React.useCallback(() => {\r\n        if (typeof order.shippingAddress === 'string') return order.shippingAddress;\r\n        return order.shippingAddress?.formattedAddress || order.shippingAddress?.street || '';\r\n    }, [order.shippingAddress]);\r\n\r\n    const handlePrintPacking = React.useCallback(() => {\r\n        const packingData = {\r\n            code: packaging.id,\r\n            createdAt: packaging.requestDate,\r\n            packedAt: packaging.confirmDate,\r\n            createdBy: packaging.requestingEmployeeName,\r\n            orderCode: order.id,\r\n            fulfillmentStatus: packaging.status,\r\n            assignedEmployee: packaging.assignedEmployeeName,\r\n            location: {\r\n                name: branch?.name,\r\n                address: branch?.address,\r\n                province: branch?.province,\r\n                phone: branch?.phone,\r\n            },\r\n            customerName: customer?.name || order.customerName || '',\r\n            customerCode: customer?.id,\r\n            customerPhone: customer?.phone || getShippingAddressField('phone'),\r\n            customerAddress: customer?.addresses?.[0]?.street,\r\n            shippingAddress: getFormattedShippingAddress(),\r\n            shippingProvince: getShippingAddressField('province'),\r\n            shippingDistrict: getShippingAddressField('district'),\r\n            shippingWard: getShippingAddressField('ward'),\r\n            items: order.lineItems.map(item => ({\r\n                variantCode: item.productId,\r\n                productName: item.productName,\r\n                quantity: item.quantity,\r\n                price: item.unitPrice,\r\n                amount: item.quantity * item.unitPrice,\r\n                note: item.note,\r\n            })),\r\n            totalQuantity: order.lineItems.reduce((sum, item) => sum + item.quantity, 0),\r\n            total: order.grandTotal,\r\n            codAmount: packaging.codAmount,\r\n            note: packaging.notes,\r\n            orderNote: order.notes,\r\n        };\r\n        const printData = mapPackingToPrintData(packingData, storeSettings);\r\n        const lineItems = mapPackingLineItems(packingData.items);\r\n        print('packing', { data: printData, lineItems });\r\n    }, [packaging, order, branch, customer, storeSettings, print, getShippingAddressField, getFormattedShippingAddress]);\r\n\r\n    const handlePrintShippingLabel = React.useCallback(() => {\r\n        const labelData = {\r\n            orderCode: order.id,\r\n            createdAt: packaging.requestDate,\r\n            createdBy: packaging.requestingEmployeeName,\r\n            status: packaging.status,\r\n            location: {\r\n                name: branch?.name,\r\n                address: branch?.address,\r\n                phone: branch?.phone,\r\n                province: branch?.province,\r\n            },\r\n            customerName: getShippingAddressField('contactName') || customer?.name || order.customerName || '',\r\n            customerPhone: getShippingAddressField('phone') || customer?.phone,\r\n            shippingAddress: getFormattedShippingAddress(),\r\n            city: getShippingAddressField('province'),\r\n            district: getShippingAddressField('district'),\r\n            receiverName: getShippingAddressField('contactName') || customer?.name || order.customerName || '',\r\n            receiverPhone: getShippingAddressField('phone') || customer?.phone,\r\n            trackingCode: packaging.trackingCode,\r\n            carrierName: packaging.carrier,\r\n            serviceName: packaging.service,\r\n            totalItems: order.lineItems.reduce((sum, item) => sum + item.quantity, 0),\r\n            total: order.grandTotal,\r\n            deliveryFee: packaging.shippingFeeToPartner || order.shippingFee,\r\n            codAmount: packaging.codAmount || order.codAmount,\r\n            totalAmount: order.grandTotal,\r\n            packingWeight: packaging.weight ? packaging.weight / 1000 : undefined, // Convert grams to kg\r\n            note: packaging.noteToShipper,\r\n        };\r\n        const printData = mapShippingLabelToPrintData(labelData, storeSettings);\r\n        print('shipping-label', { data: printData });\r\n    }, [packaging, order, branch, customer, storeSettings, print, getShippingAddressField, getFormattedShippingAddress]);\r\n\r\n    const handlePrintDelivery = React.useCallback(() => {\r\n        const deliveryData = {\r\n            code: packaging.trackingCode || packaging.id,\r\n            orderCode: order.id,\r\n            createdAt: packaging.requestDate,\r\n            createdBy: packaging.requestingEmployeeName,\r\n            shipperName: packaging.assignedEmployeeName,\r\n            deliveryStatus: packaging.deliveryStatus || packaging.status,\r\n            location: {\r\n                name: branch?.name,\r\n                address: branch?.address,\r\n                phone: branch?.phone,\r\n                province: branch?.province,\r\n            },\r\n            trackingCode: packaging.trackingCode,\r\n            carrierName: packaging.carrier || (packaging.deliveryMethod === 'Dịch vụ giao hàng' ? 'Tự giao hàng' : ''),\r\n            // Thông tin khách hàng\r\n            customerName: customer?.name || order.customerName || '',\r\n            customerCode: customer?.id,\r\n            customerPhone: customer?.phone,\r\n            customerEmail: customer?.email,\r\n            // Thông tin người nhận\r\n            receiverName: getShippingAddressField('contactName') || customer?.name || order.customerName || '',\r\n            receiverPhone: getShippingAddressField('phone') || customer?.phone || '',\r\n            shippingAddress: getFormattedShippingAddress(),\r\n            city: getShippingAddressField('province'),\r\n            district: getShippingAddressField('district'),\r\n            ward: getShippingAddressField('ward'),\r\n            // Danh sách sản phẩm\r\n            items: order.lineItems.map(item => ({\r\n                variantCode: item.productId,\r\n                productName: item.productName,\r\n                variantName: '',\r\n                unit: 'Cái',\r\n                quantity: item.quantity,\r\n                price: item.unitPrice,\r\n                amount: item.quantity * item.unitPrice,\r\n                note: item.note,\r\n            })),\r\n            // Tổng giá trị\r\n            totalQuantity: order.lineItems.reduce((sum, item) => sum + item.quantity, 0),\r\n            subtotal: order.subtotal,\r\n            deliveryFee: order.shippingFee,\r\n            codAmount: packaging.codAmount || order.codAmount,\r\n            totalAmount: order.grandTotal,\r\n            note: packaging.noteToShipper || order.notes,\r\n        };\r\n        const printData = mapDeliveryToPrintData(deliveryData, storeSettings);\r\n        const lineItems = mapDeliveryLineItems(deliveryData.items);\r\n        print('delivery', { data: printData, lineItems });\r\n    }, [packaging, order, branch, customer, storeSettings, print, getShippingAddressField, getFormattedShippingAddress]);\r\n\r\n    const renderActionButtons = () => {\r\n        if (!isActionable) return null;\r\n        \r\n        // ✅ Không hiển thị action nếu đã hủy\r\n        if (packaging.deliveryStatus === 'Đã hủy' || packaging.status === 'Hủy đóng gói') {\r\n            return null;\r\n        }\r\n    \r\n        if (packaging.status === 'Chờ đóng gói') {\r\n            return (\r\n                <div className=\"flex items-center gap-2\">\r\n                    <Button size=\"sm\" variant=\"outline\" onClick={onCancelPackaging}>Hủy yêu cầu</Button>\r\n                    <Button size=\"sm\" onClick={onConfirmPackaging}>Xác nhận đã đóng gói</Button>\r\n                </div>\r\n            );\r\n        }\r\n\r\n        if (packaging.status === 'Đã đóng gói' && !packaging.deliveryMethod) {\r\n            return (\r\n                <div className=\"flex items-center gap-2\">\r\n                    <Button \r\n                        size=\"sm\" \r\n                        variant=\"outline\" \r\n                        className=\"border-destructive text-destructive hover:bg-destructive/5\"\r\n                        onClick={onCancelPackaging}\r\n                    >\r\n                        Hủy đóng gói\r\n                    </Button>\r\n                    <DropdownMenu>\r\n                        <DropdownMenuTrigger asChild><Button size=\"sm\" variant=\"outline\">Giao hàng <ChevronDown className=\"ml-2 h-4 w-4\" /></Button></DropdownMenuTrigger>\r\n                        <DropdownMenuContent>\r\n                            <DropdownMenuItem onSelect={onOpenShipmentDialog}>Đẩy qua hãng vận chuyển</DropdownMenuItem>\r\n                            <DropdownMenuItem disabled>Tự gọi shipper</DropdownMenuItem>\r\n                            <DropdownMenuItem onSelect={onInStorePickup}>Khách nhận tại cửa hàng</DropdownMenuItem>\r\n                        </DropdownMenuContent>\r\n                    </DropdownMenu>\r\n                </div>\r\n            );\r\n        }\r\n\r\n        if (packaging.deliveryMethod === 'Nhận tại cửa hàng' && packaging.deliveryStatus === 'Đã đóng gói') {\r\n            return (\r\n                <div className=\"flex items-center gap-2\">\r\n                    <Button \r\n                        size=\"sm\" \r\n                        variant=\"outline\" \r\n                        className=\"border-destructive text-destructive hover:bg-destructive/5\"\r\n                        onClick={onCancelPackaging}\r\n                    >\r\n                        Hủy đóng gói\r\n                    </Button>\r\n                    <Button size=\"sm\" onClick={onDispatch}>Xác nhận Xuất kho</Button>\r\n                </div>\r\n            );\r\n        }\r\n\r\n        if (packaging.deliveryStatus === 'Chờ lấy hàng') {\r\n            // Check if can cancel GHTK shipment\r\n            const canCancelGHTK = packaging.carrier === 'GHTK' && \r\n                                  packaging.trackingCode && \r\n                                  packaging.ghtkStatusId && \r\n                                  [1, 2, 12].includes(packaging.ghtkStatusId) &&\r\n                                  onCancelGHTKShipment;\r\n            \r\n            return (\r\n                <div className=\"flex items-center gap-2\">\r\n                    {canCancelGHTK ? (\r\n                        <Button \r\n                            size=\"sm\" \r\n                            variant=\"outline\" \r\n                            className=\"border-destructive text-destructive hover:bg-destructive/5\"\r\n                            onClick={onCancelGHTKShipment}\r\n                        >\r\n                            Hủy vận đơn GHTK\r\n                        </Button>\r\n                    ) : (\r\n                        <Button size=\"sm\" variant=\"outline\" onClick={() => onCancelDelivery()}>Hủy giao hàng</Button>\r\n                    )}\r\n                    <Button size=\"sm\" onClick={onDispatch}>Xác nhận Xuất kho</Button>\r\n                </div>\r\n            );\r\n        }\r\n        \r\n         if (packaging.deliveryStatus === 'Đang giao hàng') {\r\n            return (\r\n                <div className=\"flex items-center gap-2\">\r\n                     <DropdownMenu>\r\n                        <DropdownMenuTrigger asChild><Button size=\"sm\" variant=\"outline\" className=\"border-destructive text-destructive hover:bg-destructive/5 hover:text-destructive\">Hủy/Thất bại</Button></DropdownMenuTrigger>\r\n                        <DropdownMenuContent>\r\n                            <DropdownMenuItem onSelect={onFailDelivery}>Giao thất bại</DropdownMenuItem>\r\n                            <DropdownMenuItem onSelect={onCancelDelivery}>Hủy giao hàng</DropdownMenuItem>\r\n                        </DropdownMenuContent>\r\n                    </DropdownMenu>\r\n                    <Button size=\"sm\" onClick={onCompleteDelivery}>Đã giao hàng</Button>\r\n                </div>\r\n            );\r\n        }\r\n        \r\n         if (packaging.deliveryStatus === 'Chờ giao lại') {\r\n            return (\r\n                 <Button size=\"sm\" onClick={onOpenShipmentDialog}>Tạo lại đơn giao hàng</Button>\r\n            )\r\n         }\r\n\r\n\r\n        return null;\r\n    };\r\n\r\n    return (\r\n        <div className=\"border rounded-md bg-background\">\r\n            {/* Header */}\r\n            <div className=\"flex items-center justify-between p-3 border-b\">\r\n                 <div className=\"flex items-center gap-2 flex-grow cursor-pointer\" onClick={() => setIsExpanded(!isExpanded)}>\r\n                    <Icon className={cn(\"h-5 w-5\", color)} />\r\n                    <div className=\"flex items-center gap-2\">\r\n                        <p className=\"text-sm font-semibold\">{displayStatusText}</p>\r\n                        <p className=\"text-sm text-muted-foreground\">{formatDate(displayDate)}</p>\r\n                        \r\n                        {/* GHTK Status Badge */}\r\n                        {packaging.carrier === 'GHTK' && packaging.ghtkStatusId !== undefined && (\r\n                            <Badge variant={getGHTKStatusVariant(packaging.ghtkStatusId)} className=\"text-xs\">\r\n                                {getGHTKStatusText(packaging.ghtkStatusId)}\r\n                            </Badge>\r\n                        )}\r\n                    </div>\r\n                    {packaging.trackingCode && (\r\n                        <>\r\n                            <Separator orientation=\"vertical\" className=\"h-4 mx-2\" />\r\n                            <div className=\"flex items-center gap-1\">\r\n                                <span className=\"text-sm font-mono text-primary\">{packaging.trackingCode}</span>\r\n                                <Button variant=\"ghost\" size=\"icon\" className=\"h-7 w-7\" onClick={(e) => { e.stopPropagation(); handleCopy(); }}>\r\n                                    {isCopied ? <Check className=\"h-4 w-4 text-green-500\" /> : <Copy className=\"h-4 w-4 text-muted-foreground\" />}\r\n                                </Button>\r\n                            </div>\r\n                        </>\r\n                    )}\r\n                    \r\n                    {/* GHTK Reason Tooltip */}\r\n                    {packaging.carrier === 'GHTK' && packaging.ghtkReasonText && (\r\n                        <TooltipProvider>\r\n                            <Tooltip>\r\n                                <TooltipTrigger asChild>\r\n                                    <Button \r\n                                        variant=\"ghost\" \r\n                                        size=\"icon\" \r\n                                        className=\"h-7 w-7\"\r\n                                        onClick={(e) => e.stopPropagation()}\r\n                                    >\r\n                                        <AlertCircle className=\"h-4 w-4 text-amber-500\" />\r\n                                    </Button>\r\n                                </TooltipTrigger>\r\n                                <TooltipContent className=\"max-w-xs\">\r\n                                    <p className=\"font-semibold mb-1\">Lý do:</p>\r\n                                    <p>{packaging.ghtkReasonText}</p>\r\n                                    {packaging.ghtkReasonCode && (\r\n                                        <p className=\"text-xs text-muted-foreground mt-1\">\r\n                                            Mã: {packaging.ghtkReasonCode}\r\n                                        </p>\r\n                                    )}\r\n                                </TooltipContent>\r\n                            </Tooltip>\r\n                        </TooltipProvider>\r\n                    )}\r\n                </div>\r\n                <div className=\"flex items-center gap-1\">\r\n                    {renderActionButtons()}\r\n                    {/* ✅ Print button - In phiếu giao hàng */}\r\n                    <TooltipProvider>\r\n                        <Tooltip>\r\n                            <TooltipTrigger asChild>\r\n                                <Button \r\n                                    variant=\"ghost\" \r\n                                    size=\"icon\" \r\n                                    className=\"h-8 w-8\"\r\n                                    onClick={handlePrintDelivery}\r\n                                >\r\n                                    <Printer className=\"h-4 w-4\" />\r\n                                </Button>\r\n                            </TooltipTrigger>\r\n                            <TooltipContent>In phiếu giao hàng</TooltipContent>\r\n                        </Tooltip>\r\n                    </TooltipProvider>\r\n                    <Button variant=\"ghost\" size=\"icon\" className=\"h-8 w-8\" onClick={() => setIsExpanded(!isExpanded)}>\r\n                        {isExpanded ? <ChevronDown className=\"h-4 w-4\" /> : <ChevronRight className=\"h-4 w-4\" />}\r\n                    </Button>\r\n                </div>\r\n            </div>\r\n            \r\n            {/* Content */}\r\n            {isExpanded && (\r\n                <div className=\"p-4 space-y-2\">\r\n                    <div className=\"grid grid-cols-1 md:grid-cols-2 text-sm gap-x-6 gap-y-1\">\r\n                        <DetailField label=\"Mã đóng gói\" className=\"py-1 border-0\">\r\n                            <div className=\"flex items-center gap-1\">\r\n                                <Link href={`/packaging/${packaging.systemId}`} className=\"font-mono text-primary hover:underline\">{packaging.id}</Link>\r\n                                <TooltipProvider>\r\n                                    <Tooltip>\r\n                                        <TooltipTrigger asChild>\r\n                                            <Button \r\n                                                variant=\"ghost\" \r\n                                                size=\"icon\" \r\n                                                className=\"h-6 w-6\" \r\n                                                onClick={handlePrintPacking}\r\n                                            >\r\n                                                <Printer className=\"h-3.5 w-3.5 text-muted-foreground hover:text-foreground\" />\r\n                                            </Button>\r\n                                        </TooltipTrigger>\r\n                                        <TooltipContent>In phiếu đóng gói</TooltipContent>\r\n                                    </Tooltip>\r\n                                </TooltipProvider>\r\n                            </div>\r\n                        </DetailField>\r\n                        <DetailField \r\n                            label=\"Mã vận đơn\" \r\n                            className=\"py-1 border-0\"\r\n                        >\r\n                            {packaging.trackingCode ? (\r\n                                <div className=\"flex items-center gap-1\">\r\n                                    {shipment ? (\r\n                                        <Link href={`/shipments/${shipment.systemId}`} className=\"font-mono text-primary hover:underline\">\r\n                                            {packaging.trackingCode}\r\n                                        </Link>\r\n                                    ) : (\r\n                                        <span className=\"font-mono\">{packaging.trackingCode}</span>\r\n                                    )}\r\n                                    <TooltipProvider>\r\n                                        <Tooltip>\r\n                                            <TooltipTrigger asChild>\r\n                                                <Button \r\n                                                    variant=\"ghost\" \r\n                                                    size=\"icon\" \r\n                                                    className=\"h-6 w-6\" \r\n                                                    onClick={handlePrintShippingLabel}\r\n                                                >\r\n                                                    <Printer className=\"h-3.5 w-3.5 text-muted-foreground hover:text-foreground\" />\r\n                                                </Button>\r\n                                            </TooltipTrigger>\r\n                                            <TooltipContent>In nhãn giao hàng</TooltipContent>\r\n                                        </Tooltip>\r\n                                    </TooltipProvider>\r\n                                </div>\r\n                            ) : (\r\n                                <span className=\"text-muted-foreground\">---</span>\r\n                            )}\r\n                        </DetailField>\r\n                        \r\n                        {packaging.deliveryMethod === 'Dịch vụ giao hàng' ? (\r\n                            <>\r\n                                <DetailField label=\"Phí trả ĐTVC\" value={formatCurrency(packaging.shippingFeeToPartner)} className=\"py-1 border-0\" />\r\n                                <DetailField label=\"Vận chuyển bởi\" value={packaging.carrier} className=\"py-1 border-0\" />\r\n                                <DetailField label=\"Tổng tiền thu hộ COD\" value={formatCurrency(packaging.codAmount)} className=\"py-1 border-0\" />\r\n                                <DetailField label=\"Người trả phí\" value={packaging.payer} className=\"py-1 border-0\" />\r\n                                <DetailField label=\"Đối soát\" value={packaging.reconciliationStatus} className=\"py-1 border-0\" />\r\n                                <DetailField label=\"Hình thức giao\" value={packaging.deliveryMethod} className=\"py-1 border-0\" />\r\n                                {packaging.weight && (\r\n                                    <DetailField label=\"Trọng lượng\" value={`${packaging.weight}g`} className=\"py-1 border-0\" />\r\n                                )}\r\n                                {packaging.dimensions && (\r\n                                    <DetailField label=\"Kích thước\" value={packaging.dimensions} className=\"py-1 border-0\" />\r\n                                )}\r\n                                <DetailField label=\"Ghi chú\" value={packaging.noteToShipper} className=\"py-1 border-0 col-span-full\" />\r\n                            </>\r\n                        ) : (\r\n                            <>\r\n                                <DetailField label=\"NV được gán\" value={renderEmployeeLink(packaging.assignedEmployeeId, packaging.assignedEmployeeName)} className=\"py-1 border-0\" />\r\n                                <DetailField label=\"Người YC\" value={renderEmployeeLink(packaging.requestingEmployeeId, packaging.requestingEmployeeName)} className=\"py-1 border-0\" />\r\n                                {packaging.status !== 'Chờ đóng gói' && (\r\n                                    <DetailField label=\"Người xác nhận\" value={renderEmployeeLink(packaging.confirmingEmployeeId, packaging.confirmingEmployeeName)} className=\"py-1 border-0\" />\r\n                                )}\r\n                                <DetailField label=\"Hình thức giao\" value={packaging.deliveryMethod} className=\"py-1 border-0\" />\r\n                            </>\r\n                        )}\r\n                        {/* ✅ Show canceller info for cancelled packaging or delivery */}\r\n                        {(packaging.status === 'Hủy đóng gói' || packaging.deliveryStatus === 'Đã hủy') && (\r\n                            <>\r\n                                <DetailField label=\"Người hủy\" value={packaging.cancelingEmployeeName || '-'} className=\"py-1 border-0\" />\r\n                                <DetailField label=\"Lý do hủy\" value={packaging.cancelReason || '-'} className=\"py-1 border-0 col-span-full md:col-span-2\" />\r\n                            </>\r\n                        )}\r\n                    </div>\r\n                </div>\r\n            )}\r\n        </div>\r\n    );\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1256, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/orders/components/cancel-shipment-dialog.tsx"],"sourcesContent":["import * as React from 'react';\r\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter, DialogDescription } from '../../../components/ui/dialog';\r\nimport { Button } from '../../../components/ui/button';\r\nimport { AlertTriangle } from 'lucide-react';\r\n\r\ninterface CancelShipmentDialogProps {\r\n    isOpen: boolean;\r\n    onOpenChange: (open: boolean) => void;\r\n    onCancelShipment: () => void;\r\n    onCancelAndRestock: () => void;\r\n}\r\n\r\nexport function CancelShipmentDialog({ isOpen, onOpenChange, onCancelShipment, onCancelAndRestock }: CancelShipmentDialogProps) {\r\n    return (\r\n        <Dialog open={isOpen} onOpenChange={onOpenChange}>\r\n            <DialogContent className=\"sm:max-w-lg\">\r\n                <DialogHeader>\r\n                    <DialogTitle className=\"flex items-center gap-2\">\r\n                        <AlertTriangle className=\"h-5 w-5 text-destructive\" />\r\n                        Hủy giao hàng\r\n                    </DialogTitle>\r\n                    <DialogDescription>\r\n                        Bạn có chắc chắn hủy đơn giao hàng?\r\n                    </DialogDescription>\r\n                </DialogHeader>\r\n                <div className=\"space-y-3 py-4\">\r\n                    <div className=\"bg-red-50 border border-red-200 text-red-800 text-sm rounded-lg p-4 leading-relaxed\">\r\n                        <p className=\"font-semibold mb-1.5\">⚠️ Lưu ý quan trọng:</p>\r\n                        <p>Yêu cầu hủy đơn có thể <span className=\"font-semibold\">không được đối tác tiếp nhận</span> ở trạng thái hiện tại. Vui lòng hủy trên hệ thống đối tác hoặc liên hệ bộ phận hỗ trợ (nếu đẩy đơn qua Sapo Express)</p>\r\n                    </div>\r\n                </div>\r\n                <DialogFooter className=\"flex-col sm:flex-row gap-2\">\r\n                    <Button \r\n                        variant=\"outline\" \r\n                        onClick={() => onOpenChange(false)}\r\n                        className=\"w-full sm:w-auto order-last sm:order-first\"\r\n                    >\r\n                        Thoát\r\n                    </Button>\r\n                    <div className=\"flex flex-col sm:flex-row gap-2 w-full sm:w-auto\">\r\n                        <Button \r\n                            variant=\"outline\" \r\n                            onClick={onCancelAndRestock}\r\n                            className=\"w-full sm:w-auto border-orange-300 text-orange-700 hover:bg-orange-50\"\r\n                        >\r\n                            Hủy giao và nhận lại hàng\r\n                        </Button>\r\n                        <Button \r\n                            variant=\"destructive\" \r\n                            onClick={onCancelShipment}\r\n                            className=\"w-full sm:w-auto\"\r\n                        >\r\n                            Hủy giao hàng\r\n                        </Button>\r\n                    </div>\r\n                </DialogFooter>\r\n            </DialogContent>\r\n        </Dialog>\r\n    );\r\n}\r\n"],"names":[],"mappings":";;;;;AACA;AACA;AACA;;;;;AASO,SAAS,qBAAqB,EAAE,MAAM,EAAE,YAAY,EAAE,gBAAgB,EAAE,kBAAkB,EAA6B;IAC1H,qBACI,8OAAC,qIAAM;QAAC,MAAM;QAAQ,cAAc;kBAChC,cAAA,8OAAC,4IAAa;YAAC,WAAU;;8BACrB,8OAAC,2IAAY;;sCACT,8OAAC,0IAAW;4BAAC,WAAU;;8CACnB,8OAAC,yOAAa;oCAAC,WAAU;;;;;;gCAA6B;;;;;;;sCAG1D,8OAAC,gJAAiB;sCAAC;;;;;;;;;;;;8BAIvB,8OAAC;oBAAI,WAAU;8BACX,cAAA,8OAAC;wBAAI,WAAU;;0CACX,8OAAC;gCAAE,WAAU;0CAAuB;;;;;;0CACpC,8OAAC;;oCAAE;kDAAuB,8OAAC;wCAAK,WAAU;kDAAgB;;;;;;oCAAmC;;;;;;;;;;;;;;;;;;8BAGrG,8OAAC,2IAAY;oBAAC,WAAU;;sCACpB,8OAAC,qIAAM;4BACH,SAAQ;4BACR,SAAS,IAAM,aAAa;4BAC5B,WAAU;sCACb;;;;;;sCAGD,8OAAC;4BAAI,WAAU;;8CACX,8OAAC,qIAAM;oCACH,SAAQ;oCACR,SAAS;oCACT,WAAU;8CACb;;;;;;8CAGD,8OAAC,qIAAM;oCACH,SAAQ;oCACR,SAAS;oCACT,WAAU;8CACb;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAQzB"}},
    {"offset": {"line": 1413, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/orders/components/cancel-packaging-dialog.tsx"],"sourcesContent":["import * as React from 'react';\r\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter, DialogDescription } from '../../../components/ui/dialog';\r\nimport { Button } from '../../../components/ui/button';\r\nimport { Textarea } from '../../../components/ui/textarea';\r\nimport { Label } from '../../../components/ui/label';\r\n\r\ninterface CancelPackagingDialogProps {\r\n    isOpen: boolean;\r\n    onOpenChange: (open: boolean) => void;\r\n    onConfirm: (reason: string) => void;\r\n}\r\n\r\nexport function CancelPackagingDialog({ isOpen, onOpenChange, onConfirm }: CancelPackagingDialogProps) {\r\n    const [reason, setReason] = React.useState('');\r\n\r\n    const handleConfirm = () => {\r\n        onConfirm(reason);\r\n        onOpenChange(false);\r\n    };\r\n    \r\n    React.useEffect(() => {\r\n        if (!isOpen) {\r\n            setReason('');\r\n        }\r\n    }, [isOpen]);\r\n\r\n    return (\r\n        <Dialog open={isOpen} onOpenChange={onOpenChange}>\r\n            <DialogContent className=\"sm:max-w-md\">\r\n                <DialogHeader>\r\n                    <DialogTitle>Hủy yêu cầu đóng gói</DialogTitle>\r\n                    <DialogDescription>\r\n                        Vui lòng nhập lý do hủy. Hành động này sẽ cập nhật trạng thái của phiếu đóng gói thành \"Hủy đóng gói\".\r\n                    </DialogDescription>\r\n                </DialogHeader>\r\n                <div className=\"pt-4\">\r\n                    <Label htmlFor=\"cancel-reason-packaging\">Lý do hủy</Label>\r\n                    <Textarea\r\n                        id=\"cancel-reason-packaging\"\r\n                        value={reason}\r\n                        onChange={(e) => setReason(e.target.value)}\r\n                        className=\"mt-2\"\r\n                        placeholder=\"Nhập lý do...\"\r\n                    />\r\n                </div>\r\n                <DialogFooter>\r\n                    <Button variant=\"outline\" onClick={() => onOpenChange(false)}>Thoát</Button>\r\n                    <Button variant=\"destructive\" onClick={handleConfirm}>Xác nhận Hủy</Button>\r\n                </DialogFooter>\r\n            </DialogContent>\r\n        </Dialog>\r\n    );\r\n}\r\n"],"names":[],"mappings":";;;;;AAAA;AACA;AACA;AACA;AACA;;;;;;;AAQO,SAAS,sBAAsB,EAAE,MAAM,EAAE,YAAY,EAAE,SAAS,EAA8B;IACjG,MAAM,CAAC,QAAQ,UAAU,GAAG,iNAAc,CAAC;IAE3C,MAAM,gBAAgB;QAClB,UAAU;QACV,aAAa;IACjB;IAEA,kNAAe,CAAC;QACZ,IAAI,CAAC,QAAQ;YACT,UAAU;QACd;IACJ,GAAG;QAAC;KAAO;IAEX,qBACI,8OAAC,qIAAM;QAAC,MAAM;QAAQ,cAAc;kBAChC,cAAA,8OAAC,4IAAa;YAAC,WAAU;;8BACrB,8OAAC,2IAAY;;sCACT,8OAAC,0IAAW;sCAAC;;;;;;sCACb,8OAAC,gJAAiB;sCAAC;;;;;;;;;;;;8BAIvB,8OAAC;oBAAI,WAAU;;sCACX,8OAAC,mIAAK;4BAAC,SAAQ;sCAA0B;;;;;;sCACzC,8OAAC,yIAAQ;4BACL,IAAG;4BACH,OAAO;4BACP,UAAU,CAAC,IAAM,UAAU,EAAE,MAAM,CAAC,KAAK;4BACzC,WAAU;4BACV,aAAY;;;;;;;;;;;;8BAGpB,8OAAC,2IAAY;;sCACT,8OAAC,qIAAM;4BAAC,SAAQ;4BAAU,SAAS,IAAM,aAAa;sCAAQ;;;;;;sCAC9D,8OAAC,qIAAM;4BAAC,SAAQ;4BAAc,SAAS;sCAAe;;;;;;;;;;;;;;;;;;;;;;;AAK1E"}},
    {"offset": {"line": 1540, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/orders/components/delivery-failure-dialog.tsx"],"sourcesContent":["import * as React from 'react';\r\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter, DialogDescription } from '../../../components/ui/dialog';\r\nimport { Button } from '../../../components/ui/button';\r\nimport { Textarea } from '../../../components/ui/textarea';\r\nimport { Label } from '../../../components/ui/label';\r\n\r\ninterface DeliveryFailureDialogProps {\r\n    isOpen: boolean;\r\n    onOpenChange: (open: boolean) => void;\r\n    onConfirm: (reason: string) => void;\r\n}\r\n\r\nexport function DeliveryFailureDialog({ isOpen, onOpenChange, onConfirm }: DeliveryFailureDialogProps) {\r\n    const [reason, setReason] = React.useState('');\r\n\r\n    const handleConfirm = () => {\r\n        onConfirm(reason);\r\n        onOpenChange(false);\r\n    };\r\n\r\n    React.useEffect(() => {\r\n        if (!isOpen) {\r\n            setReason('');\r\n        }\r\n    }, [isOpen]);\r\n\r\n    return (\r\n        <Dialog open={isOpen} onOpenChange={onOpenChange}>\r\n            <DialogContent className=\"sm:max-w-md\">\r\n                <DialogHeader>\r\n                    <DialogTitle>Báo giao hàng thất bại</DialogTitle>\r\n                    <DialogDescription>\r\n                        Nhập lý do giao hàng thất bại. Hàng sẽ được hoàn về kho và có thể tạo lại đơn giao hàng mới.\r\n                    </DialogDescription>\r\n                </DialogHeader>\r\n                <div className=\"pt-4\">\r\n                    <Label htmlFor=\"failure-reason-delivery\">Lý do</Label>\r\n                    <Textarea\r\n                        id=\"failure-reason-delivery\"\r\n                        value={reason}\r\n                        onChange={(e) => setReason(e.target.value)}\r\n                        className=\"mt-2\"\r\n                        placeholder=\"VD: Khách không nghe máy, sai địa chỉ...\"\r\n                    />\r\n                </div>\r\n                <DialogFooter>\r\n                    <Button variant=\"outline\" onClick={() => onOpenChange(false)}>Thoát</Button>\r\n                    <Button variant=\"destructive\" onClick={handleConfirm}>Xác nhận</Button>\r\n                </DialogFooter>\r\n            </DialogContent>\r\n        </Dialog>\r\n    );\r\n}\r\n"],"names":[],"mappings":";;;;;AAAA;AACA;AACA;AACA;AACA;;;;;;;AAQO,SAAS,sBAAsB,EAAE,MAAM,EAAE,YAAY,EAAE,SAAS,EAA8B;IACjG,MAAM,CAAC,QAAQ,UAAU,GAAG,iNAAc,CAAC;IAE3C,MAAM,gBAAgB;QAClB,UAAU;QACV,aAAa;IACjB;IAEA,kNAAe,CAAC;QACZ,IAAI,CAAC,QAAQ;YACT,UAAU;QACd;IACJ,GAAG;QAAC;KAAO;IAEX,qBACI,8OAAC,qIAAM;QAAC,MAAM;QAAQ,cAAc;kBAChC,cAAA,8OAAC,4IAAa;YAAC,WAAU;;8BACrB,8OAAC,2IAAY;;sCACT,8OAAC,0IAAW;sCAAC;;;;;;sCACb,8OAAC,gJAAiB;sCAAC;;;;;;;;;;;;8BAIvB,8OAAC;oBAAI,WAAU;;sCACX,8OAAC,mIAAK;4BAAC,SAAQ;sCAA0B;;;;;;sCACzC,8OAAC,yIAAQ;4BACL,IAAG;4BACH,OAAO;4BACP,UAAU,CAAC,IAAM,UAAU,EAAE,MAAM,CAAC,KAAK;4BACzC,WAAU;4BACV,aAAY;;;;;;;;;;;;8BAGpB,8OAAC,2IAAY;;sCACT,8OAAC,qIAAM;4BAAC,SAAQ;4BAAU,SAAS,IAAM,aAAa;sCAAQ;;;;;;sCAC9D,8OAAC,qIAAM;4BAAC,SAAQ;4BAAc,SAAS;sCAAe;;;;;;;;;;;;;;;;;;;;;;;AAK1E"}},
    {"offset": {"line": 1667, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/orders/components/payment-info.tsx"],"sourcesContent":["import * as React from 'react';\r\nimport Link from 'next/link';\r\nimport { formatDate, formatDateTime, formatDateTimeSeconds, formatDateCustom, parseDate, getCurrentDate } from '@/lib/date-utils';\r\nimport type { OrderPayment, Order, OrderAddress } from '../types';\r\nimport { Button } from '../../../components/ui/button';\r\nimport { DetailField } from '../../../components/ui/detail-field';\r\nimport { cn } from '../../../lib/utils';\r\nimport { ChevronRight, ChevronDown, Printer, Banknote, Minus } from 'lucide-react';\r\nimport { Badge } from '../../../components/ui/badge';\r\nimport { useAllEmployees } from '../../employees/hooks/use-all-employees';\r\nimport { useAllBranches } from '../../settings/branches/hooks/use-all-branches';\r\nimport { useStoreInfo } from '../../settings/store-info/hooks/use-store-info';\r\nimport { usePrint } from '../../../lib/use-print';\r\nimport { numberToWords, formatTime, StoreSettings } from '../../../lib/print-service';\r\nimport { mapReceiptToPrintData, ReceiptForPrint } from '../../../lib/print-mappers/receipt.mapper';\r\nimport { mapPaymentToPrintData, PaymentForPrint } from '../../../lib/print-mappers/payment.mapper';\r\n\r\nconst formatCurrency = (value?: number) => {\r\n    if (typeof value !== 'number' || isNaN(value)) return '0';\r\n    return new Intl.NumberFormat('vi-VN').format(value);\r\n};\r\n\r\n\r\n\r\ninterface PaymentInfoProps {\r\n    payment: OrderPayment;\r\n    order: Order;\r\n}\r\n\r\nexport function PaymentInfo({ payment, order }: PaymentInfoProps) {\r\n    const [isExpanded, setIsExpanded] = React.useState(false);\r\n    const { data: employees } = useAllEmployees();\r\n    const { data: branches } = useAllBranches();\r\n    const { data: storeInfoData } = useStoreInfo();\r\n    const storeInfo = storeInfoData || {} as Partial<typeof storeInfoData>;\r\n    const { print } = usePrint(order.branchSystemId);\r\n\r\n    const findEmployeeById = React.useCallback((id: string) => employees.find(e => e.systemId === id), [employees]);\r\n    const findBranchById = React.useCallback((id: string) => branches.find(b => b.systemId === id), [branches]);\r\n\r\n    const creator = React.useMemo(() => {\r\n        // Try finding by System ID first\r\n        const bySystemId = findEmployeeById(payment.createdBy);\r\n        if (bySystemId) return bySystemId;\r\n        \r\n        // Fallback: Try finding by Business ID (e.g. EMP000001)\r\n        return employees.find(e => e.id === (payment.createdBy as unknown as string));\r\n    }, [findEmployeeById, employees, payment.createdBy]);\r\n    \r\n    // Determine if this is a payment (negative amount) or receipt (positive amount)\r\n    const isPayment = payment.amount < 0;\r\n    const isWarrantyPayment = !!(payment as any).linkedWarrantySystemId;\r\n    const detailLink = isPayment ? `/payments/${payment.systemId}` : `/receipts/${payment.systemId}`;\r\n\r\n    const handlePrint = (e: React.MouseEvent) => {\r\n        e.stopPropagation();\r\n        \r\n        const amount = Math.abs(payment.amount);\r\n        const type = isPayment ? 'payment' : 'receipt';\r\n        \r\n        // Helper to get address string safely\r\n        const getAddressStr = (addr: string | OrderAddress | undefined) => {\r\n            if (!addr) return '';\r\n            return typeof addr === 'string' ? addr : addr.formattedAddress || '';\r\n        };\r\n\r\n        // Try shipping address first, then billing address\r\n        const addressStr = getAddressStr(order.shippingAddress) || getAddressStr(order.billingAddress);\r\n            \r\n        const phoneStr = typeof order.shippingAddress === 'object' \r\n            ? order.shippingAddress?.phone || order.shippingAddress?.contactPhone || ''\r\n            : '';\r\n\r\n        // Get branch info\r\n        const branch = findBranchById(order.branchSystemId);\r\n\r\n        // Prepare store settings\r\n        const storeSettings: StoreSettings = {\r\n            name: storeInfo.brandName || storeInfo.companyName,\r\n            address: storeInfo.headquartersAddress,\r\n            phone: storeInfo.hotline,\r\n            email: storeInfo.email,\r\n            province: storeInfo.province,\r\n            // logo: undefined // TODO: Add logo if available\r\n        };\r\n\r\n        let printData;\r\n\r\n        if (isPayment) {\r\n            const paymentData: PaymentForPrint = {\r\n                code: payment.id,\r\n                createdAt: payment.date,\r\n                issuedAt: payment.date,\r\n                createdBy: creator?.fullName || payment.createdBy,\r\n                recipientName: order.customerName,\r\n                recipientPhone: phoneStr,\r\n                recipientAddress: addressStr,\r\n                recipientType: 'Khách hàng',\r\n                amount: amount,\r\n                description: payment.description,\r\n                paymentMethod: payment.method,\r\n                documentRootCode: order.id,\r\n                note: payment.description,\r\n                location: branch ? {\r\n                    name: branch.name,\r\n                    address: branch.address,\r\n                    province: branch.province\r\n                } : undefined\r\n            };\r\n            printData = mapPaymentToPrintData(paymentData, storeSettings);\r\n        } else {\r\n            const receiptData: ReceiptForPrint = {\r\n                code: payment.id,\r\n                createdAt: payment.date,\r\n                issuedAt: payment.date,\r\n                createdBy: creator?.fullName || payment.createdBy,\r\n                payerName: order.customerName,\r\n                payerPhone: phoneStr,\r\n                payerAddress: addressStr,\r\n                payerType: 'Khách hàng',\r\n                amount: amount,\r\n                description: payment.description,\r\n                paymentMethod: payment.method,\r\n                documentRootCode: order.id,\r\n                note: payment.description,\r\n                location: branch ? {\r\n                    name: branch.name,\r\n                    address: branch.address,\r\n                    province: branch.province\r\n                } : undefined\r\n            };\r\n            printData = mapReceiptToPrintData(receiptData, storeSettings);\r\n        }\r\n\r\n        // Add extra fields that might be missing in mapper but present in template\r\n        printData['amount_text'] = numberToWords(amount);\r\n        printData['print_date'] = formatDate(new Date());\r\n        printData['print_time'] = formatTime(new Date());\r\n        printData['receipt_barcode'] = payment.id;\r\n        printData['description'] = payment.description;\r\n        printData['payment_method'] = payment.method;\r\n\r\n        print(type, { data: printData });\r\n    };\r\n\r\n    return (\r\n        <div className=\"border rounded-md bg-background text-sm\">\r\n            {/* Header */}\r\n            <div className=\"flex items-center p-3 cursor-pointer\" onClick={() => setIsExpanded(!isExpanded)}>\r\n                {isPayment ? (\r\n                    <Minus className=\"h-4 w-4 text-red-500 mr-3 flex-shrink-0\" />\r\n                ) : (\r\n                    <Banknote className=\"h-4 w-4 text-green-500 mr-3 flex-shrink-0\" />\r\n                )}\r\n                <Link \r\n                    href={detailLink} \r\n                    className=\"font-semibold font-mono text-primary hover:underline\"\r\n                    onClick={(e) => e.stopPropagation()} // Prevent collapsing when clicking link\r\n                >\r\n                    {payment.id}\r\n                </Link>\r\n                {isWarrantyPayment && (\r\n                    <Badge variant=\"secondary\" className=\"ml-2 text-xs\">Bảo hành</Badge>\r\n                )}\r\n                <div className=\"flex-grow text-right text-muted-foreground px-4\">\r\n                    {formatDate(payment.date)}\r\n                </div>\r\n                <div className={cn(\r\n                    \"w-28 text-right font-semibold\",\r\n                    isPayment ? \"text-red-600\" : \"text-green-600\"\r\n                )}>\r\n                    {isPayment ? '-' : '+'}{formatCurrency(Math.abs(payment.amount))}\r\n                </div>\r\n                <Button variant=\"ghost\" size=\"icon\" className=\"h-8 w-8 ml-2 flex-shrink-0\" onClick={handlePrint} title=\"In phiếu\">\r\n                    <Printer className=\"h-4 w-4\" />\r\n                </Button>\r\n                <Button variant=\"ghost\" size=\"icon\" className=\"h-8 w-8 ml-2 flex-shrink-0\">\r\n                    {isExpanded ? <ChevronDown className=\"h-4 w-4\" /> : <ChevronRight className=\"h-4 w-4\" />}\r\n                </Button>\r\n            </div>\r\n            \r\n            {/* Content */}\r\n            {isExpanded && (\r\n                <div className=\"p-4 border-t bg-muted/50 space-y-2\">\r\n                    <div className=\"grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-1\">\r\n                        <DetailField label=\"Phương thức\" value={payment.method} className=\"py-1 border-0\" />\r\n                        <DetailField \r\n                            label=\"Người tạo\" \r\n                            className=\"py-1 border-0\"\r\n                            value={creator ? (\r\n                                <Link href={`/employees/${creator.systemId}`} className=\"text-primary hover:underline\">\r\n                                    {creator.fullName}\r\n                                </Link>\r\n                            ) : payment.createdBy}\r\n                        />\r\n                        <DetailField label=\"Diễn giải\" value={payment.description} className=\"py-1 border-0 col-span-2\" />\r\n                        {isWarrantyPayment && (payment as any).linkedWarrantySystemId && (\r\n                            <DetailField \r\n                                label=\"Liên kết\" \r\n                                value={\r\n                                    <Link \r\n                                        href={`/warranty/${(payment as any).linkedWarrantySystemId}`}\r\n                                        className=\"text-primary hover:underline\"\r\n                                    >\r\n                                        Xem phiếu bảo hành\r\n                                    </Link>\r\n                                } \r\n                                className=\"py-1 border-0 col-span-2\" \r\n                            />\r\n                        )}\r\n                    </div>\r\n                </div>\r\n            )}\r\n        </div>\r\n    );\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 2001, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/orders/components/shipping-tracking-tab.tsx"],"sourcesContent":["import * as React from 'react';\r\nimport Link from 'next/link';\r\nimport { formatDateTime } from '@/lib/date-utils';\r\nimport type { Order, Packaging } from '../types';\r\nimport { Card, CardContent, CardHeader, CardTitle } from '../../../components/ui/card';\r\nimport { Badge } from '../../../components/ui/badge';\r\nimport { Button } from '../../../components/ui/button';\r\nimport { ScrollArea } from '../../../components/ui/scroll-area';\r\nimport { Truck, RefreshCw } from 'lucide-react';\r\nimport { useOrderActions } from '../hooks/use-order-actions';\r\n\r\ninterface ShippingTrackingTabProps {\r\n    order: Order;\r\n}\r\n\r\nexport function ShippingTrackingTab({ order }: ShippingTrackingTabProps) {\r\n    const { syncShipment } = useOrderActions();\r\n    \r\n    // Find the active packaging with shipping partner\r\n    const shippingPackaging = React.useMemo(() => {\r\n        return order.packagings.find(\r\n            (p) => p.deliveryMethod === 'Dịch vụ giao hàng' && p.status !== 'Hủy đóng gói'\r\n        );\r\n    }, [order.packagings]);\r\n\r\n    const handleManualSync = async () => {\r\n        if (!shippingPackaging?.trackingCode || syncShipment.isPending) return;\r\n        \r\n        try {\r\n            await syncShipment.mutateAsync(order.systemId);\r\n        } catch (error) {\r\n            console.error('Manual sync error:', error);\r\n        }\r\n    };\r\n\r\n    if (!shippingPackaging) {\r\n        return (\r\n            <Card>\r\n                <CardContent className=\"p-8 text-center text-muted-foreground\">\r\n                    <Truck className=\"h-12 w-12 mx-auto mb-4 opacity-50\" />\r\n                    <p>Đơn hàng chưa được gửi qua đơn vị vận chuyển</p>\r\n                </CardContent>\r\n            </Card>\r\n        );\r\n    }\r\n\r\n    return (\r\n        <div className=\"space-y-4\">\r\n            {/* Link to packaging detail */}\r\n            <div className=\"text-sm text-muted-foreground text-center\">\r\n                <Link \r\n                    href={`/packaging/${shippingPackaging.systemId}`}\r\n                    className=\"text-primary hover:underline\"\r\n                >\r\n                    Xem chi tiết phiếu đóng gói →\r\n                </Link>\r\n            </div>\r\n\r\n            {/* Webhook Debug Panel (Dev Only) */}\r\n            {process.env.NODE_ENV === 'development' && (\r\n                <Card className=\"border-dashed border-amber-300 bg-amber-50/50\">\r\n                    <CardHeader>\r\n                        <CardTitle className=\"text-sm font-semibold flex items-center gap-2 text-amber-900\">\r\n                            🔧 Webhook Debug Log\r\n                            <Badge variant=\"outline\" className=\"ml-auto text-xs\">DEV ONLY</Badge>\r\n                        </CardTitle>\r\n                    </CardHeader>\r\n                    <CardContent className=\"space-y-3\">\r\n                        <div>\r\n                            <p className=\"text-xs text-muted-foreground mb-2\">Webhook History:</p>\r\n                            <ScrollArea className=\"h-48 w-full rounded-md border bg-background p-3\">\r\n                                <pre className=\"text-xs font-mono whitespace-pre-wrap\">\r\n                                    {JSON.stringify(\r\n                                        {\r\n                                            trackingCode: shippingPackaging.trackingCode,\r\n                                            currentStatus: shippingPackaging.ghtkStatusId,\r\n                                            lastSynced: shippingPackaging.lastSyncedAt,\r\n                                            webhookHistory: shippingPackaging.ghtkWebhookHistory || [],\r\n                                            reason: {\r\n                                                code: shippingPackaging.ghtkReasonCode,\r\n                                                text: shippingPackaging.ghtkReasonText,\r\n                                            },\r\n                                        },\r\n                                        null,\r\n                                        2\r\n                                    )}\r\n                                </pre>\r\n                            </ScrollArea>\r\n                        </div>\r\n                        <div className=\"flex items-center gap-2\">\r\n                            <Button\r\n                                size=\"sm\"\r\n                                variant=\"outline\"\r\n                                onClick={handleManualSync}\r\n                                disabled={syncShipment.isPending || !shippingPackaging.trackingCode}\r\n                            >\r\n                                <RefreshCw className={`h-4 w-4 mr-2 ${syncShipment.isPending ? 'animate-spin' : ''}`} />\r\n                                {syncShipment.isPending ? 'Đang sync...' : 'Manual Sync'}\r\n                            </Button>\r\n                            {shippingPackaging.lastSyncedAt && (\r\n                                <span className=\"text-xs text-muted-foreground\">\r\n                                    Lần cuối: {formatDateTime(shippingPackaging.lastSyncedAt)}\r\n                                </span>\r\n                            )}\r\n                        </div>\r\n                    </CardContent>\r\n                </Card>\r\n            )}\r\n        </div>\r\n    );\r\n}\r\n"],"names":[],"mappings":";;;;;AAAA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAAA;AACA;;;;;;;;;;;AAMO,SAAS,oBAAoB,EAAE,KAAK,EAA4B;IACnE,MAAM,EAAE,YAAY,EAAE,GAAG,IAAA,yKAAe;IAExC,kDAAkD;IAClD,MAAM,oBAAoB,gNAAa,CAAC;QACpC,OAAO,MAAM,UAAU,CAAC,IAAI,CACxB,CAAC,IAAM,EAAE,cAAc,KAAK,uBAAuB,EAAE,MAAM,KAAK;IAExE,GAAG;QAAC,MAAM,UAAU;KAAC;IAErB,MAAM,mBAAmB;QACrB,IAAI,CAAC,mBAAmB,gBAAgB,aAAa,SAAS,EAAE;QAEhE,IAAI;YACA,MAAM,aAAa,WAAW,CAAC,MAAM,QAAQ;QACjD,EAAE,OAAO,OAAO;YACZ,QAAQ,KAAK,CAAC,sBAAsB;QACxC;IACJ;IAEA,IAAI,CAAC,mBAAmB;QACpB,qBACI,8OAAC,iIAAI;sBACD,cAAA,8OAAC,wIAAW;gBAAC,WAAU;;kCACnB,8OAAC,6MAAK;wBAAC,WAAU;;;;;;kCACjB,8OAAC;kCAAE;;;;;;;;;;;;;;;;;IAInB;IAEA,qBACI,8OAAC;QAAI,WAAU;;0BAEX,8OAAC;gBAAI,WAAU;0BACX,cAAA,8OAAC,uKAAI;oBACD,MAAM,CAAC,WAAW,EAAE,kBAAkB,QAAQ,EAAE;oBAChD,WAAU;8BACb;;;;;;;;;;;YAMJ,oDAAyB,+BACtB,8OAAC,iIAAI;gBAAC,WAAU;;kCACZ,8OAAC,uIAAU;kCACP,cAAA,8OAAC,sIAAS;4BAAC,WAAU;;gCAA+D;8CAEhF,8OAAC,mIAAK;oCAAC,SAAQ;oCAAU,WAAU;8CAAkB;;;;;;;;;;;;;;;;;kCAG7D,8OAAC,wIAAW;wBAAC,WAAU;;0CACnB,8OAAC;;kDACG,8OAAC;wCAAE,WAAU;kDAAqC;;;;;;kDAClD,8OAAC,iJAAU;wCAAC,WAAU;kDAClB,cAAA,8OAAC;4CAAI,WAAU;sDACV,KAAK,SAAS,CACX;gDACI,cAAc,kBAAkB,YAAY;gDAC5C,eAAe,kBAAkB,YAAY;gDAC7C,YAAY,kBAAkB,YAAY;gDAC1C,gBAAgB,kBAAkB,kBAAkB,IAAI,EAAE;gDAC1D,QAAQ;oDACJ,MAAM,kBAAkB,cAAc;oDACtC,MAAM,kBAAkB,cAAc;gDAC1C;4CACJ,GACA,MACA;;;;;;;;;;;;;;;;;0CAKhB,8OAAC;gCAAI,WAAU;;kDACX,8OAAC,qIAAM;wCACH,MAAK;wCACL,SAAQ;wCACR,SAAS;wCACT,UAAU,aAAa,SAAS,IAAI,CAAC,kBAAkB,YAAY;;0DAEnE,8OAAC,6NAAS;gDAAC,WAAW,CAAC,aAAa,EAAE,aAAa,SAAS,GAAG,iBAAiB,IAAI;;;;;;4CACnF,aAAa,SAAS,GAAG,iBAAiB;;;;;;;oCAE9C,kBAAkB,YAAY,kBAC3B,8OAAC;wCAAK,WAAU;;4CAAgC;4CACjC,IAAA,sIAAc,EAAC,kBAAkB,YAAY;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAS5F"}},
    {"offset": {"line": 2226, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/orders/components/shipping/shipping-partner-card.tsx"],"sourcesContent":["/**\r\n * ShippingPartnerCard\r\n * Display a partner with multiple service options (radio group)\r\n */\r\n\r\nimport * as React from 'react';\r\nimport { RadioGroup, RadioGroupItem } from '@/components/ui/radio-group';\r\nimport { Label } from '@/components/ui/label';\r\nimport { Badge } from '@/components/ui/badge';\r\nimport { Package, Zap, DollarSign } from 'lucide-react';\r\nimport type { ShippingService } from './types';\r\n\r\ninterface ShippingPartnerCardProps {\r\n  partnerCode: string;\r\n  partnerName: string;\r\n  services: ShippingService[];\r\n  selectedServiceId?: string | undefined;\r\n  onServiceSelect: (service: ShippingService) => void;\r\n  disabled?: boolean | undefined;\r\n}\r\n\r\n// Partner logos/colors\r\nconst partnerStyles: Record<string, { bg: string; logo: string }> = {\r\n  'GHTK': { bg: 'bg-green-500', logo: 'GHTK' },\r\n  'GHN': { bg: 'bg-orange-500', logo: 'GHN' },\r\n  'VTP': { bg: 'bg-orange-500', logo: 'VTP' },\r\n  'J&T': { bg: 'bg-red-600', logo: 'J&T' },\r\n  'SPX': { bg: 'bg-red-500', logo: 'SPX' },\r\n};\r\n\r\nexport function ShippingPartnerCard({\r\n  partnerCode,\r\n  partnerName,\r\n  services,\r\n  selectedServiceId,\r\n  onServiceSelect,\r\n  disabled = false,\r\n}: ShippingPartnerCardProps) {\r\n  const style = partnerStyles[partnerCode] || { bg: 'bg-gray-500', logo: partnerCode };\r\n  \r\n  // Find cheapest service\r\n  const cheapestService = services.reduce((prev, curr) => \r\n    curr.fee < prev.fee ? curr : prev\r\n  );\r\n\r\n  // Format currency\r\n  const formatCurrency = (value: number) => {\r\n    return new Intl.NumberFormat('vi-VN').format(value);\r\n  };\r\n\r\n  return (\r\n    <div className=\"border rounded-lg p-4 hover:border-primary/50 transition-colors\">\r\n      {/* Partner header */}\r\n      <div className=\"flex items-center gap-3 mb-3\">\r\n        <div className={`${style.bg} text-white font-bold text-sm px-3 py-2 rounded`}>\r\n          {style.logo}\r\n        </div>\r\n        <div className=\"flex-1\">\r\n          <h4 className=\"font-semibold text-base\">{partnerName}</h4>\r\n          <p className=\"text-sm text-muted-foreground\">\r\n            {services.length} lựa chọn\r\n          </p>\r\n        </div>\r\n        {cheapestService && (\r\n          <Badge variant=\"secondary\" className=\"bg-green-50 text-green-700 border-green-200\">\r\n            <DollarSign className=\"h-3 w-3 mr-1\" />\r\n            Rẻ nhất\r\n          </Badge>\r\n        )}\r\n      </div>\r\n\r\n      {/* Service options - No RadioGroup, parent already has it */}\r\n      <div className=\"space-y-2\">\r\n        {services.map((service) => {\r\n          const serviceKey = `service-${service.partnerId}-${service.serviceId}`;\r\n          const isSelected = selectedServiceId === serviceKey;\r\n          const isCheapest = service.serviceId === cheapestService.serviceId;\r\n\r\n          return (\r\n            <label\r\n              key={serviceKey}\r\n              htmlFor={serviceKey}\r\n              className={`\r\n                flex items-center gap-3 p-3 rounded-md border cursor-pointer transition-all\r\n                ${isSelected ? 'border-primary bg-primary/5' : 'border-border hover:border-primary/30'}\r\n                ${disabled ? 'opacity-50 cursor-not-allowed' : ''}\r\n              `}\r\n            >\r\n              <RadioGroupItem\r\n                id={serviceKey}\r\n                value={serviceKey}\r\n                disabled={disabled}\r\n              />\r\n              <div className=\"flex-1\">\r\n                <div className=\"flex items-center gap-2\">\r\n                  <span className=\"font-medium text-sm\">{service.serviceName}</span>\r\n                  {service.serviceId === 'express' && (\r\n                    <Badge variant=\"secondary\" className=\"text-xs bg-blue-50 text-blue-700 border-blue-200\">\r\n                      <Zap className=\"h-3 w-3 mr-1\" />\r\n                      Nhanh nhất\r\n                    </Badge>\r\n                  )}\r\n                  {isCheapest && services.length > 1 && (\r\n                    <Badge variant=\"secondary\" className=\"text-xs bg-green-50 text-green-700 border-green-200\">\r\n                      Rẻ nhất\r\n                    </Badge>\r\n                  )}\r\n                </div>\r\n                <div className=\"flex items-center gap-2 mt-1 text-xs text-muted-foreground\">\r\n                  <Package className=\"h-3 w-3\" />\r\n                  <span>{service.estimatedDays}</span>\r\n                </div>\r\n              </div>\r\n              <div className=\"text-right\">\r\n                <div className=\"font-bold text-lg\">{formatCurrency(service.fee)} ₫</div>\r\n                <div className=\"text-xs text-muted-foreground\">Phí vận chuyển</div>\r\n              </div>\r\n            </label>\r\n          );\r\n        })}\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n"],"names":[],"mappings":"AAAA;;;CAGC;;;;;AAGD;AAEA;AACA;AAAA;AAAA;;;;;AAYA,uBAAuB;AACvB,MAAM,gBAA8D;IAClE,QAAQ;QAAE,IAAI;QAAgB,MAAM;IAAO;IAC3C,OAAO;QAAE,IAAI;QAAiB,MAAM;IAAM;IAC1C,OAAO;QAAE,IAAI;QAAiB,MAAM;IAAM;IAC1C,OAAO;QAAE,IAAI;QAAc,MAAM;IAAM;IACvC,OAAO;QAAE,IAAI;QAAc,MAAM;IAAM;AACzC;AAEO,SAAS,oBAAoB,EAClC,WAAW,EACX,WAAW,EACX,QAAQ,EACR,iBAAiB,EACjB,eAAe,EACf,WAAW,KAAK,EACS;IACzB,MAAM,QAAQ,aAAa,CAAC,YAAY,IAAI;QAAE,IAAI;QAAe,MAAM;IAAY;IAEnF,wBAAwB;IACxB,MAAM,kBAAkB,SAAS,MAAM,CAAC,CAAC,MAAM,OAC7C,KAAK,GAAG,GAAG,KAAK,GAAG,GAAG,OAAO;IAG/B,kBAAkB;IAClB,MAAM,iBAAiB,CAAC;QACtB,OAAO,IAAI,KAAK,YAAY,CAAC,SAAS,MAAM,CAAC;IAC/C;IAEA,qBACE,8OAAC;QAAI,WAAU;;0BAEb,8OAAC;gBAAI,WAAU;;kCACb,8OAAC;wBAAI,WAAW,GAAG,MAAM,EAAE,CAAC,+CAA+C,CAAC;kCACzE,MAAM,IAAI;;;;;;kCAEb,8OAAC;wBAAI,WAAU;;0CACb,8OAAC;gCAAG,WAAU;0CAA2B;;;;;;0CACzC,8OAAC;gCAAE,WAAU;;oCACV,SAAS,MAAM;oCAAC;;;;;;;;;;;;;oBAGpB,iCACC,8OAAC,mIAAK;wBAAC,SAAQ;wBAAY,WAAU;;0CACnC,8OAAC,gOAAU;gCAAC,WAAU;;;;;;4BAAiB;;;;;;;;;;;;;0BAO7C,8OAAC;gBAAI,WAAU;0BACZ,SAAS,GAAG,CAAC,CAAC;oBACb,MAAM,aAAa,CAAC,QAAQ,EAAE,QAAQ,SAAS,CAAC,CAAC,EAAE,QAAQ,SAAS,EAAE;oBACtE,MAAM,aAAa,sBAAsB;oBACzC,MAAM,aAAa,QAAQ,SAAS,KAAK,gBAAgB,SAAS;oBAElE,qBACE,8OAAC;wBAEC,SAAS;wBACT,WAAW,CAAC;;gBAEV,EAAE,aAAa,gCAAgC,wCAAwC;gBACvF,EAAE,WAAW,kCAAkC,GAAG;cACpD,CAAC;;0CAED,8OAAC,qJAAc;gCACb,IAAI;gCACJ,OAAO;gCACP,UAAU;;;;;;0CAEZ,8OAAC;gCAAI,WAAU;;kDACb,8OAAC;wCAAI,WAAU;;0DACb,8OAAC;gDAAK,WAAU;0DAAuB,QAAQ,WAAW;;;;;;4CACzD,QAAQ,SAAS,KAAK,2BACrB,8OAAC,mIAAK;gDAAC,SAAQ;gDAAY,WAAU;;kEACnC,8OAAC,uMAAG;wDAAC,WAAU;;;;;;oDAAiB;;;;;;;4CAInC,cAAc,SAAS,MAAM,GAAG,mBAC/B,8OAAC,mIAAK;gDAAC,SAAQ;gDAAY,WAAU;0DAAsD;;;;;;;;;;;;kDAK/F,8OAAC;wCAAI,WAAU;;0DACb,8OAAC,mNAAO;gDAAC,WAAU;;;;;;0DACnB,8OAAC;0DAAM,QAAQ,aAAa;;;;;;;;;;;;;;;;;;0CAGhC,8OAAC;gCAAI,WAAU;;kDACb,8OAAC;wCAAI,WAAU;;4CAAqB,eAAe,QAAQ,GAAG;4CAAE;;;;;;;kDAChE,8OAAC;wCAAI,WAAU;kDAAgC;;;;;;;;;;;;;uBAnC5C;;;;;gBAuCX;;;;;;;;;;;;AAIR"}},
    {"offset": {"line": 2493, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/orders/components/shipping/shipping-partner-selected.tsx"],"sourcesContent":["/**\r\n * ShippingPartnerSelected\r\n * Display selected shipping partner with edit button\r\n */\r\n\r\nimport * as React from 'react';\r\nimport { Card, CardContent } from '@/components/ui/card';\r\nimport { Button } from '@/components/ui/button';\r\nimport { Badge } from '@/components/ui/badge';\r\nimport { Pencil, Package, Clock, Banknote, Code2 } from 'lucide-react';\r\nimport type { ShippingService } from './types';\r\n\r\ninterface ShippingPartnerSelectedProps {\r\n  service: ShippingService;\r\n  onEdit: () => void;\r\n  onTogglePreview?: (() => void) | undefined; // ✅ NEW: Callback to toggle preview\r\n  disabled?: boolean | undefined;\r\n}\r\n\r\nexport function ShippingPartnerSelected({\r\n  service,\r\n  onEdit,\r\n  onTogglePreview,\r\n  disabled,\r\n}: ShippingPartnerSelectedProps) {\r\n  return (\r\n    <div className=\"flex items-center justify-between p-4 border-2 border-green-500 bg-green-50/30 rounded-lg\">\r\n      <div className=\"flex items-center gap-3\">\r\n        <div className={`flex items-center justify-center h-9 w-16 rounded text-white text-xs font-bold\r\n          ${service.partnerCode === 'GHTK' ? 'bg-green-600' : \r\n            service.partnerCode === 'GHN' ? 'bg-orange-500' : \r\n            service.partnerCode === 'VTP' ? 'bg-orange-500' :\r\n            service.partnerCode === 'J&T' ? 'bg-red-600' :\r\n            service.partnerCode === 'SPX' ? 'bg-red-500' : 'bg-gray-500'}`}>\r\n          {service.partnerCode}\r\n        </div>\r\n        <div>\r\n          <div className=\"font-semibold\">{service.serviceName}</div>\r\n          <div className=\"text-sm text-muted-foreground\">{service.partnerName}</div>\r\n        </div>\r\n      </div>\r\n      \r\n      <div className=\"flex gap-2\">\r\n        {onTogglePreview && (\r\n          <Button\r\n            type=\"button\"\r\n            variant=\"outline\"\r\n            size=\"sm\"\r\n            onClick={(e) => {\r\n              e.preventDefault();\r\n              e.stopPropagation();\r\n              onTogglePreview();\r\n            }}\r\n            disabled={disabled}\r\n            className=\"gap-2\"\r\n          >\r\n            <Code2 className=\"h-4 w-4\" />\r\n            Xem API Data\r\n          </Button>\r\n        )}\r\n        <Button\r\n          type=\"button\"\r\n          variant=\"outline\"\r\n          size=\"sm\"\r\n          onClick={(e) => {\r\n            e.preventDefault();\r\n            e.stopPropagation();\r\n            onEdit();\r\n          }}\r\n          disabled={disabled}\r\n        >\r\n          Chọn lại đơn vị vận chuyển\r\n        </Button>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n"],"names":[],"mappings":"AAAA;;;CAGC;;;;;AAID;AAEA;;;;AAUO,SAAS,wBAAwB,EACtC,OAAO,EACP,MAAM,EACN,eAAe,EACf,QAAQ,EACqB;IAC7B,qBACE,8OAAC;QAAI,WAAU;;0BACb,8OAAC;gBAAI,WAAU;;kCACb,8OAAC;wBAAI,WAAW,CAAC;UACf,EAAE,QAAQ,WAAW,KAAK,SAAS,iBACjC,QAAQ,WAAW,KAAK,QAAQ,kBAChC,QAAQ,WAAW,KAAK,QAAQ,kBAChC,QAAQ,WAAW,KAAK,QAAQ,eAChC,QAAQ,WAAW,KAAK,QAAQ,eAAe,eAAe;kCAC/D,QAAQ,WAAW;;;;;;kCAEtB,8OAAC;;0CACC,8OAAC;gCAAI,WAAU;0CAAiB,QAAQ,WAAW;;;;;;0CACnD,8OAAC;gCAAI,WAAU;0CAAiC,QAAQ,WAAW;;;;;;;;;;;;;;;;;;0BAIvE,8OAAC;gBAAI,WAAU;;oBACZ,iCACC,8OAAC,qIAAM;wBACL,MAAK;wBACL,SAAQ;wBACR,MAAK;wBACL,SAAS,CAAC;4BACR,EAAE,cAAc;4BAChB,EAAE,eAAe;4BACjB;wBACF;wBACA,UAAU;wBACV,WAAU;;0CAEV,8OAAC,mNAAK;gCAAC,WAAU;;;;;;4BAAY;;;;;;;kCAIjC,8OAAC,qIAAM;wBACL,MAAK;wBACL,SAAQ;wBACR,MAAK;wBACL,SAAS,CAAC;4BACR,EAAE,cAAc;4BAChB,EAAE,eAAe;4BACjB;wBACF;wBACA,UAAU;kCACX;;;;;;;;;;;;;;;;;;AAMT"}},
    {"offset": {"line": 2614, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/orders/components/shipping/shipping-partner-selector.tsx"],"sourcesContent":["/**\r\n * ShippingPartnerSelector\r\n * Main component for selecting shipping partner and service\r\n * Calculates fees from multiple partners in parallel\r\n */\r\n\r\nimport * as React from 'react';\r\nimport { useRouter } from 'next/navigation';\r\nimport { RadioGroup } from '@/components/ui/radio-group';\r\nimport { Button } from '@/components/ui/button';\r\nimport { Alert, AlertDescription } from '@/components/ui/alert';\r\nimport { Skeleton } from '@/components/ui/skeleton';\r\nimport { AlertCircle, Truck, Loader2 } from 'lucide-react';\r\nimport { useShippingCalculator } from '../../hooks/use-shipping-calculator';\r\nimport { ShippingPartnerCard } from './shipping-partner-card';\r\nimport { ShippingPartnerSelected } from './shipping-partner-selected';\r\nimport type {\r\n  ShippingCalculationRequest,\r\n  ShippingService,\r\n  ShippingCalculationResult,\r\n} from './types';\r\n\r\ninterface ShippingPartnerSelectorProps {\r\n  request: ShippingCalculationRequest;\r\n  selectedService?: ShippingService | null | undefined;\r\n  onServiceSelect: (service: ShippingService | null) => void;\r\n  onServiceUpdate?: ((service: ShippingService) => void) | undefined; // ✅ NEW: Callback when service fee updates\r\n  onTogglePreview?: (() => void) | undefined; // ✅ NEW: Callback to toggle API data preview\r\n  disabled?: boolean | undefined;\r\n  collapsed?: boolean | undefined;\r\n}\r\n\r\nexport function ShippingPartnerSelector({\r\n  request,\r\n  selectedService,\r\n  onServiceSelect,\r\n  onServiceUpdate,\r\n  onTogglePreview,\r\n  disabled,\r\n  collapsed,\r\n}: ShippingPartnerSelectorProps) {\r\n  const router = useRouter();\r\n  const { results, isCalculating, calculateFees } = useShippingCalculator();\r\n  const prevWeightRef = React.useRef<number>(0);\r\n  const prevOrderValueRef = React.useRef<number>(0); // ✅ Track orderValue\r\n  const prevTransportRef = React.useRef<string>(''); // ✅ Track transport\r\n  const prevToProvinceRef = React.useRef<string>('');\r\n  const prevFromProvinceRef = React.useRef<string>('');\r\n  const [isExpanded, setIsExpanded] = React.useState(!collapsed);\r\n  const debounceTimerRef = React.useRef<NodeJS.Timeout | null>(null); // ✅ Debounce timer\r\n\r\n  // Auto-calculate whenever weight, orderValue, or transport changes (with debounce)\r\n  React.useEffect(() => {\r\n    // Calculate if have basic info (loosen requirement for 2-level address)\r\n    if (\r\n      request.weight > 0 &&\r\n      request.toProvince &&\r\n      request.fromProvince\r\n    ) {\r\n      // Check if any relevant field actually changed\r\n      const weightChanged = prevWeightRef.current !== request.weight;\r\n      const orderValueChanged = prevOrderValueRef.current !== (request.options?.orderValue || 0);\r\n      const transportChanged = prevTransportRef.current !== (request.options?.transport || 'road');\r\n      const toProvinceChanged = prevToProvinceRef.current !== request.toProvince;\r\n      const fromProvinceChanged = prevFromProvinceRef.current !== request.fromProvince;\r\n      const isFirstRun = prevWeightRef.current === 0;\r\n      \r\n      if (weightChanged || orderValueChanged || transportChanged || toProvinceChanged || fromProvinceChanged || isFirstRun) {\r\n        // ✅ Clear previous debounce timer\r\n        if (debounceTimerRef.current) {\r\n          clearTimeout(debounceTimerRef.current);\r\n        }\r\n        \r\n        // ✅ Debounce 500ms để tránh spam request khi đổi nhanh\r\n        debounceTimerRef.current = setTimeout(() => {\r\n          calculateFees(request);\r\n        }, 500);\r\n        \r\n        // Update refs\r\n        prevWeightRef.current = request.weight;\r\n        prevOrderValueRef.current = request.options?.orderValue || 0;\r\n        prevTransportRef.current = request.options?.transport || 'road';\r\n        prevToProvinceRef.current = request.toProvince;\r\n        prevFromProvinceRef.current = request.fromProvince;\r\n      }\r\n    }\r\n    \r\n    // ✅ Cleanup debounce timer on unmount\r\n    return () => {\r\n      if (debounceTimerRef.current) {\r\n        clearTimeout(debounceTimerRef.current);\r\n      }\r\n    };\r\n  }, [request.weight, request.options?.orderValue, request.options?.transport, request.toProvince, request.fromProvince, request.toDistrict, request.fromDistrict, calculateFees]); // ✅ Track all fields directly\r\n\r\n  // ✅ NEW: Auto-update selected service when results change\r\n  React.useEffect(() => {\r\n    if (!selectedService || !onServiceUpdate) return;\r\n    \r\n    // Find updated service with same ID\r\n    const allServices: ShippingService[] = [];\r\n    results.forEach(result => {\r\n      if (result.status === 'success') {\r\n        allServices.push(...result.services);\r\n      }\r\n    });\r\n    \r\n    const updatedService = allServices.find(\r\n      s => s.partnerId === selectedService.partnerId && \r\n           s.serviceId === selectedService.serviceId\r\n    );\r\n    \r\n    if (updatedService && updatedService.fee !== selectedService.fee) {\r\n      onServiceUpdate(updatedService);\r\n    }\r\n  }, [results, selectedService, onServiceUpdate]);\r\n\r\n  // Flatten all services from all partners\r\n  const allServices = React.useMemo(() => {\r\n    const services: ShippingService[] = [];\r\n    results.forEach((result) => {\r\n      if (result.status === 'success') {\r\n        services.push(...result.services);\r\n      }\r\n    });\r\n    return services;\r\n  }, [results]);\r\n\r\n  // Group services by partner\r\n  const groupedByPartner = React.useMemo(() => {\r\n    const groups: Record<string, ShippingService[]> = {};\r\n    allServices.forEach(service => {\r\n      if (!groups[service.partnerCode]) {\r\n        groups[service.partnerCode] = [];\r\n      }\r\n      groups[service.partnerCode].push(service);\r\n    });\r\n    return groups;\r\n  }, [allServices]);\r\n\r\n  // Get not-configured partners\r\n  const notConfiguredPartners = React.useMemo(() => {\r\n    return results.filter(r => r.status === 'error' && r.error === 'NOT_CONFIGURED');\r\n  }, [results]);\r\n\r\n  // Find fastest and cheapest\r\n  const { fastestService, cheapestService } = React.useMemo(() => {\r\n    if (allServices.length === 0) {\r\n      return { fastestService: null, cheapestService: null };\r\n    }\r\n\r\n    // Find cheapest\r\n    const cheapest = allServices.reduce((prev, curr) => \r\n      curr.fee < prev.fee ? curr : prev\r\n    );\r\n\r\n    // Find fastest by parsing estimated days\r\n    const fastest = allServices.reduce((prev, curr) => {\r\n      // Extract number from estimatedDays (e.g., \"1-2 ngày\" -> 1, \"3-5 ngày\" -> 3)\r\n      const prevDays = parseInt(prev.estimatedDays.match(/\\d+/)?.[0] || '999');\r\n      const currDays = parseInt(curr.estimatedDays.match(/\\d+/)?.[0] || '999');\r\n      return currDays < prevDays ? curr : prev;\r\n    });\r\n\r\n    return { \r\n      fastestService: fastest, \r\n      cheapestService: cheapest \r\n    };\r\n  }, [allServices]);\r\n\r\n  // Check if any partners are loading\r\n  const isLoading = isCalculating || results.some(r => r.status === 'loading');\r\n\r\n  // Check if all partners failed\r\n  const allFailed = results.length > 0 && results.every(r => r.status === 'error');\r\n\r\n  // Selected service ID\r\n  const selectedServiceId = selectedService\r\n    ? `service-${selectedService.partnerId}-${selectedService.serviceId}`\r\n    : '';\r\n\r\n  const handleServiceSelect = (service: ShippingService) => {\r\n    if (disabled) return;\r\n    onServiceSelect(service);\r\n  };\r\n\r\n  // Loading spinner - simple and clean\r\n  if (isCalculating) {\r\n    return (\r\n      <div className=\"flex items-center justify-center gap-2 py-8 text-sm text-muted-foreground\">\r\n        <Loader2 className=\"h-5 w-5 animate-spin\" />\r\n        <span>Đang tính phí vận chuyển...</span>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  // No services available\r\n  if (!isCalculating && allServices.length === 0 && notConfiguredPartners.length === 0) {\r\n    return (\r\n      <Alert variant=\"destructive\">\r\n        <AlertCircle className=\"h-4 w-4\" />\r\n        <AlertDescription>\r\n          {allFailed ? (\r\n            <>\r\n              Không thể kết nối với các đối tác vận chuyển. Vui lòng kiểm tra:\r\n              <ul className=\"list-disc list-inside mt-2 space-y-1\">\r\n                <li>Cấu hình tài khoản đối tác tại Cài đặt → Đối tác vận chuyển</li>\r\n                <li>Địa chỉ giao hàng có đầy đủ thông tin</li>\r\n                <li>Trọng lượng đơn hàng hợp lệ (tối thiểu 100g)</li>\r\n              </ul>\r\n            </>\r\n          ) : (\r\n            <>\r\n              {/* ✅ PHASE 3: Chi tiết lý do không tìm thấy dịch vụ */}\r\n              Không tìm thấy dịch vụ vận chuyển phù hợp. Vui lòng kiểm tra:\r\n              <ul className=\"list-disc list-inside mt-2 space-y-1\">\r\n                {(!request.toProvince || !request.toDistrict) && (\r\n                  <li className=\"text-destructive font-medium\">❌ Thiếu địa chỉ giao hàng (tỉnh/huyện)</li>\r\n                )}\r\n                {(!request.weight || request.weight <= 0) && (\r\n                  <li className=\"text-destructive font-medium\">❌ Thiếu khối lượng đơn hàng (chưa chọn sản phẩm?)</li>\r\n                )}\r\n                {!request.fromProvince && (\r\n                  <li className=\"text-destructive font-medium\">❌ Thiếu địa chỉ lấy hàng (chưa chọn chi nhánh?)</li>\r\n                )}\r\n                {request.weight > 0 && request.toProvince && request.fromProvince && (\r\n                  <li>✅ Thông tin đầy đủ nhưng không có dịch vụ khả dụng - Vui lòng thử đổi địa chỉ hoặc giảm trọng lượng</li>\r\n                )}\r\n                <li className=\"text-muted-foreground text-xs mt-2\">\r\n                  💡 Tip: Đảm bảo đã cấu hình tài khoản GHTK tại Cài đặt → Đối tác vận chuyển\r\n                </li>\r\n              </ul>\r\n            </>\r\n          )}\r\n        </AlertDescription>\r\n      </Alert>\r\n    );\r\n  }\r\n\r\n  // ✅ If collapsed and has selected service, show compact view\r\n  if (collapsed && selectedService) {\r\n    return (\r\n      <ShippingPartnerSelected\r\n        service={selectedService}\r\n        onEdit={() => {\r\n          setIsExpanded(true);\r\n          // Clear selection to force reselect\r\n          onServiceSelect(null);\r\n        }}\r\n        onTogglePreview={onTogglePreview}\r\n        disabled={disabled}\r\n      />\r\n    );\r\n  }\r\n\r\n  return (\r\n    <div className=\"space-y-4\">\r\n      {/* Header with info */}\r\n        <div className=\"flex items-center gap-2\">\r\n          <Truck className=\"h-5 w-5 text-muted-foreground\" />\r\n          <h3 className=\"text-sm font-semibold\">\r\n            Chọn đơn vị vận chuyển\r\n          </h3>\r\n          {Object.keys(groupedByPartner).length > 0 && (\r\n            <span className=\"text-sm text-muted-foreground\">\r\n              ({Object.keys(groupedByPartner).length} đối tác)\r\n            </span>\r\n          )}\r\n        </div>\r\n\r\n      {/* Show other errors (API errors) */}\r\n      {results.some(r => r.status === 'error' && r.error && r.error !== 'NOT_CONFIGURED') && (\r\n        <Alert>\r\n          <AlertCircle className=\"h-4 w-4\" />\r\n          <AlertDescription>\r\n            <p className=\"font-semibold mb-1\">Một số đối tác gặp lỗi:</p>\r\n            <ul className=\"list-disc list-inside text-sm space-y-1\">\r\n              {results\r\n                .filter(r => r.status === 'error' && r.error && r.error !== 'NOT_CONFIGURED')\r\n                .map((r, index) => (\r\n                  <li key={`${r.partnerId}-error-${index}`}>\r\n                    {r.partnerName}: {r.error}\r\n                  </li>\r\n                ))}\r\n            </ul>\r\n          </AlertDescription>\r\n        </Alert>\r\n      )}\r\n\r\n      {/* Partner cards with services */}\r\n      <RadioGroup\r\n        value={selectedServiceId}\r\n        onValueChange={(value) => {\r\n          if (disabled) return;\r\n          // Find service by value\r\n          const service = allServices.find(\r\n            s => `service-${s.partnerId}-${s.serviceId}` === value\r\n          );\r\n          if (service) {\r\n            handleServiceSelect(service);\r\n          }\r\n        }}\r\n        className=\"space-y-4\"\r\n      >\r\n        {Object.entries(groupedByPartner).map(([partnerCode, services]) => (\r\n          <ShippingPartnerCard\r\n            key={partnerCode}\r\n            partnerCode={partnerCode}\r\n            partnerName={services[0].partnerName}\r\n            services={services}\r\n            selectedServiceId={selectedServiceId}\r\n            onServiceSelect={handleServiceSelect}\r\n            disabled={disabled}\r\n          />\r\n        ))}\r\n      </RadioGroup>\r\n\r\n      {/* Not-configured partners */}\r\n      {notConfiguredPartners.length > 0 && (\r\n        <div className=\"border rounded-lg p-4 bg-orange-50/50\">\r\n          <p className=\"text-sm font-medium text-orange-900 mb-2\">\r\n            Dịch vụ vận chuyển hiện không khả dụng\r\n          </p>\r\n          <div className=\"space-y-2 mb-3\">\r\n            {notConfiguredPartners.map((partner, index) => (\r\n              <div key={`${partner.partnerId}-notconfig-${index}`} className=\"flex items-center gap-2 text-sm text-orange-800\">\r\n                <div className={`w-12 h-8 flex items-center justify-center rounded text-white text-xs font-bold\r\n                  ${partner.partnerCode === 'GHN' ? 'bg-orange-500' : \r\n                    partner.partnerCode === 'VTP' ? 'bg-orange-500' :\r\n                    partner.partnerCode === 'J&T' ? 'bg-red-600' :\r\n                    partner.partnerCode === 'SPX' ? 'bg-red-500' : 'bg-gray-500'}`}>\r\n                  {partner.partnerCode}\r\n                </div>\r\n                <span>{partner.partnerName}</span>\r\n              </div>\r\n            ))}\r\n          </div>\r\n          <Button\r\n            variant=\"outline\"\r\n            size=\"sm\"\r\n            onClick={() => router.push('/settings/shipping')}\r\n            className=\"w-full border-orange-300 text-orange-700 hover:bg-orange-100\"\r\n          >\r\n            Kết nối ngay\r\n          </Button>\r\n        </div>\r\n      )}\r\n\r\n      {/* Info message */}\r\n      {allServices.length > 0 && (\r\n        <p className=\"text-xs text-muted-foreground\">\r\n          💡 Giá được tính theo thời gian thực từ các đối tác vận chuyển.\r\n          Phí cuối cùng có thể thay đổi khi tạo đơn.\r\n        </p>\r\n      )}\r\n    </div>\r\n  );\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 3132, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/orders/components/shipping/service-config-form.tsx"],"sourcesContent":["/**\r\n * ServiceConfigForm\r\n * Inline form hiển thị config cho service đã chọn (GHTK, GHN, VTP...)\r\n * Render trực tiếp bên phải - KHÔNG DÙNG DIALOG\r\n */\r\n\r\nimport * as React from 'react';\r\nimport { Label } from '@/components/ui/label';\r\nimport { Input } from '@/components/ui/input';\r\nimport { CurrencyInput } from '@/components/ui/currency-input';\r\nimport { Checkbox } from '@/components/ui/checkbox'; // ✅ Keep for GHN form\r\nimport { RadioGroup, RadioGroupItem } from '@/components/ui/radio-group';\r\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';\r\nimport { Command, CommandEmpty, CommandGroup, CommandInput, CommandItem } from '@/components/ui/command';\r\nimport { Button } from '@/components/ui/button';\r\nimport { Calendar } from '@/components/ui/calendar';\r\nimport { Popover, PopoverContent, PopoverTrigger } from '@/components/ui/popover';\r\nimport { format } from 'date-fns';\r\nimport { vi } from 'date-fns/locale';\r\nimport { Calendar as CalendarIcon, Loader2, Check, ChevronsUpDown, Pencil } from 'lucide-react';\r\nimport { cn } from '@/lib/utils';\r\nimport { getBaseUrl } from '@/lib/api-config';\r\nimport { loadShippingConfig } from '@/lib/utils/shipping-config-migration'; // ✅ Use shared utility\r\nimport { useGlobalShippingConfig, getGHTKTagsFromRequirement } from '@/features/orders/hooks/use-global-shipping-config'; // ✅ Use global config\r\nimport { toast } from 'sonner'; // ✅ Import toast\r\nimport { AddressFormDialog } from '@/features/customers/components/address-form-dialog'; // ✅ Reuse existing component\r\nimport type { ShippingService, SelectedShippingConfig, ShippingAddress } from './types';\r\nimport type { CustomerAddress } from '@/features/customers/types';\r\n\r\ninterface ServiceConfigFormProps {\r\n  service: ShippingService;\r\n  config?: Partial<SelectedShippingConfig['options']> | undefined;\r\n  onConfigChange: (config: Partial<SelectedShippingConfig['options']>) => void;\r\n  grandTotal?: number | undefined; // ✅ Add grandTotal prop\r\n  customerAddress?: ShippingAddress | null | undefined; // ✅ Add customer address for specific addresses API\r\n}\r\n\r\n// GHTK Pick Address type\r\ninterface GHTKPickAddress {\r\n  id: string;\r\n  name: string;\r\n  address: string;\r\n  province: string;\r\n  district: string;\r\n  ward?: string;\r\n  tel: string;\r\n}\r\n\r\n// GHTK Specific Address type (street level)\r\ninterface GHTKSpecificAddress {\r\n  id: string;\r\n  name: string; // Full address string\r\n}\r\n\r\n// ✅ Cache for specific addresses (5 minutes)\r\nconst SPECIFIC_ADDRESS_CACHE_DURATION = 5 * 60 * 1000;\r\nconst specificAddressCache = new Map<string, { \r\n  data: GHTKSpecificAddress[]; \r\n  timestamp: number;\r\n}>();\r\n\r\n// ✅ Cache for GHTK pick addresses (1 hour)\r\nlet ghtkAddressCache: { data: GHTKPickAddress[]; timestamp: number; apiToken: string } | null = null;\r\n\r\nfunction getSpecificAddressCacheKey(province: string, district: string, ward: string): string {\r\n  return `${province}|${district}|${ward}`.toLowerCase();\r\n}\r\n\r\ntype ShippingOptions = NonNullable<SelectedShippingConfig['options']>;\r\n\r\nexport function ServiceConfigForm({ service, config = {}, onConfigChange, grandTotal = 0, customerAddress }: ServiceConfigFormProps) {\r\n  // ✅ Get global shipping config\r\n  const { globalConfig, getDefaultShippingOptions, getDimensions, deliveryRequirement, defaultNote } = useGlobalShippingConfig();\r\n  \r\n  // ✅ Initialize options with global config defaults\r\n  const [options, setOptions] = React.useState<Partial<ShippingOptions>>(() => {\r\n    const defaultOptions = getDefaultShippingOptions();\r\n    const ghtkTags = service.partnerCode === 'GHTK' ? getGHTKTagsFromRequirement(deliveryRequirement) : [];\r\n    \r\n    return {\r\n      transport: config?.transport || 'road',\r\n      payer: config?.payer || 'CUSTOMER',\r\n      pickOption: config?.pickOption || 'cod',\r\n      note: config?.note || defaultNote, // ✅ Use global default note\r\n      requirement: config?.requirement || deliveryRequirement, // ✅ Use global delivery requirement\r\n      tags: config?.tags || ghtkTags, // ✅ Apply GHTK tags based on global requirement\r\n      ...config, // Override with any explicitly provided config\r\n    };\r\n  });\r\n  \r\n  const [pickAddresses, setPickAddresses] = React.useState<GHTKPickAddress[]>([]);\r\n  const [loadingAddresses, setLoadingAddresses] = React.useState(false);\r\n  const [addressError, setAddressError] = React.useState<string>(''); // ✅ Add error state\r\n  \r\n  // ✅ Add state for specific addresses (street level)\r\n  const [specificAddresses, setSpecificAddresses] = React.useState<GHTKSpecificAddress[]>([]);\r\n  const [loadingSpecificAddresses, setLoadingSpecificAddresses] = React.useState(false);\r\n  const [specificAddressError, setSpecificAddressError] = React.useState<string>('');\r\n  \r\n  const [pickDate, setPickDate] = React.useState<Date>(new Date()); // ✅ Default to today\r\n  const [deliverDate, setDeliverDate] = React.useState<Date>();\r\n  const [openPickAddress, setOpenPickAddress] = React.useState(false);\r\n  const [openSpecificAddress, setOpenSpecificAddress] = React.useState(false);\r\n  const [openPickDate, setOpenPickDate] = React.useState(false);\r\n  const [openDeliverDate, setOpenDeliverDate] = React.useState(false);\r\n  \r\n  // ✅ Dialog state for return address (reuse AddressFormDialog)\r\n  const [openReturnAddressDialog, setOpenReturnAddressDialog] = React.useState(false);\r\n  const [openReturnAddressPicker, setOpenReturnAddressPicker] = React.useState(false); // ✅ Popover for choosing return address type\r\n  const [returnAddressData, setReturnAddressData] = React.useState<CustomerAddress | null>(null);\r\n\r\n  // ✅ Auto-set pickDate to today's date in options on mount\r\n  React.useEffect(() => {\r\n    if (!options.pickDate) {\r\n      const today = format(new Date(), 'yyyy-MM-dd');\r\n      handleInputChange('pickDate', today);\r\n    }\r\n  }, []); // Run only on mount\r\n\r\n  // ✅ Auto-fill orderValue = 3 triệu as default\r\n  React.useEffect(() => {\r\n    if (!options.orderValue) {\r\n      // Default to 3 million VND\r\n      handleInputChange('orderValue', 3000000);\r\n    }\r\n  }, []); // Run only on mount\r\n\r\n  // Load pick addresses for GHTK with caching\r\n  React.useEffect(() => {\r\n    if (service.partnerCode === 'GHTK') {\r\n      loadGHTKPickAddresses(); // ✅ Parallel load: Start immediately\r\n    }\r\n  }, [service.partnerCode]);\r\n\r\n  const loadGHTKPickAddresses = async () => {\r\n    // ✅ CACHE LAYER: Use in-memory cache (1 hour expiry)\r\n    const CACHE_DURATION = 60 * 60 * 1000; // 1 hour\r\n    \r\n    if (ghtkAddressCache) {\r\n      const { data, timestamp, apiToken } = ghtkAddressCache;\r\n      \r\n      // Verify cache is still valid\r\n      const config = loadShippingConfig();\r\n      const ghtkData = config.partners.GHTK;\r\n      const defaultAccount = ghtkData?.accounts?.find(a => a.isDefault && a.active)\r\n        || ghtkData?.accounts?.find(a => a.active);\r\n      const currentToken = defaultAccount?.credentials?.apiToken;\r\n      \r\n      if (\r\n        Date.now() - timestamp < CACHE_DURATION &&\r\n        apiToken === currentToken &&\r\n        Array.isArray(data) &&\r\n        data.length > 0\r\n      ) {\r\n        setPickAddresses(data);\r\n        \r\n        // Auto-select first if none selected\r\n        if (!options.pickAddressId && data[0]) {\r\n          handleInputChange('pickAddressId', data[0].id);\r\n        }\r\n        return; // Skip API call ⚡\r\n      }\r\n    }\r\n    \r\n    // ✅ No valid cache → Fetch from API\r\n    setLoadingAddresses(true);\r\n    setAddressError(''); // Clear previous error\r\n    \r\n    try {\r\n      // ✅ V2: Get default GHTK account\r\n      const config = loadShippingConfig();\r\n      const ghtkData = config.partners.GHTK;\r\n      \r\n      if (!ghtkData || !ghtkData.accounts || ghtkData.accounts.length === 0) {\r\n        throw new Error('GHTK chưa được cấu hình. Vui lòng vào Cài đặt > Vận chuyển để kết nối GHTK.');\r\n      }\r\n      \r\n      const defaultAccount = ghtkData.accounts.find(a => a.isDefault && a.active)\r\n        || ghtkData.accounts.find(a => a.active)\r\n        || ghtkData.accounts[0];\r\n\r\n      if (!defaultAccount || !defaultAccount.active) {\r\n        throw new Error('Không có tài khoản GHTK nào hoạt động. Vui lòng kích hoạt tài khoản.');\r\n      }\r\n\r\n      if (!defaultAccount.credentials.apiToken) {\r\n        throw new Error('Tài khoản GHTK chưa có API token. Vui lòng cấu hình lại.');\r\n      }\r\n\r\n      const apiToken = defaultAccount.credentials.apiToken;\r\n      const partnerCode = (defaultAccount.credentials as any).partnerCode || 'GHTK';\r\n\r\n      // ✅ Check if server is running first\r\n      const baseUrl = getBaseUrl();\r\n      const url = new URL(`${baseUrl}/api/shipping/ghtk/list-pick-addresses`);\r\n      url.searchParams.append('apiToken', apiToken);\r\n      url.searchParams.append('partnerCode', partnerCode);\r\n\r\n      // ✅ Add timeout and better error handling\r\n      const controller = new AbortController();\r\n      const timeoutId = setTimeout(() => controller.abort(), 10000); // 10s timeout\r\n\r\n      try {\r\n        const response = await fetch(url.toString(), { signal: controller.signal });\r\n        clearTimeout(timeoutId);\r\n        \r\n        if (!response.ok) {\r\n          throw new Error(`Server error: ${response.status}`);\r\n        }\r\n        const data = await response.json();\r\n        \r\n        if (data.success && data.data && Array.isArray(data.data)) {\r\n          if (data.data.length === 0) {\r\n            throw new Error('Tài khoản GHTK chưa có địa chỉ kho nào. Vui lòng thêm địa chỉ lấy hàng trên trang khachhang.giaohangtietkiem.vn');\r\n          }\r\n          \r\n          // Parse GHTK response format - just store raw data\r\n          const addresses: GHTKPickAddress[] = data.data.map((item: any) => {\r\n            return {\r\n              id: item.pick_address_id || item.id,\r\n              name: item.pick_name || item.name || 'Kho hàng',\r\n              address: item.address || '',\r\n              province: '', // Will be parsed when loading specific addresses\r\n              district: '', // Will be parsed when loading specific addresses\r\n              ward: '',\r\n              tel: item.pick_tel || item.tel || ''\r\n            };\r\n          });\r\n\r\n          setPickAddresses(addresses);\r\n          \r\n          // ✅ SAVE TO in-memory CACHE for next time\r\n          ghtkAddressCache = {\r\n            data: addresses,\r\n            timestamp: Date.now(),\r\n            apiToken: apiToken\r\n          };\r\n          \r\n          // ✅ Auto-select first address if none selected\r\n          if (addresses.length > 0 && !options.pickAddressId) {\r\n            const firstAddress = addresses[0];\r\n            handleInputChange('pickAddressId', firstAddress.id);\r\n          }\r\n        } else {\r\n          // Check specific error messages from GHTK\r\n          if (data.message) {\r\n            throw new Error(`GHTK API: ${data.message}`);\r\n          } else {\r\n            throw new Error('Không thể lấy danh sách kho từ GHTK. Vui lòng kiểm tra lại API Token.');\r\n          }\r\n        }\r\n      } catch (fetchError) {\r\n        // Handle fetch timeout or network error\r\n        if (fetchError instanceof Error && fetchError.name === 'AbortError') {\r\n          throw new Error('Server không phản hồi (timeout). Vui lòng kiểm tra server đã chạy chưa.');\r\n        }\r\n        throw new Error('Không thể kết nối server API. Vui lòng chạy: cd server && npm run dev');\r\n      }\r\n    } catch (error) {\r\n      console.error('❌ [ServiceConfigForm] Error loading pick addresses:', error);\r\n      \r\n      // ✅ Set error message for display\r\n      setAddressError(error instanceof Error ? error.message : 'Không thể tải danh sách kho');\r\n      setPickAddresses([]);\r\n    } finally {\r\n      setLoadingAddresses(false);\r\n    }\r\n  };\r\n\r\n  // ✅ Load specific addresses when pickAddressId changes\r\n  // ✅ Normalize address for GHTK API - ONLY lowercase, keep prefix!\r\n  const normalizeGHTKAddress = React.useCallback((text: string): string => {\r\n    if (!text) return '';\r\n    \r\n    // ✅ GHTK API expects lowercase with spaces, but KEEP all prefixes!\r\n    // Test results show \"tp hcm\", \"thành phố thủ dầu một\", \"phường hiệp thành\" works better\r\n    return text.trim().toLowerCase();\r\n  }, []);\r\n\r\n  const loadSpecificAddresses = React.useCallback(async (pickAddressId: string) => {\r\n    // ✅ No longer need pickAddressId - just use it as trigger ID for logging\r\n    \r\n    // ✅ FIXED: Support 2-level address - only province required, district optional\r\n    if (!customerAddress || !customerAddress.province) {\r\n      console.warn('⚠️ [ServiceConfigForm] No customer address available for specific addresses (missing province)');\r\n      setSpecificAddresses([]);\r\n      return;\r\n    }\r\n\r\n    // ✅ Check cache first\r\n    const province = customerAddress.province;\r\n    const district = customerAddress.district || '';\r\n    const ward = customerAddress.ward || '';\r\n    const cacheKey = getSpecificAddressCacheKey(province, district, ward);\r\n    const cached = specificAddressCache.get(cacheKey);\r\n    \r\n    if (cached && Date.now() - cached.timestamp < SPECIFIC_ADDRESS_CACHE_DURATION) {\r\n      setSpecificAddresses(cached.data);\r\n      return;\r\n    }\r\n\r\n    setLoadingSpecificAddresses(true);\r\n    setSpecificAddressError('');\r\n    \r\n    try {\r\n      const config = loadShippingConfig();\r\n      const ghtkData = config.partners.GHTK;\r\n      const defaultAccount = ghtkData?.accounts?.find(a => a.isDefault && a.active) \r\n        || ghtkData?.accounts?.find(a => a.active)\r\n        || ghtkData?.accounts?.[0];\r\n\r\n      if (!defaultAccount?.credentials.apiToken) {\r\n        throw new Error('Không tìm thấy API token');\r\n      }\r\n\r\n      // ✅ Use CUSTOMER address, NOT pick address (support 2-level: district can be empty)\r\n      const province = customerAddress.province;\r\n      const district = customerAddress.district || ''; // ✅ Empty for 2-level address\r\n      const ward = customerAddress.ward || '';\r\n\r\n      // Normalize for GHTK API\r\n      const normalizedProvince = normalizeGHTKAddress(province);\r\n      const normalizedDistrict = district ? normalizeGHTKAddress(district) : ''; // ✅ Keep empty if 2-level\r\n      const normalizedWard = normalizeGHTKAddress(ward);\r\n\r\n      if (!normalizedProvince) {\r\n        throw new Error(`Thiếu thông tin tỉnh/thành phố`);\r\n      }\r\n\r\n      const apiToken = defaultAccount.credentials.apiToken;\r\n      const baseUrl = getBaseUrl();\r\n      const url = new URL(`${baseUrl}/api/shipping/ghtk/get-specific-addresses`);\r\n      url.searchParams.append('province', normalizedProvince);\r\n      \r\n      // For 2-level address, try using ward as district\r\n      if (normalizedDistrict) {\r\n        url.searchParams.append('district', normalizedDistrict);\r\n      } else if (normalizedWard) {\r\n        url.searchParams.append('district', normalizedWard);\r\n      }\r\n      \r\n      url.searchParams.append('ward_street', normalizedWard);\r\n      url.searchParams.append('apiToken', apiToken);\r\n\r\n      const controller = new AbortController();\r\n      const timeoutId = setTimeout(() => controller.abort(), 10000);\r\n\r\n      try {\r\n        const response = await fetch(url.toString(), { signal: controller.signal });\r\n        clearTimeout(timeoutId);\r\n        \r\n        if (!response.ok) {\r\n          throw new Error(`Server error: ${response.status}`);\r\n        }\r\n        \r\n        const data = await response.json();\r\n        \r\n        if (data.success && data.data && Array.isArray(data.data)) {\r\n          // ✅ GHTK returns array of strings (address names)\r\n          // Use index to ensure unique IDs even if names are duplicated\r\n          let addresses = data.data.map((name: string, index: number) => ({\r\n            id: `${name}-${index}`, // ✅ Combine name + index for unique ID\r\n            name: name\r\n          }));\r\n          \r\n          // Move \"Khác\" to the top if it exists\r\n          const khacIndex = addresses.findIndex((addr: GHTKSpecificAddress) => addr.name === 'Khác');\r\n          if (khacIndex > 0) {\r\n            const khac = addresses[khacIndex];\r\n            addresses = [khac, ...addresses.slice(0, khacIndex), ...addresses.slice(khacIndex + 1)];\r\n          }\r\n          \r\n          // ✅ Save to cache\r\n          const cacheKey = getSpecificAddressCacheKey(province, district, ward);\r\n          specificAddressCache.set(cacheKey, {\r\n            data: addresses,\r\n            timestamp: Date.now()\r\n          });\r\n          \r\n          setSpecificAddresses(addresses);\r\n          \r\n          // ✅ Auto-select \"Khác\" if it exists and no address selected yet\r\n          if (addresses.length > 0 && !options.specificAddress) {\r\n            const khac = addresses.find((addr: GHTKSpecificAddress) => addr.name === 'Khác');\r\n            if (khac) {\r\n              handleInputChange('specificAddress', khac.name); // ✅ Use NAME for GHTK API\r\n            }\r\n          }\r\n        } else {\r\n          throw new Error(data.message || 'Không thể lấy danh sách địa chỉ chi tiết');\r\n        }\r\n      } catch (fetchError) {\r\n        if (fetchError instanceof Error && fetchError.name === 'AbortError') {\r\n          throw new Error('Server không phản hồi (timeout)');\r\n        }\r\n        throw new Error('Không thể kết nối server API');\r\n      }\r\n    } catch (error) {\r\n      console.error('❌ [ServiceConfigForm] Error loading specific addresses:', error);\r\n      setSpecificAddressError(error instanceof Error ? error.message : 'Không thể tải địa chỉ');\r\n      setSpecificAddresses([]);\r\n    } finally {\r\n      setLoadingSpecificAddresses(false);\r\n    }\r\n  }, [customerAddress, normalizeGHTKAddress]);\r\n\r\n  // ✅ Store latest onConfigChange callback in ref to avoid infinite loop\r\n  const onConfigChangeRef = React.useRef(onConfigChange);\r\n  React.useEffect(() => {\r\n    onConfigChangeRef.current = onConfigChange;\r\n  }, [onConfigChange]);\r\n\r\n  // ✅ FIX: Notify parent only when specific option values change, not object reference\r\n  // Create stable key based on actual primitive values (no array/object references)\r\n  const optionsKey = React.useMemo(() => {\r\n    return JSON.stringify({\r\n      pickAddressId: options.pickAddressId,\r\n      useReturnAddress: options.useReturnAddress,\r\n      deliverWorkShift: options.deliverWorkShift,\r\n      transport: options.transport,\r\n      pickDate: options.pickDate,\r\n      deliverDate: options.deliverDate,\r\n      orderValue: options.orderValue,\r\n      pickWorkShift: options.pickWorkShift,\r\n      payer: options.payer,\r\n      specificAddress: options.specificAddress, // ✅ Track specific address (hamlet)\r\n      ghtkTags: options.ghtkTags, // ✅ Track tags changes\r\n      failedDeliveryFee: options.failedDeliveryFee // ✅ Track failed delivery fee (tag 19)\r\n    });\r\n  }, [\r\n    options.pickAddressId,\r\n    options.useReturnAddress,\r\n    options.deliverWorkShift,\r\n    options.transport,\r\n    options.pickDate,\r\n    options.deliverDate,\r\n    options.orderValue,\r\n    options.pickWorkShift,\r\n    options.payer,\r\n    options.specificAddress, // ✅ Track specific address\r\n    options.ghtkTags, // ✅ Track tags changes\r\n    options.failedDeliveryFee // ✅ Track failed delivery fee\r\n  ]);\r\n\r\n  // Only notify parent when optionsKey changes (i.e., when actual values change)\r\n  React.useEffect(() => {\r\n    // ✅ Use queueMicrotask to ensure this runs AFTER render phase completes\r\n    // Use ref to avoid adding onConfigChange to dependencies (would cause infinite loop)\r\n    queueMicrotask(() => {\r\n      onConfigChangeRef.current(options);\r\n    });\r\n  }, [optionsKey, options]);\r\n\r\n  // ✅ Load specific addresses when customerAddress is available (NOT dependent on pickAddressId)\r\n  React.useEffect(() => {\r\n    if (service.partnerCode === 'GHTK' && customerAddress?.province && customerAddress?.district) {\r\n      loadSpecificAddresses('customer-address');\r\n    } else if (service.partnerCode === 'GHTK' && customerAddress?.province && !customerAddress?.district) {\r\n      loadSpecificAddresses('customer-address');\r\n    } else {\r\n      setSpecificAddresses([]);\r\n    }\r\n  }, [service.partnerCode, customerAddress, loadSpecificAddresses]);\r\n\r\n  const handleInputChange = (key: string, value: any) => {\r\n    setOptions(prev => {\r\n      const newOptions = { ...prev, [key]: value };\r\n      // ⚠️ Don't call onConfigChange here - let useEffect handle it to avoid double updates\r\n      return newOptions;\r\n    });\r\n  };\r\n\r\n  // ✅ Handler for saving return address from AddressFormDialog\r\n  const handleSaveReturnAddress = (address: Omit<CustomerAddress, 'id'>) => {\r\n    \r\n    // Map CustomerAddress to return address fields - batch update\r\n    const returnAddressFields = {\r\n      returnName: address.contactName,\r\n      returnTel: address.contactPhone,\r\n      returnProvince: address.province,\r\n      returnProvinceId: Number(address.provinceId),\r\n      returnDistrict: address.district,\r\n      returnDistrictId: address.districtId,\r\n      returnWard: address.ward,\r\n      returnWardId: address.wardId,\r\n      returnAddress: address.street,\r\n      returnStreet: address.street, // Same as returnAddress\r\n      returnEmail: '', // AddressFormDialog doesn't have email field\r\n    };\r\n    \r\n    // ✅ Batch update all fields at once\r\n    setOptions(prev => {\r\n      const newOptions = { ...prev, ...returnAddressFields };\r\n      // ⚠️ Don't call onConfigChange here - let useEffect handle it\r\n      return newOptions;\r\n    });\r\n    \r\n    toast.success('✅ Đã lưu địa chỉ trả hàng');\r\n    setOpenReturnAddressDialog(false);\r\n  };\r\n\r\n  // Render GHTK form\r\n  if (service.partnerCode === 'GHTK') {\r\n    return (\r\n      <React.Fragment>\r\n        <div className=\"space-y-4\">\r\n          <h3 className=\"font-semibold text-lg border-b pb-2\">Cấu hình vận chuyển</h3>\r\n\r\n        {/* Row 1: 2 columns */}\r\n        <div className=\"grid grid-cols-2 gap-4\">\r\n          {/* Gói dịch vụ - Dropdown list */}\r\n          <div className=\"space-y-2\">\r\n            <Label>Gói dịch vụ</Label>\r\n            <Select\r\n              value={service.serviceId}\r\n              onValueChange={(value) => {\r\n                // Allow changing service package if needed\r\n              }}\r\n            >\r\n              <SelectTrigger>\r\n                <SelectValue placeholder={service.serviceName} />\r\n              </SelectTrigger>\r\n              <SelectContent>\r\n                <SelectItem value={service.serviceId}>{service.serviceName}</SelectItem>\r\n                {/* Add more service options if available */}\r\n              </SelectContent>\r\n            </Select>\r\n          </div>\r\n\r\n          {/* Kho lấy hàng - Combobox searchable */}\r\n          <div className=\"space-y-2\">\r\n            <Label>\r\n              Kho lấy hàng {loadingAddresses && <Loader2 className=\"inline h-3 w-3 ml-2 animate-spin\" />}\r\n            </Label>\r\n            \r\n            {/* Show error if any */}\r\n            {addressError && (\r\n              <div className=\"text-xs text-red-600 mb-1\">\r\n                ⚠️ {addressError}\r\n              </div>\r\n            )}\r\n            \r\n            <Popover open={openPickAddress} onOpenChange={setOpenPickAddress}>\r\n              <PopoverTrigger asChild>\r\n                <Button\r\n                  variant=\"outline\"\r\n                  role=\"combobox\"\r\n                  aria-expanded={openPickAddress}\r\n                  className=\"w-full justify-between\"\r\n                  disabled={loadingAddresses || pickAddresses.length === 0}\r\n                >\r\n                  {loadingAddresses ? (\r\n                    <>\r\n                      <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\r\n                      Đang tải...\r\n                    </>\r\n                  ) : pickAddresses.length === 0 ? (\r\n                    addressError ? \"Lỗi tải kho\" : \"Chưa có kho hàng\"\r\n                  ) : options.pickAddressId ? (\r\n                    pickAddresses.find((addr) => addr.id === options.pickAddressId)?.name\r\n                  ) : (\r\n                    \"Chọn kho lấy hàng\"\r\n                  )}\r\n                  <ChevronsUpDown className=\"ml-2 h-4 w-4 shrink-0 opacity-50\" />\r\n                </Button>\r\n              </PopoverTrigger>\r\n              <PopoverContent className=\"w-[400px] p-0\">\r\n                <Command>\r\n                  <CommandInput placeholder=\"Tìm kho...\" />\r\n                  <CommandEmpty>\r\n                    {pickAddresses.length === 0 \r\n                      ? \"Chưa có kho hàng nào. Vui lòng thêm địa chỉ lấy hàng trong cấu hình GHTK.\"\r\n                      : \"Không tìm thấy kho nào.\"\r\n                    }\r\n                  </CommandEmpty>\r\n                  <CommandGroup>\r\n                    {pickAddresses.map((addr) => (\r\n                      <CommandItem\r\n                        key={addr.id}\r\n                        value={addr.id}\r\n                        onSelect={(currentValue) => {\r\n                          handleInputChange('pickAddressId', currentValue);\r\n                          setOpenPickAddress(false);\r\n                        }}\r\n                      >\r\n                        <Check\r\n                          className={cn(\r\n                            \"mr-2 h-4 w-4\",\r\n                            options.pickAddressId === addr.id ? \"opacity-100\" : \"opacity-0\"\r\n                          )}\r\n                        />\r\n                        <div className=\"flex flex-col\">\r\n                          <span className=\"font-medium\">{addr.name}</span>\r\n                          <span className=\"text-xs text-muted-foreground\">\r\n                            {addr.tel} {addr.tel && addr.address ? '- ' : ''}{addr.address}\r\n                          </span>\r\n                        </div>\r\n                      </CommandItem>\r\n                    ))}\r\n                  </CommandGroup>\r\n                </Command>\r\n              </PopoverContent>\r\n            </Popover>\r\n          </div>\r\n        </div>\r\n\r\n        {/* Row 2: 2 columns - Địa chỉ trả hàng + Địa chỉ chi tiết */}\r\n        <div className=\"grid grid-cols-2 gap-4\">\r\n          {/* Địa chỉ trả hàng (left) - Click to edit */}\r\n          <div className=\"space-y-2\">\r\n            <Label>Địa chỉ trả hàng</Label>\r\n            <Popover open={openReturnAddressPicker} onOpenChange={setOpenReturnAddressPicker}>\r\n              <PopoverTrigger asChild>\r\n                <Button\r\n                  variant=\"outline\"\r\n                  role=\"combobox\"\r\n                  className=\"w-full justify-between font-normal\"\r\n                >\r\n                  {options.useReturnAddress === 1 && options.returnName ? (\r\n                    <span className=\"truncate\">\r\n                      {options.returnName} - {options.returnTel}\r\n                    </span>\r\n                  ) : (\r\n                    <span className=\"text-muted-foreground\">Địa chỉ lấy hàng</span>\r\n                  )}\r\n                  <ChevronsUpDown className=\"ml-2 h-4 w-4 shrink-0 opacity-50\" />\r\n                </Button>\r\n              </PopoverTrigger>\r\n              <PopoverContent className=\"w-[400px] p-0\" align=\"start\">\r\n                <Command>\r\n                  <CommandGroup>\r\n                    <CommandItem\r\n                      value=\"same\"\r\n                      onSelect={() => {\r\n                        handleInputChange('useReturnAddress', 0);\r\n                        // Clear return address data\r\n                        handleInputChange('returnName', '');\r\n                        handleInputChange('returnTel', '');\r\n                        handleInputChange('returnProvince', '');\r\n                        handleInputChange('returnProvinceId', undefined);\r\n                        handleInputChange('returnDistrict', '');\r\n                        handleInputChange('returnDistrictId', undefined);\r\n                        handleInputChange('returnWard', '');\r\n                        handleInputChange('returnWardId', '');\r\n                        handleInputChange('returnAddress', '');\r\n                        setOpenReturnAddressPicker(false);\r\n                      }}\r\n                    >\r\n                      <Check\r\n                        className={cn(\r\n                          \"mr-2 h-4 w-4\",\r\n                          options.useReturnAddress === 0 ? \"opacity-100\" : \"opacity-0\"\r\n                        )}\r\n                      />\r\n                      Địa chỉ lấy hàng\r\n                    </CommandItem>\r\n                    \r\n                    <CommandItem\r\n                      value=\"different\"\r\n                      onSelect={() => {\r\n                        setOpenReturnAddressPicker(false);\r\n                        // Prepare data for editing (if exists)\r\n                        if (options.returnName) {\r\n                          const editData: CustomerAddress = {\r\n                            id: 'temp-return-address',\r\n                            label: 'Địa chỉ trả hàng',\r\n                            street: options.returnAddress || '',\r\n                            province: options.returnProvince || '',\r\n                            provinceId: String(options.returnProvinceId || 0),\r\n                            district: options.returnDistrict || '',\r\n                            districtId: options.returnDistrictId || 0,\r\n                            ward: options.returnWard || '',\r\n                            wardId: options.returnWardId || '',\r\n                            contactName: options.returnName || '',\r\n                            contactPhone: options.returnTel || '',\r\n                            notes: '',\r\n                            isDefaultShipping: false,\r\n                            isDefaultBilling: false,\r\n                            inputLevel: options.returnWardId ? '3-level' : '2-level',\r\n                            autoFilled: false,\r\n                            createdAt: new Date().toISOString(),\r\n                            updatedAt: new Date().toISOString(),\r\n                          };\r\n                          setReturnAddressData(editData);\r\n                        } else {\r\n                          setReturnAddressData(null);\r\n                          handleInputChange('useReturnAddress', 1);\r\n                        }\r\n                        setOpenReturnAddressDialog(true);\r\n                      }}\r\n                    >\r\n                      {options.returnName ? (\r\n                        <>\r\n                          <Check\r\n                            className={cn(\r\n                              \"mr-2 h-4 w-4 shrink-0\",\r\n                              options.useReturnAddress === 1 ? \"opacity-100\" : \"opacity-0\"\r\n                            )}\r\n                          />\r\n                          <div className=\"flex items-center justify-between flex-1 gap-2\">\r\n                            <span className=\"text-sm flex-1\">\r\n                              {options.returnAddress}, {options.returnWard && `${options.returnWard}, `}{options.returnDistrict}, {options.returnProvince}\r\n                            </span>\r\n                            <Pencil className=\"h-4 w-4 shrink-0 text-muted-foreground\" />\r\n                          </div>\r\n                        </>\r\n                      ) : (\r\n                        <>\r\n                          <Check\r\n                            className={cn(\r\n                              \"mr-2 h-4 w-4\",\r\n                              options.useReturnAddress === 1 ? \"opacity-100\" : \"opacity-0\"\r\n                            )}\r\n                          />\r\n                          Địa chỉ khác\r\n                        </>\r\n                      )}\r\n                    </CommandItem>\r\n                  </CommandGroup>\r\n                </Command>\r\n              </PopoverContent>\r\n            </Popover>\r\n          </div>\r\n\r\n          {/* Địa chỉ chi tiết - Combobox searchable (right) */}\r\n          <div className=\"space-y-2\">\r\n            <Label>\r\n              Địa chỉ chi tiết {loadingSpecificAddresses && <Loader2 className=\"inline h-3 w-3 ml-2 animate-spin\" />}\r\n            </Label>\r\n              \r\n              {/* Show error if any */}\r\n              {specificAddressError && (\r\n                <div className=\"text-xs text-red-600 mb-1\">\r\n                  ⚠️ {specificAddressError}\r\n                </div>\r\n              )}\r\n              \r\n              <Popover open={openSpecificAddress} onOpenChange={setOpenSpecificAddress}>\r\n                <PopoverTrigger asChild>\r\n                  <Button\r\n                    variant=\"outline\"\r\n                    role=\"combobox\"\r\n                    aria-expanded={openSpecificAddress}\r\n                    className=\"w-full justify-between\"\r\n                    disabled={loadingSpecificAddresses || !customerAddress || specificAddresses.length === 0}\r\n                  >\r\n                    {loadingSpecificAddresses ? (\r\n                      <>\r\n                      <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\r\n                      Đang tải...\r\n                    </>\r\n                  ) : !customerAddress ? (\r\n                    \"Chọn địa chỉ khách trước\"\r\n                  ) : specificAddresses.length === 0 ? (\r\n                    specificAddressError ? \"Lỗi tải địa chỉ\" : \"Chưa có địa chỉ\"\r\n                  ) : options.specificAddress ? (\r\n                    specificAddresses.find((addr) => addr.id === options.specificAddress)?.name || \"Chọn địa chỉ\"\r\n                  ) : (\r\n                    \"Chọn địa chỉ chi tiết\"\r\n                  )}\r\n                  <ChevronsUpDown className=\"ml-2 h-4 w-4 shrink-0 opacity-50\" />\r\n                </Button>\r\n              </PopoverTrigger>\r\n              <PopoverContent className=\"w-[400px] p-0\">\r\n                <Command>\r\n                  <CommandInput placeholder=\"Tìm địa chỉ...\" />\r\n                  <CommandEmpty>\r\n                    {specificAddresses.length === 0 \r\n                      ? \"Chưa có địa chỉ nào.\"\r\n                      : \"Không tìm thấy địa chỉ nào.\"\r\n                    }\r\n                  </CommandEmpty>\r\n                  <CommandGroup className=\"max-h-[200px] overflow-auto\">\r\n                    {specificAddresses.map((addr) => (\r\n                      <CommandItem\r\n                        key={addr.id}\r\n                        value={addr.name}\r\n                        onSelect={(currentValue) => {\r\n                          // ✅ Save ONLY the name to options, not the ID\r\n                          handleInputChange('specificAddress', currentValue);\r\n                          setOpenSpecificAddress(false);\r\n                        }}\r\n                      >\r\n                        <Check\r\n                          className={cn(\r\n                            \"mr-2 h-4 w-4\",\r\n                            options.specificAddress === addr.name ? \"opacity-100\" : \"opacity-0\"\r\n                          )}\r\n                        />\r\n                        <span className=\"text-sm\">{addr.name}</span>\r\n                      </CommandItem>\r\n                    ))}\r\n                  </CommandGroup>\r\n                </Command>\r\n              </PopoverContent>\r\n            </Popover>\r\n          </div>\r\n        </div> {/* ✅ Close grid-cols-2 row */}\r\n\r\n        {/* Row 3: 2 dates - Click once to select */}\r\n        <div className=\"grid grid-cols-2 gap-4\">\r\n          {/* Hẹn ngày lấy hàng */}\r\n          <div className=\"space-y-2\">\r\n            <Label>Hẹn ngày lấy hàng</Label>\r\n            <Popover open={openPickDate} onOpenChange={setOpenPickDate}>\r\n              <PopoverTrigger asChild>\r\n                <Button\r\n                  variant=\"outline\"\r\n                  className={cn(\r\n                    \"w-full justify-start text-left font-normal\",\r\n                    !pickDate && \"text-muted-foreground\"\r\n                  )}\r\n                >\r\n                  <CalendarIcon className=\"mr-2 h-4 w-4\" />\r\n                  {pickDate ? format(pickDate, \"dd/MM/yyyy\", { locale: vi }) : \"Chọn ngày\"}\r\n                </Button>\r\n              </PopoverTrigger>\r\n              <PopoverContent className=\"w-auto p-0\">\r\n                <Calendar\r\n                  mode=\"single\"\r\n                  selected={pickDate}\r\n                  onSelect={(date) => {\r\n                    if (date) {\r\n                      setPickDate(date);\r\n                      handleInputChange('pickDate', format(date, 'yyyy-MM-dd'));\r\n                      setOpenPickDate(false);\r\n                    }\r\n                  }}\r\n                  disabled={(date) => date < new Date(new Date().setHours(0, 0, 0, 0))}\r\n                />\r\n              </PopoverContent>\r\n            </Popover>\r\n            {pickDate && pickDate < new Date(new Date().setHours(0, 0, 0, 0)) && (\r\n              <p className=\"text-xs text-red-600\">⚠️ Ngày lấy hàng phải từ hôm nay trở đi</p>\r\n            )}\r\n          </div>\r\n\r\n          {/* Hẹn ngày giao hàng */}\r\n          <div className=\"space-y-2\">\r\n            <Label>Hẹn ngày giao hàng</Label>\r\n            <Popover open={openDeliverDate} onOpenChange={setOpenDeliverDate}>\r\n              <PopoverTrigger asChild>\r\n                <Button\r\n                  variant=\"outline\"\r\n                  className={cn(\r\n                    \"w-full justify-start text-left font-normal\",\r\n                    !deliverDate && \"text-muted-foreground\"\r\n                  )}\r\n                >\r\n                  <CalendarIcon className=\"mr-2 h-4 w-4\" />\r\n                  {deliverDate ? format(deliverDate, \"dd/MM/yyyy\", { locale: vi }) : \"Chọn ngày\"}\r\n                </Button>\r\n              </PopoverTrigger>\r\n              <PopoverContent className=\"w-auto p-0\">\r\n                <Calendar\r\n                  mode=\"single\"\r\n                  selected={deliverDate}\r\n                  onSelect={(date) => {\r\n                    setDeliverDate(date);\r\n                    if (date) {\r\n                      handleInputChange('deliverDate', format(date, 'yyyy-MM-dd'));\r\n                      setOpenDeliverDate(false);\r\n                    }\r\n                  }}\r\n                  disabled={(date) => {\r\n                    const today = new Date(new Date().setHours(0, 0, 0, 0));\r\n                    if (date < today) return true;\r\n                    if (pickDate && date < pickDate) return true;\r\n                    return false;\r\n                  }}\r\n                />\r\n              </PopoverContent>\r\n            </Popover>\r\n            {deliverDate && pickDate && deliverDate < pickDate && (\r\n              <p className=\"text-xs text-red-600\">⚠️ Ngày giao hàng phải sau hoặc bằng ngày lấy hàng</p>\r\n            )}\r\n          </div>\r\n        </div>\r\n\r\n        {/* Row 7: 2 columns - Hẹn ca lấy hàng + Hẹn ca giao hàng */}\r\n        <div className=\"grid grid-cols-2 gap-4\">\r\n          {/* Hẹn ca lấy hàng */}\r\n          <div className=\"space-y-2\">\r\n            <Label>Hẹn ca lấy hàng</Label>\r\n            <Select\r\n              value={options.pickWorkShift?.toString() || 'none'}\r\n              onValueChange={(value) => handleInputChange('pickWorkShift', value === 'none' ? undefined : parseInt(value))}\r\n            >\r\n              <SelectTrigger>\r\n                <SelectValue placeholder=\"Chọn ca lấy hàng\" />\r\n              </SelectTrigger>\r\n              <SelectContent>\r\n                <SelectItem value=\"none\">Tự động</SelectItem>\r\n                <SelectItem value=\"1\">Buổi sáng (8h-12h)</SelectItem>\r\n                <SelectItem value=\"2\">Buổi chiều (14h-18h)</SelectItem>\r\n              </SelectContent>\r\n            </Select>\r\n            {options.pickWorkShift && options.pickWorkShift !== 1 && options.pickWorkShift !== 2 && (\r\n              <p className=\"text-xs text-red-600\">⚠️ Ca lấy hàng phải là 1 (sáng) hoặc 2 (chiều)</p>\r\n            )}\r\n          </div>\r\n\r\n          {/* Hẹn ca giao hàng */}\r\n          <div className=\"space-y-2\">\r\n            <Label>Hẹn ca giao hàng</Label>\r\n            <Select\r\n              value={options.deliverWorkShift?.toString() || 'none'}\r\n              onValueChange={(value) => handleInputChange('deliverWorkShift', value === 'none' ? undefined : parseInt(value))}\r\n            >\r\n              <SelectTrigger>\r\n                <SelectValue placeholder=\"Chọn ca giao hàng\" />\r\n              </SelectTrigger>\r\n              <SelectContent>\r\n                <SelectItem value=\"none\">Tự động</SelectItem>\r\n                <SelectItem value=\"1\">Buổi sáng (8h-12h)</SelectItem>\r\n                <SelectItem value=\"2\">Buổi chiều (14h-18h)</SelectItem>\r\n              </SelectContent>\r\n            </Select>\r\n            {options.deliverWorkShift && options.deliverWorkShift !== 1 && options.deliverWorkShift !== 2 && (\r\n              <p className=\"text-xs text-red-600\">⚠️ Ca giao hàng phải là 1 (sáng) hoặc 2 (chiều)</p>\r\n            )}\r\n          </div>\r\n        </div>\r\n\r\n        {/* Row 8: Người trả phí + Lấy hàng tại */}\r\n        <div className=\"grid grid-cols-2 gap-4\">\r\n          {/* Người trả phí (left) */}\r\n          <div className=\"space-y-2\">\r\n            <Label>Người trả phí</Label>\r\n            <RadioGroup\r\n              value={options.payer || 'CUSTOMER'}\r\n              onValueChange={(value) => handleInputChange('payer', value)}\r\n              className=\"flex gap-6\"\r\n            >\r\n              <div className=\"flex items-center space-x-2\">\r\n                <RadioGroupItem value=\"SHOP\" id=\"payer-shop\" />\r\n                <Label htmlFor=\"payer-shop\" className=\"font-normal cursor-pointer\">Shop trả</Label>\r\n              </div>\r\n              <div className=\"flex items-center space-x-2\">\r\n                <RadioGroupItem value=\"CUSTOMER\" id=\"payer-customer\" />\r\n                <Label htmlFor=\"payer-customer\" className=\"font-normal cursor-pointer\">Khách trả</Label>\r\n              </div>\r\n            </RadioGroup>\r\n          </div>\r\n\r\n          {/* Lấy hàng tại (right) */}\r\n          <div className=\"space-y-2\">\r\n            <Label>Lấy hàng tại</Label>\r\n            <RadioGroup\r\n              value={options.pickOption || 'cod'}\r\n              onValueChange={(value) => handleInputChange('pickOption', value)}\r\n              className=\"flex gap-6\"\r\n            >\r\n              <div className=\"flex items-center space-x-2\">\r\n                <RadioGroupItem value=\"cod\" id=\"pick-cod\" />\r\n                <Label htmlFor=\"pick-cod\" className=\"font-normal cursor-pointer\">COD đến lấy</Label>\r\n              </div>\r\n              <div className=\"flex items-center space-x-2\">\r\n                <RadioGroupItem value=\"post\" id=\"pick-post\" />\r\n                <Label htmlFor=\"pick-post\" className=\"font-normal cursor-pointer\">Gửi bưu cục</Label>\r\n              </div>\r\n            </RadioGroup>\r\n          </div>\r\n        </div>\r\n\r\n        {/* Row 9: Vận chuyển đường + Giá trị hàng hoá */}\r\n        <div className=\"grid grid-cols-2 gap-4\">\r\n          {/* Vận chuyển đường (left) */}\r\n          <div className=\"space-y-2\">\r\n            <Label>Vận chuyển</Label>\r\n            <RadioGroup\r\n              value={options.transport || 'fly'}\r\n              onValueChange={(value) => handleInputChange('transport', value)}\r\n              className=\"flex gap-6\"\r\n            >\r\n              <div className=\"flex items-center space-x-2\">\r\n                <RadioGroupItem value=\"road\" id=\"road\" />\r\n                <Label htmlFor=\"road\" className=\"font-normal cursor-pointer\">Đường bộ</Label>\r\n              </div>\r\n              <div className=\"flex items-center space-x-2\">\r\n                <RadioGroupItem value=\"fly\" id=\"fly\" />\r\n                <Label htmlFor=\"fly\" className=\"font-normal cursor-pointer\">Đường bay</Label>\r\n              </div>\r\n            </RadioGroup>\r\n          </div>\r\n\r\n          {/* Giá trị hàng hoá (right) */}\r\n          <div className=\"space-y-2\">\r\n            <Label>Giá trị hàng hoá</Label>\r\n            <CurrencyInput \r\n              value={options.orderValue || 0} \r\n              onChange={(value) => {\r\n                if (value > 20000000) {\r\n                  toast.warning('⚠️ GHTK Express giới hạn 20 triệu', {\r\n                    description: 'Giá trị hàng hoá tối đa 20.000.000đ cho gói Express'\r\n                  });\r\n                }\r\n                handleInputChange('orderValue', value);\r\n              }}\r\n              placeholder=\"Tổng giá trị đơn hàng\"\r\n            />\r\n            {options.orderValue && options.orderValue > 20000000 && (\r\n              <p className=\"text-xs text-red-600\">\r\n                ❌ GHTK Express chỉ hỗ trợ giá trị hàng hoá tối đa 20.000.000đ\r\n              </p>\r\n            )}\r\n            {options.orderValue && options.orderValue < 1 && (\r\n              <p className=\"text-xs text-red-600\">\r\n                ❌ Giá trị hàng hoá phải lớn hơn 0đ\r\n              </p>\r\n            )}\r\n          </div>\r\n        </div>\r\n\r\n        {/* ✅ GHTK Tags - Dịch vụ cộng thêm (chỉ dùng khi tạo đơn, không ảnh hưởng tính phí) */}\r\n        <div className=\"space-y-3\">\r\n          <Label className=\"text-base font-semibold\">Dịch vụ cộng thêm</Label>\r\n          <div className=\"grid grid-cols-2 gap-3\">\r\n            {/* Tag 1: Hàng dễ vỡ - DISABLED: Not supported in GHTK Express */}\r\n            {/* <div className=\"flex items-center space-x-2\">\r\n              <Checkbox \r\n                id=\"tag-1\"\r\n                checked={options.ghtkTags?.includes(1)}\r\n                onCheckedChange={(checked) => {\r\n                  const currentTags = options.ghtkTags || [];\r\n                  const newTags = checked \r\n                    ? [...currentTags, 1]\r\n                    : currentTags.filter(t => t !== 1);\r\n                  handleInputChange('ghtkTags', newTags);\r\n                }}\r\n              />\r\n              <Label htmlFor=\"tag-1\" className=\"text-sm font-normal cursor-pointer\">\r\n                Hàng dễ vỡ\r\n              </Label>\r\n            </div> */}\r\n\r\n            {/* Tag 6: Nông sản/thực phẩm khô - DISABLED: Not supported in GHTK Express */}\r\n            {/* <div className=\"flex items-center space-x-2\">\r\n              <Checkbox \r\n                id=\"tag-6\"\r\n                checked={options.ghtkTags?.includes(6)}\r\n                onCheckedChange={(checked) => {\r\n                  const currentTags = options.ghtkTags || [];\r\n                  const newTags = checked \r\n                    ? [...currentTags, 6]\r\n                    : currentTags.filter(t => t !== 6);\r\n                  handleInputChange('ghtkTags', newTags);\r\n                }}\r\n              />\r\n              <Label htmlFor=\"tag-6\" className=\"text-sm font-normal cursor-pointer\">\r\n                Nông sản/thực phẩm khô\r\n              </Label>\r\n            </div> */}\r\n\r\n            {/* Tag 7: Đóng kiểm - DISABLED: Causes \"Thực phẩm\" error in Express */}\r\n            {/* <div className=\"flex items-center space-x-2\">\r\n              <Checkbox \r\n                id=\"tag-7\"\r\n                checked={options.ghtkTags?.includes(7)}\r\n                onCheckedChange={(checked) => {\r\n                  const currentTags = options.ghtkTags || [];\r\n                  const newTags = checked \r\n                    ? [...currentTags, 7]\r\n                    : currentTags.filter(t => t !== 7);\r\n                  handleInputChange('ghtkTags', newTags);\r\n                }}\r\n              />\r\n              <Label htmlFor=\"tag-7\" className=\"text-sm font-normal cursor-pointer\">\r\n                Đóng kiểm\r\n              </Label>\r\n            </div> */}\r\n\r\n            {/* Tag 8: Hàng không xếp chồng - DISABLED: May cause \"Thực phẩm\" error */}\r\n            {/* <div className=\"flex items-center space-x-2\">\r\n              <Checkbox \r\n                id=\"tag-8\"\r\n                checked={options.ghtkTags?.includes(8)}\r\n                onCheckedChange={(checked) => {\r\n                  const currentTags = options.ghtkTags || [];\r\n                  const newTags = checked \r\n                    ? [...currentTags, 8]\r\n                    : currentTags.filter(t => t !== 8);\r\n                  handleInputChange('ghtkTags', newTags);\r\n                }}\r\n              />\r\n              <Label htmlFor=\"tag-8\" className=\"text-sm font-normal cursor-pointer\">\r\n                Hàng không xếp chồng\r\n              </Label>\r\n            </div> */}\r\n\r\n            {/* Tag 10: Cho xem hàng */}\r\n            <div className=\"flex items-center space-x-2\">\r\n              <Checkbox \r\n                id=\"tag-10\"\r\n                checked={options.ghtkTags?.includes(10)}\r\n                onCheckedChange={(checked) => {\r\n                  const currentTags = options.ghtkTags || [];\r\n                  const newTags = checked \r\n                    ? [...currentTags, 10]\r\n                    : currentTags.filter(t => t !== 10);\r\n                  handleInputChange('ghtkTags', newTags);\r\n                }}\r\n              />\r\n              <Label htmlFor=\"tag-10\" className=\"text-sm font-normal cursor-pointer\">\r\n                Cho xem hàng\r\n              </Label>\r\n            </div>\r\n\r\n            {/* Tag 13: Gọi shop khi gặp vấn đề - DISABLED: Not supported in GHTK Express */}\r\n            {/* <div className=\"flex items-center space-x-2\">\r\n              <Checkbox \r\n                id=\"tag-13\"\r\n                checked={options.ghtkTags?.includes(13)}\r\n                onCheckedChange={(checked) => {\r\n                  const currentTags = options.ghtkTags || [];\r\n                  const newTags = checked \r\n                    ? [...currentTags, 13]\r\n                    : currentTags.filter(t => t !== 13);\r\n                  handleInputChange('ghtkTags', newTags);\r\n                }}\r\n              />\r\n              <Label htmlFor=\"tag-13\" className=\"text-sm font-normal cursor-pointer\">\r\n                Gọi shop khi gặp vấn đề\r\n              </Label>\r\n            </div> */}\r\n\r\n            {/* Tag 17: Giao 1 phần chọn sản phẩm */}\r\n            <div className=\"flex items-center space-x-2\">\r\n              <Checkbox \r\n                id=\"tag-17\"\r\n                checked={options.ghtkTags?.includes(17)}\r\n                onCheckedChange={(checked) => {\r\n                  const currentTags = options.ghtkTags || [];\r\n                  const newTags = checked \r\n                    ? [...currentTags, 17]\r\n                    : currentTags.filter(t => t !== 17);\r\n                  handleInputChange('ghtkTags', newTags);\r\n                }}\r\n              />\r\n              <Label htmlFor=\"tag-17\" className=\"text-sm font-normal cursor-pointer\">\r\n                Giao 1 phần chọn sản phẩm\r\n              </Label>\r\n            </div>\r\n\r\n            {/* Tag 18: Giao 1 phần đổi trả hàng */}\r\n            <div className=\"flex items-center space-x-2\">\r\n              <Checkbox \r\n                id=\"tag-18\"\r\n                checked={options.ghtkTags?.includes(18)}\r\n                onCheckedChange={(checked) => {\r\n                  const currentTags = options.ghtkTags || [];\r\n                  const newTags = checked \r\n                    ? [...currentTags, 18]\r\n                    : currentTags.filter(t => t !== 18);\r\n                  handleInputChange('ghtkTags', newTags);\r\n                }}\r\n              />\r\n              <Label htmlFor=\"tag-18\" className=\"text-sm font-normal cursor-pointer\">\r\n                Giao 1 phần đổi trả hàng\r\n              </Label>\r\n            </div>\r\n\r\n            {/* Tag 19: Không giao được thu phí */}\r\n            <div className=\"flex items-center space-x-2\">\r\n              <Checkbox \r\n                id=\"tag-19\"\r\n                checked={options.ghtkTags?.includes(19)}\r\n                onCheckedChange={(checked) => {\r\n                  const currentTags = options.ghtkTags || [];\r\n                  const newTags = checked \r\n                    ? [...currentTags, 19]\r\n                    : currentTags.filter(t => t !== 19);\r\n                  handleInputChange('ghtkTags', newTags);\r\n                  \r\n                  // ✅ Auto-fill failedDeliveryFee when checking tag 19\r\n                  if (checked) {\r\n                    // Default = Phí ship + 50% (theo GHTK docs: phí ship + 50% phí ship cho hàng trả)\r\n                    const shippingFee = service.fee || 0;\r\n                    const defaultFee = Math.round(shippingFee * 1.5); // Phí ship + 50%\r\n                    \r\n                    // Clamp to GHTK limits: 10k - 20tr\r\n                    const clampedFee = Math.max(10000, Math.min(20000000, defaultFee));\r\n                    \r\n                    console.log('💰 [Tag 19] Auto-fill failed delivery fee:', {\r\n                      shippingFee,\r\n                      defaultFee,\r\n                      clampedFee,\r\n                      meetsGHTKRequirement: clampedFee >= 10000 && clampedFee <= 20000000\r\n                    });\r\n                    \r\n                    // ⚠️ Warn if fee is at minimum\r\n                    if (clampedFee === 10000 && defaultFee < 10000) {\r\n                      console.warn('⚠️ Phí ship quá thấp, đã tự động tăng lên 10.000đ (tối thiểu GHTK)');\r\n                    }\r\n                    \r\n                    handleInputChange('failedDeliveryFee', clampedFee);\r\n                  } else {\r\n                    // Reset when unchecking\r\n                    handleInputChange('failedDeliveryFee', undefined);\r\n                  }\r\n                }}\r\n              />\r\n              <Label htmlFor=\"tag-19\" className=\"text-sm font-normal cursor-pointer\">\r\n                Thu tiền khi không giao được\r\n              </Label>\r\n            </div>\r\n\r\n            {/* Tag 62: Thu hồi chứng từ - DISABLED: Not supported in GHTK Express */}\r\n            {/* <div className=\"flex items-center space-x-2\">\r\n              <Checkbox \r\n                id=\"tag-62\"\r\n                checked={options.ghtkTags?.includes(62)}\r\n                onCheckedChange={(checked) => {\r\n                  const currentTags = options.ghtkTags || [];\r\n                  const newTags = checked \r\n                    ? [...currentTags, 62]\r\n                    : currentTags.filter(t => t !== 62);\r\n                  handleInputChange('ghtkTags', newTags);\r\n                }}\r\n              />\r\n              <Label htmlFor=\"tag-62\" className=\"text-sm font-normal cursor-pointer\">\r\n                Thu hồi chứng từ\r\n              </Label>\r\n            </div> */}\r\n          </div>\r\n        </div>\r\n\r\n        {/* ✅ Input số tiền thu khi không giao được (hiện khi tick tag 19) */}\r\n        {options.ghtkTags?.includes(19) && (\r\n          <div className=\"space-y-2 p-4 border border-amber-200 bg-amber-50 rounded-md\">\r\n            <Label htmlFor=\"failedDeliveryFee\" className=\"text-sm font-semibold text-amber-900\">\r\n              Số tiền thu khi không giao được\r\n            </Label>\r\n            <p className=\"text-xs text-amber-700 mb-2\">\r\n              💡 Mặc định = Phí ship + 50% ({((service.fee || 0) * 1.5).toLocaleString('vi-VN')}đ)<br/>\r\n              ⚠️ GHTK giới hạn: Tối thiểu 10.000đ, tối đa 20.000.000đ<br/>\r\n              📌 Lưu ý: Tài khoản GHTK phải được cấu hình \"Chính sách giao hàng\" để dùng tính năng này\r\n            </p>\r\n            <CurrencyInput \r\n              id=\"failedDeliveryFee\"\r\n              value={options.failedDeliveryFee || 0} \r\n              onChange={(value) => {\r\n                // Validate giới hạn GHTK\r\n                if (value < 10000 || value > 20000000) {\r\n                  console.warn('⚠️ Số tiền phải từ 10.000đ đến 20.000.000đ');\r\n                }\r\n                handleInputChange('failedDeliveryFee', value);\r\n              }}\r\n              placeholder=\"Nhập số tiền...\"\r\n            />\r\n            {options.failedDeliveryFee && (options.failedDeliveryFee < 10000 || options.failedDeliveryFee > 20000000) && (\r\n              <p className=\"text-xs text-red-600\">\r\n                ❌ Số tiền phải từ 10.000đ đến 20.000.000đ\r\n              </p>\r\n            )}\r\n          </div>\r\n        )}\r\n\r\n        {/* Phí trả đối tác vận chuyển */}\r\n        <div className=\"pt-3 border-t\">\r\n          <div className=\"flex justify-between items-center\">\r\n            <Label>Phí trả đối tác vận chuyển</Label>\r\n            <span className=\"font-semibold text-lg\">{service.fee?.toLocaleString('vi-VN') || 0}đ</span>\r\n          </div>\r\n        </div>\r\n        </div>\r\n\r\n        {/* ✅ Reuse AddressFormDialog for return address - Hide default switches */}\r\n        <AddressFormDialog\r\n          isOpen={openReturnAddressDialog}\r\n          onOpenChange={(open) => {\r\n            setOpenReturnAddressDialog(open);\r\n            if (!open) setReturnAddressData(null); // Clear data on close\r\n          }}\r\n          onSave={handleSaveReturnAddress}\r\n          editingAddress={returnAddressData}\r\n          hideDefaultSwitches={true} // ✅ Hide \"Đặt làm mặc định\" switches\r\n          title=\"📦 Địa chỉ trả hàng\" // ✅ Custom title\r\n          description=\"Khi khách không nhận hàng, sẽ trả về địa chỉ này\" // ✅ Custom description\r\n        />\r\n      </React.Fragment>\r\n    );\r\n  }\r\n\r\n  // Render GHN form\r\n  if (service.partnerCode === 'GHN') {\r\n    return (\r\n      <div className=\"space-y-4\">\r\n        <h3 className=\"font-semibold text-lg border-b pb-2\">Cấu hình vận chuyển</h3>\r\n        \r\n        <div className=\"space-y-2\">\r\n          <Label>Gói dịch vụ</Label>\r\n          <Input value={service.serviceName} disabled className=\"bg-muted\" />\r\n        </div>\r\n\r\n        {/* GHN specific fields */}\r\n        <div className=\"space-y-2\">\r\n          <Label>Kho lấy hàng</Label>\r\n          <Select>\r\n            <SelectTrigger>\r\n              <SelectValue placeholder=\"Chọn kho\" />\r\n            </SelectTrigger>\r\n            <SelectContent>\r\n              <SelectItem value=\"kho1\">Kho 1</SelectItem>\r\n            </SelectContent>\r\n          </Select>\r\n        </div>\r\n\r\n        <div className=\"space-y-2\">\r\n          <Label>Hình thức lấy hàng</Label>\r\n          <Select>\r\n            <SelectTrigger>\r\n              <SelectValue placeholder=\"Lấy hàng tại kho hàng\" />\r\n            </SelectTrigger>\r\n            <SelectContent>\r\n              <SelectItem value=\"warehouse\">Lấy hàng tại kho hàng</SelectItem>\r\n            </SelectContent>\r\n          </Select>\r\n        </div>\r\n\r\n        {/* Người trả phí */}\r\n        <div className=\"space-y-2\">\r\n          <Label>Người trả phí</Label>\r\n          <RadioGroup\r\n            value={options.payer || 'SHOP'}\r\n            onValueChange={(value) => handleInputChange('payer', value)}\r\n            className=\"flex gap-4\"\r\n          >\r\n            <div className=\"flex items-center space-x-2\">\r\n              <RadioGroupItem value=\"SHOP\" id=\"ghn-shop\" />\r\n              <Label htmlFor=\"ghn-shop\" className=\"font-normal cursor-pointer\">Shop trả</Label>\r\n            </div>\r\n            <div className=\"flex items-center space-x-2\">\r\n              <RadioGroupItem value=\"CUSTOMER\" id=\"ghn-customer\" />\r\n              <Label htmlFor=\"ghn-customer\" className=\"font-normal cursor-pointer\">Khách trả</Label>\r\n            </div>\r\n          </RadioGroup>\r\n        </div>\r\n\r\n        {/* Checkboxes */}\r\n        <div className=\"space-y-2\">\r\n          <div className=\"grid grid-cols-2 gap-3\">\r\n            <div className=\"flex items-center space-x-2\">\r\n              <Checkbox id=\"ghn-insurance\" />\r\n              <Label htmlFor=\"ghn-insurance\" className=\"text-sm font-normal cursor-pointer\">\r\n                Giao thất bại - thu tiền\r\n              </Label>\r\n            </div>\r\n\r\n            <div className=\"flex items-center space-x-2\">\r\n              <Checkbox id=\"ghn-partial\" />\r\n              <Label htmlFor=\"ghn-partial\" className=\"text-sm font-normal cursor-pointer\">\r\n                Giao hàng 1 phần\r\n              </Label>\r\n            </div>\r\n          </div>\r\n        </div>\r\n\r\n        <div className=\"pt-4 border-t\">\r\n          <div className=\"flex justify-between items-center\">\r\n            <Label>Phí trả đối tác vận chuyển</Label>\r\n            <span className=\"font-semibold text-lg\">{service.fee?.toLocaleString('vi-VN') || 0}đ</span>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  // Default fallback\r\n  return (\r\n    <div className=\"space-y-4\">\r\n      <h3 className=\"font-semibold text-lg\">Cấu hình vận chuyển</h3>\r\n      <p className=\"text-sm text-muted-foreground\">Cấu hình cho {service.partnerName}</p>\r\n    </div>\r\n  );\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 5526, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/orders/components/shipping/delivery-method-card.tsx"],"sourcesContent":["/**\r\n * DeliveryMethodCard\r\n * Card with tabs for different delivery methods\r\n * Matches Sapo's \"Đóng gói và giao hàng\" section\r\n */\r\n\r\nimport * as React from 'react';\r\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';\r\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';\r\nimport { Input } from '@/components/ui/input';\r\nimport { Label } from '@/components/ui/label';\r\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';\r\nimport { Textarea } from '@/components/ui/textarea';\r\nimport { Button } from '@/components/ui/button';\r\nimport { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from '@/components/ui/tooltip';\r\nimport { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle } from '@/components/ui/dialog';\r\nimport { ScrollArea } from '@/components/ui/scroll-area';\r\nimport { Truck, ExternalLink, Store, Clock, Package, Edit2, Info } from 'lucide-react';\r\nimport { ShippingPartnerSelector } from './shipping-partner-selector';\r\nimport { ServiceConfigForm } from './service-config-form';\r\nimport { cn } from '@/lib/utils'; // ✅ Import cn utility\r\nimport type {\r\n  DeliveryMethod,\r\n  ShippingCalculationRequest,\r\n  ShippingService,\r\n  ShippingAddress,\r\n  PackageInfo,\r\n  SelectedShippingConfig,\r\n} from './types';\r\n\r\ninterface DeliveryMethodCardProps {\r\n  selectedMethod: DeliveryMethod;\r\n  onMethodChange: (method: DeliveryMethod) => void;\r\n  \r\n  // For shipping-partner tab\r\n  shippingRequest?: ShippingCalculationRequest | null | undefined;\r\n  customerAddress?: ShippingAddress | null | undefined;\r\n  packageInfo?: PackageInfo | undefined;\r\n  selectedService?: ShippingService | null | undefined;\r\n  onServiceSelect?: ((service: ShippingService | null) => void) | undefined;\r\n  onPackageInfoChange?: ((info: Partial<PackageInfo>) => void) | undefined;\r\n  onServiceConfigChange?: ((config: Partial<SelectedShippingConfig['options']>) => void) | undefined;\r\n  onChangeDeliveryAddress?: (() => void) | undefined; // NEW: Callback to open address dialog\r\n  onNoteChange?: ((note: string) => void) | undefined; // ✅ NEW: Callback for shipping note\r\n  grandTotal?: number | undefined; // ✅ Order grand total for auto-filling orderValue\r\n  \r\n  // ✅ NEW: Props for API preview\r\n  previewData?: any; // Data that will be sent to API\r\n  \r\n  // ✅ NEW: Hide tabs and only show shipping-partner content\r\n  hideTabs?: boolean | undefined;\r\n  \r\n  disabled?: boolean | undefined;\r\n}\r\n\r\nexport function DeliveryMethodCard({\r\n  selectedMethod,\r\n  onMethodChange,\r\n  shippingRequest,\r\n  customerAddress,\r\n  packageInfo,\r\n  selectedService,\r\n  onServiceSelect,\r\n  onPackageInfoChange,\r\n  onServiceConfigChange,\r\n  onChangeDeliveryAddress,\r\n  onNoteChange,\r\n  grandTotal,\r\n  previewData,\r\n  hideTabs = false,\r\n  disabled,\r\n}: DeliveryMethodCardProps) {\r\n  \r\n  // ✅ Debug logging\r\n  React.useEffect(() => {\r\n    console.log('🎯 [DeliveryMethodCard] Props received:', {\r\n      hasCustomerAddress: !!customerAddress,\r\n      customerAddressProvince: customerAddress?.province,\r\n      customerAddressDistrict: customerAddress?.district,\r\n      selectedService: selectedService?.serviceName\r\n    });\r\n  }, [customerAddress, selectedService]);\r\n  \r\n  // Local state for editable fields\r\n  const [codAmount, setCodAmount] = React.useState(packageInfo?.codAmount || 0);\r\n  const [weight, setWeight] = React.useState(packageInfo?.weight || 0);\r\n  const [length, setLength] = React.useState(packageInfo?.length || 10);\r\n  const [width, setWidth] = React.useState(packageInfo?.width || 10);\r\n  const [height, setHeight] = React.useState(packageInfo?.height || 10);\r\n  const [deliveryNote, setDeliveryNote] = React.useState('');\r\n  const [deliveryRequirement, setDeliveryRequirement] = React.useState('view-only');\r\n\r\n  // ✅ NEW: State for preview dialog\r\n  const [showPreview, setShowPreview] = React.useState(false);\r\n  \r\n  // ✅ Track if user manually edited COD amount\r\n  const [isUserEditedCod, setIsUserEditedCod] = React.useState(false);\r\n\r\n  // Validation errors\r\n  const [errors, setErrors] = React.useState<Record<string, string>>({});\r\n\r\n  // Update local state when packageInfo changes\r\n  React.useEffect(() => {\r\n    if (packageInfo) {\r\n      // Only update codAmount if user hasn't manually edited it\r\n      if (!isUserEditedCod) {\r\n        setCodAmount(packageInfo.codAmount || 0);\r\n      }\r\n      setWeight(packageInfo.weight || 0);\r\n      setLength(packageInfo.length || 10);\r\n      setWidth(packageInfo.width || 10);\r\n      setHeight(packageInfo.height || 10);\r\n    }\r\n  }, [packageInfo, isUserEditedCod]);\r\n\r\n  // Validate and update packageInfo\r\n  const handleFieldChange = (field: string, value: number) => {\r\n    const newErrors = { ...errors };\r\n    \r\n    // Validation\r\n    if (field === 'weight' && value <= 0) {\r\n      newErrors.weight = 'Khối lượng phải lớn hơn 0';\r\n    } else if (field === 'weight' && selectedService?.partnerCode === 'GHTK' && value < 100) {\r\n      // ✅ GHTK minimum weight requirement\r\n      newErrors.weight = 'GHTK yêu cầu khối lượng tối thiểu 100g';\r\n    } else if (field === 'weight') {\r\n      delete newErrors.weight;\r\n    }\r\n\r\n    if ((field === 'length' || field === 'width' || field === 'height') && value <= 0) {\r\n      newErrors[field] = 'Kích thước phải lớn hơn 0';\r\n    } else if (field === 'length' || field === 'width' || field === 'height') {\r\n      delete newErrors[field];\r\n    }\r\n\r\n    if (field === 'codAmount' && value < 0) {\r\n      newErrors.codAmount = 'Tiền COD không được âm';\r\n    } else if (field === 'codAmount') {\r\n      delete newErrors.codAmount;\r\n    }\r\n\r\n    setErrors(newErrors);\r\n\r\n    // Update local state\r\n    switch (field) {\r\n      case 'codAmount': \r\n        setCodAmount(value);\r\n        setIsUserEditedCod(true); // Mark as user-edited\r\n        break;\r\n      case 'weight': setWeight(value); break;\r\n      case 'length': setLength(value); break;\r\n      case 'width': setWidth(value); break;\r\n      case 'height': setHeight(value); break;\r\n    }\r\n\r\n    // Notify parent if valid\r\n    if (Object.keys(newErrors).length === 0 && onPackageInfoChange) {\r\n      onPackageInfoChange({ [field]: value });\r\n    }\r\n  };\r\n\r\n  // Format currency (match product table: 8.000.000 VND)\r\n  const formatCurrency = (value: number) => {\r\n    const formatted = new Intl.NumberFormat('vi-VN').format(value);\r\n    return formatted;\r\n  };\r\n\r\n  // Format number with thousand separator (for weight)\r\n  const formatNumber = (value: number) => {\r\n    return new Intl.NumberFormat('vi-VN').format(value);\r\n  };\r\n\r\n  // Format address string\r\n  const formatAddress = (addr: ShippingAddress | null | undefined) => {\r\n    if (!addr) return 'Chưa có thông tin địa chỉ';\r\n    const parts = [addr.address, addr.ward, addr.district, addr.province].filter(Boolean);\r\n    return parts.join(', ') || 'Chưa có thông tin địa chỉ';\r\n  };\r\n\r\n  const handleChangeAddress = () => {\r\n    if (onChangeDeliveryAddress) {\r\n      onChangeDeliveryAddress();\r\n    } else {\r\n      alert('Vui lòng cập nhật địa chỉ khách hàng ở mục \"Thông tin khách hàng\" bên trên');\r\n    }\r\n  };\r\n\r\n  return (\r\n    <Tabs\r\n      value={selectedMethod}\r\n      onValueChange={(value) => onMethodChange(value as DeliveryMethod)}\r\n      className=\"w-full\"\r\n    >\r\n      {/* Conditionally hide tabs if hideTabs is true */}\r\n      {!hideTabs && (\r\n        <TabsList className=\"grid w-full grid-cols-4 h-auto\">\r\n          <TabsTrigger value=\"shipping-partner\" className=\"flex items-center gap-2 py-3\">\r\n            <Truck className=\"h-4 w-4\" />\r\n            <span>Đẩy qua hãng vận chuyển</span>\r\n          </TabsTrigger>\r\n          <TabsTrigger value=\"external\" className=\"flex items-center gap-2 py-3\" disabled>\r\n            <ExternalLink className=\"h-4 w-4\" />\r\n            <span>Đẩy vận chuyển ngoài</span>\r\n          </TabsTrigger>\r\n          <TabsTrigger value=\"pickup\" className=\"flex items-center gap-2 py-3\">\r\n            <Store className=\"h-4 w-4\" />\r\n            <span>Khách nhận tại cửa hàng</span>\r\n          </TabsTrigger>\r\n          <TabsTrigger value=\"deliver-later\" className=\"flex items-center gap-2 py-3\">\r\n            <Clock className=\"h-4 w-4\" />\r\n            <span>Giao hàng sau</span>\r\n          </TabsTrigger>\r\n        </TabsList>\r\n      )}\r\n\r\n      {/* Tab 1: Shipping Partner */}\r\n      <TabsContent value=\"shipping-partner\" className=\"mt-0\">\r\n        <div className=\"grid grid-cols-1 lg:grid-cols-[380px_1fr] gap-4 mt-4\">\r\n          {/* LEFT: Shipping Info Summary - Always visible */}\r\n          <div className=\"rounded-lg border bg-card p-4 space-y-4\">\r\n            {/* Địa chỉ giao hàng */}\r\n            <div className=\"space-y-2\">\r\n              <div className=\"flex items-center justify-between\">\r\n                <Label className=\"text-sm font-semibold text-primary\">Địa chỉ giao hàng</Label>\r\n                <Button \r\n                  type=\"button\"\r\n                  variant=\"ghost\" \r\n                  size=\"sm\" \r\n                  className=\"h-7 text-xs\"\r\n                  onClick={handleChangeAddress}\r\n                >\r\n                  <Edit2 className=\"h-3 w-3 mr-1\" />\r\n                  Thay đổi\r\n                </Button>\r\n              </div>\r\n              <div className=\"text-sm text-muted-foreground leading-relaxed\">\r\n                {formatAddress(customerAddress)}\r\n              </div>\r\n            </div>\r\n\r\n            {/* Thông tin giao hàng */}\r\n            <div className=\"border-t pt-4 space-y-3\">\r\n              <Label className=\"text-sm font-semibold\">Thông tin giao hàng</Label>\r\n              \r\n              {/* COD */}\r\n              <div className=\"space-y-1.5\">\r\n                <div className=\"flex items-center justify-between\">\r\n                  <Label htmlFor=\"codAmount\" className=\"text-sm text-muted-foreground\">\r\n                    Tiền thu hộ (COD)\r\n                  </Label>\r\n                </div>\r\n                <Input \r\n                  id=\"codAmount\"\r\n                  type=\"text\" \r\n                  value={formatCurrency(codAmount)}\r\n                  onChange={(e) => {\r\n                    const value = e.target.value.replace(/\\D/g, '');\r\n                    const numValue = Number(value);\r\n                    handleFieldChange('codAmount', numValue);\r\n                    \r\n                    // ✅ GHTK validation: COD must be 0 or between 10,000 - 20,000,000\r\n                    if (selectedService?.partnerCode === 'GHTK' && numValue > 0) {\r\n                      if (numValue < 10000) {\r\n                        console.warn('⚠️ GHTK: COD tối thiểu 10.000đ');\r\n                      } else if (numValue > 20000000) {\r\n                        console.warn('⚠️ GHTK: COD tối đa 20.000.000đ');\r\n                      }\r\n                    }\r\n                  }}\r\n                  className={cn(\r\n                    \"text-right font-medium\",\r\n                    selectedService?.partnerCode === 'GHTK' && codAmount > 0 && (codAmount < 10000 || codAmount > 20000000) && \"border-red-300\"\r\n                  )}\r\n                  placeholder=\"0\"\r\n                />\r\n                {errors.codAmount && (\r\n                  <p className=\"text-xs text-destructive\">{errors.codAmount}</p>\r\n                )}\r\n                {/* ✅ GHTK COD validation warning */}\r\n                {selectedService?.partnerCode === 'GHTK' && codAmount > 0 && codAmount < 10000 && (\r\n                  <p className=\"text-xs text-amber-600\">\r\n                    ⚠️ GHTK yêu cầu COD tối thiểu 10.000đ\r\n                  </p>\r\n                )}\r\n                {selectedService?.partnerCode === 'GHTK' && codAmount > 20000000 && (\r\n                  <p className=\"text-xs text-red-600\">\r\n                    ❌ GHTK giới hạn COD tối đa 20.000.000đ\r\n                  </p>\r\n                )}\r\n              </div>\r\n\r\n              {/* Khối lượng */}\r\n              <div className=\"space-y-1.5\">\r\n                <div className=\"flex items-center gap-1.5\">\r\n                  <Label htmlFor=\"weight\" className=\"text-sm text-muted-foreground\">\r\n                    Khối lượng (g)\r\n                  </Label>\r\n                  <TooltipProvider>\r\n                    <Tooltip>\r\n                      <TooltipTrigger asChild>\r\n                        <Info className=\"h-3.5 w-3.5 text-muted-foreground cursor-help\" />\r\n                      </TooltipTrigger>\r\n                      <TooltipContent>\r\n                        <p className=\"text-xs\">Tự động tính từ tổng khối lượng sản phẩm.</p>\r\n                        <p className=\"text-xs\">Bạn có thể sửa lại theo khối lượng thực tế.</p>\r\n                        {selectedService?.partnerCode === 'GHTK' && (\r\n                          <p className=\"text-xs text-amber-500 mt-1\">⚠️ GHTK yêu cầu tối thiểu 100g</p>\r\n                        )}\r\n                      </TooltipContent>\r\n                    </Tooltip>\r\n                  </TooltipProvider>\r\n                </div>\r\n                <Input \r\n                  id=\"weight\"\r\n                  type=\"text\" \r\n                  value={formatNumber(weight)}\r\n                  onChange={(e) => {\r\n                    const value = e.target.value.replace(/\\D/g, '');\r\n                    handleFieldChange('weight', Number(value));\r\n                  }}\r\n                  className=\"text-right font-medium\"\r\n                  placeholder=\"0\"\r\n                />\r\n                {errors.weight && (\r\n                  <p className=\"text-xs text-destructive\">{errors.weight}</p>\r\n                )}\r\n              </div>\r\n\r\n              {/* Kích thước (1 hàng) */}\r\n              <div className=\"space-y-1.5\">\r\n                <Label className=\"text-sm text-muted-foreground\">Kích thước (cm)</Label>\r\n                <div className=\"grid grid-cols-3 gap-2\">\r\n                  <div className=\"space-y-1\">\r\n                    <Input \r\n                      id=\"length\"\r\n                      type=\"number\" \r\n                      value={length}\r\n                      onChange={(e) => handleFieldChange('length', Number(e.target.value))}\r\n                      className=\"text-center text-sm\"\r\n                      placeholder=\"Dài\"\r\n                      min=\"1\"\r\n                    />\r\n                    <Label htmlFor=\"length\" className=\"text-xs text-center block text-muted-foreground\">Dài</Label>\r\n                  </div>\r\n                  <div className=\"space-y-1\">\r\n                    <Input \r\n                      id=\"width\"\r\n                      type=\"number\" \r\n                      value={width}\r\n                      onChange={(e) => handleFieldChange('width', Number(e.target.value))}\r\n                      className=\"text-center text-sm\"\r\n                      placeholder=\"Rộng\"\r\n                      min=\"1\"\r\n                    />\r\n                    <Label htmlFor=\"width\" className=\"text-xs text-center block text-muted-foreground\">Rộng</Label>\r\n                  </div>\r\n                  <div className=\"space-y-1\">\r\n                    <Input \r\n                      id=\"height\"\r\n                      type=\"number\" \r\n                      value={height}\r\n                      onChange={(e) => handleFieldChange('height', Number(e.target.value))}\r\n                      className=\"text-center text-sm\"\r\n                      placeholder=\"Cao\"\r\n                      min=\"1\"\r\n                    />\r\n                    <Label htmlFor=\"height\" className=\"text-xs text-center block text-muted-foreground\">Cao</Label>\r\n                  </div>\r\n                </div>\r\n                {(errors.length || errors.width || errors.height) && (\r\n                  <p className=\"text-xs text-destructive\">Kích thước phải lớn hơn 0</p>\r\n                )}\r\n              </div>\r\n            </div>\r\n\r\n            {/* Yêu cầu giao hàng */}\r\n            <div className=\"space-y-2\">\r\n              <Label htmlFor=\"deliveryReq\" className=\"text-sm font-medium\">\r\n                Yêu cầu giao hàng\r\n              </Label>\r\n              <Select \r\n                value={deliveryRequirement} \r\n                onValueChange={(value) => {\r\n                  setDeliveryRequirement(value);\r\n                  \r\n                  // ✅ Map to GHTK tags when service selected\r\n                  if (selectedService?.partnerCode === 'GHTK') {\r\n                    // Tag 10: Cho xem hàng\r\n                    // Note: GHTK only has \"Cho xem hàng\" tag, other options don't have specific tags\r\n                    const currentTags = (selectedService as any).tags || [];\r\n                    let newTags = currentTags.filter((t: number) => t !== 10); // Remove tag 10 first\r\n                    \r\n                    if (value === 'view-only') {\r\n                      newTags.push(10); // Add tag 10 for \"Cho xem hàng\"\r\n                    }\r\n                    // 'try-on' and 'no-check' don't have specific GHTK tags\r\n                    \r\n                    onServiceConfigChange?.({ tags: newTags });\r\n                  }\r\n                }}\r\n              >\r\n                <SelectTrigger id=\"deliveryReq\">\r\n                  <SelectValue />\r\n                </SelectTrigger>\r\n                <SelectContent>\r\n                  <SelectItem value=\"view-only\">Cho xem hàng, không cho thử</SelectItem>\r\n                  <SelectItem value=\"try-on\">Cho thử hàng</SelectItem>\r\n                  <SelectItem value=\"no-check\">Không cho kiểm tra</SelectItem>\r\n                </SelectContent>\r\n              </Select>\r\n            </div>\r\n\r\n            {/* Ghi chú */}\r\n            <div className=\"space-y-2\">\r\n              <Label htmlFor=\"deliveryNote\" className=\"text-sm font-medium\">\r\n                Ghi chú\r\n              </Label>\r\n              <Textarea \r\n                id=\"deliveryNote\"\r\n                value={deliveryNote}\r\n                onChange={(e) => {\r\n                  const note = e.target.value;\r\n                  setDeliveryNote(note);\r\n                  // ✅ Update form shippingNote\r\n                  onNoteChange?.(note);\r\n                }}\r\n                className=\"resize-none\" \r\n                rows={3}\r\n                placeholder=\"Nhập ghi chú...\"\r\n              />\r\n            </div>\r\n\r\n            <div className=\"text-xs text-muted-foreground pt-2 border-t\">\r\n              Số tiền khách cần thanh toán khi nhận hàng\r\n            </div>\r\n          </div>\r\n\r\n          {/* RIGHT: Service Selector AND Config Form */}\r\n          <div className=\"space-y-4\">\r\n            {/* Service Selector - Always show if has shipping request */}\r\n            {shippingRequest && onServiceSelect && (\r\n              <ShippingPartnerSelector\r\n                request={shippingRequest}\r\n                selectedService={selectedService}\r\n                onServiceSelect={onServiceSelect}\r\n                disabled={disabled}\r\n                collapsed={!!selectedService}\r\n                onServiceUpdate={(updatedService) => {\r\n                  // ✅ Update selected service when recalculation happens\r\n                  if (selectedService && \r\n                      updatedService.partnerId === selectedService.partnerId &&\r\n                      updatedService.serviceId === selectedService.serviceId) {\r\n                    onServiceSelect(updatedService);\r\n                  }\r\n                }}\r\n                onTogglePreview={() => setShowPreview(!showPreview)}\r\n              />\r\n            )}\r\n            \r\n            {/* Config Form - Show when service selected */}\r\n            {selectedService && (\r\n              <div className=\"rounded-lg border bg-card p-4\">\r\n                <h4 className=\"font-semibold mb-4\">Gói dịch vụ</h4>\r\n                <ServiceConfigForm\r\n                  service={selectedService}\r\n                  grandTotal={grandTotal}\r\n                  customerAddress={customerAddress}\r\n                  onConfigChange={(config) => {\r\n                    if (onServiceConfigChange) {\r\n                      onServiceConfigChange(config);\r\n                    }\r\n                  }}\r\n                />\r\n              </div>\r\n            )}\r\n            \r\n            {/* Show placeholder if no shipping request */}\r\n            {!shippingRequest && (\r\n              <div className=\"rounded-lg border bg-muted/30 p-8 text-center space-y-3\">\r\n                <Package className=\"h-12 w-12 mx-auto text-muted-foreground\" />\r\n                <div>\r\n                  <p className=\"text-sm font-medium\">Chưa đủ thông tin để tính phí vận chuyển</p>\r\n                  <p className=\"text-xs text-muted-foreground mt-1\">\r\n                    {!customerAddress ? '• Chưa có địa chỉ khách hàng' : ''}\r\n                    {customerAddress && weight <= 0 ? '• Khối lượng phải lớn hơn 0' : ''}\r\n                  </p>\r\n                </div>\r\n              </div>\r\n            )}\r\n          </div>\r\n        </div>\r\n      </TabsContent>\r\n\r\n      {/* Tab 2: External (Disabled) */}\r\n      <TabsContent value=\"external\" className=\"mt-4\">\r\n        <div className=\"rounded-lg border bg-muted/30 p-6 text-center space-y-2\">\r\n          <ExternalLink className=\"h-8 w-8 mx-auto text-muted-foreground\" />\r\n          <p className=\"text-sm font-medium\">Tính năng đang phát triển</p>\r\n        </div>\r\n      </TabsContent>\r\n\r\n      {/* Tab 3: Store Pickup */}\r\n      <TabsContent value=\"pickup\" className=\"mt-4\">\r\n        <div className=\"rounded-lg border bg-muted/30 p-6 text-center space-y-2\">\r\n          <Store className=\"h-8 w-8 mx-auto text-muted-foreground\" />\r\n          <p className=\"text-sm font-medium\">Khách nhận tại cửa hàng</p>\r\n          <p className=\"text-xs text-muted-foreground\">\r\n            Không phát sinh phí vận chuyển\r\n          </p>\r\n        </div>\r\n      </TabsContent>\r\n\r\n      {/* Tab 4: Deliver Later */}\r\n      <TabsContent value=\"deliver-later\" className=\"mt-4\">\r\n        <div className=\"rounded-lg border bg-muted/30 p-6 text-center space-y-2\">\r\n          <Clock className=\"h-8 w-8 mx-auto text-muted-foreground\" />\r\n          <p className=\"text-sm font-medium\">Giao hàng sau</p>\r\n          <p className=\"text-xs text-muted-foreground\">\r\n            Tự sắp xếp giao hàng sau khi tạo đơn\r\n          </p>\r\n        </div>\r\n      </TabsContent>\r\n\r\n      {/* ✅ Preview API Data Dialog */}\r\n      <Dialog open={showPreview} onOpenChange={setShowPreview}>\r\n        <DialogContent className=\"max-w-4xl max-h-[90vh]\">\r\n          <DialogHeader>\r\n            <DialogTitle>📤 Dữ liệu sẽ gửi lên Server API</DialogTitle>\r\n            <DialogDescription>\r\n              Đây là params thực tế sẽ được gửi đến GHTK API khi nhấn \"Chọn lại đơn vị vận chuyển\"\r\n            </DialogDescription>\r\n          </DialogHeader>\r\n          <ScrollArea className=\"h-[70vh] w-full rounded-md border p-4 bg-slate-50\">\r\n            {previewData ? (\r\n              <>\r\n                <div className=\"space-y-2 mb-4 p-3 bg-blue-50 rounded border border-blue-200\">\r\n                  <h3 className=\"font-semibold text-blue-900\">📦 Thông tin chính:</h3>\r\n                  <div className=\"grid grid-cols-2 gap-2 text-sm\">\r\n                    <div>\r\n                      <span className=\"font-medium\">Mã đơn:</span>{' '}\r\n                      <span className=\"font-mono text-green-700\">{previewData?.orderId || 'N/A'}</span>\r\n                    </div>\r\n                    <div>\r\n                      <span className=\"font-medium\">Kho lấy hàng:</span>{' '}\r\n                      <span className=\"font-mono text-orange-700\">{previewData?.pickAddressId || 'Chưa chọn'}</span>\r\n                    </div>\r\n                    <div>\r\n                      <span className=\"font-medium\">Khách hàng:</span>{' '}\r\n                      <span className=\"text-gray-800\">{previewData?.customerName || 'N/A'}</span>\r\n                    </div>\r\n                    <div>\r\n                      <span className=\"font-medium\">Tổng cân nặng:</span>{' '}\r\n                      <span className=\"text-gray-800\">{previewData?.totalWeight || 0}g</span>\r\n                    </div>\r\n                    <div>\r\n                      <span className=\"font-medium\">COD:</span>{' '}\r\n                      <span className=\"text-gray-800\">{new Intl.NumberFormat('vi-VN').format(previewData?.pickMoney || 0)}đ</span>\r\n                    </div>\r\n                    <div>\r\n                      <span className=\"font-medium\">Vận chuyển:</span>{' '}\r\n                      <span className=\"text-gray-800\">{previewData?.transport === 'fly' ? '✈️ Đường bay' : '🚚 Đường bộ'}</span>\r\n                    </div>\r\n                  </div>\r\n                </div>\r\n                <pre className=\"text-xs font-mono leading-relaxed bg-white p-3 rounded border\">\r\n                  {JSON.stringify(previewData, null, 2)}\r\n                </pre>\r\n              </>\r\n            ) : (\r\n              <div className=\"text-center py-12 text-muted-foreground\">\r\n                <Package className=\"h-16 w-16 mx-auto mb-4 opacity-30\" />\r\n                <p className=\"font-medium text-base\">Chưa có dữ liệu API</p>\r\n                <p className=\"text-sm mt-2\">Nhấn nút <strong>\"Chọn lại đơn vị vận chuyển\"</strong> bên dưới</p>\r\n                <p className=\"text-xs mt-1 text-muted-foreground/70\">để xem params sẽ được gửi đến GHTK API</p>\r\n              </div>\r\n            )}\r\n          </ScrollArea>\r\n        </DialogContent>\r\n      </Dialog>\r\n    </Tabs>\r\n  );\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 6854, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/orders/components/shipping-integration.tsx"],"sourcesContent":["import * as React from 'react';\r\nimport { useFormContext, useWatch } from 'react-hook-form';\r\nimport { DeliveryMethodCard } from './shipping/delivery-method-card';\r\nimport { DeliveryAddressCard } from './shipping/delivery-address-card';\r\nimport { PackageInfoCard } from './shipping/package-info-card';\r\nimport { useDebounce } from '../hooks/use-debounce';\r\nimport { GHTKService, type GHTKCreateOrderParams } from '../../settings/shipping/integrations/ghtk-service';\r\nimport { useAllShippingPartners } from '../../settings/shipping/hooks/use-all-shipping-partners';\r\nimport { loadShippingConfig } from '../../../lib/utils/shipping-config-migration';\r\nimport { useGlobalShippingConfig } from '../hooks/use-global-shipping-config'; // ✅ Import global config hook\r\nimport { getGHTKCredentials } from '../../../lib/utils/get-shipping-credentials'; // ✅ Import helper\r\nimport { toast } from 'sonner';\r\nimport type { \r\n  DeliveryMethod, \r\n  ShippingCalculationRequest, \r\n  ShippingService,\r\n  SelectedShippingConfig,\r\n  ShippingAddress,\r\n  PackageInfo\r\n} from './shipping/types';\r\nimport type { OrderFormValues } from '../order-form-page';\r\nimport { useShippingSettingsStore } from '../../settings/shipping/shipping-settings-store';\r\nimport { useAllProducts } from '../../products/hooks/use-all-products';\r\nimport { useAllProvinces, useAllWards } from '../../settings/provinces/hooks/use-provinces';\r\nimport { useAllBranches } from '../../settings/branches/hooks/use-all-branches';\r\nimport { useOrders } from '../hooks/use-orders'; // ✅ Import orders hook\r\nimport { asSystemId } from '@/lib/id-types';\r\nimport { Card, CardContent, CardHeader, CardTitle } from '../../../components/ui/card';\r\nimport { Button } from '../../../components/ui/button';\r\nimport { Loader2, PackageCheck } from 'lucide-react';\r\n\r\n/**\r\n * Generate unique order ID for shipping partner\r\n * Format: DH + YYMMDD + random 5 digits\r\n * Example: DH2511021A3F7\r\n */\r\nfunction generateShippingOrderId(): string {\r\n  const now = new Date();\r\n  const year = String(now.getFullYear()).slice(-2); // Last 2 digits\r\n  const month = String(now.getMonth() + 1).padStart(2, '0');\r\n  const day = String(now.getDate()).padStart(2, '0');\r\n  \r\n  // Generate random 5-character alphanumeric string (uppercase)\r\n  const chars = '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ';\r\n  let randomStr = '';\r\n  for (let i = 0; i < 5; i++) {\r\n    randomStr += chars.charAt(Math.floor(Math.random() * chars.length));\r\n  }\r\n  \r\n  return `DH${year}${month}${day}${randomStr}`;\r\n}\r\n\r\n/**\r\n * ✅ Helper: Calculate and distribute product weights\r\n * Handles 3 cases:\r\n * 1. User entered weight = 0 & products have no weight → Use default 500g per item\r\n * 2. User entered weight > 0 → Distribute proportionally to products\r\n * 3. Products have weight → Use product weights\r\n */\r\nfunction calculateProductWeights(\r\n  lineItems: any[],\r\n  findProductById: (id: string) => any,\r\n  userEnteredWeight: number\r\n): Array<{ name: string; weight: number; quantity: number; price: number; productCode: string }> {\r\n  // Build initial products list with weights from database\r\n  const products = lineItems.map(item => {\r\n    const product = findProductById(item.productSystemId);\r\n    const weightInGram = (product?.weight || 0) * item.quantity;\r\n    return {\r\n      name: item.productName,\r\n      weight: weightInGram,\r\n      quantity: item.quantity,\r\n      price: item.unitPrice,\r\n      productCode: item.productId,\r\n    };\r\n  });\r\n\r\n  // Case 1: No user weight & no product weights → Default 500g per item\r\n  if (userEnteredWeight === 0) {\r\n    const totalProductWeight = products.reduce((sum, p) => sum + p.weight, 0);\r\n    \r\n    if (totalProductWeight === 0) {\r\n      const defaultWeightPerItem = 500; // 500g default\r\n      products.forEach(p => {\r\n        p.weight = defaultWeightPerItem * p.quantity;\r\n      });\r\n    }\r\n    // else: Use product weights as-is\r\n  } \r\n  // Case 2: User entered weight → Distribute proportionally\r\n  else {\r\n    const totalProductWeight = products.reduce((sum, p) => sum + p.weight, 0);\r\n    \r\n    if (totalProductWeight > 0) {\r\n      // Distribute proportionally based on product weights\r\n      products.forEach(p => {\r\n        p.weight = Math.round((p.weight / totalProductWeight) * userEnteredWeight);\r\n      });\r\n    } else {\r\n      // No product weights, distribute evenly\r\n      const weightPerProduct = Math.round(userEnteredWeight / products.length);\r\n      products.forEach(p => {\r\n        p.weight = weightPerProduct * p.quantity;\r\n      });\r\n    }\r\n  }\r\n\r\n  return products;\r\n}\r\n\r\n/**\r\n * ✅ Helper: Build pickup address params based on pickAddressId\r\n * \r\n * GHTK REAL API Behavior (tested):\r\n * - pick_address_id = ID kho GHTK\r\n * - EVEN WITH pick_address_id, GHTK STILL REQUIRES:\r\n *   ✅ pick_name (sender name) - MANDATORY!\r\n *   ✅ pick_tel (sender phone) - MANDATORY!\r\n * - Do NOT send pick_province/pick_district/pick_ward when using pick_address_id\r\n */\r\nfunction buildPickupParams(\r\n  hasPickAddressId: boolean,\r\n  pickAddressId: string | undefined,\r\n  currentBranch: any,\r\n  pickupAddress: any\r\n) {\r\n  // ⚠️ Removed excessive console.log to prevent infinite loop in useMemo\r\n  // Only log once when actually submitting order (see ghtk-service.ts for detailed logs)\r\n  \r\n  if (hasPickAddressId && pickAddressId) {\r\n    // ⚠️ GHTK requires BOTH pick_address_id AND detailed address fields\r\n    // Even with warehouse ID, we still need to send full address\r\n    return {\r\n      pickAddressId,\r\n      pickName: currentBranch.name || pickupAddress.name,\r\n      pickAddress: pickupAddress.address || currentBranch.address || '', // ✅ REQUIRED!\r\n      pickProvince: pickupAddress.province || '', // ✅ REQUIRED!\r\n      pickDistrict: pickupAddress.district || '', // ✅ REQUIRED!\r\n      pickWard: pickupAddress.ward || '',\r\n      pickTel: currentBranch.phone || pickupAddress.phone || '',\r\n    };\r\n  } else {\r\n    // ✅ Send full manual pickup address\r\n    return {\r\n      pickName: currentBranch.name,\r\n      pickAddress: pickupAddress.address,\r\n      pickProvince: pickupAddress.province,\r\n      pickDistrict: pickupAddress.district || '',\r\n      pickWard: pickupAddress.ward || '',\r\n      pickTel: currentBranch.phone || '',\r\n    };\r\n  }\r\n}\r\n\r\n/**\r\n * ✅ Helper: Build customer address params\r\n */\r\nfunction buildCustomerParams(\r\n  customerAddress: any,\r\n  specificAddress?: string\r\n) {\r\n  return {\r\n    customerName: customerAddress.name,\r\n    customerAddress: customerAddress.address || '',\r\n    customerProvince: customerAddress.province,\r\n    customerDistrict: customerAddress.district || '',\r\n    customerWard: customerAddress.ward,\r\n    customerTel: customerAddress.phone,\r\n    customerHamlet: specificAddress || 'Khác',\r\n  };\r\n}\r\n\r\n/**\r\n * ✅ Helper: Build return address params (conditional)\r\n */\r\nfunction buildReturnAddressParams(\r\n  useReturnAddress: number | undefined,\r\n  returnConfig: any\r\n) {\r\n  if (useReturnAddress === 1 && returnConfig?.returnName) {\r\n    return {\r\n      useReturnAddress: 1,\r\n      returnName: returnConfig.returnName,\r\n      returnAddress: returnConfig.returnAddress,\r\n      returnProvince: returnConfig.returnProvince,\r\n      returnDistrict: returnConfig.returnDistrict,\r\n      returnWard: returnConfig.returnWard,\r\n      returnStreet: returnConfig.returnStreet,\r\n      returnTel: returnConfig.returnTel,\r\n      returnEmail: returnConfig.returnEmail,\r\n    };\r\n  } else {\r\n    return { useReturnAddress: 0 };\r\n  }\r\n}\r\n\r\ninterface ShippingIntegrationProps {\r\n  disabled?: boolean;\r\n  onChangeDeliveryAddress?: () => void; // ✅ Add callback for opening edit address dialog\r\n  hideTabs?: boolean; // ✅ Hide tabs and only show shipping-partner content\r\n  customer?: any; // ✅ Optional customer prop (if not provided, will watch from form)\r\n}\r\n\r\n/**\r\n * Main shipping integration component\r\n * Replaces the old PackagingAndDelivery component\r\n */\r\nexport function ShippingIntegration({ disabled, onChangeDeliveryAddress, hideTabs, customer: customerProp }: ShippingIntegrationProps) {\r\n  const { control, setValue, getValues } = useFormContext<OrderFormValues>();\r\n  const { settings: shippingSettings } = useShippingSettingsStore();\r\n  const { globalConfig, getDimensions, getWeight, getDefaultShippingOptions } = useGlobalShippingConfig(); // ✅ Get global config\r\n  const { data: allProducts } = useAllProducts();\r\n  const { data: provinces = [] } = useAllProvinces();\r\n  const { data: allWards = [] } = useAllWards();\r\n  const { data: branches } = useAllBranches();\r\n  const { data: partners } = useAllShippingPartners();\r\n  const { data: ordersData } = useOrders({ limit: 100 });\r\n  const allOrders = ordersData?.data || []; // ✅ Get all orders for ID generation\r\n\r\n  const findProductByIdBase = React.useCallback((id: string) => allProducts.find(p => p.systemId === id), [allProducts]);\r\n  const findBranchByIdBase = React.useCallback((id: string) => branches.find(b => b.systemId === id), [branches]);\r\n\r\n  // Helper function to get wards by province ID (replacement for store method)\r\n  const getWardsByProvinceId = React.useCallback((provinceId: string) => {\r\n    return allWards.filter(w => w.provinceId === provinceId);\r\n  }, [allWards]);\r\n\r\n  const findProductById = React.useCallback(\r\n    (id?: string | null) => {\r\n      if (!id || id.trim().length === 0) return undefined;\r\n      return findProductByIdBase(asSystemId(id));\r\n    },\r\n    [findProductByIdBase]\r\n  );\r\n\r\n  const findBranchById = React.useCallback(\r\n    (id?: string | null) => {\r\n      if (!id || id.trim().length === 0) return undefined;\r\n      return findBranchByIdBase(asSystemId(id));\r\n    },\r\n    [findBranchByIdBase]\r\n  );\r\n\r\n  // ✅ PHASE 2: Convert watch to useWatch for better performance\r\n  // Use customer from props if provided, otherwise watch from form\r\n  const customerFromForm = useWatch({ control, name: 'customer' });\r\n  const customer = customerProp !== undefined ? customerProp : customerFromForm;\r\n  const watchedBranchSystemId = useWatch({ control, name: 'branchSystemId' }) as string | undefined;\r\n  const branchSystemId = React.useMemo(() => {\r\n    if (!watchedBranchSystemId || watchedBranchSystemId.trim().length === 0) return undefined;\r\n    return asSystemId(watchedBranchSystemId);\r\n  }, [watchedBranchSystemId]);\r\n  const lineItems = useWatch({ control, name: 'lineItems' });\r\n  const grandTotal = useWatch({ control, name: 'grandTotal' });\r\n  const payments = useWatch({ control, name: 'payments' }) || [];\r\n  const deliveryMethod = useWatch({ control, name: 'deliveryMethod' }) as DeliveryMethod || 'deliver-later';\r\n  const trackingCode = useWatch({ control, name: 'trackingCode' });\r\n  const configuration = useWatch({ control, name: 'configuration' }); // ✅ Watch configuration for tags, transport, dates\r\n  const shippingNote = useWatch({ control, name: 'shippingNote' }); // ✅ Watch shipping note\r\n  const formWeight = useWatch({ control, name: 'weight' }); // ✅ Watch weight from form\r\n  const formShippingAddress = useWatch({ control, name: 'shippingAddress' }); // ✅ Watch selected shipping address\r\n  \r\n  // Watch customer address fields specifically to trigger recalculation\r\n  const customerProvince = customer?.shippingAddress_province;\r\n  const customerDistrict = customer?.shippingAddress_ward;\r\n  const customerStreet = customer?.shippingAddress_street;\r\n\r\n  // State for shipping\r\n  const [selectedService, setSelectedService] = React.useState<ShippingService | null>(null);\r\n  const [shippingConfig, setShippingConfig] = React.useState<SelectedShippingConfig | null>(null);\r\n  const [editingPackage, setEditingPackage] = React.useState(false);\r\n  const [creatingShipment, setCreatingShipment] = React.useState(false);\r\n  const [serviceOptions, setServiceOptions] = React.useState<Partial<SelectedShippingConfig['options']>>({}); // ✅ Track service options for recalculation\r\n  const [lastApiParams, setLastApiParams] = React.useState<any>(null); // ✅ Store last API params for preview\r\n  \r\n  // State for editable package info\r\n  const [customWeight, setCustomWeight] = React.useState<number | null>(null);\r\n  const [customLength, setCustomLength] = React.useState<number | null>(null);\r\n  const [customWidth, setCustomWidth] = React.useState<number | null>(null);\r\n  const [customHeight, setCustomHeight] = React.useState<number | null>(null);\r\n  const [customCodAmount, setCustomCodAmount] = React.useState<number | null>(null);\r\n\r\n  // Calculate total paid\r\n  const totalPaid = React.useMemo(() => \r\n    payments.reduce((sum, p) => sum + (Number(p.amount) || 0), 0),\r\n    [payments]\r\n  );\r\n\r\n  // Calculate COD amount\r\n  const codAmount = React.useMemo(() => \r\n    Math.max(0, grandTotal - totalPaid),\r\n    [grandTotal, totalPaid]\r\n  );\r\n\r\n  // Calculate total weight from line items\r\n  const totalWeight = React.useMemo(() => {\r\n    if (shippingSettings.weightSource === 'product' && lineItems) {\r\n      // ⚠️ Removed console.log to prevent infinite loop spam\r\n      \r\n      let hasProductWithoutWeight = false;\r\n      const total = lineItems.reduce((sum, item) => {\r\n        const product = findProductById(item.productSystemId);\r\n        \r\n        if (!product || !product.weight) {\r\n          hasProductWithoutWeight = true;\r\n          return sum;\r\n        }\r\n        const weightInGrams = product.weightUnit === 'kg' ? product.weight * 1000 : product.weight;\r\n        return sum + (weightInGrams * item.quantity);\r\n      }, 0);\r\n      \r\n      return total;\r\n    }\r\n    // Return custom weight (no conversion, use as-is with unit from shippingSettings)\r\n    return shippingSettings.customWeight || 0;\r\n  }, [shippingSettings.weightSource, shippingSettings.customWeight, lineItems, findProductById]);\r\n\r\n  // Debounce weight to avoid excessive recalculations\r\n  const debouncedWeight = useDebounce(totalWeight, 300);\r\n\r\n  // ✅ PHASE 3: Auto-fill weight into form field when delivery method is shipping-partner\r\n  React.useEffect(() => {\r\n    if (deliveryMethod === 'shipping-partner') {\r\n      // Only auto-fill if:\r\n      // 1. totalWeight changed (from products)\r\n      // 2. User hasn't manually entered a weight (customWeight is null)\r\n      // 3. totalWeight is valid (> 0)\r\n      if (!customWeight && totalWeight > 0) {\r\n        const roundedWeight = Math.round(totalWeight);\r\n        setValue('weight', roundedWeight);\r\n        // ⚠️ Removed console.log\r\n      }\r\n    }\r\n  }, [deliveryMethod, totalWeight, customWeight, formWeight, setValue]);\r\n\r\n  // Get customer shipping address\r\n  const customerAddress: ShippingAddress | null = React.useMemo(() => {\r\n    // Removed console.log with potential circular references\r\n    \r\n    if (!customer) {\r\n      console.warn('⚠️ [Customer Address] No customer');\r\n      return null;\r\n    }\r\n\r\n    // ✅ PRIORITY 1: Get from form's selected shippingAddress field (user can change this)\r\n    if (formShippingAddress) {\r\n      const shippingAddr = formShippingAddress;\r\n      // console.log('🔍 [Customer Address] Checking formShippingAddress:', shippingAddr); // Removed\r\n      \r\n      if (shippingAddr.province) {\r\n        const province = provinces.find(p => p.name === shippingAddr.province);\r\n        if (province) {\r\n          const result = {\r\n            name: customer.name,\r\n            phone: customer.phone,\r\n            address: shippingAddr.street || '',\r\n            province: shippingAddr.province,\r\n            provinceId: parseInt(province.id),\r\n            district: shippingAddr.district || '',\r\n            districtId: shippingAddr.districtId || 0,\r\n            ward: shippingAddr.ward || '',\r\n            wardCode: shippingAddr.wardCode\r\n          };\r\n          // console.log('✅ [Customer Address] From form shippingAddress field:', result); // Removed\r\n          return result;\r\n        } else {\r\n          console.warn('⚠️ [Customer Address] Province not found in provinces list:', shippingAddr.province);\r\n        }\r\n      } else {\r\n        console.warn('⚠️ [Customer Address] formShippingAddress has no province field');\r\n      }\r\n    }\r\n\r\n    // ✅ PRIORITY 2: Try to get from addresses array (default shipping address)\r\n    if (customer.addresses && customer.addresses.length > 0) {\r\n      // Find default shipping address or first address\r\n      const shippingAddr = customer.addresses.find(addr => addr.isDefaultShipping) || customer.addresses[0];\r\n      \r\n      if (shippingAddr.province) {\r\n        const province = provinces.find(p => p.name === shippingAddr.province);\r\n        if (province) {\r\n          const result = {\r\n            name: customer.name,\r\n            phone: customer.phone,\r\n            address: shippingAddr.street || '',\r\n            province: shippingAddr.province,\r\n            provinceId: parseInt(province.id),\r\n            district: shippingAddr.district || '',\r\n            districtId: shippingAddr.districtId || 0,\r\n            ward: shippingAddr.ward || '',\r\n            wardCode: shippingAddr.wardCode\r\n          };\r\n          // ⚠️ Removed console.log\r\n          return result;\r\n        }\r\n      }\r\n    }\r\n\r\n    // PRIORITY 3: Fallback to legacy fields\r\n    if (!customer.shippingAddress_province) {\r\n      return null;\r\n    }\r\n\r\n    // Find province and district\r\n    const province = provinces.find(p => p.name === customer.shippingAddress_province);\r\n    if (!province) {\r\n      return null;\r\n    }\r\n\r\n    const wards = getWardsByProvinceId(province.id);\r\n    const ward = wards.find(w => w.name === customer.shippingAddress_ward);\r\n\r\n    const result = {\r\n      name: customer.name,\r\n      phone: customer.phone,\r\n      address: customer.shippingAddress_street || '',\r\n      province: province.name,\r\n      provinceId: parseInt(province.id),\r\n      district: customer.shippingAddress_ward || '', // FIXME: Need district separate field\r\n      districtId: 0, // FIXME: Need district ID mapping\r\n      ward: customer.shippingAddress_ward,\r\n      wardCode: ward?.id\r\n    };\r\n    // ⚠️ Removed console.log\r\n    return result;\r\n  }, [\r\n    customer, \r\n    formShippingAddress,\r\n    // ✅ CRITICAL: Add specific fields to trigger recalculation when address changes\r\n    formShippingAddress?.province,\r\n    formShippingAddress?.district,\r\n    formShippingAddress?.ward,\r\n    formShippingAddress?.street,\r\n    formShippingAddress?.id,\r\n    formShippingAddress?.provinceId,\r\n    formShippingAddress?.districtId,\r\n    formShippingAddress?.wardId,\r\n    formShippingAddress?.wardCode,\r\n    // ✅ SUPER CRITICAL: Stringify entire object to catch ALL changes\r\n    JSON.stringify(formShippingAddress),\r\n    provinces, \r\n    getWardsByProvinceId, \r\n    customerProvince, \r\n    customerDistrict, \r\n    customerStreet\r\n  ]);\r\n\r\n  // ✅ Auto-set default shipping address to form when customer changes\r\n  React.useEffect(() => {\r\n    if (customer && customer.addresses && customer.addresses.length > 0 && !formShippingAddress) {\r\n      const defaultShipping = customer.addresses.find(addr => addr.isDefaultShipping) || customer.addresses[0];\r\n      if (defaultShipping) {\r\n        // console.log('🔄 [Auto-set] Setting default shipping address to form:', defaultShipping); // Removed\r\n        setValue('shippingAddress', defaultShipping);\r\n      }\r\n    }\r\n  }, [customer, formShippingAddress, setValue]);\r\n\r\n  // Get branch pickup address\r\n  const pickupAddress: ShippingAddress | null = React.useMemo(() => {\r\n    if (!branchSystemId) {\r\n      return null;\r\n    }\r\n\r\n    // ✅ V2: Load shipping config (multi-account structure)\r\n    const shippingConfig = loadShippingConfig();\r\n\r\n    // ✅ V2: Get default GHTK account\r\n    const ghtkData = shippingConfig.partners.GHTK;\r\n    if (!ghtkData || !ghtkData.accounts || ghtkData.accounts.length === 0) {\r\n      return null;\r\n    }\r\n\r\n    const defaultAccount = ghtkData.accounts.find(a => a.isDefault && a.active)\r\n      || ghtkData.accounts.find(a => a.active)\r\n      || ghtkData.accounts[0];\r\n\r\n    if (!defaultAccount || !defaultAccount.active) {\r\n      return null;\r\n    }\r\n\r\n    \r\n    // ✅ Store default settings for fee calculation\r\n    if (defaultAccount.defaultSettings) {\r\n      (window as any).__ghtkDefaultSettings = defaultAccount.defaultSettings;\r\n    }\r\n\r\n    // ✅ V2: Find pickup address for this branch\r\n    const pickupAddr = defaultAccount.pickupAddresses?.find(p => p.sapoBranchId === branchSystemId);\r\n    \r\n    if (pickupAddr) {\r\n      const result = {\r\n        name: pickupAddr.partnerWarehouseName,\r\n        phone: pickupAddr.partnerWarehouseTel || '',\r\n        address: pickupAddr.partnerWarehouseAddress,\r\n        province: pickupAddr.partnerWarehouseProvince,\r\n        provinceId: 1, // Placeholder\r\n        district: pickupAddr.partnerWarehouseDistrict,\r\n        districtId: 1, // Placeholder\r\n        ward: pickupAddr.partnerWarehouseWard || '',\r\n        wardCode: pickupAddr.partnerWarehouseId || '', // GHTK warehouse ID\r\n      };\r\n      return result;\r\n    }\r\n\r\n    // ⚠️ No pickup address mapped - Show warning and return null to disable shipping\r\n    const branch = findBranchById(branchSystemId);\r\n    if (!branch) {\r\n      return null;\r\n    }\r\n\r\n    console.warn('[ShippingIntegration] No pickup address mapped for branch:', branch.name);\r\n    toast.warning('Chưa cấu hình địa chỉ lấy hàng', {\r\n      description: `Chi nhánh \"${branch.name}\" chưa được ánh xạ với kho GHTK. Vui lòng cấu hình trong Cài đặt → Đối tác vận chuyển.`,\r\n      duration: 6000,\r\n    });\r\n    \r\n    return null; // Disable shipping partner selection\r\n  }, [branchSystemId, findBranchById]);\r\n\r\n  // ✅ TASK 5: Preload address details when switching to shipping tab\r\n  React.useEffect(() => {\r\n    if (deliveryMethod === 'shipping-partner') {\r\n      // Removed console.log with potential circular references\r\n      \r\n      // The actual address loading is handled by useMemo (customerAddress, pickupAddress)\r\n      // This useEffect just logs that we're switching and the address is being computed\r\n      // If customer or branch changes while on shipping tab, the useMemo will auto-recompute\r\n      \r\n      if (!customer) {\r\n        toast.warning('Chưa có thông tin khách hàng', {\r\n          description: 'Vui lòng nhập thông tin khách hàng trước khi chọn vận chuyển',\r\n          duration: 4000\r\n        });\r\n      } else if (!branchSystemId) {\r\n        toast.warning('Chưa chọn chi nhánh', {\r\n          description: 'Vui lòng chọn chi nhánh lấy hàng',\r\n          duration: 4000\r\n        });\r\n      } else {\r\n        console.log('✅ [Address Preload] Customer address and branch loaded successfully');\r\n        // Show success toast when address is fully loaded\r\n        if (customerProvince && customerDistrict && pickupAddress) {\r\n          toast.success('Đã tải thông tin địa chỉ', {\r\n            description: `Khách: ${customerProvince}, ${customerDistrict} | Lấy hàng: ${pickupAddress.province}`,\r\n            duration: 3000\r\n          });\r\n        }\r\n      }\r\n    }\r\n  }, [deliveryMethod, customer, branchSystemId, customerProvince, customerDistrict, customerStreet, pickupAddress]);\r\n\r\n  // Package info (use debounced weight for stability, allow manual override)\r\n  const packageInfo: PackageInfo = React.useMemo(() => {\r\n    // ✅ Get default dimensions from global config\r\n    const defaultDimensions = getDimensions();\r\n    \r\n    // ✅ Use weight from form field (already auto-filled by useEffect)\r\n    // This avoids timing issues with debounced totalWeight\r\n    const finalWeight = formWeight ?? customWeight ?? Math.round(totalWeight);\r\n    \r\n    // ⚠️ Removed console.log to prevent spam\r\n    \r\n    const result = {\r\n      weight: finalWeight,\r\n      weightUnit: shippingSettings.weightUnit || 'gram',\r\n      // ✅ Use global config dimensions as default, then shippingSettings, then fallback\r\n      length: customLength ?? defaultDimensions.length ?? (shippingSettings.length || 10),\r\n      width: customWidth ?? defaultDimensions.width ?? (shippingSettings.width || 10),\r\n      height: customHeight ?? defaultDimensions.height ?? (shippingSettings.height || 10),\r\n      codAmount: customCodAmount ?? codAmount,\r\n      insuranceValue: grandTotal\r\n    };\r\n    \r\n    return result;\r\n  }, [formWeight, totalWeight, codAmount, grandTotal, shippingSettings.weightUnit, shippingSettings.length, shippingSettings.width, shippingSettings.height, customWeight, customLength, customWidth, customHeight, customCodAmount, getDimensions]);\r\n\r\n  // ✅ Build shipping calculation request with auto-recalculation\r\n  const shippingRequest: ShippingCalculationRequest | null = React.useMemo(() => {\r\n    // Removed console.log with potential circular references\r\n    \r\n    if (!pickupAddress || !customerAddress) {\r\n      console.warn('⚠️ [Shipping Request] Missing address:', {\r\n        pickupAddress: !!pickupAddress,\r\n        customerAddress: !!customerAddress\r\n      });\r\n      return null;\r\n    }\r\n    \r\n    if (packageInfo.weight <= 0) {\r\n      console.warn('⚠️ [Shipping Request] Invalid weight:', packageInfo.weight);\r\n      return null;\r\n    }\r\n    \r\n    const ghtkDefaults = (window as any).__ghtkDefaultSettings || {};\r\n\r\n    const result = {\r\n      fromProvinceId: pickupAddress.provinceId,\r\n      fromDistrictId: pickupAddress.districtId,\r\n      fromWardCode: pickupAddress.wardCode,\r\n      fromAddress: pickupAddress.address,\r\n      fromProvince: pickupAddress.province,\r\n      fromDistrict: pickupAddress.district,\r\n      toProvinceId: customerAddress.provinceId,\r\n      toDistrictId: customerAddress.districtId,\r\n      toWardCode: customerAddress.wardCode,\r\n      toWard: customerAddress.ward, // ✅ Ward name for 2-level address\r\n      toAddress: customerAddress.address,\r\n      toProvince: customerAddress.province,\r\n      toDistrict: customerAddress.district,\r\n      weight: packageInfo.weight,\r\n      length: packageInfo.length,\r\n      width: packageInfo.width,\r\n      height: packageInfo.height,\r\n      codAmount: packageInfo.codAmount,\r\n      insuranceValue: packageInfo.insuranceValue,\r\n      options: {\r\n        transport: serviceOptions?.transport || ghtkDefaults.transport || 'road',\r\n        tags: serviceOptions?.tags || ghtkDefaults.tags || [],\r\n        deliverWorkShift: serviceOptions?.deliverWorkShift || ghtkDefaults.deliverWorkShift || 1,\r\n        pickWorkShift: serviceOptions?.pickWorkShift || ghtkDefaults.pickWorkShift || 1,\r\n        orderValue: serviceOptions?.orderValue || grandTotal || 0,\r\n        pickAddressId: serviceOptions?.pickAddressId,\r\n      }\r\n    };\r\n    \r\n    // Removed console.log - only log essential info\r\n    console.log('✅ [Shipping Request] Built request with weight:', result.weight, 'g');\r\n    \r\n    return result;\r\n  }, [\r\n    pickupAddress, \r\n    customerAddress, \r\n    // ✅ CRITICAL: Add specific address fields to trigger recalculation when address changes\r\n    customerAddress?.province,\r\n    customerAddress?.district,\r\n    customerAddress?.provinceId,\r\n    customerAddress?.districtId,\r\n    customerAddress?.wardCode,\r\n    packageInfo.weight,\r\n    packageInfo.codAmount,\r\n    packageInfo.length,\r\n    packageInfo.width,\r\n    packageInfo.height,\r\n    packageInfo.insuranceValue,\r\n    grandTotal,\r\n    serviceOptions?.transport,\r\n    JSON.stringify(serviceOptions?.tags || []),\r\n    serviceOptions?.deliverWorkShift,\r\n    serviceOptions?.pickWorkShift,\r\n    serviceOptions?.orderValue,\r\n    serviceOptions?.pickAddressId,\r\n  ]);\r\n\r\n  // ✅ REMOVED: Don't reset service when address changes\r\n  // Instead, let the shipping calculator hook automatically recalculate fees\r\n  // and update the selected service's fee in place\r\n\r\n  // Handle delivery method change - memoized with useCallback\r\n  const handleMethodChange = React.useCallback((method: DeliveryMethod) => {\r\n    setValue('deliveryMethod', method);\r\n    \r\n    // Reset shipping data when changing method\r\n    if (method !== 'shipping-partner') {\r\n      setSelectedService(null);\r\n      setShippingConfig(null);\r\n      setValue('shippingFee', 0);\r\n      setValue('shippingPartnerId', '');\r\n      setValue('shippingServiceId', '');\r\n      setValue('trackingCode', ''); // ✅ Clear tracking code khi không dùng đối tác vận chuyển\r\n    }\r\n  }, [setValue]);\r\n\r\n  // Handle service selection - memoized with useCallback\r\n  const handleServiceSelect = React.useCallback((service: ShippingService) => {\r\n    \r\n    setSelectedService(service);\r\n    \r\n    // ✅ FIX: CHỈ lưu thông tin service, KHÔNG tự động set shippingFee\r\n    // User phải click \"Áp dụng\" trong ServiceConfigForm mới set fee\r\n    setValue('shippingPartnerId', service.partnerId);\r\n    setValue('shippingServiceId', service.serviceId);\r\n    \r\n  }, [setValue]);\r\n\r\n  // Handle config save - memoized with useCallback\r\n  const handleConfigSave = React.useCallback((options: Partial<SelectedShippingConfig['options']>) => {\r\n    if (!selectedService) return;\r\n\r\n\r\n    const config: SelectedShippingConfig = {\r\n      service: selectedService,\r\n      weight: packageInfo.weight,\r\n      dimensions: {\r\n        length: packageInfo.length,\r\n        width: packageInfo.width,\r\n        height: packageInfo.height\r\n      },\r\n      pickupAddressId: branchSystemId,\r\n      deliveryAddress: customerAddress,\r\n      options: options\r\n    };\r\n\r\n    setShippingConfig(config);\r\n    \r\n    // ✅ NOW set the shipping fee (when user confirms config)\r\n    setValue('shippingFee', selectedService.fee);\r\n    \r\n    // Save to form\r\n    setValue('codAmount', packageInfo.codAmount);\r\n    setValue('weight', packageInfo.weight);\r\n    setValue('length', packageInfo.length);\r\n    setValue('width', packageInfo.width);\r\n    setValue('height', packageInfo.height);\r\n    setValue('payer', options?.payer === 'CUSTOMER' ? 'Người nhận' : 'Người gửi');\r\n    setValue('shippingNote', options?.note || '');\r\n    setValue('configuration', options);\r\n    \r\n  }, [selectedService, packageInfo, branchSystemId, customerAddress, setValue]);\r\n\r\n  // Handle package info change - memoized with useCallback\r\n  const handlePackageChange = React.useCallback((info: PackageInfo) => {\r\n    setValue('weight', info.weight);\r\n    setValue('length', info.length);\r\n    setValue('width', info.width);\r\n    setValue('height', info.height);\r\n    setValue('codAmount', info.codAmount);\r\n  }, [setValue]);\r\n\r\n  // Handle package info change from DeliveryMethodCard\r\n  const handlePackageInfoChange = React.useCallback((info: Partial<PackageInfo>) => {\r\n    \r\n    if (info.weight !== undefined) {\r\n      setCustomWeight(info.weight);\r\n      setValue('weight', info.weight); // ✅ Update form value so API params use updated weight\r\n    }\r\n    if (info.length !== undefined) {\r\n      setCustomLength(info.length);\r\n    }\r\n    if (info.width !== undefined) {\r\n      setCustomWidth(info.width);\r\n    }\r\n    if (info.height !== undefined) {\r\n      setCustomHeight(info.height);\r\n    }\r\n    if (info.codAmount !== undefined) {\r\n      setCustomCodAmount(info.codAmount);\r\n    }\r\n    \r\n  }, [setValue]);\r\n\r\n  // ✅ Update form value when user manually edits codAmount\r\n  React.useEffect(() => {\r\n    if (customCodAmount !== null) {\r\n      console.log('💰 [ShippingIntegration] User edited COD amount:', {\r\n        customCodAmount,\r\n        autoCodAmount: codAmount,\r\n        grandTotal,\r\n        totalPaid\r\n      });\r\n      setValue('codAmount', customCodAmount);\r\n    }\r\n  }, [customCodAmount, setValue, codAmount, grandTotal, totalPaid]);\r\n\r\n  // Handle service config change\r\n  const handleServiceConfigChange = React.useCallback((config: Partial<SelectedShippingConfig['options']>) => {\r\n    \r\n    // Save config to form values\r\n    const currentConfig = getValues('configuration');\r\n    setValue('configuration', { \r\n      ...currentConfig, \r\n      ...config\r\n      // Note: _ghtkPreviewParams will be added by useEffect below\r\n    });\r\n    \r\n    // ✅ Update state to trigger recalculation\r\n    setServiceOptions(prev => {\r\n      const newOptions = { ...prev, ...config };\r\n      return newOptions;\r\n    });\r\n  }, [setValue, getValues]);\r\n\r\n  // Auto-update package info when values change\r\n  React.useEffect(() => {\r\n    if (deliveryMethod === 'shipping-partner') {\r\n      // ✅ FIX: Only auto-update codAmount if user hasn't manually edited it\r\n      // If customCodAmount is set, it means user manually edited the field\r\n      if (customCodAmount === null) {\r\n        console.log('💰 [ShippingIntegration] Auto-updating COD amount:', {\r\n          autoCodAmount: codAmount,\r\n          grandTotal,\r\n          totalPaid\r\n        });\r\n        setValue('codAmount', codAmount);\r\n      } else {\r\n        console.log('💰 [ShippingIntegration] Skipping auto-update (user edited):', {\r\n          customCodAmount,\r\n          autoCodAmount: codAmount\r\n        });\r\n      }\r\n      // ✅ Remove duplicate weight setValue - already handled above\r\n      setValue('length', shippingSettings.length);\r\n      setValue('width', shippingSettings.width);\r\n      setValue('height', shippingSettings.height);\r\n    }\r\n  }, [deliveryMethod, codAmount, shippingSettings.length, shippingSettings.width, shippingSettings.height, setValue, customCodAmount, grandTotal, totalPaid]);\r\n\r\n  // ⚠️ DEPRECATED - Đã thay thế bằng previewData (unified params)\r\n  // Giữ lại để tương thích ngược, nhưng ưu tiên dùng previewData\r\n  const previewParams = React.useMemo(() => {\r\n    if (!selectedService || !customerAddress || !lineItems || lineItems.length === 0) {\r\n      return null;\r\n    }\r\n\r\n    const formValues = getValues();\r\n    const orderId = formValues.externalReference || 'DH' + Date.now().toString().slice(-8);\r\n    const currentBranch = findBranchById(branchSystemId);\r\n    \r\n    if (!currentBranch || !pickupAddress) return null;\r\n\r\n    // ✅ Use helper function to calculate product weights (DRY - Don't Repeat Yourself)\r\n    const userEnteredWeight = packageInfo.weight || 0;\r\n    const products = calculateProductWeights(lineItems, findProductById, userEnteredWeight);\r\n\r\n    const params: any = {\r\n      orderId: String(orderId),\r\n      \r\n      // ✅ Use helper functions to build params (DRY)\r\n      ...buildPickupParams(\r\n        !!formValues.configuration?.pickAddressId,\r\n        formValues.configuration?.pickAddressId,\r\n        currentBranch,\r\n        pickupAddress\r\n      ),\r\n      \r\n      ...buildCustomerParams(customerAddress, formValues.configuration?.specificAddress),\r\n      \r\n      ...buildReturnAddressParams(\r\n        formValues.configuration?.useReturnAddress,\r\n        formValues.configuration\r\n      ),\r\n      \r\n      // Products\r\n      products: products,\r\n      \r\n      // Payment\r\n      pickMoney: packageInfo.codAmount || 0,\r\n      value: formValues.configuration?.orderValue || 0,\r\n      isFreeship: formValues.configuration?.payer === 'SHOP' ? 1 : 0, // ✅ Convert to 0/1\r\n      failedDeliveryFee: formValues.configuration?.failedDeliveryFee, // ✅ Thêm field này\r\n      \r\n      // Package info\r\n      weightOption: shippingSettings.weightUnit,\r\n      totalWeight: products.reduce((sum, p) => sum + p.weight, 0), // ✅ Recalculate\r\n      totalBox: lineItems.reduce((sum, item) => sum + item.quantity, 0), // ✅ Thêm totalBox\r\n      \r\n      // Dates & configuration\r\n      pickDate: formValues.configuration?.pickDate,\r\n      deliverDate: formValues.configuration?.deliverDate,\r\n      pickWorkShift: formValues.configuration?.pickWorkShift,\r\n      deliverWorkShift: formValues.configuration?.deliverWorkShift,\r\n      transport: (formValues.configuration?.transport as 'road' | 'fly') || 'road',\r\n      tags: (formValues.configuration?.ghtkTags as number[]) || [], // ✅ Tags cho GHTK\r\n      note: shippingConfig?.options?.note, // ✅ Shipping note\r\n    };\r\n\r\n    return params;\r\n  }, [\r\n    selectedService,\r\n    customerAddress,\r\n    lineItems,\r\n    packageInfo,\r\n    branchSystemId,\r\n    shippingConfig,\r\n    configuration,\r\n    shippingSettings.weightUnit,\r\n    pickupAddress,\r\n    findBranchById,\r\n    findProductById,\r\n    getValues\r\n  ]);\r\n\r\n  // Handle create shipment order\r\n  const handleCreateShipment = React.useCallback(async () => {\r\n    if (!selectedService || !shippingConfig || !customerAddress || !pickupAddress) {\r\n      toast.error('Thiếu thông tin', { description: 'Vui lòng chọn dịch vụ vận chuyển và cấu hình đầy đủ' });\r\n      return;\r\n    }\r\n\r\n    const formValues = getValues();\r\n    \r\n    // ✅ Comprehensive GHTK validation based on API documentation\r\n    const validationErrors: string[] = [];\r\n    \r\n    // Required pickup fields\r\n    if (!formValues.configuration?.pickAddressId) {\r\n      if (!pickupAddress.name) validationErrors.push('Thiếu tên người liên hệ lấy hàng');\r\n      if (!pickupAddress.address) validationErrors.push('Thiếu địa chỉ lấy hàng');\r\n      if (!pickupAddress.province) validationErrors.push('Thiếu tỉnh/thành lấy hàng');\r\n      // ✅ District is optional for 2-level address\r\n      // if (!pickupAddress.district) validationErrors.push('Thiếu quận/huyện lấy hàng');\r\n      if (!pickupAddress.phone) validationErrors.push('Thiếu số điện thoại lấy hàng');\r\n    }\r\n    \r\n    // Required customer fields\r\n    if (!customerAddress.name) validationErrors.push('Thiếu tên người nhận hàng');\r\n    if (!customerAddress.address) validationErrors.push('Thiếu địa chỉ người nhận');\r\n    if (!customerAddress.province) validationErrors.push('Thiếu tỉnh/thành người nhận');\r\n    // ✅ District is optional for 2-level address (province + ward only)\r\n    // if (!customerAddress.district) validationErrors.push('Thiếu quận/huyện người nhận');\r\n    if (!customerAddress.ward) validationErrors.push('Thiếu phường/xã người nhận');\r\n    if (!customerAddress.phone) validationErrors.push('Thiếu số điện thoại người nhận');\r\n    \r\n    // ✅ Validate return address if \"Địa chỉ khác\" selected\r\n    if (formValues.configuration?.useReturnAddress === 1) {\r\n      if (!formValues.configuration.returnName) validationErrors.push('Thiếu tên người nhận hàng trả');\r\n      if (!formValues.configuration.returnAddress) validationErrors.push('Thiếu địa chỉ trả hàng');\r\n      if (!formValues.configuration.returnProvince) validationErrors.push('Thiếu tỉnh/thành trả hàng');\r\n      // ✅ District is optional for 2-level address\r\n      // if (!formValues.configuration.returnDistrict) validationErrors.push('Thiếu quận/huyện trả hàng');\r\n      if (!formValues.configuration.returnTel) validationErrors.push('Thiếu số điện thoại trả hàng');\r\n    }\r\n    \r\n    // Required: hamlet OR street (GHTK API rule)\r\n    const hasHamlet = customerAddress.address && customerAddress.address.toLowerCase().includes('thôn');\r\n    const hasStreet = customerAddress.address && customerAddress.address.length > 0;\r\n    if (!hasHamlet && !hasStreet) {\r\n      validationErrors.push('Địa chỉ người nhận phải có đường/phố hoặc thôn/ấp/xóm');\r\n    }\r\n    \r\n    // Required: weight > 0\r\n    if (!packageInfo.weight || packageInfo.weight <= 0) {\r\n      validationErrors.push('Khối lượng phải lớn hơn 0');\r\n    }\r\n    \r\n    // Required: value > 0 (insurance value)\r\n    const orderValue = formValues.configuration?.orderValue || grandTotal;\r\n    if (!orderValue || orderValue <= 0) {\r\n      validationErrors.push('Giá trị hàng hoá phải lớn hơn 0');\r\n    }\r\n    \r\n    // Required: products array not empty\r\n    if (!lineItems || lineItems.length === 0) {\r\n      validationErrors.push('Đơn hàng phải có ít nhất 1 sản phẩm');\r\n    }\r\n    \r\n    // Validate work shifts (must be 1 or 2, or undefined)\r\n    if (formValues.configuration?.pickWorkShift && ![1, 2].includes(formValues.configuration.pickWorkShift)) {\r\n      validationErrors.push('Ca lấy hàng phải là 1 (sáng) hoặc 2 (chiều)');\r\n    }\r\n    if (formValues.configuration?.deliverWorkShift && ![1, 2].includes(formValues.configuration.deliverWorkShift)) {\r\n      validationErrors.push('Ca giao hàng phải là 1 (sáng) hoặc 2 (chiều)');\r\n    }\r\n    \r\n    // Show all validation errors\r\n    if (validationErrors.length > 0) {\r\n      console.log('🚨 Validation Errors:', validationErrors);\r\n      // console.log('📍 Customer Address:', customerAddress); // Removed\r\n      // console.log('📦 Pickup Address:', pickupAddress); // Removed\r\n      toast.error('Dữ liệu không hợp lệ', {\r\n        description: validationErrors.join(', '),\r\n        duration: 8000,\r\n      });\r\n      return;\r\n    }\r\n    // ✅ Generate unique order ID for GHTK (DH + YYMMDD + 5 random chars)\r\n    const orderId = formValues.externalReference || generateShippingOrderId();\r\n    const currentBranch = findBranchById(branchSystemId);\r\n    \r\n    if (!currentBranch) {\r\n      toast.error('Không tìm thấy chi nhánh');\r\n      return;\r\n    }\r\n\r\n    setCreatingShipment(true);\r\n\r\n    try {\r\n      // Currently only support GHTK\r\n      if (selectedService.partnerId === 'GHTK') {\r\n        // ✅ Use centralized helper function instead of store\r\n        const { apiToken, partnerCode } = getGHTKCredentials();\r\n        \r\n        const ghtkService = new GHTKService(apiToken, partnerCode);\r\n\r\n        // ✅✅✅ TÁI SỬ DỤNG previewParams - Đảm bảo 100% giống với preview\r\n        const params = {\r\n          ...previewParams,\r\n          orderId: String(orderId), // Override với orderId đã generate\r\n        };\r\n\r\n        console.log('📤 [Create Shipment] Params gửi lên GHTK (100% GIỐNG preview):', params); // ✅ Log để verify\r\n        \r\n        const result = await ghtkService.createOrder(params);\r\n\r\n        if (result.success && result.order) {\r\n          const trackingCode = result.order.label;\r\n          \r\n          // Check for duplicate tracking code\r\n          const existingOrder = getValues().trackingCode;\r\n          if (existingOrder && existingOrder === trackingCode) {\r\n            console.warn('[ShippingIntegration] Duplicate tracking code detected:', trackingCode);\r\n          }\r\n          \r\n          setValue('trackingCode', trackingCode);\r\n          setValue('configuration', { \r\n            ...formValues.configuration,\r\n            ghtkLabel: trackingCode,\r\n            ghtkTrackingId: result.order.tracking_id,\r\n            ghtkEstimatedPickTime: result.order.estimated_pick_time,\r\n            ghtkEstimatedDeliverTime: result.order.estimated_deliver_time,\r\n          });\r\n          \r\n          toast.success('Tạo đơn vận chuyển thành công!', { \r\n            description: `Mã vận đơn: ${trackingCode}` \r\n          });\r\n        } else {\r\n          throw new Error(result.message || 'Không thể tạo đơn vận chuyển');\r\n        }\r\n      } else {\r\n        toast.error('Chưa hỗ trợ', { description: `Chưa hỗ trợ tạo đơn cho ${selectedService.partnerName}` });\r\n      }\r\n    } catch (error) {\r\n      console.error('[ShippingIntegration] Create shipment error:', error);\r\n      \r\n      // Parse error message for better user feedback\r\n      let errorMessage = 'Vui lòng thử lại';\r\n      if (error instanceof Error) {\r\n        errorMessage = error.message;\r\n        \r\n        // Specific error messages\r\n        if (error.message.includes('timeout') || error.message.includes('network')) {\r\n          errorMessage = 'Lỗi kết nối. Vui lòng kiểm tra internet và thử lại.';\r\n        } else if (error.message.includes('token') || error.message.includes('authentication')) {\r\n          errorMessage = 'API Token không hợp lệ. Vui lòng kiểm tra cấu hình.';\r\n        } else if (error.message.includes('address') || error.message.includes('địa chỉ')) {\r\n          errorMessage = 'Địa chỉ không hợp lệ. Vui lòng kiểm tra lại thông tin.';\r\n        }\r\n      }\r\n      \r\n      toast.error('Lỗi tạo đơn vận chuyển', { \r\n        description: errorMessage,\r\n        duration: 5000,\r\n      });\r\n    } finally {\r\n      setCreatingShipment(false);\r\n    }\r\n  }, [selectedService, shippingConfig, customerAddress, pickupAddress, branchSystemId, lineItems, packageInfo, grandTotal, shippingSettings.weightUnit, getValues, setValue, findBranchById, findProductById, partners]);\r\n\r\n  // ⚠️ REMOVED: previewData - Đã merge vào previewParams để tránh duplicate logic\r\n  // previewData đã bị xóa vì nó duplicate logic với previewParams\r\n  // Giờ chỉ dùng DUY NHẤT 1 source of truth: previewParams\r\n\r\n  // ✅ Store previewParams globally for order-form-page to access (avoid infinite loop from setValue)\r\n  React.useEffect(() => {\r\n    if (previewParams && deliveryMethod === 'shipping-partner') {\r\n      (window as any).__ghtkPreviewParams = previewParams;\r\n    }\r\n  }, [previewParams, deliveryMethod]);\r\n\r\n  return (\r\n    <div className=\"space-y-4\">\r\n      {/* Main Delivery Method Selector */}\r\n      {hideTabs ? (\r\n        // ✅ When hideTabs is true (in dialog), don't wrap in Card\r\n        <DeliveryMethodCard\r\n          selectedMethod={deliveryMethod}\r\n          onMethodChange={handleMethodChange}\r\n          shippingRequest={shippingRequest}\r\n          customerAddress={customerAddress}\r\n          packageInfo={packageInfo}\r\n          selectedService={selectedService}\r\n          onServiceSelect={handleServiceSelect}\r\n          onPackageInfoChange={handlePackageInfoChange}\r\n          onServiceConfigChange={handleServiceConfigChange}\r\n          onNoteChange={(note) => setValue('shippingNote', note)}\r\n          grandTotal={grandTotal}\r\n          previewData={previewParams} // ✅ Use auto-generated preview params\r\n          onChangeDeliveryAddress={onChangeDeliveryAddress || (() => {\r\n            toast.info('Cập nhật địa chỉ', { \r\n              description: 'Vui lòng cập nhật địa chỉ khách hàng ở mục \"Thông tin khách hàng\" bên trên' \r\n            });\r\n          })}\r\n          hideTabs={hideTabs}\r\n          disabled={disabled}\r\n        />\r\n      ) : (\r\n        // ✅ When hideTabs is false (in order form page), wrap in Card\r\n        <Card>\r\n          <CardHeader>\r\n            <CardTitle className=\"text-base font-semibold\">Giao hàng</CardTitle>\r\n          </CardHeader>\r\n          <CardContent>\r\n            <DeliveryMethodCard\r\n              selectedMethod={deliveryMethod}\r\n              onMethodChange={handleMethodChange}\r\n              shippingRequest={shippingRequest}\r\n              customerAddress={customerAddress}\r\n              packageInfo={packageInfo}\r\n              selectedService={selectedService}\r\n              onServiceSelect={handleServiceSelect}\r\n              onPackageInfoChange={handlePackageInfoChange}\r\n              onServiceConfigChange={handleServiceConfigChange}\r\n              onNoteChange={(note) => setValue('shippingNote', note)}\r\n              grandTotal={grandTotal}\r\n              previewData={previewParams} // ✅ Use auto-generated preview params\r\n              onChangeDeliveryAddress={onChangeDeliveryAddress || (() => {\r\n                toast.info('Cập nhật địa chỉ', { \r\n                  description: 'Vui lòng cập nhật địa chỉ khách hàng ở mục \"Thông tin khách hàng\" bên trên' \r\n                });\r\n              })}\r\n              hideTabs={hideTabs}\r\n              disabled={disabled}\r\n            />\r\n          </CardContent>\r\n        </Card>\r\n      )}\r\n    </div>\r\n  );\r\n}\r\n\r\n// Export the create shipment function to be used in order-form-page\r\nexport { GHTKService, type GHTKCreateOrderParams };\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 7986, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/orders/components/order-workflow-card.tsx"],"sourcesContent":["import * as React from 'react';\r\nimport { Card, CardContent, CardHeader, CardTitle } from '../../../components/ui/card';\r\nimport { SubtaskList, type Subtask } from '../../../components/shared/subtask-list';\r\nimport type { Order } from '../types';\r\nimport { getWorkflowTemplate } from '../../settings/printer/workflow-templates-page';\r\nimport { toast } from 'sonner';\r\n\r\ninterface OrderWorkflowCardProps {\r\n  order: Order;\r\n  onUpdateOrder: (systemId: string, updates: Partial<Order>) => void;\r\n}\r\n\r\nexport function OrderWorkflowCard({\r\n  order,\r\n  onUpdateOrder,\r\n}: OrderWorkflowCardProps) {\r\n  // Initialize subtasks from template if empty\r\n  const subtasks = React.useMemo((): Subtask[] => {\r\n    if (order.subtasks && order.subtasks.length > 0) {\r\n      // Convert order.subtasks to Subtask[] format\r\n      return order.subtasks.map((s, index) => ({\r\n        id: s.id,\r\n        title: s.title,\r\n        completed: s.completed,\r\n        order: s.order ?? index,\r\n        createdAt: s.createdAt ?? new Date(),\r\n        completedAt: s.completedAt,\r\n        assigneeId: s.assigneeId,\r\n        assigneeName: s.assigneeName,\r\n        parentId: s.parentId,\r\n        metadata: s.metadata,\r\n      }));\r\n    }\r\n    \r\n    // Get default workflow template for orders\r\n    const template = getWorkflowTemplate('orders');\r\n    if (template.length > 0) {\r\n      // Save to order\r\n      onUpdateOrder(order.systemId, { subtasks: template });\r\n      return template;\r\n    }\r\n    \r\n    return [];\r\n  }, [order.subtasks, order.systemId, onUpdateOrder]);\r\n\r\n  const handleToggleComplete = React.useCallback(\r\n    (id: string, completed: boolean) => {\r\n      const toggledSubtask = subtasks.find((s) => s.id === id);\r\n      if (!toggledSubtask) return;\r\n\r\n      const updatedSubtasks = subtasks.map((subtask) =>\r\n        subtask.id === id \r\n          ? { ...subtask, completed, completedAt: completed ? new Date() : undefined } \r\n          : subtask\r\n      );\r\n\r\n      onUpdateOrder(order.systemId, { subtasks: updatedSubtasks });\r\n\r\n      const action = completed ? 'Hoàn thành bước' : 'Bỏ hoàn thành bước';\r\n      toast.success(`${action}: ${toggledSubtask.title}`);\r\n    },\r\n    [subtasks, order.systemId, onUpdateOrder]\r\n  );\r\n\r\n  const handleAllCompleted = React.useCallback(() => {\r\n    toast.success('Đã hoàn thành toàn bộ quy trình xử lý đơn hàng!');\r\n  }, []);\r\n\r\n  // Show message if no workflow template is configured for orders\r\n  if (subtasks.length === 0) {\r\n    return (\r\n      <Card className=\"border-dashed\">\r\n        <CardHeader>\r\n          <CardTitle className=\"text-base font-semibold\">Quy trình xử lý</CardTitle>\r\n        </CardHeader>\r\n        <CardContent>\r\n          <div className=\"text-center py-4 text-muted-foreground\">\r\n            <p className=\"text-sm\">Chưa cấu hình quy trình</p>\r\n            <p className=\"text-xs mt-1\">\r\n              Vào <a href=\"/settings/workflow-templates\" className=\"text-primary hover:underline\">Cài đặt → Quy trình</a> để thiết lập\r\n            </p>\r\n          </div>\r\n        </CardContent>\r\n      </Card>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <Card>\r\n      <CardHeader>\r\n        <CardTitle className=\"text-base font-semibold\">Quy trình xử lý</CardTitle>\r\n      </CardHeader>\r\n      <CardContent>\r\n        <SubtaskList\r\n          subtasks={subtasks}\r\n          onToggleComplete={handleToggleComplete}\r\n          onAllCompleted={handleAllCompleted}\r\n          showProgress\r\n          readonly\r\n          compact={false}\r\n        />\r\n      </CardContent>\r\n    </Card>\r\n  );\r\n}\r\n"],"names":[],"mappings":";;;;;AAAA;AACA;AACA;AAEA;AAAA;AACA;;;;;;;AAOO,SAAS,kBAAkB,EAChC,KAAK,EACL,aAAa,EACU;IACvB,6CAA6C;IAC7C,MAAM,WAAW,gNAAa,CAAC;QAC7B,IAAI,MAAM,QAAQ,IAAI,MAAM,QAAQ,CAAC,MAAM,GAAG,GAAG;YAC/C,6CAA6C;YAC7C,OAAO,MAAM,QAAQ,CAAC,GAAG,CAAC,CAAC,GAAG,QAAU,CAAC;oBACvC,IAAI,EAAE,EAAE;oBACR,OAAO,EAAE,KAAK;oBACd,WAAW,EAAE,SAAS;oBACtB,OAAO,EAAE,KAAK,IAAI;oBAClB,WAAW,EAAE,SAAS,IAAI,IAAI;oBAC9B,aAAa,EAAE,WAAW;oBAC1B,YAAY,EAAE,UAAU;oBACxB,cAAc,EAAE,YAAY;oBAC5B,UAAU,EAAE,QAAQ;oBACpB,UAAU,EAAE,QAAQ;gBACtB,CAAC;QACH;QAEA,2CAA2C;QAC3C,MAAM,WAAW,IAAA,8NAAmB,EAAC;QACrC,IAAI,SAAS,MAAM,GAAG,GAAG;YACvB,gBAAgB;YAChB,cAAc,MAAM,QAAQ,EAAE;gBAAE,UAAU;YAAS;YACnD,OAAO;QACT;QAEA,OAAO,EAAE;IACX,GAAG;QAAC,MAAM,QAAQ;QAAE,MAAM,QAAQ;QAAE;KAAc;IAElD,MAAM,uBAAuB,oNAAiB,CAC5C,CAAC,IAAY;QACX,MAAM,iBAAiB,SAAS,IAAI,CAAC,CAAC,IAAM,EAAE,EAAE,KAAK;QACrD,IAAI,CAAC,gBAAgB;QAErB,MAAM,kBAAkB,SAAS,GAAG,CAAC,CAAC,UACpC,QAAQ,EAAE,KAAK,KACX;gBAAE,GAAG,OAAO;gBAAE;gBAAW,aAAa,YAAY,IAAI,SAAS;YAAU,IACzE;QAGN,cAAc,MAAM,QAAQ,EAAE;YAAE,UAAU;QAAgB;QAE1D,MAAM,SAAS,YAAY,oBAAoB;QAC/C,iJAAK,CAAC,OAAO,CAAC,GAAG,OAAO,EAAE,EAAE,eAAe,KAAK,EAAE;IACpD,GACA;QAAC;QAAU,MAAM,QAAQ;QAAE;KAAc;IAG3C,MAAM,qBAAqB,oNAAiB,CAAC;QAC3C,iJAAK,CAAC,OAAO,CAAC;IAChB,GAAG,EAAE;IAEL,gEAAgE;IAChE,IAAI,SAAS,MAAM,KAAK,GAAG;QACzB,qBACE,8OAAC,iIAAI;YAAC,WAAU;;8BACd,8OAAC,uIAAU;8BACT,cAAA,8OAAC,sIAAS;wBAAC,WAAU;kCAA0B;;;;;;;;;;;8BAEjD,8OAAC,wIAAW;8BACV,cAAA,8OAAC;wBAAI,WAAU;;0CACb,8OAAC;gCAAE,WAAU;0CAAU;;;;;;0CACvB,8OAAC;gCAAE,WAAU;;oCAAe;kDACtB,8OAAC;wCAAE,MAAK;wCAA+B,WAAU;kDAA+B;;;;;;oCAAuB;;;;;;;;;;;;;;;;;;;;;;;;IAMvH;IAEA,qBACE,8OAAC,iIAAI;;0BACH,8OAAC,uIAAU;0BACT,cAAA,8OAAC,sIAAS;oBAAC,WAAU;8BAA0B;;;;;;;;;;;0BAEjD,8OAAC,wIAAW;0BACV,cAAA,8OAAC,uJAAW;oBACV,UAAU;oBACV,kBAAkB;oBAClB,gBAAgB;oBAChB,YAAY;oBACZ,QAAQ;oBACR,SAAS;;;;;;;;;;;;;;;;;AAKnB"}},
    {"offset": {"line": 8171, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/orders/components/order-print-button.tsx"],"sourcesContent":["/**\r\n * Order Print Button with Dropdown\r\n * Nút In với dropdown menu để chọn khổ giấy\r\n */\r\n\r\nimport * as React from 'react';\r\nimport { Button } from '../../../components/ui/button';\r\nimport { \r\n  DropdownMenu, \r\n  DropdownMenuContent, \r\n  DropdownMenuItem, \r\n  DropdownMenuTrigger \r\n} from '../../../components/ui/dropdown-menu';\r\nimport { Printer, ChevronDown, Check } from 'lucide-react';\r\nimport { usePrint } from '../../../lib/use-print';\r\nimport type { PaperSize } from '../../settings/printer/types';\r\nimport type { Order } from '../types';\r\nimport type { Customer } from '../../customers/types';\r\nimport type { Branch } from '../../settings/branches/types';\r\nimport type { Employee } from '../../employees/types';\r\nimport { \r\n  convertOrderForPrint,\r\n  mapOrderToPrintData,\r\n  mapOrderLineItems,\r\n  createStoreSettings,\r\n} from '../../../lib/print/order-print-helper';\r\n\r\nconst PAPER_SIZES: { value: PaperSize; label: string }[] = [\r\n  { value: 'K57', label: 'K57 (57mm)' },\r\n  { value: 'K80', label: 'K80 (80mm)' },\r\n  { value: 'A5', label: 'A5' },\r\n  { value: 'A4', label: 'A4' },\r\n];\r\n\r\ninterface OrderPrintButtonProps {\r\n  order: Order;\r\n  customer?: Customer | null;\r\n  branch?: Branch | null;\r\n  createdByEmployee?: Employee | null;\r\n  logoUrl?: string | null;\r\n}\r\n\r\nexport function OrderPrintButton({\r\n  order,\r\n  customer,\r\n  branch,\r\n  createdByEmployee,\r\n  logoUrl,\r\n}: OrderPrintButtonProps) {\r\n  const { print, getDefaultSize } = usePrint(branch?.systemId);\r\n\r\n  const handlePrint = React.useCallback((paperSize?: PaperSize) => {\r\n    const storeSettings = createStoreSettings(branch, { logo: logoUrl });\r\n    const size = paperSize || getDefaultSize('order');\r\n    const orderData = convertOrderForPrint(order, { customer, createdByEmployee });\r\n    \r\n    print('order', {\r\n      data: mapOrderToPrintData(orderData, storeSettings),\r\n      lineItems: mapOrderLineItems(orderData.items),\r\n      paperSize: size,\r\n    });\r\n  }, [order, customer, branch, createdByEmployee, logoUrl, print, getDefaultSize]);\r\n\r\n  // In đơn hàng mặc định\r\n  const handleDefaultPrint = React.useCallback(() => {\r\n    handlePrint();\r\n  }, [handlePrint]);\r\n\r\n  const defaultSize = getDefaultSize('order');\r\n\r\n  return (\r\n    <div className=\"flex\">\r\n      {/* Nút In chính - In đơn hàng với khổ giấy mặc định */}\r\n      <Button\r\n        variant=\"outline\"\r\n        size=\"sm\"\r\n        className=\"h-7 rounded-r-none border-r-0\"\r\n        onClick={handleDefaultPrint}\r\n      >\r\n        <Printer className=\"mr-2 h-4 w-4\" />\r\n        In\r\n      </Button>\r\n\r\n      {/* Dropdown để chọn khổ giấy */}\r\n      <DropdownMenu>\r\n        <DropdownMenuTrigger asChild>\r\n          <Button\r\n            variant=\"outline\"\r\n            size=\"sm\"\r\n            className=\"h-7 px-1.5 rounded-l-none\"\r\n          >\r\n            <ChevronDown className=\"h-4 w-4\" />\r\n          </Button>\r\n        </DropdownMenuTrigger>\r\n        <DropdownMenuContent align=\"end\">\r\n          {PAPER_SIZES.map((size) => (\r\n            <DropdownMenuItem \r\n              key={size.value}\r\n              onClick={() => handlePrint(size.value)}\r\n            >\r\n              {size.value === defaultSize && <Check className=\"mr-2 h-4 w-4\" />}\r\n              {size.value !== defaultSize && <span className=\"mr-6\" />}\r\n              {size.label}\r\n            </DropdownMenuItem>\r\n          ))}\r\n        </DropdownMenuContent>\r\n      </DropdownMenu>\r\n    </div>\r\n  );\r\n}\r\n"],"names":[],"mappings":";;;;;AAAA;;;CAGC,GAED;AACA;AACA;AAMA;AAAA;AAAA;AACA;AAMA;AAAA;;;;;;;;AAOA,MAAM,cAAqD;IACzD;QAAE,OAAO;QAAO,OAAO;IAAa;IACpC;QAAE,OAAO;QAAO,OAAO;IAAa;IACpC;QAAE,OAAO;QAAM,OAAO;IAAK;IAC3B;QAAE,OAAO;QAAM,OAAO;IAAK;CAC5B;AAUM,SAAS,iBAAiB,EAC/B,KAAK,EACL,QAAQ,EACR,MAAM,EACN,iBAAiB,EACjB,OAAO,EACe;IACtB,MAAM,EAAE,KAAK,EAAE,cAAc,EAAE,GAAG,IAAA,+HAAQ,EAAC,QAAQ;IAEnD,MAAM,cAAc,oNAAiB,CAAC,CAAC;QACrC,MAAM,gBAAgB,IAAA,+KAAmB,EAAC,QAAQ;YAAE,MAAM;QAAQ;QAClE,MAAM,OAAO,aAAa,eAAe;QACzC,MAAM,YAAY,IAAA,gLAAoB,EAAC,OAAO;YAAE;YAAU;QAAkB;QAE5E,MAAM,SAAS;YACb,MAAM,IAAA,iKAAmB,EAAC,WAAW;YACrC,WAAW,IAAA,+JAAiB,EAAC,UAAU,KAAK;YAC5C,WAAW;QACb;IACF,GAAG;QAAC;QAAO;QAAU;QAAQ;QAAmB;QAAS;QAAO;KAAe;IAE/E,uBAAuB;IACvB,MAAM,qBAAqB,oNAAiB,CAAC;QAC3C;IACF,GAAG;QAAC;KAAY;IAEhB,MAAM,cAAc,eAAe;IAEnC,qBACE,8OAAC;QAAI,WAAU;;0BAEb,8OAAC,qIAAM;gBACL,SAAQ;gBACR,MAAK;gBACL,WAAU;gBACV,SAAS;;kCAET,8OAAC,mNAAO;wBAAC,WAAU;;;;;;oBAAiB;;;;;;;0BAKtC,8OAAC,qJAAY;;kCACX,8OAAC,4JAAmB;wBAAC,OAAO;kCAC1B,cAAA,8OAAC,qIAAM;4BACL,SAAQ;4BACR,MAAK;4BACL,WAAU;sCAEV,cAAA,8OAAC,mOAAW;gCAAC,WAAU;;;;;;;;;;;;;;;;kCAG3B,8OAAC,4JAAmB;wBAAC,OAAM;kCACxB,YAAY,GAAG,CAAC,CAAC,qBAChB,8OAAC,yJAAgB;gCAEf,SAAS,IAAM,YAAY,KAAK,KAAK;;oCAEpC,KAAK,KAAK,KAAK,6BAAe,8OAAC,6MAAK;wCAAC,WAAU;;;;;;oCAC/C,KAAK,KAAK,KAAK,6BAAe,8OAAC;wCAAK,WAAU;;;;;;oCAC9C,KAAK,KAAK;;+BALN,KAAK,KAAK;;;;;;;;;;;;;;;;;;;;;;AAY7B"}}]
}