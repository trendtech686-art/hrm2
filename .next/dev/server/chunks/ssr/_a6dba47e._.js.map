{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/lib/pkgx/api-service.ts"],"sourcesContent":["import { usePkgxSettingsStore } from '../../features/settings/pkgx/store';\r\nimport type {\r\n  PkgxProduct,\r\n  PkgxProductsResponse,\r\n  PkgxProductPayload,\r\n  PkgxImageUploadResponse,\r\n  PkgxCategoriesResponse,\r\n  PkgxBrandsResponse,\r\n  PkgxBrandFromApi,\r\n  PkgxGalleryResponse,\r\n  PkgxGalleryImage,\r\n} from '../../features/settings/pkgx/types';\r\nimport { PKGX_API_CONFIG } from '../../features/settings/pkgx/constants';\r\n\r\n// ========================================\r\n// Types\r\n// ========================================\r\n\r\ntype ApiResponse<T> = {\r\n  success: boolean;\r\n  data?: T;\r\n  error?: string;\r\n};\r\n\r\ntype CreateProductResponse = {\r\n  error: boolean;\r\n  message: string;\r\n  goods_id: number;\r\n  created_slug: string;\r\n};\r\n\r\ntype UpdateProductResponse = {\r\n  error: boolean;\r\n  message: string;\r\n  goods_id: number;\r\n  updated_slug?: string;\r\n};\r\n\r\n// ========================================\r\n// Helper Functions\r\n// ========================================\r\n\r\nfunction getApiConfig() {\r\n  const { settings } = usePkgxSettingsStore.getState();\r\n  return {\r\n    apiUrl: settings.apiUrl || PKGX_API_CONFIG.baseUrl,\r\n    apiKey: settings.apiKey,\r\n    enabled: settings.enabled,\r\n  };\r\n}\r\n\r\nasync function fetchWithAuth<T>(url: string, options: RequestInit = {}): Promise<ApiResponse<T>> {\r\n  const { apiKey, enabled } = getApiConfig();\r\n\r\n  if (!enabled) {\r\n    return { success: false, error: 'Tích hợp PKGX chưa được bật' };\r\n  }\r\n\r\n  if (!apiKey) {\r\n    return { success: false, error: 'Chưa cấu hình API Key' };\r\n  }\r\n\r\n  // DEBUG: Log request details\r\n  console.log('[PKGX fetchWithAuth] URL:', url);\r\n  console.log('[PKGX fetchWithAuth] Method:', options.method || 'GET');\r\n  console.log('[PKGX fetchWithAuth] Headers:', options.headers);\r\n  if (options.body) {\r\n    console.log('[PKGX fetchWithAuth] Body (raw):', options.body);\r\n    console.log('[PKGX fetchWithAuth] Body type:', typeof options.body);\r\n  }\r\n\r\n  try {\r\n    const fetchOptions: RequestInit = {\r\n      ...options,\r\n      mode: 'cors',\r\n      credentials: 'omit',\r\n      headers: {\r\n        'X-API-KEY': apiKey,\r\n        'Content-Type': 'application/json',\r\n        ...options.headers,\r\n      },\r\n    };\r\n    console.log('[PKGX fetchWithAuth] Full fetch options:', JSON.stringify(fetchOptions, null, 2));\r\n    \r\n    const response = await fetch(url, fetchOptions);\r\n\r\n    const responseText = await response.text();\r\n    console.log('[PKGX fetchWithAuth] Response text:', responseText);\r\n    \r\n    const data = JSON.parse(responseText);\r\n    \r\n    // DEBUG: Log response\r\n    console.log('[PKGX fetchWithAuth] Response status:', response.status);\r\n    console.log('[PKGX fetchWithAuth] Response data:', data);\r\n\r\n    if (data.error) {\r\n      return { success: false, error: data.message || 'Lỗi từ server PKGX' };\r\n    }\r\n\r\n    return { success: true, data };\r\n  } catch (error) {\r\n    return {\r\n      success: false,\r\n      error: error instanceof Error ? error.message : 'Không thể kết nối đến server PKGX',\r\n    };\r\n  }\r\n}\r\n\r\n// ========================================\r\n// API Functions\r\n// ========================================\r\n\r\n/**\r\n * Lấy danh sách danh mục từ PKGX\r\n */\r\nexport async function getCategories(): Promise<ApiResponse<PkgxCategoriesResponse>> {\r\n  const { apiUrl } = getApiConfig();\r\n  const url = `${apiUrl}?action=get_categories`;\r\n  return fetchWithAuth<PkgxCategoriesResponse>(url, { method: 'GET' });\r\n}\r\n\r\n/**\r\n * Lấy danh sách thương hiệu từ PKGX\r\n */\r\nexport async function getBrands(): Promise<ApiResponse<PkgxBrandsResponse>> {\r\n  const { apiUrl } = getApiConfig();\r\n  const url = `${apiUrl}?action=get_brands`;\r\n  return fetchWithAuth<PkgxBrandsResponse>(url, { method: 'GET' });\r\n}\r\n\r\n/**\r\n * Lấy chi tiết 1 thương hiệu từ PKGX theo brand_id\r\n */\r\nexport async function getBrandById(brandId: number): Promise<ApiResponse<PkgxBrandFromApi | null>> {\r\n  const { apiUrl } = getApiConfig();\r\n  const url = `${apiUrl}?action=get_brands&brand_id=${brandId}`;\r\n  \r\n  const response = await fetchWithAuth<{ error: boolean; message: string; data: PkgxBrandFromApi }>(url, { method: 'GET' });\r\n  \r\n  if (!response.success || !response.data) {\r\n    return { success: false, error: response.error };\r\n  }\r\n  \r\n  return { success: true, data: response.data.data };\r\n}\r\n\r\n/**\r\n * Lấy danh sách sản phẩm từ PKGX (có phân trang)\r\n */\r\nexport async function getProducts(\r\n  page: number = 1,\r\n  limit: number = 50\r\n): Promise<ApiResponse<PkgxProductsResponse>> {\r\n  const { apiUrl } = getApiConfig();\r\n  const url = `${apiUrl}?action=get_products&page=${page}&limit=${limit}`;\r\n  return fetchWithAuth<PkgxProductsResponse>(url, { method: 'GET' });\r\n}\r\n\r\n/**\r\n * Lấy tất cả sản phẩm từ PKGX (tự động phân trang)\r\n */\r\nexport async function getAllProducts(): Promise<ApiResponse<PkgxProduct[]>> {\r\n  const allProducts: PkgxProduct[] = [];\r\n  let currentPage = 1;\r\n  let totalPages = 1;\r\n\r\n  while (currentPage <= totalPages) {\r\n    const response = await getProducts(currentPage, 100);\r\n\r\n    if (!response.success || !response.data) {\r\n      return { success: false, error: response.error };\r\n    }\r\n\r\n    allProducts.push(...response.data.data);\r\n    totalPages = response.data.pagination.total_pages;\r\n    currentPage++;\r\n  }\r\n\r\n  return { success: true, data: allProducts };\r\n}\r\n\r\n/**\r\n * Lấy sản phẩm theo goods_id (sử dụng API get_products với filter)\r\n */\r\nexport async function getProductById(goodsId: number): Promise<ApiResponse<PkgxProduct | null>> {\r\n  const { apiUrl } = getApiConfig();\r\n  // API không có action=get_product, dùng get_products với goods_id filter\r\n  const url = `${apiUrl}?action=get_products&goods_id=${goodsId}`;\r\n  \r\n  const response = await fetchWithAuth<PkgxProductsResponse>(url, { method: 'GET' });\r\n  \r\n  if (!response.success || !response.data) {\r\n    return { success: false, error: response.error };\r\n  }\r\n  \r\n  // Trả về sản phẩm đầu tiên nếu có\r\n  const product = response.data.data?.[0] || null;\r\n  return { success: true, data: product };\r\n}\r\n\r\n/**\r\n * Lấy gallery ảnh sản phẩm theo goods_id\r\n * Note: Cần API endpoint `get_gallery` trên server PKGX\r\n */\r\nexport async function getProductGallery(goodsId: number): Promise<ApiResponse<PkgxGalleryImage[]>> {\r\n  const { apiUrl } = getApiConfig();\r\n  const url = `${apiUrl}?action=get_gallery&goods_id=${goodsId}`;\r\n  \r\n  try {\r\n    const response = await fetchWithAuth<PkgxGalleryResponse>(url, { method: 'GET' });\r\n    \r\n    // Debug log\r\n    console.log('Gallery API response:', response);\r\n    \r\n    if (!response.success) {\r\n      // Nếu API chưa có hoặc lỗi, trả về mảng rỗng\r\n      console.log('Gallery API error:', response.error);\r\n      return { success: true, data: [] };\r\n    }\r\n    \r\n    // response.data chứa toàn bộ response từ API: { error, message, goods_id, total, data }\r\n    const galleryData = response.data as PkgxGalleryResponse;\r\n    return { success: true, data: galleryData.data || [] };\r\n  } catch (error) {\r\n    console.error('Gallery API exception:', error);\r\n    return { success: true, data: [] }; // Fallback to empty array\r\n  }\r\n}\r\n\r\n/**\r\n * Tạo sản phẩm mới trên PKGX\r\n */\r\nexport async function createProduct(\r\n  payload: PkgxProductPayload\r\n): Promise<ApiResponse<CreateProductResponse>> {\r\n  const { apiUrl } = getApiConfig();\r\n  const url = `${apiUrl}?action=create_product`;\r\n\r\n  return fetchWithAuth<CreateProductResponse>(url, {\r\n    method: 'POST',\r\n    headers: { 'Content-Type': 'application/json' },\r\n    body: JSON.stringify(payload),\r\n  });\r\n}\r\n\r\n/**\r\n * Cập nhật sản phẩm trên PKGX\r\n */\r\nexport async function updateProduct(\r\n  goodsId: number,\r\n  payload: Partial<PkgxProductPayload>\r\n): Promise<ApiResponse<UpdateProductResponse>> {\r\n  const { apiUrl } = getApiConfig();\r\n  const url = `${apiUrl}?action=update_product&goods_id=${goodsId}`;\r\n\r\n  return fetchWithAuth<UpdateProductResponse>(url, {\r\n    method: 'POST',\r\n    headers: { 'Content-Type': 'application/json' },\r\n    body: JSON.stringify(payload),\r\n  });\r\n}\r\n\r\n/**\r\n * Cập nhật giá sản phẩm\r\n */\r\nexport async function updateProductPrice(\r\n  goodsId: number,\r\n  prices: {\r\n    shop_price?: number;\r\n    market_price?: number;\r\n    partner_price?: number;\r\n    ace_price?: number;\r\n    deal_price?: number;\r\n  }\r\n): Promise<ApiResponse<UpdateProductResponse>> {\r\n  return updateProduct(goodsId, prices);\r\n}\r\n\r\n/**\r\n * Cập nhật SEO sản phẩm\r\n */\r\nexport async function updateProductSeo(\r\n  goodsId: number,\r\n  seo: {\r\n    meta_title?: string;\r\n    meta_desc?: string;\r\n    keywords?: string;\r\n  }\r\n): Promise<ApiResponse<UpdateProductResponse>> {\r\n  return updateProduct(goodsId, seo);\r\n}\r\n\r\n/**\r\n * Cập nhật tồn kho sản phẩm\r\n */\r\nexport async function updateProductStock(\r\n  goodsId: number,\r\n  goodsNumber: number\r\n): Promise<ApiResponse<UpdateProductResponse>> {\r\n  return updateProduct(goodsId, { goods_number: goodsNumber });\r\n}\r\n\r\n/**\r\n * Upload ảnh sản phẩm lên PKGX\r\n */\r\nexport async function uploadProductImage(\r\n  imageFile: File,\r\n  options?: {\r\n    filenameSlug?: string;\r\n    goodsId?: number;\r\n  }\r\n): Promise<ApiResponse<PkgxImageUploadResponse>> {\r\n  const { apiUrl, apiKey, enabled } = getApiConfig();\r\n\r\n  if (!enabled) {\r\n    return { success: false, error: 'Tích hợp PKGX chưa được bật' };\r\n  }\r\n\r\n  if (!apiKey) {\r\n    return { success: false, error: 'Chưa cấu hình API Key' };\r\n  }\r\n\r\n  const url = `${apiUrl}?action=upload_product_image`;\r\n  const formData = new FormData();\r\n  formData.append('image_file', imageFile);\r\n\r\n  if (options?.filenameSlug) {\r\n    formData.append('filename_slug', options.filenameSlug);\r\n  }\r\n\r\n  if (options?.goodsId) {\r\n    formData.append('goods_id', options.goodsId.toString());\r\n  }\r\n\r\n  try {\r\n    const response = await fetch(url, {\r\n      method: 'POST',\r\n      headers: { 'X-API-KEY': apiKey },\r\n      body: formData,\r\n    });\r\n\r\n    const data = await response.json();\r\n\r\n    if (data.error) {\r\n      return { success: false, error: data.message };\r\n    }\r\n\r\n    return { success: true, data };\r\n  } catch (error) {\r\n    return {\r\n      success: false,\r\n      error: error instanceof Error ? error.message : 'Không thể upload ảnh',\r\n    };\r\n  }\r\n}\r\n\r\n/**\r\n * Upload ảnh từ URL (server-to-server, tránh CORS)\r\n * Server PKGX sẽ tự download ảnh từ URL rồi xử lý\r\n */\r\nexport async function uploadImageFromUrl(\r\n  imageUrl: string,\r\n  options?: {\r\n    filenameSlug?: string;\r\n    goodsId?: number;\r\n  }\r\n): Promise<ApiResponse<PkgxImageUploadResponse>> {\r\n  const { apiUrl, apiKey, enabled } = getApiConfig();\r\n\r\n  if (!enabled) {\r\n    return { success: false, error: 'Tích hợp PKGX chưa được bật' };\r\n  }\r\n\r\n  if (!apiKey) {\r\n    return { success: false, error: 'Chưa cấu hình API Key' };\r\n  }\r\n\r\n  const url = `${apiUrl}?action=upload_image_from_url`;\r\n  \r\n  const payload: Record<string, unknown> = {\r\n    image_url: imageUrl,\r\n  };\r\n\r\n  if (options?.filenameSlug) {\r\n    payload.filename_slug = options.filenameSlug;\r\n  }\r\n\r\n  if (options?.goodsId) {\r\n    payload.goods_id = options.goodsId;\r\n  }\r\n\r\n  try {\r\n    const response = await fetch(url, {\r\n      method: 'POST',\r\n      headers: { \r\n        'X-API-KEY': apiKey,\r\n        'Content-Type': 'application/json',\r\n      },\r\n      body: JSON.stringify(payload),\r\n    });\r\n\r\n    const data = await response.json();\r\n\r\n    if (data.error) {\r\n      return { success: false, error: data.message };\r\n    }\r\n\r\n    return { success: true, data };\r\n  } catch (error) {\r\n    return {\r\n      success: false,\r\n      error: error instanceof Error ? error.message : 'Không thể upload ảnh từ URL',\r\n    };\r\n  }\r\n}\r\n\r\n/**\r\n * Lấy chi tiết danh mục theo cat_id (bao gồm SEO fields)\r\n */\r\nexport async function getCategoryById(catId: number): Promise<ApiResponse<PkgxCategoriesResponse>> {\r\n  const { apiUrl } = getApiConfig();\r\n  const url = `${apiUrl}?action=get_categories&cat_id=${catId}`;\r\n  return fetchWithAuth<PkgxCategoriesResponse>(url, { method: 'GET' });\r\n}\r\n\r\n/**\r\n * Cập nhật thông tin danh mục (SEO, mô tả)\r\n * \r\n * Các trường hỗ trợ:\r\n * - cat_name: Tên danh mục\r\n * - cat_desc: Mô tả chi tiết (HTML) - tương đương longDescription\r\n * - keywords: Từ khóa SEO - tương đương seoKeywords\r\n * - cat_alias: Slug URL\r\n * - meta_title: Tiêu đề SEO (NEW)\r\n * - meta_desc: Mô tả SEO (NEW)\r\n * - short_desc: Mô tả ngắn (NEW)\r\n */\r\nexport async function updateCategory(\r\n  catId: number,\r\n  payload: {\r\n    cat_name?: string;\r\n    cat_desc?: string;  // Mô tả ngắn (shortDescription)\r\n    long_desc?: string; // Mô tả dài (longDescription) - HTML\r\n    keywords?: string;\r\n    cat_alias?: string;\r\n    // SEO fields\r\n    meta_title?: string;\r\n    meta_desc?: string;\r\n  }\r\n): Promise<ApiResponse<{ error: boolean; message: string; cat_id: number }>> {\r\n  const { apiUrl } = getApiConfig();\r\n  // Add timestamp to bust cache\r\n  const timestamp = Date.now();\r\n  const url = `${apiUrl}?action=update_category&cat_id=${catId}&_t=${timestamp}`;\r\n\r\n  console.log('[updateCategory] Calling with catId:', catId, 'payload:', payload);\r\n\r\n  return fetchWithAuth(url, {\r\n    method: 'POST',\r\n    headers: { 'Content-Type': 'application/json' },\r\n    body: JSON.stringify(payload),\r\n  });\r\n}\r\n\r\n/**\r\n * Cập nhật thông tin cơ bản danh mục (tên, parent, hiển thị)\r\n * URL: POST ?action=update_category_basic&cat_id=123\r\n * \r\n * Các trường hỗ trợ:\r\n * - cat_name: Tên danh mục\r\n * - parent_id: ID danh mục cha (0 = gốc)\r\n * - is_show: 1 = Hiển thị, 0 = Ẩn (Display in Category Home)\r\n */\r\nexport async function updateCategoryBasic(\r\n  catId: number,\r\n  payload: {\r\n    cat_name?: string;\r\n    parent_id?: number;\r\n    is_show?: number; // 1 = hiển thị, 0 = ẩn\r\n  }\r\n): Promise<ApiResponse<{ error: boolean; message: string; cat_id: number; changes?: Record<string, { old: unknown; new: unknown }> }>> {\r\n  const { apiUrl } = getApiConfig();\r\n  const timestamp = Date.now();\r\n  const url = `${apiUrl}?action=update_category_basic&cat_id=${catId}&_t=${timestamp}`;\r\n\r\n  console.log('[updateCategoryBasic] Calling with catId:', catId, 'payload:', payload);\r\n\r\n  return fetchWithAuth(url, {\r\n    method: 'POST',\r\n    headers: { 'Content-Type': 'application/json' },\r\n    body: JSON.stringify(payload),\r\n  });\r\n}\r\n\r\n/**\r\n * Cập nhật thông tin thương hiệu (SEO, mô tả)\r\n * \r\n * Các trường hỗ trợ:\r\n * - brand_name: Tên thương hiệu\r\n * - brand_desc: Mô tả chi tiết (HTML) - tương đương longDescription\r\n * - site_url: Website URL\r\n * - keywords: Từ khóa SEO (NEW) - tương đương seoKeywords\r\n * - meta_title: Tiêu đề SEO (NEW)\r\n * - meta_desc: Mô tả SEO (NEW)\r\n * - short_desc: Mô tả ngắn (NEW)\r\n * - long_desc: Mô tả dài (NEW)\r\n */\r\nexport async function updateBrand(\r\n  brandId: number,\r\n  payload: {\r\n    brand_name?: string;\r\n    brand_desc?: string;\r\n    site_url?: string;\r\n    // SEO fields (NEW)\r\n    keywords?: string;\r\n    meta_title?: string;\r\n    meta_desc?: string;\r\n    short_desc?: string;\r\n    long_desc?: string;\r\n  }\r\n): Promise<ApiResponse<{ error: boolean; message: string; brand_id: number }>> {\r\n  const { apiUrl } = getApiConfig();\r\n  const url = `${apiUrl}?action=update_brand&brand_id=${brandId}`;\r\n\r\n  return fetchWithAuth(url, {\r\n    method: 'POST',\r\n    headers: { 'Content-Type': 'application/json' },\r\n    body: JSON.stringify(payload),\r\n  });\r\n}\r\n\r\n/**\r\n * Test kết nối API\r\n */\r\nexport async function testConnection(): Promise<ApiResponse<{ productCount: number }>> {\r\n  const response = await getProducts(1, 1);\r\n\r\n  if (!response.success) {\r\n    return { success: false, error: response.error };\r\n  }\r\n\r\n  return {\r\n    success: true,\r\n    data: { productCount: response.data?.pagination.total_items || 0 },\r\n  };\r\n}\r\n\r\n// ========================================\r\n// Member Price API (Giá thành viên)\r\n// ========================================\r\n\r\ntype MemberRank = {\r\n  rank_id: number;\r\n  rank_name: string;\r\n  min_points: number;\r\n  max_points: number;\r\n  discount: number;\r\n  special_rank: number;\r\n};\r\n\r\ntype MemberRanksResponse = {\r\n  error: boolean;\r\n  message: string;\r\n  total: number;\r\n  data: MemberRank[];\r\n};\r\n\r\ntype MemberPriceResult = {\r\n  user_rank: number;\r\n  rank_name?: string;\r\n  user_price?: number;\r\n  status: 'updated' | 'deleted' | 'skipped';\r\n  reason?: string;\r\n};\r\n\r\ntype CurrentMemberPrice = {\r\n  user_rank: string;\r\n  user_price: string;\r\n  rank_name: string;\r\n};\r\n\r\ntype UpdateMemberPriceResponse = {\r\n  error: boolean;\r\n  message: string;\r\n  goods_id: number;\r\n  goods_name: string;\r\n  results: MemberPriceResult[];\r\n  current_member_prices: CurrentMemberPrice[];\r\n};\r\n\r\n/**\r\n * Lấy danh sách hạng thành viên từ PKGX\r\n */\r\nexport async function getMemberRanks(): Promise<ApiResponse<MemberRanksResponse>> {\r\n  const { apiUrl } = getApiConfig();\r\n  const url = `${apiUrl}?action=get_member_ranks`;\r\n  return fetchWithAuth<MemberRanksResponse>(url, { method: 'GET' });\r\n}\r\n\r\n/**\r\n * Cập nhật giá thành viên cho sản phẩm\r\n * \r\n * @param goodsId - ID sản phẩm trên PKGX\r\n * @param memberPrices - Mảng giá thành viên theo user_rank\r\n * \r\n * Ví dụ:\r\n * - Cập nhật 1 giá: updateMemberPrice(8014, [{ user_rank: 8, user_price: 2200000 }])\r\n * - Cập nhật nhiều: updateMemberPrice(8014, [{ user_rank: 8, user_price: 2200000 }, { user_rank: 9, user_price: 1800000 }])\r\n * - Xóa giá (set = 0): updateMemberPrice(8014, [{ user_rank: 8, user_price: 0 }])\r\n */\r\nexport async function updateMemberPrice(\r\n  goodsId: number,\r\n  memberPrices: Array<{ user_rank: number; user_price: number }>\r\n): Promise<ApiResponse<UpdateMemberPriceResponse>> {\r\n  const { apiUrl } = getApiConfig();\r\n  const url = `${apiUrl}?action=update_member_price&goods_id=${goodsId}`;\r\n\r\n  return fetchWithAuth<UpdateMemberPriceResponse>(url, {\r\n    method: 'POST',\r\n    headers: { 'Content-Type': 'application/json' },\r\n    body: JSON.stringify({ member_prices: memberPrices }),\r\n  });\r\n}\r\n\r\n/**\r\n * Cập nhật giá thành viên theo rank_id đơn lẻ\r\n */\r\nexport async function updateMemberPriceSingle(\r\n  goodsId: number,\r\n  userRank: number,\r\n  userPrice: number\r\n): Promise<ApiResponse<UpdateMemberPriceResponse>> {\r\n  return updateMemberPrice(goodsId, [{ user_rank: userRank, user_price: userPrice }]);\r\n}\r\n\r\n// ========================================\r\n// HTML Image Processing\r\n// ========================================\r\n\r\n/**\r\n * Kiểm tra URL có phải là URL công khai không (không phải localhost/internal)\r\n */\r\nfunction isPublicUrl(url: string): boolean {\r\n  try {\r\n    const parsed = new URL(url);\r\n    const hostname = parsed.hostname.toLowerCase();\r\n    \r\n    // Loại bỏ các URL nội bộ\r\n    if (hostname === 'localhost' || \r\n        hostname === '127.0.0.1' ||\r\n        hostname.startsWith('192.168.') ||\r\n        hostname.startsWith('10.') ||\r\n        hostname.endsWith('.local')) {\r\n      return false;\r\n    }\r\n    return true;\r\n  } catch {\r\n    return false;\r\n  }\r\n}\r\n\r\n/**\r\n * Kiểm tra xem URL có phải là ảnh base64 không\r\n */\r\nfunction isBase64Image(url: string): boolean {\r\n  return url.startsWith('data:image/');\r\n}\r\n\r\n/**\r\n * Kiểm tra xem URL đã là URL của PKGX CDN chưa\r\n */\r\nfunction isPkgxCdnUrl(url: string): boolean {\r\n  return url.includes('phukiengiaxuong.com.vn/cdn/');\r\n}\r\n\r\n/**\r\n * Xử lý HTML để upload tất cả ảnh lên PKGX và thay thế URL\r\n * \r\n * Hàm này sẽ:\r\n * 1. Tìm tất cả <img> tags trong HTML\r\n * 2. Với mỗi ảnh có src là URL công khai (không phải localhost):\r\n *    - Upload lên PKGX qua upload_image_from_url\r\n *    - Thay thế src bằng URL mới trên PKGX CDN\r\n * 3. Với ảnh base64: bỏ qua (quá nặng, không sync)\r\n * 4. Với ảnh đã trên PKGX CDN: giữ nguyên\r\n * \r\n * @param html - HTML content cần xử lý\r\n * @param filenamePrefix - Prefix cho tên file (optional)\r\n * @returns HTML đã được xử lý với URLs mới\r\n */\r\nexport async function processHtmlImagesForPkgx(\r\n  html: string,\r\n  filenamePrefix?: string\r\n): Promise<{ processedHtml: string; uploadedCount: number; skippedCount: number; errors: string[] }> {\r\n  if (!html) {\r\n    return { processedHtml: html, uploadedCount: 0, skippedCount: 0, errors: [] };\r\n  }\r\n\r\n  // Regex để tìm tất cả <img> tags\r\n  const imgRegex = /<img[^>]+src=[\"']([^\"']+)[\"'][^>]*>/gi;\r\n  \r\n  let processedHtml = html;\r\n  let uploadedCount = 0;\r\n  let skippedCount = 0;\r\n  const errors: string[] = [];\r\n  \r\n  // Tìm tất cả các ảnh\r\n  const matches: Array<{ fullMatch: string; src: string }> = [];\r\n  let match;\r\n  while ((match = imgRegex.exec(html)) !== null) {\r\n    matches.push({ fullMatch: match[0], src: match[1] });\r\n  }\r\n\r\n  // Xử lý từng ảnh\r\n  for (let i = 0; i < matches.length; i++) {\r\n    const { fullMatch, src } = matches[i];\r\n    \r\n    // Skip base64 images\r\n    if (isBase64Image(src)) {\r\n      skippedCount++;\r\n      errors.push(`Bỏ qua ảnh base64 (không hỗ trợ upload base64)`);\r\n      continue;\r\n    }\r\n    \r\n    // Skip if already on PKGX CDN\r\n    if (isPkgxCdnUrl(src)) {\r\n      skippedCount++;\r\n      continue;\r\n    }\r\n    \r\n    // Skip localhost/internal URLs\r\n    if (!isPublicUrl(src)) {\r\n      skippedCount++;\r\n      errors.push(`Bỏ qua URL nội bộ: ${src.substring(0, 50)}...`);\r\n      continue;\r\n    }\r\n    \r\n    // Upload to PKGX\r\n    try {\r\n      const slug = filenamePrefix \r\n        ? `${filenamePrefix}-desc-img-${i + 1}` \r\n        : `desc-img-${Date.now()}-${i + 1}`;\r\n      \r\n      const uploadResult = await uploadImageFromUrl(src, { filenameSlug: slug });\r\n      \r\n      if (uploadResult.success && uploadResult.data?.data?.full_urls?.original) {\r\n        // Replace src in HTML\r\n        const newSrc = uploadResult.data.data.full_urls.original;\r\n        const newImgTag = fullMatch.replace(src, newSrc);\r\n        processedHtml = processedHtml.replace(fullMatch, newImgTag);\r\n        uploadedCount++;\r\n      } else {\r\n        errors.push(`Lỗi upload ảnh: ${uploadResult.error || 'Unknown error'}`);\r\n        skippedCount++;\r\n      }\r\n    } catch (error) {\r\n      errors.push(`Exception upload ảnh: ${error instanceof Error ? error.message : String(error)}`);\r\n      skippedCount++;\r\n    }\r\n  }\r\n\r\n  return { processedHtml, uploadedCount, skippedCount, errors };\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 560, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/lib/id-types.ts"],"sourcesContent":["/**\r\n * Type-safe ID System\r\n * \r\n * Prevents mixing systemId with business ID at compile time\r\n */\r\n\r\n// Branded types for type safety\r\nexport type SystemId = string & { readonly __brand: 'SystemId' };\r\nexport type BusinessId = string & { readonly __brand: 'BusinessId' };\r\n\r\n/**\r\n * Create a SystemId from a string\r\n * Use this when you know for sure it's a systemId\r\n */\r\nexport function asSystemId(id: string): SystemId {\r\n  return id as SystemId;\r\n}\r\n\r\n/**\r\n * Create a BusinessId from a string\r\n * Use this when you know for sure it's a business ID\r\n */\r\nexport function asBusinessId(id: string): BusinessId {\r\n  return id as BusinessId;\r\n}\r\n\r\n/**\r\n * Check if a string is a valid systemId format\r\n */\r\nexport function isSystemIdFormat(id: string): boolean {\r\n  // SystemId: 8 digits + prefix (e.g., NV00000001, VOUCHER00000123)\r\n  return /^[A-Z]+\\d{8}$/.test(id);\r\n}\r\n\r\n/**\r\n * Check if a string is a valid business ID format\r\n */\r\nexport function isBusinessIdFormat(id: string): boolean {\r\n  // Business ID: shorter, variable length (e.g., NV001, PT000001)\r\n  return /^[A-Z]+\\d{3,6}$/.test(id);\r\n}\r\n\r\n/**\r\n * Safely convert unknown ID to proper type\r\n */\r\nexport function parseId(id: string): { type: 'system' | 'business'; value: SystemId | BusinessId } {\r\n  if (isSystemIdFormat(id)) {\r\n    return { type: 'system', value: asSystemId(id) };\r\n  }\r\n  if (isBusinessIdFormat(id)) {\r\n    return { type: 'business', value: asBusinessId(id) };\r\n  }\r\n  throw new Error(`Invalid ID format: ${id}`);\r\n}\r\n\r\n/**\r\n * ID Pair - Always keep systemId and businessId together\r\n */\r\nexport interface IDPair {\r\n  systemId: SystemId;\r\n  businessId: BusinessId;\r\n}\r\n\r\n/**\r\n * Entity with dual IDs\r\n */\r\nexport interface DualIDEntity {\r\n  systemId: SystemId;\r\n  id: BusinessId;\r\n}\r\n\r\n/**\r\n * Store methods with type-safe IDs\r\n */\r\nexport interface TypeSafeStore<T extends DualIDEntity> {\r\n  /** Find by systemId (for queries, relationships) */\r\n  findBySystemId(systemId: SystemId): T | null;\r\n  \r\n  /** Find by business ID (for user input, display) */\r\n  findByBusinessId(businessId: BusinessId): T | null;\r\n  \r\n  /** Update by systemId (always use systemId for updates) */\r\n  updateBySystemId(systemId: SystemId, updates: Partial<T>): void;\r\n  \r\n  /** Delete by systemId (always use systemId for deletes) */\r\n  deleteBySystemId(systemId: SystemId): void;\r\n}\r\n\r\n/**\r\n * Route params with type-safe IDs\r\n */\r\nexport interface RouteParams {\r\n  systemId?: SystemId;\r\n  id?: BusinessId;\r\n}\r\n\r\n/**\r\n * Link builder - always uses systemId\r\n */\r\nexport function buildEntityLink(path: string, entity: DualIDEntity): string {\r\n  return path.replace(':systemId', entity.systemId);\r\n}\r\n\r\n/**\r\n * Display ID - always uses business ID\r\n */\r\nexport function getDisplayId(entity: DualIDEntity): string {\r\n  return entity.id;\r\n}\r\n\r\n/**\r\n * Runtime guard: ensures a string is valid SystemId format and casts it\r\n * Logs warning if format is invalid\r\n */\r\nexport function ensureSystemId(id: string, context?: string): SystemId {\r\n  if (!isSystemIdFormat(id)) {\r\n    console.warn(`[ensureSystemId] Invalid SystemId format: \"${id}\"${context ? ` in ${context}` : ''}`);\r\n  }\r\n  return asSystemId(id);\r\n}\r\n\r\n/**\r\n * Runtime guard: ensures a string is valid BusinessId format and casts it\r\n * Logs warning if format is invalid\r\n */\r\nexport function ensureBusinessId(id: string, context?: string): BusinessId {\r\n  if (!isBusinessIdFormat(id)) {\r\n    console.warn(`[ensureBusinessId] Invalid BusinessId format: \"${id}\"${context ? ` in ${context}` : ''}`);\r\n  }\r\n  return asBusinessId(id);\r\n}\r\n"],"names":[],"mappings":"AAAA;;;;CAIC,GAED,gCAAgC;;;;;;;;;;;;;;;;;;;;;AAQzB,SAAS,WAAW,EAAU;IACnC,OAAO;AACT;AAMO,SAAS,aAAa,EAAU;IACrC,OAAO;AACT;AAKO,SAAS,iBAAiB,EAAU;IACzC,kEAAkE;IAClE,OAAO,gBAAgB,IAAI,CAAC;AAC9B;AAKO,SAAS,mBAAmB,EAAU;IAC3C,gEAAgE;IAChE,OAAO,kBAAkB,IAAI,CAAC;AAChC;AAKO,SAAS,QAAQ,EAAU;IAChC,IAAI,iBAAiB,KAAK;QACxB,OAAO;YAAE,MAAM;YAAU,OAAO,WAAW;QAAI;IACjD;IACA,IAAI,mBAAmB,KAAK;QAC1B,OAAO;YAAE,MAAM;YAAY,OAAO,aAAa;QAAI;IACrD;IACA,MAAM,IAAI,MAAM,CAAC,mBAAmB,EAAE,IAAI;AAC5C;AA8CO,SAAS,gBAAgB,IAAY,EAAE,MAAoB;IAChE,OAAO,KAAK,OAAO,CAAC,aAAa,OAAO,QAAQ;AAClD;AAKO,SAAS,aAAa,MAAoB;IAC/C,OAAO,OAAO,EAAE;AAClB;AAMO,SAAS,eAAe,EAAU,EAAE,OAAgB;IACzD,IAAI,CAAC,iBAAiB,KAAK;QACzB,QAAQ,IAAI,CAAC,CAAC,2CAA2C,EAAE,GAAG,CAAC,EAAE,UAAU,CAAC,IAAI,EAAE,SAAS,GAAG,IAAI;IACpG;IACA,OAAO,WAAW;AACpB;AAMO,SAAS,iBAAiB,EAAU,EAAE,OAAgB;IAC3D,IAAI,CAAC,mBAAmB,KAAK;QAC3B,QAAQ,IAAI,CAAC,CAAC,+CAA+C,EAAE,GAAG,CAAC,EAAE,UAAU,CAAC,IAAI,EAAE,SAAS,GAAG,IAAI;IACxG;IACA,OAAO,aAAa;AACtB"}},
    {"offset": {"line": 636, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/lib/id-utils.ts"],"sourcesContent":["/**\r\n * ID Utilities\r\n * Helpers for generating and validating IDs (systemId & business id)\r\n */\r\n\r\nimport { getPrefix, type EntityType } from './smart-prefix';\r\nimport { ID_CONFIG } from './id-config';\r\n\r\n// Re-export EntityType for convenience\r\nexport type { EntityType } from './smart-prefix';\r\n\r\n/**\r\n * Generate SystemId (6 digits, immutable, internal use only)\r\n * Format: SYSTEMID_PREFIX + 6 digits (e.g., \"EMP000001\", \"CUSTOMER000001\", \"ORDER000001\")\r\n * Uses systemIdPrefix from ID_CONFIG (English full words)\r\n */\r\nexport function generateSystemId(entityType: EntityType, counter: number): string {\r\n  const config = ID_CONFIG[entityType];\r\n  if (!config) {\r\n    throw new Error(`No configuration found for entity type: ${entityType}`);\r\n  }\r\n  const prefix = config.systemIdPrefix;\r\n  const digitCount = config.digitCount || 6;\r\n  return `${prefix}${String(counter).padStart(digitCount, '0')}`;\r\n}\r\n\r\n/**\r\n * Generate Business ID (6 digits, user-facing, editable)\r\n * Format: PREFIX + 6 digits (e.g., \"NV000001\", \"KH000001\", \"CTV000001\")\r\n * All entities use same 6-digit format for consistency\r\n * \r\n * @param entityType - Entity type from smart-prefix\r\n * @param counter - Current counter value\r\n * @param customId - Optional custom ID from user input\r\n * @returns Generated ID or validated custom ID\r\n */\r\nexport function generateBusinessId(\r\n  entityType: EntityType, \r\n  counter: number,\r\n  customId?: string\r\n): string {\r\n  // If user provided custom ID, validate and return it\r\n  if (customId && customId.trim()) {\r\n    const sanitized = sanitizeBusinessId(customId);\r\n    if (!sanitized) {\r\n      throw new Error('Mã không hợp lệ! Chỉ được phép sử dụng chữ cái và số.');\r\n    }\r\n    return sanitized;\r\n  }\r\n  \r\n  // Otherwise, auto-generate\r\n  const prefix = getPrefix(entityType);\r\n  return `${prefix}${String(counter).padStart(6, '0')}`;\r\n}\r\n\r\n/**\r\n * Sanitize business ID\r\n * - Remove special characters (keep only letters and numbers)\r\n * - Convert to uppercase\r\n * - Trim whitespace\r\n * \r\n * @param id - Raw user input\r\n * @returns Sanitized ID or null if invalid\r\n */\r\nexport function sanitizeBusinessId(id: string): string | null {\r\n  if (!id || typeof id !== 'string') return null;\r\n  \r\n  // Remove all special characters, keep only alphanumeric\r\n  const cleaned = id.trim().replace(/[^a-zA-Z0-9]/g, '');\r\n  \r\n  if (!cleaned) return null;\r\n  \r\n  // Convert to uppercase for consistency\r\n  return cleaned.toUpperCase();\r\n}\r\n\r\n/**\r\n * Validate business ID uniqueness (case-insensitive)\r\n * \r\n * @param id - ID to check\r\n * @param existingIds - Array of existing IDs in the system\r\n * @param currentId - Current ID (for edit mode, to exclude self)\r\n * @returns true if unique, false if duplicate\r\n */\r\nexport function isBusinessIdUnique(\r\n  id: string,\r\n  existingIds: string[],\r\n  currentId?: string\r\n): boolean {\r\n  if (!id) return false;\r\n  \r\n  const normalizedId = id.toUpperCase();\r\n  const normalizedCurrentId = currentId?.toUpperCase();\r\n  \r\n  return !existingIds.some(existingId => {\r\n    // ✅ Filter out empty/undefined IDs\r\n    if (!existingId || existingId.trim() === '') return false;\r\n    \r\n    const normalizedExisting = existingId.toUpperCase();\r\n    // Skip self-comparison in edit mode\r\n    if (normalizedCurrentId && normalizedExisting === normalizedCurrentId) {\r\n      return false;\r\n    }\r\n    return normalizedExisting === normalizedId;\r\n  });\r\n}\r\n\r\n/**\r\n * Extract counter from system ID\r\n * Used to initialize counter when loading from localStorage\r\n * Supports both 6, 7 and 8 digits\r\n * \r\n * @param systemId - System ID to parse (e.g., \"EMP000001\", \"CUSTOMER000001\", \"WARRANTY0000001\")\r\n * @param prefix - Expected systemIdPrefix (e.g., \"EMP\", \"CUSTOMER\", \"WARRANTY\")\r\n * @returns Counter value or 0 if invalid\r\n */\r\nexport function extractCounterFromSystemId(systemId: string, prefix: string): number {\r\n  if (!systemId || typeof systemId !== 'string') return 0;\r\n  \r\n  // Try different digit counts (most entities use 6 digits, some use 7-8)\r\n  const regex8 = new RegExp(`^${prefix}(\\\\d{8})$`);\r\n  const regex7 = new RegExp(`^${prefix}(\\\\d{7})$`);\r\n  const regex6 = new RegExp(`^${prefix}(\\\\d{6})$`);\r\n  \r\n  const match8 = systemId.match(regex8);\r\n  if (match8) return parseInt(match8[1], 10);\r\n  \r\n  const match7 = systemId.match(regex7);\r\n  if (match7) return parseInt(match7[1], 10);\r\n  \r\n  const match6 = systemId.match(regex6);\r\n  if (match6) return parseInt(match6[1], 10);\r\n  \r\n  return 0;\r\n}\r\n\r\n/**\r\n * Extract counter from business ID\r\n * Used to initialize counter when loading from localStorage\r\n * \r\n * @param businessId - Business ID to parse (e.g., \"NV000001\")\r\n * @param prefix - Expected prefix (e.g., \"NV\")\r\n * @returns Counter value or 0 if invalid\r\n */\r\nexport function extractCounterFromBusinessId(businessId: string, prefix: string): number {\r\n  if (!businessId || typeof businessId !== 'string') return 0;\r\n  const regex = new RegExp(`^${prefix}(\\\\d+)$`);\r\n  const match = businessId.match(regex);\r\n  return match ? parseInt(match[1], 10) : 0;\r\n}\r\n\r\n/**\r\n * Get max counter from array of items (for systemId)\r\n * \r\n * @param items - Array of items with systemId\r\n * @param prefix - Prefix to match\r\n * @returns Maximum counter value\r\n */\r\nexport function getMaxSystemIdCounter<T extends { systemId: string }>(\r\n  items: T[],\r\n  prefix: string\r\n): number {\r\n  if (!items || !Array.isArray(items)) return 0;\r\n  \r\n  let maxCounter = 0;\r\n  \r\n  items.forEach(item => {\r\n    if (!item || !item.systemId) return;\r\n    const counter = extractCounterFromSystemId(item.systemId, prefix);\r\n    if (counter > maxCounter) {\r\n      maxCounter = counter;\r\n    }\r\n  });\r\n  \r\n  return maxCounter;\r\n}\r\n\r\n/**\r\n * Get max counter from array of items (for business id)\r\n * Only counts auto-generated IDs (PREFIX + digits)\r\n * \r\n * @param items - Array of items with id\r\n * @param prefix - Prefix to match\r\n * @returns Maximum counter value\r\n */\r\nexport function getMaxBusinessIdCounter<T extends { id: string }>(\r\n  items: T[],\r\n  prefix: string\r\n): number {\r\n  if (!items || !Array.isArray(items)) return 0;\r\n  \r\n  let maxCounter = 0;\r\n  \r\n  items.forEach(item => {\r\n    if (!item || !item.id) return;\r\n    const counter = extractCounterFromBusinessId(item.id, prefix);\r\n    if (counter > maxCounter) {\r\n      maxCounter = counter;\r\n    }\r\n  });\r\n  \r\n  return maxCounter;\r\n}\r\n\r\n/**\r\n * Format ID for display\r\n * Adds spacing for readability\r\n * \r\n * @param id - ID to format\r\n * @returns Formatted ID (e.g., \"NV-000001\", \"KH-000123\")\r\n */\r\nexport function formatIdForDisplay(id: string): string {\r\n  // Match pattern: PREFIX followed by numbers\r\n  const match = id.match(/^([A-Z]+)(\\d+)$/);\r\n  if (!match) return id;\r\n  \r\n  const [, prefix, numbers] = match;\r\n  return `${prefix}-${numbers}`;\r\n}\r\n\r\n/**\r\n * Validate ID format\r\n * Check if ID follows valid pattern (letters + numbers only)\r\n * \r\n * @param id - ID to validate\r\n * @returns true if valid format\r\n */\r\nexport function isValidIdFormat(id: string): boolean {\r\n  if (!id || typeof id !== 'string') return false;\r\n  \r\n  // Only alphanumeric characters allowed\r\n  const regex = /^[A-Z0-9]+$/i;\r\n  return regex.test(id);\r\n}\r\n\r\n/**\r\n * Generate suggested IDs based on entity type\r\n * Useful for autocomplete or placeholder text\r\n * \r\n * @param entityType - Entity type\r\n * @param counter - Current counter\r\n * @param count - Number of suggestions\r\n * @returns Array of suggested IDs\r\n */\r\nexport function generateSuggestedIds(\r\n  entityType: EntityType,\r\n  counter: number,\r\n  count: number = 3\r\n): string[] {\r\n  const suggestions: string[] = [];\r\n  const prefix = getPrefix(entityType);\r\n  \r\n  for (let i = 0; i < count; i++) {\r\n    suggestions.push(`${prefix}${String(counter + i + 1).padStart(6, '0')}`);\r\n  }\r\n  \r\n  return suggestions;\r\n}\r\n\r\n/**\r\n * ✨ Find next available business ID\r\n * Checks existing IDs and increments counter until finding a unique ID\r\n * \r\n * @param prefix - ID prefix (e.g., 'PT', 'PC', 'NV')\r\n * @param existingIds - Array of existing business IDs\r\n * @param startCounter - Starting counter value\r\n * @param digitCount - Number of digits (default: 6)\r\n * @returns Object with nextId and updatedCounter\r\n */\r\nexport function findNextAvailableBusinessId(\r\n  prefix: string,\r\n  existingIds: string[],\r\n  startCounter: number,\r\n  digitCount: number = 6\r\n): { nextId: string; updatedCounter: number } {\r\n  let counter = startCounter;\r\n  let nextId: string;\r\n  \r\n  // Keep incrementing until we find a unique ID\r\n  do {\r\n    counter++;\r\n    nextId = `${prefix}${String(counter).padStart(digitCount, '0')}`;\r\n  } while (existingIds.some(id => id === nextId));\r\n  \r\n  return {\r\n    nextId,\r\n    updatedCounter: counter\r\n  };\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 796, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/lib/store-factory.ts"],"sourcesContent":["import { create } from 'zustand';\r\n// persist, createJSONStorage removed - database is now source of truth\r\nimport { \r\n  generateSystemId, \r\n  generateBusinessId, \r\n  isBusinessIdUnique,\r\n  getMaxSystemIdCounter,\r\n  getMaxBusinessIdCounter,\r\n  findNextAvailableBusinessId,\r\n  type EntityType \r\n} from './id-utils';\r\nimport { getPrefix } from './smart-prefix';\r\nimport { ID_CONFIG, type SystemId, type BusinessId, createSystemId, createBusinessId as brandBusinessId } from './id-config';\r\n\r\nconst SYSTEM_FALLBACK_ID: SystemId = createSystemId('SYS000000');\r\n\r\nconst asSystemIdFallback = (): SystemId => SYSTEM_FALLBACK_ID;\r\n\r\n// ✅ API Sync helper for store-factory\r\nasync function syncToAPI<T>(\r\n  apiEndpoint: string,\r\n  action: 'create' | 'update' | 'delete' | 'restore',\r\n  data: T | { systemId: SystemId },\r\n  systemId?: SystemId\r\n): Promise<boolean> {\r\n  try {\r\n    const endpoint = action === 'create' \r\n      ? apiEndpoint \r\n      : `${apiEndpoint}/${systemId || (data as any).systemId}`;\r\n    \r\n    const method = action === 'create' ? 'POST' \r\n      : action === 'update' ? 'PATCH' \r\n      : action === 'delete' ? 'DELETE'\r\n      : 'PATCH'; // restore uses PATCH\r\n    \r\n    const response = await fetch(endpoint, {\r\n      method,\r\n      headers: { 'Content-Type': 'application/json' },\r\n      credentials: 'include',\r\n      body: action !== 'delete' ? JSON.stringify(data) : undefined,\r\n    });\r\n    \r\n    if (!response.ok) {\r\n      console.warn(`[Store Factory API] ${action} failed for ${apiEndpoint}:`, response.status);\r\n    }\r\n    return response.ok;\r\n  } catch (error) {\r\n    console.error(`[Store Factory API] ${action} error for ${apiEndpoint}:`, error);\r\n    return false;\r\n  }\r\n}\r\n\r\n// Item with SystemId (branded type)\r\nexport type ItemWithSystemId = { systemId: SystemId; [key: string]: any };\r\n\r\n// ✅ Counter state for ID generation\r\nexport type CounterState = {\r\n  systemId: number;\r\n  businessId: number;\r\n};\r\n\r\nexport type CrudState<T extends ItemWithSystemId> = {\r\n  data: T[];\r\n  _counters: CounterState; // ✅ Persisted counters\r\n  _initialized: boolean; // ✅ Track if loaded from API\r\n  add: (item: Omit<T, 'systemId'>) => T;\r\n  addMultiple: (items: Omit<T, 'systemId'>[]) => void;\r\n  update: (systemId: SystemId, item: Partial<T>) => void; // ✅ Accept partial updates\r\n  remove: (systemId: SystemId) => void; // ✅ Branded type\r\n  hardDelete: (systemId: SystemId) => void; // ✅ Branded type\r\n  restore: (systemId: SystemId) => void; // ✅ Branded type\r\n  findById: (systemId: SystemId | string) => T | undefined; // ✅ Branded type\r\n  getActive: () => T[];\r\n  getDeleted: () => T[];\r\n  loadFromAPI: () => Promise<void>; // ✅ Load data from database\r\n};\r\n\r\nexport const createCrudStore = <T extends ItemWithSystemId>(\r\n  _initialData: T[], // @deprecated - Kept for backward compatibility but NO LONGER USED\r\n  entityType: EntityType, // Changed from idPrefix to entityType\r\n  options?: {\r\n    businessIdField?: keyof T; // Field name for business ID (default: 'id')\r\n    persistKey?: string; // @deprecated - No longer used, kept for backward compatibility\r\n    getCurrentUser?: () => string | undefined; // Function to get current user systemId\r\n    apiEndpoint?: string; // ✅ API endpoint for database sync (e.g., '/api/employees')\r\n  }\r\n) => {\r\n  const businessPrefix = getPrefix(entityType); // Vietnamese prefix for Business ID (NV, KH, DH)\r\n  const config = ID_CONFIG[entityType];\r\n  const systemIdPrefix = config?.systemIdPrefix || entityType.toUpperCase(); // English prefix for SystemId (EMP, CUSTOMER, ORDER)\r\n  \r\n  const businessIdField = options?.businessIdField ?? 'id';\r\n  // const persistKey = options?.persistKey; // @deprecated - No longer used\r\n  const getCurrentUser = options?.getCurrentUser;\r\n  const apiEndpoint = options?.apiEndpoint;\r\n\r\n  // ✅ CHANGED: Start with empty array - database is source of truth\r\n  // Mock data files (data.ts) are NO LONGER USED for runtime\r\n  const normalizedInitialData: T[] = [];\r\n\r\n  const storeConfig = (set: any, get: any) => ({\r\n    data: normalizedInitialData, // ✅ Start empty - data loaded via React Query\r\n    // ✅ Counters start at 0 - will be initialized from API via loadFromAPI()\r\n    _counters: {\r\n      systemId: 0,\r\n      businessId: 0\r\n    },\r\n    _initialized: false, // ✅ Track API initialization\r\n    add: (item: Omit<T, 'systemId'>): T => {\r\n        // ✅ Get counters from state (persisted)\r\n        const currentCounters = get()._counters;\r\n        const newSystemIdCounter = currentCounters.systemId + 1;\r\n        const newSystemId = createSystemId(generateSystemId(entityType, newSystemIdCounter));\r\n        \r\n        // Generate or validate Business ID (if field exists)\r\n        let finalItem = { ...item } as any;\r\n        let newBusinessIdCounter = currentCounters.businessId;\r\n        \r\n        if (businessIdField in item) {\r\n          const customId = (item as any)[businessIdField];\r\n          const existingIds = get().data.map((d: any) => d[businessIdField]);\r\n          \r\n          // ✅ If customId provided, validate uniqueness\r\n          if (customId && customId.trim()) {\r\n            if (!isBusinessIdUnique(customId, existingIds)) {\r\n              throw new Error(`Mã \"${customId}\" đã tồn tại! Vui lòng sử dụng mã khác.`);\r\n            }\r\n            finalItem[businessIdField] = customId.trim().toUpperCase();\r\n          } else {\r\n            // ✅ Auto-generate with findNextAvailableBusinessId\r\n            const digitCount = 6; // All entities use 6 digits\r\n            const result = findNextAvailableBusinessId(businessPrefix, existingIds, newBusinessIdCounter, digitCount);\r\n            finalItem[businessIdField] = result.nextId;\r\n            newBusinessIdCounter = result.updatedCounter;\r\n          }\r\n        }\r\n        \r\n        const now = new Date().toISOString();\r\n        const currentUser = getCurrentUser?.();\r\n        const newItem = { \r\n          ...finalItem, \r\n          systemId: newSystemId, // ✅ Branded SystemId\r\n          createdAt: finalItem.createdAt || now,\r\n          updatedAt: now,\r\n          createdBy: finalItem.createdBy || currentUser,\r\n          updatedBy: currentUser,\r\n        } as unknown as T;\r\n        \r\n        // ✅ Update both data and counters atomically\r\n        set((state: any) => ({ \r\n          data: [...state.data, newItem],\r\n          _counters: {\r\n            systemId: newSystemIdCounter,\r\n            businessId: newBusinessIdCounter\r\n          }\r\n        }));\r\n        \r\n        // ✅ Sync to API in background\r\n        if (apiEndpoint) {\r\n          syncToAPI(apiEndpoint, 'create', newItem).catch(console.error);\r\n        }\r\n        \r\n        return newItem;\r\n    },\r\n    addMultiple: (items: Omit<T, 'systemId'>[]) => \r\n        set((state: any) => {\r\n            const now = new Date().toISOString();\r\n            const currentUser = getCurrentUser?.();\r\n            const newItems: T[] = [];\r\n            const digitCount = 6; // All entities use 6 digits\r\n            \r\n            // ✅ Start from current counters\r\n            let currentSystemIdCounter = state._counters.systemId;\r\n            let currentBusinessIdCounter = state._counters.businessId;\r\n            \r\n            items.forEach(item => {\r\n                // ✅ Generate SystemId from current counter\r\n                currentSystemIdCounter++;\r\n                const newSystemId = createSystemId(generateSystemId(entityType, currentSystemIdCounter));\r\n                \r\n                // Generate or validate Business ID (if field exists)\r\n                let finalItem = { ...item } as any;\r\n                if (businessIdField in item) {\r\n                  const customId = (item as any)[businessIdField];\r\n                  \r\n                  // Collect existing IDs (from state + already added in this batch)\r\n                  const existingIds = [\r\n                    ...state.data.map((d: any) => d[businessIdField]),\r\n                    ...newItems.map((d: any) => d[businessIdField])\r\n                  ];\r\n                  \r\n                  // ✅ If customId provided, validate uniqueness\r\n                  if (customId && customId.trim()) {\r\n                    if (!isBusinessIdUnique(customId, existingIds)) {\r\n                      throw new Error(`Mã \"${customId}\" đã tồn tại! Vui lòng sử dụng mã khác.`);\r\n                    }\r\n                    finalItem[businessIdField] = customId.trim().toUpperCase();\r\n                  } else {\r\n                    // ✅ Auto-generate with findNextAvailableBusinessId\r\n                    const result = findNextAvailableBusinessId(businessPrefix, existingIds, currentBusinessIdCounter, digitCount);\r\n                    finalItem[businessIdField] = result.nextId;\r\n                    currentBusinessIdCounter = result.updatedCounter;\r\n                  }\r\n                }\r\n                \r\n                newItems.push({ \r\n                  ...finalItem, \r\n                  systemId: newSystemId,\r\n                  createdAt: now,\r\n                  updatedAt: now,\r\n                  createdBy: currentUser,\r\n                  updatedBy: currentUser,\r\n                } as unknown as T);\r\n            });\r\n            \r\n            // ✅ Update both data and counters\r\n            const result = { \r\n              data: [...state.data, ...newItems],\r\n              _counters: {\r\n                systemId: currentSystemIdCounter,\r\n                businessId: currentBusinessIdCounter\r\n              }\r\n            };\r\n            \r\n            // ✅ Sync to API in background (batch)\r\n            if (apiEndpoint) {\r\n              newItems.forEach(item => {\r\n                syncToAPI(apiEndpoint, 'create', item).catch(console.error);\r\n              });\r\n            }\r\n            \r\n            return result;\r\n        }),\r\n    update: (systemId: SystemId, updatedItem: Partial<T>) => {\r\n      // Validate unique business ID (case-insensitive, skip self)\r\n      if (businessIdField in updatedItem) {\r\n        const businessId = (updatedItem as any)[businessIdField];\r\n        const existingIds = get().data\r\n          .filter((d: any) => d.systemId !== systemId)\r\n          .map((d: any) => d[businessIdField]);\r\n        \r\n        if (businessId && !isBusinessIdUnique(businessId, existingIds)) {\r\n          throw new Error(`Mã \"${businessId}\" đã tồn tại! Vui lòng sử dụng mã khác.`);\r\n        }\r\n      }\r\n\r\n      const now = new Date().toISOString();\r\n      const currentUser = getCurrentUser?.();\r\n      set((state: any) => ({\r\n        data: state.data.map((item: T) =>\r\n          item.systemId === systemId \r\n            ? { ...item, ...updatedItem, updatedAt: now, updatedBy: currentUser } as T\r\n            : item\r\n        ),\r\n      }));\r\n      \r\n      // ✅ Sync to API in background\r\n      if (apiEndpoint) {\r\n        const fullItem = get().data.find((item: T) => item.systemId === systemId);\r\n        if (fullItem) {\r\n          syncToAPI(apiEndpoint, 'update', fullItem, systemId).catch(console.error);\r\n        }\r\n      }\r\n    },\r\n    remove: (systemId: SystemId) => {\r\n      // Soft delete - mark as deleted\r\n      const now = new Date().toISOString();\r\n      set((state: any) => ({\r\n        data: state.data.map((item: T) =>\r\n          item.systemId === systemId\r\n            ? { ...item, isDeleted: true, deletedAt: now } as T\r\n            : item\r\n        ),\r\n      }));\r\n      \r\n      // ✅ Sync to API in background\r\n      if (apiEndpoint) {\r\n        const item = get().data.find((item: T) => item.systemId === systemId);\r\n        if (item) {\r\n          syncToAPI(apiEndpoint, 'update', { ...item, isDeleted: true, deletedAt: now }, systemId).catch(console.error);\r\n        }\r\n      }\r\n    },\r\n    hardDelete: (systemId: SystemId) => {\r\n      // Permanent delete - remove from array\r\n      set((state: any) => ({\r\n        data: state.data.filter((item: T) => item.systemId !== systemId),\r\n      }));\r\n      \r\n      // ✅ Sync to API in background\r\n      if (apiEndpoint) {\r\n        syncToAPI(apiEndpoint, 'delete', { systemId }, systemId).catch(console.error);\r\n      }\r\n    },\r\n    restore: (systemId: SystemId) => {\r\n      // Restore soft-deleted item\r\n      set((state: any) => ({\r\n        data: state.data.map((item: T) =>\r\n          item.systemId === systemId\r\n            ? { ...item, isDeleted: false, deletedAt: null } as T\r\n            : item\r\n        ),\r\n      }));\r\n      \r\n      // ✅ Sync to API in background\r\n      if (apiEndpoint) {\r\n        const item = get().data.find((item: T) => item.systemId === systemId);\r\n        if (item) {\r\n          syncToAPI(apiEndpoint, 'restore', { ...item, isDeleted: false, deletedAt: null }, systemId).catch(console.error);\r\n        }\r\n      }\r\n    },\r\n    getActive: () => get().data.filter((item: any) => !item.isDeleted),\r\n    getDeleted: () => get().data.filter((item: any) => item.isDeleted),\r\n    findById: (id: SystemId | string) => get().data.find((item: T) => item.systemId === id || (item as any).id === id),\r\n    \r\n    // ✅ Load data from database API - OPTIMIZED: No more limit=10000!\r\n    // This is now only used for counter initialization, NOT for loading all data\r\n    // Use React Query hooks for data fetching with proper pagination\r\n    loadFromAPI: async () => {\r\n      if (!apiEndpoint) return;\r\n      if (get()._initialized) return;\r\n      \r\n      try {\r\n        // Only fetch minimal data needed to initialize counters\r\n        // Actual data loading should be done via React Query hooks\r\n        const response = await fetch(`${apiEndpoint}?limit=1&sortBy=systemId&sortOrder=desc`, {\r\n          credentials: 'include',\r\n        });\r\n        if (response.ok) {\r\n          const json = await response.json();\r\n          const pagination = json.pagination || {};\r\n          const lastItem = json.data?.[0];\r\n          \r\n          // Initialize counters from the latest item (highest IDs)\r\n          const newCounters = {\r\n            systemId: lastItem ? getMaxSystemIdCounter([lastItem], systemIdPrefix) : 0,\r\n            businessId: (lastItem && options?.businessIdField)\r\n              ? getMaxBusinessIdCounter([lastItem] as any[], businessPrefix)\r\n              : 0\r\n          };\r\n          \r\n          set({ \r\n            data: [], // Don't store data in Zustand anymore - use React Query\r\n            _counters: newCounters,\r\n            _initialized: true \r\n          });\r\n          \r\n          console.log(`[Store Factory] ${apiEndpoint} initialized. Total records: ${pagination.total || 'unknown'}`);\r\n        }\r\n      } catch (error) {\r\n        console.error(`[Store Factory] loadFromAPI error for ${apiEndpoint}:`, error);\r\n        // Still mark as initialized to prevent infinite retry\r\n        set({ _initialized: true });\r\n      }\r\n    },\r\n  });\r\n\r\n  // ✅ SIMPLIFIED: No localStorage persistence, database is source of truth\r\n  // Data is loaded via ApiSyncProvider on app init\r\n  return create<CrudState<T>>(storeConfig);\r\n};\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1104, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/lib/activity-history-helper.ts"],"sourcesContent":["/**\r\n * Activity History Helper\r\n * \r\n * Helper để tạo các entry lịch sử hoạt động một cách nhất quán\r\n * Dùng chung cho tất cả các modules trong hệ thống\r\n * \r\n * NOTE: Đã remove import useEmployeeStore để tránh circular dependency\r\n * và cải thiện compile time\r\n */\r\n\r\nimport type { HistoryEntry } from '../components/ActivityHistory';\r\nimport { getCurrentUserInfo as getAuthUserInfo } from '../contexts/auth-context';\r\nimport type { SystemId } from './id-types';\r\n\r\n// Re-export HistoryEntry type for convenience\r\nexport type { HistoryEntry } from '../components/ActivityHistory';\r\n\r\n/**\r\n * Lấy thông tin người dùng hiện tại từ auth context\r\n * NOTE: Avatar lookup từ employee store đã bị remove để tránh circular dependency\r\n */\r\nexport function getCurrentUserInfo(): { systemId: string; name: string; avatar?: string } {\r\n  const authInfo = getAuthUserInfo();\r\n  \r\n  return {\r\n    systemId: authInfo.systemId || 'SYSTEM',\r\n    name: authInfo.name || 'Hệ thống',\r\n    avatar: undefined, // Avatar will be fetched by component if needed\r\n  };\r\n}\r\n\r\n/**\r\n * Lấy thông tin nhân viên từ systemId\r\n * NOTE: This function now requires employee data to be passed in\r\n * to avoid circular dependency with employee store\r\n */\r\nexport function getEmployeeInfoFromData(\r\n  employeeSystemId: SystemId | string,\r\n  employees: Array<{ systemId: string; fullName: string; avatarUrl?: string }>\r\n): { systemId: string; name: string; avatar?: string } {\r\n  const employee = employees.find(e => e.systemId === employeeSystemId);\r\n  \r\n  if (employee) {\r\n    return {\r\n      systemId: employee.systemId,\r\n      name: employee.fullName,\r\n      avatar: employee.avatarUrl,\r\n    };\r\n  }\r\n  \r\n  // Fallback to system\r\n  return {\r\n    systemId: String(employeeSystemId) || 'SYSTEM',\r\n    name: 'Hệ thống',\r\n  };\r\n}\r\n\r\n/**\r\n * @deprecated Use getEmployeeInfoFromData instead\r\n */\r\nexport function getEmployeeInfo(employeeSystemId: SystemId | string): { systemId: string; name: string; avatar?: string } {\r\n  // Return minimal info without employee store lookup\r\n  return {\r\n    systemId: String(employeeSystemId) || 'SYSTEM',\r\n    name: 'Hệ thống',\r\n  };\r\n}\r\n\r\n/**\r\n * Tạo một history entry mới\r\n */\r\nexport function createHistoryEntry(\r\n  action: HistoryEntry['action'],\r\n  userOrDescription: { systemId: string; name: string; avatar?: string } | string,\r\n  descriptionOrMetadata?: string | HistoryEntry['metadata'],\r\n  metadata?: HistoryEntry['metadata']\r\n): HistoryEntry {\r\n  const hasUserObject = typeof userOrDescription === 'object' && userOrDescription !== null;\r\n  const user = hasUserObject ? userOrDescription : getCurrentUserInfo();\r\n  const description = (hasUserObject ? descriptionOrMetadata : userOrDescription) as string | undefined;\r\n  const meta = (hasUserObject ? metadata : descriptionOrMetadata) as HistoryEntry['metadata'] | undefined;\r\n\r\n  return {\r\n    id: `history-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,\r\n    action,\r\n    timestamp: new Date(),\r\n    user: {\r\n      systemId: user.systemId,\r\n      name: user.name,\r\n      avatar: user.avatar,\r\n    },\r\n    description: description ?? '',\r\n    metadata: meta,\r\n  };\r\n}\r\n\r\n/**\r\n * Tạo history entry cho action \"created\"\r\n */\r\nexport function createCreatedEntry(\r\n  user: { systemId: string; name: string; avatar?: string },\r\n  description: string\r\n): HistoryEntry {\r\n  return createHistoryEntry('created', user, description);\r\n}\r\n\r\n/**\r\n * Tạo history entry cho action \"updated\"\r\n */\r\nexport function createUpdatedEntry(\r\n  user: { systemId: string; name: string; avatar?: string },\r\n  description: string\r\n): HistoryEntry {\r\n  return createHistoryEntry('updated', user, description);\r\n}\r\n\r\n/**\r\n * Tạo history entry cho action \"status_changed\"\r\n */\r\nexport function createStatusChangedEntry(\r\n  user: { systemId: string; name: string; avatar?: string },\r\n  oldStatus: string,\r\n  newStatus: string,\r\n  description: string\r\n): HistoryEntry {\r\n  return createHistoryEntry(\r\n    'status_changed',\r\n    user,\r\n    description,\r\n    { field: 'status', oldValue: oldStatus, newValue: newStatus }\r\n  );\r\n}\r\n\r\n/**\r\n * Tạo history entry cho action \"deleted\"\r\n */\r\nexport function createDeletedEntry(\r\n  user: { systemId: string; name: string; avatar?: string },\r\n  description: string\r\n): HistoryEntry {\r\n  return createHistoryEntry('deleted', user, description);\r\n}\r\n\r\n/**\r\n * Tạo history entry cho action \"assigned\"\r\n */\r\nexport function createAssignedEntry(\r\n  user: { systemId: string; name: string; avatar?: string },\r\n  description: string\r\n): HistoryEntry {\r\n  return createHistoryEntry('assigned', user, description);\r\n}\r\n\r\n/**\r\n * Tạo history entry cho action \"payment_made\"\r\n */\r\nexport function createPaymentEntry(\r\n  user: { systemId: string; name: string; avatar?: string },\r\n  description: string\r\n): HistoryEntry {\r\n  return createHistoryEntry('payment_made', user, description);\r\n}\r\n\r\n/**\r\n * Tạo history entry cho action \"comment_added\"\r\n */\r\nexport function createCommentEntry(\r\n  user: { systemId: string; name: string; avatar?: string },\r\n  description: string\r\n): HistoryEntry {\r\n  return createHistoryEntry('comment_added', user, description);\r\n}\r\n\r\n/**\r\n * Tạo history entry cho action \"cancelled\"\r\n */\r\nexport function createCancelledEntry(\r\n  user: { systemId: string; name: string; avatar?: string },\r\n  description: string\r\n): HistoryEntry {\r\n  return createHistoryEntry('cancelled', user, description);\r\n}\r\n\r\n/**\r\n * Tạo history entry cho action \"verified\"\r\n */\r\nexport function createVerifiedEntry(\r\n  user: { systemId: string; name: string; avatar?: string },\r\n  description: string\r\n): HistoryEntry {\r\n  return createHistoryEntry('verified', user, description);\r\n}\r\n\r\n/**\r\n * Tạo history entry cho action \"ended\"\r\n */\r\nexport function createEndedEntry(\r\n  user: { systemId: string; name: string; avatar?: string },\r\n  description: string\r\n): HistoryEntry {\r\n  return createHistoryEntry('ended', user, description);\r\n}\r\n\r\n/**\r\n * Tạo history entry cho action \"reopened\"\r\n */\r\nexport function createReopenedEntry(\r\n  user: { systemId: string; name: string; avatar?: string },\r\n  description: string\r\n): HistoryEntry {\r\n  return createHistoryEntry('reopened', user, description);\r\n}\r\n\r\n/**\r\n * Tạo history entry cho product actions\r\n */\r\nexport function createProductEntry(\r\n  user: { systemId: string; name: string; avatar?: string },\r\n  action: 'product_added' | 'product_updated' | 'product_removed',\r\n  description: string\r\n): HistoryEntry {\r\n  return createHistoryEntry(action, user, description);\r\n}\r\n\r\n/**\r\n * Helper để append history entry vào existing array\r\n */\r\nexport function appendHistoryEntry(\r\n  existingHistory: HistoryEntry[] | undefined,\r\n  ...newEntries: HistoryEntry[]\r\n): HistoryEntry[] {\r\n  return [...(existingHistory || []), ...newEntries];\r\n}\r\n\r\n/**\r\n * Helper để tạo nhiều history entries cùng lúc\r\n */\r\nexport function createBulkUpdateEntries(\r\n  user: { systemId: string; name: string; avatar?: string },\r\n  changes: Array<{ field: string; description: string }>\r\n): HistoryEntry[] {\r\n  return changes.map(change => createHistoryEntry('updated', user, change.description));\r\n}\r\n"],"names":[],"mappings":"AAAA;;;;;;;;CAQC;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAGD;;AAUO,SAAS;IACd,MAAM,WAAW,IAAA,kJAAe;IAEhC,OAAO;QACL,UAAU,SAAS,QAAQ,IAAI;QAC/B,MAAM,SAAS,IAAI,IAAI;QACvB,QAAQ;IACV;AACF;AAOO,SAAS,wBACd,gBAAmC,EACnC,SAA4E;IAE5E,MAAM,WAAW,UAAU,IAAI,CAAC,CAAA,IAAK,EAAE,QAAQ,KAAK;IAEpD,IAAI,UAAU;QACZ,OAAO;YACL,UAAU,SAAS,QAAQ;YAC3B,MAAM,SAAS,QAAQ;YACvB,QAAQ,SAAS,SAAS;QAC5B;IACF;IAEA,qBAAqB;IACrB,OAAO;QACL,UAAU,OAAO,qBAAqB;QACtC,MAAM;IACR;AACF;AAKO,SAAS,gBAAgB,gBAAmC;IACjE,oDAAoD;IACpD,OAAO;QACL,UAAU,OAAO,qBAAqB;QACtC,MAAM;IACR;AACF;AAKO,SAAS,mBACd,MAA8B,EAC9B,iBAA+E,EAC/E,qBAAyD,EACzD,QAAmC;IAEnC,MAAM,gBAAgB,OAAO,sBAAsB,YAAY,sBAAsB;IACrF,MAAM,OAAO,gBAAgB,oBAAoB;IACjD,MAAM,cAAe,gBAAgB,wBAAwB;IAC7D,MAAM,OAAQ,gBAAgB,WAAW;IAEzC,OAAO;QACL,IAAI,CAAC,QAAQ,EAAE,KAAK,GAAG,GAAG,CAAC,EAAE,KAAK,MAAM,GAAG,QAAQ,CAAC,IAAI,MAAM,CAAC,GAAG,IAAI;QACtE;QACA,WAAW,IAAI;QACf,MAAM;YACJ,UAAU,KAAK,QAAQ;YACvB,MAAM,KAAK,IAAI;YACf,QAAQ,KAAK,MAAM;QACrB;QACA,aAAa,eAAe;QAC5B,UAAU;IACZ;AACF;AAKO,SAAS,mBACd,IAAyD,EACzD,WAAmB;IAEnB,OAAO,mBAAmB,WAAW,MAAM;AAC7C;AAKO,SAAS,mBACd,IAAyD,EACzD,WAAmB;IAEnB,OAAO,mBAAmB,WAAW,MAAM;AAC7C;AAKO,SAAS,yBACd,IAAyD,EACzD,SAAiB,EACjB,SAAiB,EACjB,WAAmB;IAEnB,OAAO,mBACL,kBACA,MACA,aACA;QAAE,OAAO;QAAU,UAAU;QAAW,UAAU;IAAU;AAEhE;AAKO,SAAS,mBACd,IAAyD,EACzD,WAAmB;IAEnB,OAAO,mBAAmB,WAAW,MAAM;AAC7C;AAKO,SAAS,oBACd,IAAyD,EACzD,WAAmB;IAEnB,OAAO,mBAAmB,YAAY,MAAM;AAC9C;AAKO,SAAS,mBACd,IAAyD,EACzD,WAAmB;IAEnB,OAAO,mBAAmB,gBAAgB,MAAM;AAClD;AAKO,SAAS,mBACd,IAAyD,EACzD,WAAmB;IAEnB,OAAO,mBAAmB,iBAAiB,MAAM;AACnD;AAKO,SAAS,qBACd,IAAyD,EACzD,WAAmB;IAEnB,OAAO,mBAAmB,aAAa,MAAM;AAC/C;AAKO,SAAS,oBACd,IAAyD,EACzD,WAAmB;IAEnB,OAAO,mBAAmB,YAAY,MAAM;AAC9C;AAKO,SAAS,iBACd,IAAyD,EACzD,WAAmB;IAEnB,OAAO,mBAAmB,SAAS,MAAM;AAC3C;AAKO,SAAS,oBACd,IAAyD,EACzD,WAAmB;IAEnB,OAAO,mBAAmB,YAAY,MAAM;AAC9C;AAKO,SAAS,mBACd,IAAyD,EACzD,MAA+D,EAC/D,WAAmB;IAEnB,OAAO,mBAAmB,QAAQ,MAAM;AAC1C;AAKO,SAAS,mBACd,eAA2C,EAC3C,GAAG,UAA0B;IAE7B,OAAO;WAAK,mBAAmB,EAAE;WAAM;KAAW;AACpD;AAKO,SAAS,wBACd,IAAyD,EACzD,OAAsD;IAEtD,OAAO,QAAQ,GAAG,CAAC,CAAA,SAAU,mBAAmB,WAAW,MAAM,OAAO,WAAW;AACrF"}},
    {"offset": {"line": 1253, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/hooks/use-debounce.ts"],"sourcesContent":["import * as React from 'react';\r\n\r\nexport function useDebounce<T>(value: T, delay: number): T {\r\n  const [debouncedValue, setDebouncedValue] = React.useState<T>(value);\r\n\r\n  React.useEffect(() => {\r\n    const handler = setTimeout(() => {\r\n      setDebouncedValue(value);\r\n    }, delay);\r\n\r\n    return () => {\r\n      clearTimeout(handler);\r\n    };\r\n  }, [value, delay]);\r\n\r\n  return debouncedValue;\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;;AAEO,SAAS,YAAe,KAAQ,EAAE,KAAa;IACpD,MAAM,CAAC,gBAAgB,kBAAkB,GAAG,iNAAc,CAAI;IAE9D,kNAAe,CAAC;QACd,MAAM,UAAU,WAAW;YACzB,kBAAkB;QACpB,GAAG;QAEH,OAAO;YACL,aAAa;QACf;IACF,GAAG;QAAC;QAAO;KAAM;IAEjB,OAAO;AACT"}},
    {"offset": {"line": 1278, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/app/%28authenticated%29/settings/pkgx/page.tsx"],"sourcesContent":["'use client';\r\nimport { PkgxSettingsPage } from '@/features/settings/pkgx/pkgx-settings-page';\r\nexport default PkgxSettingsPage;\r\n"],"names":[],"mappings":";;;;AACA;AADA;;uCAEe,6KAAgB"}}]
}