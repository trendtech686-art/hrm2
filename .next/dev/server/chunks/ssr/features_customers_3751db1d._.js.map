{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/customers/intelligence-utils.ts"],"sourcesContent":["import type { Customer } from './types';\r\nimport { formatDate, formatDateTime, formatDateTimeSeconds, formatDateCustom, getCurrentDate, getDaysDiff } from '@/lib/date-utils';\r\n// RFM Score types\r\nexport type RFMScore = {\r\n  recency: 1 | 2 | 3 | 4 | 5;      // 5 = Best (mua gần đây)\r\n  frequency: 1 | 2 | 3 | 4 | 5;    // 5 = Best (mua thường xuyên)\r\n  monetary: 1 | 2 | 3 | 4 | 5;     // 5 = Best (chi tiêu nhiều)\r\n};\r\n\r\n// Customer Segment based on RFM\r\nexport type CustomerSegment = \r\n  | 'Champions'           // RFM: 5-5-5, 5-4-5, 4-5-5 - Khách hàng tốt nhất\r\n  | 'Loyal Customers'     // RFM: 4-4-4, 4-5-4, 5-4-4 - Khách thân thiết\r\n  | 'Potential Loyalist'  // RFM: 4-3-*, 3-4-*, 5-3-* - Tiềm năng trở thành thân thiết\r\n  | 'New Customers'       // RFM: 5-1-*, 4-1-* - Khách mới\r\n  | 'Promising'           // RFM: 4-2-*, 3-3-* - Đầy hứa hẹn\r\n  | 'Need Attention'      // RFM: 3-2-*, 2-3-* - Cần chú ý\r\n  | 'About To Sleep'      // RFM: 3-1-*, 2-2-* - Sắp ngủ đông\r\n  | 'At Risk'             // RFM: 2-5-*, 2-4-*, 1-3-* - Có nguy cơ\r\n  | 'Cannot Lose Them'    // RFM: 1-5-5, 1-4-5 - Không thể mất\r\n  | 'Hibernating'         // RFM: 2-1-*, 1-2-* - Ngủ đông\r\n  | 'Lost';               // RFM: 1-1-* - Đã mất\r\n\r\n/**\r\n * Tính RFM scores cho một khách hàng\r\n */\r\nexport const calculateRFMScores = (customer: Customer, allCustomers: Customer[]): RFMScore => {\r\n  // Recency: Số ngày từ lần mua cuối\r\n  const daysSinceLastPurchase = customer.lastPurchaseDate \r\n    ? getDaysDiff(getCurrentDate(), new Date(customer.lastPurchaseDate))\r\n    : 999999;\r\n  \r\n  // Frequency: Tổng số đơn hàng\r\n  const frequency = customer.totalOrders || 0;\r\n  \r\n  // Monetary: Tổng chi tiêu\r\n  const monetary = customer.totalSpent || 0;\r\n\r\n  // Calculate percentiles for scoring\r\n  const allRecencies = allCustomers.map(c => \r\n    c.lastPurchaseDate ? getDaysDiff(getCurrentDate(), new Date(c.lastPurchaseDate)) : 999999\r\n  ).sort((a, b) => a - b);\r\n  \r\n  const allFrequencies = allCustomers.map(c => c.totalOrders || 0).sort((a, b) => b - a);\r\n  const allMonetary = allCustomers.map(c => c.totalSpent || 0).sort((a, b) => b - a);\r\n\r\n  // Score Recency (lower is better, so invert)\r\n  const recencyScore = getScore(daysSinceLastPurchase, allRecencies, true) as RFMScore['recency'];\r\n  \r\n  // Score Frequency (higher is better)\r\n  const frequencyScore = getScore(frequency, allFrequencies, false) as RFMScore['frequency'];\r\n  \r\n  // Score Monetary (higher is better)\r\n  const monetaryScore = getScore(monetary, allMonetary, false) as RFMScore['monetary'];\r\n\r\n  return {\r\n    recency: recencyScore,\r\n    frequency: frequencyScore,\r\n    monetary: monetaryScore\r\n  };\r\n};\r\n\r\n/**\r\n * Helper: Tính score 1-5 dựa trên percentile\r\n */\r\nconst getScore = (value: number, sortedValues: number[], invert: boolean): 1 | 2 | 3 | 4 | 5 => {\r\n  const index = sortedValues.indexOf(value);\r\n  if (index === -1) return 1;\r\n  \r\n  const percentile = (index / sortedValues.length) * 100;\r\n  \r\n  let score: number;\r\n  if (percentile >= 80) score = 5;\r\n  else if (percentile >= 60) score = 4;\r\n  else if (percentile >= 40) score = 3;\r\n  else if (percentile >= 20) score = 2;\r\n  else score = 1;\r\n  \r\n  // Invert for recency (lower days = better)\r\n  if (invert) {\r\n    score = 6 - score;\r\n  }\r\n  \r\n  return score as 1 | 2 | 3 | 4 | 5;\r\n};\r\n\r\n/**\r\n * Phân loại segment dựa trên RFM scores\r\n */\r\nexport const getCustomerSegment = (rfm: RFMScore): CustomerSegment => {\r\n  const { recency: R, frequency: F, monetary: M } = rfm;\r\n  \r\n  // Champions: RFM 5-5-5, 5-4-5, 4-5-5, 5-5-4\r\n  if ((R >= 4 && F >= 4 && M >= 4) && (R === 5 || F === 5)) {\r\n    return 'Champions';\r\n  }\r\n  \r\n  // Loyal Customers: RFM 4-4-4, 4-5-4, 5-4-4, 4-4-5\r\n  if (R >= 4 && F >= 4 && M >= 4) {\r\n    return 'Loyal Customers';\r\n  }\r\n  \r\n  // Potential Loyalist: High frequency, good recency\r\n  if (R >= 3 && F >= 3 && M >= 3) {\r\n    return 'Potential Loyalist';\r\n  }\r\n  \r\n  // New Customers: High recency, low frequency\r\n  if (R >= 4 && F <= 2) {\r\n    return 'New Customers';\r\n  }\r\n  \r\n  // Promising: Good recency, moderate frequency\r\n  if (R >= 3 && F >= 2 && F <= 3) {\r\n    return 'Promising';\r\n  }\r\n  \r\n  // Need Attention: Moderate scores\r\n  if (R === 3 && F === 2) {\r\n    return 'Need Attention';\r\n  }\r\n  \r\n  // About To Sleep: Low frequency, moderate recency\r\n  if ((R === 3 || R === 2) && F <= 2) {\r\n    return 'About To Sleep';\r\n  }\r\n  \r\n  // Cannot Lose Them: Low recency but high value\r\n  if (R === 1 && F >= 4 && M >= 4) {\r\n    return 'Cannot Lose Them';\r\n  }\r\n  \r\n  // At Risk: Low recency, good history\r\n  if (R <= 2 && F >= 3) {\r\n    return 'At Risk';\r\n  }\r\n  \r\n  // Hibernating: Low recency and frequency\r\n  if (R <= 2 && F <= 2 && M >= 2) {\r\n    return 'Hibernating';\r\n  }\r\n  \r\n  // Lost: Lowest scores\r\n  return 'Lost';\r\n};\r\n\r\n/**\r\n * Lấy màu badge cho segment\r\n */\r\nexport const getSegmentBadgeVariant = (segment: CustomerSegment): \r\n  'default' | 'secondary' | 'success' | 'warning' | 'destructive' => {\r\n  switch (segment) {\r\n    case 'Champions':\r\n    case 'Loyal Customers':\r\n      return 'success';\r\n    case 'Potential Loyalist':\r\n    case 'Promising':\r\n      return 'default';\r\n    case 'New Customers':\r\n      return 'secondary';\r\n    case 'Need Attention':\r\n    case 'About To Sleep':\r\n      return 'warning';\r\n    case 'At Risk':\r\n    case 'Cannot Lose Them':\r\n    case 'Hibernating':\r\n    case 'Lost':\r\n      return 'destructive';\r\n    default:\r\n      return 'secondary';\r\n  }\r\n};\r\n\r\n/**\r\n * Dịch segment sang tiếng Việt\r\n */\r\nexport const getSegmentLabel = (segment: CustomerSegment): string => {\r\n  const labels: Record<CustomerSegment, string> = {\r\n    'Champions': 'Xuất sắc',\r\n    'Loyal Customers': 'Trung thành',\r\n    'Potential Loyalist': 'Tiềm năng cao',\r\n    'New Customers': 'Khách mới',\r\n    'Promising': 'Hứa hẹn',\r\n    'Need Attention': 'Cần quan tâm',\r\n    'About To Sleep': 'Sắp ngủ đông',\r\n    'At Risk': 'Có nguy cơ',\r\n    'Cannot Lose Them': 'Không thể mất',\r\n    'Hibernating': 'Ngủ đông',\r\n    'Lost': 'Đã mất'\r\n  };\r\n  return labels[segment];\r\n};\r\n\r\n/**\r\n * Tính Customer Health Score (0-100)\r\n * Dựa trên 4 yếu tố: Recency, Frequency, Monetary, Payment Behavior\r\n */\r\nexport const calculateHealthScore = (customer: Customer): number => {\r\n  let score = 0;\r\n  \r\n  // 1. Recency - Thời gian mua gần nhất (30 points)\r\n  const daysSinceLastPurchase = customer.lastPurchaseDate \r\n    ? getDaysDiff(getCurrentDate(), new Date(customer.lastPurchaseDate))\r\n    : Infinity;\r\n    \r\n  if (daysSinceLastPurchase <= 7) score += 30;\r\n  else if (daysSinceLastPurchase <= 30) score += 25;\r\n  else if (daysSinceLastPurchase <= 60) score += 20;\r\n  else if (daysSinceLastPurchase <= 90) score += 15;\r\n  else if (daysSinceLastPurchase <= 180) score += 10;\r\n  else if (daysSinceLastPurchase <= 365) score += 5;\r\n  \r\n  // 2. Frequency - Tần suất mua (25 points)\r\n  const totalOrders = customer.totalOrders || 0;\r\n  if (totalOrders >= 20) score += 25;\r\n  else if (totalOrders >= 10) score += 20;\r\n  else if (totalOrders >= 5) score += 15;\r\n  else if (totalOrders >= 3) score += 10;\r\n  else if (totalOrders >= 1) score += 5;\r\n  \r\n  // 3. Monetary - Tổng chi tiêu (30 points)\r\n  const totalSpent = customer.totalSpent || 0;\r\n  if (totalSpent >= 500_000_000) score += 30;\r\n  else if (totalSpent >= 200_000_000) score += 25;\r\n  else if (totalSpent >= 100_000_000) score += 20;\r\n  else if (totalSpent >= 50_000_000) score += 15;\r\n  else if (totalSpent >= 20_000_000) score += 10;\r\n  else if (totalSpent >= 5_000_000) score += 5;\r\n  \r\n  // 4. Payment Behavior - Hành vi thanh toán (15 points)\r\n  // Dựa trên tỷ lệ nợ hiện tại so với hạn mức\r\n  if (customer.maxDebt && customer.maxDebt > 0) {\r\n    const debtRatio = (customer.currentDebt || 0) / customer.maxDebt;\r\n    if (debtRatio <= 0.2) score += 15;\r\n    else if (debtRatio <= 0.4) score += 12;\r\n    else if (debtRatio <= 0.6) score += 8;\r\n    else if (debtRatio <= 0.8) score += 4;\r\n    // > 80% = 0 điểm\r\n  } else {\r\n    // Không có hạn mức công nợ → xem như thanh toán tốt\r\n    score += 15;\r\n  }\r\n  \r\n  return Math.min(100, score);\r\n};\r\n\r\n/**\r\n * Lấy health score level\r\n */\r\nexport const getHealthScoreLevel = (score: number): {\r\n  level: 'excellent' | 'good' | 'fair' | 'poor' | 'critical';\r\n  label: string;\r\n  variant: 'success' | 'default' | 'warning' | 'destructive';\r\n} => {\r\n  if (score >= 80) return { level: 'excellent', label: 'Xuất sắc', variant: 'success' };\r\n  if (score >= 60) return { level: 'good', label: 'Tốt', variant: 'default' };\r\n  if (score >= 40) return { level: 'fair', label: 'Trung bình', variant: 'warning' };\r\n  if (score >= 20) return { level: 'poor', label: 'Yếu', variant: 'destructive' };\r\n  return { level: 'critical', label: 'Nguy hiểm', variant: 'destructive' };\r\n};\r\n\r\n/**\r\n * Dự đoán Churn Risk\r\n */\r\nexport const calculateChurnRisk = (customer: Customer): {\r\n  risk: 'low' | 'medium' | 'high';\r\n  label: string;\r\n  variant: 'success' | 'warning' | 'destructive';\r\n  reason: string;\r\n} => {\r\n  const daysSinceLastPurchase = customer.lastPurchaseDate \r\n    ? getDaysDiff(getCurrentDate(), new Date(customer.lastPurchaseDate))\r\n    : Infinity;\r\n  \r\n  const totalOrders = customer.totalOrders || 0;\r\n  \r\n  // Nếu khách mới (chưa có đơn hoặc chỉ 1 đơn), dùng default 30 ngày\r\n  // Nếu khách cũ, tính dựa trên thời gian từ createdAt đến lastPurchaseDate / số đơn\r\n  let avgDaysBetweenOrders = 30; // Default\r\n  if (totalOrders > 1 && customer.createdAt && customer.lastPurchaseDate) {\r\n    const customerAge = getDaysDiff(new Date(customer.lastPurchaseDate), new Date(customer.createdAt));\r\n    avgDaysBetweenOrders = Math.max(7, customerAge / (totalOrders - 1)); // Tối thiểu 7 ngày\r\n  }\r\n  \r\n  // Khách vừa mua hàng gần đây (< 7 ngày) = low risk\r\n  if (daysSinceLastPurchase <= 7) {\r\n    return {\r\n      risk: 'low',\r\n      label: 'Nguy cơ thấp',\r\n      variant: 'success',\r\n      reason: 'Khách hàng đang hoạt động tốt'\r\n    };\r\n  }\r\n  \r\n  // High risk: Không mua > 2x thời gian trung bình hoặc > 365 ngày\r\n  if (daysSinceLastPurchase > avgDaysBetweenOrders * 2 || daysSinceLastPurchase > 365) {\r\n    return {\r\n      risk: 'high',\r\n      label: 'Nguy cơ cao',\r\n      variant: 'destructive',\r\n      reason: `Không mua hàng ${Math.floor(daysSinceLastPurchase)} ngày, vượt quá 2x chu kỳ trung bình`\r\n    };\r\n  }\r\n  \r\n  // Medium risk: Không mua > 1.5x thời gian trung bình hoặc > 180 ngày\r\n  if (daysSinceLastPurchase > avgDaysBetweenOrders * 1.5 || daysSinceLastPurchase > 180) {\r\n    return {\r\n      risk: 'medium',\r\n      label: 'Nguy cơ trung bình',\r\n      variant: 'warning',\r\n      reason: `Không mua hàng ${Math.floor(daysSinceLastPurchase)} ngày, đang giảm tần suất`\r\n    };\r\n  }\r\n  \r\n  // Low risk\r\n  return {\r\n    risk: 'low',\r\n    label: 'Nguy cơ thấp',\r\n    variant: 'success',\r\n    reason: 'Khách hàng đang hoạt động tốt'\r\n  };\r\n};\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 262, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/customers/lifecycle-utils.ts"],"sourcesContent":["import type { Customer, CustomerLifecycleStage } from './types';\r\nimport { formatDate, formatDateTime, formatDateTimeSeconds, formatDateCustom, getCurrentDate, getDaysDiff } from '@/lib/date-utils';\r\n/**\r\n * Tự động tính toán giai đoạn vòng đời khách hàng dựa trên hành vi\r\n */\r\nexport const calculateLifecycleStage = (customer: Customer): CustomerLifecycleStage => {\r\n  const totalOrders = customer.totalOrders || 0;\r\n  const totalSpent = customer.totalSpent || 0;\r\n  const lastPurchaseDate = customer.lastPurchaseDate;\r\n  \r\n  // Nếu chưa mua lần nào\r\n  if (totalOrders === 0) {\r\n    return \"Khách tiềm năng\";\r\n  }\r\n  \r\n  // Tính số ngày từ lần mua cuối\r\n  const daysSinceLastPurchase = lastPurchaseDate \r\n    ? getDaysDiff(getCurrentDate(), new Date(lastPurchaseDate))\r\n    : Infinity;\r\n  \r\n  // Khách đã mất (không mua > 365 ngày)\r\n  if (daysSinceLastPurchase > 365) {\r\n    return \"Mất khách\";\r\n  }\r\n  \r\n  // Không hoạt động (không mua > 180 ngày)\r\n  if (daysSinceLastPurchase > 180) {\r\n    return \"Không hoạt động\";\r\n  }\r\n  \r\n  // Khách VIP: Top 10% spending (>= 50 triệu) và mua >= 5 lần\r\n  if (totalSpent >= 50_000_000 && totalOrders >= 5) {\r\n    return \"Khách VIP\";\r\n  }\r\n  \r\n  // Khách thân thiết: Mua >= 5 lần\r\n  if (totalOrders >= 5) {\r\n    return \"Khách thân thiết\";\r\n  }\r\n  \r\n  // Khách quay lại: Mua 2-4 lần\r\n  if (totalOrders >= 2) {\r\n    return \"Khách quay lại\";\r\n  }\r\n  \r\n  // Khách mới: Mua lần đầu\r\n  return \"Khách mới\";\r\n};\r\n\r\n/**\r\n * Lấy màu badge cho lifecycle stage\r\n */\r\nexport const getLifecycleStageVariant = (stage?: CustomerLifecycleStage): \r\n  'default' | 'secondary' | 'success' | 'warning' | 'destructive' => {\r\n  switch (stage) {\r\n    case \"Khách VIP\":\r\n      return \"success\";\r\n    case \"Khách thân thiết\":\r\n      return \"success\";\r\n    case \"Khách quay lại\":\r\n      return \"default\";\r\n    case \"Khách mới\":\r\n      return \"secondary\";\r\n    case \"Khách tiềm năng\":\r\n      return \"secondary\";\r\n    case \"Không hoạt động\":\r\n      return \"warning\";\r\n    case \"Mất khách\":\r\n      return \"destructive\";\r\n    default:\r\n      return \"secondary\";\r\n  }\r\n};\r\n\r\n/**\r\n * Cập nhật lifecycle stage cho tất cả customers (chạy batch)\r\n */\r\nexport const updateAllCustomerLifecycleStages = (customers: Customer[]): Customer[] => {\r\n  return customers.map(customer => ({\r\n    ...customer,\r\n    lifecycleStage: calculateLifecycleStage(customer)\r\n  }));\r\n};\r\n"],"names":[],"mappings":";;;;;;;;AACA;;AAIO,MAAM,0BAA0B,CAAC;IACtC,MAAM,cAAc,SAAS,WAAW,IAAI;IAC5C,MAAM,aAAa,SAAS,UAAU,IAAI;IAC1C,MAAM,mBAAmB,SAAS,gBAAgB;IAElD,uBAAuB;IACvB,IAAI,gBAAgB,GAAG;QACrB,OAAO;IACT;IAEA,+BAA+B;IAC/B,MAAM,wBAAwB,mBAC1B,IAAA,mIAAW,EAAC,IAAA,sIAAc,KAAI,IAAI,KAAK,qBACvC;IAEJ,sCAAsC;IACtC,IAAI,wBAAwB,KAAK;QAC/B,OAAO;IACT;IAEA,yCAAyC;IACzC,IAAI,wBAAwB,KAAK;QAC/B,OAAO;IACT;IAEA,4DAA4D;IAC5D,IAAI,cAAc,cAAc,eAAe,GAAG;QAChD,OAAO;IACT;IAEA,iCAAiC;IACjC,IAAI,eAAe,GAAG;QACpB,OAAO;IACT;IAEA,8BAA8B;IAC9B,IAAI,eAAe,GAAG;QACpB,OAAO;IACT;IAEA,yBAAyB;IACzB,OAAO;AACT;AAKO,MAAM,2BAA2B,CAAC;IAEvC,OAAQ;QACN,KAAK;YACH,OAAO;QACT,KAAK;YACH,OAAO;QACT,KAAK;YACH,OAAO;QACT,KAAK;YACH,OAAO;QACT,KAAK;YACH,OAAO;QACT,KAAK;YACH,OAAO;QACT,KAAK;YACH,OAAO;QACT;YACE,OAAO;IACX;AACF;AAKO,MAAM,mCAAmC,CAAC;IAC/C,OAAO,UAAU,GAAG,CAAC,CAAA,WAAY,CAAC;YAChC,GAAG,QAAQ;YACX,gBAAgB,wBAAwB;QAC1C,CAAC;AACH"}},
    {"offset": {"line": 335, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/customers/credit-utils.ts"],"sourcesContent":["import type { Customer } from './types';\r\n\r\nexport type CreditAlertLevel = 'safe' | 'warning' | 'danger' | 'exceeded';\r\n\r\n/**\r\n * Tính mức độ cảnh báo công nợ\r\n */\r\nexport const getCreditAlertLevel = (customer: Customer): CreditAlertLevel => {\r\n  const currentDebt = customer.currentDebt || 0;\r\n  const maxDebt = customer.maxDebt || 0;\r\n  \r\n  // Nếu không có hạn mức hoặc hạn mức = 0, không cảnh báo\r\n  if (maxDebt === 0) return 'safe';\r\n  \r\n  const debtRatio = (currentDebt / maxDebt) * 100;\r\n  \r\n  if (debtRatio >= 100) return 'exceeded';  // Vượt hạn mức\r\n  if (debtRatio >= 90) return 'danger';     // >= 90%\r\n  if (debtRatio >= 70) return 'warning';    // >= 70%\r\n  return 'safe';                             // < 70%\r\n};\r\n\r\n/**\r\n * Lấy variant Badge cho credit alert\r\n */\r\nexport const getCreditAlertBadgeVariant = (level: CreditAlertLevel): \r\n  'default' | 'secondary' | 'success' | 'warning' | 'destructive' => {\r\n  switch (level) {\r\n    case 'exceeded':\r\n    case 'danger':\r\n      return 'destructive';\r\n    case 'warning':\r\n      return 'warning';\r\n    case 'safe':\r\n      return 'success';\r\n    default:\r\n      return 'secondary';\r\n  }\r\n};\r\n\r\n/**\r\n * Lấy text cho credit alert\r\n */\r\nexport const getCreditAlertText = (level: CreditAlertLevel): string => {\r\n  switch (level) {\r\n    case 'exceeded':\r\n      return 'Vượt hạn mức';\r\n    case 'danger':\r\n      return 'Sắp vượt hạn';\r\n    case 'warning':\r\n      return 'Cần theo dõi';\r\n    case 'safe':\r\n      return 'An toàn';\r\n    default:\r\n      return '';\r\n  }\r\n};\r\n\r\n/**\r\n * Kiểm tra xem có thể tạo đơn hàng không (dựa vào công nợ)\r\n */\r\nexport const canCreateOrder = (customer: Customer, orderAmount: number): {\r\n  allowed: boolean;\r\n  reason?: string;\r\n} => {\r\n  const currentDebt = customer.currentDebt || 0;\r\n  const maxDebt = customer.maxDebt || 0;\r\n  \r\n  // Nếu không cho phép công nợ và có công nợ hiện tại\r\n  if (!customer.allowCredit && currentDebt > 0) {\r\n    return {\r\n      allowed: false,\r\n      reason: 'Khách hàng không được phép công nợ và còn nợ cũ'\r\n    };\r\n  }\r\n  \r\n  // Nếu có hạn mức công nợ\r\n  if (maxDebt > 0) {\r\n    const newDebt = currentDebt + orderAmount;\r\n    if (newDebt > maxDebt) {\r\n      return {\r\n        allowed: false,\r\n        reason: `Đơn hàng này sẽ vượt hạn mức công nợ (${formatCurrency(newDebt)} / ${formatCurrency(maxDebt)})`\r\n      };\r\n    }\r\n  }\r\n  \r\n  return { allowed: true };\r\n};\r\n\r\n/**\r\n * Lấy danh sách khách hàng có nguy cơ công nợ cao\r\n */\r\nexport const getHighRiskDebtCustomers = (customers: Customer[]): Customer[] => {\r\n  return customers.filter(customer => {\r\n    const level = getCreditAlertLevel(customer);\r\n    return level === 'danger' || level === 'exceeded';\r\n  }).sort((a, b) => {\r\n    const ratioA = ((a.currentDebt || 0) / (a.maxDebt || 1)) * 100;\r\n    const ratioB = ((b.currentDebt || 0) / (b.maxDebt || 1)) * 100;\r\n    return ratioB - ratioA; // Sort by ratio descending\r\n  });\r\n};\r\n\r\n/**\r\n * Helper format currency\r\n */\r\nconst formatCurrency = (value: number): string => {\r\n  return new Intl.NumberFormat('vi-VN', { \r\n    style: 'currency', \r\n    currency: 'VND' \r\n  }).format(value);\r\n};\r\n"],"names":[],"mappings":";;;;;;;;;;;;AAOO,MAAM,sBAAsB,CAAC;IAClC,MAAM,cAAc,SAAS,WAAW,IAAI;IAC5C,MAAM,UAAU,SAAS,OAAO,IAAI;IAEpC,wDAAwD;IACxD,IAAI,YAAY,GAAG,OAAO;IAE1B,MAAM,YAAY,AAAC,cAAc,UAAW;IAE5C,IAAI,aAAa,KAAK,OAAO,YAAa,eAAe;IACzD,IAAI,aAAa,IAAI,OAAO,UAAc,SAAS;IACnD,IAAI,aAAa,IAAI,OAAO,WAAc,SAAS;IACnD,OAAO,QAAoC,QAAQ;AACrD;AAKO,MAAM,6BAA6B,CAAC;IAEzC,OAAQ;QACN,KAAK;QACL,KAAK;YACH,OAAO;QACT,KAAK;YACH,OAAO;QACT,KAAK;YACH,OAAO;QACT;YACE,OAAO;IACX;AACF;AAKO,MAAM,qBAAqB,CAAC;IACjC,OAAQ;QACN,KAAK;YACH,OAAO;QACT,KAAK;YACH,OAAO;QACT,KAAK;YACH,OAAO;QACT,KAAK;YACH,OAAO;QACT;YACE,OAAO;IACX;AACF;AAKO,MAAM,iBAAiB,CAAC,UAAoB;IAIjD,MAAM,cAAc,SAAS,WAAW,IAAI;IAC5C,MAAM,UAAU,SAAS,OAAO,IAAI;IAEpC,oDAAoD;IACpD,IAAI,CAAC,SAAS,WAAW,IAAI,cAAc,GAAG;QAC5C,OAAO;YACL,SAAS;YACT,QAAQ;QACV;IACF;IAEA,yBAAyB;IACzB,IAAI,UAAU,GAAG;QACf,MAAM,UAAU,cAAc;QAC9B,IAAI,UAAU,SAAS;YACrB,OAAO;gBACL,SAAS;gBACT,QAAQ,CAAC,sCAAsC,EAAE,eAAe,SAAS,GAAG,EAAE,eAAe,SAAS,CAAC,CAAC;YAC1G;QACF;IACF;IAEA,OAAO;QAAE,SAAS;IAAK;AACzB;AAKO,MAAM,2BAA2B,CAAC;IACvC,OAAO,UAAU,MAAM,CAAC,CAAA;QACtB,MAAM,QAAQ,oBAAoB;QAClC,OAAO,UAAU,YAAY,UAAU;IACzC,GAAG,IAAI,CAAC,CAAC,GAAG;QACV,MAAM,SAAS,AAAC,CAAC,EAAE,WAAW,IAAI,CAAC,IAAI,CAAC,EAAE,OAAO,IAAI,CAAC,IAAK;QAC3D,MAAM,SAAS,AAAC,CAAC,EAAE,WAAW,IAAI,CAAC,IAAI,CAAC,EAAE,OAAO,IAAI,CAAC,IAAK;QAC3D,OAAO,SAAS,QAAQ,2BAA2B;IACrD;AACF;AAEA;;CAEC,GACD,MAAM,iBAAiB,CAAC;IACtB,OAAO,IAAI,KAAK,YAAY,CAAC,SAAS;QACpC,OAAO;QACP,UAAU;IACZ,GAAG,MAAM,CAAC;AACZ"}},
    {"offset": {"line": 431, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/customers/debt-tracking-utils.ts"],"sourcesContent":["import type { Customer, DebtStatus, DebtTransaction } from './types';\r\nimport { formatDate, formatDateTime, formatDateTimeSeconds, formatDateCustom, getCurrentDate, addDays, getDaysDiff, isDateBefore, toISODate } from '@/lib/date-utils';\r\n/**\r\n * Tính ngày đến hạn dựa trên ngày đơn hàng và payment terms\r\n */\r\nexport const calculateDueDate = (orderDate: string, paymentTermsDays: number): string => {\r\n  return toISODate(addDays(new Date(orderDate), paymentTermsDays));\r\n};\r\n\r\n/**\r\n * Parse payment terms string thành số ngày\r\n * \"NET30\" → 30, \"NET15\" → 15, \"COD\" → 0\r\n */\r\nexport const parsePaymentTerms = (paymentTerms?: string): number => {\r\n  if (!paymentTerms) return 0;\r\n  \r\n  const match = paymentTerms.match(/NET(\\d+)/i);\r\n  if (match) {\r\n    return parseInt(match[1], 10);\r\n  }\r\n  \r\n  if (paymentTerms.toUpperCase() === 'COD') {\r\n    return 0; // COD = thanh toán ngay\r\n  }\r\n  \r\n  return 30; // Default 30 ngày\r\n};\r\n\r\n/**\r\n * Tính số ngày quá hạn (nếu > 0 thì quá hạn)\r\n */\r\nexport const calculateDaysOverdue = (dueDate: string): number => {\r\n  const days = getDaysDiff(getCurrentDate(), new Date(dueDate));\r\n  return days > 0 ? days : 0;\r\n};\r\n\r\n/**\r\n * Tính số ngày còn lại đến hạn (nếu > 0 thì chưa đến hạn)\r\n */\r\nexport const calculateDaysUntilDue = (dueDate: string): number => {\r\n  return getDaysDiff(new Date(dueDate), getCurrentDate());\r\n};\r\n\r\n/**\r\n * Phân loại trạng thái công nợ dựa trên ngày đến hạn\r\n */\r\nexport const getDebtStatus = (dueDate: string, hasDebt: boolean): DebtStatus | null => {\r\n  if (!hasDebt) return null;\r\n  \r\n  const daysUntilDue = calculateDaysUntilDue(dueDate);\r\n  \r\n  // Chưa đến hạn\r\n  if (daysUntilDue > 3) return \"Chưa đến hạn\";\r\n  \r\n  // Sắp đến hạn (1-3 ngày)\r\n  if (daysUntilDue >= 1 && daysUntilDue <= 3) return \"Sắp đến hạn\";\r\n  \r\n  // Đến hạn hôm nay\r\n  if (daysUntilDue === 0) return \"Đến hạn hôm nay\";\r\n  \r\n  // Quá hạn\r\n  const daysOverdue = Math.abs(daysUntilDue);\r\n  \r\n  if (daysOverdue >= 1 && daysOverdue <= 7) return \"Quá hạn 1-7 ngày\";\r\n  if (daysOverdue >= 8 && daysOverdue <= 15) return \"Quá hạn 8-15 ngày\";\r\n  if (daysOverdue >= 16 && daysOverdue <= 30) return \"Quá hạn 16-30 ngày\";\r\n  \r\n  return \"Quá hạn > 30 ngày\";\r\n};\r\n\r\n/**\r\n * Lấy variant cho badge trạng thái công nợ\r\n */\r\nexport const getDebtStatusVariant = (status?: DebtStatus | null): \r\n  'default' | 'secondary' | 'success' | 'warning' | 'destructive' => {\r\n  if (!status) return 'secondary';\r\n  \r\n  switch (status) {\r\n    case \"Chưa đến hạn\":\r\n      return \"secondary\";\r\n    case \"Sắp đến hạn\":\r\n      return \"default\";\r\n    case \"Đến hạn hôm nay\":\r\n      return \"warning\";\r\n    case \"Quá hạn 1-7 ngày\":\r\n      return \"warning\";\r\n    case \"Quá hạn 8-15 ngày\":\r\n    case \"Quá hạn 16-30 ngày\":\r\n    case \"Quá hạn > 30 ngày\":\r\n      return \"destructive\";\r\n    default:\r\n      return \"secondary\";\r\n  }\r\n};\r\n\r\n/**\r\n * Tính toán debt tracking info cho customer\r\n */\r\nexport const calculateDebtTrackingInfo = (customer: Customer): {\r\n  oldestDebtDueDate?: string;\r\n  maxDaysOverdue: number;\r\n  debtStatus?: DebtStatus | null;\r\n} => {\r\n  const debtTransactions = customer.debtTransactions || [];\r\n  const unpaidTransactions = debtTransactions.filter(t => !t.isPaid);\r\n  \r\n  if (unpaidTransactions.length === 0 || !customer.currentDebt || customer.currentDebt === 0) {\r\n    return {\r\n      maxDaysOverdue: 0,\r\n      debtStatus: null\r\n    };\r\n  }\r\n  \r\n  // Tìm giao dịch có dueDate sớm nhất (nợ lâu nhất)\r\n  const oldestTransaction = unpaidTransactions.reduce((oldest, current) => {\r\n    return isDateBefore(new Date(current.dueDate), new Date(oldest.dueDate)) ? current : oldest;\r\n  });\r\n  \r\n  const oldestDebtDueDate = oldestTransaction.dueDate;\r\n  const maxDaysOverdue = calculateDaysOverdue(oldestDebtDueDate);\r\n  const debtStatus = getDebtStatus(oldestDebtDueDate, true);\r\n  \r\n  return {\r\n    oldestDebtDueDate,\r\n    maxDaysOverdue,\r\n    debtStatus\r\n  };\r\n};\r\n\r\n/**\r\n * Lấy danh sách khách hàng có nợ quá hạn, sắp xếp theo mức độ ưu tiên\r\n */\r\nexport const getOverdueDebtCustomers = (customers: Customer[]): Customer[] => {\r\n  return customers\r\n    .filter(c => {\r\n      const info = calculateDebtTrackingInfo(c);\r\n      return info.maxDaysOverdue > 0; // Chỉ lấy KH quá hạn\r\n    })\r\n    .sort((a, b) => {\r\n      const infoA = calculateDebtTrackingInfo(a);\r\n      const infoB = calculateDebtTrackingInfo(b);\r\n      \r\n      // Sắp xếp theo số ngày quá hạn (giảm dần)\r\n      return (infoB.maxDaysOverdue || 0) - (infoA.maxDaysOverdue || 0);\r\n    });\r\n};\r\n\r\n/**\r\n * Lấy danh sách khách hàng sắp đến hạn thanh toán (1-3 ngày)\r\n */\r\nexport const getDueSoonCustomers = (customers: Customer[]): Customer[] => {\r\n  return customers\r\n    .filter(c => {\r\n      const info = calculateDebtTrackingInfo(c);\r\n      if (!info.oldestDebtDueDate) return false;\r\n      \r\n      const daysUntil = calculateDaysUntilDue(info.oldestDebtDueDate);\r\n      return daysUntil >= 1 && daysUntil <= 3;\r\n    })\r\n    .sort((a, b) => {\r\n      const infoA = calculateDebtTrackingInfo(a);\r\n      const infoB = calculateDebtTrackingInfo(b);\r\n      \r\n      const daysA = infoA.oldestDebtDueDate ? calculateDaysUntilDue(infoA.oldestDebtDueDate) : 999;\r\n      const daysB = infoB.oldestDebtDueDate ? calculateDaysUntilDue(infoB.oldestDebtDueDate) : 999;\r\n      \r\n      return daysA - daysB; // Sắp xếp theo ngày đến hạn (tăng dần)\r\n    });\r\n};\r\n\r\n/**\r\n * Tính tổng công nợ quá hạn\r\n */\r\nexport const calculateTotalOverdueDebt = (customers: Customer[]): number => {\r\n  return getOverdueDebtCustomers(customers).reduce((sum, c) => sum + (c.currentDebt || 0), 0);\r\n};\r\n\r\n/**\r\n * Tính tổng công nợ sắp đến hạn\r\n */\r\nexport const calculateTotalDueSoonDebt = (customers: Customer[]): number => {\r\n  return getDueSoonCustomers(customers).reduce((sum, c) => sum + (c.currentDebt || 0), 0);\r\n};\r\n\r\n/**\r\n * Format ngày hiển thị\r\n */\r\nexport const formatDebtDate = (dateString?: string): string => {\r\n  if (!dateString) return '-';\r\n  return formatDate(dateString);\r\n};\r\n\r\n/**\r\n * Helper format currency\r\n */\r\nexport const formatCurrency = (value?: number): string => {\r\n  if (typeof value !== 'number') return '0 ₫';\r\n  return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(value);\r\n};\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 585, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/customers/store.ts"],"sourcesContent":["import { create } from 'zustand';\r\nimport { createCrudStore, CrudState } from '../../lib/store-factory';\r\n// REMOVED: import { data as initialData } from './data'; // Mock data no longer used - database is source of truth\r\nimport type { Customer } from './types';\r\nimport { SystemId, BusinessId } from '../../lib/id-types';\r\nimport { calculateLifecycleStage } from './lifecycle-utils';\r\nimport { getHighRiskDebtCustomers } from './credit-utils';\r\nimport { \r\n  calculateRFMScores, \r\n  getCustomerSegment, \r\n  calculateHealthScore,\r\n  calculateChurnRisk \r\n} from './intelligence-utils';\r\nimport { getOverdueDebtCustomers, getDueSoonCustomers } from './debt-tracking-utils';\r\nimport Fuse from 'fuse.js';\r\nimport { getCurrentUserSystemId } from '../../contexts/auth-context';\r\nimport {\r\n  getCurrentUserInfo,\r\n  createCreatedEntry,\r\n  createUpdatedEntry,\r\n  createStatusChangedEntry,\r\n  appendHistoryEntry,\r\n  type HistoryEntry\r\n} from '../../lib/activity-history-helper';\r\n\r\nconst baseStore = createCrudStore<Customer>([], 'customers', {\r\n  businessIdField: 'id',\r\n  getCurrentUser: getCurrentUserSystemId, // Track who creates/updates\r\n  apiEndpoint: '/api/customers',\r\n});\r\n\r\n// ✅ API Sync helpers\r\nconst API_ENDPOINT = '/api/customers';\r\n\r\nconst syncToApi = {\r\n  create: async (customer: Customer) => {\r\n    try {\r\n      const response = await fetch(API_ENDPOINT, {\r\n        method: 'POST',\r\n        credentials: 'include',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify(customer),\r\n      });\r\n      if (!response.ok) console.warn('[Customer API] Create sync failed');\r\n      else console.log('[Customer API] Created:', customer.systemId);\r\n    } catch (e) {\r\n      console.warn('[Customer API] Create sync error:', e);\r\n    }\r\n  },\r\n  update: async (systemId: SystemId, updates: Partial<Customer>) => {\r\n    try {\r\n      const response = await fetch(`${API_ENDPOINT}/${systemId}`, {\r\n        method: 'PATCH',\r\n        credentials: 'include',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify(updates),\r\n      });\r\n      if (!response.ok) console.warn('[Customer API] Update sync failed');\r\n      else console.log('[Customer API] Updated:', systemId);\r\n    } catch (e) {\r\n      console.warn('[Customer API] Update sync error:', e);\r\n    }\r\n  },\r\n  delete: async (systemId: SystemId, hard = false) => {\r\n    try {\r\n      const response = await fetch(`${API_ENDPOINT}/${systemId}`, {\r\n        method: 'DELETE',\r\n        credentials: 'include',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({ hard }),\r\n      });\r\n      if (!response.ok) console.warn('[Customer API] Delete sync failed');\r\n      else console.log('[Customer API] Deleted:', systemId);\r\n    } catch (e) {\r\n      console.warn('[Customer API] Delete sync error:', e);\r\n    }\r\n  },\r\n  restore: async (systemId: SystemId) => {\r\n    try {\r\n      const response = await fetch(`${API_ENDPOINT}/${systemId}/restore`, {\r\n        method: 'POST',\r\n        credentials: 'include',\r\n        headers: { 'Content-Type': 'application/json' },\r\n      });\r\n      if (!response.ok) console.warn('[Customer API] Restore sync failed');\r\n      else console.log('[Customer API] Restored:', systemId);\r\n    } catch (e) {\r\n      console.warn('[Customer API] Restore sync error:', e);\r\n    }\r\n  },\r\n};\r\n\r\n// ✅ Wrap base store methods with API sync\r\nconst originalAdd = baseStore.getState().add;\r\nconst originalUpdate = baseStore.getState().update;\r\nconst originalRemove = baseStore.getState().remove;\r\nconst originalHardDelete = baseStore.getState().hardDelete;\r\nconst originalRestore = baseStore.getState().restore;\r\n\r\nbaseStore.setState({\r\n  add: (item: Omit<Customer, 'systemId'>) => {\r\n    const result = originalAdd(item);\r\n    syncToApi.create(result);\r\n    return result;\r\n  },\r\n  update: (systemId: SystemId, updates: Partial<Customer>) => {\r\n    originalUpdate(systemId, updates);\r\n    syncToApi.update(systemId, updates);\r\n  },\r\n  remove: (systemId: SystemId) => {\r\n    originalRemove(systemId);\r\n    syncToApi.delete(systemId, false);\r\n  },\r\n  hardDelete: (systemId: SystemId) => {\r\n    originalHardDelete(systemId);\r\n    syncToApi.delete(systemId, true);\r\n  },\r\n  restore: (systemId: SystemId) => {\r\n    originalRestore(systemId);\r\n    syncToApi.restore(systemId);\r\n  },\r\n});\r\n\r\n// Define enhanced interface\r\ninterface CustomerStoreState extends CrudState<Customer> {\r\n  searchCustomers: (query: string, page: number, limit?: number) => Promise<{ items: { value: string; label: string }[], hasNextPage: boolean }>;\r\n  updateDebt: (systemId: SystemId, amountChange: number) => void;\r\n  incrementOrderStats: (systemId: SystemId, orderValue: number) => void;\r\n  decrementOrderStats: (systemId: SystemId, orderValue: number) => void;\r\n  incrementReturnStats: (systemId: SystemId, quantity: number) => void;\r\n  incrementFailedDeliveryStats: (systemId: SystemId) => void;\r\n  addDebtTransaction: (systemId: SystemId, transaction: import('./types').DebtTransaction) => void;\r\n  addDebtReminder: (systemId: SystemId, reminder: import('./types').DebtReminder) => void;\r\n  updateDebtReminder: (systemId: SystemId, reminderId: SystemId, updates: Partial<import('./types').DebtReminder>) => void;\r\n  removeDebtReminder: (systemId: SystemId, reminderId: SystemId) => void;\r\n  updateDebtTransactionPayment: (systemId: SystemId, orderId: BusinessId, amountPaid: number) => void;\r\n  removeDebtTransaction: (systemId: SystemId, orderId: BusinessId) => void;\r\n  getHighRiskDebtCustomers: () => Customer[];\r\n  updateCustomerIntelligence: () => void; // Batch update RFM, health score, churn risk\r\n  getCustomersBySegment: (segment: string) => Customer[];\r\n  getOverdueDebtCustomers: () => Customer[];\r\n  getDueSoonCustomers: () => Customer[];\r\n    removeMany: (systemIds: SystemId[]) => void;\r\n    updateManyStatus: (systemIds: SystemId[], status: Customer['status']) => void;\r\n    restoreMany: (systemIds: SystemId[]) => void;\r\n}\r\n\r\n// Augmented methods\r\nconst augmentedMethods = {\r\n    searchCustomers: async (query: string, page: number, limit: number = 20) => {\r\n        return new Promise<{ items: { value: string; label: string }[], hasNextPage: boolean }>(resolve => {\r\n            setTimeout(() => {\r\n                const allCustomers = baseStore.getState().data;\r\n                \r\n                // Create fresh Fuse instance with current data (avoid stale data)\r\n                const fuse = new Fuse(allCustomers, {\r\n                    keys: ['name', 'id', 'phone'],\r\n                    threshold: 0.3,\r\n                });\r\n                \r\n                const results = query ? fuse.search(query).map(r => r.item) : allCustomers;\r\n                \r\n                const start = (page - 1) * limit;\r\n                const end = start + limit;\r\n                const paginatedItems = results.slice(start, end);\r\n\r\n                resolve({\r\n                    items: paginatedItems.map(c => ({ value: c.systemId, label: c.name })),\r\n                    hasNextPage: end < results.length,\r\n                });\r\n            }, 300);\r\n        });\r\n    },\r\n    updateDebt: (systemId: SystemId, amountChange: number) => {\r\n        baseStore.setState(state => ({\r\n            data: state.data.map(customer => {\r\n                if (customer.systemId === systemId) {\r\n                    const newDebt = (customer.currentDebt || 0) + amountChange;\r\n                    // Sync to API\r\n                    syncToApi.update(systemId, { currentDebt: newDebt });\r\n                    return {\r\n                        ...customer,\r\n                        currentDebt: newDebt,\r\n                    };\r\n                }\r\n                return customer;\r\n            })\r\n        }));\r\n    },\r\n    incrementOrderStats: (systemId: SystemId, orderValue: number) => {\r\n        const allCustomers = baseStore.getState().getActive();\r\n        \r\n        baseStore.setState(state => ({\r\n            data: state.data.map(customer => {\r\n                if (customer.systemId === systemId) {\r\n                    const updatedCustomer = {\r\n                        ...customer,\r\n                        totalOrders: (customer.totalOrders || 0) + 1,\r\n                        totalSpent: (customer.totalSpent || 0) + orderValue,\r\n                        lastPurchaseDate: new Date().toISOString().split('T')[0],\r\n                    };\r\n                    \r\n                    // Auto-update intelligence after order stats change\r\n                    const rfmScores = calculateRFMScores(updatedCustomer, allCustomers);\r\n                    const segment = getCustomerSegment(rfmScores);\r\n                    const healthScore = calculateHealthScore(updatedCustomer);\r\n                    const churnRisk = calculateChurnRisk(updatedCustomer).risk;\r\n                    const lifecycleStage = calculateLifecycleStage(updatedCustomer);\r\n                    \r\n                    return {\r\n                        ...updatedCustomer,\r\n                        rfmScores,\r\n                        segment,\r\n                        healthScore,\r\n                        churnRisk,\r\n                        lifecycleStage,\r\n                    };\r\n                }\r\n                return customer;\r\n            })\r\n        }));\r\n    },\r\n    decrementOrderStats: (systemId: SystemId, orderValue: number) => {\r\n        const allCustomers = baseStore.getState().getActive();\r\n        \r\n        baseStore.setState(state => ({\r\n            data: state.data.map(customer => {\r\n                if (customer.systemId === systemId) {\r\n                    const updatedCustomer = {\r\n                        ...customer,\r\n                        totalOrders: Math.max(0, (customer.totalOrders || 0) - 1),\r\n                        totalSpent: Math.max(0, (customer.totalSpent || 0) - orderValue),\r\n                    };\r\n                    \r\n                    // Auto-update intelligence after order stats change\r\n                    const rfmScores = calculateRFMScores(updatedCustomer, allCustomers);\r\n                    const segment = getCustomerSegment(rfmScores);\r\n                    const healthScore = calculateHealthScore(updatedCustomer);\r\n                    const churnRisk = calculateChurnRisk(updatedCustomer).risk;\r\n                    const lifecycleStage = calculateLifecycleStage(updatedCustomer);\r\n                    \r\n                    return {\r\n                        ...updatedCustomer,\r\n                        rfmScores,\r\n                        segment,\r\n                        healthScore,\r\n                        churnRisk,\r\n                        lifecycleStage,\r\n                    };\r\n                }\r\n                return customer;\r\n            })\r\n        }));\r\n    },\r\n    incrementReturnStats: (systemId: SystemId, quantity: number) => {\r\n        baseStore.setState(state => ({\r\n            data: state.data.map(customer => {\r\n                if (customer.systemId === systemId) {\r\n                    return {\r\n                        ...customer,\r\n                        totalQuantityReturned: (customer.totalQuantityReturned || 0) + quantity,\r\n                    };\r\n                }\r\n                return customer;\r\n            })\r\n        }));\r\n    },\r\n    incrementFailedDeliveryStats: (systemId: SystemId) => {\r\n        baseStore.setState(state => ({\r\n            data: state.data.map(customer => {\r\n                if (customer.systemId === systemId) {\r\n                    return {\r\n                        ...customer,\r\n                        failedDeliveries: (customer.failedDeliveries || 0) + 1,\r\n                    };\r\n                }\r\n                return customer;\r\n            })\r\n        }));\r\n    },\r\n    addDebtTransaction: (systemId: SystemId, transaction: import('./types').DebtTransaction) => {\r\n        baseStore.setState(state => ({\r\n            data: state.data.map(customer => {\r\n                if (customer.systemId === systemId) {\r\n                    const currentTransactions = customer.debtTransactions || [];\r\n                    // Avoid duplicates\r\n                    if (currentTransactions.some(t => t.orderId === transaction.orderId)) {\r\n                        return customer;\r\n                    }\r\n\r\n                    const outstandingAmount = Math.max(transaction.remainingAmount ?? transaction.amount ?? 0, 0);\r\n                    return {\r\n                        ...customer,\r\n                        currentDebt: Math.max(0, (customer.currentDebt || 0) + outstandingAmount),\r\n                        debtTransactions: [...currentTransactions, transaction],\r\n                    };\r\n                }\r\n                return customer;\r\n            })\r\n        }));\r\n    },\r\n    updateDebtTransactionPayment: (systemId: SystemId, orderId: BusinessId, amountPaid: number) => {\r\n        baseStore.setState(state => ({\r\n            data: state.data.map(customer => {\r\n                if (customer.systemId === systemId && customer.debtTransactions) {\r\n                    let debtDelta = 0;\r\n                    const updatedTransactions = customer.debtTransactions.map(t => {\r\n                        if (t.orderId !== orderId) {\r\n                            return t;\r\n                        }\r\n\r\n                        const currentPaid = t.paidAmount || 0;\r\n                        const currentRemaining = t.remainingAmount ?? Math.max(t.amount - currentPaid, 0);\r\n                        let appliedAmount = amountPaid;\r\n\r\n                        if (appliedAmount > 0) {\r\n                            appliedAmount = Math.min(appliedAmount, currentRemaining);\r\n                        } else if (appliedAmount < 0) {\r\n                            appliedAmount = Math.max(appliedAmount, -currentPaid);\r\n                        }\r\n\r\n                        const newPaidAmount = currentPaid + appliedAmount;\r\n                        const recalculatedRemaining = Math.max(t.amount - newPaidAmount, 0);\r\n                        debtDelta -= appliedAmount;\r\n\r\n                        return {\r\n                            ...t,\r\n                            paidAmount: newPaidAmount,\r\n                            remainingAmount: recalculatedRemaining,\r\n                            isPaid: recalculatedRemaining <= 0,\r\n                            paidDate: recalculatedRemaining <= 0 ? new Date().toISOString().split('T')[0] : t.paidDate,\r\n                        };\r\n                    });\r\n\r\n                    return {\r\n                        ...customer,\r\n                        currentDebt: Math.max(0, (customer.currentDebt || 0) + debtDelta),\r\n                        debtTransactions: updatedTransactions,\r\n                    };\r\n                }\r\n                return customer;\r\n            })\r\n        }));\r\n    },\r\n    removeDebtTransaction: (systemId: SystemId, orderId: BusinessId) => {\r\n        baseStore.setState(state => ({\r\n            data: state.data.map(customer => {\r\n                if (customer.systemId === systemId && customer.debtTransactions) {\r\n                    const transaction = customer.debtTransactions.find(t => t.orderId === orderId);\r\n                    const outstanding = transaction\r\n                        ? Math.max(transaction.remainingAmount ?? (transaction.amount - (transaction.paidAmount || 0)), 0)\r\n                        : 0;\r\n                    return {\r\n                        ...customer,\r\n                        currentDebt: Math.max(0, (customer.currentDebt || 0) - outstanding),\r\n                        debtTransactions: customer.debtTransactions.filter(t => t.orderId !== orderId),\r\n                    };\r\n                }\r\n                return customer;\r\n            })\r\n        }));\r\n    },\r\n    // Add debt reminder (3.3)\r\n    addDebtReminder: (systemId: SystemId, reminder: import('./types').DebtReminder) => {\r\n        baseStore.setState(state => ({\r\n            data: state.data.map(customer => {\r\n                if (customer.systemId === systemId) {\r\n                    const currentReminders = customer.debtReminders || [];\r\n                    return {\r\n                        ...customer,\r\n                        debtReminders: [...currentReminders, reminder],\r\n                    };\r\n                }\r\n                return customer;\r\n            })\r\n        }));\r\n    },\r\n    // Update debt reminder (3.3)\r\n    updateDebtReminder: (systemId: SystemId, reminderId: SystemId, updates: Partial<import('./types').DebtReminder>) => {\r\n        baseStore.setState(state => ({\r\n            data: state.data.map(customer => {\r\n                if (customer.systemId === systemId && customer.debtReminders) {\r\n                    return {\r\n                        ...customer,\r\n                        debtReminders: customer.debtReminders.map(r =>\r\n                            r.systemId === reminderId ? { ...r, ...updates } : r\r\n                        ),\r\n                    };\r\n                }\r\n                return customer;\r\n            })\r\n        }));\r\n    },\r\n    // Remove debt reminder (3.3)\r\n    removeDebtReminder: (systemId: SystemId, reminderId: SystemId) => {\r\n        baseStore.setState(state => ({\r\n            data: state.data.map(customer => {\r\n                if (customer.systemId === systemId && customer.debtReminders) {\r\n                    return {\r\n                        ...customer,\r\n                        debtReminders: customer.debtReminders.filter(r => r.systemId !== reminderId),\r\n                    };\r\n                }\r\n                return customer;\r\n            })\r\n        }));\r\n    },\r\n    // Override add to auto-calculate lifecycle stage and log activity\r\n    add: (customer: Omit<Customer, 'systemId'>) => {\r\n        const userInfo = getCurrentUserInfo();\r\n        const customerWithLifecycle = {\r\n            ...customer,\r\n            lifecycleStage: calculateLifecycleStage(customer as Customer)\r\n        };\r\n        const newCustomer = baseStore.getState().add(customerWithLifecycle);\r\n        \r\n        // Add activity history entry\r\n        const historyEntry = createCreatedEntry(\r\n            userInfo,\r\n            `${userInfo.name} đã tạo khách hàng ${newCustomer.name} (${newCustomer.id})`\r\n        );\r\n        baseStore.getState().update(newCustomer.systemId, {\r\n            ...newCustomer,\r\n            activityHistory: [historyEntry]\r\n        });\r\n        \r\n        return newCustomer;\r\n    },\r\n    // Override update to auto-calculate lifecycle stage and log activity\r\n    update: (systemId: SystemId, updatedCustomer: Customer) => {\r\n        console.log('[CustomerStore] update called:', { systemId, updatedCustomer });\r\n        \r\n        const userInfo = getCurrentUserInfo();\r\n        const existingCustomer = baseStore.getState().data.find(c => c.systemId === systemId);\r\n        const historyEntries: HistoryEntry[] = [];\r\n        \r\n        if (existingCustomer) {\r\n            // Track status changes\r\n            if (existingCustomer.status !== updatedCustomer.status) {\r\n                historyEntries.push(createStatusChangedEntry(\r\n                    userInfo,\r\n                    existingCustomer.status,\r\n                    updatedCustomer.status,\r\n                    `${userInfo.name} đã đổi trạng thái từ \"${existingCustomer.status}\" sang \"${updatedCustomer.status}\"`\r\n                ));\r\n            }\r\n            \r\n            // Track field changes\r\n            const fieldsToTrack: Array<{ key: keyof Customer; label: string }> = [\r\n                { key: 'name', label: 'Tên khách hàng' },\r\n                { key: 'email', label: 'Email' },\r\n                { key: 'phone', label: 'Số điện thoại' },\r\n                { key: 'company', label: 'Công ty' },\r\n                { key: 'taxCode', label: 'Mã số thuế' },\r\n                { key: 'representative', label: 'Người đại diện' },\r\n                { key: 'type', label: 'Loại khách hàng' },\r\n                { key: 'customerGroup', label: 'Nhóm khách hàng' },\r\n                { key: 'lifecycleStage', label: 'Giai đoạn vòng đời' },\r\n                { key: 'maxDebt', label: 'Hạn mức công nợ' },\r\n                { key: 'paymentTerms', label: 'Điều khoản thanh toán' },\r\n                { key: 'creditRating', label: 'Xếp hạng tín dụng' },\r\n                { key: 'pricingLevel', label: 'Mức giá' },\r\n                { key: 'defaultDiscount', label: 'Chiết khấu mặc định' },\r\n                { key: 'accountManagerId', label: 'Nhân viên phụ trách' },\r\n            ];\r\n            \r\n            const changes: string[] = [];\r\n            for (const field of fieldsToTrack) {\r\n                const oldVal = existingCustomer[field.key];\r\n                const newVal = updatedCustomer[field.key];\r\n                if (oldVal !== newVal && !(oldVal === undefined && newVal === undefined)) {\r\n                    // Skip if it's the status field (already tracked above)\r\n                    if (field.key === 'status') continue;\r\n                    const oldDisplay = oldVal !== undefined && oldVal !== null && oldVal !== '' ? String(oldVal) : '(trống)';\r\n                    const newDisplay = newVal !== undefined && newVal !== null && newVal !== '' ? String(newVal) : '(trống)';\r\n                    changes.push(`${field.label}: ${oldDisplay} → ${newDisplay}`);\r\n                }\r\n            }\r\n            \r\n            if (changes.length > 0) {\r\n                historyEntries.push(createUpdatedEntry(\r\n                    userInfo,\r\n                    `${userInfo.name} đã cập nhật: ${changes.join(', ')}`\r\n                ));\r\n            }\r\n        }\r\n        \r\n        const customerWithLifecycle = {\r\n            ...updatedCustomer,\r\n            lifecycleStage: calculateLifecycleStage(updatedCustomer),\r\n            activityHistory: appendHistoryEntry(existingCustomer?.activityHistory, ...historyEntries)\r\n        };\r\n        console.log('[CustomerStore] Calling baseStore.update with:', customerWithLifecycle);\r\n        \r\n        // Call the update function from baseStore directly\r\n        baseStore.getState().update(systemId, customerWithLifecycle);\r\n        \r\n        console.log('[CustomerStore] State after update:', baseStore.getState().data.find(c => c.systemId === systemId));\r\n    },\r\n    // Get customers with high debt risk\r\n    getHighRiskDebtCustomers: () => {\r\n        const activeCustomers = baseStore.getState().getActive();\r\n        return getHighRiskDebtCustomers(activeCustomers);\r\n    },\r\n    // Batch update customer intelligence (RFM, health score, churn risk)\r\n    updateCustomerIntelligence: () => {\r\n        const allCustomers = baseStore.getState().getActive();\r\n        \r\n        baseStore.setState(state => ({\r\n            data: state.data.map(customer => {\r\n                if (customer.isDeleted) return customer;\r\n                \r\n                // Calculate RFM\r\n                const rfmScores = calculateRFMScores(customer, allCustomers);\r\n                const segment = getCustomerSegment(rfmScores);\r\n                \r\n                // Calculate health score\r\n                const healthScore = calculateHealthScore(customer);\r\n                \r\n                // Calculate churn risk\r\n                const churnRisk = calculateChurnRisk(customer).risk;\r\n                \r\n                // Calculate lifecycle stage\r\n                const lifecycleStage = calculateLifecycleStage(customer);\r\n                \r\n                return {\r\n                    ...customer,\r\n                    rfmScores,\r\n                    segment,\r\n                    healthScore,\r\n                    churnRisk,\r\n                    lifecycleStage\r\n                };\r\n            })\r\n        }));\r\n    },\r\n    // Get customers by segment\r\n    getCustomersBySegment: (segment: string) => {\r\n        return baseStore.getState().getActive().filter(c => c.segment === segment);\r\n    },\r\n    // Get customers with overdue debt\r\n    getOverdueDebtCustomers: () => {\r\n        const activeCustomers = baseStore.getState().getActive();\r\n        return getOverdueDebtCustomers(activeCustomers);\r\n    },\r\n    // Get customers with debt due soon\r\n    getDueSoonCustomers: () => {\r\n        const activeCustomers = baseStore.getState().getActive();\r\n        return getDueSoonCustomers(activeCustomers);\r\n    },\r\n    removeMany: (systemIds: SystemId[]) => {\r\n        if (!systemIds.length) return;\r\n        const deletedAtTimestamp = new Date().toISOString();\r\n        baseStore.setState(state => ({\r\n            data: state.data.map(customer =>\r\n                systemIds.includes(customer.systemId)\r\n                    ? { ...customer, isDeleted: true, deletedAt: deletedAtTimestamp }\r\n                    : customer\r\n            )\r\n        }));\r\n    },\r\n    updateManyStatus: (systemIds: SystemId[], status: Customer['status']) => {\r\n        if (!systemIds.length) return;\r\n        baseStore.setState(state => ({\r\n            data: state.data.map(customer =>\r\n                systemIds.includes(customer.systemId)\r\n                    ? { ...customer, status }\r\n                    : customer\r\n            )\r\n        }));\r\n    },\r\n    restoreMany: (systemIds: SystemId[]) => {\r\n        if (!systemIds.length) return;\r\n        baseStore.setState(state => ({\r\n            data: state.data.map(customer =>\r\n                systemIds.includes(customer.systemId)\r\n                    ? { ...customer, isDeleted: false, deletedAt: null }\r\n                    : customer\r\n            )\r\n        }));\r\n    }\r\n};\r\n\r\ntype CustomerStoreSelector<T> = (state: CustomerStoreState) => T;\r\n\r\nlet cachedBaseState: CrudState<Customer> | null = null;\r\nlet cachedCombinedState: CustomerStoreState | null = null;\r\n\r\nconst getCombinedState = (state: CrudState<Customer>): CustomerStoreState => {\r\n    if (cachedBaseState !== state || !cachedCombinedState) {\r\n        cachedBaseState = state;\r\n        cachedCombinedState = { ...state, ...augmentedMethods } as CustomerStoreState;\r\n    }\r\n    return cachedCombinedState!;\r\n};\r\n\r\nconst boundStore = baseStore as unknown as {\r\n    <R>(selector: (state: CrudState<Customer>) => R, equalityFn?: (a: R, b: R) => boolean): R;\r\n    (): CustomerStoreState;\r\n};\r\n\r\nexport const useCustomerStore = <T = CustomerStoreState>(\r\n    selector?: CustomerStoreSelector<T>,\r\n    equalityFn?: (a: T, b: T) => boolean\r\n): T => {\r\n    if (selector) {\r\n        if (equalityFn) {\r\n            return boundStore((state) => selector(getCombinedState(state)), equalityFn);\r\n        }\r\n        return boundStore((state) => selector(getCombinedState(state)));\r\n    }\r\n    return boundStore((state) => getCombinedState(state) as unknown as T);\r\n};\r\n\r\nuseCustomerStore.getState = (): CustomerStoreState => {\r\n    return getCombinedState(baseStore.getState());\r\n};\r\n"],"names":[],"mappings":";;;;AACA;AAIA;AACA;AACA;AAMA;AACA;AACA;AACA;;;;;;;;;AASA,MAAM,YAAY,IAAA,0IAAe,EAAW,EAAE,EAAE,aAAa;IAC3D,iBAAiB;IACjB,gBAAgB,sJAAsB;IACtC,aAAa;AACf;AAEA,qBAAqB;AACrB,MAAM,eAAe;AAErB,MAAM,YAAY;IAChB,QAAQ,OAAO;QACb,IAAI;YACF,MAAM,WAAW,MAAM,MAAM,cAAc;gBACzC,QAAQ;gBACR,aAAa;gBACb,SAAS;oBAAE,gBAAgB;gBAAmB;gBAC9C,MAAM,KAAK,SAAS,CAAC;YACvB;YACA,IAAI,CAAC,SAAS,EAAE,EAAE,QAAQ,IAAI,CAAC;iBAC1B,QAAQ,GAAG,CAAC,2BAA2B,SAAS,QAAQ;QAC/D,EAAE,OAAO,GAAG;YACV,QAAQ,IAAI,CAAC,qCAAqC;QACpD;IACF;IACA,QAAQ,OAAO,UAAoB;QACjC,IAAI;YACF,MAAM,WAAW,MAAM,MAAM,GAAG,aAAa,CAAC,EAAE,UAAU,EAAE;gBAC1D,QAAQ;gBACR,aAAa;gBACb,SAAS;oBAAE,gBAAgB;gBAAmB;gBAC9C,MAAM,KAAK,SAAS,CAAC;YACvB;YACA,IAAI,CAAC,SAAS,EAAE,EAAE,QAAQ,IAAI,CAAC;iBAC1B,QAAQ,GAAG,CAAC,2BAA2B;QAC9C,EAAE,OAAO,GAAG;YACV,QAAQ,IAAI,CAAC,qCAAqC;QACpD;IACF;IACA,QAAQ,OAAO,UAAoB,OAAO,KAAK;QAC7C,IAAI;YACF,MAAM,WAAW,MAAM,MAAM,GAAG,aAAa,CAAC,EAAE,UAAU,EAAE;gBAC1D,QAAQ;gBACR,aAAa;gBACb,SAAS;oBAAE,gBAAgB;gBAAmB;gBAC9C,MAAM,KAAK,SAAS,CAAC;oBAAE;gBAAK;YAC9B;YACA,IAAI,CAAC,SAAS,EAAE,EAAE,QAAQ,IAAI,CAAC;iBAC1B,QAAQ,GAAG,CAAC,2BAA2B;QAC9C,EAAE,OAAO,GAAG;YACV,QAAQ,IAAI,CAAC,qCAAqC;QACpD;IACF;IACA,SAAS,OAAO;QACd,IAAI;YACF,MAAM,WAAW,MAAM,MAAM,GAAG,aAAa,CAAC,EAAE,SAAS,QAAQ,CAAC,EAAE;gBAClE,QAAQ;gBACR,aAAa;gBACb,SAAS;oBAAE,gBAAgB;gBAAmB;YAChD;YACA,IAAI,CAAC,SAAS,EAAE,EAAE,QAAQ,IAAI,CAAC;iBAC1B,QAAQ,GAAG,CAAC,4BAA4B;QAC/C,EAAE,OAAO,GAAG;YACV,QAAQ,IAAI,CAAC,sCAAsC;QACrD;IACF;AACF;AAEA,0CAA0C;AAC1C,MAAM,cAAc,UAAU,QAAQ,GAAG,GAAG;AAC5C,MAAM,iBAAiB,UAAU,QAAQ,GAAG,MAAM;AAClD,MAAM,iBAAiB,UAAU,QAAQ,GAAG,MAAM;AAClD,MAAM,qBAAqB,UAAU,QAAQ,GAAG,UAAU;AAC1D,MAAM,kBAAkB,UAAU,QAAQ,GAAG,OAAO;AAEpD,UAAU,QAAQ,CAAC;IACjB,KAAK,CAAC;QACJ,MAAM,SAAS,YAAY;QAC3B,UAAU,MAAM,CAAC;QACjB,OAAO;IACT;IACA,QAAQ,CAAC,UAAoB;QAC3B,eAAe,UAAU;QACzB,UAAU,MAAM,CAAC,UAAU;IAC7B;IACA,QAAQ,CAAC;QACP,eAAe;QACf,UAAU,MAAM,CAAC,UAAU;IAC7B;IACA,YAAY,CAAC;QACX,mBAAmB;QACnB,UAAU,MAAM,CAAC,UAAU;IAC7B;IACA,SAAS,CAAC;QACR,gBAAgB;QAChB,UAAU,OAAO,CAAC;IACpB;AACF;AA0BA,oBAAoB;AACpB,MAAM,mBAAmB;IACrB,iBAAiB,OAAO,OAAe,MAAc,QAAgB,EAAE;QACnE,OAAO,IAAI,QAA6E,CAAA;YACpF,WAAW;gBACP,MAAM,eAAe,UAAU,QAAQ,GAAG,IAAI;gBAE9C,kEAAkE;gBAClE,MAAM,OAAO,IAAI,sJAAI,CAAC,cAAc;oBAChC,MAAM;wBAAC;wBAAQ;wBAAM;qBAAQ;oBAC7B,WAAW;gBACf;gBAEA,MAAM,UAAU,QAAQ,KAAK,MAAM,CAAC,OAAO,GAAG,CAAC,CAAA,IAAK,EAAE,IAAI,IAAI;gBAE9D,MAAM,QAAQ,CAAC,OAAO,CAAC,IAAI;gBAC3B,MAAM,MAAM,QAAQ;gBACpB,MAAM,iBAAiB,QAAQ,KAAK,CAAC,OAAO;gBAE5C,QAAQ;oBACJ,OAAO,eAAe,GAAG,CAAC,CAAA,IAAK,CAAC;4BAAE,OAAO,EAAE,QAAQ;4BAAE,OAAO,EAAE,IAAI;wBAAC,CAAC;oBACpE,aAAa,MAAM,QAAQ,MAAM;gBACrC;YACJ,GAAG;QACP;IACJ;IACA,YAAY,CAAC,UAAoB;QAC7B,UAAU,QAAQ,CAAC,CAAA,QAAS,CAAC;gBACzB,MAAM,MAAM,IAAI,CAAC,GAAG,CAAC,CAAA;oBACjB,IAAI,SAAS,QAAQ,KAAK,UAAU;wBAChC,MAAM,UAAU,CAAC,SAAS,WAAW,IAAI,CAAC,IAAI;wBAC9C,cAAc;wBACd,UAAU,MAAM,CAAC,UAAU;4BAAE,aAAa;wBAAQ;wBAClD,OAAO;4BACH,GAAG,QAAQ;4BACX,aAAa;wBACjB;oBACJ;oBACA,OAAO;gBACX;YACJ,CAAC;IACL;IACA,qBAAqB,CAAC,UAAoB;QACtC,MAAM,eAAe,UAAU,QAAQ,GAAG,SAAS;QAEnD,UAAU,QAAQ,CAAC,CAAA,QAAS,CAAC;gBACzB,MAAM,MAAM,IAAI,CAAC,GAAG,CAAC,CAAA;oBACjB,IAAI,SAAS,QAAQ,KAAK,UAAU;wBAChC,MAAM,kBAAkB;4BACpB,GAAG,QAAQ;4BACX,aAAa,CAAC,SAAS,WAAW,IAAI,CAAC,IAAI;4BAC3C,YAAY,CAAC,SAAS,UAAU,IAAI,CAAC,IAAI;4BACzC,kBAAkB,IAAI,OAAO,WAAW,GAAG,KAAK,CAAC,IAAI,CAAC,EAAE;wBAC5D;wBAEA,oDAAoD;wBACpD,MAAM,YAAY,IAAA,oKAAkB,EAAC,iBAAiB;wBACtD,MAAM,UAAU,IAAA,oKAAkB,EAAC;wBACnC,MAAM,cAAc,IAAA,sKAAoB,EAAC;wBACzC,MAAM,YAAY,IAAA,oKAAkB,EAAC,iBAAiB,IAAI;wBAC1D,MAAM,iBAAiB,IAAA,sKAAuB,EAAC;wBAE/C,OAAO;4BACH,GAAG,eAAe;4BAClB;4BACA;4BACA;4BACA;4BACA;wBACJ;oBACJ;oBACA,OAAO;gBACX;YACJ,CAAC;IACL;IACA,qBAAqB,CAAC,UAAoB;QACtC,MAAM,eAAe,UAAU,QAAQ,GAAG,SAAS;QAEnD,UAAU,QAAQ,CAAC,CAAA,QAAS,CAAC;gBACzB,MAAM,MAAM,IAAI,CAAC,GAAG,CAAC,CAAA;oBACjB,IAAI,SAAS,QAAQ,KAAK,UAAU;wBAChC,MAAM,kBAAkB;4BACpB,GAAG,QAAQ;4BACX,aAAa,KAAK,GAAG,CAAC,GAAG,CAAC,SAAS,WAAW,IAAI,CAAC,IAAI;4BACvD,YAAY,KAAK,GAAG,CAAC,GAAG,CAAC,SAAS,UAAU,IAAI,CAAC,IAAI;wBACzD;wBAEA,oDAAoD;wBACpD,MAAM,YAAY,IAAA,oKAAkB,EAAC,iBAAiB;wBACtD,MAAM,UAAU,IAAA,oKAAkB,EAAC;wBACnC,MAAM,cAAc,IAAA,sKAAoB,EAAC;wBACzC,MAAM,YAAY,IAAA,oKAAkB,EAAC,iBAAiB,IAAI;wBAC1D,MAAM,iBAAiB,IAAA,sKAAuB,EAAC;wBAE/C,OAAO;4BACH,GAAG,eAAe;4BAClB;4BACA;4BACA;4BACA;4BACA;wBACJ;oBACJ;oBACA,OAAO;gBACX;YACJ,CAAC;IACL;IACA,sBAAsB,CAAC,UAAoB;QACvC,UAAU,QAAQ,CAAC,CAAA,QAAS,CAAC;gBACzB,MAAM,MAAM,IAAI,CAAC,GAAG,CAAC,CAAA;oBACjB,IAAI,SAAS,QAAQ,KAAK,UAAU;wBAChC,OAAO;4BACH,GAAG,QAAQ;4BACX,uBAAuB,CAAC,SAAS,qBAAqB,IAAI,CAAC,IAAI;wBACnE;oBACJ;oBACA,OAAO;gBACX;YACJ,CAAC;IACL;IACA,8BAA8B,CAAC;QAC3B,UAAU,QAAQ,CAAC,CAAA,QAAS,CAAC;gBACzB,MAAM,MAAM,IAAI,CAAC,GAAG,CAAC,CAAA;oBACjB,IAAI,SAAS,QAAQ,KAAK,UAAU;wBAChC,OAAO;4BACH,GAAG,QAAQ;4BACX,kBAAkB,CAAC,SAAS,gBAAgB,IAAI,CAAC,IAAI;wBACzD;oBACJ;oBACA,OAAO;gBACX;YACJ,CAAC;IACL;IACA,oBAAoB,CAAC,UAAoB;QACrC,UAAU,QAAQ,CAAC,CAAA,QAAS,CAAC;gBACzB,MAAM,MAAM,IAAI,CAAC,GAAG,CAAC,CAAA;oBACjB,IAAI,SAAS,QAAQ,KAAK,UAAU;wBAChC,MAAM,sBAAsB,SAAS,gBAAgB,IAAI,EAAE;wBAC3D,mBAAmB;wBACnB,IAAI,oBAAoB,IAAI,CAAC,CAAA,IAAK,EAAE,OAAO,KAAK,YAAY,OAAO,GAAG;4BAClE,OAAO;wBACX;wBAEA,MAAM,oBAAoB,KAAK,GAAG,CAAC,YAAY,eAAe,IAAI,YAAY,MAAM,IAAI,GAAG;wBAC3F,OAAO;4BACH,GAAG,QAAQ;4BACX,aAAa,KAAK,GAAG,CAAC,GAAG,CAAC,SAAS,WAAW,IAAI,CAAC,IAAI;4BACvD,kBAAkB;mCAAI;gCAAqB;6BAAY;wBAC3D;oBACJ;oBACA,OAAO;gBACX;YACJ,CAAC;IACL;IACA,8BAA8B,CAAC,UAAoB,SAAqB;QACpE,UAAU,QAAQ,CAAC,CAAA,QAAS,CAAC;gBACzB,MAAM,MAAM,IAAI,CAAC,GAAG,CAAC,CAAA;oBACjB,IAAI,SAAS,QAAQ,KAAK,YAAY,SAAS,gBAAgB,EAAE;wBAC7D,IAAI,YAAY;wBAChB,MAAM,sBAAsB,SAAS,gBAAgB,CAAC,GAAG,CAAC,CAAA;4BACtD,IAAI,EAAE,OAAO,KAAK,SAAS;gCACvB,OAAO;4BACX;4BAEA,MAAM,cAAc,EAAE,UAAU,IAAI;4BACpC,MAAM,mBAAmB,EAAE,eAAe,IAAI,KAAK,GAAG,CAAC,EAAE,MAAM,GAAG,aAAa;4BAC/E,IAAI,gBAAgB;4BAEpB,IAAI,gBAAgB,GAAG;gCACnB,gBAAgB,KAAK,GAAG,CAAC,eAAe;4BAC5C,OAAO,IAAI,gBAAgB,GAAG;gCAC1B,gBAAgB,KAAK,GAAG,CAAC,eAAe,CAAC;4BAC7C;4BAEA,MAAM,gBAAgB,cAAc;4BACpC,MAAM,wBAAwB,KAAK,GAAG,CAAC,EAAE,MAAM,GAAG,eAAe;4BACjE,aAAa;4BAEb,OAAO;gCACH,GAAG,CAAC;gCACJ,YAAY;gCACZ,iBAAiB;gCACjB,QAAQ,yBAAyB;gCACjC,UAAU,yBAAyB,IAAI,IAAI,OAAO,WAAW,GAAG,KAAK,CAAC,IAAI,CAAC,EAAE,GAAG,EAAE,QAAQ;4BAC9F;wBACJ;wBAEA,OAAO;4BACH,GAAG,QAAQ;4BACX,aAAa,KAAK,GAAG,CAAC,GAAG,CAAC,SAAS,WAAW,IAAI,CAAC,IAAI;4BACvD,kBAAkB;wBACtB;oBACJ;oBACA,OAAO;gBACX;YACJ,CAAC;IACL;IACA,uBAAuB,CAAC,UAAoB;QACxC,UAAU,QAAQ,CAAC,CAAA,QAAS,CAAC;gBACzB,MAAM,MAAM,IAAI,CAAC,GAAG,CAAC,CAAA;oBACjB,IAAI,SAAS,QAAQ,KAAK,YAAY,SAAS,gBAAgB,EAAE;wBAC7D,MAAM,cAAc,SAAS,gBAAgB,CAAC,IAAI,CAAC,CAAA,IAAK,EAAE,OAAO,KAAK;wBACtE,MAAM,cAAc,cACd,KAAK,GAAG,CAAC,YAAY,eAAe,IAAK,YAAY,MAAM,GAAG,CAAC,YAAY,UAAU,IAAI,CAAC,GAAI,KAC9F;wBACN,OAAO;4BACH,GAAG,QAAQ;4BACX,aAAa,KAAK,GAAG,CAAC,GAAG,CAAC,SAAS,WAAW,IAAI,CAAC,IAAI;4BACvD,kBAAkB,SAAS,gBAAgB,CAAC,MAAM,CAAC,CAAA,IAAK,EAAE,OAAO,KAAK;wBAC1E;oBACJ;oBACA,OAAO;gBACX;YACJ,CAAC;IACL;IACA,0BAA0B;IAC1B,iBAAiB,CAAC,UAAoB;QAClC,UAAU,QAAQ,CAAC,CAAA,QAAS,CAAC;gBACzB,MAAM,MAAM,IAAI,CAAC,GAAG,CAAC,CAAA;oBACjB,IAAI,SAAS,QAAQ,KAAK,UAAU;wBAChC,MAAM,mBAAmB,SAAS,aAAa,IAAI,EAAE;wBACrD,OAAO;4BACH,GAAG,QAAQ;4BACX,eAAe;mCAAI;gCAAkB;6BAAS;wBAClD;oBACJ;oBACA,OAAO;gBACX;YACJ,CAAC;IACL;IACA,6BAA6B;IAC7B,oBAAoB,CAAC,UAAoB,YAAsB;QAC3D,UAAU,QAAQ,CAAC,CAAA,QAAS,CAAC;gBACzB,MAAM,MAAM,IAAI,CAAC,GAAG,CAAC,CAAA;oBACjB,IAAI,SAAS,QAAQ,KAAK,YAAY,SAAS,aAAa,EAAE;wBAC1D,OAAO;4BACH,GAAG,QAAQ;4BACX,eAAe,SAAS,aAAa,CAAC,GAAG,CAAC,CAAA,IACtC,EAAE,QAAQ,KAAK,aAAa;oCAAE,GAAG,CAAC;oCAAE,GAAG,OAAO;gCAAC,IAAI;wBAE3D;oBACJ;oBACA,OAAO;gBACX;YACJ,CAAC;IACL;IACA,6BAA6B;IAC7B,oBAAoB,CAAC,UAAoB;QACrC,UAAU,QAAQ,CAAC,CAAA,QAAS,CAAC;gBACzB,MAAM,MAAM,IAAI,CAAC,GAAG,CAAC,CAAA;oBACjB,IAAI,SAAS,QAAQ,KAAK,YAAY,SAAS,aAAa,EAAE;wBAC1D,OAAO;4BACH,GAAG,QAAQ;4BACX,eAAe,SAAS,aAAa,CAAC,MAAM,CAAC,CAAA,IAAK,EAAE,QAAQ,KAAK;wBACrE;oBACJ;oBACA,OAAO;gBACX;YACJ,CAAC;IACL;IACA,kEAAkE;IAClE,KAAK,CAAC;QACF,MAAM,WAAW,IAAA,0JAAkB;QACnC,MAAM,wBAAwB;YAC1B,GAAG,QAAQ;YACX,gBAAgB,IAAA,sKAAuB,EAAC;QAC5C;QACA,MAAM,cAAc,UAAU,QAAQ,GAAG,GAAG,CAAC;QAE7C,6BAA6B;QAC7B,MAAM,eAAe,IAAA,0JAAkB,EACnC,UACA,GAAG,SAAS,IAAI,CAAC,mBAAmB,EAAE,YAAY,IAAI,CAAC,EAAE,EAAE,YAAY,EAAE,CAAC,CAAC,CAAC;QAEhF,UAAU,QAAQ,GAAG,MAAM,CAAC,YAAY,QAAQ,EAAE;YAC9C,GAAG,WAAW;YACd,iBAAiB;gBAAC;aAAa;QACnC;QAEA,OAAO;IACX;IACA,qEAAqE;IACrE,QAAQ,CAAC,UAAoB;QACzB,QAAQ,GAAG,CAAC,kCAAkC;YAAE;YAAU;QAAgB;QAE1E,MAAM,WAAW,IAAA,0JAAkB;QACnC,MAAM,mBAAmB,UAAU,QAAQ,GAAG,IAAI,CAAC,IAAI,CAAC,CAAA,IAAK,EAAE,QAAQ,KAAK;QAC5E,MAAM,iBAAiC,EAAE;QAEzC,IAAI,kBAAkB;YAClB,uBAAuB;YACvB,IAAI,iBAAiB,MAAM,KAAK,gBAAgB,MAAM,EAAE;gBACpD,eAAe,IAAI,CAAC,IAAA,gKAAwB,EACxC,UACA,iBAAiB,MAAM,EACvB,gBAAgB,MAAM,EACtB,GAAG,SAAS,IAAI,CAAC,uBAAuB,EAAE,iBAAiB,MAAM,CAAC,QAAQ,EAAE,gBAAgB,MAAM,CAAC,CAAC,CAAC;YAE7G;YAEA,sBAAsB;YACtB,MAAM,gBAA+D;gBACjE;oBAAE,KAAK;oBAAQ,OAAO;gBAAiB;gBACvC;oBAAE,KAAK;oBAAS,OAAO;gBAAQ;gBAC/B;oBAAE,KAAK;oBAAS,OAAO;gBAAgB;gBACvC;oBAAE,KAAK;oBAAW,OAAO;gBAAU;gBACnC;oBAAE,KAAK;oBAAW,OAAO;gBAAa;gBACtC;oBAAE,KAAK;oBAAkB,OAAO;gBAAiB;gBACjD;oBAAE,KAAK;oBAAQ,OAAO;gBAAkB;gBACxC;oBAAE,KAAK;oBAAiB,OAAO;gBAAkB;gBACjD;oBAAE,KAAK;oBAAkB,OAAO;gBAAqB;gBACrD;oBAAE,KAAK;oBAAW,OAAO;gBAAkB;gBAC3C;oBAAE,KAAK;oBAAgB,OAAO;gBAAwB;gBACtD;oBAAE,KAAK;oBAAgB,OAAO;gBAAoB;gBAClD;oBAAE,KAAK;oBAAgB,OAAO;gBAAU;gBACxC;oBAAE,KAAK;oBAAmB,OAAO;gBAAsB;gBACvD;oBAAE,KAAK;oBAAoB,OAAO;gBAAsB;aAC3D;YAED,MAAM,UAAoB,EAAE;YAC5B,KAAK,MAAM,SAAS,cAAe;gBAC/B,MAAM,SAAS,gBAAgB,CAAC,MAAM,GAAG,CAAC;gBAC1C,MAAM,SAAS,eAAe,CAAC,MAAM,GAAG,CAAC;gBACzC,IAAI,WAAW,UAAU,CAAC,CAAC,WAAW,aAAa,WAAW,SAAS,GAAG;oBACtE,wDAAwD;oBACxD,IAAI,MAAM,GAAG,KAAK,UAAU;oBAC5B,MAAM,aAAa,WAAW,aAAa,WAAW,QAAQ,WAAW,KAAK,OAAO,UAAU;oBAC/F,MAAM,aAAa,WAAW,aAAa,WAAW,QAAQ,WAAW,KAAK,OAAO,UAAU;oBAC/F,QAAQ,IAAI,CAAC,GAAG,MAAM,KAAK,CAAC,EAAE,EAAE,WAAW,GAAG,EAAE,YAAY;gBAChE;YACJ;YAEA,IAAI,QAAQ,MAAM,GAAG,GAAG;gBACpB,eAAe,IAAI,CAAC,IAAA,0JAAkB,EAClC,UACA,GAAG,SAAS,IAAI,CAAC,cAAc,EAAE,QAAQ,IAAI,CAAC,OAAO;YAE7D;QACJ;QAEA,MAAM,wBAAwB;YAC1B,GAAG,eAAe;YAClB,gBAAgB,IAAA,sKAAuB,EAAC;YACxC,iBAAiB,IAAA,0JAAkB,EAAC,kBAAkB,oBAAoB;QAC9E;QACA,QAAQ,GAAG,CAAC,kDAAkD;QAE9D,mDAAmD;QACnD,UAAU,QAAQ,GAAG,MAAM,CAAC,UAAU;QAEtC,QAAQ,GAAG,CAAC,uCAAuC,UAAU,QAAQ,GAAG,IAAI,CAAC,IAAI,CAAC,CAAA,IAAK,EAAE,QAAQ,KAAK;IAC1G;IACA,oCAAoC;IACpC,0BAA0B;QACtB,MAAM,kBAAkB,UAAU,QAAQ,GAAG,SAAS;QACtD,OAAO,IAAA,oKAAwB,EAAC;IACpC;IACA,qEAAqE;IACrE,4BAA4B;QACxB,MAAM,eAAe,UAAU,QAAQ,GAAG,SAAS;QAEnD,UAAU,QAAQ,CAAC,CAAA,QAAS,CAAC;gBACzB,MAAM,MAAM,IAAI,CAAC,GAAG,CAAC,CAAA;oBACjB,IAAI,SAAS,SAAS,EAAE,OAAO;oBAE/B,gBAAgB;oBAChB,MAAM,YAAY,IAAA,oKAAkB,EAAC,UAAU;oBAC/C,MAAM,UAAU,IAAA,oKAAkB,EAAC;oBAEnC,yBAAyB;oBACzB,MAAM,cAAc,IAAA,sKAAoB,EAAC;oBAEzC,uBAAuB;oBACvB,MAAM,YAAY,IAAA,oKAAkB,EAAC,UAAU,IAAI;oBAEnD,4BAA4B;oBAC5B,MAAM,iBAAiB,IAAA,sKAAuB,EAAC;oBAE/C,OAAO;wBACH,GAAG,QAAQ;wBACX;wBACA;wBACA;wBACA;wBACA;oBACJ;gBACJ;YACJ,CAAC;IACL;IACA,2BAA2B;IAC3B,uBAAuB,CAAC;QACpB,OAAO,UAAU,QAAQ,GAAG,SAAS,GAAG,MAAM,CAAC,CAAA,IAAK,EAAE,OAAO,KAAK;IACtE;IACA,kCAAkC;IAClC,yBAAyB;QACrB,MAAM,kBAAkB,UAAU,QAAQ,GAAG,SAAS;QACtD,OAAO,IAAA,6KAAuB,EAAC;IACnC;IACA,mCAAmC;IACnC,qBAAqB;QACjB,MAAM,kBAAkB,UAAU,QAAQ,GAAG,SAAS;QACtD,OAAO,IAAA,yKAAmB,EAAC;IAC/B;IACA,YAAY,CAAC;QACT,IAAI,CAAC,UAAU,MAAM,EAAE;QACvB,MAAM,qBAAqB,IAAI,OAAO,WAAW;QACjD,UAAU,QAAQ,CAAC,CAAA,QAAS,CAAC;gBACzB,MAAM,MAAM,IAAI,CAAC,GAAG,CAAC,CAAA,WACjB,UAAU,QAAQ,CAAC,SAAS,QAAQ,IAC9B;wBAAE,GAAG,QAAQ;wBAAE,WAAW;wBAAM,WAAW;oBAAmB,IAC9D;YAEd,CAAC;IACL;IACA,kBAAkB,CAAC,WAAuB;QACtC,IAAI,CAAC,UAAU,MAAM,EAAE;QACvB,UAAU,QAAQ,CAAC,CAAA,QAAS,CAAC;gBACzB,MAAM,MAAM,IAAI,CAAC,GAAG,CAAC,CAAA,WACjB,UAAU,QAAQ,CAAC,SAAS,QAAQ,IAC9B;wBAAE,GAAG,QAAQ;wBAAE;oBAAO,IACtB;YAEd,CAAC;IACL;IACA,aAAa,CAAC;QACV,IAAI,CAAC,UAAU,MAAM,EAAE;QACvB,UAAU,QAAQ,CAAC,CAAA,QAAS,CAAC;gBACzB,MAAM,MAAM,IAAI,CAAC,GAAG,CAAC,CAAA,WACjB,UAAU,QAAQ,CAAC,SAAS,QAAQ,IAC9B;wBAAE,GAAG,QAAQ;wBAAE,WAAW;wBAAO,WAAW;oBAAK,IACjD;YAEd,CAAC;IACL;AACJ;AAIA,IAAI,kBAA8C;AAClD,IAAI,sBAAiD;AAErD,MAAM,mBAAmB,CAAC;IACtB,IAAI,oBAAoB,SAAS,CAAC,qBAAqB;QACnD,kBAAkB;QAClB,sBAAsB;YAAE,GAAG,KAAK;YAAE,GAAG,gBAAgB;QAAC;IAC1D;IACA,OAAO;AACX;AAEA,MAAM,aAAa;AAKZ,MAAM,mBAAmB,CAC5B,UACA;IAEA,IAAI,UAAU;QACV,IAAI,YAAY;YACZ,OAAO,WAAW,CAAC,QAAU,SAAS,iBAAiB,SAAS;QACpE;QACA,OAAO,WAAW,CAAC,QAAU,SAAS,iBAAiB;IAC3D;IACA,OAAO,WAAW,CAAC,QAAU,iBAAiB;AAClD;AAEA,iBAAiB,QAAQ,GAAG;IACxB,OAAO,iBAAiB,UAAU,QAAQ;AAC9C"}},
    {"offset": {"line": 1192, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/customers/utils/address-conversion-helper.ts"],"sourcesContent":["/**\r\n * Address Conversion Helper\r\n * \r\n * Logic chuyển đổi địa chỉ 2 cấp → 3 cấp\r\n * Tìm các gợi ý District+Ward dựa trên Province+Ward input\r\n */\r\n\r\nimport { useProvinceStore } from '@/features/settings/provinces/store';\r\nimport type { Ward, District } from '@/features/settings/provinces/types';\r\nimport { asBusinessId } from '@/lib/id-types';\r\n\r\nexport type WardSuggestion = {\r\n  ward: Ward;\r\n  district: District;\r\n  fullAddress: string;\r\n  matchScore: number; // 0-100 (cao = match tốt)\r\n};\r\n\r\n/**\r\n * Tìm các ward gợi ý dựa trên input 2 cấp\r\n * \r\n * Logic:\r\n * 1. Tìm xem wardName có chứa tên District không\r\n *    VD: \"X. Gia Lâm\" → Tìm \"Huyện Gia Lâm\"\r\n * 2. Nếu có → Lấy TẤT CẢ wards trong District đó\r\n * 3. Nếu không → Tìm wards có tên giống/gần giống\r\n * \r\n * @example\r\n * findMatchingWards(\"101\", \"X. Gia Lâm\")\r\n * // Returns: 25 suggestions (6 new + 19 old wards in Huyện Gia Lâm)\r\n */\r\nexport function findMatchingWards(\r\n  provinceId: string,\r\n  wardName: string\r\n): WardSuggestion[] {\r\n  const { \r\n    wards, \r\n    districts, \r\n    getDistrictsByProvinceId, \r\n    getWardsByDistrictId \r\n  } = useProvinceStore.getState();\r\n\r\n  const suggestions: WardSuggestion[] = [];\r\n  const businessProvinceId = asBusinessId(provinceId);\r\n  \r\n  // Normalize input\r\n  const normalizedInput = normalizeText(wardName);\r\n  \r\n  // Extract core name (remove prefix like \"Phường\", \"Xã\", etc.)\r\n  const coreWardName = normalizedInput\r\n    .replace(/^(phuong|xa|thi tran|tt)\\s+/i, '')\r\n    .trim();\r\n  \r\n  // Step 1: Tìm TẤT CẢ wards có tên giống trong province\r\n  // VD: \"Xã Bát Tràng\" → Tìm tất cả ward có tên \"Bát Tràng\" trong province\r\n  for (const ward of wards) {\r\n    // Chỉ tìm trong province hiện tại và phải có districtId (3 cấp)\r\n    if (ward.provinceId !== businessProvinceId || !ward.districtId) continue;\r\n    \r\n    const normalizedWard = normalizeText(ward.name);\r\n    const coreWardNameCompare = normalizedWard\r\n      .replace(/^(phuong|xa|thi tran|tt)\\s+/i, '')\r\n      .trim();\r\n    \r\n    // Exact match với core name hoặc full match\r\n    if (coreWardNameCompare === coreWardName || \r\n        normalizedWard === normalizedInput ||\r\n        coreWardNameCompare.includes(coreWardName) ||\r\n        coreWardName.includes(coreWardNameCompare)) {\r\n      \r\n      // Tìm district tương ứng\r\n      const district = districts.find(d => d.id === ward.districtId);\r\n      \r\n      if (district) {\r\n        suggestions.push({\r\n          ward,\r\n          district,\r\n          fullAddress: `${ward.name}, ${district.name}`,\r\n          matchScore: calculateMatchScore(wardName, ward.name, district.name, 'exact_match'),\r\n        });\r\n      }\r\n    }\r\n  }\r\n  \r\n  // Step 2: Nếu không tìm thấy exact match → Tìm district có tên giống wardName\r\n  // VD: \"Phường Hoàn Kiếm\" → Tìm \"Quận Hoàn Kiếm\"\r\n  if (suggestions.length === 0) {\r\n    const provinceDistricts = getDistrictsByProvinceId(businessProvinceId);\r\n    \r\n    for (const district of provinceDistricts) {\r\n      const normalizedDistrict = normalizeText(district.name);\r\n      const coreDistrictName = normalizedDistrict\r\n        .replace(/^(quan|huyen|thi xa|thanh pho|tp)\\s+/i, '')\r\n        .trim();\r\n      \r\n      // Check if wardName contains district name\r\n      if (coreWardName.includes(coreDistrictName) || \r\n          coreDistrictName.includes(coreWardName) ||\r\n          normalizedInput.includes(normalizedDistrict)) {\r\n        \r\n        // Lấy TẤT CẢ wards trong district này\r\n        const districtWards = getWardsByDistrictId(district.id);\r\n        \r\n        for (const ward of districtWards) {\r\n          suggestions.push({\r\n            ward,\r\n            district,\r\n            fullAddress: `${ward.name}, ${district.name}`,\r\n            matchScore: calculateMatchScore(wardName, ward.name, district.name, 'district_match'),\r\n          });\r\n        }\r\n      }\r\n    }\r\n  }\r\n  \r\n  // Step 3: Nếu vẫn không tìm thấy → Fuzzy match\r\n  if (suggestions.length === 0) {\r\n    for (const ward of wards) {\r\n      // Chỉ tìm trong province hiện tại\r\n      if (ward.provinceId !== businessProvinceId) continue;\r\n      \r\n      const normalizedWard = normalizeText(ward.name);\r\n      const coreWardNameCompare = normalizedWard\r\n        .replace(/^(phuong|xa|thi tran|tt)\\s+/i, '')\r\n        .trim();\r\n      \r\n      // Fuzzy match với core name\r\n      if (coreWardNameCompare.includes(coreWardName) || \r\n          coreWardName.includes(coreWardNameCompare) ||\r\n          normalizedWard.includes(normalizedInput) || \r\n          normalizedInput.includes(normalizedWard)) {\r\n        \r\n        // Tìm district tương ứng\r\n        const district = ward.districtId \r\n          ? districts.find(d => d.id === ward.districtId)\r\n          : null;\r\n        \r\n        if (district) {\r\n          suggestions.push({\r\n            ward,\r\n            district,\r\n            fullAddress: `${ward.name}, ${district.name}`,\r\n            matchScore: calculateMatchScore(wardName, ward.name, district.name, 'ward_match'),\r\n          });\r\n        }\r\n      }\r\n    }\r\n  }\r\n  \r\n  // Sort by match score (cao → thấp)\r\n  return suggestions.sort((a, b) => b.matchScore - a.matchScore);\r\n}\r\n\r\n/**\r\n * Normalize text for matching\r\n * - Lowercase\r\n * - Remove accents (dấu)\r\n * - Remove special chars\r\n * - Trim whitespace\r\n */\r\nfunction normalizeText(text: string): string {\r\n  return text\r\n    .toLowerCase()\r\n    .normalize('NFD')\r\n    .replace(/[\\u0300-\\u036f]/g, '') // Remove dấu\r\n    .replace(/[đĐ]/g, 'd')\r\n    .replace(/[^a-z0-9\\s]/g, '') // Remove special chars\r\n    .trim();\r\n}\r\n\r\n/**\r\n * Calculate match score (0-100)\r\n */\r\nfunction calculateMatchScore(\r\n  input: string,\r\n  wardName: string,\r\n  districtName: string,\r\n  matchType: 'exact_match' | 'district_match' | 'ward_match'\r\n): number {\r\n  const normalizedInput = normalizeText(input);\r\n  const normalizedWard = normalizeText(wardName);\r\n  const normalizedDistrict = normalizeText(districtName);\r\n  \r\n  // Remove prefix để so sánh core name\r\n  const coreInput = normalizedInput.replace(/^(phuong|xa|thi tran|tt)\\s+/i, '').trim();\r\n  const coreWard = normalizedWard.replace(/^(phuong|xa|thi tran|tt)\\s+/i, '').trim();\r\n  \r\n  let score = 0;\r\n  \r\n  if (matchType === 'exact_match') {\r\n    // Exact match → Điểm cao nhất (90-100)\r\n    score = 90;\r\n    \r\n    // Bonus: Core name exact match\r\n    if (coreWard === coreInput) {\r\n      score = 100;\r\n    } else if (normalizedWard === normalizedInput) {\r\n      score = 95;\r\n    }\r\n  } else if (matchType === 'district_match') {\r\n    // District match → Điểm cao (70-100)\r\n    score = 70;\r\n    \r\n    // Bonus: Ward name cũng match\r\n    if (normalizedWard.includes(normalizedInput)) {\r\n      score += 20;\r\n    }\r\n    \r\n    // Bonus: Exact match\r\n    if (normalizedWard === normalizedInput) {\r\n      score = 100;\r\n    }\r\n  } else {\r\n    // Ward match → Điểm thấp hơn (30-60)\r\n    score = 30;\r\n    \r\n    // Bonus: Match tốt hơn\r\n    const matchLength = longestCommonSubstring(normalizedInput, normalizedWard);\r\n    score += Math.min(30, (matchLength / normalizedInput.length) * 30);\r\n  }\r\n  \r\n  return Math.min(100, score);\r\n}\r\n\r\n/**\r\n * Find longest common substring\r\n */\r\nfunction longestCommonSubstring(str1: string, str2: string): number {\r\n  let longest = 0;\r\n  for (let i = 0; i < str1.length; i++) {\r\n    for (let j = 0; j < str2.length; j++) {\r\n      let len = 0;\r\n      while (\r\n        i + len < str1.length &&\r\n        j + len < str2.length &&\r\n        str1[i + len] === str2[j + len]\r\n      ) {\r\n        len++;\r\n      }\r\n      longest = Math.max(longest, len);\r\n    }\r\n  }\r\n  return longest;\r\n}\r\n\r\n/**\r\n * Format gợi ý để hiển thị trong dialog\r\n */\r\nexport function formatSuggestion(suggestion: WardSuggestion): string {\r\n  const { ward, district } = suggestion;\r\n  const levelBadge = ward.level === 'new' ? '🆕' : ward.level === 'old' ? '📦' : '';\r\n  \r\n  return `${ward.name}, ${district.name} ${levelBadge}`;\r\n}\r\n"],"names":[],"mappings":";;;;;;AAAA;;;;;CAKC,GAED;AAEA;;;AAsBO,SAAS,kBACd,UAAkB,EAClB,QAAgB;IAEhB,MAAM,EACJ,KAAK,EACL,SAAS,EACT,wBAAwB,EACxB,oBAAoB,EACrB,GAAG,8JAAgB,CAAC,QAAQ;IAE7B,MAAM,cAAgC,EAAE;IACxC,MAAM,qBAAqB,IAAA,kIAAY,EAAC;IAExC,kBAAkB;IAClB,MAAM,kBAAkB,cAAc;IAEtC,8DAA8D;IAC9D,MAAM,eAAe,gBAClB,OAAO,CAAC,gCAAgC,IACxC,IAAI;IAEP,uDAAuD;IACvD,yEAAyE;IACzE,KAAK,MAAM,QAAQ,MAAO;QACxB,gEAAgE;QAChE,IAAI,KAAK,UAAU,KAAK,sBAAsB,CAAC,KAAK,UAAU,EAAE;QAEhE,MAAM,iBAAiB,cAAc,KAAK,IAAI;QAC9C,MAAM,sBAAsB,eACzB,OAAO,CAAC,gCAAgC,IACxC,IAAI;QAEP,4CAA4C;QAC5C,IAAI,wBAAwB,gBACxB,mBAAmB,mBACnB,oBAAoB,QAAQ,CAAC,iBAC7B,aAAa,QAAQ,CAAC,sBAAsB;YAE9C,yBAAyB;YACzB,MAAM,WAAW,UAAU,IAAI,CAAC,CAAA,IAAK,EAAE,EAAE,KAAK,KAAK,UAAU;YAE7D,IAAI,UAAU;gBACZ,YAAY,IAAI,CAAC;oBACf;oBACA;oBACA,aAAa,GAAG,KAAK,IAAI,CAAC,EAAE,EAAE,SAAS,IAAI,EAAE;oBAC7C,YAAY,oBAAoB,UAAU,KAAK,IAAI,EAAE,SAAS,IAAI,EAAE;gBACtE;YACF;QACF;IACF;IAEA,8EAA8E;IAC9E,gDAAgD;IAChD,IAAI,YAAY,MAAM,KAAK,GAAG;QAC5B,MAAM,oBAAoB,yBAAyB;QAEnD,KAAK,MAAM,YAAY,kBAAmB;YACxC,MAAM,qBAAqB,cAAc,SAAS,IAAI;YACtD,MAAM,mBAAmB,mBACtB,OAAO,CAAC,yCAAyC,IACjD,IAAI;YAEP,2CAA2C;YAC3C,IAAI,aAAa,QAAQ,CAAC,qBACtB,iBAAiB,QAAQ,CAAC,iBAC1B,gBAAgB,QAAQ,CAAC,qBAAqB;gBAEhD,sCAAsC;gBACtC,MAAM,gBAAgB,qBAAqB,SAAS,EAAE;gBAEtD,KAAK,MAAM,QAAQ,cAAe;oBAChC,YAAY,IAAI,CAAC;wBACf;wBACA;wBACA,aAAa,GAAG,KAAK,IAAI,CAAC,EAAE,EAAE,SAAS,IAAI,EAAE;wBAC7C,YAAY,oBAAoB,UAAU,KAAK,IAAI,EAAE,SAAS,IAAI,EAAE;oBACtE;gBACF;YACF;QACF;IACF;IAEA,+CAA+C;IAC/C,IAAI,YAAY,MAAM,KAAK,GAAG;QAC5B,KAAK,MAAM,QAAQ,MAAO;YACxB,kCAAkC;YAClC,IAAI,KAAK,UAAU,KAAK,oBAAoB;YAE5C,MAAM,iBAAiB,cAAc,KAAK,IAAI;YAC9C,MAAM,sBAAsB,eACzB,OAAO,CAAC,gCAAgC,IACxC,IAAI;YAEP,4BAA4B;YAC5B,IAAI,oBAAoB,QAAQ,CAAC,iBAC7B,aAAa,QAAQ,CAAC,wBACtB,eAAe,QAAQ,CAAC,oBACxB,gBAAgB,QAAQ,CAAC,iBAAiB;gBAE5C,yBAAyB;gBACzB,MAAM,WAAW,KAAK,UAAU,GAC5B,UAAU,IAAI,CAAC,CAAA,IAAK,EAAE,EAAE,KAAK,KAAK,UAAU,IAC5C;gBAEJ,IAAI,UAAU;oBACZ,YAAY,IAAI,CAAC;wBACf;wBACA;wBACA,aAAa,GAAG,KAAK,IAAI,CAAC,EAAE,EAAE,SAAS,IAAI,EAAE;wBAC7C,YAAY,oBAAoB,UAAU,KAAK,IAAI,EAAE,SAAS,IAAI,EAAE;oBACtE;gBACF;YACF;QACF;IACF;IAEA,mCAAmC;IACnC,OAAO,YAAY,IAAI,CAAC,CAAC,GAAG,IAAM,EAAE,UAAU,GAAG,EAAE,UAAU;AAC/D;AAEA;;;;;;CAMC,GACD,SAAS,cAAc,IAAY;IACjC,OAAO,KACJ,WAAW,GACX,SAAS,CAAC,OACV,OAAO,CAAC,oBAAoB,IAAI,aAAa;KAC7C,OAAO,CAAC,SAAS,KACjB,OAAO,CAAC,gBAAgB,IAAI,uBAAuB;KACnD,IAAI;AACT;AAEA;;CAEC,GACD,SAAS,oBACP,KAAa,EACb,QAAgB,EAChB,YAAoB,EACpB,SAA0D;IAE1D,MAAM,kBAAkB,cAAc;IACtC,MAAM,iBAAiB,cAAc;IACrC,MAAM,qBAAqB,cAAc;IAEzC,qCAAqC;IACrC,MAAM,YAAY,gBAAgB,OAAO,CAAC,gCAAgC,IAAI,IAAI;IAClF,MAAM,WAAW,eAAe,OAAO,CAAC,gCAAgC,IAAI,IAAI;IAEhF,IAAI,QAAQ;IAEZ,IAAI,cAAc,eAAe;QAC/B,uCAAuC;QACvC,QAAQ;QAER,+BAA+B;QAC/B,IAAI,aAAa,WAAW;YAC1B,QAAQ;QACV,OAAO,IAAI,mBAAmB,iBAAiB;YAC7C,QAAQ;QACV;IACF,OAAO,IAAI,cAAc,kBAAkB;QACzC,qCAAqC;QACrC,QAAQ;QAER,8BAA8B;QAC9B,IAAI,eAAe,QAAQ,CAAC,kBAAkB;YAC5C,SAAS;QACX;QAEA,qBAAqB;QACrB,IAAI,mBAAmB,iBAAiB;YACtC,QAAQ;QACV;IACF,OAAO;QACL,qCAAqC;QACrC,QAAQ;QAER,uBAAuB;QACvB,MAAM,cAAc,uBAAuB,iBAAiB;QAC5D,SAAS,KAAK,GAAG,CAAC,IAAI,AAAC,cAAc,gBAAgB,MAAM,GAAI;IACjE;IAEA,OAAO,KAAK,GAAG,CAAC,KAAK;AACvB;AAEA;;CAEC,GACD,SAAS,uBAAuB,IAAY,EAAE,IAAY;IACxD,IAAI,UAAU;IACd,IAAK,IAAI,IAAI,GAAG,IAAI,KAAK,MAAM,EAAE,IAAK;QACpC,IAAK,IAAI,IAAI,GAAG,IAAI,KAAK,MAAM,EAAE,IAAK;YACpC,IAAI,MAAM;YACV,MACE,IAAI,MAAM,KAAK,MAAM,IACrB,IAAI,MAAM,KAAK,MAAM,IACrB,IAAI,CAAC,IAAI,IAAI,KAAK,IAAI,CAAC,IAAI,IAAI,CAC/B;gBACA;YACF;YACA,UAAU,KAAK,GAAG,CAAC,SAAS;QAC9B;IACF;IACA,OAAO;AACT;AAKO,SAAS,iBAAiB,UAA0B;IACzD,MAAM,EAAE,IAAI,EAAE,QAAQ,EAAE,GAAG;IAC3B,MAAM,aAAa,KAAK,KAAK,KAAK,QAAQ,OAAO,KAAK,KAAK,KAAK,QAAQ,OAAO;IAE/E,OAAO,GAAG,KAAK,IAAI,CAAC,EAAE,EAAE,SAAS,IAAI,CAAC,CAAC,EAAE,YAAY;AACvD"}},
    {"offset": {"line": 1357, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/customers/components/address-conversion-dialog.tsx"],"sourcesContent":["/**\r\n * Address Conversion Dialog\r\n * \r\n * Dialog chuyển đổi địa chỉ 2 cấp → 3 cấp\r\n * Hiển thị danh sách gợi ý District+Ward để user chọn\r\n */\r\n\r\nimport { useState, useEffect } from 'react';\r\nimport { Button } from '@/components/ui/button';\r\nimport {\r\n  Dialog,\r\n  DialogContent,\r\n  DialogDescription,\r\n  DialogFooter,\r\n  DialogHeader,\r\n  DialogTitle,\r\n} from '@/components/ui/dialog';\r\nimport { Label } from '@/components/ui/label';\r\nimport { Input } from '@/components/ui/input';\r\nimport { RadioGroup, RadioGroupItem } from '@/components/ui/radio-group';\r\nimport { MapPin, RefreshCw, AlertCircle } from 'lucide-react';\r\nimport { Alert, AlertDescription } from '@/components/ui/alert';\r\nimport { toast } from 'sonner';\r\nimport { findMatchingWards, formatSuggestion, type WardSuggestion } from '../utils/address-conversion-helper';\r\nimport type { EnhancedCustomerAddress } from '../types/enhanced-address';\r\n\r\ntype AddressConversionDialogProps = {\r\n  address: EnhancedCustomerAddress; // Địa chỉ 2 cấp cần convert\r\n  onSuccess: (updatedAddress: EnhancedCustomerAddress) => void;\r\n  open?: boolean;\r\n  onOpenChange?: (open: boolean) => void;\r\n};\r\n\r\nexport function AddressConversionDialog({\r\n  address,\r\n  onSuccess,\r\n  open: controlledOpen,\r\n  onOpenChange: controlledOnOpenChange,\r\n}: AddressConversionDialogProps) {\r\n  const [internalOpen, setInternalOpen] = useState(false);\r\n  const [suggestions, setSuggestions] = useState<WardSuggestion[]>([]);\r\n  const [selectedSuggestion, setSelectedSuggestion] = useState<WardSuggestion | null>(null);\r\n  const [loading, setLoading] = useState(false);\r\n\r\n  // Use controlled or uncontrolled mode\r\n  const open = controlledOpen !== undefined ? controlledOpen : internalOpen;\r\n  const setOpen = controlledOnOpenChange || setInternalOpen;\r\n\r\n  // Load suggestions khi mở dialog\r\n  useEffect(() => {\r\n    if (open) {\r\n      setLoading(true);\r\n      \r\n      // Tìm gợi ý dựa trên province + ward hiện tại\r\n      const results = findMatchingWards(address.provinceId, address.ward);\r\n      \r\n      setSuggestions(results);\r\n      setLoading(false);\r\n      \r\n      // Auto-select first suggestion nếu có\r\n      if (results.length > 0) {\r\n        setSelectedSuggestion(results[0]);\r\n      }\r\n    }\r\n  }, [open, address.provinceId, address.ward]);\r\n\r\n  const handleConvert = () => {\r\n    if (!selectedSuggestion) {\r\n      toast.error('Vui lòng chọn một địa chỉ');\r\n      return;\r\n    }\r\n\r\n    // Tạo địa chỉ 3 cấp mới\r\n    const updatedAddress: EnhancedCustomerAddress = {\r\n      ...address,\r\n      inputLevel: '3-level',\r\n      autoFilled: false, // User chọn\r\n      convertedAt: new Date().toISOString(),\r\n      \r\n      // Update district info\r\n      district: selectedSuggestion.district.name,\r\n      districtId: selectedSuggestion.district.id,\r\n      \r\n      // Update ward info (có thể khác với ward cũ)\r\n      ward: selectedSuggestion.ward.name,\r\n      wardId: selectedSuggestion.ward.id,\r\n      \r\n      updatedAt: new Date().toISOString(),\r\n    };\r\n\r\n    toast.success('Địa chỉ đã được chuyển đổi sang 3 cấp!');\r\n    onSuccess(updatedAddress);\r\n    setOpen(false);\r\n  };\r\n\r\n  return (\r\n    <Dialog open={open} onOpenChange={setOpen}>\r\n      <DialogContent className=\"max-w-2xl max-h-[90vh] overflow-y-auto\">\r\n        <DialogHeader>\r\n          <DialogTitle className=\"flex items-center gap-2\">\r\n            <MapPin className=\"h-5 w-5\" />\r\n            Chuyển đổi địa chỉ\r\n          </DialogTitle>\r\n          <DialogDescription>\r\n            Chọn Quận/Huyện và Phường/Xã chính xác để hoàn thiện địa chỉ 3 cấp\r\n          </DialogDescription>\r\n        </DialogHeader>\r\n\r\n        {/* Địa chỉ hiện tại (2 cấp) */}\r\n        <div className=\"space-y-4\">\r\n          <div>\r\n            <Label className=\"text-sm font-semibold\">Địa chỉ hiện tại (2 cấp)</Label>\r\n            <div className=\"mt-2 p-3 bg-orange-50 border border-orange-200 rounded-lg space-y-1\">\r\n              <div className=\"text-sm\">\r\n                <strong>Tỉnh/Thành phố:</strong> {address.province}\r\n              </div>\r\n              <div className=\"text-sm\">\r\n                <strong>Phường/Xã:</strong> {address.ward}\r\n              </div>\r\n              <div className=\"text-sm\">\r\n                <strong>Địa chỉ chi tiết:</strong> {address.street}\r\n              </div>\r\n              <div className=\"text-xs text-orange-700 mt-2\">\r\n                ⚠️ Thiếu Quận/Huyện - Cần bổ sung để gửi API vận chuyển\r\n              </div>\r\n            </div>\r\n          </div>\r\n\r\n          {/* Danh sách gợi ý */}\r\n          <div>\r\n            <Label className=\"text-sm font-semibold flex items-center gap-2\">\r\n              <AlertCircle className=\"h-4 w-4\" />\r\n              Địa chỉ bạn nhập tương ứng với địa chỉ nào sau đây?\r\n            </Label>\r\n            \r\n            {loading ? (\r\n              <div className=\"mt-2 p-4 text-center text-muted-foreground\">\r\n                Đang tìm kiếm...\r\n              </div>\r\n            ) : suggestions.length === 0 ? (\r\n              <Alert className=\"mt-2 border-yellow-200 bg-yellow-50\">\r\n                <AlertCircle className=\"h-4 w-4 text-yellow-600\" />\r\n                <AlertDescription className=\"text-yellow-700\">\r\n                  Không tìm thấy gợi ý phù hợp. Vui lòng kiểm tra lại tên Phường/Xã.\r\n                </AlertDescription>\r\n              </Alert>\r\n            ) : (\r\n              <RadioGroup\r\n                value={selectedSuggestion?.ward.id ?? \"\"}\r\n                onValueChange={(value) => {\r\n                  const suggestion = suggestions.find(s => s.ward.id === value);\r\n                  setSelectedSuggestion(suggestion || null);\r\n                }}\r\n                className=\"mt-2 space-y-2 max-h-[400px] overflow-y-auto\"\r\n              >\r\n                {suggestions.map((suggestion, index) => (\r\n                  <div\r\n                    key={`${suggestion.ward.id}-${index}`}\r\n                    className=\"flex items-start space-x-2 border rounded-lg p-3 hover:bg-accent cursor-pointer\"\r\n                  >\r\n                    <RadioGroupItem\r\n                      value={suggestion.ward.id}\r\n                      id={`suggestion-${suggestion.ward.id}-${index}`}\r\n                      className=\"mt-1\"\r\n                    />\r\n                    <Label\r\n                      htmlFor={`suggestion-${suggestion.ward.id}-${index}`}\r\n                      className=\"cursor-pointer flex-1\"\r\n                    >\r\n                      <div className=\"text-sm\">\r\n                        {address.street}, {formatSuggestion(suggestion)}, {address.province}\r\n                      </div>\r\n                      <div className=\"text-xs text-muted-foreground mt-1\">\r\n                        Match: {suggestion.matchScore}%\r\n                      </div>\r\n                    </Label>\r\n                  </div>\r\n                ))}\r\n              </RadioGroup>\r\n            )}\r\n          </div>\r\n        </div>\r\n\r\n        <DialogFooter>\r\n          <Button variant=\"outline\" onClick={() => setOpen(false)}>\r\n            Hủy\r\n          </Button>\r\n          <Button\r\n            onClick={handleConvert}\r\n            disabled={!selectedSuggestion || suggestions.length === 0}\r\n          >\r\n            Áp dụng\r\n          </Button>\r\n        </DialogFooter>\r\n      </DialogContent>\r\n    </Dialog>\r\n  );\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1733, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/customers/components/address-bidirectional-converter.tsx"],"sourcesContent":["/**\r\n * Address Bidirectional Converter\r\n * \r\n * Chuyển đổi 2 chiều:\r\n * - 2 cấp → 3 cấp: Tạo địa chỉ mới với district (dùng AddressConversionDialog)\r\n * - 3 cấp → 2 cấp: Tạo địa chỉ mới bỏ district\r\n */\r\n\r\nimport { useState, useEffect } from 'react';\r\nimport { Button } from '@/components/ui/button';\r\nimport {\r\n  Dialog,\r\n  DialogContent,\r\n  DialogDescription,\r\n  DialogFooter,\r\n  DialogHeader,\r\n  DialogTitle,\r\n} from '@/components/ui/dialog';\r\nimport { Alert, AlertDescription } from '@/components/ui/alert';\r\nimport { RefreshCw, AlertCircle, ArrowRight, Info } from 'lucide-react';\r\nimport { toast } from 'sonner';\r\nimport { AddressConversionDialog } from './address-conversion-dialog';\r\nimport { findAllNewWards, findAllOldWards } from '@/features/settings/provinces/ward-old-to-new-mapping';\r\nimport { useProvinceStore } from '@/features/settings/provinces/store';\r\nimport { asBusinessId } from '@/lib/id-types';\r\nimport type { EnhancedCustomerAddress } from '../types/enhanced-address';\r\n\r\ntype AddressBidirectionalConverterProps = {\r\n  address: EnhancedCustomerAddress;\r\n  onSuccess: (newAddress: EnhancedCustomerAddress) => void;\r\n  open?: boolean;\r\n  onOpenChange?: (open: boolean) => void;\r\n};\r\n\r\nexport function AddressBidirectionalConverter({\r\n  address,\r\n  onSuccess,\r\n  open: controlledOpen,\r\n  onOpenChange: controlledOnOpenChange,\r\n}: AddressBidirectionalConverterProps) {\r\n  const [internalOpen, setInternalOpen] = useState(false);\r\n  const [selectedWardMapping, setSelectedWardMapping] = useState<any>(null);\r\n  const { getWards2LevelByProvinceId } = useProvinceStore();\r\n\r\n  // Use controlled or uncontrolled mode\r\n  const isOpen = controlledOpen !== undefined ? controlledOpen : internalOpen;\r\n  const setIsOpen = controlledOnOpenChange || setInternalOpen;\r\n\r\n  // Auto-select nếu chỉ có 1 kết quả\r\n  useEffect(() => {\r\n    if (isOpen && address.inputLevel === '3-level') {\r\n      console.log('🔍 Finding NEW wards (2-level) for OLD ward:', {\r\n        oldWardName: address.ward,\r\n        provinceName: address.province\r\n      });\r\n      \r\n      // 3-level (cũ) → 2-level (mới): Tìm NEW ward từ OLD ward\r\n      const allNewWardMappings = findAllNewWards(address.ward, address.province);\r\n      \r\n      console.log('✅ Found NEW ward mappings:', allNewWardMappings);\r\n      \r\n      if (allNewWardMappings.length === 1) {\r\n        setSelectedWardMapping(allNewWardMappings[0]);\r\n        console.log('✓ Auto-selected:', allNewWardMappings[0]);\r\n      } else if (allNewWardMappings.length === 0) {\r\n        setSelectedWardMapping(null);\r\n        console.log('❌ No mapping found - ward không có trong FILE3 hoặc không được sáp nhập');\r\n      } else {\r\n        setSelectedWardMapping(null);\r\n        console.log('⚠️ Multiple results, user must select');\r\n      }\r\n    }\r\n  }, [isOpen, address.ward, address.inputLevel, address.province]);\r\n\r\n  // Case 1: Địa chỉ 2 cấp → 3 cấp (cần chọn district)\r\n  if (address.inputLevel === '2-level') {\r\n    return (\r\n      <AddressConversionDialog\r\n        address={address}\r\n        onSuccess={onSuccess}\r\n        open={isOpen}\r\n        onOpenChange={setIsOpen}\r\n      />\r\n    );\r\n  }\r\n\r\n  // Case 2: Địa chỉ 3 cấp (cũ) → 2 cấp (mới) - tìm ward 2 cấp tương ứng\r\n  const handleConvert3To2 = () => {\r\n    if (!selectedWardMapping) {\r\n      toast.error('Vui lòng chọn Phường/Xã 2 cấp');\r\n      return;\r\n    }\r\n    \r\n    // newWardName là ward 2 cấp (sau sáp nhập - không có district)\r\n    const newWard = selectedWardMapping.newWardName;\r\n    \r\n    // Tìm wardId từ store (ward 2 cấp không có districtId)\r\n    const wards2Level = getWards2LevelByProvinceId(asBusinessId(address.provinceId));\r\n    console.log('🔍 Looking for 2-level ward:', {\r\n      wardName: newWard,\r\n      provinceId: address.provinceId,\r\n      available2LevelWards: wards2Level.length,\r\n      sample: wards2Level.slice(0, 3),\r\n    });\r\n    \r\n    const foundWard = wards2Level.find(w => w.name === newWard);\r\n    \r\n    if (!foundWard) {\r\n      console.error('❌ Ward not found:', {\r\n        wardName: newWard,\r\n        available2LevelWards: wards2Level.map(w => w.name),\r\n      });\r\n      toast.error('Không tìm thấy ward trong database', {\r\n        description: 'Vui lòng thử lại hoặc chọn ward khác',\r\n      });\r\n      return;\r\n    }\r\n    \r\n    console.log('✅ Found ward:', foundWard);\r\n    \r\n    if (!foundWard) {\r\n      toast.error('Không tìm thấy ward trong database', {\r\n        description: 'Vui lòng thử lại hoặc chọn ward khác',\r\n      });\r\n      return;\r\n    }\r\n    \r\n    // Tạo địa chỉ mới 2 cấp với ward đã chọn\r\n    const newAddress: EnhancedCustomerAddress = {\r\n      ...address,\r\n      id: crypto.randomUUID(),\r\n      label: `${address.label} (2 cấp)`,\r\n      inputLevel: '2-level',\r\n      district: '',\r\n      districtId: 0,\r\n      ward: newWard,\r\n      wardId: foundWard.id,\r\n      autoFilled: false,\r\n      convertedAt: new Date().toISOString(),\r\n      createdAt: new Date().toISOString(),\r\n      updatedAt: new Date().toISOString(),\r\n    };\r\n\r\n    toast.success('Đã tạo địa chỉ 2 cấp mới!', {\r\n      description: `Ward 2 cấp: ${newWard}`,\r\n    });\r\n    \r\n    onSuccess(newAddress);\r\n    setIsOpen(false);\r\n  };\r\n\r\n  return (\r\n    <Dialog open={isOpen} onOpenChange={setIsOpen}>\r\n      <DialogContent className=\"max-w-full sm:max-w-2xl lg:max-w-4xl max-h-[90vh] overflow-y-auto\">\r\n        <DialogHeader>\r\n          <DialogTitle className=\"text-base sm:text-lg\">Chuyển đổi sang địa chỉ 2 cấp</DialogTitle>\r\n          <DialogDescription className=\"text-sm\">\r\n            Tạo địa chỉ mới 2 cấp (bỏ Quận/Huyện) - Hệ thống tự động tìm Phường/Xã tương ứng\r\n          </DialogDescription>\r\n        </DialogHeader>\r\n\r\n        <div className=\"space-y-4 sm:space-y-6\">\r\n          {/* Comparison: 3 cấp vs 2 cấp */}\r\n          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-3 sm:gap-4\">\r\n            {/* Current Address (3 cấp) */}\r\n            <div className=\"space-y-2\">\r\n              <div className=\"font-medium text-sm flex items-center gap-2\">\r\n                <span className=\"bg-muted text-muted-foreground px-2 py-1 rounded text-xs\">Hiện tại</span>\r\n                <span className=\"text-xs sm:text-sm\">Địa chỉ 3 cấp</span>\r\n              </div>\r\n              <div className=\"bg-muted p-3 sm:p-4 rounded-lg text-sm space-y-1.5\">\r\n                <div className=\"font-medium\">{address.label}</div>\r\n                <div className=\"text-muted-foreground text-xs sm:text-sm\">{address.street}</div>\r\n                <div className=\"text-xs sm:text-sm\">{address.ward}</div>\r\n                <div className=\"text-xs sm:text-sm\">{address.district}</div>\r\n                <div className=\"font-medium text-xs sm:text-sm\">{address.province}</div>\r\n              </div>\r\n            </div>\r\n\r\n            {/* Preview Address (2 cấp) */}\r\n            {(() => {\r\n              const allNewWardMappings = findAllNewWards(address.ward, address.province);\r\n              const hasMapping = allNewWardMappings.length > 0;\r\n              \r\n              return (\r\n                <div className=\"space-y-2\">\r\n                  <div className=\"font-medium text-sm flex items-center gap-2\">\r\n                    <span className=\"bg-green-100 text-green-700 px-2 py-1 rounded text-xs\">Mới</span>\r\n                    <span className=\"text-xs sm:text-sm\">Địa chỉ 2 cấp</span>\r\n                  </div>\r\n                  <div className={`p-3 sm:p-4 rounded-lg text-sm space-y-1.5 ${hasMapping ? 'bg-green-50 border border-green-200' : 'bg-orange-50 border border-orange-200'}`}>\r\n                    <div className=\"font-medium\">{address.label} (2 cấp)</div>\r\n                    <div className=\"text-muted-foreground text-xs sm:text-sm\">{address.street}</div>\r\n                    {hasMapping ? (\r\n                      <>\r\n                        <div className=\"text-green-700 font-medium text-xs sm:text-sm\">\r\n                          ✓ Tìm thấy {allNewWardMappings.length} phường/xã\r\n                        </div>\r\n                        <div className=\"max-h-20 overflow-y-auto space-y-0.5\">\r\n                          {allNewWardMappings.map((m, i) => (\r\n                            <div key={i} className=\"text-xs sm:text-sm text-green-600\">• {m.newWardName}</div>\r\n                          ))}\r\n                        </div>\r\n                      </>\r\n                    ) : (\r\n                      <div className=\"text-orange-600 text-xs sm:text-sm\">⚠️ Không tìm thấy</div>\r\n                    )}\r\n                    <div className=\"text-muted-foreground italic text-xs\">(Bỏ Quận/Huyện)</div>\r\n                    <div className=\"font-medium text-xs sm:text-sm\">{address.province}</div>\r\n                  </div>\r\n                </div>\r\n              );\r\n            })()}\r\n          </div>\r\n\r\n          {/* Ward Selection */}\r\n          {(() => {\r\n            const allNewWardMappings = findAllNewWards(address.ward, address.province);\r\n            \r\n            if (allNewWardMappings.length > 0) {\r\n              return (\r\n                <div className=\"space-y-3\">\r\n                  <div className=\"text-sm font-medium bg-blue-50 border border-blue-200 p-2.5 sm:p-3 rounded-lg flex items-center gap-2\">\r\n                    <Info className=\"h-4 w-4 text-blue-600 flex-shrink-0\" />\r\n                    <span className=\"text-xs sm:text-sm\">Chọn Phường/Xã 2 cấp phù hợp ({allNewWardMappings.length} kết quả) *</span>\r\n                  </div>\r\n                  <div className=\"grid grid-cols-1 gap-2 max-h-[300px] sm:max-h-[400px] overflow-y-auto border rounded-lg p-2 sm:p-3\">\r\n                    {allNewWardMappings.map((mapping, idx) => (\r\n                      <label\r\n                        key={idx}\r\n                        className={`flex items-start gap-2 sm:gap-3 p-2.5 sm:p-3 border rounded-lg cursor-pointer transition-all ${\r\n                          selectedWardMapping?.newWardName === mapping.newWardName && selectedWardMapping?.oldWardName === mapping.oldWardName\r\n                            ? 'bg-blue-50 border-blue-400 shadow-sm'\r\n                            : 'hover:bg-muted/50 border-border'\r\n                        }`}\r\n                      >\r\n                        <input\r\n                          type=\"radio\"\r\n                          name=\"ward-selection\"\r\n                          checked={selectedWardMapping?.newWardName === mapping.newWardName && selectedWardMapping?.oldWardName === mapping.oldWardName}\r\n                          onChange={() => setSelectedWardMapping(mapping)}\r\n                          className=\"mt-0.5 sm:mt-1 h-4 w-4 flex-shrink-0\"\r\n                        />\r\n                        <div className=\"flex-1 min-w-0\">\r\n                          <div className=\"flex items-start justify-between gap-2 mb-1\">\r\n                            <div className=\"font-semibold text-green-700 flex-1 text-xs sm:text-sm\">\r\n                              {mapping.newWardName}\r\n                            </div>\r\n                            <div className=\"text-xs bg-green-100 text-green-700 px-1.5 sm:px-2 py-0.5 rounded whitespace-nowrap flex-shrink-0\">\r\n                              {mapping.provinceName}\r\n                            </div>\r\n                          </div>\r\n                          <div className=\"text-xs text-muted-foreground\">\r\n                            <span className=\"font-medium\">Địa chỉ đầy đủ:</span> {address.street}, {mapping.newWardName}, {mapping.provinceName}\r\n                          </div>\r\n                          <div className=\"text-xs text-muted-foreground mt-1 pt-1 border-t\">\r\n                            <span className=\"font-medium\">Nguồn gốc từ ward 3 cấp:</span> {mapping.oldWardName}\r\n                          </div>\r\n                        </div>\r\n                      </label>\r\n                    ))}\r\n                  </div>\r\n                </div>\r\n              );\r\n            }\r\n            \r\n            return (\r\n              <Alert variant=\"destructive\">\r\n                <AlertCircle className=\"h-4 w-4\" />\r\n                <AlertDescription className=\"text-xs sm:text-sm\">\r\n                  <strong>Không tìm thấy Phường/Xã 2 cấp tương ứng.</strong><br/>\r\n                  Sau khi tạo, vui lòng chọn lại Phường/Xã 2 cấp thủ công.\r\n                </AlertDescription>\r\n              </Alert>\r\n            );\r\n          })()}\r\n        </div>\r\n\r\n        <DialogFooter className=\"flex-col sm:flex-row gap-2 sm:gap-2\">\r\n          <Button variant=\"outline\" onClick={() => setIsOpen(false)} className=\"w-full sm:w-auto order-2 sm:order-1\">\r\n            Hủy\r\n          </Button>\r\n          <Button \r\n            onClick={handleConvert3To2}\r\n            disabled={!selectedWardMapping}\r\n            className=\"w-full sm:w-auto sm:min-w-[180px] order-1 sm:order-2\"\r\n          >\r\n            <RefreshCw className=\"h-4 w-4 mr-2\" />\r\n            Tạo địa chỉ mới\r\n          </Button>\r\n        </DialogFooter>\r\n      </DialogContent>\r\n    </Dialog>\r\n  );\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 2360, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/customers/components/address-form-dialog.tsx"],"sourcesContent":["/**\r\n * AddressFormDialog\r\n * Shared dialog component for adding/editing customer addresses\r\n * Used in: CustomerAddresses, CustomerAddressSelector, OrderFormPage\r\n */\r\n\r\nimport * as React from 'react';\r\nimport { Button } from '../../../components/ui/button';\r\nimport { Input } from '../../../components/ui/input';\r\nimport { Label } from '../../../components/ui/label';\r\nimport { RadioGroup, RadioGroupItem } from '../../../components/ui/radio-group';\r\nimport { Switch } from '../../../components/ui/switch';\r\nimport {\r\n  Dialog,\r\n  DialogContent,\r\n  DialogDescription,\r\n  DialogFooter,\r\n  DialogHeader,\r\n  DialogTitle,\r\n} from '../../../components/ui/dialog';\r\nimport { VirtualizedCombobox } from '../../../components/ui/virtualized-combobox';\r\nimport { toast } from 'sonner';\r\nimport { useProvinceStore } from '../../settings/provinces/store';\r\nimport { autoFillDistrict } from '../../settings/provinces/ward-district-mapping';\r\nimport type { CustomerAddress } from '../types';\r\n\r\ninterface AddressFormDialogProps {\r\n  isOpen: boolean;\r\n  onOpenChange: (open: boolean) => void;\r\n  onSave: (address: Omit<CustomerAddress, 'id'>) => void;\r\n  editingAddress?: CustomerAddress | null;\r\n  hideDefaultSwitches?: boolean; // ✅ Option to hide default shipping/billing switches\r\n  title?: string; // ✅ Custom title\r\n  description?: string; // ✅ Custom description\r\n}\r\n\r\nexport function AddressFormDialog({\r\n  isOpen,\r\n  onOpenChange,\r\n  onSave,\r\n  editingAddress,\r\n  hideDefaultSwitches = false, // ✅ Default to false (show switches)\r\n  title,\r\n  description,\r\n}: AddressFormDialogProps) {\r\n  const {\r\n    data: provinces,\r\n    getDistrictsByProvinceId,\r\n    getWards2LevelByProvinceId,\r\n    getWards3LevelByDistrictId,\r\n  } = useProvinceStore();\r\n\r\n  const [addressLevel, setAddressLevel] = React.useState<'2-level' | '3-level'>('2-level');\r\n  const [formData, setFormData] = React.useState({\r\n    label: '',\r\n    street: '',\r\n    province: '',\r\n    provinceId: '',\r\n    district: '',\r\n    districtId: 0,\r\n    ward: '',\r\n    wardId: '',\r\n    wardCode: '',\r\n    contactName: '',\r\n    contactPhone: '',\r\n    notes: '',\r\n    isDefaultShipping: false,\r\n    isDefaultBilling: false,\r\n    inputLevel: '2-level' as '2-level' | '3-level',\r\n  });\r\n\r\n  // Reset form when dialog opens/closes or editingAddress changes\r\n  React.useEffect(() => {\r\n    if (isOpen) {\r\n      console.log('[AddressFormDialog] Opening with editingAddress:', editingAddress);\r\n      if (editingAddress) {\r\n        const level = editingAddress.inputLevel || '2-level';\r\n        setAddressLevel(level);\r\n        const newFormData = {\r\n          label: editingAddress.label || '',\r\n          street: editingAddress.street || '',\r\n          province: editingAddress.province || '',\r\n          provinceId: editingAddress.provinceId || '',\r\n          district: editingAddress.district || '',\r\n          districtId: editingAddress.districtId || 0,\r\n          ward: editingAddress.ward || '',\r\n          wardId: editingAddress.wardId || '',\r\n          wardCode: '', // wardCode not in EnhancedCustomerAddress type\r\n          contactName: editingAddress.contactName || '',\r\n          contactPhone: editingAddress.contactPhone || '',\r\n          notes: editingAddress.notes || '',\r\n          isDefaultShipping: editingAddress.isDefaultShipping || false,\r\n          isDefaultBilling: editingAddress.isDefaultBilling || false,\r\n          inputLevel: level,\r\n        };\r\n        console.log('[AddressFormDialog] Setting formData:', newFormData);\r\n        setFormData(newFormData);\r\n      } else {\r\n        setAddressLevel('2-level');\r\n        setFormData({\r\n          label: '',\r\n          street: '',\r\n          province: '',\r\n          provinceId: '',\r\n          district: '',\r\n          districtId: 0,\r\n          ward: '',\r\n          wardId: '',\r\n          wardCode: '',\r\n          contactName: '',\r\n          contactPhone: '',\r\n          notes: '',\r\n          isDefaultShipping: false,\r\n          isDefaultBilling: false,\r\n          inputLevel: '2-level',\r\n        });\r\n      }\r\n    }\r\n  }, [isOpen, editingAddress]);\r\n\r\n  // Get available districts and wards based on selection\r\n  // IMPORTANT: Lookup province by BOTH name and provinceId for compatibility\r\n  const selectedProvince = React.useMemo(() => {\r\n    console.log('[AddressFormDialog] Looking for province:', { \r\n      provinceName: formData.province, \r\n      provinceId: formData.provinceId,\r\n      availableProvinces: provinces.slice(0, 5).map(p => ({ id: p.id, name: p.name }))\r\n    });\r\n    \r\n    // First try by name\r\n    let found = provinces.find((p) => p.name === formData.province);\r\n    if (found) {\r\n      console.log('[AddressFormDialog] Found province by name:', found);\r\n      return found;\r\n    }\r\n    \r\n    // Then try by provinceId\r\n    if (formData.provinceId) {\r\n      found = provinces.find((p) => p.id === formData.provinceId);\r\n      if (found) {\r\n        console.log('[AddressFormDialog] Found province by id:', found);\r\n        return found;\r\n      }\r\n    }\r\n    \r\n    // Try normalized name match\r\n    const normalizedInput = formData.province?.toLowerCase().normalize('NFD').replace(/[\\u0300-\\u036f]/g, '').replace(/đ/g, 'd');\r\n    if (normalizedInput) {\r\n      found = provinces.find((p) => {\r\n        const normalizedName = p.name.toLowerCase().normalize('NFD').replace(/[\\u0300-\\u036f]/g, '').replace(/đ/g, 'd');\r\n        return normalizedName === normalizedInput || \r\n               normalizedName.includes(normalizedInput) || \r\n               normalizedInput.includes(normalizedName);\r\n      });\r\n      if (found) {\r\n        console.log('[AddressFormDialog] Found province by normalized match:', found);\r\n        return found;\r\n      }\r\n    }\r\n    \r\n    console.log('[AddressFormDialog] Province NOT FOUND');\r\n    return null;\r\n  }, [provinces, formData.province, formData.provinceId]);\r\n\r\n  const availableDistricts = React.useMemo(() => {\r\n    if (!selectedProvince) return [];\r\n    const districtsFromProvince = getDistrictsByProvinceId(selectedProvince.id);\r\n    \r\n    // If we have a districtId but it's not in the available list,\r\n    // the district might belong to a different province mapping (e.g. 3-level data)\r\n    // In this case, add it manually to the options\r\n    if (formData.districtId && formData.district) {\r\n      const hasDistrict = districtsFromProvince.some(d => d.id === formData.districtId);\r\n      if (!hasDistrict) {\r\n        // Get district by ID directly\r\n        const store = useProvinceStore.getState();\r\n        const districtById = store.getDistrictById(formData.districtId);\r\n        if (districtById) {\r\n          return [districtById, ...districtsFromProvince];\r\n        }\r\n        // If still not found, create a virtual entry for display\r\n        return [{\r\n          systemId: `D${formData.districtId}` as any,\r\n          id: formData.districtId,\r\n          name: formData.district,\r\n          provinceId: selectedProvince.id as any,\r\n        }, ...districtsFromProvince];\r\n      }\r\n    }\r\n    \r\n    return districtsFromProvince;\r\n  }, [selectedProvince, getDistrictsByProvinceId, formData.districtId, formData.district]);\r\n\r\n  // For 3-level: If we have districtId but it's not in availableDistricts,\r\n  // it might be from wards-3level-data with different provinceId mapping\r\n  // In this case, try to get district directly by ID\r\n  const selectedDistrict = React.useMemo(() => {\r\n    if (!formData.districtId || formData.districtId === 0) return null;\r\n    \r\n    // First try from available districts\r\n    const fromAvailable = availableDistricts.find(d => d.id === formData.districtId);\r\n    if (fromAvailable) return fromAvailable;\r\n    \r\n    // Try direct lookup by ID (for cross-province cases)\r\n    const store = useProvinceStore.getState();\r\n    return store.getDistrictById(formData.districtId) || null;\r\n  }, [formData.districtId, availableDistricts]);\r\n\r\n  const availableWards = React.useMemo(() => {\r\n    if (addressLevel === '2-level') {\r\n      if (!selectedProvince) return [];\r\n      return getWards2LevelByProvinceId(selectedProvince.id);\r\n    }\r\n    \r\n    // For 3-level, use districtId directly (not requiring selectedProvince)\r\n    if (!formData.districtId) return [];\r\n    return getWards3LevelByDistrictId(formData.districtId);\r\n  }, [selectedProvince, formData.districtId, addressLevel, getWards2LevelByProvinceId, getWards3LevelByDistrictId]);\r\n\r\n  // Prepare options for comboboxes\r\n  const provinceOptions = React.useMemo(\r\n    () =>\r\n      provinces.map((p) => ({\r\n        label: p.name,\r\n        value: p.name,\r\n      })),\r\n    [provinces]\r\n  );\r\n\r\n  const districtOptions = React.useMemo(() => {\r\n    const options = availableDistricts.map((d) => ({\r\n      label: d.name,\r\n      value: d.name,\r\n    }));\r\n    \r\n    // If we have a selected district that's not in available list, add it\r\n    if (selectedDistrict && !availableDistricts.find(d => d.id === selectedDistrict.id)) {\r\n      options.unshift({\r\n        label: selectedDistrict.name,\r\n        value: selectedDistrict.name,\r\n      });\r\n    }\r\n    \r\n    // If formData has district name but not in options, add it for display\r\n    if (formData.district && !options.some(o => o.value === formData.district)) {\r\n      options.unshift({\r\n        label: formData.district,\r\n        value: formData.district,\r\n      });\r\n    }\r\n    \r\n    return options;\r\n  }, [availableDistricts, selectedDistrict, formData.district]);\r\n\r\n  // Selected ward for display\r\n  const selectedWard = React.useMemo(() => {\r\n    if (!formData.wardId) return null;\r\n    \r\n    // First try from available wards\r\n    const fromAvailable = availableWards.find(w => w.id === formData.wardId);\r\n    if (fromAvailable) return fromAvailable;\r\n    \r\n    // Try direct lookup by ID\r\n    const store = useProvinceStore.getState();\r\n    return store.getWardById(formData.wardId) || null;\r\n  }, [formData.wardId, availableWards]);\r\n\r\n  const wardOptions = React.useMemo(() => {\r\n    const options = availableWards.map((w) => ({\r\n      label: w.name,\r\n      value: w.name,\r\n    }));\r\n    \r\n    // If we have a selected ward that's not in available list, add it\r\n    if (selectedWard && !availableWards.find(w => w.id === selectedWard.id)) {\r\n      options.unshift({\r\n        label: selectedWard.name,\r\n        value: selectedWard.name,\r\n      });\r\n    }\r\n    \r\n    return options;\r\n  }, [availableWards, selectedWard]);\r\n\r\n  const showValidationError = (message: string) => {\r\n    toast.error('Thiếu thông tin', { description: message });\r\n  };\r\n\r\n  const handleSave = () => {\r\n    const label = formData.label.trim();\r\n    const street = formData.street.trim();\r\n\r\n    if (!label) {\r\n      showValidationError('Vui lòng nhập tên địa chỉ.');\r\n      return;\r\n    }\r\n\r\n    if (!street) {\r\n      showValidationError('Vui lòng nhập địa chỉ chi tiết.');\r\n      return;\r\n    }\r\n\r\n    if (!formData.province || !formData.provinceId) {\r\n      showValidationError('Vui lòng chọn tỉnh/thành phố.');\r\n      return;\r\n    }\r\n\r\n    if (addressLevel === '3-level') {\r\n      if (!formData.district || !formData.districtId) {\r\n        showValidationError('Vui lòng chọn quận/huyện trước khi lưu địa chỉ 3 cấp.');\r\n        return;\r\n      }\r\n      if (!formData.ward || !formData.wardId) {\r\n        showValidationError('Vui lòng chọn phường/xã cho địa chỉ 3 cấp.');\r\n        return;\r\n      }\r\n    } else {\r\n      if (!formData.ward || !formData.wardId) {\r\n        showValidationError('Vui lòng chọn phường/xã cho địa chỉ 2 cấp.');\r\n        return;\r\n      }\r\n    }\r\n\r\n    let districtName = formData.district;\r\n    let districtId = formData.districtId;\r\n    let autoFilled = false;\r\n\r\n    if (addressLevel === '2-level') {\r\n      try {\r\n        const mapping = autoFillDistrict({\r\n          provinceId: formData.provinceId,\r\n          provinceName: formData.province,\r\n          wardId: formData.wardId,\r\n          wardName: formData.ward,\r\n        });\r\n        districtName = mapping.districtName;\r\n        districtId = mapping.districtId;\r\n        autoFilled = true;\r\n      } catch (error) {\r\n        showValidationError('Không tìm thấy quận/huyện tương ứng với phường/xã đã chọn.');\r\n        return;\r\n      }\r\n    }\r\n\r\n    const addressData: Omit<CustomerAddress, 'id'> = {\r\n      label,\r\n      street,\r\n      province: formData.province,\r\n      provinceId: formData.provinceId,\r\n      district: districtName,\r\n      districtId,\r\n      ward: formData.ward,\r\n      wardId: formData.wardId,\r\n      contactName: formData.contactName,\r\n      contactPhone: formData.contactPhone,\r\n      notes: formData.notes,\r\n      isDefaultShipping: formData.isDefaultShipping,\r\n      isDefaultBilling: formData.isDefaultBilling,\r\n      inputLevel: formData.inputLevel,\r\n      autoFilled,\r\n    };\r\n\r\n    onSave(addressData);\r\n    onOpenChange(false);\r\n  };\r\n\r\n  return (\r\n    <Dialog open={isOpen} onOpenChange={onOpenChange}>\r\n      <DialogContent className=\"max-w-2xl max-h-[90vh] overflow-y-auto\">\r\n        <DialogHeader>\r\n          <DialogTitle className=\"text-base sm:text-lg\">\r\n            {title || (editingAddress ? 'Chỉnh sửa địa chỉ' : 'Thêm địa chỉ mới')}\r\n          </DialogTitle>\r\n          <DialogDescription className=\"text-sm\">\r\n            {description || 'Nhập thông tin địa chỉ của khách hàng'}\r\n          </DialogDescription>\r\n        </DialogHeader>\r\n\r\n        <div className=\"grid gap-3 py-3\">\r\n          {/* Address Level Selection - Compact */}\r\n          <div className=\"grid gap-2\">\r\n            <Label className=\"text-sm font-medium\">Loại địa chỉ *</Label>\r\n            <RadioGroup\r\n              value={addressLevel}\r\n              onValueChange={(value: '2-level' | '3-level') => {\r\n                setAddressLevel(value);\r\n                setFormData((prev) => ({\r\n                  ...prev,\r\n                  inputLevel: value,\r\n                  ward: '',\r\n                  wardId: '',\r\n                  district: value === '2-level' ? '' : prev.district,\r\n                  districtId: value === '2-level' ? 0 : prev.districtId,\r\n                }));\r\n              }}\r\n              className=\"flex gap-2\"\r\n            >\r\n              <div className=\"flex items-center space-x-2 border rounded-md px-3 py-2 flex-1 cursor-pointer hover:bg-accent transition-colors\">\r\n                <RadioGroupItem value=\"2-level\" id=\"level-2\" />\r\n                <Label htmlFor=\"level-2\" className=\"cursor-pointer text-sm flex-1\">\r\n                  <span className=\"font-medium\">2 cấp</span>\r\n                  <span className=\"text-xs text-muted-foreground block\">Tỉnh → Phường/Xã</span>\r\n                </Label>\r\n              </div>\r\n              <div className=\"flex items-center space-x-2 border rounded-md px-3 py-2 flex-1 cursor-pointer hover:bg-accent transition-colors\">\r\n                <RadioGroupItem value=\"3-level\" id=\"level-3\" />\r\n                <Label htmlFor=\"level-3\" className=\"cursor-pointer text-sm flex-1\">\r\n                  <span className=\"font-medium\">3 cấp</span>\r\n                  <span className=\"text-xs text-muted-foreground block\">Tỉnh → Quận → Phường</span>\r\n                </Label>\r\n              </div>\r\n            </RadioGroup>\r\n          </div>\r\n\r\n          {/* Tên địa chỉ và Địa chỉ cùng 1 hàng */}\r\n          <div className=\"grid grid-cols-2 gap-2\">\r\n            <div className=\"grid gap-2\">\r\n              <Label htmlFor=\"label\" className=\"text-sm\">\r\n                Tên địa chỉ *\r\n              </Label>\r\n              <Input\r\n                className=\"h-9\"\r\n                id=\"label\"\r\n                placeholder=\"VD: Văn phòng chính, Nhà máy...\"\r\n                value={formData.label}\r\n                onChange={(e) => setFormData({ ...formData, label: e.target.value })}\r\n              />\r\n            </div>\r\n\r\n            <div className=\"grid gap-2\">\r\n              <Label htmlFor=\"street\" className=\"text-sm\">\r\n                Địa chỉ *\r\n              </Label>\r\n              <Input\r\n                className=\"h-9\"\r\n                id=\"street\"\r\n                placeholder=\"Số nhà, tên đường...\"\r\n                value={formData.street}\r\n                onChange={(e) => setFormData({ ...formData, street: e.target.value })}\r\n              />\r\n            </div>\r\n          </div>\r\n\r\n          {/* Compact address fields - 1 row for 3 fields */}\r\n          <div className=\"grid gap-2\">\r\n            <div className={addressLevel === '3-level' ? 'grid grid-cols-3 gap-2' : 'grid grid-cols-2 gap-2'}>\r\n              <div className=\"grid gap-1.5\">\r\n                <Label htmlFor=\"province\" className=\"text-xs\">\r\n                  Tỉnh/TP *\r\n                </Label>\r\n                <VirtualizedCombobox\r\n                  options={provinceOptions}\r\n                  value={provinceOptions.find((opt) => opt.value === formData.province) || null}\r\n                  onChange={(option) => {\r\n                    const selectedProv = provinces.find((p) => p.name === option?.value);\r\n                    setFormData((prev) => ({\r\n                      ...prev,\r\n                      province: option ? option.value : '',\r\n                      provinceId: selectedProv?.id || '',\r\n                      district: '',\r\n                      districtId: 0,\r\n                      ward: '',\r\n                      wardId: '',\r\n                    }));\r\n                  }}\r\n                  placeholder=\"Chọn tỉnh/TP\"\r\n                  searchPlaceholder=\"Tìm tỉnh...\"\r\n                  emptyPlaceholder=\"Không tìm thấy.\"\r\n                  estimatedItemHeight={36}\r\n                />\r\n              </div>\r\n\r\n              {/* Show district field only for 3-level addresses */}\r\n              {addressLevel === '3-level' && (\r\n                <div className=\"grid gap-1.5\">\r\n                  <Label htmlFor=\"district\" className=\"text-xs\">\r\n                    Quận/Huyện *\r\n                  </Label>\r\n                  <VirtualizedCombobox\r\n                    options={districtOptions}\r\n                    value={districtOptions.find((opt) => opt.value === formData.district) || null}\r\n                    onChange={(option) => {\r\n                      const selectedDist = availableDistricts.find((d) => d.name === option?.value);\r\n                      setFormData((prev) => ({\r\n                        ...prev,\r\n                        district: option ? option.value : '',\r\n                        districtId: selectedDist?.id || 0,\r\n                        ward: '',\r\n                        wardId: '',\r\n                      }));\r\n                    }}\r\n                    placeholder={selectedProvince ? 'Chọn quận/huyện' : 'Chọn tỉnh trước'}\r\n                    searchPlaceholder=\"Tìm quận/huyện...\"\r\n                    emptyPlaceholder=\"Không tìm thấy.\"\r\n                    disabled={!selectedProvince}\r\n                    estimatedItemHeight={36}\r\n                  />\r\n                </div>\r\n              )}\r\n\r\n              <div className=\"grid gap-1.5\">\r\n                <Label htmlFor=\"ward\" className=\"text-xs\">\r\n                  Phường/Xã\r\n                </Label>\r\n                <VirtualizedCombobox\r\n                  options={wardOptions}\r\n                  value={wardOptions.find((opt) => opt.value === formData.ward) || null}\r\n                  onChange={(option) => {\r\n                    const selectedWard = availableWards.find((w) => w.name === option?.value);\r\n                    setFormData((prev) => ({\r\n                      ...prev,\r\n                      ward: option ? option.value : '',\r\n                      wardId: selectedWard?.id || '',\r\n                      districtId:\r\n                        addressLevel === '3-level'\r\n                          ? selectedWard?.districtId || prev.districtId || 0\r\n                          : prev.districtId,\r\n                    }));\r\n                  }}\r\n                  placeholder={\r\n                    addressLevel === '3-level' && !formData.districtId\r\n                      ? 'Chọn quận/huyện trước'\r\n                      : selectedProvince\r\n                      ? 'Chọn phường/xã'\r\n                      : 'Chọn tỉnh trước'\r\n                  }\r\n                  searchPlaceholder=\"Tìm phường/xã...\"\r\n                  emptyPlaceholder=\"Không tìm thấy.\"\r\n                  disabled={!selectedProvince || (addressLevel === '3-level' && !formData.districtId)}\r\n                  estimatedItemHeight={36}\r\n                />\r\n              </div>\r\n            </div>\r\n          </div>\r\n\r\n          <div className=\"grid grid-cols-2 gap-2\">\r\n            <div className=\"grid gap-1.5\">\r\n              <Label htmlFor=\"contactName\" className=\"text-xs\">\r\n                Người liên hệ\r\n              </Label>\r\n              <Input\r\n                className=\"h-9\"\r\n                id=\"contactName\"\r\n                placeholder=\"Tên người liên hệ\"\r\n                value={formData.contactName}\r\n                onChange={(e) => setFormData({ ...formData, contactName: e.target.value })}\r\n              />\r\n            </div>\r\n            <div className=\"grid gap-1.5\">\r\n              <Label htmlFor=\"contactPhone\" className=\"text-xs\">\r\n                Số điện thoại\r\n              </Label>\r\n              <Input\r\n                className=\"h-9\"\r\n                id=\"contactPhone\"\r\n                placeholder=\"Số điện thoại liên hệ\"\r\n                value={formData.contactPhone}\r\n                onChange={(e) => setFormData({ ...formData, contactPhone: e.target.value })}\r\n              />\r\n            </div>\r\n          </div>\r\n\r\n          <div className=\"grid gap-1.5\">\r\n            <Label htmlFor=\"notes\" className=\"text-xs\">\r\n              Ghi chú\r\n            </Label>\r\n            <Input\r\n              className=\"h-9\"\r\n              id=\"notes\"\r\n              placeholder=\"Ghi chú thêm về địa chỉ này...\"\r\n              value={formData.notes}\r\n              onChange={(e) => setFormData({ ...formData, notes: e.target.value })}\r\n            />\r\n          </div>\r\n\r\n          {/* ✅ Hide default switches when hideDefaultSwitches=true */}\r\n          {!hideDefaultSwitches && (\r\n            <div className=\"space-y-3 border-t pt-3\">\r\n              <div className=\"flex items-center justify-between space-x-2 p-3 border rounded-lg\">\r\n                <Label htmlFor=\"isDefaultShipping\" className=\"font-normal text-sm flex-1 cursor-pointer\">\r\n                  Đặt làm mặc định giao hàng\r\n                </Label>\r\n                <Switch\r\n                  id=\"isDefaultShipping\"\r\n                  checked={formData.isDefaultShipping}\r\n                  onCheckedChange={(checked) => setFormData({ ...formData, isDefaultShipping: checked })}\r\n                />\r\n              </div>\r\n\r\n              <div className=\"flex items-center justify-between space-x-2 p-3 border rounded-lg\">\r\n                <Label htmlFor=\"isDefaultBilling\" className=\"font-normal text-sm flex-1 cursor-pointer\">\r\n                  Đặt làm mặc định hóa đơn\r\n                </Label>\r\n                <Switch\r\n                  id=\"isDefaultBilling\"\r\n                  checked={formData.isDefaultBilling}\r\n                  onCheckedChange={(checked) => setFormData({ ...formData, isDefaultBilling: checked })}\r\n                />\r\n              </div>\r\n            </div>\r\n          )}\r\n        </div>\r\n\r\n        <DialogFooter className=\"flex-col sm:flex-row gap-2 sm:gap-0\">\r\n          <Button variant=\"outline\" onClick={() => onOpenChange(false)} className=\"w-full sm:w-auto\">\r\n            Hủy\r\n          </Button>\r\n          <Button onClick={handleSave} className=\"w-full sm:w-auto\">\r\n            {editingAddress ? 'Cập nhật' : 'Thêm mới'}\r\n          </Button>\r\n        </DialogFooter>\r\n      </DialogContent>\r\n    </Dialog>\r\n  );\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 3303, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/customers/customer-addresses.tsx"],"sourcesContent":["import * as React from 'react';\r\nimport { Button } from '../../components/ui/button';\r\nimport { Card, CardContent } from '../../components/ui/card';\r\nimport { Badge } from '../../components/ui/badge';\r\nimport { Switch } from '../../components/ui/switch';\r\nimport { MapPin, Plus, Edit, Trash2, Check, ArrowLeftRight, X, MoreHorizontal, Eye } from 'lucide-react';\r\nimport {\r\n  Table,\r\n  TableBody,\r\n  TableCell,\r\n  TableHead,\r\n  TableHeader,\r\n  TableRow,\r\n} from '../../components/ui/table';\r\nimport {\r\n  DropdownMenu,\r\n  DropdownMenuContent,\r\n  DropdownMenuItem,\r\n  DropdownMenuSeparator,\r\n  DropdownMenuTrigger,\r\n} from '../../components/ui/dropdown-menu';\r\nimport {\r\n  Dialog,\r\n  DialogContent,\r\n  DialogDescription,\r\n  DialogFooter,\r\n  DialogHeader,\r\n  DialogTitle,\r\n} from '../../components/ui/dialog';\r\nimport { toast } from 'sonner';\r\nimport { cn } from '../../lib/utils';\r\nimport { AddressBidirectionalConverter } from './components/address-bidirectional-converter';\r\nimport { AddressFormDialog } from './components/address-form-dialog';\r\nimport type { EnhancedCustomerAddress } from './types/enhanced-address';\r\n\r\n// Use EnhancedCustomerAddress as CustomerAddress\r\nexport type CustomerAddress = EnhancedCustomerAddress;\r\n\r\ninterface CustomerAddressesProps {\r\n  addresses: CustomerAddress[];\r\n  onUpdate: (addresses: CustomerAddress[]) => void;\r\n}\r\n\r\nexport function CustomerAddresses({ addresses = [], onUpdate }: CustomerAddressesProps) {\r\n  console.log('[CustomerAddresses] Render with addresses:', addresses);\r\n  \r\n  const [isDialogOpen, setIsDialogOpen] = React.useState(false);\r\n  const [isConverterOpen, setIsConverterOpen] = React.useState(false);\r\n  const [isDeleteDialogOpen, setIsDeleteDialogOpen] = React.useState(false);\r\n  const [deletingAddress, setDeletingAddress] = React.useState<CustomerAddress | null>(null);\r\n  const [convertingAddress, setConvertingAddress] = React.useState<CustomerAddress | null>(null);\r\n  const [editingAddress, setEditingAddress] = React.useState<CustomerAddress | null>(null);\r\n\r\n  const handleAddNew = () => {\r\n    setEditingAddress(null);\r\n    setIsDialogOpen(true);\r\n  };\r\n\r\n  const handleEdit = (address: CustomerAddress) => {\r\n    setEditingAddress(address);\r\n    setIsDialogOpen(true);\r\n  };\r\n\r\n  const handleConvert = (address: CustomerAddress) => {\r\n    setConvertingAddress(address);\r\n    setIsConverterOpen(true);\r\n  };\r\n\r\n  const handleConverterSave = (convertedAddress: Partial<CustomerAddress>) => {\r\n    // Add converted address to list\r\n    const newAddress: CustomerAddress = {\r\n      ...convertedAddress,\r\n      id: crypto.randomUUID(),\r\n      isDefaultShipping: false,\r\n      isDefaultBilling: false,\r\n    } as CustomerAddress;\r\n    \r\n    onUpdate([...addresses, newAddress]);\r\n    setIsConverterOpen(false);\r\n    setConvertingAddress(null);\r\n    toast.success('Đã thêm địa chỉ đã chuyển đổi');\r\n  };\r\n\r\n  const handleSave = (addressData: Omit<CustomerAddress, 'id'>) => {\r\n    console.log('[CustomerAddresses] handleSave called:', {\r\n      addressData,\r\n      editingAddress,\r\n      currentAddresses: addresses,\r\n    });\r\n\r\n    let newAddresses: CustomerAddress[];\r\n    let savedAddressId: string;\r\n\r\n    if (editingAddress) {\r\n      // Update existing\r\n      savedAddressId = editingAddress.id;\r\n      newAddresses = addresses.map(addr =>\r\n        addr.id === editingAddress.id \r\n          ? { \r\n              ...addressData, \r\n              id: addr.id,\r\n            } as CustomerAddress \r\n          : addr\r\n      );\r\n    } else {\r\n      // Add new\r\n      savedAddressId = crypto.randomUUID();\r\n      const newAddress: CustomerAddress = {\r\n        ...addressData,\r\n        id: savedAddressId,\r\n        createdAt: new Date().toISOString(),\r\n        updatedAt: new Date().toISOString(),\r\n      };\r\n      console.log('[CustomerAddresses] Created new address:', newAddress);\r\n      newAddresses = [...addresses, newAddress];\r\n    }\r\n\r\n    // If setting as default shipping, unset other shipping defaults\r\n    if (addressData.isDefaultShipping) {\r\n      newAddresses = newAddresses.map(addr => {\r\n        if (addr.id !== savedAddressId) {\r\n          return { ...addr, isDefaultShipping: false };\r\n        }\r\n        return addr;\r\n      });\r\n    }\r\n\r\n    // If setting as default billing, unset other billing defaults\r\n    if (addressData.isDefaultBilling) {\r\n      newAddresses = newAddresses.map(addr => {\r\n        if (addr.id !== savedAddressId) {\r\n          return { ...addr, isDefaultBilling: false };\r\n        }\r\n        return addr;\r\n      });\r\n    }\r\n\r\n    console.log('[CustomerAddresses] Calling onUpdate with:', newAddresses);\r\n    onUpdate(newAddresses);\r\n    \r\n    const types: string[] = [];\r\n    if (addressData.isDefaultShipping) types.push('Mặc định giao hàng');\r\n    if (addressData.isDefaultBilling) types.push('Mặc định hóa đơn');\r\n    \r\n    toast.success(\r\n      editingAddress ? 'Đã cập nhật địa chỉ' : 'Đã thêm địa chỉ mới',\r\n      { description: types.length > 0 ? `${types.join(', ')}` : undefined }\r\n    );\r\n  };\r\n\r\n  const handleDelete = (id: string) => {\r\n    const address = addresses.find(addr => addr.id === id);\r\n    if (!address) return;\r\n\r\n    setDeletingAddress(address);\r\n    setIsDeleteDialogOpen(true);\r\n  };\r\n\r\n  const handleSetDefault = (id: string, type: 'shipping' | 'billing') => {\r\n    const address = addresses.find(addr => addr.id === id);\r\n    if (!address) return;\r\n\r\n    const updatedAddresses = addresses.map(addr => {\r\n      if (type === 'shipping') {\r\n        // Unset all other shipping defaults, set this one\r\n        return {\r\n          ...addr,\r\n          isDefaultShipping: addr.id === id,\r\n        };\r\n      } else if (type === 'billing') {\r\n        // Unset all other billing defaults, set this one\r\n        return {\r\n          ...addr,\r\n          isDefaultBilling: addr.id === id,\r\n        };\r\n      }\r\n      return addr;\r\n    });\r\n    \r\n    onUpdate(updatedAddresses);\r\n    \r\n    const typeLabel = type === 'shipping' ? 'giao hàng' : 'hóa đơn';\r\n    toast.success(`Đã đặt làm địa chỉ mặc định ${typeLabel}`);\r\n  };\r\n\r\n  const confirmDelete = () => {\r\n    if (!deletingAddress) return;\r\n\r\n    const newAddresses = addresses.filter(addr => addr.id !== deletingAddress.id);\r\n    onUpdate(newAddresses);\r\n    toast.success('Đã xóa địa chỉ');\r\n    setIsDeleteDialogOpen(false);\r\n    setDeletingAddress(null);\r\n  };\r\n\r\n  const formatFullAddress = (addr: CustomerAddress) => {\r\n    const parts = [addr.street, addr.ward, addr.district, addr.province].filter(Boolean);\r\n    return parts.join(', ');\r\n  };\r\n\r\n  return (\r\n    <div className=\"space-y-4\">\r\n      <div className=\"flex items-center justify-between\">\r\n        <h3 className=\"text-base font-medium\">Danh sách địa chỉ</h3>\r\n        <Button onClick={handleAddNew} size=\"sm\">\r\n          <Plus className=\"mr-2 h-4 w-4\" />\r\n          Thêm địa chỉ\r\n        </Button>\r\n      </div>\r\n\r\n      {addresses.length === 0 ? (\r\n        <Card>\r\n          <CardContent className=\"py-12 text-center text-muted-foreground\">\r\n            Chưa có địa chỉ nào. Nhấn \"Thêm địa chỉ\" để tạo mới.\r\n          </CardContent>\r\n        </Card>\r\n      ) : (\r\n        <div className=\"rounded-md border\">\r\n          <Table>\r\n            <TableHeader>\r\n              <TableRow>\r\n                <TableHead>Tên địa chỉ</TableHead>\r\n                <TableHead>Địa chỉ</TableHead>\r\n                <TableHead>Tỉnh/TP</TableHead>\r\n                <TableHead>Quận/Huyện</TableHead>\r\n                <TableHead>Phường/Xã</TableHead>\r\n                <TableHead>Loại</TableHead>\r\n                <TableHead>Liên hệ</TableHead>\r\n                <TableHead>SĐT</TableHead>\r\n                <TableHead className=\"text-center\">MĐ GH</TableHead>\r\n                <TableHead className=\"text-center\">MĐ HĐ</TableHead>\r\n                <TableHead className=\"w-[50px]\"></TableHead>\r\n              </TableRow>\r\n            </TableHeader>\r\n            <TableBody>\r\n              {addresses.map((address) => (\r\n                <TableRow \r\n                  key={address.id} \r\n                  className=\"cursor-pointer\"\r\n                  onClick={() => handleEdit(address)}\r\n                >\r\n                  <TableCell className=\"font-medium\">{address.label}</TableCell>\r\n                  <TableCell>{address.street}</TableCell>\r\n                  <TableCell>{address.province}</TableCell>\r\n                  <TableCell>{address.district || '—'}</TableCell>\r\n                  <TableCell>{address.ward || '—'}</TableCell>\r\n                  <TableCell>\r\n                    <Badge variant={address.inputLevel === '2-level' ? 'secondary' : 'default'}>\r\n                      {address.inputLevel === '2-level' ? '2 cấp' : '3 cấp'}\r\n                    </Badge>\r\n                  </TableCell>\r\n                  <TableCell>{address.contactName || '—'}</TableCell>\r\n                  <TableCell>{address.contactPhone || '—'}</TableCell>\r\n                  <TableCell className=\"text-center\" onClick={(e) => e.stopPropagation()}>\r\n                    <Switch \r\n                      checked={address.isDefaultShipping} \r\n                      onCheckedChange={() => handleSetDefault(address.id, 'shipping')}\r\n                    />\r\n                  </TableCell>\r\n                  <TableCell className=\"text-center\" onClick={(e) => e.stopPropagation()}>\r\n                    <Switch \r\n                      checked={address.isDefaultBilling} \r\n                      onCheckedChange={() => handleSetDefault(address.id, 'billing')}\r\n                    />\r\n                  </TableCell>\r\n                  <TableCell onClick={(e) => e.stopPropagation()}>\r\n                    <DropdownMenu>\r\n                      <DropdownMenuTrigger asChild>\r\n                        <Button variant=\"ghost\" size=\"icon\" className=\"h-8 w-8\">\r\n                          <MoreHorizontal className=\"h-4 w-4\" />\r\n                          <span className=\"sr-only\">Mở menu</span>\r\n                        </Button>\r\n                      </DropdownMenuTrigger>\r\n                      <DropdownMenuContent align=\"end\">\r\n                        <DropdownMenuItem onClick={() => handleEdit(address)}>\r\n                          Sửa\r\n                        </DropdownMenuItem>\r\n                        <DropdownMenuSeparator />\r\n                        <DropdownMenuItem onClick={() => handleConvert(address)}>\r\n                          {address.inputLevel === '2-level' ? 'Chuyển sang 3 cấp' : 'Chuyển sang 2 cấp'}\r\n                        </DropdownMenuItem>\r\n                        <DropdownMenuSeparator />\r\n                        <DropdownMenuItem \r\n                          onClick={() => handleDelete(address.id)}\r\n                          className=\"text-destructive focus:text-destructive\"\r\n                        >\r\n                          Xóa\r\n                        </DropdownMenuItem>\r\n                      </DropdownMenuContent>\r\n                    </DropdownMenu>\r\n                  </TableCell>\r\n                </TableRow>\r\n              ))}\r\n            </TableBody>\r\n          </Table>\r\n        </div>\r\n      )}\r\n\r\n      {/* Add/Edit Dialog */}\r\n      <AddressFormDialog\r\n        isOpen={isDialogOpen}\r\n        onOpenChange={setIsDialogOpen}\r\n        onSave={handleSave}\r\n        editingAddress={editingAddress}\r\n      />\r\n\r\n      {/* Address Converter Dialog */}\r\n      {convertingAddress && (\r\n        <AddressBidirectionalConverter\r\n          address={convertingAddress}\r\n          onSuccess={handleConverterSave}\r\n          open={isConverterOpen}\r\n          onOpenChange={setIsConverterOpen}\r\n        />\r\n      )}\r\n\r\n      {/* Delete Confirmation Dialog */}\r\n      <Dialog open={isDeleteDialogOpen} onOpenChange={setIsDeleteDialogOpen}>\r\n        <DialogContent className=\"max-w-md\">\r\n          <DialogHeader>\r\n            <DialogTitle>Xác nhận xóa địa chỉ</DialogTitle>\r\n            <DialogDescription>\r\n              Bạn có chắc chắn muốn xóa địa chỉ này?\r\n            </DialogDescription>\r\n          </DialogHeader>\r\n          {deletingAddress && (\r\n            <div className=\"py-4 space-y-2\">\r\n              <div className=\"p-3 bg-muted rounded-md\">\r\n                <p className=\"font-medium text-sm\">{deletingAddress.label}</p>\r\n                <p className=\"text-sm text-muted-foreground mt-1\">\r\n                  {formatFullAddress(deletingAddress)}\r\n                </p>\r\n              </div>\r\n              <p className=\"text-sm text-muted-foreground\">\r\n                Hành động này không thể hoàn tác.\r\n              </p>\r\n            </div>\r\n          )}\r\n          <DialogFooter className=\"flex-col sm:flex-row gap-2 sm:gap-0\">\r\n            <Button \r\n              variant=\"outline\" \r\n              onClick={() => setIsDeleteDialogOpen(false)}\r\n              className=\"w-full sm:w-auto\"\r\n            >\r\n              Hủy\r\n            </Button>\r\n            <Button \r\n              variant=\"destructive\"\r\n              onClick={confirmDelete}\r\n              className=\"w-full sm:w-auto\"\r\n            >\r\n              Xóa địa chỉ\r\n            </Button>\r\n          </DialogFooter>\r\n        </DialogContent>\r\n      </Dialog>\r\n    </div>\r\n  );\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 3983, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/customers/sla/evaluator.ts"],"sourcesContent":["import { differenceInDays, parseISO, formatISO } from 'date-fns';\r\nimport type { Customer } from '../types';\r\nimport type { CustomerSlaSetting, CustomerSlaType } from '../../settings/customers/types';\r\nimport type { CustomerSlaAlert, CustomerSlaIndex, CustomerHealthAlert, DebtAlert, ReportSummary } from './types';\r\nimport { calculateChurnRisk, calculateHealthScore } from '../intelligence-utils';\r\n\r\nconst MIN_DATE = '1970-01-01T00:00:00Z';\r\n\r\ntype AlertLevel = CustomerSlaAlert['alertLevel'];\r\n\r\nfunction calculateAlertLevel(daysRemaining: number, slaSetting: CustomerSlaSetting): AlertLevel {\r\n  // daysRemaining < 0 means overdue\r\n  // criticalDays = số ngày quá hạn để coi là nghiêm trọng\r\n  // warningDays = số ngày TRƯỚC target để bắt đầu cảnh báo\r\n  \r\n  if (daysRemaining < -slaSetting.criticalDays) return 'overdue'; // Quá hạn > criticalDays ngày\r\n  if (daysRemaining < 0) return 'critical'; // Quá hạn nhưng chưa đến criticalDays\r\n  if (daysRemaining <= slaSetting.warningDays) return 'warning'; // Còn <= warningDays ngày\r\n  return 'normal';\r\n}\r\n\r\nfunction addDays(base: Date, days: number) {\r\n  return new Date(base.getTime() + days * 24 * 60 * 60 * 1000);\r\n}\r\n\r\nfunction resolveBaselineDate(customer: Customer, slaType: CustomerSlaType) {\r\n  switch (slaType) {\r\n    case 'follow-up':\r\n      return customer.lastContactDate || customer.lastPurchaseDate || customer.updatedAt || customer.createdAt || MIN_DATE;\r\n    case 're-engagement':\r\n      return customer.lastPurchaseDate || customer.updatedAt || customer.createdAt || MIN_DATE;\r\n    case 'debt-payment':\r\n      return customer.oldestDebtDueDate || customer.updatedAt || customer.createdAt || MIN_DATE;\r\n  }\r\n}\r\n\r\nfunction getAssignee(customer: Customer, slaType: CustomerSlaType) {\r\n  if (customer.accountManagerName) return customer.accountManagerName;\r\n  if (customer.accountManagerId) return customer.accountManagerId;\r\n  if (slaType === 'debt-payment') return 'Kế toán công nợ';\r\n  return 'Chưa phân công';\r\n}\r\n\r\nfunction getLastActivity(customer: Customer, slaType: CustomerSlaType) {\r\n  if (slaType === 'debt-payment') {\r\n    return customer.oldestDebtDueDate || customer.updatedAt || customer.createdAt || MIN_DATE;\r\n  }\r\n  if (slaType === 'follow-up') {\r\n    return customer.lastContactDate || customer.lastPurchaseDate || customer.updatedAt || customer.createdAt || MIN_DATE;\r\n  }\r\n  return customer.lastPurchaseDate || customer.updatedAt || customer.createdAt || MIN_DATE;\r\n}\r\n\r\nfunction evaluateSla(customers: Customer[], slaSettings: CustomerSlaSetting[], slaType: CustomerSlaType) {\r\n  const setting = slaSettings.find(s => s.slaType === slaType && s.isActive);\r\n  if (!setting) return [] as CustomerSlaAlert[];\r\n\r\n  const today = new Date();\r\n  const alerts: CustomerSlaAlert[] = [];\r\n\r\n  for (const customer of customers) {\r\n    if (customer.isDeleted || customer.status === 'Ngừng Giao Dịch') continue;\r\n\r\n    const baselineISO = resolveBaselineDate(customer, slaType);\r\n    const baseline = parseISO(baselineISO);\r\n    const daysSinceBaseline = differenceInDays(today, baseline);\r\n    const daysRemaining = setting.targetDays - daysSinceBaseline;\r\n\r\n    if (slaType === 're-engagement' && !customer.totalOrders) continue;\r\n    if (slaType === 'debt-payment' && !customer.currentDebt) continue;\r\n\r\n    // Hiển thị alert khi:\r\n    // - Còn <= warningDays ngày (sắp đến hạn)\r\n    // - Hoặc đã quá hạn (daysRemaining < 0)\r\n    if (daysRemaining <= setting.warningDays) {\r\n      alerts.push({\r\n        systemId: customer.systemId,\r\n        customer,\r\n        slaType,\r\n        slaName: setting.name,\r\n        daysRemaining,\r\n        alertLevel: calculateAlertLevel(daysRemaining, setting),\r\n        targetDate: formatISO(addDays(baseline, setting.targetDays), { representation: 'date' }),\r\n        lastActivityDate: baselineISO,\r\n        assignee: getAssignee(customer, slaType),\r\n      });\r\n    }\r\n  }\r\n\r\n  return alerts.sort((a, b) => a.daysRemaining - b.daysRemaining);\r\n}\r\n\r\nfunction evaluateDebts(customers: Customer[]): DebtAlert[] {\r\n  const alerts: DebtAlert[] = [];\r\n  const today = new Date();\r\n\r\n  for (const customer of customers) {\r\n    if (customer.isDeleted) continue;\r\n    const currentDebt = customer.currentDebt || 0;\r\n    if (currentDebt <= 0) continue;\r\n\r\n    let overdueAmount = 0;\r\n    let maxDaysOverdue = 0;\r\n    let oldestDueDate: string | undefined;\r\n\r\n    if (customer.debtTransactions) {\r\n      for (const txn of customer.debtTransactions) {\r\n        if (txn.isPaid) continue;\r\n        const dueDate = parseISO(txn.dueDate);\r\n        const daysOverdue = differenceInDays(today, dueDate);\r\n        if (daysOverdue > 0) {\r\n          overdueAmount += txn.remainingAmount || txn.amount;\r\n          if (daysOverdue > maxDaysOverdue) {\r\n            maxDaysOverdue = daysOverdue;\r\n            oldestDueDate = txn.dueDate;\r\n          }\r\n        }\r\n      }\r\n    }\r\n\r\n    // ✅ Tính debtStatus realtime thay vì lấy từ dữ liệu cũ\r\n    let debtStatus: NonNullable<Customer['debtStatus']>;\r\n    if (maxDaysOverdue > 30) {\r\n      debtStatus = 'Quá hạn > 30 ngày';\r\n    } else if (maxDaysOverdue > 15) {\r\n      debtStatus = 'Quá hạn 16-30 ngày';\r\n    } else if (maxDaysOverdue > 7) {\r\n      debtStatus = 'Quá hạn 8-15 ngày';\r\n    } else if (maxDaysOverdue > 0) {\r\n      debtStatus = 'Quá hạn 1-7 ngày';\r\n    } else if (oldestDueDate) {\r\n      const daysUntilDue = differenceInDays(parseISO(oldestDueDate), today);\r\n      if (daysUntilDue <= 0) {\r\n        debtStatus = 'Đến hạn hôm nay';\r\n      } else if (daysUntilDue <= 3) {\r\n        debtStatus = 'Sắp đến hạn';\r\n      } else {\r\n        debtStatus = 'Chưa đến hạn';\r\n      }\r\n    } else {\r\n      debtStatus = customer.debtStatus || 'Chưa đến hạn';\r\n    }\r\n    \r\n    // ✅ Chỉ hiển thị nếu thực sự có nợ quá hạn (overdueAmount > 0)\r\n    if (overdueAmount > 0) {\r\n      const debtAlert: DebtAlert = {\r\n        systemId: customer.systemId,\r\n        customer,\r\n        totalDebt: currentDebt,\r\n        overdueAmount,\r\n        daysOverdue: maxDaysOverdue,\r\n        debtStatus,\r\n      };\r\n      if (oldestDueDate !== undefined) {\r\n        debtAlert.oldestDueDate = oldestDueDate;\r\n      }\r\n      alerts.push(debtAlert);\r\n    }\r\n  }\r\n\r\n  return alerts.sort((a, b) => b.daysOverdue - a.daysOverdue);\r\n}\r\n\r\nfunction evaluateHealth(customers: Customer[]): CustomerHealthAlert[] {\r\n  const today = new Date();\r\n  const alerts: CustomerHealthAlert[] = [];\r\n\r\n  for (const customer of customers) {\r\n    if (customer.isDeleted || customer.status === 'Ngừng Giao Dịch') continue;\r\n\r\n    // ✅ Tính realtime thay vì lấy từ dữ liệu cũ\r\n    const healthScore = calculateHealthScore(customer);\r\n    const churnRiskResult = calculateChurnRisk(customer);\r\n    const churnRisk = churnRiskResult.risk;\r\n\r\n    // Chỉ hiển thị nếu có rủi ro medium/high hoặc health score thấp\r\n    if (churnRisk !== 'low' || healthScore < 50) {\r\n      const daysSinceLastPurchase = customer.lastPurchaseDate\r\n        ? differenceInDays(today, parseISO(customer.lastPurchaseDate))\r\n        : 999;\r\n\r\n      const healthAlert: CustomerHealthAlert = {\r\n        systemId: customer.systemId,\r\n        customer,\r\n        healthScore,\r\n        churnRisk,\r\n        daysSinceLastPurchase,\r\n        totalOrders: customer.totalOrders || 0,\r\n        totalSpent: customer.totalSpent || 0,\r\n      };\r\n      if (customer.segment !== undefined) {\r\n        healthAlert.segment = customer.segment;\r\n      }\r\n      alerts.push(healthAlert);\r\n    }\r\n  }\r\n\r\n  return alerts.sort((a, b) => a.healthScore - b.healthScore);\r\n}\r\n\r\nexport function buildSlaIndex(customers: Customer[], slaSettings: CustomerSlaSetting[]): CustomerSlaIndex {\r\n  const followUpAlerts = evaluateSla(customers, slaSettings, 'follow-up');\r\n  const reEngagementAlerts = evaluateSla(customers, slaSettings, 're-engagement');\r\n  const debtAlerts = evaluateDebts(customers);\r\n  const healthAlerts = evaluateHealth(customers);\r\n\r\n  const entries: CustomerSlaIndex['entries'] = {};\r\n\r\n  for (const alert of followUpAlerts) {\r\n    entries[alert.systemId] = entries[alert.systemId] || { customer: alert.customer, alerts: [] };\r\n    entries[alert.systemId].alerts.push(alert);\r\n  }\r\n  for (const alert of reEngagementAlerts) {\r\n    entries[alert.systemId] = entries[alert.systemId] || { customer: alert.customer, alerts: [] };\r\n    entries[alert.systemId].alerts.push(alert);\r\n  }\r\n  for (const alert of debtAlerts) {\r\n    entries[alert.systemId] = entries[alert.systemId] || { customer: alert.customer, alerts: [] };\r\n    entries[alert.systemId].debtAlert = alert;\r\n  }\r\n  for (const alert of healthAlerts) {\r\n    entries[alert.systemId] = entries[alert.systemId] || { customer: alert.customer, alerts: [] };\r\n    entries[alert.systemId].healthAlert = alert;\r\n  }\r\n\r\n  return {\r\n    entries,\r\n    followUpAlerts,\r\n    reEngagementAlerts,\r\n    debtAlerts,\r\n    healthAlerts,\r\n  };\r\n}\r\n\r\nexport function summarizeIndex(index: CustomerSlaIndex): ReportSummary {\r\n  // Count unique customers with critical alerts\r\n  const criticalCustomerIds = new Set<string>();\r\n  \r\n  index.followUpAlerts\r\n    .filter(a => a.alertLevel === 'critical' || a.alertLevel === 'overdue')\r\n    .forEach(a => criticalCustomerIds.add(a.systemId));\r\n  \r\n  index.reEngagementAlerts\r\n    .filter(a => a.alertLevel === 'critical' || a.alertLevel === 'overdue')\r\n    .forEach(a => criticalCustomerIds.add(a.systemId));\r\n  \r\n  index.debtAlerts\r\n    .filter(a => a.daysOverdue > 15)\r\n    .forEach(a => criticalCustomerIds.add(a.systemId));\r\n  \r\n  index.healthAlerts\r\n    .filter(a => a.churnRisk === 'high')\r\n    .forEach(a => criticalCustomerIds.add(a.systemId));\r\n  \r\n  const criticalCount = criticalCustomerIds.size;\r\n  const totalCustomers = Object.keys(index.entries).length;\r\n\r\n  return {\r\n    totalCustomers,\r\n    followUpAlerts: index.followUpAlerts.length,\r\n    reEngagementAlerts: index.reEngagementAlerts.length,\r\n    debtAlerts: index.debtAlerts.length,\r\n    healthAlerts: index.healthAlerts.length,\r\n    criticalCount,\r\n  };\r\n}\r\n"],"names":[],"mappings":";;;;;;AAAA;AAAA;AAAA;AAIA;;;AAEA,MAAM,WAAW;AAIjB,SAAS,oBAAoB,aAAqB,EAAE,UAA8B;IAChF,kCAAkC;IAClC,wDAAwD;IACxD,yDAAyD;IAEzD,IAAI,gBAAgB,CAAC,WAAW,YAAY,EAAE,OAAO,WAAW,8BAA8B;IAC9F,IAAI,gBAAgB,GAAG,OAAO,YAAY,sCAAsC;IAChF,IAAI,iBAAiB,WAAW,WAAW,EAAE,OAAO,WAAW,0BAA0B;IACzF,OAAO;AACT;AAEA,SAAS,QAAQ,IAAU,EAAE,IAAY;IACvC,OAAO,IAAI,KAAK,KAAK,OAAO,KAAK,OAAO,KAAK,KAAK,KAAK;AACzD;AAEA,SAAS,oBAAoB,QAAkB,EAAE,OAAwB;IACvE,OAAQ;QACN,KAAK;YACH,OAAO,SAAS,eAAe,IAAI,SAAS,gBAAgB,IAAI,SAAS,SAAS,IAAI,SAAS,SAAS,IAAI;QAC9G,KAAK;YACH,OAAO,SAAS,gBAAgB,IAAI,SAAS,SAAS,IAAI,SAAS,SAAS,IAAI;QAClF,KAAK;YACH,OAAO,SAAS,iBAAiB,IAAI,SAAS,SAAS,IAAI,SAAS,SAAS,IAAI;IACrF;AACF;AAEA,SAAS,YAAY,QAAkB,EAAE,OAAwB;IAC/D,IAAI,SAAS,kBAAkB,EAAE,OAAO,SAAS,kBAAkB;IACnE,IAAI,SAAS,gBAAgB,EAAE,OAAO,SAAS,gBAAgB;IAC/D,IAAI,YAAY,gBAAgB,OAAO;IACvC,OAAO;AACT;AAEA,SAAS,gBAAgB,QAAkB,EAAE,OAAwB;IACnE,IAAI,YAAY,gBAAgB;QAC9B,OAAO,SAAS,iBAAiB,IAAI,SAAS,SAAS,IAAI,SAAS,SAAS,IAAI;IACnF;IACA,IAAI,YAAY,aAAa;QAC3B,OAAO,SAAS,eAAe,IAAI,SAAS,gBAAgB,IAAI,SAAS,SAAS,IAAI,SAAS,SAAS,IAAI;IAC9G;IACA,OAAO,SAAS,gBAAgB,IAAI,SAAS,SAAS,IAAI,SAAS,SAAS,IAAI;AAClF;AAEA,SAAS,YAAY,SAAqB,EAAE,WAAiC,EAAE,OAAwB;IACrG,MAAM,UAAU,YAAY,IAAI,CAAC,CAAA,IAAK,EAAE,OAAO,KAAK,WAAW,EAAE,QAAQ;IACzE,IAAI,CAAC,SAAS,OAAO,EAAE;IAEvB,MAAM,QAAQ,IAAI;IAClB,MAAM,SAA6B,EAAE;IAErC,KAAK,MAAM,YAAY,UAAW;QAChC,IAAI,SAAS,SAAS,IAAI,SAAS,MAAM,KAAK,mBAAmB;QAEjE,MAAM,cAAc,oBAAoB,UAAU;QAClD,MAAM,WAAW,IAAA,mJAAQ,EAAC;QAC1B,MAAM,oBAAoB,IAAA,mKAAgB,EAAC,OAAO;QAClD,MAAM,gBAAgB,QAAQ,UAAU,GAAG;QAE3C,IAAI,YAAY,mBAAmB,CAAC,SAAS,WAAW,EAAE;QAC1D,IAAI,YAAY,kBAAkB,CAAC,SAAS,WAAW,EAAE;QAEzD,sBAAsB;QACtB,0CAA0C;QAC1C,wCAAwC;QACxC,IAAI,iBAAiB,QAAQ,WAAW,EAAE;YACxC,OAAO,IAAI,CAAC;gBACV,UAAU,SAAS,QAAQ;gBAC3B;gBACA;gBACA,SAAS,QAAQ,IAAI;gBACrB;gBACA,YAAY,oBAAoB,eAAe;gBAC/C,YAAY,IAAA,qJAAS,EAAC,QAAQ,UAAU,QAAQ,UAAU,GAAG;oBAAE,gBAAgB;gBAAO;gBACtF,kBAAkB;gBAClB,UAAU,YAAY,UAAU;YAClC;QACF;IACF;IAEA,OAAO,OAAO,IAAI,CAAC,CAAC,GAAG,IAAM,EAAE,aAAa,GAAG,EAAE,aAAa;AAChE;AAEA,SAAS,cAAc,SAAqB;IAC1C,MAAM,SAAsB,EAAE;IAC9B,MAAM,QAAQ,IAAI;IAElB,KAAK,MAAM,YAAY,UAAW;QAChC,IAAI,SAAS,SAAS,EAAE;QACxB,MAAM,cAAc,SAAS,WAAW,IAAI;QAC5C,IAAI,eAAe,GAAG;QAEtB,IAAI,gBAAgB;QACpB,IAAI,iBAAiB;QACrB,IAAI;QAEJ,IAAI,SAAS,gBAAgB,EAAE;YAC7B,KAAK,MAAM,OAAO,SAAS,gBAAgB,CAAE;gBAC3C,IAAI,IAAI,MAAM,EAAE;gBAChB,MAAM,UAAU,IAAA,mJAAQ,EAAC,IAAI,OAAO;gBACpC,MAAM,cAAc,IAAA,mKAAgB,EAAC,OAAO;gBAC5C,IAAI,cAAc,GAAG;oBACnB,iBAAiB,IAAI,eAAe,IAAI,IAAI,MAAM;oBAClD,IAAI,cAAc,gBAAgB;wBAChC,iBAAiB;wBACjB,gBAAgB,IAAI,OAAO;oBAC7B;gBACF;YACF;QACF;QAEA,uDAAuD;QACvD,IAAI;QACJ,IAAI,iBAAiB,IAAI;YACvB,aAAa;QACf,OAAO,IAAI,iBAAiB,IAAI;YAC9B,aAAa;QACf,OAAO,IAAI,iBAAiB,GAAG;YAC7B,aAAa;QACf,OAAO,IAAI,iBAAiB,GAAG;YAC7B,aAAa;QACf,OAAO,IAAI,eAAe;YACxB,MAAM,eAAe,IAAA,mKAAgB,EAAC,IAAA,mJAAQ,EAAC,gBAAgB;YAC/D,IAAI,gBAAgB,GAAG;gBACrB,aAAa;YACf,OAAO,IAAI,gBAAgB,GAAG;gBAC5B,aAAa;YACf,OAAO;gBACL,aAAa;YACf;QACF,OAAO;YACL,aAAa,SAAS,UAAU,IAAI;QACtC;QAEA,+DAA+D;QAC/D,IAAI,gBAAgB,GAAG;YACrB,MAAM,YAAuB;gBAC3B,UAAU,SAAS,QAAQ;gBAC3B;gBACA,WAAW;gBACX;gBACA,aAAa;gBACb;YACF;YACA,IAAI,kBAAkB,WAAW;gBAC/B,UAAU,aAAa,GAAG;YAC5B;YACA,OAAO,IAAI,CAAC;QACd;IACF;IAEA,OAAO,OAAO,IAAI,CAAC,CAAC,GAAG,IAAM,EAAE,WAAW,GAAG,EAAE,WAAW;AAC5D;AAEA,SAAS,eAAe,SAAqB;IAC3C,MAAM,QAAQ,IAAI;IAClB,MAAM,SAAgC,EAAE;IAExC,KAAK,MAAM,YAAY,UAAW;QAChC,IAAI,SAAS,SAAS,IAAI,SAAS,MAAM,KAAK,mBAAmB;QAEjE,4CAA4C;QAC5C,MAAM,cAAc,IAAA,sKAAoB,EAAC;QACzC,MAAM,kBAAkB,IAAA,oKAAkB,EAAC;QAC3C,MAAM,YAAY,gBAAgB,IAAI;QAEtC,gEAAgE;QAChE,IAAI,cAAc,SAAS,cAAc,IAAI;YAC3C,MAAM,wBAAwB,SAAS,gBAAgB,GACnD,IAAA,mKAAgB,EAAC,OAAO,IAAA,mJAAQ,EAAC,SAAS,gBAAgB,KAC1D;YAEJ,MAAM,cAAmC;gBACvC,UAAU,SAAS,QAAQ;gBAC3B;gBACA;gBACA;gBACA;gBACA,aAAa,SAAS,WAAW,IAAI;gBACrC,YAAY,SAAS,UAAU,IAAI;YACrC;YACA,IAAI,SAAS,OAAO,KAAK,WAAW;gBAClC,YAAY,OAAO,GAAG,SAAS,OAAO;YACxC;YACA,OAAO,IAAI,CAAC;QACd;IACF;IAEA,OAAO,OAAO,IAAI,CAAC,CAAC,GAAG,IAAM,EAAE,WAAW,GAAG,EAAE,WAAW;AAC5D;AAEO,SAAS,cAAc,SAAqB,EAAE,WAAiC;IACpF,MAAM,iBAAiB,YAAY,WAAW,aAAa;IAC3D,MAAM,qBAAqB,YAAY,WAAW,aAAa;IAC/D,MAAM,aAAa,cAAc;IACjC,MAAM,eAAe,eAAe;IAEpC,MAAM,UAAuC,CAAC;IAE9C,KAAK,MAAM,SAAS,eAAgB;QAClC,OAAO,CAAC,MAAM,QAAQ,CAAC,GAAG,OAAO,CAAC,MAAM,QAAQ,CAAC,IAAI;YAAE,UAAU,MAAM,QAAQ;YAAE,QAAQ,EAAE;QAAC;QAC5F,OAAO,CAAC,MAAM,QAAQ,CAAC,CAAC,MAAM,CAAC,IAAI,CAAC;IACtC;IACA,KAAK,MAAM,SAAS,mBAAoB;QACtC,OAAO,CAAC,MAAM,QAAQ,CAAC,GAAG,OAAO,CAAC,MAAM,QAAQ,CAAC,IAAI;YAAE,UAAU,MAAM,QAAQ;YAAE,QAAQ,EAAE;QAAC;QAC5F,OAAO,CAAC,MAAM,QAAQ,CAAC,CAAC,MAAM,CAAC,IAAI,CAAC;IACtC;IACA,KAAK,MAAM,SAAS,WAAY;QAC9B,OAAO,CAAC,MAAM,QAAQ,CAAC,GAAG,OAAO,CAAC,MAAM,QAAQ,CAAC,IAAI;YAAE,UAAU,MAAM,QAAQ;YAAE,QAAQ,EAAE;QAAC;QAC5F,OAAO,CAAC,MAAM,QAAQ,CAAC,CAAC,SAAS,GAAG;IACtC;IACA,KAAK,MAAM,SAAS,aAAc;QAChC,OAAO,CAAC,MAAM,QAAQ,CAAC,GAAG,OAAO,CAAC,MAAM,QAAQ,CAAC,IAAI;YAAE,UAAU,MAAM,QAAQ;YAAE,QAAQ,EAAE;QAAC;QAC5F,OAAO,CAAC,MAAM,QAAQ,CAAC,CAAC,WAAW,GAAG;IACxC;IAEA,OAAO;QACL;QACA;QACA;QACA;QACA;IACF;AACF;AAEO,SAAS,eAAe,KAAuB;IACpD,8CAA8C;IAC9C,MAAM,sBAAsB,IAAI;IAEhC,MAAM,cAAc,CACjB,MAAM,CAAC,CAAA,IAAK,EAAE,UAAU,KAAK,cAAc,EAAE,UAAU,KAAK,WAC5D,OAAO,CAAC,CAAA,IAAK,oBAAoB,GAAG,CAAC,EAAE,QAAQ;IAElD,MAAM,kBAAkB,CACrB,MAAM,CAAC,CAAA,IAAK,EAAE,UAAU,KAAK,cAAc,EAAE,UAAU,KAAK,WAC5D,OAAO,CAAC,CAAA,IAAK,oBAAoB,GAAG,CAAC,EAAE,QAAQ;IAElD,MAAM,UAAU,CACb,MAAM,CAAC,CAAA,IAAK,EAAE,WAAW,GAAG,IAC5B,OAAO,CAAC,CAAA,IAAK,oBAAoB,GAAG,CAAC,EAAE,QAAQ;IAElD,MAAM,YAAY,CACf,MAAM,CAAC,CAAA,IAAK,EAAE,SAAS,KAAK,QAC5B,OAAO,CAAC,CAAA,IAAK,oBAAoB,GAAG,CAAC,EAAE,QAAQ;IAElD,MAAM,gBAAgB,oBAAoB,IAAI;IAC9C,MAAM,iBAAiB,OAAO,IAAI,CAAC,MAAM,OAAO,EAAE,MAAM;IAExD,OAAO;QACL;QACA,gBAAgB,MAAM,cAAc,CAAC,MAAM;QAC3C,oBAAoB,MAAM,kBAAkB,CAAC,MAAM;QACnD,YAAY,MAAM,UAAU,CAAC,MAAM;QACnC,cAAc,MAAM,YAAY,CAAC,MAAM;QACvC;IACF;AACF"}},
    {"offset": {"line": 4224, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/customers/sla/sla-sync.ts"],"sourcesContent":["/**\r\n * Customer SLA Sync Utilities\r\n * NOTE: localStorage has been removed - uses in-memory cache + database sync\r\n */\r\n\r\nimport type { \r\n  CustomerSlaAckMap, \r\n  SlaActivityLog,\r\n  CustomerSlaIndex \r\n} from './types';\r\n\r\n// In-memory caches\r\nlet ackMapCache: CustomerSlaAckMap | null = null;\r\nlet activityLogCache: SlaActivityLog[] | null = null;\r\nlet evaluationCache: CustomerSlaIndex | null = null;\r\n\r\n// ============= ACKNOWLEDGEMENTS =============\r\n\r\nasync function fetchAckMap(): Promise<CustomerSlaAckMap> {\r\n  try {\r\n    const response = await fetch('/api/customer-sla?type=ack');\r\n    if (!response.ok) throw new Error('Failed to fetch');\r\n    return await response.json();\r\n  } catch (error) {\r\n    console.error('[CustomerSLA] Failed to fetch ack map:', error);\r\n    throw error;\r\n  }\r\n}\r\n\r\nasync function saveAckMapToDb(map: CustomerSlaAckMap): Promise<void> {\r\n  try {\r\n    const response = await fetch('/api/customer-sla', {\r\n      method: 'POST',\r\n      headers: { 'Content-Type': 'application/json' },\r\n      body: JSON.stringify({ type: 'ack', data: map }),\r\n    });\r\n    if (!response.ok) throw new Error('Failed to save');\r\n  } catch (error) {\r\n    console.error('[CustomerSLA] Failed to save ack map:', error);\r\n    throw error;\r\n  }\r\n}\r\n\r\n/**\r\n * Load ack map from database\r\n */\r\nexport async function loadAckMapAsync(): Promise<CustomerSlaAckMap> {\r\n  try {\r\n    const data = await fetchAckMap();\r\n    ackMapCache = data;\r\n    return data;\r\n  } catch {\r\n    return ackMapCache ?? {};\r\n  }\r\n}\r\n\r\n/**\r\n * Get ack map synchronously (from cache)\r\n */\r\nexport function getAckMapSync(): CustomerSlaAckMap {\r\n  return ackMapCache ?? {};\r\n}\r\n\r\n/**\r\n * Save ack map to database\r\n */\r\nexport async function saveAckMapAsync(map: CustomerSlaAckMap): Promise<void> {\r\n  await saveAckMapToDb(map);\r\n  ackMapCache = map;\r\n}\r\n\r\n// ============= ACTIVITY LOG =============\r\n\r\nasync function fetchActivityLog(): Promise<SlaActivityLog[]> {\r\n  try {\r\n    const response = await fetch('/api/customer-sla?type=log');\r\n    if (!response.ok) throw new Error('Failed to fetch');\r\n    return await response.json();\r\n  } catch (error) {\r\n    console.error('[CustomerSLA] Failed to fetch activity log:', error);\r\n    throw error;\r\n  }\r\n}\r\n\r\nasync function saveActivityLogToDb(logs: SlaActivityLog[]): Promise<void> {\r\n  try {\r\n    const response = await fetch('/api/customer-sla', {\r\n      method: 'POST',\r\n      headers: { 'Content-Type': 'application/json' },\r\n      body: JSON.stringify({ type: 'log', data: logs }),\r\n    });\r\n    if (!response.ok) throw new Error('Failed to save');\r\n  } catch (error) {\r\n    console.error('[CustomerSLA] Failed to save activity log:', error);\r\n    throw error;\r\n  }\r\n}\r\n\r\n/**\r\n * Load activity log from database\r\n */\r\nexport async function loadActivityLogAsync(): Promise<SlaActivityLog[]> {\r\n  try {\r\n    const data = await fetchActivityLog();\r\n    activityLogCache = data;\r\n    return data;\r\n  } catch {\r\n    return activityLogCache ?? [];\r\n  }\r\n}\r\n\r\n/**\r\n * Get activity log synchronously\r\n */\r\nexport function getActivityLogSync(): SlaActivityLog[] {\r\n  return activityLogCache ?? [];\r\n}\r\n\r\n/**\r\n * Add to activity log and save to database\r\n */\r\nexport async function addActivityLogAsync(log: SlaActivityLog): Promise<void> {\r\n  const logs = getActivityLogSync();\r\n  logs.push(log);\r\n  // Keep only last 500 entries\r\n  const trimmed = logs.slice(-500);\r\n  await saveActivityLogToDb(trimmed);\r\n  activityLogCache = trimmed;\r\n}\r\n\r\n// ============= EVALUATION DATA =============\r\n\r\nasync function fetchEvaluation(): Promise<CustomerSlaIndex | null> {\r\n  try {\r\n    const response = await fetch('/api/customer-sla?type=evaluation');\r\n    if (!response.ok) throw new Error('Failed to fetch');\r\n    return await response.json();\r\n  } catch (error) {\r\n    console.error('[CustomerSLA] Failed to fetch evaluation:', error);\r\n    throw error;\r\n  }\r\n}\r\n\r\nasync function saveEvaluationToDb(data: CustomerSlaIndex, timestamp: string): Promise<void> {\r\n  try {\r\n    await fetch('/api/customer-sla', {\r\n      method: 'POST',\r\n      headers: { 'Content-Type': 'application/json' },\r\n      body: JSON.stringify({ type: 'evaluation', data }),\r\n    });\r\n  } catch (error) {\r\n    console.error('[CustomerSLA] Failed to save evaluation:', error);\r\n    throw error;\r\n  }\r\n}\r\n\r\n/**\r\n * Load evaluation data from database\r\n */\r\nexport async function loadEvaluationAsync(): Promise<CustomerSlaIndex | null> {\r\n  try {\r\n    const data = await fetchEvaluation();\r\n    evaluationCache = data;\r\n    return data;\r\n  } catch {\r\n    return evaluationCache;\r\n  }\r\n}\r\n\r\n/**\r\n * Get evaluation data synchronously\r\n */\r\nexport function getEvaluationSync(): CustomerSlaIndex | null {\r\n  return evaluationCache;\r\n}\r\n\r\n/**\r\n * Save evaluation data to database\r\n */\r\nexport async function saveEvaluationAsync(data: CustomerSlaIndex, timestamp: string): Promise<void> {\r\n  await saveEvaluationToDb(data, timestamp);\r\n  evaluationCache = data;\r\n}\r\n\r\n// ============= INITIALIZATION =============\r\n\r\n/**\r\n * Initialize all customer SLA data from database\r\n */\r\nexport async function initCustomerSlaData(): Promise<void> {\r\n  await Promise.all([\r\n    loadAckMapAsync(),\r\n    loadActivityLogAsync(),\r\n    loadEvaluationAsync(),\r\n  ]);\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 4402, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/customers/sla/ack-storage.ts"],"sourcesContent":["/**\r\n * Customer SLA Acknowledgement Storage\r\n * \r\n * NOTE: localStorage has been removed - uses in-memory cache + database sync\r\n */\r\n\r\nimport type { CustomerSlaAckMap, CustomerSlaAcknowledgement, CustomerSlaType, SlaActivityLog } from './types';\r\nimport type { SystemId } from '@/lib/id-types';\r\nimport {\r\n  getAckMapSync,\r\n  saveAckMapAsync,\r\n  getActivityLogSync,\r\n  addActivityLogAsync,\r\n} from './sla-sync';\r\n\r\n// In-memory cache\r\nlet cachedMap: CustomerSlaAckMap | null = null;\r\nlet cachedActivityLog: SlaActivityLog[] | null = null;\r\n\r\nfunction ensureCache(): CustomerSlaAckMap {\r\n  if (!cachedMap) {\r\n    cachedMap = getAckMapSync();\r\n  }\r\n  return cachedMap;\r\n}\r\n\r\nfunction saveAckMap(map: CustomerSlaAckMap) {\r\n  cachedMap = map;\r\n  // Fire and forget - save to database in background\r\n  saveAckMapAsync(map).catch(error => {\r\n    console.warn('[customer-sla] Failed to persist ack map to database', error);\r\n  });\r\n}\r\n\r\nexport function getAcknowledgement(customerId: SystemId, slaType: CustomerSlaType): CustomerSlaAcknowledgement | undefined {\r\n  const map = ensureCache();\r\n  const ack = map[customerId]?.[slaType];\r\n  \r\n  // Check if snooze has expired\r\n  if (ack?.snoozeUntil) {\r\n    const snoozeEnd = new Date(ack.snoozeUntil);\r\n    if (snoozeEnd < new Date()) {\r\n      // Snooze expired, remove the acknowledgement\r\n      clearAcknowledgement(customerId, slaType);\r\n      return undefined;\r\n    }\r\n  }\r\n  \r\n  return ack;\r\n}\r\n\r\nexport function setAcknowledgement(customerId: SystemId, ack: CustomerSlaAcknowledgement, performedBy?: string) {\r\n  const map = ensureCache();\r\n  map[customerId] = map[customerId] || {};\r\n  map[customerId][ack.slaType] = ack;\r\n  saveAckMap(map);\r\n  \r\n  // Log activity\r\n  addActivityLog({\r\n    id: `${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,\r\n    customerId,\r\n    slaType: ack.slaType,\r\n    actionType: ack.actionType,\r\n    performedAt: ack.acknowledgedAt,\r\n    performedBy,\r\n    notes: ack.notes,\r\n  });\r\n}\r\n\r\nexport function clearAcknowledgement(customerId: SystemId, slaType?: CustomerSlaType) {\r\n  const map = ensureCache();\r\n  if (!map[customerId]) return;\r\n  if (slaType) {\r\n    delete map[customerId][slaType];\r\n  } else {\r\n    delete map[customerId];\r\n  }\r\n  saveAckMap(map);\r\n}\r\n\r\n// Activity Log functions\r\nfunction loadActivityLog(): SlaActivityLog[] {\r\n  if (!cachedActivityLog) {\r\n    cachedActivityLog = getActivityLogSync();\r\n  }\r\n  return cachedActivityLog;\r\n}\r\n\r\nexport const SLA_LOG_UPDATED_EVENT = 'sla-log-updated';\r\n\r\nexport function addActivityLog(log: SlaActivityLog) {\r\n  const logs = loadActivityLog();\r\n  logs.push(log);\r\n  // Keep only last 500 entries\r\n  cachedActivityLog = logs.slice(-500);\r\n  \r\n  // Fire and forget - save to database in background\r\n  addActivityLogAsync(log).catch(error => {\r\n    console.warn('[customer-sla] Failed to save activity log to database', error);\r\n  });\r\n  \r\n  // Dispatch event to notify listeners\r\n  if (typeof window !== 'undefined') {\r\n    window.dispatchEvent(new CustomEvent(SLA_LOG_UPDATED_EVENT, { detail: { customerId: log.customerId } }));\r\n  }\r\n}\r\n\r\nexport function getActivityLogs(customerId?: SystemId, limit = 50): SlaActivityLog[] {\r\n  const logs = loadActivityLog();\r\n  const filtered = customerId \r\n    ? logs.filter(l => l.customerId === customerId)\r\n    : logs;\r\n  return filtered.slice(-limit).reverse();\r\n}\r\n\r\nexport function isAlertSnoozed(customerId: SystemId, slaType: CustomerSlaType): boolean {\r\n  const ack = getAcknowledgement(customerId, slaType);\r\n  if (!ack?.snoozeUntil) return false;\r\n  return new Date(ack.snoozeUntil) > new Date();\r\n}\r\n\r\nexport function getSnoozeRemaining(customerId: SystemId, slaType: CustomerSlaType): number {\r\n  const ack = getAcknowledgement(customerId, slaType);\r\n  if (!ack?.snoozeUntil) return 0;\r\n  const remaining = new Date(ack.snoozeUntil).getTime() - Date.now();\r\n  return Math.max(0, Math.ceil(remaining / (1000 * 60 * 60 * 24))); // Days remaining\r\n}\r\n"],"names":[],"mappings":"AAAA;;;;CAIC;;;;;;;;;;;;;;;;;;AAID;;AAOA,kBAAkB;AAClB,IAAI,YAAsC;AAC1C,IAAI,oBAA6C;AAEjD,SAAS;IACP,IAAI,CAAC,WAAW;QACd,YAAY,IAAA,4JAAa;IAC3B;IACA,OAAO;AACT;AAEA,SAAS,WAAW,GAAsB;IACxC,YAAY;IACZ,mDAAmD;IACnD,IAAA,8JAAe,EAAC,KAAK,KAAK,CAAC,CAAA;QACzB,QAAQ,IAAI,CAAC,wDAAwD;IACvE;AACF;AAEO,SAAS,mBAAmB,UAAoB,EAAE,OAAwB;IAC/E,MAAM,MAAM;IACZ,MAAM,MAAM,GAAG,CAAC,WAAW,EAAE,CAAC,QAAQ;IAEtC,8BAA8B;IAC9B,IAAI,KAAK,aAAa;QACpB,MAAM,YAAY,IAAI,KAAK,IAAI,WAAW;QAC1C,IAAI,YAAY,IAAI,QAAQ;YAC1B,6CAA6C;YAC7C,qBAAqB,YAAY;YACjC,OAAO;QACT;IACF;IAEA,OAAO;AACT;AAEO,SAAS,mBAAmB,UAAoB,EAAE,GAA+B,EAAE,WAAoB;IAC5G,MAAM,MAAM;IACZ,GAAG,CAAC,WAAW,GAAG,GAAG,CAAC,WAAW,IAAI,CAAC;IACtC,GAAG,CAAC,WAAW,CAAC,IAAI,OAAO,CAAC,GAAG;IAC/B,WAAW;IAEX,eAAe;IACf,eAAe;QACb,IAAI,GAAG,KAAK,GAAG,GAAG,CAAC,EAAE,KAAK,MAAM,GAAG,QAAQ,CAAC,IAAI,MAAM,CAAC,GAAG,IAAI;QAC9D;QACA,SAAS,IAAI,OAAO;QACpB,YAAY,IAAI,UAAU;QAC1B,aAAa,IAAI,cAAc;QAC/B;QACA,OAAO,IAAI,KAAK;IAClB;AACF;AAEO,SAAS,qBAAqB,UAAoB,EAAE,OAAyB;IAClF,MAAM,MAAM;IACZ,IAAI,CAAC,GAAG,CAAC,WAAW,EAAE;IACtB,IAAI,SAAS;QACX,OAAO,GAAG,CAAC,WAAW,CAAC,QAAQ;IACjC,OAAO;QACL,OAAO,GAAG,CAAC,WAAW;IACxB;IACA,WAAW;AACb;AAEA,yBAAyB;AACzB,SAAS;IACP,IAAI,CAAC,mBAAmB;QACtB,oBAAoB,IAAA,iKAAkB;IACxC;IACA,OAAO;AACT;AAEO,MAAM,wBAAwB;AAE9B,SAAS,eAAe,GAAmB;IAChD,MAAM,OAAO;IACb,KAAK,IAAI,CAAC;IACV,6BAA6B;IAC7B,oBAAoB,KAAK,KAAK,CAAC,CAAC;IAEhC,mDAAmD;IACnD,IAAA,kKAAmB,EAAC,KAAK,KAAK,CAAC,CAAA;QAC7B,QAAQ,IAAI,CAAC,0DAA0D;IACzE;IAEA,qCAAqC;IACrC;;AAGF;AAEO,SAAS,gBAAgB,UAAqB,EAAE,QAAQ,EAAE;IAC/D,MAAM,OAAO;IACb,MAAM,WAAW,aACb,KAAK,MAAM,CAAC,CAAA,IAAK,EAAE,UAAU,KAAK,cAClC;IACJ,OAAO,SAAS,KAAK,CAAC,CAAC,OAAO,OAAO;AACvC;AAEO,SAAS,eAAe,UAAoB,EAAE,OAAwB;IAC3E,MAAM,MAAM,mBAAmB,YAAY;IAC3C,IAAI,CAAC,KAAK,aAAa,OAAO;IAC9B,OAAO,IAAI,KAAK,IAAI,WAAW,IAAI,IAAI;AACzC;AAEO,SAAS,mBAAmB,UAAoB,EAAE,OAAwB;IAC/E,MAAM,MAAM,mBAAmB,YAAY;IAC3C,IAAI,CAAC,KAAK,aAAa,OAAO;IAC9B,MAAM,YAAY,IAAI,KAAK,IAAI,WAAW,EAAE,OAAO,KAAK,KAAK,GAAG;IAChE,OAAO,KAAK,GAAG,CAAC,GAAG,KAAK,IAAI,CAAC,YAAY,CAAC,OAAO,KAAK,KAAK,EAAE,KAAK,iBAAiB;AACrF"}},
    {"offset": {"line": 4523, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/customers/sla/store.ts"],"sourcesContent":["/**\r\n * Customer SLA Engine Store\r\n * \r\n * NOTE: Now syncs with database via sla-sync.ts\r\n */\r\n\r\nimport { create } from 'zustand';\r\nimport type { Customer } from '../types';\r\nimport type { CustomerSlaSetting } from '../../settings/customers/types';\r\nimport type { CustomerSlaIndex, ReportSummary, CustomerSlaAlert, SlaActionType } from './types';\r\nimport { buildSlaIndex, summarizeIndex } from './evaluator';\r\nimport { SLA_EVALUATION_KEY, SLA_LAST_RUN_KEY } from './constants';\r\nimport { setAcknowledgement, getAcknowledgement, isAlertSnoozed, getSnoozeRemaining } from './ack-storage';\r\nimport { getEvaluationSync, saveEvaluationAsync } from './sla-sync';\r\nimport type { CustomerSlaType, CustomerSlaAcknowledgement } from './types';\r\nimport type { SystemId } from '@/lib/id-types';\r\nimport { getCurrentUserName } from '@/contexts/auth-context';\r\nimport { useCustomerStore } from '../store';\r\n\r\ntype SlaStoreState = {\r\n  lastEvaluatedAt?: string;\r\n  index: CustomerSlaIndex | null;\r\n  summary: ReportSummary | null;\r\n  isLoading: boolean;\r\n};\r\n\r\ntype AcknowledgeOptions = {\r\n  actionType?: SlaActionType;\r\n  snoozeDays?: number;\r\n  notes?: string;\r\n};\r\n\r\ntype SlaStoreActions = {\r\n  evaluate: (customers: Customer[], settings: CustomerSlaSetting[]) => void;\r\n  acknowledge: (customerId: SystemId, alert: CustomerSlaAlert, options?: AcknowledgeOptions) => void;\r\n  snooze: (customerId: SystemId, alert: CustomerSlaAlert, days: number, notes?: string) => void;\r\n  getAck: (customerId: SystemId, slaType: CustomerSlaType) => CustomerSlaAcknowledgement | undefined;\r\n  isSnoozed: (customerId: SystemId, slaType: CustomerSlaType) => boolean;\r\n  getSnoozeRemaining: (customerId: SystemId, slaType: CustomerSlaType) => number;\r\n  triggerReevaluation: () => void;\r\n};\r\n\r\ntype SlaStore = SlaStoreState & SlaStoreActions;\r\n\r\n// In-memory storage for last run time\r\nlet cachedLastRun: string | undefined = undefined;\r\n\r\nconst getPersistedIndex = (): CustomerSlaIndex | null => {\r\n  // Use sync utility which checks in-memory cache, then database\r\n  return getEvaluationSync();\r\n};\r\n\r\nconst getLastRun = () => {\r\n  return cachedLastRun;\r\n};\r\n\r\nconst persistedIndex = getPersistedIndex();\r\n\r\n// Store reference for re-evaluation\r\nlet lastCustomers: Customer[] = [];\r\nlet lastSettings: CustomerSlaSetting[] = [];\r\n\r\nexport const useCustomerSlaEngineStore = create<SlaStore>((set, get) => {\r\n  const initialState: SlaStoreState = {\r\n    index: persistedIndex,\r\n    summary: persistedIndex ? summarizeIndex(persistedIndex) : null,\r\n    isLoading: false,\r\n  };\r\n  const initialLastRun = getLastRun();\r\n  if (initialLastRun !== undefined) {\r\n    initialState.lastEvaluatedAt = initialLastRun;\r\n  }\r\n\r\n  return {\r\n    ...initialState,\r\n\r\n    evaluate(customers, settings) {\r\n      // Store for re-evaluation\r\n      lastCustomers = customers;\r\n      lastSettings = settings;\r\n      \r\n      set({ isLoading: true });\r\n      const nextIndex = buildSlaIndex(customers, settings);\r\n      const nextSummary = summarizeIndex(nextIndex);\r\n      const timestamp = new Date().toISOString();\r\n\r\n      // Update in-memory cache\r\n      cachedLastRun = timestamp;\r\n      \r\n      // Fire and forget - save to database in background\r\n      saveEvaluationAsync(nextIndex, timestamp).catch(error => {\r\n        console.warn('[customer-sla] Failed to save evaluation to database', error);\r\n      });\r\n\r\n      set({\r\n        index: nextIndex,\r\n        summary: nextSummary,\r\n        lastEvaluatedAt: timestamp,\r\n        isLoading: false,\r\n      });\r\n    },\r\n\r\n    triggerReevaluation() {\r\n      // Get fresh customer data from the customer store\r\n      const freshCustomers = useCustomerStore.getState().data;\r\n      if (freshCustomers.length && lastSettings.length) {\r\n        get().evaluate(freshCustomers, lastSettings);\r\n      }\r\n    },\r\n\r\n    acknowledge(customerId, alert, options = {}) {\r\n      const { actionType = 'acknowledged', snoozeDays, notes } = options;\r\n      const now = new Date();\r\n      const performedBy = getCurrentUserName() || 'Hệ thống';\r\n      \r\n      const ack: CustomerSlaAcknowledgement = {\r\n        slaType: alert.slaType,\r\n        targetDate: alert.targetDate,\r\n        acknowledgedAt: now.toISOString(),\r\n        actionType,\r\n        notes,\r\n      };\r\n      \r\n      if (snoozeDays && snoozeDays > 0) {\r\n        const snoozeEnd = new Date(now.getTime() + snoozeDays * 24 * 60 * 60 * 1000);\r\n        ack.snoozeUntil = snoozeEnd.toISOString();\r\n        ack.actionType = 'snoozed';\r\n      }\r\n      \r\n      setAcknowledgement(customerId, ack, performedBy);\r\n\r\n      const currentIndex = get().index;\r\n      if (!currentIndex) return;\r\n\r\n      // For follow-up SLA, we remove from index because the cycle will be reset\r\n      // (lastContactDate updated -> re-evaluation will create new alert with new targetDate)\r\n      // For other SLA types, we keep the alert visible with \"acknowledged\" badge\r\n      if (alert.slaType === 'follow-up') {\r\n        const nextEntries = { ...currentIndex.entries };\r\n        const entry = nextEntries[customerId];\r\n        if (entry) {\r\n          entry.alerts = entry.alerts.filter(a => !(a.slaType === alert.slaType && a.targetDate === alert.targetDate));\r\n        }\r\n\r\n        const nextIndex = {\r\n          ...currentIndex,\r\n          entries: nextEntries,\r\n          followUpAlerts: currentIndex.followUpAlerts.filter(a => !(a.systemId === customerId && a.slaType === alert.slaType && a.targetDate === alert.targetDate)),\r\n        };\r\n\r\n        const nextSummary = summarizeIndex(nextIndex);\r\n        set({ index: nextIndex, summary: nextSummary });\r\n      } else {\r\n        // For re-engagement, debt-payment - just trigger a re-render\r\n        // Alert stays visible with \"acknowledged\" badge\r\n        // Create new summary object to ensure reference change\r\n        const newSummary = { ...summarizeIndex(currentIndex), _lastAckAt: now.toISOString() };\r\n        set({ summary: newSummary });\r\n      }\r\n    },\r\n\r\n    snooze(customerId, alert, days, notes) {\r\n      get().acknowledge(customerId, alert, {\r\n        actionType: 'snoozed',\r\n        snoozeDays: days,\r\n        notes: notes || `Tạm ẩn ${days} ngày`,\r\n      });\r\n    },\r\n\r\n    getAck(customerId, slaType) {\r\n      return getAcknowledgement(customerId, slaType);\r\n    },\r\n\r\n    isSnoozed(customerId, slaType) {\r\n      return isAlertSnoozed(customerId, slaType);\r\n    },\r\n\r\n    getSnoozeRemaining(customerId, slaType) {\r\n      return getSnoozeRemaining(customerId, slaType);\r\n    },\r\n  };\r\n});\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 4673, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/customers/sla/constants.ts"],"sourcesContent":["export const SLA_EVALUATION_KEY = 'hrm-customer-sla-evals';\r\nexport const SLA_ACKNOWLEDGEMENTS_KEY = 'hrm-customer-sla-acks';\r\nexport const SLA_LAST_RUN_KEY = 'hrm-customer-sla-last-run';\r\n\r\nexport const SLA_TYPE_BADGES: Record<string, { label: string; color: string }> = {\r\n  'follow-up': {\r\n    label: 'Liên hệ định kỳ',\r\n    color: 'text-blue-600 bg-blue-50'\r\n  },\r\n  're-engagement': {\r\n    label: 'Kích hoạt lại',\r\n    color: 'text-orange-600 bg-orange-50'\r\n  },\r\n  'debt-payment': {\r\n    label: 'Nhắc công nợ',\r\n    color: 'text-rose-600 bg-rose-50'\r\n  }\r\n};\r\n"],"names":[],"mappings":";;;;;;;;;;AAAO,MAAM,qBAAqB;AAC3B,MAAM,2BAA2B;AACjC,MAAM,mBAAmB;AAEzB,MAAM,kBAAoE;IAC/E,aAAa;QACX,OAAO;QACP,OAAO;IACT;IACA,iBAAiB;QACf,OAAO;QACP,OAAO;IACT;IACA,gBAAgB;QACd,OAAO;QACP,OAAO;IACT;AACF"}},
    {"offset": {"line": 4704, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/customers/components/sla-status-card.tsx"],"sourcesContent":["import * as React from 'react';\r\nimport type { Customer } from '../types';\r\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from '../../../components/ui/card';\r\nimport { Badge } from '../../../components/ui/badge';\r\nimport { Button } from '../../../components/ui/button';\r\nimport { Bell, Check, Clock, MoreHorizontal, HelpCircle, AlertTriangle, AlertCircle, Info } from 'lucide-react';\r\nimport { format } from 'date-fns';\r\nimport { vi } from 'date-fns/locale';\r\nimport { useCustomerSlaEngineStore } from '../sla/store';\r\nimport { useCustomerStore } from '../store';\r\nimport { formatDaysRemaining } from '../../reports/customer-sla-report/sla-utils';\r\nimport { SLA_TYPE_BADGES } from '../sla/constants';\r\nimport type { CustomerSlaAlert } from '../sla/types';\r\nimport {\r\n  DropdownMenu,\r\n  DropdownMenuContent,\r\n  DropdownMenuItem,\r\n  DropdownMenuSeparator,\r\n  DropdownMenuTrigger,\r\n} from '../../../components/ui/dropdown-menu';\r\nimport { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from '../../../components/ui/tooltip';\r\nimport { Progress } from '../../../components/ui/progress';\r\nimport { toast } from 'sonner';\r\n\r\ntype Props = {\r\n  customer: Customer;\r\n};\r\n\r\nexport function CustomerSlaStatusCard({ customer }: Props) {\r\n  const entry = useCustomerSlaEngineStore((state) => state.index?.entries[customer.systemId]);\r\n  const acknowledge = useCustomerSlaEngineStore((state) => state.acknowledge);\r\n  const snooze = useCustomerSlaEngineStore((state) => state.snooze);\r\n  const getAck = useCustomerSlaEngineStore((state) => state.getAck);\r\n  const isSnoozed = useCustomerSlaEngineStore((state) => state.isSnoozed);\r\n  const getSnoozeRemaining = useCustomerSlaEngineStore((state) => state.getSnoozeRemaining);\r\n  const updateCustomer = useCustomerStore((state) => state.update);\r\n  const triggerReevaluation = useCustomerSlaEngineStore((state) => state.triggerReevaluation);\r\n\r\n  // Handle acknowledge: update SLA store AND customer's lastContactDate (only for follow-up SLA)\r\n  const handleAcknowledge = React.useCallback((alert: CustomerSlaAlert) => {\r\n    const now = new Date().toISOString();\r\n    \r\n    // 1. Update SLA acknowledgement\r\n    acknowledge(customer.systemId, alert, { actionType: 'acknowledged' });\r\n    \r\n    // 2. Only update customer's lastContactDate for follow-up SLA to reset that cycle\r\n    // For other SLA types (re-engagement, debt-payment), just acknowledge without resetting baseline\r\n    if (alert.slaType === 'follow-up') {\r\n      updateCustomer(customer.systemId, {\r\n        lastContactDate: now,\r\n      });\r\n      \r\n      toast.success('Đã xác nhận xử lý SLA', {\r\n        description: 'Ngày liên hệ cuối đã được cập nhật',\r\n      });\r\n      \r\n      // 3. Trigger re-evaluation after a short delay\r\n      setTimeout(() => triggerReevaluation(), 500);\r\n    } else {\r\n      toast.success('Đã xác nhận xử lý SLA', {\r\n        description: `SLA \"${alert.slaName}\" đã được đánh dấu xử lý`,\r\n      });\r\n    }\r\n  }, [customer.systemId, acknowledge, updateCustomer, triggerReevaluation]);\r\n\r\n  // Handle snooze\r\n  const handleSnooze = React.useCallback((alert: CustomerSlaAlert, days: number) => {\r\n    snooze(customer.systemId, alert, days);\r\n    toast.success(`Đã tạm ẩn ${days} ngày`, {\r\n      description: `SLA sẽ hiển thị lại sau ${days} ngày`,\r\n    });\r\n  }, [customer.systemId, snooze]);\r\n\r\n  if (!entry) {\r\n    return (\r\n      <Card>\r\n        <CardHeader>\r\n          <CardTitle>Trạng thái SLA</CardTitle>\r\n          <CardDescription>Không có cảnh báo nào</CardDescription>\r\n        </CardHeader>\r\n        <CardContent>\r\n          <p className=\"text-body-sm text-muted-foreground\">\r\n            Khách hàng này hiện không có SLA nào cần theo dõi.\r\n          </p>\r\n        </CardContent>\r\n      </Card>\r\n    );\r\n  }\r\n\r\n  const alerts = entry.alerts;\r\n  const debtAlert = entry.debtAlert;\r\n  const healthAlert = entry.healthAlert;\r\n\r\n  // Calculate summary stats\r\n  const totalAlerts = alerts.length + (debtAlert ? 1 : 0) + (healthAlert ? 1 : 0);\r\n  const overdueCount = alerts.filter(a => a.alertLevel === 'overdue').length;\r\n  const criticalCount = alerts.filter(a => a.alertLevel === 'critical').length;\r\n  const warningCount = alerts.filter(a => a.alertLevel === 'warning').length;\r\n  const acknowledgedCount = alerts.filter(a => {\r\n    const ack = getAck(customer.systemId, a.slaType);\r\n    return ack?.targetDate === a.targetDate;\r\n  }).length;\r\n  const snoozedCount = alerts.filter(a => isSnoozed(customer.systemId, a.slaType)).length;\r\n  const processedCount = acknowledgedCount + snoozedCount;\r\n  const progressPercent = totalAlerts > 0 ? Math.round((processedCount / totalAlerts) * 100) : 0;\r\n\r\n  if (!alerts.length && !debtAlert && !healthAlert) {\r\n    return (\r\n      <Card>\r\n        <CardHeader>\r\n          <CardTitle>Trạng thái SLA</CardTitle>\r\n          <CardDescription>Không có cảnh báo nào</CardDescription>\r\n        </CardHeader>\r\n        <CardContent>\r\n          <p className=\"text-body-sm text-muted-foreground\">\r\n            Khách hàng này hiện không có SLA nào cần theo dõi.\r\n          </p>\r\n        </CardContent>\r\n      </Card>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <Card>\r\n      <CardHeader>\r\n        <CardTitle>Trạng thái SLA</CardTitle>\r\n        <CardDescription>Danh sách cảnh báo cần xử lý</CardDescription>\r\n      </CardHeader>\r\n      <CardContent className=\"space-y-4\">\r\n        {/* Summary Bar */}\r\n        <div className=\"bg-muted/50 rounded-lg p-3 space-y-3\">\r\n          {/* Progress */}\r\n          <div className=\"space-y-1.5\">\r\n            <div className=\"flex justify-between text-body-sm\">\r\n              <span className=\"text-muted-foreground\">Tiến độ xử lý</span>\r\n              <span className=\"font-medium\">{processedCount}/{totalAlerts} ({progressPercent}%)</span>\r\n            </div>\r\n            <Progress value={progressPercent} className=\"h-2\" />\r\n          </div>\r\n          \r\n          {/* Alert counts by level */}\r\n          <div className=\"flex flex-wrap gap-2\">\r\n            {overdueCount > 0 && (\r\n              <TooltipProvider delayDuration={0}>\r\n                <Tooltip>\r\n                  <TooltipTrigger asChild>\r\n                    <Badge variant=\"destructive\" className=\"cursor-help\">\r\n                      <AlertTriangle className=\"h-3 w-3 mr-1\" />\r\n                      {overdueCount} quá hạn\r\n                    </Badge>\r\n                  </TooltipTrigger>\r\n                  <TooltipContent>\r\n                    <p>SLA đã quá hạn mục tiêu, cần xử lý ngay</p>\r\n                  </TooltipContent>\r\n                </Tooltip>\r\n              </TooltipProvider>\r\n            )}\r\n            {criticalCount > 0 && (\r\n              <TooltipProvider delayDuration={0}>\r\n                <Tooltip>\r\n                  <TooltipTrigger asChild>\r\n                    <Badge variant=\"warning\" className=\"cursor-help\">\r\n                      <AlertCircle className=\"h-3 w-3 mr-1\" />\r\n                      {criticalCount} nghiêm trọng\r\n                    </Badge>\r\n                  </TooltipTrigger>\r\n                  <TooltipContent>\r\n                    <p>SLA sắp đến hạn (còn 1-2 ngày), ưu tiên xử lý</p>\r\n                  </TooltipContent>\r\n                </Tooltip>\r\n              </TooltipProvider>\r\n            )}\r\n            {warningCount > 0 && (\r\n              <TooltipProvider delayDuration={0}>\r\n                <Tooltip>\r\n                  <TooltipTrigger asChild>\r\n                    <Badge variant=\"secondary\" className=\"cursor-help\">\r\n                      <Info className=\"h-3 w-3 mr-1\" />\r\n                      {warningCount} cảnh báo\r\n                    </Badge>\r\n                  </TooltipTrigger>\r\n                  <TooltipContent>\r\n                    <p>SLA cần theo dõi, còn vài ngày để xử lý</p>\r\n                  </TooltipContent>\r\n                </Tooltip>\r\n              </TooltipProvider>\r\n            )}\r\n            {acknowledgedCount > 0 && (\r\n              <Badge variant=\"outline\" className=\"text-green-600 border-green-200 bg-green-50\">\r\n                <Check className=\"h-3 w-3 mr-1\" />\r\n                {acknowledgedCount} đã xử lý\r\n              </Badge>\r\n            )}\r\n            {snoozedCount > 0 && (\r\n              <Badge variant=\"outline\" className=\"text-amber-600 border-amber-200 bg-amber-50\">\r\n                <Clock className=\"h-3 w-3 mr-1\" />\r\n                {snoozedCount} tạm ẩn\r\n              </Badge>\r\n            )}\r\n          </div>\r\n        </div>\r\n\r\n        {alerts.map(alert => {\r\n          const ack = getAck(customer.systemId, alert.slaType);\r\n          const isAcknowledged = ack?.targetDate === alert.targetDate;\r\n          const alertIsSnoozed = isSnoozed(customer.systemId, alert.slaType);\r\n          const snoozeRemaining = getSnoozeRemaining(customer.systemId, alert.slaType);\r\n          const badgeMeta = SLA_TYPE_BADGES[alert.slaType];\r\n          const colorClass = badgeMeta?.color || 'text-slate-600 bg-slate-100';\r\n          \r\n          return (\r\n            <div key={`${alert.slaType}-${alert.targetDate}`} className=\"border rounded-lg p-3 space-y-2\">\r\n              <div className=\"flex justify-between items-center\">\r\n                <div>\r\n                  <div className=\"flex items-center gap-2\">\r\n                    <Badge variant=\"outline\" className={colorClass}>{badgeMeta?.label || alert.slaName}</Badge>\r\n                    <span className=\"text-body-sm font-medium\">{formatDaysRemaining(alert.daysRemaining)}</span>\r\n                  </div>\r\n                  <p className=\"text-body-sm text-muted-foreground\">\r\n                    Ngày mục tiêu: {format(new Date(alert.targetDate), 'dd/MM/yyyy', { locale: vi })}\r\n                  </p>\r\n                </div>\r\n                <Badge variant={alert.alertLevel === 'overdue' ? 'destructive' : 'secondary'}>\r\n                  {alert.alertLevel === 'overdue' ? 'Quá hạn' : alert.alertLevel === 'critical' ? 'Nghiêm trọng' : alert.alertLevel === 'warning' ? 'Cảnh báo' : 'Bình thường'}\r\n                </Badge>\r\n              </div>\r\n              <div className=\"flex items-center justify-between text-body-sm text-muted-foreground\">\r\n                <span>Phụ trách: {alert.assignee || '—'}</span>\r\n                <span>Hoạt động cuối: {alert.lastActivityDate ? format(new Date(alert.lastActivityDate), 'dd/MM/yyyy', { locale: vi }) : '—'}</span>\r\n              </div>\r\n              <div className=\"flex justify-end gap-2\">\r\n                {alertIsSnoozed ? (\r\n                  <Badge variant=\"outline\" className=\"text-amber-600\">\r\n                    <Clock className=\"h-3 w-3 mr-1\" /> Tạm ẩn còn {snoozeRemaining} ngày\r\n                  </Badge>\r\n                ) : isAcknowledged ? (\r\n                  <Badge variant=\"outline\" className=\"text-green-600\">\r\n                    <Check className=\"h-3 w-3 mr-1\" /> Đã xác nhận {format(new Date(ack!.acknowledgedAt), 'dd/MM HH:mm', { locale: vi })}\r\n                  </Badge>\r\n                ) : (\r\n                  <div className=\"flex gap-2\">\r\n                    <TooltipProvider delayDuration={0}>\r\n                      <Tooltip>\r\n                        <TooltipTrigger asChild>\r\n                          <Button variant=\"outline\" size=\"sm\" onClick={() => handleAcknowledge(alert)}>\r\n                            <Check className=\"h-4 w-4 mr-1\" /> Đã xử lý\r\n                          </Button>\r\n                        </TooltipTrigger>\r\n                        <TooltipContent side=\"top\" className=\"max-w-xs\">\r\n                          {alert.slaType === 'follow-up' ? (\r\n                            <p>Xác nhận đã liên hệ khách hàng. Ngày liên hệ cuối sẽ được cập nhật và chu kỳ SLA được làm mới.</p>\r\n                          ) : alert.slaType === 're-engagement' ? (\r\n                            <p>Xác nhận đã tiếp cận lại khách hàng. Cảnh báo sẽ được đánh dấu đã xử lý.</p>\r\n                          ) : (\r\n                            <p>Xác nhận đã xử lý SLA này. Cảnh báo sẽ được đánh dấu hoàn thành.</p>\r\n                          )}\r\n                        </TooltipContent>\r\n                      </Tooltip>\r\n                    </TooltipProvider>\r\n                    <TooltipProvider delayDuration={0}>\r\n                      <Tooltip>\r\n                        <TooltipTrigger asChild>\r\n                          <DropdownMenu>\r\n                            <DropdownMenuTrigger asChild>\r\n                              <Button variant=\"ghost\" size=\"sm\" className=\"h-8 w-8 p-0\">\r\n                                <MoreHorizontal className=\"h-4 w-4\" />\r\n                              </Button>\r\n                            </DropdownMenuTrigger>\r\n                            <DropdownMenuContent align=\"end\">\r\n                              <DropdownMenuItem onClick={() => handleSnooze(alert, 1)}>\r\n                                <Clock className=\"h-4 w-4 mr-2\" /> Tạm ẩn 1 ngày\r\n                              </DropdownMenuItem>\r\n                              <DropdownMenuItem onClick={() => handleSnooze(alert, 3)}>\r\n                                <Clock className=\"h-4 w-4 mr-2\" /> Tạm ẩn 3 ngày\r\n                              </DropdownMenuItem>\r\n                              <DropdownMenuItem onClick={() => handleSnooze(alert, 7)}>\r\n                                <Clock className=\"h-4 w-4 mr-2\" /> Tạm ẩn 7 ngày\r\n                              </DropdownMenuItem>\r\n                              <DropdownMenuSeparator />\r\n                              <DropdownMenuItem onClick={() => handleSnooze(alert, 30)}>\r\n                                <Clock className=\"h-4 w-4 mr-2\" /> Tạm ẩn 30 ngày\r\n                              </DropdownMenuItem>\r\n                            </DropdownMenuContent>\r\n                          </DropdownMenu>\r\n                        </TooltipTrigger>\r\n                        <TooltipContent side=\"top\">\r\n                          <p>Tạm ẩn cảnh báo này trong một khoảng thời gian</p>\r\n                        </TooltipContent>\r\n                      </Tooltip>\r\n                    </TooltipProvider>\r\n                  </div>\r\n                )}\r\n              </div>\r\n            </div>\r\n          );\r\n        })}\r\n\r\n        {debtAlert && (\r\n            <div className=\"border rounded-lg p-3 space-y-2 bg-rose-50\">\r\n            <div className=\"flex items-center gap-2\">\r\n              <Badge variant=\"destructive\">Công nợ</Badge>\r\n              <span className=\"text-body-sm font-medium\">{debtAlert.debtStatus}</span>\r\n            </div>\r\n            <p className=\"text-body-sm text-rose-700\">\r\n              Nợ quá hạn: {new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND', maximumFractionDigits: 0 }).format(debtAlert.overdueAmount)}\r\n            </p>\r\n            {debtAlert.oldestDueDate && (\r\n              <p className=\"text-body-xs text-muted-foreground\">\r\n                Hạn sớm nhất: {format(new Date(debtAlert.oldestDueDate), 'dd/MM/yyyy', { locale: vi })}\r\n              </p>\r\n            )}\r\n          </div>\r\n        )}\r\n\r\n        {healthAlert && (\r\n          <div className=\"border rounded-lg p-3 space-y-2 bg-purple-50\">\r\n            <div className=\"flex items-center gap-2\">\r\n              <Badge className=\"bg-purple-600 hover:bg-purple-700\">Rủi ro churn</Badge>\r\n              <TooltipProvider delayDuration={0}>\r\n                <Tooltip>\r\n                  <TooltipTrigger asChild>\r\n                    <HelpCircle className=\"h-3.5 w-3.5 text-purple-600 cursor-help\" />\r\n                  </TooltipTrigger>\r\n                  <TooltipContent side=\"top\" className=\"max-w-sm p-4\">\r\n                    <div className=\"text-body-xs space-y-3\">\r\n                      <p className=\"font-semibold text-base\">Cách tính điểm sức khỏe (Health Score):</p>\r\n                      \r\n                      <div className=\"space-y-1\">\r\n                        <p className=\"font-medium\">1. Recency (Thời gian mua gần nhất) - Tối đa 30đ:</p>\r\n                        <ul className=\"list-disc list-inside pl-1 text-muted-foreground\">\r\n                          <li>Mua trong 7 ngày: +30đ</li>\r\n                          <li>Mua trong 30 ngày: +25đ</li>\r\n                          <li>...giảm dần...</li>\r\n                          <li>Trên 1 năm: +5đ</li>\r\n                        </ul>\r\n                      </div>\r\n\r\n                      <div className=\"space-y-1\">\r\n                        <p className=\"font-medium\">2. Frequency (Tần suất mua) - Tối đa 25đ:</p>\r\n                        <ul className=\"list-disc list-inside pl-1 text-muted-foreground\">\r\n                          <li>Trên 20 đơn: +25đ</li>\r\n                          <li>Trên 10 đơn: +20đ</li>\r\n                          <li>...giảm dần...</li>\r\n                        </ul>\r\n                      </div>\r\n\r\n                      <div className=\"space-y-1\">\r\n                        <p className=\"font-medium\">3. Monetary (Tổng chi tiêu) - Tối đa 30đ:</p>\r\n                        <ul className=\"list-disc list-inside pl-1 text-muted-foreground\">\r\n                          <li>Trên 500 triệu: +30đ</li>\r\n                          <li>Trên 200 triệu: +25đ</li>\r\n                          <li>...giảm dần...</li>\r\n                        </ul>\r\n                      </div>\r\n\r\n                      <div className=\"space-y-1\">\r\n                        <p className=\"font-medium\">4. Payment Behavior (Hành vi thanh toán) - Tối đa 15đ:</p>\r\n                        <p className=\"text-muted-foreground mb-1\">Dựa trên tỷ lệ nợ hiện tại / hạn mức tín dụng.</p>\r\n                        <ul className=\"list-disc list-inside pl-1 text-muted-foreground\">\r\n                          <li>Dùng &lt; 20% hạn mức: +15đ (Tốt)</li>\r\n                          <li>Dùng &gt; 80% hạn mức: 0đ (Rủi ro)</li>\r\n                          <li>Nếu không có hạn mức nợ: Mặc định +15đ</li>\r\n                        </ul>\r\n                      </div>\r\n                    </div>\r\n                  </TooltipContent>\r\n                </Tooltip>\r\n              </TooltipProvider>\r\n              <span className=\"text-body-sm font-medium\">{healthAlert.churnRisk === 'high' ? 'Rủi ro cao' : healthAlert.churnRisk === 'medium' ? 'Rủi ro trung bình' : 'Rủi ro thấp'}</span>\r\n            </div>\r\n            <p className=\"text-body-sm text-purple-700\">\r\n              Health score: {healthAlert.healthScore}/100 • Không mua: {healthAlert.daysSinceLastPurchase} ngày\r\n            </p>\r\n          </div>\r\n        )}\r\n      </CardContent>\r\n    </Card>\r\n  );\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 5963, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/customers/hooks/use-computed-debt.ts"],"sourcesContent":["/**\r\n * Hook to compute customer debt dynamically from orders and receipts/payments\r\n * ═══════════════════════════════════════════════════════════════\r\n * This replaces the static currentDebt field with real-time calculated debt\r\n * based on:\r\n * - Delivered orders (increases debt)\r\n * - Receipts with affectsDebt=true (decreases debt)\r\n * - Payments with affectsDebt=true (increases/decreases debt) - excluding sales return refunds\r\n * \r\n * NOTE: Sales returns and refund payments from sales returns do NOT affect debt.\r\n * They are cash transactions, not debt transactions.\r\n * \r\n * IMPORTANT: This uses the same logic as detail-page.tsx customerDebtTransactions\r\n * to ensure consistency across the app.\r\n * ═══════════════════════════════════════════════════════════════\r\n */\r\n\r\nimport { useMemo } from 'react';\r\nimport { useOrderStore } from '../../orders/store';\r\nimport { useReceiptStore } from '../../receipts/store';\r\nimport { usePaymentStore } from '../../payments/store';\r\nimport type { Customer, DebtTransaction } from '../types';\r\nimport type { Order } from '../../orders/types';\r\nimport type { Receipt } from '../../receipts/types';\r\nimport type { Payment } from '../../payments/types';\r\nimport type { SystemId, BusinessId } from '@/lib/id-types';\r\nimport { asSystemId } from '@/lib/id-types';\r\n\r\nexport type ComputedDebtInfo = {\r\n  currentDebt: number;\r\n  debtTransactions: DebtTransaction[];\r\n};\r\n\r\n/**\r\n * Compute debt transactions and current debt for a customer\r\n * Uses the same logic as detail-page.tsx for consistency\r\n */\r\nfunction computeCustomerDebtTransactions(\r\n  customer: Customer,\r\n  allOrders: Order[],\r\n  allReceipts: Receipt[],\r\n  allPayments: Payment[]\r\n): ComputedDebtInfo {\r\n  // Get orders that create debt for this customer\r\n  // Debt starts when: status='Hoàn thành' OR deliveryStatus='Đã giao hàng' OR stockOutStatus='Xuất kho toàn bộ'\r\n  const debtCreatingOrders = allOrders.filter(\r\n    o => o.customerSystemId === customer.systemId && \r\n         o.status !== 'Đã hủy' &&\r\n         (o.status === 'Hoàn thành' || \r\n          o.deliveryStatus === 'Đã giao hàng' || \r\n          o.stockOutStatus === 'Xuất kho toàn bộ')\r\n  );\r\n\r\n  // Build order transactions - use grandTotal (không trừ paidAmount)\r\n  // vì phiếu thu đã được tính riêng ở receiptTransactions\r\n  const orderTransactions = debtCreatingOrders\r\n    .map(order => {\r\n      // Calculate due date based on payment terms (default NET30)\r\n      const orderDate = new Date(order.orderDate);\r\n      const paymentTermDays = customer.paymentTerms === 'NET60' ? 60 : \r\n                               customer.paymentTerms === 'NET15' ? 15 : \r\n                               customer.paymentTerms === 'COD' ? 0 : 30;\r\n      const dueDate = new Date(orderDate);\r\n      dueDate.setDate(dueDate.getDate() + paymentTermDays);\r\n      \r\n      return {\r\n        systemId: asSystemId(`debt-order-${order.systemId}`),\r\n        orderId: order.id,\r\n        orderDate: order.orderDate,\r\n        amount: order.grandTotal || 0,\r\n        dueDate: dueDate.toISOString().split('T')[0],\r\n        isPaid: false,\r\n        remainingAmount: order.grandTotal || 0,\r\n        notes: `Đơn hàng #${order.id}`,\r\n        _createdAt: order.createdAt || order.orderDate,\r\n        _type: 'order' as const,\r\n        _change: order.grandTotal || 0,\r\n      };\r\n    });\r\n\r\n  // Get receipts affecting this customer's debt\r\n  const customerReceipts = allReceipts.filter(\r\n    r => r.status !== 'cancelled' && \r\n         r.affectsDebt === true && \r\n         (r.customerSystemId === customer.systemId || \r\n          r.payerSystemId === customer.systemId ||\r\n          (r.payerTypeName === 'Khách hàng' && r.payerName === customer.name))\r\n  );\r\n\r\n  const receiptTransactions = customerReceipts.map(receipt => ({\r\n    systemId: asSystemId(`debt-receipt-${receipt.systemId}`),\r\n    orderId: receipt.id,\r\n    orderDate: receipt.date,\r\n    amount: receipt.amount,\r\n    dueDate: receipt.date,\r\n    isPaid: true,\r\n    remainingAmount: 0,\r\n    notes: receipt.description || `Phiếu thu #${receipt.id}`,\r\n    _createdAt: receipt.createdAt || receipt.date,\r\n    _type: 'receipt' as const,\r\n    _change: -receipt.amount, // Receipts reduce debt\r\n  }));\r\n\r\n  // ✅ Phiếu chi - CHỈ TÍNH các phiếu chi KHÔNG phải hoàn tiền từ trả hàng\r\n  // Phiếu chi hoàn tiền từ trả hàng là giao dịch tiền mặt, không ảnh hưởng công nợ\r\n  // Phiếu trả hàng cũng KHÔNG ảnh hưởng công nợ\r\n  const customerPayments = allPayments.filter(\r\n    p => p.status !== 'cancelled' && \r\n         p.affectsDebt === true && \r\n         !p.linkedSalesReturnSystemId && // Loại bỏ phiếu chi từ trả hàng\r\n         (p.customerSystemId === customer.systemId || \r\n          p.recipientSystemId === customer.systemId ||\r\n          (p.recipientTypeName === 'Khách hàng' && p.recipientName === customer.name))\r\n  );\r\n\r\n  const paymentTransactions = customerPayments.map(payment => {\r\n    // Phiếu chi cho khách (không phải trả hàng) → giảm công nợ\r\n    const isRefundToCustomer = payment.paymentReceiptTypeName === 'Hoàn tiền khách hàng' || \r\n                               payment.category === 'complaint_refund';\r\n    const changeAmount = isRefundToCustomer ? -payment.amount : payment.amount;\r\n    \r\n    return {\r\n      systemId: asSystemId(`debt-payment-${payment.systemId}`),\r\n      orderId: payment.id,\r\n      orderDate: payment.date,\r\n      amount: payment.amount,\r\n      dueDate: payment.date,\r\n      isPaid: false,\r\n      remainingAmount: payment.amount,\r\n      notes: payment.description || `Phiếu chi #${payment.id}`,\r\n      _createdAt: payment.createdAt || payment.date,\r\n      _type: 'payment' as const,\r\n      _change: changeAmount,\r\n    };\r\n  });\r\n\r\n  // ✅ Công nợ = Đơn hàng - Phiếu thu - Phiếu chi (không phải trả hàng)\r\n  // Phiếu trả hàng và phiếu chi hoàn tiền từ trả hàng KHÔNG ảnh hưởng công nợ\r\n  const allTransactions = [...orderTransactions, ...receiptTransactions, ...paymentTransactions];\r\n  allTransactions.sort((a, b) => new Date(a._createdAt).getTime() - new Date(b._createdAt).getTime());\r\n\r\n  // Calculate running balance\r\n  let runningDebt = 0;\r\n  const transactionsWithBalance = allTransactions.map(t => {\r\n    runningDebt += t._change;\r\n    return t;\r\n  });\r\n\r\n  // Get current debt (final balance)\r\n  const currentDebt = Math.max(0, runningDebt);\r\n\r\n  // Convert to DebtTransaction format (only unpaid order transactions)\r\n  const debtTransactions: DebtTransaction[] = orderTransactions.map(t => ({\r\n    systemId: t.systemId,\r\n    orderId: t.orderId,\r\n    orderDate: t.orderDate,\r\n    amount: t.amount,\r\n    dueDate: t.dueDate,\r\n    isPaid: currentDebt === 0, // Mark as paid if no outstanding debt\r\n    remainingAmount: currentDebt === 0 ? 0 : t.remainingAmount,\r\n    notes: t.notes,\r\n  }));\r\n\r\n  return {\r\n    currentDebt,\r\n    debtTransactions,\r\n  };\r\n}\r\n\r\n/**\r\n * Hook to get computed debt for a single customer\r\n */\r\nexport function useComputedCustomerDebt(customer: Customer | null | undefined): ComputedDebtInfo | null {\r\n  const { data: allOrders } = useOrderStore();\r\n  const { data: allReceipts } = useReceiptStore();\r\n  const { data: allPayments } = usePaymentStore();\r\n\r\n  return useMemo(() => {\r\n    if (!customer) return null;\r\n    return computeCustomerDebtTransactions(customer, allOrders, allReceipts, allPayments);\r\n  }, [customer, allOrders, allReceipts, allPayments]);\r\n}\r\n\r\n/**\r\n * Hook to get computed debt for all customers as a map\r\n * Returns a Map of customerSystemId -> ComputedDebtInfo\r\n */\r\nexport function useAllCustomersComputedDebt(customers: Customer[]): Map<SystemId, ComputedDebtInfo> {\r\n  const { data: allOrders } = useOrderStore();\r\n  const { data: allReceipts } = useReceiptStore();\r\n  const { data: allPayments } = usePaymentStore();\r\n\r\n  return useMemo(() => {\r\n    const debtMap = new Map<SystemId, ComputedDebtInfo>();\r\n    \r\n    for (const customer of customers) {\r\n      const debtInfo = computeCustomerDebtTransactions(customer, allOrders, allReceipts, allPayments);\r\n      debtMap.set(customer.systemId, debtInfo);\r\n    }\r\n    \r\n    return debtMap;\r\n  }, [customers, allOrders, allReceipts, allPayments]);\r\n}\r\n\r\n/**\r\n * Hook to get customers with computed debt appended\r\n * Returns customers array with currentDebt AND debtTransactions replaced by computed values\r\n */\r\nexport function useCustomersWithComputedDebt(customers: Customer[]): Customer[] {\r\n  const { data: allOrders } = useOrderStore();\r\n  const { data: allReceipts } = useReceiptStore();\r\n  const { data: allPayments } = usePaymentStore();\r\n\r\n  return useMemo(() => {\r\n    return customers.map(customer => {\r\n      const debtInfo = computeCustomerDebtTransactions(customer, allOrders, allReceipts, allPayments);\r\n      return {\r\n        ...customer,\r\n        currentDebt: debtInfo.currentDebt, // Override static currentDebt\r\n        debtTransactions: debtInfo.debtTransactions, // Override static debtTransactions\r\n      };\r\n    });\r\n  }, [customers, allOrders, allReceipts, allPayments]);\r\n}\r\n"],"names":[],"mappings":";;;;;;;;AAAA;;;;;;;;;;;;;;;CAeC,GAED;AACA;AACA;AACA;AAMA;;;;;;AAOA;;;CAGC,GACD,SAAS,gCACP,QAAkB,EAClB,SAAkB,EAClB,WAAsB,EACtB,WAAsB;IAEtB,gDAAgD;IAChD,8GAA8G;IAC9G,MAAM,qBAAqB,UAAU,MAAM,CACzC,CAAA,IAAK,EAAE,gBAAgB,KAAK,SAAS,QAAQ,IACxC,EAAE,MAAM,KAAK,YACb,CAAC,EAAE,MAAM,KAAK,gBACb,EAAE,cAAc,KAAK,kBACrB,EAAE,cAAc,KAAK,kBAAkB;IAG/C,mEAAmE;IACnE,wDAAwD;IACxD,MAAM,oBAAoB,mBACvB,GAAG,CAAC,CAAA;QACH,4DAA4D;QAC5D,MAAM,YAAY,IAAI,KAAK,MAAM,SAAS;QAC1C,MAAM,kBAAkB,SAAS,YAAY,KAAK,UAAU,KACnC,SAAS,YAAY,KAAK,UAAU,KACpC,SAAS,YAAY,KAAK,QAAQ,IAAI;QAC/D,MAAM,UAAU,IAAI,KAAK;QACzB,QAAQ,OAAO,CAAC,QAAQ,OAAO,KAAK;QAEpC,OAAO;YACL,UAAU,IAAA,gIAAU,EAAC,CAAC,WAAW,EAAE,MAAM,QAAQ,EAAE;YACnD,SAAS,MAAM,EAAE;YACjB,WAAW,MAAM,SAAS;YAC1B,QAAQ,MAAM,UAAU,IAAI;YAC5B,SAAS,QAAQ,WAAW,GAAG,KAAK,CAAC,IAAI,CAAC,EAAE;YAC5C,QAAQ;YACR,iBAAiB,MAAM,UAAU,IAAI;YACrC,OAAO,CAAC,UAAU,EAAE,MAAM,EAAE,EAAE;YAC9B,YAAY,MAAM,SAAS,IAAI,MAAM,SAAS;YAC9C,OAAO;YACP,SAAS,MAAM,UAAU,IAAI;QAC/B;IACF;IAEF,8CAA8C;IAC9C,MAAM,mBAAmB,YAAY,MAAM,CACzC,CAAA,IAAK,EAAE,MAAM,KAAK,eACb,EAAE,WAAW,KAAK,QAClB,CAAC,EAAE,gBAAgB,KAAK,SAAS,QAAQ,IACxC,EAAE,aAAa,KAAK,SAAS,QAAQ,IACpC,EAAE,aAAa,KAAK,gBAAgB,EAAE,SAAS,KAAK,SAAS,IAAI,AAAC;IAG3E,MAAM,sBAAsB,iBAAiB,GAAG,CAAC,CAAA,UAAW,CAAC;YAC3D,UAAU,IAAA,gIAAU,EAAC,CAAC,aAAa,EAAE,QAAQ,QAAQ,EAAE;YACvD,SAAS,QAAQ,EAAE;YACnB,WAAW,QAAQ,IAAI;YACvB,QAAQ,QAAQ,MAAM;YACtB,SAAS,QAAQ,IAAI;YACrB,QAAQ;YACR,iBAAiB;YACjB,OAAO,QAAQ,WAAW,IAAI,CAAC,WAAW,EAAE,QAAQ,EAAE,EAAE;YACxD,YAAY,QAAQ,SAAS,IAAI,QAAQ,IAAI;YAC7C,OAAO;YACP,SAAS,CAAC,QAAQ,MAAM;QAC1B,CAAC;IAED,wEAAwE;IACxE,iFAAiF;IACjF,8CAA8C;IAC9C,MAAM,mBAAmB,YAAY,MAAM,CACzC,CAAA,IAAK,EAAE,MAAM,KAAK,eACb,EAAE,WAAW,KAAK,QAClB,CAAC,EAAE,yBAAyB,IAAI,gCAAgC;QAChE,CAAC,EAAE,gBAAgB,KAAK,SAAS,QAAQ,IACxC,EAAE,iBAAiB,KAAK,SAAS,QAAQ,IACxC,EAAE,iBAAiB,KAAK,gBAAgB,EAAE,aAAa,KAAK,SAAS,IAAI,AAAC;IAGnF,MAAM,sBAAsB,iBAAiB,GAAG,CAAC,CAAA;QAC/C,2DAA2D;QAC3D,MAAM,qBAAqB,QAAQ,sBAAsB,KAAK,0BACnC,QAAQ,QAAQ,KAAK;QAChD,MAAM,eAAe,qBAAqB,CAAC,QAAQ,MAAM,GAAG,QAAQ,MAAM;QAE1E,OAAO;YACL,UAAU,IAAA,gIAAU,EAAC,CAAC,aAAa,EAAE,QAAQ,QAAQ,EAAE;YACvD,SAAS,QAAQ,EAAE;YACnB,WAAW,QAAQ,IAAI;YACvB,QAAQ,QAAQ,MAAM;YACtB,SAAS,QAAQ,IAAI;YACrB,QAAQ;YACR,iBAAiB,QAAQ,MAAM;YAC/B,OAAO,QAAQ,WAAW,IAAI,CAAC,WAAW,EAAE,QAAQ,EAAE,EAAE;YACxD,YAAY,QAAQ,SAAS,IAAI,QAAQ,IAAI;YAC7C,OAAO;YACP,SAAS;QACX;IACF;IAEA,qEAAqE;IACrE,4EAA4E;IAC5E,MAAM,kBAAkB;WAAI;WAAsB;WAAwB;KAAoB;IAC9F,gBAAgB,IAAI,CAAC,CAAC,GAAG,IAAM,IAAI,KAAK,EAAE,UAAU,EAAE,OAAO,KAAK,IAAI,KAAK,EAAE,UAAU,EAAE,OAAO;IAEhG,4BAA4B;IAC5B,IAAI,cAAc;IAClB,MAAM,0BAA0B,gBAAgB,GAAG,CAAC,CAAA;QAClD,eAAe,EAAE,OAAO;QACxB,OAAO;IACT;IAEA,mCAAmC;IACnC,MAAM,cAAc,KAAK,GAAG,CAAC,GAAG;IAEhC,qEAAqE;IACrE,MAAM,mBAAsC,kBAAkB,GAAG,CAAC,CAAA,IAAK,CAAC;YACtE,UAAU,EAAE,QAAQ;YACpB,SAAS,EAAE,OAAO;YAClB,WAAW,EAAE,SAAS;YACtB,QAAQ,EAAE,MAAM;YAChB,SAAS,EAAE,OAAO;YAClB,QAAQ,gBAAgB;YACxB,iBAAiB,gBAAgB,IAAI,IAAI,EAAE,eAAe;YAC1D,OAAO,EAAE,KAAK;QAChB,CAAC;IAED,OAAO;QACL;QACA;IACF;AACF;AAKO,SAAS,wBAAwB,QAAqC;IAC3E,MAAM,EAAE,MAAM,SAAS,EAAE,GAAG,IAAA,4IAAa;IACzC,MAAM,EAAE,MAAM,WAAW,EAAE,GAAG,IAAA,gJAAe;IAC7C,MAAM,EAAE,MAAM,WAAW,EAAE,GAAG,IAAA,gJAAe;IAE7C,OAAO,IAAA,gNAAO,EAAC;QACb,IAAI,CAAC,UAAU,OAAO;QACtB,OAAO,gCAAgC,UAAU,WAAW,aAAa;IAC3E,GAAG;QAAC;QAAU;QAAW;QAAa;KAAY;AACpD;AAMO,SAAS,4BAA4B,SAAqB;IAC/D,MAAM,EAAE,MAAM,SAAS,EAAE,GAAG,IAAA,4IAAa;IACzC,MAAM,EAAE,MAAM,WAAW,EAAE,GAAG,IAAA,gJAAe;IAC7C,MAAM,EAAE,MAAM,WAAW,EAAE,GAAG,IAAA,gJAAe;IAE7C,OAAO,IAAA,gNAAO,EAAC;QACb,MAAM,UAAU,IAAI;QAEpB,KAAK,MAAM,YAAY,UAAW;YAChC,MAAM,WAAW,gCAAgC,UAAU,WAAW,aAAa;YACnF,QAAQ,GAAG,CAAC,SAAS,QAAQ,EAAE;QACjC;QAEA,OAAO;IACT,GAAG;QAAC;QAAW;QAAW;QAAa;KAAY;AACrD;AAMO,SAAS,6BAA6B,SAAqB;IAChE,MAAM,EAAE,MAAM,SAAS,EAAE,GAAG,IAAA,4IAAa;IACzC,MAAM,EAAE,MAAM,WAAW,EAAE,GAAG,IAAA,gJAAe;IAC7C,MAAM,EAAE,MAAM,WAAW,EAAE,GAAG,IAAA,gJAAe;IAE7C,OAAO,IAAA,gNAAO,EAAC;QACb,OAAO,UAAU,GAAG,CAAC,CAAA;YACnB,MAAM,WAAW,gCAAgC,UAAU,WAAW,aAAa;YACnF,OAAO;gBACL,GAAG,QAAQ;gBACX,aAAa,SAAS,WAAW;gBACjC,kBAAkB,SAAS,gBAAgB;YAC7C;QACF;IACF,GAAG;QAAC;QAAW;QAAW;QAAa;KAAY;AACrD"}},
    {"offset": {"line": 6151, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/customers/sla/hooks.ts"],"sourcesContent":["import * as React from 'react';\r\nimport { useCustomerStore } from '../store';\r\nimport { useCustomerSlaEngineStore } from './store';\r\nimport { useCustomerSlaStore as useCustomerSlaSettingStore } from '../../settings/customers/sla-settings-store';\r\nimport { useCustomersWithComputedDebt } from '../hooks/use-computed-debt';\r\n\r\nexport function useCustomerSlaEvaluation() {\r\n  const customers = useCustomerStore((state) => state.data);\r\n  const slaSettings = useCustomerSlaSettingStore((state) => state.data);\r\n  const evaluate = useCustomerSlaEngineStore((state) => state.evaluate);\r\n  const storeState = useCustomerSlaEngineStore();\r\n\r\n  // Use computed debt from orders/receipts instead of static currentDebt field\r\n  const customersWithDebt = useCustomersWithComputedDebt(customers);\r\n\r\n  React.useEffect(() => {\r\n    if (!customersWithDebt.length || !slaSettings.length) return;\r\n    evaluate(customersWithDebt, slaSettings);\r\n  }, [customersWithDebt, slaSettings, evaluate]);\r\n\r\n  return storeState;\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;AACA;AACA;;;;;;AAEO,SAAS;IACd,MAAM,YAAY,IAAA,kJAAgB,EAAC,CAAC,QAAU,MAAM,IAAI;IACxD,MAAM,cAAc,IAAA,oLAA0B,EAAC,CAAC,QAAU,MAAM,IAAI;IACpE,MAAM,WAAW,IAAA,kKAAyB,EAAC,CAAC,QAAU,MAAM,QAAQ;IACpE,MAAM,aAAa,IAAA,kKAAyB;IAE5C,6EAA6E;IAC7E,MAAM,oBAAoB,IAAA,yLAA4B,EAAC;IAEvD,kNAAe,CAAC;QACd,IAAI,CAAC,kBAAkB,MAAM,IAAI,CAAC,YAAY,MAAM,EAAE;QACtD,SAAS,mBAAmB;IAC9B,GAAG;QAAC;QAAmB;QAAa;KAAS;IAE7C,OAAO;AACT"}},
    {"offset": {"line": 6186, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/customers/detail-page.tsx"],"sourcesContent":["'use client'\r\n\r\nimport * as React from 'react';\r\nimport { useParams, useRouter } from 'next/navigation';\r\nimport Link from 'next/link';\r\nimport { formatDate as formatDateUtil, formatDateTime, formatDateTimeSeconds, formatDateCustom, getCurrentDate, getDaysDiff, parseDate } from '@/lib/date-utils';\r\nimport { asSystemId, type SystemId } from '@/lib/id-types';\r\nimport { sanitizeToText } from '@/lib/sanitize';\r\nimport { \r\n  calculateHealthScore, \r\n  calculateChurnRisk, \r\n  calculateRFMScores, \r\n  getCustomerSegment,\r\n  getSegmentLabel,\r\n  getSegmentBadgeVariant,\r\n  getHealthScoreLevel\r\n} from './intelligence-utils';\r\nimport { calculateLifecycleStage, getLifecycleStageVariant } from './lifecycle-utils';\r\nimport { useCustomerStore } from './store';\r\nimport type { Customer, CustomerAddress } from './types';\r\nimport { useOrderStore } from '../orders/store';\r\nimport { useWarrantyStore } from '../warranty/store';\r\nimport { useComplaintStore } from '../complaints/store';\r\nimport { useReceiptStore } from '../receipts/store';\r\nimport { usePaymentStore } from '../payments/store';\r\nimport { useEmployeeStore } from '../employees/store';\r\nimport { useCustomerTypeStore } from '../settings/customers/customer-types-store';\r\nimport { useCustomerGroupStore } from '../settings/customers/customer-groups-store';\r\nimport { useCustomerSourceStore } from '../settings/customers/customer-sources-store';\r\nimport { usePaymentTermStore } from '../settings/customers/payment-terms-store';\r\nimport { useCreditRatingStore } from '../settings/customers/credit-ratings-store';\r\nimport { usePageHeader } from '../../contexts/page-header-context';\r\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from '../../components/ui/card';\r\nimport { Button } from '../../components/ui/button';\r\nimport { Switch } from '../../components/ui/switch';\r\nimport { toast } from 'sonner';\r\nimport {\r\n  AlertDialog,\r\n  AlertDialogAction,\r\n  AlertDialogCancel,\r\n  AlertDialogContent,\r\n  AlertDialogDescription,\r\n  AlertDialogFooter,\r\n  AlertDialogHeader,\r\n  AlertDialogTitle,\r\n  AlertDialogTrigger,\r\n} from '../../components/ui/alert-dialog';\r\nimport {\r\n  DropdownMenu,\r\n  DropdownMenuContent,\r\n  DropdownMenuItem,\r\n  DropdownMenuSeparator,\r\n  DropdownMenuTrigger,\r\n} from '../../components/ui/dropdown-menu';\r\nimport { ArrowLeft, Edit, Phone, Mail, ExternalLink, Trash2, AlertTriangle, Clock, CreditCard, TrendingDown, Plus, Eye, MoreHorizontal, Printer, FileSpreadsheet, FileText, HelpCircle, Copy, Link as LinkIcon } from 'lucide-react';\r\nimport { Badge } from '../../components/ui/badge';\r\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from '../../components/ui/tabs';\r\nimport { ProgressiveImage } from '../../components/ui/progressive-image';\r\nimport { RelatedDataTable } from '../../components/data-table/related-data-table';\r\nimport { CustomerAddresses } from './customer-addresses';\r\nimport { CopyableText } from '../../components/shared/copy-button';\r\nimport { useProductStore } from '../products/store';\r\nimport { useSalesReturnStore } from '../sales-returns/store';\r\nimport { calculateWarrantyExpiry, calculateDaysRemaining, getWarrantyStatusBadge } from '../warranty/utils/warranty-checker';\r\nimport type { ColumnDef } from '../../components/data-table/types';\r\nimport type { Order, OrderMainStatus } from '../orders/types';\r\nimport type { WarrantyTicket } from '../warranty/types';\r\nimport type { Complaint } from '../complaints/types';\r\nimport { CustomerSlaStatusCard } from './components/sla-status-card';\r\nimport { useCustomerSlaEvaluation } from './sla/hooks';\r\nimport { useCustomerSlaEngineStore } from './sla/store';\r\nimport { getActivityLogs, SLA_LOG_UPDATED_EVENT } from './sla/ack-storage';\r\nimport { WARRANTY_STATUS_LABELS, WARRANTY_STATUS_COLORS } from '../warranty/types';\r\nimport { complaintStatusLabels, complaintStatusColors, complaintTypeLabels } from '../complaints/types';\r\nimport { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from '../../components/ui/tooltip';\r\nimport { DatabaseComments } from '../../components/DatabaseComments';\r\nimport { ActivityHistory, type HistoryEntry } from '../../components/ActivityHistory';\r\nimport { useAuth } from '../../contexts/auth-context';\r\n\r\nconst normalizeCurrencyValue = (value?: number) => {\r\n  if (typeof value !== 'number' || Number.isNaN(value)) return 0;\r\n  return Math.abs(value) < 0.005 ? 0 : value;\r\n};\r\n\r\nconst formatCurrency = (value?: number) => {\r\n  const normalized = normalizeCurrencyValue(value);\r\n  return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(normalized);\r\n};\r\n\r\nconst formatAddress = (street?: string, ward?: string, province?: string) => {\r\n    const address = [street, ward, province].filter(Boolean).join(', ');\r\n    return address || '-';\r\n};\r\n\r\n// Simple detail item component - no icons for cleaner look\r\nconst DetailItem = ({ label, value, onClick, className = '' }: { \r\n  label: string; \r\n  value?: React.ReactNode; \r\n  onClick?: (() => void) | undefined;\r\n  className?: string;\r\n}) => (\r\n  <div className={`space-y-1 ${className}`}>\r\n    <dt className=\"text-body-sm text-muted-foreground\">{label}</dt>\r\n    <dd \r\n      className={`text-body-sm font-medium ${onClick ? 'text-primary hover:underline cursor-pointer' : ''}`}\r\n      onClick={onClick}\r\n    >\r\n      {value !== null && value !== undefined && value !== '' ? value : '—'}\r\n    </dd>\r\n  </div>\r\n);\r\n\r\n// Stats summary item\r\nconst StatItem = ({ label, value, subtext }: { label: string; value: string; subtext?: string }) => (\r\n  <div className=\"text-center p-4 rounded-lg bg-muted/50\">\r\n    <div className=\"text-h3 font-bold\">{value}</div>\r\n    <div className=\"text-body-sm text-muted-foreground\">{label}</div>\r\n    {subtext && <div className=\"text-body-xs text-muted-foreground mt-1\">{subtext}</div>}\r\n  </div>\r\n);\r\n\r\ntype DrilldownSearch = {\r\n  query: string;\r\n  token: string;\r\n};\r\n\r\nconst orderStatusVariants: Record<OrderMainStatus, \"success\" | \"default\" | \"secondary\" | \"warning\" | \"destructive\"> = {\r\n    \"Đặt hàng\": \"secondary\",\r\n    \"Đang giao dịch\": \"warning\",\r\n    \"Hoàn thành\": \"success\",\r\n    \"Đã hủy\": \"destructive\",\r\n};\r\n\r\n// REMOVED: Complaint status variants\r\n// const complaintStatusVariants: Record<ComplaintStatus, \"default\" | \"secondary\" | \"warning\" | \"success\"> = {\r\n//     \"Mới\": \"secondary\", \"Đang xử lý\": \"warning\", \"Đã giải quyết\": \"success\", \"Đã đóng\": \"default\",\r\n// };\r\n\r\n// Column Definitions\r\nconst orderColumns: ColumnDef<Order>[] = [\r\n    { id: 'id', accessorKey: 'id', header: 'Mã ĐH', cell: ({ row }) => <span className=\"font-medium\">{row.id}</span>, meta: { displayName: 'Mã ĐH'} },\r\n    { id: 'orderDate', accessorKey: 'orderDate', header: 'Ngày đặt', cell: ({ row }) => formatDateUtil(row.orderDate), meta: { displayName: 'Ngày đặt'} },\r\n    { id: 'status', accessorKey: 'status', header: 'Trạng thái', cell: ({ row }) => {\r\n        let displayStatus = row.status;\r\n        if (row.status === 'Đặt hàng' && (row.stockOutStatus === 'Xuất kho toàn bộ' || row.deliveryStatus === 'Đang giao hàng' || row.deliveryStatus === 'Đã giao hàng')) {\r\n            displayStatus = 'Đang giao dịch';\r\n        }\r\n        return <Badge variant={orderStatusVariants[displayStatus] || orderStatusVariants[row.status]}>{displayStatus}</Badge>;\r\n    }, meta: { displayName: 'Trạng thái'} },\r\n    { id: 'grandTotal', accessorKey: 'grandTotal', header: 'Tổng tiền', cell: ({ row }) => formatCurrency(row.grandTotal), meta: { displayName: 'Tổng tiền'} },\r\n    { id: 'actions', header: 'Hành động', cell: ({ row }) => (\r\n        <DropdownMenu>\r\n            <DropdownMenuTrigger asChild>\r\n                <Button variant=\"ghost\" size=\"icon\" className=\"h-8 w-8\">\r\n                    <MoreHorizontal className=\"h-4 w-4\" />\r\n                    <span className=\"sr-only\">Mở menu</span>\r\n                </Button>\r\n            </DropdownMenuTrigger>\r\n            <DropdownMenuContent align=\"end\">\r\n                <DropdownMenuItem asChild>\r\n                    <Link href={`/orders/${row.systemId}`}>\r\n                        <Eye className=\"mr-2 h-4 w-4\" />\r\n                        Xem chi tiết\r\n                    </Link>\r\n                </DropdownMenuItem>\r\n                <DropdownMenuSeparator />\r\n                <DropdownMenuItem onClick={() => window.print()}>\r\n                    <Printer className=\"mr-2 h-4 w-4\" />\r\n                    In\r\n                </DropdownMenuItem>\r\n                <DropdownMenuItem onClick={() => toast.info('Chức năng xuất PDF đang phát triển')}>\r\n                    <FileText className=\"mr-2 h-4 w-4\" />\r\n                    Xuất PDF\r\n                </DropdownMenuItem>\r\n                <DropdownMenuItem onClick={() => toast.info('Chức năng xuất Excel đang phát triển')}>\r\n                    <FileSpreadsheet className=\"mr-2 h-4 w-4\" />\r\n                    Xuất Excel\r\n                </DropdownMenuItem>\r\n            </DropdownMenuContent>\r\n        </DropdownMenu>\r\n    ), meta: { displayName: 'Hành động', excludeFromExport: true } },\r\n];\r\n\r\n// Extended order type with return info\r\ntype OrderWithReturns = Order & {\r\n    returnCount?: number;\r\n    totalReturnValue?: number;\r\n    returnIds?: string[];\r\n};\r\n\r\nconst productColumns: ColumnDef<{ systemId: string, name: string; quantity: number; orderId: string; orderDate: string; orderSystemId: string; productSystemId: string; warrantyMonths: number; warrantyExpiry: string; daysRemaining: number }>[] = [\r\n    { id: 'orderId', accessorKey: 'orderId', header: 'Mã ĐH', cell: ({ row }) => <Link href={`/orders/${row.orderSystemId}`} className=\"font-medium text-primary hover:underline\">{row.orderId}</Link>, meta: { displayName: 'Mã ĐH'} },\r\n    { id: 'orderDate', accessorKey: 'orderDate', header: 'Ngày mua', cell: ({ row }) => formatDateUtil(row.orderDate), meta: { displayName: 'Ngày mua'} },\r\n    { id: 'name', accessorKey: 'name', header: 'Tên sản phẩm', cell: ({ row }) => <Link href={`/products/${row.productSystemId}`} className=\"font-medium text-primary hover:underline\">{row.name}</Link>, meta: { displayName: 'Tên sản phẩm'} },\r\n    { id: 'quantity', accessorKey: 'quantity', header: 'SL', cell: ({ row }) => row.quantity, meta: { displayName: 'Số lượng'} },\r\n    { id: 'warrantyMonths', accessorKey: 'warrantyMonths', header: 'Bảo hành', cell: ({ row }) => row.warrantyMonths ? `${row.warrantyMonths} tháng` : '—', meta: { displayName: 'Bảo hành'} },\r\n    { id: 'warrantyExpiry', accessorKey: 'warrantyExpiry', header: 'Hết hạn BH', cell: ({ row }) => row.warrantyExpiry ? formatDateUtil(row.warrantyExpiry) : '—', meta: { displayName: 'Hết hạn BH'} },\r\n    { id: 'daysRemaining', accessorKey: 'daysRemaining', header: 'Thời gian còn lại', cell: ({ row }) => {\r\n        if (!row.warrantyMonths) return '—';\r\n        const badge = getWarrantyStatusBadge(row.daysRemaining);\r\n        return <Badge variant={badge.variant}>{badge.label}</Badge>;\r\n    }, meta: { displayName: 'Thời gian còn lại'} },\r\n    { id: 'actions', header: 'Hành động', cell: ({ row }) => (\r\n        <DropdownMenu>\r\n            <DropdownMenuTrigger asChild>\r\n                <Button variant=\"ghost\" size=\"icon\" className=\"h-8 w-8\">\r\n                    <MoreHorizontal className=\"h-4 w-4\" />\r\n                    <span className=\"sr-only\">Mở menu</span>\r\n                </Button>\r\n            </DropdownMenuTrigger>\r\n            <DropdownMenuContent align=\"end\">\r\n                <DropdownMenuItem asChild>\r\n                    <Link href={`/products/${row.productSystemId}`}>\r\n                        <Eye className=\"mr-2 h-4 w-4\" />\r\n                        Xem sản phẩm\r\n                    </Link>\r\n                </DropdownMenuItem>\r\n                <DropdownMenuItem asChild>\r\n                    <Link href={`/orders/${row.orderSystemId}`}>\r\n                        <ExternalLink className=\"mr-2 h-4 w-4\" />\r\n                        Xem đơn hàng\r\n                    </Link>\r\n                </DropdownMenuItem>\r\n            </DropdownMenuContent>\r\n        </DropdownMenu>\r\n    ), meta: { displayName: 'Hành động', excludeFromExport: true } },\r\n];\r\n\r\nconst warrantyColumns: ColumnDef<WarrantyTicket>[] = [\r\n  {\r\n    id: 'id',\r\n    accessorKey: 'id',\r\n    header: 'Mã BH',\r\n    cell: ({ row }) => (\r\n      <Link href={`/warranty/${row.systemId}`} className=\"font-medium text-primary hover:underline\">\r\n        {row.id}\r\n      </Link>\r\n    ),\r\n    meta: { displayName: 'Mã BH' },\r\n  },\r\n  {\r\n    id: 'status',\r\n    accessorKey: 'status',\r\n    header: 'Trạng thái',\r\n    cell: ({ row }) => (\r\n      <Badge className={WARRANTY_STATUS_COLORS[row.status] || ''}>\r\n        {WARRANTY_STATUS_LABELS[row.status] || row.status}\r\n      </Badge>\r\n    ),\r\n    meta: { displayName: 'Trạng thái' },\r\n  },\r\n  {\r\n    id: 'createdAt',\r\n    accessorKey: 'createdAt',\r\n    header: 'Ngày tạo',\r\n    cell: ({ row }) => formatDateUtil(row.createdAt),\r\n    meta: { displayName: 'Ngày tạo' },\r\n  },\r\n  {\r\n    id: 'branchName',\r\n    accessorKey: 'branchName',\r\n    header: 'Chi nhánh',\r\n    cell: ({ row }) => row.branchName,\r\n    meta: { displayName: 'Chi nhánh' },\r\n  },\r\n  {\r\n    id: 'trackingCode',\r\n    accessorKey: 'trackingCode',\r\n    header: 'Mã vận đơn',\r\n    cell: ({ row }) => row.trackingCode || '---',\r\n    meta: { displayName: 'Mã vận đơn' },\r\n  },\r\n  {\r\n    id: 'totalProducts',\r\n    header: 'Sản phẩm',\r\n    cell: ({ row }) => row.summary?.totalProducts ?? row.products.length,\r\n    meta: { displayName: 'Sản phẩm' },\r\n  },\r\n  {\r\n    id: 'actions',\r\n    header: 'Hành động',\r\n    cell: ({ row }) => (\r\n      <DropdownMenu>\r\n        <DropdownMenuTrigger asChild>\r\n          <Button variant=\"ghost\" size=\"icon\" className=\"h-8 w-8\">\r\n            <MoreHorizontal className=\"h-4 w-4\" />\r\n            <span className=\"sr-only\">Mở menu</span>\r\n          </Button>\r\n        </DropdownMenuTrigger>\r\n        <DropdownMenuContent align=\"end\">\r\n          <DropdownMenuItem asChild>\r\n            <Link href={`/warranty/${row.systemId}`}>\r\n              <Eye className=\"mr-2 h-4 w-4\" />\r\n              Xem chi tiết\r\n            </Link>\r\n          </DropdownMenuItem>\r\n          {row.publicTrackingCode && (\r\n            <DropdownMenuItem onClick={() => {\r\n              const trackingUrl = `${window.location.origin}/tracking/warranty/${row.publicTrackingCode}`;\r\n              navigator.clipboard.writeText(trackingUrl);\r\n              toast.success('Đã copy link tracking');\r\n            }}>\r\n              <LinkIcon className=\"mr-2 h-4 w-4\" />\r\n              Copy link tracking\r\n            </DropdownMenuItem>\r\n          )}\r\n        </DropdownMenuContent>\r\n      </DropdownMenu>\r\n    ),\r\n    meta: { displayName: 'Hành động', excludeFromExport: true },\r\n  },\r\n];\r\n\r\ntype ComplaintRow = Complaint & { assignedName: string };\r\n\r\nconst complaintColumns: ColumnDef<ComplaintRow>[] = [\r\n  {\r\n    id: 'id',\r\n    accessorKey: 'id',\r\n    header: 'Mã KN',\r\n    cell: ({ row }) => (\r\n      <Link href={`/complaints/${row.systemId}`} className=\"font-medium text-primary hover:underline\">\r\n        {row.id}\r\n      </Link>\r\n    ),\r\n    meta: { displayName: 'Mã KN' },\r\n  },\r\n  {\r\n    id: 'status',\r\n    accessorKey: 'status',\r\n    header: 'Trạng thái',\r\n    cell: ({ row }) => (\r\n      <Badge className={complaintStatusColors[row.status] || ''}>\r\n        {complaintStatusLabels[row.status] || row.status}\r\n      </Badge>\r\n    ),\r\n    meta: { displayName: 'Trạng thái' },\r\n  },\r\n  {\r\n    id: 'type',\r\n    accessorKey: 'type',\r\n    header: 'Loại',\r\n    cell: ({ row }) => complaintTypeLabels[row.type] || row.type,\r\n    meta: { displayName: 'Loại' },\r\n  },\r\n  {\r\n    id: 'createdAt',\r\n    accessorKey: 'createdAt',\r\n    header: 'Ngày tạo',\r\n    cell: ({ row }) => formatDateUtil(row.createdAt),\r\n    meta: { displayName: 'Ngày tạo' },\r\n  },\r\n  {\r\n    id: 'assignedName',\r\n    accessorKey: 'assignedName',\r\n    header: 'Nhân viên xử lý',\r\n    cell: ({ row }) => row.assignedTo ? (\r\n      <Link href={`/employees/${row.assignedTo}`} className=\"text-primary hover:underline\">\r\n        {row.assignedName}\r\n      </Link>\r\n    ) : 'Chưa giao',\r\n    meta: { displayName: 'Nhân viên xử lý' },\r\n  },\r\n  {\r\n    id: 'orderCode',\r\n    accessorKey: 'orderCode',\r\n    header: 'Đơn liên quan',\r\n    cell: ({ row }) => (\r\n      <Link href={`/orders/${row.orderSystemId}`} className=\"text-primary hover:underline\">\r\n        {row.orderCode || row.orderSystemId}\r\n      </Link>\r\n    ),\r\n    meta: { displayName: 'Đơn liên quan' },\r\n  },\r\n  {\r\n    id: 'actions',\r\n    header: 'Hành động',\r\n    cell: ({ row }) => (\r\n      <DropdownMenu>\r\n        <DropdownMenuTrigger asChild>\r\n          <Button variant=\"ghost\" size=\"icon\" className=\"h-8 w-8\">\r\n            <MoreHorizontal className=\"h-4 w-4\" />\r\n            <span className=\"sr-only\">Mở menu</span>\r\n          </Button>\r\n        </DropdownMenuTrigger>\r\n        <DropdownMenuContent align=\"end\">\r\n          <DropdownMenuItem asChild>\r\n            <Link href={`/complaints/${row.systemId}`}>\r\n              <Eye className=\"mr-2 h-4 w-4\" />\r\n              Xem chi tiết\r\n            </Link>\r\n          </DropdownMenuItem>\r\n          <DropdownMenuItem asChild>\r\n            <Link href={`/orders/${row.orderSystemId}`}>\r\n              <ExternalLink className=\"mr-2 h-4 w-4\" />\r\n              Xem đơn hàng\r\n            </Link>\r\n          </DropdownMenuItem>\r\n          {row.publicTrackingCode && (\r\n            <DropdownMenuItem onClick={() => {\r\n              const trackingUrl = `${window.location.origin}/tracking/complaint/${row.publicTrackingCode}`;\r\n              navigator.clipboard.writeText(trackingUrl);\r\n              toast.success('Đã copy link tracking');\r\n            }}>\r\n              <LinkIcon className=\"mr-2 h-4 w-4\" />\r\n              Copy link tracking\r\n            </DropdownMenuItem>\r\n          )}\r\n        </DropdownMenuContent>\r\n      </DropdownMenu>\r\n    ),\r\n    meta: { displayName: 'Hành động', excludeFromExport: true },\r\n  },\r\n];\r\n\r\n// REMOVED: Complaint columns\r\n// const complaintColumns: ColumnDef<Complaint>[] = [\r\n//     { id: 'id', accessorKey: 'id', header: 'Mã KN', cell: ({ row }) => <span className=\"font-medium\">{row.id}</span>, meta: { displayName: 'Mã KN'} },\r\n//     { id: 'title', accessorKey: 'title', header: 'Tiêu đề', cell: ({ row }) => row.title, meta: { displayName: 'Tiêu đề'} },\r\n//     { id: 'createdDate', accessorKey: 'createdDate', header: 'Ngày tạo', cell: ({ row }) => formatDateUtil(row.createdDate), meta: { displayName: 'Ngày tạo'} },\r\n//     { id: 'status', accessorKey: 'status', header: 'Trạng thái', cell: ({ row }) => <Badge variant={complaintStatusVariants[row.status] as any}>{row.status}</Badge>, meta: { displayName: 'Trạng thái'} },\r\n// ];\r\n\r\nconst debtColumns: ColumnDef<any>[] = [\r\n    { id: 'voucherId', accessorKey: 'voucherId', header: 'Mã phiếu', cell: ({ row }) => {\r\n        const path = row.type === 'order' ? `/orders/${row.originalSystemId}` \r\n            : row.type === 'receipt' ? `/receipts/${row.originalSystemId}` \r\n            : row.type === 'sales-return' ? `/returns/${row.originalSystemId}`\r\n            : row.type === 'complaint-payment' ? `/payments/${row.originalSystemId}`\r\n            : `/payments/${row.originalSystemId}`;\r\n        return <Link href={path} className=\"font-medium text-primary hover:underline\">{row.voucherId}</Link>;\r\n    }, meta: { displayName: 'Mã phiếu' } },\r\n    { id: 'creator', accessorKey: 'creator', header: 'Người tạo', cell: ({ row }) => {\r\n        return row.creatorId ? (\r\n            <Link href={`/employees/${row.creatorId}`} className=\"text-primary hover:underline\">{row.creator}</Link>\r\n        ) : (\r\n            <span>{row.creator}</span>\r\n        );\r\n    }, meta: { displayName: 'Người tạo' } },\r\n    { id: 'createdAt', accessorKey: 'createdAt', header: 'Ngày Ghi nhận', cell: ({ row }) => formatDateUtil(row.createdAt), meta: { displayName: 'Ngày Ghi nhận' } },\r\n    { id: 'description', accessorKey: 'description', header: 'Ghi chú', cell: ({ row }) => {\r\n        // Hiển thị badge cho complaint payment\r\n        if (row.type === 'complaint-payment') {\r\n            return (\r\n                <span className=\"flex items-center gap-1\">\r\n                    <span>{row.description}</span>\r\n                    <Badge variant=\"outline\" className=\"text-[10px] px-1 py-0\">Khiếu nại</Badge>\r\n                </span>\r\n            );\r\n        }\r\n        return row.description;\r\n    }, meta: { displayName: 'Ghi chú' } },\r\n    { id: 'change', accessorKey: 'change', header: 'Giá trị thay đổi', cell: ({ row }) => {\r\n        // Hiển thị displayAmount nếu có (cho phiếu chi hoàn tiền từ trả hàng/khiếu nại)\r\n        const displayValue = row.displayAmount !== undefined ? row.displayAmount : row.change;\r\n        const isRefundFromReturn = row.type === 'payment' && row.displayAmount !== undefined;\r\n        const isRefundFromComplaint = row.type === 'complaint-payment';\r\n        return (\r\n            <span className={displayValue > 0 ? 'text-blue-600' : 'text-green-600'}>\r\n                {formatCurrency(displayValue)}\r\n                {(isRefundFromReturn || isRefundFromComplaint) && <span className=\"text-xs text-muted-foreground ml-1\">(tiền mặt)</span>}\r\n            </span>\r\n        );\r\n    }, meta: { displayName: 'Giá trị thay đổi' } },\r\n    { id: 'balance', accessorKey: 'balance', header: 'Công nợ', cell: ({ row }) => <span className=\"font-semibold\">{formatCurrency(row.balance)}</span>, meta: { displayName: 'Công nợ' } },\r\n    { id: 'actions', header: 'Hành động', cell: ({ row }) => {\r\n        const path = row.type === 'order' ? `/orders/${row.originalSystemId}` \r\n            : row.type === 'receipt' ? `/receipts/${row.originalSystemId}` \r\n            : row.type === 'sales-return' ? `/returns/${row.originalSystemId}`\r\n            : row.type === 'complaint-payment' ? `/payments/${row.originalSystemId}`\r\n            : `/payments/${row.originalSystemId}`;\r\n        return (\r\n            <DropdownMenu>\r\n                <DropdownMenuTrigger asChild>\r\n                    <Button variant=\"ghost\" size=\"icon\" className=\"h-8 w-8\">\r\n                        <MoreHorizontal className=\"h-4 w-4\" />\r\n                        <span className=\"sr-only\">Mở menu</span>\r\n                    </Button>\r\n                </DropdownMenuTrigger>\r\n                <DropdownMenuContent align=\"end\">\r\n                    <DropdownMenuItem asChild>\r\n                        <Link href={path}>\r\n                            <Eye className=\"mr-2 h-4 w-4\" />\r\n                            Xem chi tiết\r\n                        </Link>\r\n                    </DropdownMenuItem>\r\n                    <DropdownMenuSeparator />\r\n                    <DropdownMenuItem onClick={() => window.print()}>\r\n                        <Printer className=\"mr-2 h-4 w-4\" />\r\n                        In\r\n                    </DropdownMenuItem>\r\n                    <DropdownMenuItem onClick={() => toast.info('Chức năng xuất PDF đang phát triển')}>\r\n                        <FileText className=\"mr-2 h-4 w-4\" />\r\n                        Xuất PDF\r\n                    </DropdownMenuItem>\r\n                    <DropdownMenuItem onClick={() => toast.info('Chức năng xuất Excel đang phát triển')}>\r\n                        <FileSpreadsheet className=\"mr-2 h-4 w-4\" />\r\n                        Xuất Excel\r\n                    </DropdownMenuItem>\r\n                </DropdownMenuContent>\r\n            </DropdownMenu>\r\n        );\r\n    }, meta: { displayName: 'Hành động', excludeFromExport: true } },\r\n];\r\n\r\nconst customerStatusVariants: Partial<Record<Customer[\"status\"], \"default\" | \"secondary\" | \"destructive\">> = {\r\n  \"Đang giao dịch\": \"default\",\r\n  \"Ngừng Giao Dịch\": \"secondary\",\r\n  active: \"default\",\r\n  inactive: \"secondary\",\r\n};\r\n\r\nconst renderCustomerStatusBadge = (status?: Customer[\"status\"]) => {\r\n  if (!status) return undefined;\r\n  return (\r\n    <Badge variant={customerStatusVariants[status] ?? \"secondary\"}>\r\n      {status}\r\n    </Badge>\r\n  );\r\n};\r\n\r\n\r\nexport function CustomerDetailPage() {\r\n  const { systemId } = useParams<{ systemId: string }>();\r\n  const router = useRouter();\r\n  const { findById, update, data, removeMany } = useCustomerStore();\r\n  const customer = React.useMemo(() => (systemId ? findById(asSystemId(systemId)) : null), [systemId, findById, data]);\r\n  const [activeTab, setActiveTab] = React.useState('info');\r\n  const [orderDrilldownSearch, setOrderDrilldownSearch] = React.useState<DrilldownSearch | null>(null);\r\n  const [warrantyDrilldownSearch, setWarrantyDrilldownSearch] = React.useState<DrilldownSearch | null>(null);\r\n  const [complaintDrilldownSearch, setComplaintDrilldownSearch] = React.useState<DrilldownSearch | null>(null);\r\n\r\n  useCustomerSlaEvaluation();\r\n\r\n  const { data: allOrders } = useOrderStore();\r\n  const { data: allSalesReturns } = useSalesReturnStore();\r\n  const { data: allWarrantyTickets } = useWarrantyStore();\r\n  const allComplaints = useComplaintStore((state) => state.complaints);\r\n  const { data: allReceipts } = useReceiptStore();\r\n  const { data: allPayments } = usePaymentStore();\r\n  const { findById: findEmployeeById } = useEmployeeStore();\r\n  const { employee: authEmployee } = useAuth();\r\n\r\n  // Force update logs when SLA action happens\r\n  const [logUpdateTrigger, setLogUpdateTrigger] = React.useState(0);\r\n\r\n  React.useEffect(() => {\r\n    const handleLogUpdate = (e: Event) => {\r\n      const customEvent = e as CustomEvent;\r\n      if (customEvent.detail?.customerId === customer?.systemId) {\r\n        setLogUpdateTrigger(prev => prev + 1);\r\n      }\r\n    };\r\n\r\n    window.addEventListener(SLA_LOG_UPDATED_EVENT, handleLogUpdate);\r\n    return () => window.removeEventListener(SLA_LOG_UPDATED_EVENT, handleLogUpdate);\r\n  }, [customer?.systemId]);\r\n\r\n  // Build activity history from customer data\r\n  const activityHistory = React.useMemo((): HistoryEntry[] => {\r\n    if (!customer) return [];\r\n    const entries: HistoryEntry[] = [];\r\n    \r\n    // Created entry\r\n    if (customer.createdAt) {\r\n      entries.push({\r\n        id: `${customer.systemId}-created`,\r\n        action: 'created',\r\n        timestamp: new Date(customer.createdAt),\r\n        user: {\r\n          systemId: customer.createdBy || '',\r\n          name: findEmployeeById(customer.createdBy ? asSystemId(customer.createdBy) : asSystemId(''))?.fullName || 'Hệ thống',\r\n        },\r\n        description: `Tạo hồ sơ khách hàng ${customer.name}`,\r\n      });\r\n    }\r\n    \r\n    // Updated entry\r\n    if (customer.updatedAt && customer.updatedAt !== customer.createdAt) {\r\n      entries.push({\r\n        id: `${customer.systemId}-updated`,\r\n        action: 'updated',\r\n        timestamp: new Date(customer.updatedAt),\r\n        user: {\r\n          systemId: customer.updatedBy || '',\r\n          name: findEmployeeById(customer.updatedBy ? asSystemId(customer.updatedBy) : asSystemId(''))?.fullName || 'Hệ thống',\r\n        },\r\n        description: 'Cập nhật thông tin khách hàng',\r\n      });\r\n    }\r\n\r\n    // SLA Activity Logs\r\n    const slaLogs = getActivityLogs(customer.systemId);\r\n    \r\n    const getSlaTypeLabel = (type: string) => {\r\n      switch (type) {\r\n        case 'follow-up': return 'Liên hệ định kỳ';\r\n        case 're-engagement': return 'Kích hoạt lại';\r\n        case 'debt-payment': return 'Thanh toán công nợ';\r\n        case 'warranty-expiry': return 'Hết hạn bảo hành';\r\n        default: return type;\r\n      }\r\n    };\r\n\r\n    slaLogs.forEach(log => {\r\n      let actionLabel = 'updated';\r\n      let description = '';\r\n      const slaTypeLabel = getSlaTypeLabel(log.slaType);\r\n      \r\n      switch (log.actionType) {\r\n        case 'acknowledged':\r\n          actionLabel = 'status_changed';\r\n          description = `Đã xác nhận xử lý SLA (${slaTypeLabel})`;\r\n          break;\r\n        case 'snoozed':\r\n          actionLabel = 'status_changed';\r\n          description = `Tạm hoãn SLA (${slaTypeLabel})`;\r\n          break;\r\n        default:\r\n          description = `Cập nhật SLA (${slaTypeLabel})`;\r\n      }\r\n\r\n      if (log.notes) {\r\n        description += `: ${log.notes}`;\r\n      }\r\n\r\n      entries.push({\r\n        id: log.id,\r\n        action: actionLabel as any,\r\n        timestamp: new Date(log.performedAt),\r\n        user: {\r\n          systemId: 'system', // We don't have user ID in simple log yet, or it's just name\r\n          name: log.performedBy || 'Hệ thống',\r\n        },\r\n        description,\r\n      });\r\n    });\r\n    \r\n    return entries.sort((a, b) => b.timestamp.getTime() - a.timestamp.getTime());\r\n  }, [customer, findEmployeeById, logUpdateTrigger]);\r\n\r\n  const focusTab = React.useCallback((tab: string, scrollToSection = false) => {\r\n    setActiveTab(tab);\r\n    if (!scrollToSection || typeof window === 'undefined' || typeof window.requestAnimationFrame !== 'function') {\r\n      return;\r\n    }\r\n\r\n    window.requestAnimationFrame(() => {\r\n      if (typeof document === 'undefined') return;\r\n      const anchor = document.getElementById(`customer-tab-${tab}`);\r\n      if (anchor) {\r\n        anchor.scrollIntoView({ behavior: 'smooth', block: 'start' });\r\n      }\r\n    });\r\n  }, []);\r\n\r\n  const buildDrilldownSearch = React.useCallback((query: string): DrilldownSearch => ({\r\n    query,\r\n    token: `${Date.now()}-${Math.random().toString(36).slice(2, 8)}`,\r\n  }), []);\r\n\r\n  const handleOrderSearchApplied = React.useCallback(() => setOrderDrilldownSearch(null), []);\r\n  const handleWarrantySearchApplied = React.useCallback(() => setWarrantyDrilldownSearch(null), []);\r\n  const handleComplaintSearchApplied = React.useCallback(() => setComplaintDrilldownSearch(null), []);\r\n  const handleOrderStatusFilter = React.useCallback((status?: OrderMainStatus | 'failed') => {\r\n    focusTab('purchase-history', true);\r\n    if (!status) return;\r\n    if (status === 'failed') {\r\n      setOrderDrilldownSearch(buildDrilldownSearch('Chờ giao lại'));\r\n      return;\r\n    }\r\n    setOrderDrilldownSearch(buildDrilldownSearch(status));\r\n  }, [focusTab, buildDrilldownSearch]);\r\n  const handleDebtCardClick = React.useCallback(() => focusTab('debt', true), [focusTab]);\r\n  const handleWarrantyCardClick = React.useCallback((filterActive?: boolean) => {\r\n    focusTab('warranty', true);\r\n    if (filterActive) {\r\n      setWarrantyDrilldownSearch(buildDrilldownSearch('pending'));\r\n    }\r\n  }, [focusTab, buildDrilldownSearch]);\r\n  const handleComplaintCardClick = React.useCallback((filterActive?: boolean) => {\r\n    focusTab('complaints', true);\r\n    if (filterActive) {\r\n      setComplaintDrilldownSearch(buildDrilldownSearch('pending'));\r\n    }\r\n  }, [focusTab, buildDrilldownSearch]);\r\n  \r\n  // Settings stores\r\n  const customerTypes = useCustomerTypeStore();\r\n  const customerGroups = useCustomerGroupStore();\r\n  const customerSources = useCustomerSourceStore();\r\n  const paymentTerms = usePaymentTermStore();\r\n  const creditRatings = useCreditRatingStore();\r\n\r\n  // Lookup names\r\n  const getTypeName = (id?: string) => id ? customerTypes.findById(asSystemId(id))?.name : undefined;\r\n  const getGroupName = (id?: string) => id ? customerGroups.findById(asSystemId(id))?.name : undefined;\r\n  const getSourceName = (id?: string) => id ? customerSources.findById(asSystemId(id))?.name : undefined;\r\n  const getPaymentTermName = (id?: string) => id ? paymentTerms.findById(asSystemId(id))?.name : undefined;\r\n  const getCreditRatingName = (id?: string) => id ? creditRatings.findById(asSystemId(id))?.name : undefined;\r\n  const getEmployeeName = (id?: string) => id ? findEmployeeById(asSystemId(id))?.fullName : undefined;\r\n\r\n  const customerOrders = React.useMemo(() => allOrders.filter(o => o.customerSystemId === customer?.systemId), [allOrders, customer?.systemId]);\r\n  \r\n  // Sales returns for this customer\r\n  const customerSalesReturns = React.useMemo(() => \r\n    allSalesReturns.filter(sr => sr.customerSystemId === customer?.systemId),\r\n    [allSalesReturns, customer?.systemId]\r\n  );\r\n  \r\n  // Combine orders with their return info\r\n  const customerOrdersWithReturns = React.useMemo<OrderWithReturns[]>(() => {\r\n    return customerOrders.map(order => {\r\n      const returnsForOrder = customerSalesReturns.filter(sr => sr.orderSystemId === order.systemId);\r\n      const totalReturnValue = returnsForOrder.reduce((sum, sr) => sum + sr.totalReturnValue, 0);\r\n      return {\r\n        ...order,\r\n        returnCount: returnsForOrder.length,\r\n        totalReturnValue,\r\n        returnIds: returnsForOrder.map(sr => sr.id),\r\n      };\r\n    });\r\n  }, [customerOrders, customerSalesReturns]);\r\n  \r\n  // Dynamic columns with return info\r\n  const orderColumnsWithReturns = React.useMemo<ColumnDef<OrderWithReturns>[]>(() => [\r\n    { id: 'id', accessorKey: 'id', header: 'Mã ĐH', cell: ({ row }) => <span className=\"font-medium\">{row.id}</span>, meta: { displayName: 'Mã ĐH'} },\r\n    { id: 'orderDate', accessorKey: 'orderDate', header: 'Ngày đặt', cell: ({ row }) => formatDateUtil(row.orderDate), meta: { displayName: 'Ngày đặt'} },\r\n    { id: 'status', accessorKey: 'status', header: 'Trạng thái', cell: ({ row }) => {\r\n        let displayStatus = row.status;\r\n        if (row.status === 'Đặt hàng' && (row.stockOutStatus === 'Xuất kho toàn bộ' || row.deliveryStatus === 'Đang giao hàng' || row.deliveryStatus === 'Đã giao hàng')) {\r\n            displayStatus = 'Đang giao dịch';\r\n        }\r\n        return <Badge variant={orderStatusVariants[displayStatus] || orderStatusVariants[row.status]}>{displayStatus}</Badge>;\r\n    }, meta: { displayName: 'Trạng thái'} },\r\n    { id: 'grandTotal', accessorKey: 'grandTotal', header: 'Tổng tiền', cell: ({ row }) => formatCurrency(row.grandTotal), meta: { displayName: 'Tổng tiền'} },\r\n    { id: 'returns', header: 'Hoàn trả', cell: ({ row }) => {\r\n        if (!row.returnCount || row.returnCount === 0) {\r\n            return <span className=\"text-muted-foreground\">-</span>;\r\n        }\r\n        return (\r\n            <div className=\"flex flex-col\">\r\n                <span className=\"text-amber-600 font-medium\">{row.returnCount} phiếu</span>\r\n                <span className=\"text-xs text-muted-foreground\">{formatCurrency(row.totalReturnValue || 0)}</span>\r\n            </div>\r\n        );\r\n    }, meta: { displayName: 'Hoàn trả'} },\r\n    { id: 'actions', header: 'Hành động', cell: ({ row }) => (\r\n        <DropdownMenu>\r\n            <DropdownMenuTrigger asChild>\r\n                <Button variant=\"ghost\" size=\"icon\" className=\"h-8 w-8\">\r\n                    <MoreHorizontal className=\"h-4 w-4\" />\r\n                </Button>\r\n            </DropdownMenuTrigger>\r\n            <DropdownMenuContent align=\"end\">\r\n                <DropdownMenuItem asChild>\r\n                    <Link href={`/orders/${row.systemId}`}>\r\n                        <Eye className=\"mr-2 h-4 w-4\" />\r\n                        Xem chi tiết\r\n                    </Link>\r\n                </DropdownMenuItem>\r\n                <DropdownMenuSeparator />\r\n                <DropdownMenuItem onClick={() => window.print()}>\r\n                    <Printer className=\"mr-2 h-4 w-4\" />\r\n                    In\r\n                </DropdownMenuItem>\r\n                <DropdownMenuItem onClick={() => toast.info('Chức năng xuất PDF đang phát triển')}>\r\n                    <FileText className=\"mr-2 h-4 w-4\" />\r\n                    Xuất PDF\r\n                </DropdownMenuItem>\r\n                <DropdownMenuItem onClick={() => toast.info('Chức năng xuất Excel đang phát triển')}>\r\n                    <FileSpreadsheet className=\"mr-2 h-4 w-4\" />\r\n                    Xuất Excel\r\n                </DropdownMenuItem>\r\n            </DropdownMenuContent>\r\n        </DropdownMenu>\r\n    ), meta: { displayName: 'Hành động', excludeFromExport: true } },\r\n  ], []);\r\n  \r\n  // Orders that create debt: status='Hoàn thành' OR deliveryStatus='Đã giao hàng' OR stockOutStatus='Xuất kho toàn bộ'\r\n  const deliveredCustomerOrders = React.useMemo(\r\n    () => customerOrders.filter(order => \r\n      order.status !== 'Đã hủy' &&\r\n      (order.status === 'Hoàn thành' || \r\n       order.deliveryStatus === 'Đã giao hàng' || \r\n       order.stockOutStatus === 'Xuất kho toàn bộ')\r\n    ),\r\n    [customerOrders]\r\n  );\r\n  const failedDeliveryOrders = React.useMemo(\r\n    () => customerOrders.filter(order => order.deliveryStatus === 'Chờ giao lại'),\r\n    [customerOrders]\r\n  );\r\n  const orderStatusBreakdown = React.useMemo(() => {\r\n    return customerOrders.reduce(\r\n      (acc, order) => {\r\n        if (order.status === 'Hoàn thành') acc.hoanThanh += 1;\r\n        else if (order.status === 'Đang giao dịch') acc.dangGiaoDich += 1;\r\n        else if (order.status === 'Đặt hàng') acc.datHang += 1;\r\n        else if (order.status === 'Đã hủy') acc.daHuy += 1;\r\n        return acc;\r\n      },\r\n      { dangGiaoDich: 0, hoanThanh: 0, datHang: 0, daHuy: 0 }\r\n    );\r\n  }, [customerOrders]);\r\n  \r\n  // Note: Warranty tickets don't have customerId field - they store customer info directly\r\n  // Filter by customer phone number instead\r\n  const customerWarrantyTickets = React.useMemo(() => {\r\n    if (!customer?.phone) return [] as WarrantyTicket[];\r\n    return allWarrantyTickets.filter(t => t.customerPhone === customer.phone);\r\n  }, [allWarrantyTickets, customer?.phone]);\r\n  const customerWarrantyCount = customerWarrantyTickets.length;\r\n  const activeWarrantyCount = React.useMemo(\r\n    () => customerWarrantyTickets.filter(ticket => !['returned', 'completed', 'cancelled'].includes(ticket.status)).length,\r\n    [customerWarrantyTickets]\r\n  );\r\n  \r\n  const customerComplaints = React.useMemo(() => {\r\n    if (!customer) return [] as Complaint[];\r\n    return allComplaints.filter(c => c.customerSystemId === customer.systemId);\r\n  }, [allComplaints, customer?.systemId]);\r\n  const customerComplaintCount = customerComplaints.length;\r\n  const activeComplaintCount = React.useMemo(\r\n    () => customerComplaints.filter(complaint => complaint.status === 'pending' || complaint.status === 'investigating').length,\r\n    [customerComplaints]\r\n  );\r\n\r\n  // ============================================\r\n  // REALTIME Customer Intelligence Calculations\r\n  // ============================================\r\n  const realtimeHealthScore = React.useMemo(() => {\r\n    if (!customer) return 0;\r\n    return calculateHealthScore(customer);\r\n  }, [customer]);\r\n  \r\n  const realtimeChurnRisk = React.useMemo(() => {\r\n    if (!customer) return null;\r\n    return calculateChurnRisk(customer);\r\n  }, [customer]);\r\n  \r\n  const realtimeRFMScores = React.useMemo(() => {\r\n    if (!customer) return null;\r\n    // Need all customers for percentile calculation\r\n    return calculateRFMScores(customer, data);\r\n  }, [customer, data]);\r\n  \r\n  const realtimeSegment = React.useMemo(() => {\r\n    if (!realtimeRFMScores) return null;\r\n    return getCustomerSegment(realtimeRFMScores);\r\n  }, [realtimeRFMScores]);\r\n  \r\n  const realtimeLifecycleStage = React.useMemo(() => {\r\n    if (!customer) return null;\r\n    return calculateLifecycleStage(customer);\r\n  }, [customer]);\r\n\r\n  const daysSinceLastPurchase = React.useMemo(() => {\r\n    if (!customer?.lastPurchaseDate) return null;\r\n    return getDaysDiff(getCurrentDate(), new Date(customer.lastPurchaseDate));\r\n  }, [customer?.lastPurchaseDate]);\r\n\r\n  // Get products store for warranty info\r\n  const { findById: findProductById } = useProductStore();\r\n\r\n  const purchasedProducts = React.useMemo(() => {\r\n    const items: Array<{ systemId: string, name: string; quantity: number; orderId: string; orderDate: string; orderSystemId: string; productSystemId: string; warrantyMonths: number; warrantyExpiry: string; daysRemaining: number }> = [];\r\n    customerOrders.forEach(order => {\r\n      order.lineItems.forEach(item => {\r\n        // Lấy thông tin bảo hành từ sản phẩm hoặc mặc định 12 tháng\r\n        const product = item.productSystemId ? findProductById(asSystemId(item.productSystemId)) : null;\r\n        const warrantyMonths = (item as any).warrantyPeriodMonths || product?.warrantyPeriodMonths || 0;\r\n        const warrantyExpiry = warrantyMonths > 0 ? calculateWarrantyExpiry(order.orderDate, warrantyMonths) : '';\r\n        const daysRemaining = warrantyExpiry ? calculateDaysRemaining(warrantyExpiry) : 0;\r\n        \r\n        items.push({\r\n          systemId: `${order.systemId}-${item.productId}-${Math.random()}`, // Ensure uniqueness\r\n          name: item.productName,\r\n          quantity: item.quantity,\r\n          orderId: order.id,\r\n          orderDate: order.orderDate,\r\n          orderSystemId: order.systemId,\r\n          productSystemId: item.productSystemId,\r\n          warrantyMonths,\r\n          warrantyExpiry,\r\n          daysRemaining,\r\n        });\r\n      });\r\n    });\r\n    return items.sort((a, b) => new Date(b.orderDate).getTime() - new Date(a.orderDate).getTime());\r\n  }, [customerOrders, findProductById]);\r\n  \r\n  const customerDebtTransactions = React.useMemo(() => {\r\n    if (!customer) return [];\r\n\r\n    // Helper: get timestamp for sorting - prefer createdAt, fallback to date field\r\n    const getTimestamp = (createdAt: string | undefined, fallbackDate: string): number => {\r\n        const parsed = parseDate(createdAt || fallbackDate);\r\n        return parsed?.getTime() || 0;\r\n    };\r\n\r\n    const orderTransactions = deliveredCustomerOrders.map(order => ({\r\n        systemId: `order-${order.systemId}`,\r\n        voucherId: order.id,\r\n        originalSystemId: order.systemId,\r\n        type: 'order',\r\n        creator: order.salesperson,\r\n        creatorId: order.salespersonSystemId,\r\n        date: order.orderDate,\r\n        createdAt: order.createdAt || order.orderDate, // Ưu tiên createdAt, fallback orderDate\r\n        _sortTimestamp: getTimestamp(order.createdAt, order.orderDate),\r\n        description: `Đơn hàng #${order.id}`,\r\n        // ✅ Use grandTotal (không trừ paidAmount) vì phiếu thu đã được tính riêng ở receiptTransactions\r\n        // Nếu dùng grandTotal - paidAmount sẽ bị tính trùng khi phiếu thu đã auto-allocate vào order\r\n        change: order.grandTotal || 0,\r\n    }));\r\n\r\n    // ✅ Chỉ tính phiếu thu có affectsDebt=true, chưa hủy, và đúng khách hàng (theo systemId)\r\n    const receiptTransactions = allReceipts\r\n        .filter(r => \r\n            r.status !== 'cancelled' && \r\n            r.affectsDebt === true && \r\n            (r.customerSystemId === customer.systemId || r.payerSystemId === customer.systemId || \r\n             (r.payerTypeName === 'Khách hàng' && r.payerName === customer.name))\r\n        )\r\n        .map(receipt => ({\r\n            systemId: `receipt-${receipt.systemId}`,\r\n            voucherId: receipt.id,\r\n            originalSystemId: receipt.systemId,\r\n            type: 'receipt',\r\n            creator: getEmployeeName(receipt.createdBy) || receipt.createdBy,\r\n            creatorId: receipt.createdBy,\r\n            date: receipt.date,\r\n            createdAt: receipt.createdAt || receipt.date, // Fallback to date if createdAt not set\r\n            _sortTimestamp: getTimestamp(receipt.createdAt, receipt.date),\r\n            description: receipt.description,\r\n            change: -receipt.amount,\r\n        }));\r\n\r\n    // ✅ Phiếu chi có ảnh hưởng công nợ (KHÔNG phải hoàn tiền từ trả hàng)\r\n    const paymentTransactionsWithDebt = allPayments\r\n        .filter(p => \r\n            p.status !== 'cancelled' && \r\n            p.affectsDebt === true && \r\n            !p.linkedSalesReturnSystemId &&\r\n            (p.customerSystemId === customer.systemId || p.recipientSystemId === customer.systemId ||\r\n             (p.recipientTypeName === 'Khách hàng' && p.recipientName === customer.name))\r\n        )\r\n        .map(payment => {\r\n            const isRefundToCustomer = payment.paymentReceiptTypeName === 'Hoàn tiền khách hàng' || \r\n                                       payment.category === 'complaint_refund';\r\n            return {\r\n                systemId: `payment-${payment.systemId}`,\r\n                voucherId: payment.id,\r\n                originalSystemId: payment.systemId,\r\n                type: 'payment',\r\n                creator: getEmployeeName(payment.createdBy) || payment.createdBy,\r\n                creatorId: payment.createdBy,\r\n                date: payment.date,\r\n                createdAt: payment.createdAt || payment.date,\r\n                _sortTimestamp: getTimestamp(payment.createdAt, payment.date),\r\n                description: payment.description,\r\n                change: isRefundToCustomer ? -payment.amount : payment.amount,\r\n            };\r\n        });\r\n\r\n    // ✅ Phiếu chi hoàn tiền từ trả hàng - hiển thị nhưng KHÔNG ảnh hưởng công nợ (change = 0)\r\n    const refundPaymentTransactions = allPayments\r\n        .filter(p => \r\n            p.status !== 'cancelled' && \r\n            p.linkedSalesReturnSystemId &&\r\n            (p.customerSystemId === customer.systemId || p.recipientSystemId === customer.systemId ||\r\n             (p.recipientTypeName === 'Khách hàng' && p.recipientName === customer.name))\r\n        )\r\n        .map(payment => ({\r\n            systemId: `payment-${payment.systemId}`,\r\n            voucherId: payment.id,\r\n            originalSystemId: payment.systemId,\r\n            type: 'payment',\r\n            creator: getEmployeeName(payment.createdBy) || payment.createdBy,\r\n            creatorId: payment.createdBy,\r\n            date: payment.date,\r\n            createdAt: payment.createdAt || payment.date,\r\n            _sortTimestamp: getTimestamp(payment.createdAt, payment.date),\r\n            description: payment.description,\r\n            // Hiển thị số tiền hoàn nhưng KHÔNG ảnh hưởng công nợ\r\n            displayAmount: -payment.amount,\r\n            change: 0,\r\n        }));\r\n    \r\n    // ✅ Phiếu chi hoàn tiền từ khiếu nại - hiển thị nhưng KHÔNG ảnh hưởng công nợ (change = 0)\r\n    const complaintRefundPaymentTransactions = allPayments\r\n        .filter(p => \r\n            p.status !== 'cancelled' && \r\n            p.linkedComplaintSystemId &&\r\n            !p.linkedSalesReturnSystemId && // Exclude if already in refundPaymentTransactions\r\n            (p.customerSystemId === customer.systemId || p.recipientSystemId === customer.systemId ||\r\n             (p.recipientTypeName === 'Khách hàng' && p.recipientName === customer.name))\r\n        )\r\n        .map(payment => ({\r\n            systemId: `complaint-payment-${payment.systemId}`,\r\n            voucherId: payment.id,\r\n            originalSystemId: payment.systemId,\r\n            type: 'complaint-payment',\r\n            creator: getEmployeeName(payment.createdBy) || payment.createdBy,\r\n            creatorId: payment.createdBy,\r\n            date: payment.date,\r\n            createdAt: payment.createdAt || payment.date,\r\n            _sortTimestamp: getTimestamp(payment.createdAt, payment.date),\r\n            description: payment.description || 'Hoàn tiền khiếu nại',\r\n            // Hiển thị số tiền hoàn nhưng KHÔNG ảnh hưởng công nợ\r\n            displayAmount: -payment.amount,\r\n            change: 0,\r\n        }));\r\n\r\n    // Combine tất cả transactions\r\n    const allTransactions = [...orderTransactions, ...receiptTransactions, ...paymentTransactionsWithDebt, ...refundPaymentTransactions, ...complaintRefundPaymentTransactions];\r\n    // ✅ Sort theo _sortTimestamp (thời điểm tạo đã parse)\r\n    allTransactions.sort((a, b) => a._sortTimestamp - b._sortTimestamp);\r\n    \r\n    let runningDebt = 0;\r\n    const transactionsWithBalance = allTransactions.map(t => {\r\n        runningDebt += t.change;\r\n        return { ...t, balance: runningDebt };\r\n    });\r\n\r\n    return transactionsWithBalance.reverse();\r\n  }, [customer, deliveredCustomerOrders, allReceipts, allPayments, getEmployeeName]);\r\n\r\n  const warrantyTableData = React.useMemo(() => {\r\n    return [...customerWarrantyTickets].sort(\r\n      (a, b) => new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime()\r\n    );\r\n  }, [customerWarrantyTickets]);\r\n\r\n  const complaintTableData = React.useMemo<ComplaintRow[]>(() => {\r\n    return customerComplaints\r\n      .slice()\r\n      .sort((a, b) => new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime())\r\n      .map(complaint => ({\r\n        ...complaint,\r\n        assignedName: complaint.assignedTo ? (getEmployeeName(complaint.assignedTo) || complaint.assignedTo) : '',\r\n      }));\r\n  }, [customerComplaints, getEmployeeName]);\r\n\r\n  const [deleteDialogOpen, setDeleteDialogOpen] = React.useState(false);\r\n  \r\n  // Get SLA entry for header badges\r\n  const slaEntry = useCustomerSlaEngineStore((state) => customer ? state.index?.entries[customer.systemId] : null);\r\n  \r\n  const handleDeleteCustomer = React.useCallback(() => {\r\n    if (customer) {\r\n      removeMany([customer.systemId]);\r\n      toast.success(`Đã chuyển khách hàng ${customer.name} vào thùng rác`);\r\n      router.push('/customers');\r\n    }\r\n  }, [customer, removeMany, router]);\r\n\r\n  const headerActions = React.useMemo(() => [\r\n    <Button key=\"delete\" variant=\"outline\" size=\"sm\" className=\"h-9 text-destructive hover:text-destructive\" onClick={() => setDeleteDialogOpen(true)}>\r\n      <Trash2 className=\"mr-2 h-4 w-4\" />\r\n      Chuyển vào thùng rác\r\n    </Button>,\r\n    <Button key=\"edit\" size=\"sm\" className=\"h-9\" onClick={() => router.push(`/customers/${systemId}/edit`)}>\r\n      <Edit className=\"mr-2 h-4 w-4\" />\r\n      Chỉnh sửa\r\n    </Button>\r\n  ], [router, systemId]);\r\n\r\n  // ✅ Build header badges with SLA alerts\r\n  const headerBadges = React.useMemo(() => {\r\n    const badges: React.ReactNode[] = [];\r\n    \r\n    // Customer status badge\r\n    if (customer?.status) {\r\n      badges.push(\r\n        <Badge key=\"status\" variant={customerStatusVariants[customer.status] ?? \"secondary\"}>\r\n          {customer.status}\r\n        </Badge>\r\n      );\r\n    }\r\n    \r\n    // SLA alert badges\r\n    if (slaEntry) {\r\n      // Overdue SLA alerts\r\n      const overdueAlerts = slaEntry.alerts?.filter(a => a.alertLevel === 'overdue') || [];\r\n      if (overdueAlerts.length > 0) {\r\n        badges.push(\r\n          <Badge key=\"sla-overdue\" variant=\"destructive\" className=\"gap-1\">\r\n            <Clock className=\"h-3 w-3\" />\r\n            {overdueAlerts.length} SLA quá hạn\r\n          </Badge>\r\n        );\r\n      }\r\n      \r\n      // Debt alert\r\n      if (slaEntry.debtAlert) {\r\n        badges.push(\r\n          <Badge key=\"debt-alert\" variant=\"destructive\" className=\"gap-1\">\r\n            <CreditCard className=\"h-3 w-3\" />\r\n            Nợ quá hạn\r\n          </Badge>\r\n        );\r\n      }\r\n      \r\n      // Churn risk alert\r\n      if (slaEntry.healthAlert && slaEntry.healthAlert.churnRisk === 'high') {\r\n        badges.push(\r\n          <Badge key=\"churn-alert\" className=\"gap-1 bg-purple-600 hover:bg-purple-700\">\r\n            <TrendingDown className=\"h-3 w-3\" />\r\n            Rủi ro cao\r\n          </Badge>\r\n        );\r\n      }\r\n    }\r\n    \r\n    return badges.length > 0 ? (\r\n      <div className=\"flex items-center gap-2 flex-wrap\">\r\n        {badges}\r\n      </div>\r\n    ) : undefined;\r\n  }, [customer?.status, slaEntry]);\r\n\r\n  usePageHeader({\r\n    title: customer?.name || 'Chi tiết Khách hàng',\r\n    subtitle: customer?.tags?.length ? customer.tags.join(', ') : undefined,\r\n    badge: headerBadges,\r\n    breadcrumb: [\r\n      { label: 'Trang chủ', href: '/', isCurrent: false },\r\n      { label: 'Khách hàng', href: '/customers', isCurrent: false },\r\n      { label: customer?.name || 'Chi tiết', href: '', isCurrent: true },\r\n    ],\r\n    actions: headerActions,\r\n  });\r\n\r\n  if (!customer) {\r\n    return (\r\n      <div className=\"flex h-full items-center justify-center\">\r\n        <div className=\"text-center\">\r\n          <h2 className=\"text-2xl font-bold\">Không tìm thấy khách hàng</h2>\r\n          <Button onClick={() => router.push('/customers')} className=\"mt-4\">\r\n            <ArrowLeft className=\"mr-2 h-4 w-4\" />\r\n            Quay về danh sách\r\n          </Button>\r\n        </div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  // Tính tổng giá trị hàng đã trả\r\n  const totalReturnedValue = React.useMemo(\r\n    () => customerSalesReturns.reduce((sum, sr) => sum + sr.totalReturnValue, 0),\r\n    [customerSalesReturns]\r\n  );\r\n\r\n  // Chi tiêu = Tổng đơn hàng - Giá trị hàng trả\r\n  const totalSpent = React.useMemo(\r\n    () => deliveredCustomerOrders.reduce((sum, order) => sum + (order.grandTotal || 0), 0) - totalReturnedValue,\r\n    [deliveredCustomerOrders, totalReturnedValue]\r\n  );\r\n\r\n  const currentDebt = React.useMemo(() => \r\n    customerDebtTransactions.length > 0 ? customerDebtTransactions[0].balance : 0,\r\n    [customerDebtTransactions]\r\n  );\r\n  const unresolvedFailedDeliveries = failedDeliveryOrders.length;\r\n  const totalFailedDeliveries = React.useMemo(\r\n    () => (customer?.failedDeliveries ?? unresolvedFailedDeliveries),\r\n    [customer?.failedDeliveries, unresolvedFailedDeliveries]\r\n  );\r\n  const orderStatusEntries = React.useMemo(\r\n    () => ([\r\n      { key: 'hoanThanh', label: 'Hoàn thành', count: orderStatusBreakdown.hoanThanh, status: 'Hoàn thành' as OrderMainStatus },\r\n      { key: 'dangGiaoDich', label: 'Đang giao dịch', count: orderStatusBreakdown.dangGiaoDich, status: 'Đang giao dịch' as OrderMainStatus },\r\n      { key: 'datHang', label: 'Đặt hàng', count: orderStatusBreakdown.datHang, status: 'Đặt hàng' as OrderMainStatus },\r\n      { key: 'daHuy', label: 'Đã hủy', count: orderStatusBreakdown.daHuy, status: 'Đã hủy' as OrderMainStatus },\r\n    ]),\r\n    [orderStatusBreakdown]\r\n  );\r\n\r\n  // DEBUG: Check if values are calculated\r\n  // console.log('CustomerDetail Debug:', { \r\n  //   realtimeChurnRisk, \r\n  //   realtimeHealthScore,\r\n  //   slaLogsCount: getActivityLogs(customer?.systemId).length \r\n  // });\r\n\r\n  return (\r\n    <>\r\n      {/* Delete Confirmation Dialog */}\r\n      <AlertDialog open={deleteDialogOpen} onOpenChange={setDeleteDialogOpen}>\r\n        <AlertDialogContent>\r\n          <AlertDialogHeader>\r\n            <AlertDialogTitle>Chuyển vào thùng rác</AlertDialogTitle>\r\n            <AlertDialogDescription>\r\n              Bạn có chắc chắn muốn chuyển khách hàng <strong>{customer.name}</strong> ({customer.id}) vào thùng rác?\r\n              Bạn có thể khôi phục lại sau trong mục Thùng rác.\r\n            </AlertDialogDescription>\r\n          </AlertDialogHeader>\r\n          <AlertDialogFooter>\r\n            <AlertDialogCancel>Hủy</AlertDialogCancel>\r\n            <AlertDialogAction onClick={handleDeleteCustomer} className=\"bg-destructive text-destructive-foreground hover:bg-destructive/90\">\r\n              Chuyển vào thùng rác\r\n            </AlertDialogAction>\r\n          </AlertDialogFooter>\r\n        </AlertDialogContent>\r\n      </AlertDialog>\r\n\r\n      <div className=\"w-full h-full\">\r\n        <div className=\"space-y-6\">\r\n          {/* Stats Summary - Compact layout */}\r\n          <div className=\"grid grid-cols-3 md:grid-cols-6 gap-2\">\r\n            {/* Tổng chi tiêu */}\r\n            <Card\r\n              role=\"button\"\r\n              tabIndex={0}\r\n              onClick={() => handleOrderStatusFilter('Hoàn thành')}\r\n              className=\"cursor-pointer transition hover:border-primary/50\"\r\n            >\r\n              <CardContent className=\"p-3\">\r\n                <div className=\"text-[11px] text-muted-foreground\">Chi tiêu</div>\r\n                <div className=\"text-body-base font-bold\">{formatCurrency(totalSpent)}</div>\r\n              </CardContent>\r\n            </Card>\r\n\r\n            {/* Đơn hàng */}\r\n            <Card\r\n              role=\"button\"\r\n              tabIndex={0}\r\n              onClick={() => handleOrderStatusFilter()}\r\n              className=\"cursor-pointer transition hover:border-primary/50\"\r\n            >\r\n              <CardContent className=\"p-3\">\r\n                <div className=\"text-[11px] text-muted-foreground\">Đơn hàng</div>\r\n                <div className=\"flex items-baseline gap-2\">\r\n                  <span className=\"text-body-base font-bold\">{customerOrders.length}</span>\r\n                  {orderStatusBreakdown.hoanThanh > 0 && (\r\n                    <span className=\"text-[10px] text-green-600\">Hoàn thành: {orderStatusBreakdown.hoanThanh}</span>\r\n                  )}\r\n                </div>\r\n              </CardContent>\r\n            </Card>\r\n\r\n            {/* Công nợ */}\r\n            <Card\r\n              role=\"button\"\r\n              tabIndex={0}\r\n              onClick={handleDebtCardClick}\r\n              className=\"cursor-pointer transition hover:border-primary/50\"\r\n            >\r\n              <CardContent className=\"p-3\">\r\n                <div className=\"text-[11px] text-muted-foreground\">Công nợ</div>\r\n                <div className=\"text-body-base font-bold\">{formatCurrency(currentDebt)}</div>\r\n              </CardContent>\r\n            </Card>\r\n\r\n            {/* Bảo hành */}\r\n            <Card\r\n              role=\"button\"\r\n              tabIndex={0}\r\n              onClick={() => handleWarrantyCardClick(false)}\r\n              className=\"cursor-pointer transition hover:border-primary/50\"\r\n            >\r\n              <CardContent className=\"p-3\">\r\n                <div className=\"text-[11px] text-muted-foreground\">Bảo hành</div>\r\n                <div className=\"flex items-baseline gap-2\">\r\n                  <span className=\"text-body-base font-bold\">{customerWarrantyTickets.length}</span>\r\n                  {activeWarrantyCount > 0 && (\r\n                    <span className=\"text-[10px] text-orange-600\">Chưa xử lý: {activeWarrantyCount}</span>\r\n                  )}\r\n                </div>\r\n              </CardContent>\r\n            </Card>\r\n\r\n            {/* Khiếu nại */}\r\n            <Card\r\n              role=\"button\"\r\n              tabIndex={0}\r\n              onClick={() => handleComplaintCardClick(false)}\r\n              className=\"cursor-pointer transition hover:border-primary/50\"\r\n            >\r\n              <CardContent className=\"p-3\">\r\n                <div className=\"text-[11px] text-muted-foreground\">Khiếu nại</div>\r\n                <div className=\"flex items-baseline gap-2\">\r\n                  <span className=\"text-body-base font-bold\">{customerComplaints.length}</span>\r\n                  {activeComplaintCount > 0 && (\r\n                    <span className=\"text-[10px] text-red-600\">Đang xử lý: {activeComplaintCount}</span>\r\n                  )}\r\n                </div>\r\n              </CardContent>\r\n            </Card>\r\n\r\n            {/* Giao hàng thất bại */}\r\n            <Card\r\n              role=\"button\"\r\n              tabIndex={0}\r\n              onClick={() => handleOrderStatusFilter('failed')}\r\n              className=\"cursor-pointer transition hover:border-primary/50\"\r\n            >\r\n              <CardContent className=\"p-3\">\r\n                <div className=\"text-[11px] text-muted-foreground\">GH lỗi</div>\r\n                <div className=\"flex items-baseline gap-2\">\r\n                  <span className=\"text-body-base font-bold\">{totalFailedDeliveries}</span>\r\n                  {unresolvedFailedDeliveries > 0 && (\r\n                    <span className=\"text-[10px] text-orange-600\">chờ giao lại: {unresolvedFailedDeliveries}</span>\r\n                  )}\r\n                </div>\r\n              </CardContent>\r\n            </Card>\r\n          </div>\r\n\r\n        {/* Tabs */}\r\n        <Tabs value={activeTab} onValueChange={setActiveTab} className=\"w-full\">\r\n          <TabsList className=\"w-full justify-start overflow-x-auto\">\r\n            <TabsTrigger value=\"info\">Thông tin</TabsTrigger>\r\n            <TabsTrigger value=\"business\">Doanh nghiệp</TabsTrigger>\r\n            <TabsTrigger value=\"payment\">Thanh toán</TabsTrigger>\r\n            <TabsTrigger value=\"purchase-history\">Đơn hàng</TabsTrigger>\r\n            <TabsTrigger value=\"debt\">Công nợ</TabsTrigger>\r\n            <TabsTrigger value=\"sla\">SLA</TabsTrigger>\r\n            <TabsTrigger value=\"contacts\">Liên hệ</TabsTrigger>\r\n            <TabsTrigger value=\"addresses\">Địa chỉ</TabsTrigger>\r\n            <TabsTrigger value=\"products\">Sản phẩm</TabsTrigger>\r\n            <TabsTrigger value=\"warranty\">Bảo hành</TabsTrigger>\r\n            <TabsTrigger value=\"complaints\">Khiếu nại</TabsTrigger>\r\n          </TabsList>\r\n\r\n          {/* Tab: Thông tin chung */}\r\n          <TabsContent value=\"info\" id=\"customer-tab-info\" className=\"space-y-6 mt-6\">\r\n            {/* Images Section */}\r\n            {customer.images && customer.images.length > 0 && (\r\n              <Card>\r\n                <CardHeader className=\"pb-3\">\r\n                  <CardTitle className=\"text-body-base font-medium\">Hình ảnh</CardTitle>\r\n                </CardHeader>\r\n                <CardContent>\r\n                  <div className=\"grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-3\">\r\n                    {customer.images.map((url, index) => (\r\n                      <div\r\n                        key={index}\r\n                        className=\"relative aspect-square rounded-lg overflow-hidden border bg-muted cursor-pointer hover:opacity-90 transition-opacity\"\r\n                        onClick={() => window.open(url, '_blank')}\r\n                      >\r\n                        <ProgressiveImage\r\n                          src={url}\r\n                          alt={`${customer.name} - ${index + 1}`}\r\n                          className=\"w-full h-full object-cover\"\r\n                        />\r\n                        {index === 0 && (\r\n                          <Badge className=\"absolute top-1.5 left-1.5 text-body-xs\" variant=\"secondary\">\r\n                            Chính\r\n                          </Badge>\r\n                        )}\r\n                      </div>\r\n                    ))}\r\n                  </div>\r\n                </CardContent>\r\n              </Card>\r\n            )}\r\n\r\n            {/* Thông tin cơ bản - Grid layout clean với icon copy */}\r\n            <Card>\r\n              <CardHeader className=\"pb-3\">\r\n                <CardTitle className=\"text-body-base font-medium\">Thông tin cơ bản</CardTitle>\r\n              </CardHeader>\r\n              <CardContent>\r\n                <dl className=\"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-x-6 gap-y-4\">\r\n                  <CopyableText label=\"Mã khách hàng\" value={customer.id} />\r\n                  <CopyableText label=\"Tên khách hàng\" value={customer.name} />\r\n                  <CopyableText label=\"Email\" value={customer.email} />\r\n                  <CopyableText label=\"Số điện thoại\" value={customer.phone} />\r\n                  <CopyableText label=\"Zalo\" value={customer.zaloPhone} />\r\n                </dl>\r\n              </CardContent>\r\n            </Card>\r\n\r\n            {/* Phân loại */}\r\n            <Card>\r\n              <CardHeader className=\"pb-3\">\r\n                <CardTitle className=\"text-body-base font-medium\">Phân loại</CardTitle>\r\n              </CardHeader>\r\n              <CardContent>\r\n                <dl className=\"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-x-6 gap-y-4\">\r\n                  <DetailItem label=\"Loại khách hàng\" value={getTypeName(customer.type)} />\r\n                  <DetailItem label=\"Nhóm khách hàng\" value={getGroupName(customer.customerGroup)} />\r\n                  <DetailItem label=\"Nguồn\" value={getSourceName(customer.source)} />\r\n                  <DetailItem label=\"Chiến dịch\" value={customer.campaign} />\r\n                  <DetailItem \r\n                    label=\"Người giới thiệu\" \r\n                    value={customer.referredBy ? findById(asSystemId(customer.referredBy))?.name : undefined}\r\n                    onClick={customer.referredBy ? () => router.push(`/customers/${customer.referredBy}`) : undefined}\r\n                  />\r\n                  <DetailItem label=\"Bảng giá\" value={customer.pricingLevel} />\r\n                </dl>\r\n              </CardContent>\r\n            </Card>\r\n\r\n            {/* Chỉ số khách hàng - Tính toán REALTIME */}\r\n            <Card>\r\n              <CardHeader className=\"pb-3\">\r\n                <CardTitle className=\"text-body-base font-medium\">Chỉ số khách hàng</CardTitle>\r\n                <p className=\"text-body-xs text-muted-foreground mt-1\">Phân tích hành vi mua hàng để đánh giá mức độ trung thành và rủi ro (tính toán realtime)</p>\r\n              </CardHeader>\r\n              <CardContent>\r\n                <dl className=\"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-x-6 gap-y-4\">\r\n                  {/* Điểm sức khỏe KH - với Tooltip */}\r\n                  <div className=\"space-y-1\">\r\n                    <dt className=\"text-body-sm text-muted-foreground flex items-center gap-1\">\r\n                      Điểm sức khỏe KH\r\n                      <TooltipProvider delayDuration={0}>\r\n                        <Tooltip>\r\n                          <TooltipTrigger asChild>\r\n                            <HelpCircle className=\"h-3.5 w-3.5 text-muted-foreground cursor-help\" />\r\n                          </TooltipTrigger>\r\n                          <TooltipContent side=\"top\" className=\"max-w-xs\">\r\n                            <div className=\"text-body-xs space-y-1\">\r\n                              <p className=\"font-semibold\">Cách tính điểm (tổng 100):</p>\r\n                              <ul className=\"list-disc list-inside space-y-0.5\">\r\n                                <li><strong>Recency (30đ):</strong> Thời gian từ lần mua gần nhất</li>\r\n                                <li><strong>Frequency (25đ):</strong> Tổng số đơn hàng</li>\r\n                                <li><strong>Monetary (30đ):</strong> Tổng chi tiêu</li>\r\n                                <li><strong>Payment (15đ):</strong> Tỷ lệ sử dụng hạn mức công nợ</li>\r\n                              </ul>\r\n                            </div>\r\n                          </TooltipContent>\r\n                        </Tooltip>\r\n                      </TooltipProvider>\r\n                    </dt>\r\n                    <dd>\r\n                      <span className={`text-h4 font-bold ${realtimeHealthScore >= 70 ? 'text-green-600' : realtimeHealthScore >= 40 ? 'text-yellow-600' : 'text-red-600'}`}>\r\n                        {realtimeHealthScore}/100\r\n                      </span>\r\n                      <p className=\"text-body-xs text-muted-foreground mt-1\">\r\n                        {getHealthScoreLevel(realtimeHealthScore).label}\r\n                      </p>\r\n                    </dd>\r\n                  </div>\r\n\r\n                  {/* Vòng đời khách hàng */}\r\n                  <div className=\"space-y-1\">\r\n                    <dt className=\"text-body-sm text-muted-foreground\">Vòng đời</dt>\r\n                    <dd>\r\n                      <Badge variant={getLifecycleStageVariant(realtimeLifecycleStage || undefined)}>{realtimeLifecycleStage}</Badge>\r\n                      <p className=\"text-body-xs text-muted-foreground mt-1\">\r\n                        {daysSinceLastPurchase !== null \r\n                          ? `Mua cách đây ${daysSinceLastPurchase} ngày`\r\n                          : 'Chưa mua hàng'}\r\n                      </p>\r\n                    </dd>\r\n                  </div>\r\n\r\n                  {/* Phân khúc RFM */}\r\n                  {realtimeSegment && (\r\n                    <div className=\"space-y-1\">\r\n                      <dt className=\"text-body-sm text-muted-foreground\">Phân khúc RFM</dt>\r\n                      <dd>\r\n                        <Badge variant={getSegmentBadgeVariant(realtimeSegment)}>{getSegmentLabel(realtimeSegment)}</Badge>\r\n                        <p className=\"text-body-xs text-muted-foreground mt-1\">{realtimeSegment}</p>\r\n                      </dd>\r\n                    </div>\r\n                  )}\r\n\r\n                  {/* Điểm RFM */}\r\n                  {realtimeRFMScores && (\r\n                    <div className=\"space-y-1\">\r\n                      <dt className=\"text-body-sm text-muted-foreground\">Điểm RFM</dt>\r\n                      <dd>\r\n                        <div className=\"flex flex-wrap gap-1\">\r\n                          <Badge variant=\"outline\" title=\"Recency - Thời gian từ lần mua gần nhất (1-5, cao = mua gần đây)\">R: {realtimeRFMScores.recency}</Badge>\r\n                          <Badge variant=\"outline\" title=\"Frequency - Tần suất mua hàng (1-5, cao = mua thường xuyên)\">F: {realtimeRFMScores.frequency}</Badge>\r\n                          <Badge variant=\"outline\" title=\"Monetary - Giá trị đơn hàng (1-5, cao = chi tiêu nhiều)\">M: {realtimeRFMScores.monetary}</Badge>\r\n                        </div>\r\n                      </dd>\r\n                    </div>\r\n                  )}\r\n\r\n                  {/* Rủi ro rời bỏ */}\r\n                  {realtimeChurnRisk && (\r\n                    <div className=\"space-y-1\">\r\n                      <dt className=\"text-body-sm text-muted-foreground flex items-center gap-1\">\r\n                        Rủi ro rời bỏ\r\n                        <TooltipProvider delayDuration={0}>\r\n                          <Tooltip>\r\n                            <TooltipTrigger asChild>\r\n                              <HelpCircle className=\"h-3.5 w-3.5 text-muted-foreground cursor-help\" />\r\n                            </TooltipTrigger>\r\n                            <TooltipContent side=\"top\" className=\"max-w-sm p-4\">\r\n                              <div className=\"text-body-xs space-y-3\">\r\n                                <p className=\"font-semibold text-base\">Cách tính điểm sức khỏe (Health Score):</p>\r\n                                \r\n                                <div className=\"space-y-1\">\r\n                                  <p className=\"font-medium\">1. Recency (Thời gian mua gần nhất) - Tối đa 30đ:</p>\r\n                                  <ul className=\"list-disc list-inside pl-1 text-muted-foreground\">\r\n                                    <li>Mua trong 7 ngày: +30đ</li>\r\n                                    <li>Mua trong 30 ngày: +25đ</li>\r\n                                    <li>...giảm dần...</li>\r\n                                    <li>Trên 1 năm: +5đ</li>\r\n                                  </ul>\r\n                                </div>\r\n\r\n                                <div className=\"space-y-1\">\r\n                                  <p className=\"font-medium\">2. Frequency (Tần suất mua) - Tối đa 25đ:</p>\r\n                                  <ul className=\"list-disc list-inside pl-1 text-muted-foreground\">\r\n                                    <li>Trên 20 đơn: +25đ</li>\r\n                                    <li>Trên 10 đơn: +20đ</li>\r\n                                    <li>...giảm dần...</li>\r\n                                  </ul>\r\n                                </div>\r\n\r\n                                <div className=\"space-y-1\">\r\n                                  <p className=\"font-medium\">3. Monetary (Tổng chi tiêu) - Tối đa 30đ:</p>\r\n                                  <ul className=\"list-disc list-inside pl-1 text-muted-foreground\">\r\n                                    <li>Trên 500 triệu: +30đ</li>\r\n                                    <li>Trên 200 triệu: +25đ</li>\r\n                                    <li>...giảm dần...</li>\r\n                                  </ul>\r\n                                </div>\r\n\r\n                                <div className=\"space-y-1\">\r\n                                  <p className=\"font-medium\">4. Payment Behavior (Hành vi thanh toán) - Tối đa 15đ:</p>\r\n                                  <p className=\"text-muted-foreground mb-1\">Dựa trên tỷ lệ nợ hiện tại / hạn mức tín dụng.</p>\r\n                                  <ul className=\"list-disc list-inside pl-1 text-muted-foreground\">\r\n                                    <li>Dùng &lt; 20% hạn mức: +15đ (Tốt)</li>\r\n                                    <li>Dùng &gt; 80% hạn mức: 0đ (Rủi ro)</li>\r\n                                    <li>Nếu không có hạn mức nợ: Mặc định +15đ</li>\r\n                                  </ul>\r\n                                </div>\r\n                              </div>\r\n                            </TooltipContent>\r\n                          </Tooltip>\r\n                        </TooltipProvider>\r\n                      </dt>\r\n                      <dd>\r\n                        <Badge variant={realtimeChurnRisk.variant}>\r\n                          {realtimeChurnRisk.label}\r\n                        </Badge>\r\n                        <p className=\"text-body-xs text-muted-foreground mt-1\">\r\n                          {realtimeChurnRisk.reason}\r\n                        </p>\r\n                      </dd>\r\n                    </div>\r\n                  )}\r\n\r\n                  {/* Tỷ lệ công nợ/Hạn mức */}\r\n                  {customer.maxDebt && customer.maxDebt > 0 && (\r\n                    <div className=\"space-y-1\">\r\n                      <dt className=\"text-body-sm text-muted-foreground\">Tỷ lệ công nợ/Hạn mức</dt>\r\n                      <dd>\r\n                        {(() => {\r\n                          const debtRatio = ((currentDebt || 0) / customer.maxDebt) * 100;\r\n                          const variant = debtRatio >= 90 ? 'destructive' : debtRatio >= 70 ? 'warning' : 'success';\r\n                          return (\r\n                            <>\r\n                              <span className={`text-h4 font-bold ${variant === 'destructive' ? 'text-red-600' : variant === 'warning' ? 'text-yellow-600' : 'text-green-600'}`}>\r\n                                {debtRatio.toFixed(0)}%\r\n                              </span>\r\n                              <p className=\"text-body-xs text-muted-foreground mt-1\">\r\n                                {formatCurrency(currentDebt)} / {formatCurrency(customer.maxDebt)}\r\n                              </p>\r\n                            </>\r\n                          );\r\n                        })()}\r\n                      </dd>\r\n                    </div>\r\n                  )}\r\n                </dl>\r\n              </CardContent>\r\n            </Card>\r\n\r\n            {/* Ngân hàng & Mạng xã hội */}\r\n            {(customer.bankName || customer.bankAccount || customer.social?.website || customer.social?.facebook || customer.social?.linkedin) && (\r\n              <Card>\r\n                <CardHeader className=\"pb-3\">\r\n                  <CardTitle className=\"text-body-base font-medium\">Ngân hàng & Mạng xã hội</CardTitle>\r\n                </CardHeader>\r\n                <CardContent>\r\n                  <dl className=\"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-x-6 gap-y-4\">\r\n                    <DetailItem label=\"Ngân hàng\" value={customer.bankName} />\r\n                    <CopyableText label=\"Số tài khoản\" value={customer.bankAccount} />\r\n                    {customer.social?.website && (\r\n                      <div className=\"space-y-1\">\r\n                        <dt className=\"text-body-sm text-muted-foreground\">Website</dt>\r\n                        <dd>\r\n                          <a \r\n                            href={customer.social.website.startsWith('http') ? customer.social.website : `https://${customer.social.website}`}\r\n                            target=\"_blank\"\r\n                            rel=\"noopener noreferrer\"\r\n                            className=\"text-body-sm text-primary hover:underline inline-flex items-center gap-1\"\r\n                          >\r\n                            {customer.social.website}\r\n                            <ExternalLink className=\"h-3 w-3\" />\r\n                          </a>\r\n                        </dd>\r\n                      </div>\r\n                    )}\r\n                    {customer.social?.facebook && (\r\n                      <div className=\"space-y-1\">\r\n                        <dt className=\"text-body-sm text-muted-foreground\">Facebook</dt>\r\n                        <dd>\r\n                          <a \r\n                            href={customer.social.facebook.startsWith('http') ? customer.social.facebook : `https://facebook.com/${customer.social.facebook}`}\r\n                            target=\"_blank\"\r\n                            rel=\"noopener noreferrer\"\r\n                            className=\"text-body-sm text-primary hover:underline inline-flex items-center gap-1\"\r\n                          >\r\n                            {customer.social.facebook}\r\n                            <ExternalLink className=\"h-3 w-3\" />\r\n                          </a>\r\n                        </dd>\r\n                      </div>\r\n                    )}\r\n                    {customer.social?.linkedin && (\r\n                      <DetailItem label=\"Instagram\" value={customer.social.linkedin} />\r\n                    )}\r\n                  </dl>\r\n                </CardContent>\r\n              </Card>\r\n            )}\r\n\r\n            {/* Thống kê mua hàng */}\r\n            <Card>\r\n              <CardHeader className=\"pb-3\">\r\n                <CardTitle className=\"text-body-base font-medium\">Thống kê mua hàng</CardTitle>\r\n              </CardHeader>\r\n              <CardContent>\r\n                <dl className=\"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-x-6 gap-y-4\">\r\n                  <DetailItem label=\"Tổng đơn hàng\" value={customer.totalOrders?.toString()} />\r\n                  <DetailItem label=\"Tổng chi tiêu\" value={formatCurrency(customer.totalSpent)} />\r\n                  <DetailItem label=\"SL đã mua\" value={customer.totalQuantityPurchased?.toString()} />\r\n                  <DetailItem label=\"SL trả lại\" value={customer.totalQuantityReturned?.toString()} />\r\n                  <DetailItem label=\"Lần mua gần nhất\" value={formatDateUtil(customer.lastPurchaseDate)} />\r\n                  <DetailItem label=\"Giao hàng thất bại\" value={customer.failedDeliveries?.toString()} />\r\n                </dl>\r\n              </CardContent>\r\n            </Card>\r\n\r\n            {/* Quản lý */}\r\n            <Card>\r\n              <CardHeader className=\"pb-3\">\r\n                <CardTitle className=\"text-body-base font-medium\">Quản lý</CardTitle>\r\n              </CardHeader>\r\n              <CardContent>\r\n                <dl className=\"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-x-6 gap-y-4\">\r\n                  <DetailItem \r\n                    label=\"NV phụ trách\" \r\n                    value={customer.accountManagerName || getEmployeeName(customer.accountManagerId)}\r\n                    onClick={customer.accountManagerId ? () => router.push(`/employees/${customer.accountManagerId}`) : undefined}\r\n                  />\r\n                  <DetailItem label=\"Ngày tạo\" value={formatDateUtil(customer.createdAt)} />\r\n                  <DetailItem \r\n                    label=\"Người tạo\" \r\n                    value={getEmployeeName(customer.createdBy)}\r\n                    onClick={customer.createdBy ? () => router.push(`/employees/${customer.createdBy}`) : undefined}\r\n                  />\r\n                  <DetailItem label=\"Cập nhật\" value={formatDateUtil(customer.updatedAt)} />\r\n                  <DetailItem \r\n                    label=\"Người cập nhật\" \r\n                    value={getEmployeeName(customer.updatedBy)}\r\n                    onClick={customer.updatedBy ? () => router.push(`/employees/${customer.updatedBy}`) : undefined}\r\n                  />\r\n                </dl>\r\n              </CardContent>\r\n            </Card>\r\n\r\n            {/* Ghi chú */}\r\n            {customer.notes && (\r\n              <Card>\r\n                <CardHeader className=\"pb-3\">\r\n                  <CardTitle className=\"text-body-base font-medium\">Ghi chú</CardTitle>\r\n                </CardHeader>\r\n                <CardContent>\r\n                  <p className=\"text-body-sm text-muted-foreground whitespace-pre-wrap\">{sanitizeToText(customer.notes)}</p>\r\n                </CardContent>\r\n              </Card>\r\n            )}\r\n          </TabsContent>\r\n\r\n          {/* Tab: Thông tin doanh nghiệp */}\r\n          <TabsContent value=\"business\" id=\"customer-tab-business\" className=\"space-y-6 mt-6\">\r\n            {(customer.company || customer.taxCode || customer.representative || customer.position) ? (\r\n              <Card>\r\n                <CardHeader className=\"pb-3\">\r\n                  <CardTitle className=\"text-body-base font-medium\">Thông tin doanh nghiệp</CardTitle>\r\n                </CardHeader>\r\n                <CardContent>\r\n                  <dl className=\"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-x-6 gap-y-4\">\r\n                    <CopyableText label=\"Công ty\" value={customer.company} />\r\n                    <CopyableText label=\"Mã số thuế\" value={customer.taxCode} />\r\n                    <DetailItem label=\"Người đại diện\" value={customer.representative} />\r\n                    <DetailItem label=\"Chức vụ\" value={customer.position} />\r\n                  </dl>\r\n                </CardContent>\r\n              </Card>\r\n            ) : (\r\n              <Card>\r\n                <CardContent className=\"py-12\">\r\n                  <div className=\"text-center text-muted-foreground\">\r\n                    <p>Chưa có thông tin doanh nghiệp</p>\r\n                  </div>\r\n                </CardContent>\r\n              </Card>\r\n            )}\r\n\r\n            {/* Hợp đồng */}\r\n            {customer.contract && (\r\n              <Card>\r\n                <CardHeader className=\"pb-3\">\r\n                  <CardTitle className=\"text-body-base font-medium\">Hợp đồng</CardTitle>\r\n                </CardHeader>\r\n                <CardContent>\r\n                  <dl className=\"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-x-6 gap-y-4\">\r\n                    <DetailItem label=\"Số hợp đồng\" value={customer.contract.number} />\r\n                    <DetailItem label=\"Ngày bắt đầu\" value={formatDateUtil(customer.contract.startDate)} />\r\n                    <DetailItem label=\"Ngày kết thúc\" value={formatDateUtil(customer.contract.endDate)} />\r\n                    <DetailItem label=\"Giá trị\" value={formatCurrency(customer.contract.value)} />\r\n                    {customer.contract.fileUrl && (\r\n                      <div className=\"space-y-1\">\r\n                        <dt className=\"text-body-sm text-muted-foreground\">File hợp đồng</dt>\r\n                        <dd>\r\n                          <a \r\n                            href={customer.contract.fileUrl} \r\n                            target=\"_blank\" \r\n                            rel=\"noopener noreferrer\"\r\n                            className=\"text-body-sm text-primary hover:underline inline-flex items-center gap-1\"\r\n                          >\r\n                            Xem tài liệu <ExternalLink className=\"h-3 w-3\" />\r\n                          </a>\r\n                        </dd>\r\n                      </div>\r\n                    )}\r\n                    {customer.contract.status && (\r\n                      <div className=\"space-y-1\">\r\n                        <dt className=\"text-body-sm text-muted-foreground\">Trạng thái</dt>\r\n                        <dd>\r\n                          <Badge variant={\r\n                            customer.contract.status === 'Active' ? 'success' :\r\n                            customer.contract.status === 'Expired' ? 'destructive' :\r\n                            customer.contract.status === 'Pending' ? 'warning' :\r\n                            'secondary'\r\n                          }>\r\n                            {customer.contract.status === 'Active' ? 'Đang hiệu lực' : \r\n                             customer.contract.status === 'Expired' ? 'Hết hạn' :\r\n                             customer.contract.status === 'Pending' ? 'Chờ duyệt' :\r\n                             customer.contract.status === 'Cancelled' ? 'Đã hủy' : customer.contract.status}\r\n                          </Badge>\r\n                        </dd>\r\n                      </div>\r\n                    )}\r\n                  </dl>\r\n                  {customer.contract.details && (\r\n                    <div className=\"mt-4 pt-4 border-t\">\r\n                      <div className=\"text-body-sm text-muted-foreground mb-1\">Chi tiết điều khoản</div>\r\n                      <p className=\"text-body-sm whitespace-pre-wrap\">{customer.contract.details}</p>\r\n                    </div>\r\n                  )}\r\n                </CardContent>\r\n              </Card>\r\n            )}\r\n          </TabsContent>\r\n\r\n          {/* Tab: Thanh toán */}\r\n          <TabsContent value=\"payment\" id=\"customer-tab-payment\" className=\"space-y-6 mt-6\">\r\n            <Card>\r\n              <CardHeader className=\"pb-3\">\r\n                <CardTitle className=\"text-body-base font-medium\">Thanh toán & Tín dụng</CardTitle>\r\n              </CardHeader>\r\n              <CardContent>\r\n                <dl className=\"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-x-6 gap-y-4\">\r\n                  <DetailItem label=\"Hạn thanh toán\" value={getPaymentTermName(customer.paymentTerms)} />\r\n                  <DetailItem label=\"Xếp hạng tín dụng\" value={getCreditRatingName(customer.creditRating)} />\r\n                  <DetailItem label=\"Cho phép công nợ\" value={customer.allowCredit ? 'Có' : 'Không'} />\r\n                  <DetailItem label=\"Giảm giá mặc định\" value={customer.defaultDiscount ? `${customer.defaultDiscount}%` : undefined} />\r\n                  <DetailItem label=\"Công nợ hiện tại\" value={formatCurrency(currentDebt)} />\r\n                  <DetailItem label=\"Hạn mức công nợ\" value={formatCurrency(customer.maxDebt)} />\r\n                </dl>\r\n              </CardContent>\r\n            </Card>\r\n          </TabsContent>\r\n\r\n          {/* Tab: Đơn hàng */}\r\n          <TabsContent value=\"purchase-history\" id=\"customer-tab-purchase-history\" className=\"mt-4\">\r\n            <RelatedDataTable \r\n              data={customerOrdersWithReturns} \r\n              columns={orderColumnsWithReturns} \r\n              searchKeys={['id', 'status', 'deliveryStatus']} \r\n              searchPlaceholder=\"Tìm theo mã ĐH...\" \r\n              dateFilterColumn=\"orderDate\" \r\n              dateFilterTitle=\"Ngày đặt\" \r\n              exportFileName={`Don_hang_${customer.id}`} \r\n              onRowClick={(row) => router.push(`/orders/${row.systemId}`)} \r\n              controlledSearch={orderDrilldownSearch}\r\n              onControlledSearchApplied={handleOrderSearchApplied}\r\n              showCheckbox\r\n              defaultSorting={{ id: 'orderDate', desc: true }}\r\n            />\r\n          </TabsContent>\r\n\r\n          {/* Tab: Công nợ */}\r\n          <TabsContent value=\"debt\" id=\"customer-tab-debt\" className=\"mt-4\">\r\n            <RelatedDataTable \r\n              data={customerDebtTransactions} \r\n              columns={debtColumns} \r\n              searchKeys={['voucherId', 'description', 'creator']} \r\n              searchPlaceholder=\"Tìm giao dịch...\"\r\n              dateFilterColumn=\"createdAt\"\r\n              dateFilterTitle=\"Ngày Ghi nhận\"\r\n              exportFileName={`Cong_no_${customer.id}`}\r\n              showCheckbox\r\n            />\r\n          </TabsContent>\r\n\r\n          {/* Tab: Địa chỉ */}\r\n          <TabsContent value=\"addresses\" id=\"customer-tab-addresses\" className=\"mt-4\">\r\n            <CustomerAddresses \r\n              addresses={customer.addresses || []} \r\n              onUpdate={(newAddresses) => {\r\n                const updatedCustomer = { ...customer, addresses: newAddresses };\r\n                update(asSystemId(customer.systemId), updatedCustomer);\r\n              }}\r\n            />\r\n          </TabsContent>\r\n\r\n          {/* Tab: Sản phẩm đã mua */}\r\n          <TabsContent value=\"products\" id=\"customer-tab-products\" className=\"mt-4\">\r\n            <RelatedDataTable \r\n              data={purchasedProducts} \r\n              columns={productColumns} \r\n              searchKeys={['name', 'orderId']} \r\n              searchPlaceholder=\"Tìm sản phẩm, mã đơn...\" \r\n              exportFileName={`SP_da_mua_${customer.id}`}\r\n              showCheckbox\r\n              defaultSorting={{ id: 'orderDate', desc: true }}\r\n            />\r\n          </TabsContent>\r\n\r\n          {/* Tab: Bảo hành */}\r\n          <TabsContent value=\"warranty\" id=\"customer-tab-warranty\" className=\"mt-4\">\r\n            <RelatedDataTable\r\n              data={warrantyTableData}\r\n              columns={warrantyColumns}\r\n              searchKeys={['id', 'status', 'trackingCode', 'branchName']}\r\n              searchPlaceholder=\"Tìm phiếu bảo hành...\"\r\n              dateFilterColumn=\"createdAt\"\r\n              dateFilterTitle=\"Ngày tạo\"\r\n              exportFileName={`Bao_hanh_${customer.id}`}\r\n              onRowClick={(row) => router.push(`/warranty/${row.systemId}`)}\r\n              controlledSearch={warrantyDrilldownSearch}\r\n              onControlledSearchApplied={handleWarrantySearchApplied}\r\n              showCheckbox\r\n              defaultSorting={{ id: 'createdAt', desc: true }}\r\n            />\r\n          </TabsContent>\r\n\r\n          {/* Tab: SLA */}\r\n          <TabsContent value=\"sla\" id=\"customer-tab-sla\" className=\"mt-4\">\r\n            <CustomerSlaStatusCard customer={customer} />\r\n          </TabsContent>\r\n\r\n          {/* Tab: Liên hệ */}\r\n          <TabsContent value=\"contacts\" id=\"customer-tab-contacts\" className=\"mt-6\">\r\n            <Card>\r\n              <CardHeader className=\"pb-3\">\r\n                <CardTitle className=\"text-body-base font-medium\">Danh sách liên hệ</CardTitle>\r\n              </CardHeader>\r\n              <CardContent>\r\n                {!customer.contacts || customer.contacts.length === 0 ? (\r\n                  <div className=\"text-center py-12 text-muted-foreground\">\r\n                    <p>Chưa có thông tin liên hệ nào</p>\r\n                  </div>\r\n                ) : (\r\n                  <div className=\"grid gap-4 md:grid-cols-2 lg:grid-cols-3\">\r\n                    {customer.contacts.map((contact, index) => (\r\n                      <Card key={index} className=\"relative overflow-hidden\">\r\n                        {contact.isPrimary && (\r\n                          <Badge className=\"absolute top-2 right-2 text-body-xs\" variant=\"success\">\r\n                            Chính\r\n                          </Badge>\r\n                        )}\r\n                        <CardContent className=\"p-4 pt-5\">\r\n                          <div className=\"flex items-start gap-3 mb-3\">\r\n                            <div className=\"h-10 w-10 rounded-full bg-muted flex items-center justify-center text-lg font-semibold text-muted-foreground shrink-0\">\r\n                              {contact.name.charAt(0).toUpperCase()}\r\n                            </div>\r\n                            <div className=\"min-w-0\">\r\n                              <div className=\"font-medium truncate\">{contact.name}</div>\r\n                              <div className=\"text-body-sm text-muted-foreground truncate\">{contact.role}</div>\r\n                            </div>\r\n                          </div>\r\n                          <div className=\"space-y-1.5 text-body-sm\">\r\n                            {contact.phone && (\r\n                              <div className=\"flex items-center gap-2\">\r\n                                <Phone className=\"h-3.5 w-3.5 text-muted-foreground shrink-0\" />\r\n                                <a href={`tel:${contact.phone}`} className=\"hover:underline truncate\">{contact.phone}</a>\r\n                              </div>\r\n                            )}\r\n                            {contact.email && (\r\n                              <div className=\"flex items-center gap-2\">\r\n                                <Mail className=\"h-3.5 w-3.5 text-muted-foreground shrink-0\" />\r\n                                <a href={`mailto:${contact.email}`} className=\"hover:underline truncate\">{contact.email}</a>\r\n                              </div>\r\n                            )}\r\n                          </div>\r\n                        </CardContent>\r\n                      </Card>\r\n                    ))}\r\n                  </div>\r\n                )}\r\n              </CardContent>\r\n            </Card>\r\n          </TabsContent>\r\n\r\n          {/* Tab: Khiếu nại */}\r\n          <TabsContent value=\"complaints\" id=\"customer-tab-complaints\" className=\"mt-4\">\r\n            <RelatedDataTable\r\n              data={complaintTableData}\r\n              columns={complaintColumns}\r\n              searchKeys={['id', 'type', 'assignedName', 'orderCode', 'description']}\r\n              searchPlaceholder=\"Tìm khiếu nại...\"\r\n              dateFilterColumn=\"createdAt\"\r\n              dateFilterTitle=\"Ngày tạo\"\r\n              exportFileName={`Khieu_nai_${customer.id}`}\r\n              onRowClick={(row) => router.push(`/complaints/${row.systemId}`)}\r\n              controlledSearch={complaintDrilldownSearch}\r\n              onControlledSearchApplied={handleComplaintSearchApplied}\r\n              showCheckbox\r\n              defaultSorting={{ id: 'createdAt', desc: true }}\r\n            />\r\n          </TabsContent>\r\n        </Tabs>\r\n\r\n        {/* Comments */}\r\n        <DatabaseComments\r\n          entityType=\"customer\"\r\n          entityId={customer.systemId}\r\n        />\r\n\r\n        {/* Activity History */}\r\n        <ActivityHistory\r\n          history={activityHistory}\r\n          title=\"Lịch sử hoạt động\"\r\n          emptyMessage=\"Chưa có lịch sử hoạt động\"\r\n          groupByDate\r\n          maxHeight=\"600px\"\r\n        />\r\n      </div>\r\n    </div>\r\n    </>\r\n  );\r\n}\r\n"],"names":[],"mappings":"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"}}]
}