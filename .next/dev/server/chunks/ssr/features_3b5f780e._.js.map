{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/employees/store.ts"],"sourcesContent":["import { createCrudStore, CrudState } from '../../lib/store-factory';\r\n// REMOVED: import { data as initialData } from './data'; // Mock data no longer used - database is source of truth\r\nimport type { Employee } from './types';\r\nimport type { HistoryEntry } from '../../components/ActivityHistory';\r\nimport Fuse from 'fuse.js';\r\nimport { getCurrentUserSystemId } from '../../contexts/auth-context';\r\nimport { registerBreadcrumbStore } from '../../lib/breadcrumb-generator'; // ‚úÖ NEW\r\nimport { type SystemId } from '../../lib/id-types';\r\nimport { createInMemoryRepository } from '../../repositories/in-memory-repository';\r\nimport { \r\n  createHistoryEntry, \r\n  getCurrentUserInfo,\r\n  appendHistoryEntry \r\n} from '../../lib/activity-history-helper';\r\n\r\ntype EmployeePersistenceAdapter = {\r\n  create: (payload: Omit<Employee, 'systemId'>) => Promise<Employee>;\r\n  update: (systemId: SystemId, payload: Partial<Employee>) => Promise<Employee>;\r\n  softDelete: (systemId: SystemId) => Promise<void>;\r\n  restore: (systemId: SystemId) => Promise<Employee | undefined>;\r\n  hardDelete: (systemId: SystemId) => Promise<void>;\r\n};\r\n\r\nconst baseStore = createCrudStore<Employee>([], 'employees', {\r\n  businessIdField: 'id',\r\n  getCurrentUser: getCurrentUserSystemId, // ‚úÖ Track who creates/updates\r\n  apiEndpoint: '/api/employees',\r\n});\r\n\r\n// ‚úÖ Wrap add method to include activity history\r\nconst originalAdd = baseStore.getState().add;\r\nconst wrappedAdd = (item: Omit<Employee, 'systemId'>): Employee => {\r\n  const userInfo = getCurrentUserInfo();\r\n  const historyEntry = createHistoryEntry(\r\n    'created',\r\n    `${userInfo.name} ƒë√£ t·∫°o h·ªì s∆° nh√¢n vi√™n ${item.fullName} (${item.id})`,\r\n    userInfo\r\n  );\r\n  \r\n  const newEmployee = originalAdd({\r\n    ...item,\r\n    activityHistory: [historyEntry],\r\n  });\r\n  \r\n  return newEmployee;\r\n};\r\n\r\n// ‚úÖ Wrap update method to include activity history\r\nconst originalUpdate = baseStore.getState().update;\r\nconst wrappedUpdate = (systemId: SystemId, updates: Partial<Employee>): void => {\r\n  const currentEmployee = baseStore.getState().data.find(e => e.systemId === systemId);\r\n  if (!currentEmployee) return;\r\n  \r\n  const userInfo = getCurrentUserInfo();\r\n  const historyEntries: HistoryEntry[] = [];\r\n  \r\n  // Track important field changes\r\n  const trackedFields: { key: keyof Employee; label: string }[] = [\r\n    { key: 'fullName', label: 'h·ªç t√™n' },\r\n    { key: 'jobTitle', label: 'ch·ª©c danh' },\r\n    { key: 'department', label: 'ph√≤ng ban' },\r\n    { key: 'employmentStatus', label: 'tr·∫°ng th√°i l√†m vi·ªác' },\r\n    { key: 'employeeType', label: 'lo·∫°i nh√¢n vi√™n' },\r\n    { key: 'baseSalary', label: 'l∆∞∆°ng c∆° b·∫£n' },\r\n    { key: 'phone', label: 's·ªë ƒëi·ªán tho·∫°i' },\r\n    { key: 'workEmail', label: 'email c√¥ng vi·ªác' },\r\n    { key: 'role', label: 'vai tr√≤' },\r\n  ];\r\n  \r\n  trackedFields.forEach(({ key, label }) => {\r\n    if (updates[key] !== undefined && updates[key] !== currentEmployee[key]) {\r\n      const oldValue = currentEmployee[key];\r\n      const newValue = updates[key];\r\n      \r\n      // Format values for display\r\n      let oldDisplay = oldValue;\r\n      let newDisplay = newValue;\r\n      \r\n      if (key === 'baseSalary') {\r\n        oldDisplay = new Intl.NumberFormat('vi-VN').format(oldValue as number) + 'ƒë';\r\n        newDisplay = new Intl.NumberFormat('vi-VN').format(newValue as number) + 'ƒë';\r\n      }\r\n      \r\n      historyEntries.push(createHistoryEntry(\r\n        'updated',\r\n        `${userInfo.name} ƒë√£ c·∫≠p nh·∫≠t ${label}: \"${oldDisplay || '(tr·ªëng)'}\" ‚Üí \"${newDisplay}\"`,\r\n        userInfo,\r\n        { field: key, oldValue, newValue }\r\n      ));\r\n    }\r\n  });\r\n  \r\n  // If status changed specifically\r\n  if (updates.employmentStatus && updates.employmentStatus !== currentEmployee.employmentStatus) {\r\n    historyEntries.push(createHistoryEntry(\r\n      'status_changed',\r\n      `${userInfo.name} ƒë√£ thay ƒë·ªïi tr·∫°ng th√°i l√†m vi·ªác t·ª´ \"${currentEmployee.employmentStatus}\" th√†nh \"${updates.employmentStatus}\"`,\r\n      userInfo,\r\n      { field: 'employmentStatus', oldValue: currentEmployee.employmentStatus, newValue: updates.employmentStatus }\r\n    ));\r\n  }\r\n  \r\n  // If no specific changes tracked, add generic update entry\r\n  if (historyEntries.length === 0) {\r\n    historyEntries.push(createHistoryEntry(\r\n      'updated',\r\n      `${userInfo.name} ƒë√£ c·∫≠p nh·∫≠t th√¥ng tin nh√¢n vi√™n`,\r\n      userInfo\r\n    ));\r\n  }\r\n  \r\n  const updatedHistory = appendHistoryEntry(currentEmployee.activityHistory, ...historyEntries);\r\n  \r\n  originalUpdate(systemId, {\r\n    ...updates,\r\n    activityHistory: updatedHistory,\r\n  });\r\n};\r\n\r\n// ‚úÖ Override base store methods\r\nbaseStore.setState({\r\n  add: wrappedAdd,\r\n  update: wrappedUpdate,\r\n});\r\n\r\nexport const employeeRepository = createInMemoryRepository<Employee>(() => baseStore.getState());\r\n\r\n// ‚úÖ API-backed persistence adapter - syncs to PostgreSQL\r\nconst API_ENDPOINT = '/api/employees';\r\n\r\nconst persistence: EmployeePersistenceAdapter = {\r\n  create: async (payload) => {\r\n    // First create locally for immediate UI update\r\n    const localResult = await employeeRepository.create(payload);\r\n    \r\n    // Then sync to API (background)\r\n    try {\r\n      const response = await fetch(API_ENDPOINT, {\r\n        method: 'POST',\r\n        credentials: 'include',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({ ...payload, systemId: localResult.systemId }),\r\n      });\r\n      if (!response.ok) {\r\n        console.warn('[Employee API] Create sync failed, data saved locally');\r\n      } else {\r\n        console.log('[Employee API] Created:', localResult.systemId);\r\n      }\r\n    } catch (e) {\r\n      console.warn('[Employee API] Create sync error:', e);\r\n    }\r\n    \r\n    return localResult;\r\n  },\r\n  update: async (systemId, payload) => {\r\n    // First update locally\r\n    const localResult = await employeeRepository.update(systemId, payload);\r\n    \r\n    // Then sync to API\r\n    try {\r\n      const response = await fetch(`${API_ENDPOINT}/${systemId}`, {\r\n        method: 'PATCH',\r\n        credentials: 'include',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify(payload),\r\n      });\r\n      if (!response.ok) {\r\n        console.warn('[Employee API] Update sync failed');\r\n      } else {\r\n        console.log('[Employee API] Updated:', systemId);\r\n      }\r\n    } catch (e) {\r\n      console.warn('[Employee API] Update sync error:', e);\r\n    }\r\n    \r\n    return localResult;\r\n  },\r\n  softDelete: async (systemId) => {\r\n    // First delete locally\r\n    await employeeRepository.softDelete(systemId);\r\n    \r\n    // Then sync to API\r\n    try {\r\n      const response = await fetch(`${API_ENDPOINT}/${systemId}`, {\r\n        method: 'DELETE',\r\n        credentials: 'include',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({ hard: false }),\r\n      });\r\n      if (!response.ok) {\r\n        console.warn('[Employee API] Soft delete sync failed');\r\n      } else {\r\n        console.log('[Employee API] Soft deleted:', systemId);\r\n      }\r\n    } catch (e) {\r\n      console.warn('[Employee API] Soft delete sync error:', e);\r\n    }\r\n  },\r\n  restore: async (systemId) => {\r\n    // First restore locally\r\n    const localResult = await employeeRepository.restore(systemId);\r\n    \r\n    // Then sync to API\r\n    try {\r\n      const response = await fetch(`${API_ENDPOINT}/${systemId}/restore`, {\r\n        method: 'POST',\r\n        credentials: 'include',\r\n        headers: { 'Content-Type': 'application/json' },\r\n      });\r\n      if (!response.ok) {\r\n        console.warn('[Employee API] Restore sync failed');\r\n      } else {\r\n        console.log('[Employee API] Restored:', systemId);\r\n      }\r\n    } catch (e) {\r\n      console.warn('[Employee API] Restore sync error:', e);\r\n    }\r\n    \r\n    return localResult;\r\n  },\r\n  hardDelete: async (systemId) => {\r\n    // First delete locally\r\n    await employeeRepository.hardDelete(systemId);\r\n    \r\n    // Then sync to API\r\n    try {\r\n      const response = await fetch(`${API_ENDPOINT}/${systemId}`, {\r\n        method: 'DELETE',\r\n        credentials: 'include',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({ hard: true }),\r\n      });\r\n      if (!response.ok) {\r\n        console.warn('[Employee API] Hard delete sync failed');\r\n      } else {\r\n        console.log('[Employee API] Hard deleted:', systemId);\r\n      }\r\n    } catch (e) {\r\n      console.warn('[Employee API] Hard delete sync error:', e);\r\n    }\r\n  },\r\n};\r\n\r\n// ‚úÖ Register for breadcrumb auto-generation\r\nregisterBreadcrumbStore('employees', () => baseStore.getState());\r\n\r\n// Define enhanced interface\r\ninterface EmployeeStoreState extends CrudState<Employee> {\r\n  searchEmployees: (query: string, page: number, limit?: number) => Promise<{ items: { value: string; label: string }[], hasNextPage: boolean }>;\r\n  permanentDelete: (systemId: SystemId) => Promise<void>;\r\n  persistence: EmployeePersistenceAdapter;\r\n}\r\n\r\ntype EmployeeStoreHook = (() => EmployeeStoreState) & {\r\n  getState: () => EmployeeStoreState;\r\n  persistence: EmployeePersistenceAdapter;\r\n};\r\n\r\n// Augmented methods\r\nconst augmentedMethods = {\r\n    // FIX: Changed `page: number = 1` to `page: number` to make it a required parameter, matching Combobox prop type.\r\n    // ‚úÖ CRITICAL FIX: Create fresh Fuse instance on each search to avoid stale data\r\n    searchEmployees: async (query: string, page: number, limit: number = 20) => {\r\n        return new Promise<{ items: { value: string; label: string }[], hasNextPage: boolean }>(resolve => {\r\n            setTimeout(() => {\r\n                const allEmployees = baseStore.getState().data;\r\n                \r\n                // ‚úÖ Create fresh Fuse instance with current data\r\n                const fuse = new Fuse(allEmployees, {\r\n                    keys: ['fullName', 'id', 'phone', 'personalEmail', 'workEmail'],\r\n                    threshold: 0.3,\r\n                });\r\n                \r\n                const results = query ? fuse.search(query).map(r => r.item) : allEmployees;\r\n                \r\n                const start = (page - 1) * limit;\r\n                const end = start + limit;\r\n                const paginatedItems = results.slice(start, end);\r\n\r\n                resolve({\r\n                    items: paginatedItems.map(e => ({ value: e.systemId, label: e.fullName })),\r\n                    hasNextPage: end < results.length,\r\n                });\r\n            }, 300);\r\n        });\r\n    },\r\n    permanentDelete: async (systemId: SystemId) => {\r\n        await persistence.hardDelete(systemId);\r\n    }\r\n};\r\n\r\nconst useEmployeeStoreHook = (): EmployeeStoreState => {\r\n  const state = baseStore();\r\n  return {\r\n    ...state,\r\n    ...augmentedMethods, // This includes permanentDelete\r\n    persistence,\r\n  };\r\n};\r\n\r\nexport const useEmployeeStore = useEmployeeStoreHook as EmployeeStoreHook;\r\n\r\n// Export getState for non-hook usage\r\nuseEmployeeStore.getState = (): EmployeeStoreState => {\r\n  const state = baseStore.getState();\r\n  return {\r\n    ...state,\r\n    ...augmentedMethods,\r\n    persistence,\r\n  };\r\n};\r\n\r\nuseEmployeeStore.persistence = persistence;\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 313, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/products/store.ts"],"sourcesContent":["import { createCrudStore, CrudState } from '../../lib/store-factory';\r\n// REMOVED: import { data as initialData } from './data'; // Mock data no longer used - database is source of truth\r\nimport type { Product } from './types';\r\nimport { type SystemId } from '@/lib/id-types';\r\nimport { asSystemId, asBusinessId } from '../../lib/id-types';\r\nimport { getCurrentUserSystemId } from '../../contexts/auth-context';\r\nimport Fuse from 'fuse.js';\r\nimport {\r\n  getCurrentUserInfo,\r\n  createCreatedEntry,\r\n  createUpdatedEntry,\r\n  createStatusChangedEntry,\r\n  appendHistoryEntry,\r\n  type HistoryEntry\r\n} from '../../lib/activity-history-helper';\r\n\r\nconst baseStore = createCrudStore<Product>([], 'products', {\r\n  businessIdField: 'id',\r\n  getCurrentUser: getCurrentUserSystemId, // ‚úÖ Track who creates/updates\r\n  apiEndpoint: '/api/products',\r\n});\r\n\r\n// ‚úÖ API Sync helpers\r\nconst API_ENDPOINT = '/api/products';\r\n\r\nconst syncToApi = {\r\n  create: async (product: Product) => {\r\n    try {\r\n      const response = await fetch(API_ENDPOINT, {\r\n        method: 'POST',\r\n        credentials: 'include',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify(product),\r\n      });\r\n      if (!response.ok) console.warn('[Product API] Create sync failed');\r\n      else console.log('[Product API] Created:', product.systemId);\r\n    } catch (e) {\r\n      console.warn('[Product API] Create sync error:', e);\r\n    }\r\n  },\r\n  update: async (systemId: SystemId, updates: Partial<Product>) => {\r\n    try {\r\n      const response = await fetch(`${API_ENDPOINT}/${systemId}`, {\r\n        method: 'PATCH',\r\n        credentials: 'include',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify(updates),\r\n      });\r\n      if (!response.ok) console.warn('[Product API] Update sync failed');\r\n      else console.log('[Product API] Updated:', systemId);\r\n    } catch (e) {\r\n      console.warn('[Product API] Update sync error:', e);\r\n    }\r\n  },\r\n  delete: async (systemId: SystemId, hard = false) => {\r\n    try {\r\n      const response = await fetch(`${API_ENDPOINT}/${systemId}`, {\r\n        method: 'DELETE',\r\n        credentials: 'include',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({ hard }),\r\n      });\r\n      if (!response.ok) console.warn('[Product API] Delete sync failed');\r\n      else console.log('[Product API] Deleted:', systemId);\r\n    } catch (e) {\r\n      console.warn('[Product API] Delete sync error:', e);\r\n    }\r\n  },\r\n  restore: async (systemId: SystemId) => {\r\n    try {\r\n      const response = await fetch(`${API_ENDPOINT}/${systemId}/restore`, {\r\n        method: 'POST',\r\n        credentials: 'include',\r\n        headers: { 'Content-Type': 'application/json' },\r\n      });\r\n      if (!response.ok) console.warn('[Product API] Restore sync failed');\r\n      else console.log('[Product API] Restored:', systemId);\r\n    } catch (e) {\r\n      console.warn('[Product API] Restore sync error:', e);\r\n    }\r\n  },\r\n};\r\n\r\n// ‚úÖ Wrap base store methods with API sync\r\nconst originalAdd = baseStore.getState().add;\r\nconst originalUpdate = baseStore.getState().update;\r\nconst originalRemove = baseStore.getState().remove;\r\nconst originalHardDelete = baseStore.getState().hardDelete;\r\nconst originalRestore = baseStore.getState().restore;\r\n\r\nbaseStore.setState({\r\n  add: (item: Omit<Product, 'systemId'>) => {\r\n    const result = originalAdd(item);\r\n    syncToApi.create(result);\r\n    return result;\r\n  },\r\n  update: (systemId: SystemId, updates: Partial<Product>) => {\r\n    originalUpdate(systemId, updates);\r\n    syncToApi.update(systemId, updates);\r\n  },\r\n  remove: (systemId: SystemId) => {\r\n    originalRemove(systemId);\r\n    syncToApi.delete(systemId, false);\r\n  },\r\n  hardDelete: (systemId: SystemId) => {\r\n    originalHardDelete(systemId);\r\n    syncToApi.delete(systemId, true);\r\n  },\r\n  restore: (systemId: SystemId) => {\r\n    originalRestore(systemId);\r\n    syncToApi.restore(systemId);\r\n  },\r\n});\r\n\r\n// Define extended store interface\r\nexport interface ProductStoreState extends CrudState<Product> {\r\n  updateInventory: (productSystemId: SystemId, branchSystemId: SystemId, quantityChange: number) => void;\r\n  commitStock: (productSystemId: SystemId, branchSystemId: SystemId, quantity: number) => void;\r\n  uncommitStock: (productSystemId: SystemId, branchSystemId: SystemId, quantity: number) => void;\r\n  dispatchStock: (productSystemId: SystemId, branchSystemId: SystemId, quantity: number) => void;\r\n  completeDelivery: (productSystemId: SystemId, branchSystemId: SystemId, quantity: number) => void;\r\n  returnStockFromTransit: (productSystemId: SystemId, branchSystemId: SystemId, quantity: number) => void;\r\n  updateLastPurchasePrice: (productSystemId: SystemId, price: number, date: string) => void;\r\n  searchProducts: (query: string, page: number, limit?: number) => Promise<{ items: { value: SystemId; label: string }[], hasNextPage: boolean }>;\r\n}\r\n\r\n// Helper to check if product tracks stock\r\nconst canModifyStock = (product: Product | undefined): boolean => {\r\n  if (!product) return false;\r\n  // Services, digital products, and combos don't track stock directly\r\n  if (product.type === 'service' || product.type === 'digital' || product.type === 'combo') return false;\r\n  // Explicitly disabled stock tracking\r\n  if (product.isStockTracked === false) return false;\r\n  return true;\r\n};\r\n\r\n// Define custom methods\r\nconst updateInventory = (productSystemId: SystemId, branchSystemId: SystemId, quantityChange: number) => {\r\n  baseStore.setState(state => {\r\n    const product = state.data.find(p => p.systemId === productSystemId);\r\n    if (!product) return state;\r\n    \r\n    // Skip if product doesn't track stock\r\n    if (!canModifyStock(product)) {\r\n      console.warn(`[updateInventory] Skipped: Product ${productSystemId} does not track stock`);\r\n      return state;\r\n    }\r\n    \r\n    const oldQuantity = product.inventoryByBranch?.[branchSystemId] || 0;\r\n    const newQuantity = oldQuantity + quantityChange;\r\n    \r\n    // ‚úÖ Removed COMPLAINT_ADJUSTMENT stock history creation\r\n    // Stock history will be created by inventory check balance instead\r\n    \r\n    return {\r\n      data: state.data.map(p => {\r\n        if (p.systemId === productSystemId) {\r\n          const newInventoryByBranch = { ...p.inventoryByBranch };\r\n          newInventoryByBranch[branchSystemId] = newQuantity;\r\n          return {\r\n            ...p,\r\n            inventoryByBranch: newInventoryByBranch,\r\n          };\r\n        }\r\n        return p;\r\n      }),\r\n    };\r\n  });\r\n};\r\n\r\nconst commitStock = (productSystemId: SystemId, branchSystemId: SystemId, quantity: number) => {\r\n  baseStore.setState(state => {\r\n    const product = state.data.find(p => p.systemId === productSystemId);\r\n    if (!canModifyStock(product)) {\r\n      console.warn(`[commitStock] Skipped: Product ${productSystemId} does not track stock`);\r\n      return state;\r\n    }\r\n    return {\r\n      data: state.data.map(p => {\r\n        if (p.systemId === productSystemId) {\r\n          const newCommitted = { ...p.committedByBranch };\r\n          newCommitted[branchSystemId] = (newCommitted[branchSystemId] || 0) + quantity;\r\n          return { ...p, committedByBranch: newCommitted };\r\n        }\r\n        return p;\r\n      }),\r\n    };\r\n  });\r\n};\r\n\r\nconst uncommitStock = (productSystemId: SystemId, branchSystemId: SystemId, quantity: number) => {\r\n  baseStore.setState(state => {\r\n    const product = state.data.find(p => p.systemId === productSystemId);\r\n    if (!canModifyStock(product)) {\r\n      console.warn(`[uncommitStock] Skipped: Product ${productSystemId} does not track stock`);\r\n      return state;\r\n    }\r\n    return {\r\n      data: state.data.map(p => {\r\n        if (p.systemId === productSystemId) {\r\n          const newCommitted = { ...p.committedByBranch };\r\n          newCommitted[branchSystemId] = Math.max(0, (newCommitted[branchSystemId] || 0) - quantity);\r\n          return { ...p, committedByBranch: newCommitted };\r\n        }\r\n        return p;\r\n      }),\r\n    };\r\n  });\r\n};\r\n\r\nconst dispatchStock = (productSystemId: SystemId, branchSystemId: SystemId, quantity: number) => {\r\n  console.log('üî¥ [dispatchStock] Called with:', { productSystemId, branchSystemId, quantity });\r\n  \r\n  baseStore.setState(state => {\r\n    const product = state.data.find(p => p.systemId === productSystemId);\r\n    if (!product) {\r\n      console.error('‚ùå [dispatchStock] Product not found:', productSystemId);\r\n      return state;\r\n    }\r\n    \r\n    // Skip if product doesn't track stock\r\n    if (!canModifyStock(product)) {\r\n      console.warn(`[dispatchStock] Skipped: Product ${productSystemId} does not track stock`);\r\n      return state;\r\n    }\r\n    \r\n    console.log('üì¶ [dispatchStock] Current inventory:', product.inventoryByBranch);\r\n    console.log('üì¶ [dispatchStock] Current committed:', product.committedByBranch);\r\n    \r\n    return {\r\n      data: state.data.map(product => {\r\n        if (product.systemId === productSystemId) {\r\n          const newInventory = { ...product.inventoryByBranch };\r\n          const oldInventory = newInventory[branchSystemId] || 0;\r\n          newInventory[branchSystemId] = oldInventory - quantity;\r\n          \r\n          const newCommitted = { ...product.committedByBranch };\r\n          newCommitted[branchSystemId] = Math.max(0, (newCommitted[branchSystemId] || 0) - quantity);\r\n\r\n          const newInTransit = { ...product.inTransitByBranch };\r\n          newInTransit[branchSystemId] = (newInTransit[branchSystemId] || 0) + quantity;\r\n          \r\n          console.log('‚úÖ [dispatchStock] Updated inventory:', {\r\n            old: oldInventory,\r\n            new: newInventory[branchSystemId],\r\n            change: -quantity\r\n          });\r\n          \r\n          return { \r\n            ...product, \r\n            inventoryByBranch: newInventory,\r\n            committedByBranch: newCommitted,\r\n            inTransitByBranch: newInTransit,\r\n          };\r\n        }\r\n        return product;\r\n      }),\r\n    };\r\n  });\r\n  \r\n  console.log('‚úÖ [dispatchStock] Completed');\r\n};\r\n\r\nconst completeDelivery = (productSystemId: SystemId, branchSystemId: SystemId, quantity: number) => {\r\n  baseStore.setState(state => {\r\n    const product = state.data.find(p => p.systemId === productSystemId);\r\n    if (!canModifyStock(product)) {\r\n      return state;\r\n    }\r\n    return {\r\n      data: state.data.map(p => {\r\n        if (p.systemId === productSystemId) {\r\n          const newInTransit = { ...p.inTransitByBranch };\r\n          newInTransit[branchSystemId] = Math.max(0, (newInTransit[branchSystemId] || 0) - quantity);\r\n          return { ...p, inTransitByBranch: newInTransit };\r\n        }\r\n        return p;\r\n      }),\r\n    };\r\n  });\r\n};\r\n\r\nconst returnStockFromTransit = (productSystemId: SystemId, branchSystemId: SystemId, quantity: number) => {\r\n  baseStore.setState(state => {\r\n    const product = state.data.find(p => p.systemId === productSystemId);\r\n    if (!canModifyStock(product)) {\r\n      return state;\r\n    }\r\n    return {\r\n      data: state.data.map(p => {\r\n        if (p.systemId === productSystemId) {\r\n          const newInTransit = { ...p.inTransitByBranch };\r\n          newInTransit[branchSystemId] = Math.max(0, (newInTransit[branchSystemId] || 0) - quantity);\r\n          const newInventory = { ...p.inventoryByBranch };\r\n          newInventory[branchSystemId] = (newInventory[branchSystemId] || 0) + quantity;\r\n          return { ...p, inventoryByBranch: newInventory, inTransitByBranch: newInTransit };\r\n        }\r\n        return p;\r\n      }),\r\n    };\r\n  });\r\n};\r\n\r\nconst updateLastPurchasePrice = (productSystemId: SystemId, price: number, date: string) => {\r\n  baseStore.setState(state => ({\r\n    data: state.data.map(product => {\r\n      if (product.systemId === productSystemId) {\r\n        // Only update if the new date is newer or equal to the existing lastPurchaseDate\r\n        const existingDate = product.lastPurchaseDate ? new Date(product.lastPurchaseDate).getTime() : 0;\r\n        const newDateTs = new Date(date).getTime();\r\n        \r\n        if (newDateTs >= existingDate) {\r\n          return {\r\n            ...product,\r\n            lastPurchasePrice: price,\r\n            lastPurchaseDate: date,\r\n          };\r\n        }\r\n      }\r\n      return product;\r\n    }),\r\n  }));\r\n};\r\n\r\nconst searchProducts = async (query: string, page: number = 1, limit: number = 10): Promise<{ items: { value: SystemId; label: string }[], hasNextPage: boolean }> => {\r\n  const allProducts = baseStore.getState().data;\r\n  \r\n  // ‚úÖ Create fresh Fuse instance with current data (avoid stale data)\r\n  const fuse = new Fuse(allProducts, {\r\n    keys: ['name', 'id', 'sku', 'barcode'],\r\n    threshold: 0.3,\r\n  });\r\n  \r\n  const results = fuse.search(query);\r\n  const startIndex = (page - 1) * limit;\r\n  const endIndex = startIndex + limit;\r\n  const paginatedResults = results.slice(startIndex, endIndex);\r\n\r\n  return {\r\n    items: paginatedResults.map(result => ({\r\n      value: asSystemId(result.item.systemId),\r\n      label: `${result.item.name} (${result.item.id})`,\r\n    })),\r\n    hasNextPage: endIndex < results.length,\r\n  };\r\n};\r\n\r\n// Wrapped add method with activity history logging\r\nconst addProduct = (product: Omit<Product, 'systemId'>) => {\r\n  const userInfo = getCurrentUserInfo();\r\n  const newProduct = baseStore.getState().add(product);\r\n  \r\n  // Add activity history entry\r\n  const historyEntry = createCreatedEntry(\r\n    userInfo,\r\n    `${userInfo.name} ƒë√£ t·∫°o s·∫£n ph·∫©m ${newProduct.name} (${newProduct.id})`\r\n  );\r\n  baseStore.getState().update(newProduct.systemId, {\r\n    ...newProduct,\r\n    activityHistory: [historyEntry]\r\n  });\r\n  \r\n  return newProduct;\r\n};\r\n\r\n// Wrapped update method with activity history logging\r\nconst updateProduct = (systemId: SystemId, updatedProduct: Product) => {\r\n  const userInfo = getCurrentUserInfo();\r\n  const existingProduct = baseStore.getState().data.find(p => p.systemId === systemId);\r\n  const historyEntries: HistoryEntry[] = [];\r\n  \r\n  if (existingProduct) {\r\n    // Track status changes\r\n    if (existingProduct.status !== updatedProduct.status) {\r\n      const statusLabels: Record<string, string> = {\r\n        'active': 'ƒêang kinh doanh',\r\n        'inactive': 'Ng·ª´ng kinh doanh',\r\n        'discontinued': 'Ng·ª´ng s·∫£n xu·∫•t'\r\n      };\r\n      historyEntries.push(createStatusChangedEntry(\r\n        userInfo,\r\n        statusLabels[existingProduct.status || 'active'],\r\n        statusLabels[updatedProduct.status || 'active'],\r\n        `${userInfo.name} ƒë√£ ƒë·ªïi tr·∫°ng th√°i t·ª´ \"${statusLabels[existingProduct.status || 'active']}\" sang \"${statusLabels[updatedProduct.status || 'active']}\"`\r\n      ));\r\n    }\r\n    \r\n    // Track field changes\r\n    const fieldsToTrack: Array<{ key: keyof Product; label: string }> = [\r\n      { key: 'name', label: 'T√™n s·∫£n ph·∫©m' },\r\n      { key: 'id', label: 'M√£ SKU' },\r\n      { key: 'description', label: 'M√¥ t·∫£' },\r\n      { key: 'shortDescription', label: 'M√¥ t·∫£ ng·∫Øn' },\r\n      { key: 'type', label: 'Lo·∫°i s·∫£n ph·∫©m' },\r\n      { key: 'categorySystemId', label: 'Danh m·ª•c' },\r\n      { key: 'brandSystemId', label: 'Th∆∞∆°ng hi·ªáu' },\r\n      { key: 'unit', label: 'ƒê∆°n v·ªã t√≠nh' },\r\n      { key: 'costPrice', label: 'Gi√° v·ªën' },\r\n      { key: 'minPrice', label: 'Gi√° t·ªëi thi·ªÉu' },\r\n      { key: 'barcode', label: 'M√£ v·∫°ch' },\r\n      { key: 'primarySupplierSystemId', label: 'Nh√† cung c·∫•p ch√≠nh' },\r\n      { key: 'warrantyPeriodMonths', label: 'Th·ªùi h·∫°n b·∫£o h√†nh' },\r\n      { key: 'reorderLevel', label: 'M·ª©c ƒë·∫∑t h√†ng l·∫°i' },\r\n      { key: 'safetyStock', label: 'T·ªìn kho an to√†n' },\r\n      { key: 'maxStock', label: 'T·ªìn kho t·ªëi ƒëa' },\r\n    ];\r\n    \r\n    const changes: string[] = [];\r\n    for (const field of fieldsToTrack) {\r\n      const oldVal = existingProduct[field.key];\r\n      const newVal = updatedProduct[field.key];\r\n      if (oldVal !== newVal && !(oldVal === undefined && newVal === undefined)) {\r\n        if (field.key === 'status') continue;\r\n        const oldDisplay = oldVal !== undefined && oldVal !== null && oldVal !== '' ? String(oldVal) : '(tr·ªëng)';\r\n        const newDisplay = newVal !== undefined && newVal !== null && newVal !== '' ? String(newVal) : '(tr·ªëng)';\r\n        changes.push(`${field.label}: ${oldDisplay} ‚Üí ${newDisplay}`);\r\n      }\r\n    }\r\n    \r\n    // Track price changes separately\r\n    if (existingProduct.costPrice !== updatedProduct.costPrice) {\r\n      changes.push(`Gi√° v·ªën: ${existingProduct.costPrice?.toLocaleString('vi-VN')} ‚Üí ${updatedProduct.costPrice?.toLocaleString('vi-VN')}`);\r\n    }\r\n    \r\n    if (changes.length > 0) {\r\n      historyEntries.push(createUpdatedEntry(\r\n        userInfo,\r\n        `${userInfo.name} ƒë√£ c·∫≠p nh·∫≠t: ${changes.join(', ')}`\r\n      ));\r\n    }\r\n  }\r\n  \r\n  const productWithHistory = {\r\n    ...updatedProduct,\r\n    activityHistory: appendHistoryEntry(existingProduct?.activityHistory, ...historyEntries)\r\n  };\r\n  \r\n  baseStore.getState().update(systemId, productWithHistory);\r\n};\r\n\r\n// Export typed hook that includes both base and custom methods\r\nexport const useProductStore = (): ProductStoreState => {\r\n  const state = baseStore();\r\n  return {\r\n    ...state,\r\n    add: addProduct,\r\n    update: updateProduct,\r\n    updateInventory,\r\n    commitStock,\r\n    uncommitStock,\r\n    dispatchStock,\r\n    completeDelivery,\r\n    returnStockFromTransit,\r\n    updateLastPurchasePrice,\r\n    searchProducts,\r\n  };\r\n};\r\n\r\n// Export getState method for non-hook usage\r\nuseProductStore.getState = () => {\r\n  const state = baseStore.getState();\r\n  return {\r\n    ...state,\r\n    add: addProduct,\r\n    update: updateProduct,\r\n    updateInventory,\r\n    commitStock,\r\n    uncommitStock,\r\n    dispatchStock,\r\n    completeDelivery,\r\n    returnStockFromTransit,\r\n    updateLastPurchasePrice,\r\n    searchProducts,\r\n  };\r\n};\r\n\r\n(useProductStore as typeof useProductStore & { subscribe?: typeof baseStore.subscribe }).subscribe = baseStore.subscribe;\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 824, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/products/combo-utils.ts"],"sourcesContent":["/**\r\n * Combo Product Utilities\r\n * ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\r\n * Tham kh·∫£o: Sapo Combo\r\n * - Combo kh√¥ng c√≥ t·ªìn kho ri√™ng\r\n * - T·ªìn kho combo = MIN(t·ªìn kho SP con / s·ªë l∆∞·ª£ng trong combo)\r\n * - T·ªëi ƒëa 20 s·∫£n ph·∫©m con\r\n * - Kh√¥ng cho ph√©p combo l·ªìng combo\r\n * ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\r\n */\r\n\r\nimport type { Product, ComboItem, ComboPricingType } from './types';\r\nimport type { SystemId } from '@/lib/id-types';\r\n\r\n// Constants\r\nexport const MAX_COMBO_ITEMS = 20;\r\nexport const MIN_COMBO_ITEMS = 2;\r\n\r\n/**\r\n * Check if product is a combo\r\n */\r\nexport function isComboProduct(product: Product): boolean {\r\n  return product.type === 'combo';\r\n}\r\n\r\n/**\r\n * Check if a product can be added to combo\r\n * - Kh√¥ng cho ph√©p th√™m combo v√†o combo (no nested combo)\r\n * - S·∫£n ph·∫©m ph·∫£i active\r\n */\r\nexport function canAddToCombo(product: Product): boolean {\r\n  if (product.type === 'combo') return false;\r\n  if (product.status === 'discontinued') return false;\r\n  if (product.isDeleted) return false;\r\n  return true;\r\n}\r\n\r\n/**\r\n * Validate combo items\r\n * Returns error message or null if valid\r\n */\r\nexport function validateComboItems(\r\n  comboItems: ComboItem[],\r\n  allProducts: Product[]\r\n): string | null {\r\n  // Check minimum items\r\n  if (comboItems.length < MIN_COMBO_ITEMS) {\r\n    return `Combo ph·∫£i c√≥ √≠t nh·∫•t ${MIN_COMBO_ITEMS} s·∫£n ph·∫©m`;\r\n  }\r\n  \r\n  // Check maximum items\r\n  if (comboItems.length > MAX_COMBO_ITEMS) {\r\n    return `Combo ch·ªâ ƒë∆∞·ª£c t·ªëi ƒëa ${MAX_COMBO_ITEMS} s·∫£n ph·∫©m`;\r\n  }\r\n  \r\n  // Check for duplicate products\r\n  const productIds = comboItems.map(item => item.productSystemId);\r\n  const uniqueIds = new Set(productIds);\r\n  if (uniqueIds.size !== productIds.length) {\r\n    return 'Combo kh√¥ng ƒë∆∞·ª£c ch·ª©a s·∫£n ph·∫©m tr√πng l·∫∑p';\r\n  }\r\n  \r\n  // Check each item\r\n  for (const item of comboItems) {\r\n    // Check quantity\r\n    if (item.quantity < 1) {\r\n      return 'S·ªë l∆∞·ª£ng s·∫£n ph·∫©m trong combo ph·∫£i >= 1';\r\n    }\r\n    \r\n    if (!Number.isInteger(item.quantity)) {\r\n      return 'S·ªë l∆∞·ª£ng s·∫£n ph·∫©m trong combo ph·∫£i l√† s·ªë nguy√™n';\r\n    }\r\n    \r\n    // Check product exists and is valid\r\n    const product = allProducts.find(p => p.systemId === item.productSystemId);\r\n    if (!product) {\r\n      return 'S·∫£n ph·∫©m trong combo kh√¥ng t·ªìn t·∫°i';\r\n    }\r\n    \r\n    if (!canAddToCombo(product)) {\r\n      return `S·∫£n ph·∫©m \"${product.name}\" kh√¥ng th·ªÉ th√™m v√†o combo`;\r\n    }\r\n  }\r\n  \r\n  return null;\r\n}\r\n\r\n/**\r\n * Calculate combo available stock for a specific branch\r\n * Formula: MIN(child_product_available / quantity_in_combo)\r\n * \r\n * @param comboItems - List of combo items\r\n * @param allProducts - All products to lookup\r\n * @param branchSystemId - Branch to calculate stock for\r\n * @returns Available combo quantity (floored to integer)\r\n */\r\nexport function calculateComboStock(\r\n  comboItems: ComboItem[],\r\n  allProducts: Product[],\r\n  branchSystemId: SystemId\r\n): number {\r\n  if (!comboItems || comboItems.length === 0) return 0;\r\n  \r\n  let minComboQuantity = Infinity;\r\n  \r\n  for (const item of comboItems) {\r\n    const product = allProducts.find(p => p.systemId === item.productSystemId);\r\n    if (!product) return 0; // If any product not found, combo unavailable\r\n    \r\n    // Available = On-hand - Committed\r\n    const onHand = product.inventoryByBranch?.[branchSystemId] || 0;\r\n    const committed = product.committedByBranch?.[branchSystemId] || 0;\r\n    const available = onHand - committed;\r\n    \r\n    // How many combos can we make from this product?\r\n    const comboQuantityFromThisProduct = Math.floor(available / item.quantity);\r\n    \r\n    minComboQuantity = Math.min(minComboQuantity, comboQuantityFromThisProduct);\r\n  }\r\n  \r\n  return minComboQuantity === Infinity ? 0 : Math.max(0, minComboQuantity);\r\n}\r\n\r\n/**\r\n * Calculate combo stock across all branches\r\n * Returns a map of branchSystemId -> available combo quantity\r\n */\r\nexport function calculateComboStockAllBranches(\r\n  comboItems: ComboItem[],\r\n  allProducts: Product[]\r\n): Record<SystemId, number> {\r\n  if (!comboItems || comboItems.length === 0) return {};\r\n  \r\n  // Collect all branch IDs from child products\r\n  const allBranchIds = new Set<SystemId>();\r\n  for (const item of comboItems) {\r\n    const product = allProducts.find(p => p.systemId === item.productSystemId);\r\n    if (product?.inventoryByBranch) {\r\n      Object.keys(product.inventoryByBranch).forEach(branchId => {\r\n        allBranchIds.add(branchId as SystemId);\r\n      });\r\n    }\r\n  }\r\n  \r\n  // Calculate stock for each branch\r\n  const result: Record<SystemId, number> = {};\r\n  for (const branchId of allBranchIds) {\r\n    result[branchId] = calculateComboStock(comboItems, allProducts, branchId);\r\n  }\r\n  \r\n  return result;\r\n}\r\n\r\n/**\r\n * Calculate combo price based on pricing type\r\n * \r\n * @param comboItems - List of combo items\r\n * @param allProducts - All products to lookup prices\r\n * @param pricingPolicySystemId - Which pricing policy to use\r\n * @param comboPricingType - How to calculate price\r\n * @param comboDiscount - Discount value (% or fixed amount)\r\n * @returns Calculated combo price\r\n */\r\nexport function calculateComboPrice(\r\n  comboItems: ComboItem[],\r\n  allProducts: Product[],\r\n  pricingPolicySystemId: SystemId,\r\n  comboPricingType: ComboPricingType,\r\n  comboDiscount: number = 0\r\n): number {\r\n  if (comboPricingType === 'fixed') {\r\n    // Fixed price is stored directly, not calculated\r\n    return comboDiscount; // In fixed mode, comboDiscount IS the price\r\n  }\r\n  \r\n  // Calculate sum of child products' prices\r\n  let sumPrice = 0;\r\n  for (const item of comboItems) {\r\n    const product = allProducts.find(p => p.systemId === item.productSystemId);\r\n    if (!product) continue;\r\n    \r\n    const unitPrice = product.prices?.[pricingPolicySystemId] || 0;\r\n    sumPrice += unitPrice * item.quantity;\r\n  }\r\n  \r\n  // Apply discount\r\n  if (comboPricingType === 'sum_discount_percent') {\r\n    const discountAmount = sumPrice * (comboDiscount / 100);\r\n    return Math.round(sumPrice - discountAmount);\r\n  }\r\n  \r\n  if (comboPricingType === 'sum_discount_amount') {\r\n    return Math.max(0, sumPrice - comboDiscount);\r\n  }\r\n  \r\n  return sumPrice;\r\n}\r\n\r\n/**\r\n * Calculate combo cost price (sum of child products' cost prices)\r\n */\r\ntype ComboCostOptions = {\r\n  /**\r\n   * Optional pricing policy to use when we have to fall back to selling price data.\r\n   * Ensures cost previews stay in sync with the price policy that users actually see.\r\n   */\r\n  fallbackPricingPolicyId?: SystemId;\r\n  /**\r\n   * Allow falling back to selling price data if cost/last purchase/min price are missing.\r\n   * Defaults to true to avoid showing zero cost when data is incomplete.\r\n   */\r\n  allowPriceFallback?: boolean;\r\n};\r\n\r\nconst isNumber = (value: unknown): value is number => typeof value === 'number' && Number.isFinite(value);\r\n\r\nexport function calculateComboCostPrice(\r\n  comboItems: ComboItem[],\r\n  allProducts: Product[],\r\n  options: ComboCostOptions = {}\r\n): number {\r\n  const { fallbackPricingPolicyId, allowPriceFallback = true } = options;\r\n  let totalCost = 0;\r\n  \r\n  for (const item of comboItems) {\r\n    const product = allProducts.find(p => p.systemId === item.productSystemId);\r\n    if (!product) continue;\r\n\r\n    let unitCost = product.costPrice;\r\n\r\n    if (!isNumber(unitCost) && isNumber(product.lastPurchasePrice)) {\r\n      unitCost = product.lastPurchasePrice;\r\n    }\r\n\r\n    if (!isNumber(unitCost) && allowPriceFallback) {\r\n      if (fallbackPricingPolicyId && isNumber(product.prices?.[fallbackPricingPolicyId])) {\r\n        unitCost = product.prices![fallbackPricingPolicyId];\r\n      }\r\n\r\n      if (!isNumber(unitCost)) {\r\n        const firstPrice = Object.values(product.prices || {}).find((price): price is number => isNumber(price));\r\n        if (isNumber(firstPrice)) {\r\n          unitCost = firstPrice;\r\n        }\r\n      }\r\n    }\r\n\r\n    if (!isNumber(unitCost) && isNumber(product.minPrice)) {\r\n      unitCost = product.minPrice;\r\n    }\r\n    \r\n    totalCost += (unitCost || 0) * item.quantity;\r\n  }\r\n  \r\n  return totalCost;\r\n}\r\n\r\n/**\r\n * Calculate combo last purchase price (sum of child products' last purchase prices)\r\n */\r\nexport function calculateComboLastPurchasePrice(\r\n  comboItems: ComboItem[],\r\n  allProducts: Product[]\r\n): number {\r\n  let total = 0;\r\n  \r\n  for (const item of comboItems) {\r\n    const product = allProducts.find(p => p.systemId === item.productSystemId);\r\n    if (!product) continue;\r\n    \r\n    total += (product.lastPurchasePrice || 0) * item.quantity;\r\n  }\r\n  \r\n  return total;\r\n}\r\n\r\n/**\r\n * Calculate combo min price (sum of child products' min prices)\r\n */\r\nexport function calculateComboMinPrice(\r\n  comboItems: ComboItem[],\r\n  allProducts: Product[]\r\n): number {\r\n  let total = 0;\r\n  \r\n  for (const item of comboItems) {\r\n    const product = allProducts.find(p => p.systemId === item.productSystemId);\r\n    if (!product) continue;\r\n    \r\n    total += (product.minPrice || 0) * item.quantity;\r\n  }\r\n  \r\n  return total;\r\n}\r\n\r\n/**\r\n * Calculate combo prices by policy (sum of child products' prices per policy)\r\n * This returns the RAW sum without any discount applied\r\n */\r\nexport function calculateComboPricesByPolicy(\r\n  comboItems: ComboItem[],\r\n  allProducts: Product[]\r\n): Record<string, number> {\r\n  const pricesByPolicy: Record<string, number> = {};\r\n  \r\n  for (const item of comboItems) {\r\n    const product = allProducts.find(p => p.systemId === item.productSystemId);\r\n    if (!product || !product.prices) continue;\r\n    \r\n    for (const [policyId, price] of Object.entries(product.prices)) {\r\n      if (!pricesByPolicy[policyId]) {\r\n        pricesByPolicy[policyId] = 0;\r\n      }\r\n      pricesByPolicy[policyId] += (price || 0) * item.quantity;\r\n    }\r\n  }\r\n  \r\n  return pricesByPolicy;\r\n}\r\n\r\n/**\r\n * Calculate final combo prices by policy with discount applied\r\n * This returns the actual selling prices for the combo\r\n * \r\n * @param comboItems - List of combo items\r\n * @param allProducts - All products to lookup prices\r\n * @param comboPricingType - How to calculate price\r\n * @param comboDiscount - Discount value (% or fixed amount or fixed price)\r\n * @param defaultPolicyId - Default selling policy ID (used for fixed pricing)\r\n * @returns Final combo prices by policy\r\n */\r\nexport function calculateFinalComboPricesByPolicy(\r\n  comboItems: ComboItem[],\r\n  allProducts: Product[],\r\n  comboPricingType: ComboPricingType,\r\n  comboDiscount: number = 0,\r\n  defaultPolicyId?: string\r\n): Record<string, number> {\r\n  // Get raw sum prices first\r\n  const rawPricesByPolicy = calculateComboPricesByPolicy(comboItems, allProducts);\r\n  const finalPricesByPolicy: Record<string, number> = {};\r\n  \r\n  if (comboPricingType === 'fixed') {\r\n    // For fixed pricing, only policies that exist on child products should be auto-filled.\r\n    for (const policyId of Object.keys(rawPricesByPolicy)) {\r\n      finalPricesByPolicy[policyId] = comboDiscount; // comboDiscount IS the price in fixed mode\r\n    }\r\n    return finalPricesByPolicy;\r\n  }\r\n  \r\n  // For discount-based pricing, apply discount to each policy's sum\r\n  for (const [policyId, sumPrice] of Object.entries(rawPricesByPolicy)) {\r\n    if (comboPricingType === 'sum_discount_percent') {\r\n      const discountAmount = sumPrice * (comboDiscount / 100);\r\n      finalPricesByPolicy[policyId] = Math.round(sumPrice - discountAmount);\r\n    } else if (comboPricingType === 'sum_discount_amount') {\r\n      finalPricesByPolicy[policyId] = Math.max(0, sumPrice - comboDiscount);\r\n    } else {\r\n      // No discount, use raw sum\r\n      finalPricesByPolicy[policyId] = sumPrice;\r\n    }\r\n  }\r\n  \r\n  return finalPricesByPolicy;\r\n}\r\n\r\n/**\r\n * Get summary text for combo (e.g., \"3 s·∫£n ph·∫©m, t·ªìn kho: 15\")\r\n */\r\nexport function getComboSummary(\r\n  comboItems: ComboItem[],\r\n  allProducts: Product[],\r\n  branchSystemId?: SystemId\r\n): string {\r\n  const itemCount = comboItems?.length || 0;\r\n  \r\n  if (!branchSystemId) {\r\n    return `${itemCount} s·∫£n ph·∫©m`;\r\n  }\r\n  \r\n  const stock = calculateComboStock(comboItems, allProducts, branchSystemId);\r\n  return `${itemCount} s·∫£n ph·∫©m, t·ªìn kho: ${stock}`;\r\n}\r\n\r\n/**\r\n * Check if combo has sufficient stock for a quantity\r\n */\r\nexport function hasComboStock(\r\n  comboItems: ComboItem[],\r\n  allProducts: Product[],\r\n  branchSystemId: SystemId,\r\n  requiredQuantity: number\r\n): boolean {\r\n  const available = calculateComboStock(comboItems, allProducts, branchSystemId);\r\n  return available >= requiredQuantity;\r\n}\r\n\r\n/**\r\n * Get the limiting product(s) for combo stock\r\n * Returns the product(s) that have the lowest available combo quantity\r\n */\r\nexport function getComboBottleneckProducts(\r\n  comboItems: ComboItem[],\r\n  allProducts: Product[],\r\n  branchSystemId: SystemId\r\n): Array<{ product: Product; availableForCombo: number; itemQuantity: number }> {\r\n  if (!comboItems || comboItems.length === 0) return [];\r\n  \r\n  const comboStock = calculateComboStock(comboItems, allProducts, branchSystemId);\r\n  const bottlenecks: Array<{ product: Product; availableForCombo: number; itemQuantity: number }> = [];\r\n  \r\n  for (const item of comboItems) {\r\n    const product = allProducts.find(p => p.systemId === item.productSystemId);\r\n    if (!product) continue;\r\n    \r\n    const onHand = product.inventoryByBranch?.[branchSystemId] || 0;\r\n    const committed = product.committedByBranch?.[branchSystemId] || 0;\r\n    const available = onHand - committed;\r\n    const comboQuantityFromThisProduct = Math.floor(available / item.quantity);\r\n    \r\n    // This product is a bottleneck if it limits the combo quantity\r\n    if (comboQuantityFromThisProduct === comboStock) {\r\n      bottlenecks.push({\r\n        product,\r\n        availableForCombo: comboQuantityFromThisProduct,\r\n        itemQuantity: item.quantity,\r\n      });\r\n    }\r\n  }\r\n  \r\n  return bottlenecks;\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1095, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/stock-history/store.ts"],"sourcesContent":["import { create } from 'zustand';\r\nimport { formatDate, formatDateTime, formatDateTimeSeconds, formatDateCustom, parseDate, getCurrentDate } from '@/lib/date-utils';\r\nimport type { StockHistoryEntry } from './types';\r\nimport { asSystemId } from '../../lib/id-types';\r\nimport type { SystemId } from '../../lib/id-types';\r\n// REMOVED: import { data as initialData } from './data'; // Mock data no longer used - database is source of truth\r\n\r\n// API sync helpers\r\nasync function syncToAPI(action: 'create', data: any): Promise<boolean> {\r\n  try {\r\n    const response = await fetch('/api/inventory/stock-history', {\r\n      method: 'POST',\r\n      headers: { 'Content-Type': 'application/json' },\r\n      body: JSON.stringify(data),\r\n    });\r\n    \r\n    if (!response.ok) {\r\n      console.error(`[StockHistory API] ${action} failed:`, await response.text());\r\n      return false;\r\n    }\r\n    return true;\r\n  } catch (error) {\r\n    console.error(`[StockHistory API] ${action} error:`, error);\r\n    return false;\r\n  }\r\n}\r\n\r\n// ‚ú® Migration helper: Convert SKU to systemId for old data\r\nfunction migrateHistoryData(entries: StockHistoryEntry[]): StockHistoryEntry[] {\r\n  // Map SKU ‚Üí systemId from products\r\n  const skuToSystemId: Record<string, string> = {\r\n    'DV-WEB-01': 'SP00000001',\r\n    'DV-WEB-02': 'SP00000002',\r\n    'DV-WEB-03': 'SP00000003',\r\n    'DV-MKT-01': 'SP00000004',\r\n    'DV-MKT-02': 'SP00000005',\r\n    'DV-MKT-03': 'SP00000006',\r\n    'DV-SEO-01': 'SP00000007',\r\n    'DV-SEO-02': 'SP00000008',\r\n    'DV-IT-01': 'SP00000009',\r\n    'DV-DSN-01': 'SP00000010',\r\n    'SW-CRM-01': 'SP00000011',\r\n    'SW-ERP-01': 'SP00000012',\r\n    'SW-WIN-01': 'SP00000013',\r\n    'SW-OFF-01': 'SP00000014',\r\n    'SW-ADOBE-01': 'SP00000015',\r\n    'HW-SRV-01': 'SP00000016',\r\n    'HW-SRV-02': 'SP00000017',\r\n    'HW-PC-01': 'SP00000018',\r\n    'HW-PC-02': 'SP00000019',\r\n    'HW-LT-01': 'SP00000020',\r\n    'HW-NET-01': 'SP00000021',\r\n    'HW-NET-02': 'SP00000022',\r\n    'HW-CAM-01': 'SP00000023',\r\n    'MISC-HOST-01': 'SP00000024',\r\n    'MISC-HOST-02': 'SP00000025',\r\n    'MISC-SSL-01': 'SP00000026',\r\n    'MISC-DOMAIN-COM': 'SP00000027',\r\n    'MISC-DOMAIN-VN': 'SP00000028',\r\n    'MISC-PRINT-01': 'SP00000029',\r\n    'MISC-PRINT-02': 'SP00000030',\r\n  };\r\n  \r\n  return entries.map(entry => ({\r\n    ...entry,\r\n    productId: asSystemId(skuToSystemId[entry.productId as any] || entry.productId) // Convert or keep if already systemId\r\n  }));\r\n}\r\n\r\ninterface StockHistoryState {\r\n  entries: StockHistoryEntry[];\r\n  initialized: boolean;\r\n  addEntry: (entry: Omit<StockHistoryEntry, 'systemId'>) => void;\r\n  getHistoryForProduct: (productId: SystemId, branchSystemId?: 'all' | SystemId) => StockHistoryEntry[];\r\n  loadFromAPI: () => Promise<void>;\r\n}\r\n\r\nlet entryCounter = 0;\r\n\r\nexport const useStockHistoryStore = create<StockHistoryState>()(\r\n  (set, get) => ({\r\n      entries: [], // Database is source of truth\r\n      initialized: false,\r\n      \r\n      addEntry: (entry) => {\r\n        entryCounter++;\r\n        const newEntry: StockHistoryEntry = {\r\n            ...entry,\r\n            systemId: asSystemId(`HISTORY${String(Date.now()).slice(-6)}_${entryCounter}`),\r\n        };\r\n        set((state) => ({ entries: [...state.entries, newEntry] }));\r\n        // Sync to API\r\n        syncToAPI('create', newEntry).catch(console.error);\r\n      },\r\n      \r\n      getHistoryForProduct: (productId, branchSystemId = 'all') => {\r\n          const productHistory = get().entries.filter(e => e.productId === productId);\r\n          const sortedHistory = productHistory.sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime());\r\n\r\n          if (branchSystemId === 'all') {\r\n            return sortedHistory;\r\n          }\r\n          return sortedHistory.filter(e => e.branchSystemId === branchSystemId);\r\n        },\r\n      \r\n      loadFromAPI: async () => {\r\n        try {\r\n          // NOTE: Use React Query hooks for paginated data. This only loads initial batch.\r\n          const response = await fetch('/api/inventory/stock-history?limit=30');\r\n          if (!response.ok) return;\r\n          const json = await response.json();\r\n          const apiData = json.data || [];\r\n          if (apiData.length > 0) {\r\n            set({ entries: migrateHistoryData(apiData), initialized: true });\r\n          } else {\r\n            set({ initialized: true });\r\n          }\r\n        } catch (error) {\r\n          console.error('[StockHistory API] loadFromAPI error:', error);\r\n        }\r\n      },\r\n    })\r\n);\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1217, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/cashbook/store.ts"],"sourcesContent":["import { create } from 'zustand';\r\n// REMOVED: import { data as initialData } from './data'; // Mock data no longer used - database is source of truth\r\nimport type { CashAccount } from './types';\r\nimport { findNextAvailableBusinessId, generateSystemId, getMaxBusinessIdCounter, getMaxSystemIdCounter, type EntityType } from '../../lib/id-utils';\r\nimport { asBusinessId, asSystemId, type BusinessId, type SystemId } from '../../lib/id-types';\r\n\r\nconst CASH_ACCOUNT_ENTITY: EntityType = 'cash-accounts';\r\nconst SYSTEM_ID_PREFIX = 'ACCOUNT';\r\nconst BUSINESS_ID_PREFIX = 'TK';\r\nconst BUSINESS_ID_DIGITS = 6;\r\n\r\n// API sync helpers\r\nasync function syncToAPI(action: 'create' | 'update' | 'delete', data: any): Promise<boolean> {\r\n  try {\r\n    const endpoint = action === 'create' ? '/api/cash-accounts' : `/api/cash-accounts/${data.systemId}`;\r\n    const method = action === 'create' ? 'POST' : action === 'update' ? 'PATCH' : 'DELETE';\r\n    \r\n    const response = await fetch(endpoint, {\r\n      method,\r\n      headers: { 'Content-Type': 'application/json' },\r\n      body: action !== 'delete' ? JSON.stringify(data) : undefined,\r\n    });\r\n    \r\n    if (!response.ok) {\r\n      console.error(`[Cashbook API] ${action} failed:`, await response.text());\r\n      return false;\r\n    }\r\n    return true;\r\n  } catch (error) {\r\n    console.error(`[Cashbook API] ${action} error:`, error);\r\n    return false;\r\n  }\r\n}\r\n\r\nasync function fetchFromAPI(): Promise<CashAccount[]> {\r\n  try {\r\n    const response = await fetch('/api/cash-accounts?limit=50');\r\n    if (!response.ok) return [];\r\n    const json = await response.json();\r\n    return json.data || [];\r\n  } catch (error) {\r\n    console.error('[Cashbook API] fetch error:', error);\r\n    return [];\r\n  }\r\n}\r\n\r\ninterface CashbookState {\r\n  accounts: CashAccount[];\r\n  initialized: boolean;\r\n  getAccountById: (id: BusinessId) => CashAccount | undefined;\r\n  add: (item: Omit<CashAccount, 'systemId'>) => void;\r\n  update: (systemId: SystemId, item: CashAccount) => void;\r\n  remove: (systemId: SystemId) => void;\r\n  setDefault: (systemId: SystemId) => void;\r\n  loadFromAPI: () => Promise<void>;\r\n}\r\n\r\nconst getNextSystemId = (accounts: CashAccount[]): SystemId => {\r\n  const currentCounter = getMaxSystemIdCounter(accounts, SYSTEM_ID_PREFIX);\r\n  return asSystemId(generateSystemId(CASH_ACCOUNT_ENTITY, currentCounter + 1));\r\n};\r\n\r\nconst ensureBusinessId = (accounts: CashAccount[], provided?: BusinessId): BusinessId => {\r\n  if (provided && provided.trim()) {\r\n    return provided;\r\n  }\r\n\r\n  const existingIds = accounts.map(acc => acc.id as string);\r\n  const startCounter = getMaxBusinessIdCounter(accounts, BUSINESS_ID_PREFIX);\r\n  const { nextId } = findNextAvailableBusinessId(BUSINESS_ID_PREFIX, existingIds, startCounter, BUSINESS_ID_DIGITS);\r\n  return asBusinessId(nextId);\r\n};\r\n\r\nexport const useCashbookStore = create<CashbookState>()(\r\n  (set, get) => ({\r\n      accounts: [],\r\n      initialized: false,\r\n      getAccountById: (id) => get().accounts.find(a => a.id === id),\r\n      \r\n      add: (item) => {\r\n        const newAccount: CashAccount = {\r\n          ...item,\r\n          systemId: getNextSystemId(get().accounts),\r\n          id: ensureBusinessId(get().accounts, item.id),\r\n        };\r\n        set((state) => ({ accounts: [...state.accounts, newAccount] }));\r\n        // Sync to API\r\n        syncToAPI('create', newAccount).catch(console.error);\r\n      },\r\n      \r\n      update: (systemId, updatedItem) => {\r\n        set((state) => ({\r\n          accounts: state.accounts.map((acc) => (acc.systemId === systemId ? updatedItem : acc))\r\n        }));\r\n        // Sync to API\r\n        syncToAPI('update', updatedItem).catch(console.error);\r\n      },\r\n      \r\n      remove: (systemId) => {\r\n        set((state) => ({\r\n          accounts: state.accounts.filter(acc => acc.systemId !== systemId)\r\n        }));\r\n        // Sync to API\r\n        syncToAPI('delete', { systemId }).catch(console.error);\r\n      },\r\n      \r\n      setDefault: (systemId) => {\r\n        set((state) => {\r\n          const targetAccount = state.accounts.find(acc => acc.systemId === systemId);\r\n          if (!targetAccount) return state;\r\n\r\n          const updated = state.accounts.map(acc => ({\r\n            ...acc,\r\n            isDefault: (acc.type === targetAccount.type ? acc.systemId === systemId : acc.isDefault) ?? false\r\n          }));\r\n          \r\n          // Sync updated accounts to API\r\n          updated.forEach(acc => {\r\n            if (acc.type === targetAccount.type) {\r\n              syncToAPI('update', acc).catch(console.error);\r\n            }\r\n          });\r\n          \r\n          return { accounts: updated };\r\n        });\r\n      },\r\n      \r\n      loadFromAPI: async () => {\r\n        const apiData = await fetchFromAPI();\r\n        if (apiData.length > 0) {\r\n          set({ accounts: apiData, initialized: true });\r\n        } else {\r\n          set({ initialized: true });\r\n        }\r\n      },\r\n    })\r\n);\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1349, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/finance/document-lookups.ts"],"sourcesContent":["import { useTargetGroupStore } from '@/features/settings/target-groups/store';\r\nimport { usePaymentMethodStore } from '@/features/settings/payments/methods/store';\r\nimport { useCashbookStore } from '@/features/cashbook/store';\r\nimport { useReceiptTypeStore } from '@/features/settings/receipt-types/store';\r\nimport { usePaymentTypeStore } from '@/features/settings/payments/types/store';\r\nimport type { TargetGroup } from '@/features/settings/target-groups/types';\r\nimport type { PaymentMethod } from '@/features/settings/payments/methods/types';\r\nimport type { CashAccount } from '@/features/cashbook/types';\r\nimport type { ReceiptType } from '@/features/settings/receipt-types/types';\r\nimport type { PaymentType } from '@/features/settings/payments/types/types';\r\nimport type { SystemId } from '@/lib/id-types';\r\n\r\nconst normalizeName = (value?: string | null) => (value ?? '').trim().toLowerCase();\r\n\r\nexport const DEFAULT_CUSTOMER_GROUP = 'kh√°ch h√†ng';\r\n\r\nexport const pickTargetGroup = (options?: {\r\n  systemId?: SystemId | undefined;\r\n  name?: string | undefined;\r\n  fallbackName?: string | undefined;\r\n}): TargetGroup | null => {\r\n  const groups = useTargetGroupStore.getState().data ?? [];\r\n  if (groups.length === 0) {\r\n    return null;\r\n  }\r\n\r\n  if (options?.systemId) {\r\n    const match = groups.find(group => group.systemId === options.systemId);\r\n    if (match) {\r\n      return match;\r\n    }\r\n  }\r\n\r\n  const lookupNames = [options?.name, options?.fallbackName, DEFAULT_CUSTOMER_GROUP].filter(Boolean) as string[];\r\n  for (const candidate of lookupNames) {\r\n    const normalized = normalizeName(candidate);\r\n    const match = groups.find(group => normalizeName(group.name) === normalized);\r\n    if (match) {\r\n      return match;\r\n    }\r\n  }\r\n\r\n  return groups[0] ?? null;\r\n};\r\n\r\nexport const pickPaymentMethod = (options?: {\r\n  systemId?: SystemId | undefined;\r\n  name?: string | undefined;\r\n}): PaymentMethod | null => {\r\n  const methods = usePaymentMethodStore.getState().data ?? [];\r\n  if (methods.length === 0) {\r\n    return null;\r\n  }\r\n\r\n  if (options?.systemId) {\r\n    const match = methods.find(method => method.systemId === options.systemId);\r\n    if (match) {\r\n      return match;\r\n    }\r\n  }\r\n\r\n  if (options?.name) {\r\n    const normalized = normalizeName(options.name);\r\n    const match = methods.find(method => normalizeName(method.name) === normalized);\r\n    if (match) {\r\n      return match;\r\n    }\r\n  }\r\n\r\n  return methods.find(method => method.isDefault) ?? methods[0] ?? null;\r\n};\r\n\r\nexport const pickAccount = (options: {\r\n  accountSystemId?: SystemId | undefined;\r\n  preferredType?: 'cash' | 'bank' | undefined;\r\n  branchSystemId?: SystemId | undefined;\r\n  paymentMethodName?: string | undefined;\r\n}): CashAccount | null => {\r\n  const { accounts } = useCashbookStore.getState();\r\n  if (!accounts || accounts.length === 0) {\r\n    return null;\r\n  }\r\n\r\n  if (options.accountSystemId) {\r\n    const match = accounts.find(account => account.systemId === options.accountSystemId);\r\n    if (match) {\r\n      return match;\r\n    }\r\n  }\r\n\r\n  let preferredType = options.preferredType;\r\n  if (!preferredType && options.paymentMethodName) {\r\n    const normalizedMethod = normalizeName(options.paymentMethodName);\r\n    preferredType = normalizedMethod === 'ti·ªÅn m·∫∑t' ? 'cash' : normalizedMethod === 'chuy·ªÉn kho·∫£n' ? 'bank' : undefined;\r\n  }\r\n\r\n  const candidates = preferredType ? accounts.filter(account => account.type === preferredType) : accounts;\r\n\r\n  if (candidates.length === 0) {\r\n    return accounts[0];\r\n  }\r\n\r\n  return (\r\n    candidates.find(account => account.branchSystemId && options.branchSystemId && account.branchSystemId === options.branchSystemId) ??\r\n    candidates.find(account => account.isDefault) ??\r\n    candidates[0]\r\n  );\r\n};\r\n\r\nexport const pickReceiptType = (options?: {\r\n  systemId?: SystemId | undefined;\r\n  name?: string | undefined;\r\n}): ReceiptType | null => {\r\n  const types = useReceiptTypeStore.getState().data ?? [];\r\n  if (types.length === 0) {\r\n    return null;\r\n  }\r\n\r\n  if (options?.systemId) {\r\n    const match = types.find(type => type.systemId === options.systemId);\r\n    if (match) {\r\n      return match;\r\n    }\r\n  }\r\n\r\n  if (options?.name) {\r\n    const normalized = normalizeName(options.name);\r\n    const match = types.find(type => normalizeName(type.name) === normalized);\r\n    if (match) {\r\n      return match;\r\n    }\r\n  }\r\n\r\n  return types[0] ?? null;\r\n};\r\n\r\nexport const pickPaymentType = (options?: {\r\n  systemId?: SystemId | undefined;\r\n  name?: string | undefined;\r\n}): PaymentType | null => {\r\n  const types = usePaymentTypeStore.getState().data ?? [];\r\n  if (types.length === 0) {\r\n    return null;\r\n  }\r\n\r\n  if (options?.systemId) {\r\n    const match = types.find(type => type.systemId === options.systemId);\r\n    if (match) {\r\n      return match;\r\n    }\r\n  }\r\n\r\n  if (options?.name) {\r\n    const normalized = normalizeName(options.name);\r\n    const match = types.find(type => normalizeName(type.name) === normalized);\r\n    if (match) {\r\n      return match;\r\n    }\r\n  }\r\n\r\n  return types[0] ?? null;\r\n};\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1486, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/finance/document-helpers.ts"],"sourcesContent":["import { toISODateTime } from '@/lib/date-utils';\r\nimport { asBusinessId, type BusinessId, type SystemId } from '@/lib/id-types';\r\nimport { useReceiptStore, type ReceiptInput } from '@/features/receipts/store';\r\nimport type { Receipt } from '@/features/receipts/types';\r\nimport { usePaymentStore, type PaymentInput } from '@/features/payments/store';\r\nimport type { Payment } from '@/features/payments/types';\r\nimport { pickAccount, pickPaymentMethod, pickPaymentType, pickReceiptType, pickTargetGroup } from '@/features/finance/document-lookups';\r\n\r\nconst asBusinessIdOrUndefined = (value?: string | BusinessId | null) => {\r\n  if (!value) {\r\n    return undefined;\r\n  }\r\n  return typeof value === 'string' ? asBusinessId(value) : value;\r\n};\r\n\r\ninterface ReceiptDocumentOptions {\r\n  amount: number;\r\n  description: string;\r\n  customerName: string;\r\n  branchSystemId: SystemId;\r\n  branchName: string;\r\n  createdBy: SystemId;\r\n  customerSystemId?: SystemId;\r\n  paymentMethodSystemId?: SystemId;\r\n  paymentMethodName?: string;\r\n  accountSystemId?: SystemId;\r\n  accountPreference?: 'cash' | 'bank';\r\n  receiptTypeSystemId?: SystemId;\r\n  receiptTypeName?: string;\r\n  payerTargetGroupSystemId?: SystemId;\r\n  payerTargetGroupName?: string;\r\n  originalDocumentId?: string | BusinessId;\r\n  linkedOrderSystemId?: SystemId;\r\n  linkedSalesReturnSystemId?: SystemId;\r\n  linkedWarrantySystemId?: SystemId;\r\n  linkedComplaintSystemId?: SystemId;\r\n  category?: Receipt['category'];\r\n  affectsDebt?: boolean;\r\n  status?: Receipt['status'];\r\n  date?: string;\r\n}\r\n\r\ninterface PaymentDocumentOptions {\r\n  amount: number;\r\n  description: string;\r\n  recipientName: string;\r\n  branchSystemId: SystemId;\r\n  branchName: string;\r\n  createdBy: SystemId;\r\n  recipientSystemId?: SystemId;\r\n  customerSystemId?: SystemId;\r\n  customerName?: string;\r\n  paymentMethodSystemId?: SystemId;\r\n  paymentMethodName?: string;\r\n  accountSystemId?: SystemId;\r\n  accountPreference?: 'cash' | 'bank';\r\n  paymentTypeSystemId?: SystemId;\r\n  paymentTypeName?: string;\r\n  recipientTargetGroupSystemId?: SystemId;\r\n  recipientTargetGroupName?: string;\r\n  originalDocumentId?: string | BusinessId;\r\n  linkedOrderSystemId?: SystemId;\r\n  linkedSalesReturnSystemId?: SystemId;\r\n  linkedWarrantySystemId?: SystemId;\r\n  linkedComplaintSystemId?: SystemId;\r\n  category?: Payment['category'];\r\n  affectsDebt?: boolean;\r\n  status?: Payment['status'];\r\n  date?: string;\r\n}\r\n\r\nexport interface DocumentCreationResult<T> {\r\n  document: T | null;\r\n  error?: string;\r\n}\r\n\r\nexport const createReceiptDocument = (options: ReceiptDocumentOptions): DocumentCreationResult<Receipt> => {\r\n  if (!options.branchSystemId) {\r\n    return { document: null, error: 'Thi·∫øu m√£ chi nh√°nh khi t·∫°o phi·∫øu thu.' };\r\n  }\r\n\r\n  const targetGroup = pickTargetGroup({\r\n    systemId: options.payerTargetGroupSystemId,\r\n    name: options.payerTargetGroupName,\r\n  });\r\n  if (!targetGroup) {\r\n    return { document: null, error: 'Ch∆∞a c·∫•u h√¨nh nh√≥m ƒë·ªëi t∆∞·ª£ng (Target Group) cho phi·∫øu thu.' };\r\n  }\r\n\r\n  const paymentMethod = pickPaymentMethod({\r\n    systemId: options.paymentMethodSystemId,\r\n    name: options.paymentMethodName,\r\n  });\r\n  if (!paymentMethod) {\r\n    return { document: null, error: 'Ch∆∞a c·∫•u h√¨nh ph∆∞∆°ng th·ª©c thu ti·ªÅn.' };\r\n  }\r\n\r\n  const account = pickAccount({\r\n    accountSystemId: options.accountSystemId,\r\n    preferredType: options.accountPreference,\r\n    branchSystemId: options.branchSystemId,\r\n    paymentMethodName: paymentMethod.name,\r\n  });\r\n  if (!account) {\r\n    return { document: null, error: 'Ch∆∞a c·∫•u h√¨nh t√†i kho·∫£n qu·ªπ ph√π h·ª£p ƒë·ªÉ t·∫°o phi·∫øu thu.' };\r\n  }\r\n\r\n  const receiptType = pickReceiptType({\r\n    systemId: options.receiptTypeSystemId,\r\n    name: options.receiptTypeName,\r\n  });\r\n  if (!receiptType) {\r\n    return { document: null, error: 'Ch∆∞a c·∫•u h√¨nh lo·∫°i phi·∫øu thu.' };\r\n  }\r\n\r\n  const timestamp = options.date ?? toISODateTime(new Date());\r\n  const payload: ReceiptInput = {\r\n    date: timestamp,\r\n    amount: options.amount,\r\n    payerTypeSystemId: targetGroup.systemId,\r\n    payerTypeName: targetGroup.name,\r\n    payerName: options.customerName,\r\n    payerSystemId: options.customerSystemId,\r\n    description: options.description,\r\n    paymentMethodSystemId: paymentMethod.systemId,\r\n    paymentMethodName: paymentMethod.name,\r\n    accountSystemId: account.systemId,\r\n    paymentReceiptTypeSystemId: receiptType.systemId,\r\n    paymentReceiptTypeName: receiptType.name,\r\n    branchSystemId: options.branchSystemId,\r\n    branchName: options.branchName,\r\n    createdBy: options.createdBy,\r\n    createdAt: timestamp,\r\n    status: options.status ?? 'completed',\r\n    category: options.category,\r\n    originalDocumentId: asBusinessIdOrUndefined(options.originalDocumentId),\r\n    linkedOrderSystemId: options.linkedOrderSystemId,\r\n    linkedSalesReturnSystemId: options.linkedSalesReturnSystemId,\r\n    linkedWarrantySystemId: options.linkedWarrantySystemId,\r\n    linkedComplaintSystemId: options.linkedComplaintSystemId,\r\n    customerSystemId: options.customerSystemId,\r\n    customerName: options.customerName,\r\n    affectsDebt: options.affectsDebt ?? true,\r\n  };\r\n\r\n  const receipt = useReceiptStore.getState().add(payload);\r\n  return { document: receipt };\r\n};\r\n\r\nexport const createPaymentDocument = (options: PaymentDocumentOptions): DocumentCreationResult<Payment> => {\r\n  if (!options.branchSystemId) {\r\n    return { document: null, error: 'Thi·∫øu m√£ chi nh√°nh khi t·∫°o phi·∫øu chi.' };\r\n  }\r\n\r\n  const targetGroup = pickTargetGroup({\r\n    systemId: options.recipientTargetGroupSystemId,\r\n    name: options.recipientTargetGroupName,\r\n  });\r\n  if (!targetGroup) {\r\n    return { document: null, error: 'Ch∆∞a c·∫•u h√¨nh nh√≥m ƒë·ªëi t∆∞·ª£ng (Target Group) cho phi·∫øu chi.' };\r\n  }\r\n\r\n  const paymentMethod = pickPaymentMethod({\r\n    systemId: options.paymentMethodSystemId,\r\n    name: options.paymentMethodName,\r\n  });\r\n  if (!paymentMethod) {\r\n    return { document: null, error: 'Ch∆∞a c·∫•u h√¨nh ph∆∞∆°ng th·ª©c chi ti·ªÅn.' };\r\n  }\r\n\r\n  const account = pickAccount({\r\n    accountSystemId: options.accountSystemId,\r\n    preferredType: options.accountPreference,\r\n    branchSystemId: options.branchSystemId,\r\n    paymentMethodName: paymentMethod.name,\r\n  });\r\n  if (!account) {\r\n    return { document: null, error: 'Ch∆∞a c·∫•u h√¨nh t√†i kho·∫£n qu·ªπ ph√π h·ª£p ƒë·ªÉ t·∫°o phi·∫øu chi.' };\r\n  }\r\n\r\n  const paymentType = pickPaymentType({\r\n    systemId: options.paymentTypeSystemId,\r\n    name: options.paymentTypeName,\r\n  });\r\n  if (!paymentType) {\r\n    return { document: null, error: 'Ch∆∞a c·∫•u h√¨nh lo·∫°i phi·∫øu chi.' };\r\n  }\r\n\r\n  const timestamp = options.date ?? toISODateTime(new Date());\r\n  const payload: PaymentInput = {\r\n    date: timestamp,\r\n    amount: options.amount,\r\n    recipientTypeSystemId: targetGroup.systemId,\r\n    recipientTypeName: targetGroup.name,\r\n    recipientName: options.recipientName,\r\n    recipientSystemId: options.recipientSystemId,\r\n    description: options.description,\r\n    paymentMethodSystemId: paymentMethod.systemId,\r\n    paymentMethodName: paymentMethod.name,\r\n    accountSystemId: account.systemId,\r\n    paymentReceiptTypeSystemId: paymentType.systemId,\r\n    paymentReceiptTypeName: paymentType.name,\r\n    branchSystemId: options.branchSystemId,\r\n    branchName: options.branchName,\r\n    createdBy: options.createdBy,\r\n    createdAt: timestamp,\r\n    status: options.status ?? 'completed',\r\n    category: options.category,\r\n    originalDocumentId: asBusinessIdOrUndefined(options.originalDocumentId),\r\n    linkedOrderSystemId: options.linkedOrderSystemId,\r\n    linkedSalesReturnSystemId: options.linkedSalesReturnSystemId,\r\n    linkedWarrantySystemId: options.linkedWarrantySystemId,\r\n    linkedComplaintSystemId: options.linkedComplaintSystemId,\r\n    customerSystemId: options.customerSystemId,\r\n    customerName: options.customerName ?? options.recipientName,\r\n    affectsDebt: options.affectsDebt ?? true,\r\n  };\r\n\r\n  const payment = usePaymentStore.getState().add(payload);\r\n  return { document: payment };\r\n};\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1678, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/receipts/store.ts"],"sourcesContent":["import { create } from 'zustand';\r\nimport { subscribeWithSelector } from 'zustand/middleware';\r\nimport type { Receipt } from './types';\r\nimport type { HistoryEntry } from '../../components/ActivityHistory';\r\nimport { \r\n  findNextAvailableBusinessId, \r\n  generateSystemId, \r\n  getMaxBusinessIdCounter, \r\n  getMaxSystemIdCounter,\r\n  extractCounterFromBusinessId,\r\n  type EntityType \r\n} from '@/lib/id-utils';\r\nimport { asSystemId, asBusinessId, type BusinessId, type SystemId } from '@/lib/id-types';\r\n// REMOVED: import { data as initialData } from './data'; // Mock data no longer used - database is source of truth\r\nimport { pickAccount, pickPaymentMethod, pickReceiptType, pickTargetGroup } from '@/features/finance/document-lookups';\r\nimport { useEmployeeStore } from '../employees/store';\r\nimport { getCurrentUserSystemId } from '../../contexts/auth-context';\r\n\r\n// API sync helpers\r\nasync function syncToAPI(action: 'create' | 'update' | 'delete', data: any): Promise<boolean> {\r\n  try {\r\n    const endpoint = action === 'create' ? '/api/receipts' : `/api/receipts/${data.systemId}`;\r\n    const method = action === 'create' ? 'POST' : action === 'update' ? 'PATCH' : 'DELETE';\r\n    \r\n    const response = await fetch(endpoint, {\r\n      method,\r\n      headers: { 'Content-Type': 'application/json' },\r\n      body: action !== 'delete' ? JSON.stringify(data) : undefined,\r\n    });\r\n    \r\n    if (!response.ok) {\r\n      console.error(`[Receipts API] ${action} failed:`, await response.text());\r\n      return false;\r\n    }\r\n    return true;\r\n  } catch (error) {\r\n    console.error(`[Receipts API] ${action} error:`, error);\r\n    return false;\r\n  }\r\n}\r\n\r\n// Helper to get current user info\r\nconst getCurrentUserInfo = () => {\r\n  const currentUserSystemId = getCurrentUserSystemId?.() || 'SYSTEM';\r\n  const employee = useEmployeeStore.getState().data.find(e => e.systemId === currentUserSystemId);\r\n  return {\r\n    systemId: currentUserSystemId,\r\n    name: employee?.fullName || 'H·ªá th·ªëng',\r\n    avatar: employee?.avatarUrl,\r\n  };\r\n};\r\n\r\n// Helper to create history entry\r\nconst createHistoryEntry = (\r\n  action: HistoryEntry['action'],\r\n  description: string,\r\n  metadata?: HistoryEntry['metadata']\r\n): HistoryEntry => ({\r\n  id: crypto.randomUUID(),\r\n  action,\r\n  timestamp: new Date(),\r\n  user: getCurrentUserInfo(),\r\n  description,\r\n  metadata,\r\n});\r\n\r\nconst SYSTEM_AUTHOR = asSystemId('SYSTEM');\r\nconst getCurrentReceiptAuthor = (): SystemId => {\r\n  const userId = getCurrentUserSystemId?.();\r\n  return userId ? asSystemId(userId) : SYSTEM_AUTHOR;\r\n};\r\n\r\nexport type ReceiptInput = Omit<Receipt, 'systemId' | 'id'> & { id?: BusinessId };\r\n\r\ninterface ReceiptStore {\r\n  data: Receipt[];\r\n  businessIdCounter: number;\r\n  systemIdCounter: number;\r\n  initialized: boolean;\r\n  add: (item: ReceiptInput) => Receipt;\r\n  addMultiple: (items: ReceiptInput[]) => void;\r\n  update: (systemId: SystemId, item: Receipt) => void;\r\n  remove: (systemId: SystemId) => void;\r\n  findById: (systemId: SystemId) => Receipt | undefined;\r\n  getActive: () => Receipt[];\r\n  cancel: (systemId: SystemId, reason?: string) => void;\r\n  loadFromAPI: () => Promise<void>;\r\n}\r\n\r\nconst RECEIPT_ENTITY: EntityType = 'receipts';\r\nconst SYSTEM_ID_PREFIX = 'RECEIPT';\r\nconst BUSINESS_ID_PREFIX = 'PT';\r\nconst BUSINESS_ID_DIGITS = 6;\r\n\r\nconst normalizeReceiptStatus = (status?: Receipt['status']): Receipt['status'] =>\r\n  status === 'cancelled' ? 'cancelled' : 'completed';\r\n\r\nconst ensureReceiptMetadata = (receipt: Receipt): Receipt => {\r\n  let mutated = false;\r\n  const updates: Partial<Receipt> = {};\r\n\r\n  const targetGroup = pickTargetGroup({\r\n    systemId: receipt.payerTypeSystemId,\r\n    name: receipt.payerTypeName,\r\n  });\r\n  if (targetGroup) {\r\n    if (receipt.payerTypeSystemId !== targetGroup.systemId) {\r\n      updates.payerTypeSystemId = targetGroup.systemId;\r\n      mutated = true;\r\n    }\r\n    if (receipt.payerTypeName !== targetGroup.name) {\r\n      updates.payerTypeName = targetGroup.name;\r\n      mutated = true;\r\n    }\r\n  }\r\n\r\n  const paymentMethod = pickPaymentMethod({\r\n    systemId: receipt.paymentMethodSystemId,\r\n    name: receipt.paymentMethodName,\r\n  });\r\n  if (paymentMethod) {\r\n    if (receipt.paymentMethodSystemId !== paymentMethod.systemId) {\r\n      updates.paymentMethodSystemId = paymentMethod.systemId;\r\n      mutated = true;\r\n    }\r\n    if (receipt.paymentMethodName !== paymentMethod.name) {\r\n      updates.paymentMethodName = paymentMethod.name;\r\n      mutated = true;\r\n    }\r\n  }\r\n\r\n  const account = pickAccount({\r\n    accountSystemId: receipt.accountSystemId,\r\n    branchSystemId: receipt.branchSystemId,\r\n    paymentMethodName: paymentMethod?.name ?? receipt.paymentMethodName,\r\n  });\r\n  if (account && receipt.accountSystemId !== account.systemId) {\r\n    updates.accountSystemId = account.systemId;\r\n    mutated = true;\r\n  }\r\n\r\n  const receiptType = pickReceiptType({\r\n    systemId: receipt.paymentReceiptTypeSystemId,\r\n    name: receipt.paymentReceiptTypeName,\r\n  });\r\n  if (receiptType) {\r\n    if (receipt.paymentReceiptTypeSystemId !== receiptType.systemId) {\r\n      updates.paymentReceiptTypeSystemId = receiptType.systemId;\r\n      mutated = true;\r\n    }\r\n    if (receipt.paymentReceiptTypeName !== receiptType.name) {\r\n      updates.paymentReceiptTypeName = receiptType.name;\r\n      mutated = true;\r\n    }\r\n  }\r\n\r\n  if (!receipt.customerName && receipt.payerName) {\r\n    updates.customerName = receipt.payerName;\r\n    mutated = true;\r\n  }\r\n\r\n  if (!receipt.customerSystemId && receipt.payerSystemId) {\r\n    updates.customerSystemId = receipt.payerSystemId;\r\n    mutated = true;\r\n  }\r\n\r\n  return mutated ? { ...receipt, ...updates } : receipt;\r\n};\r\n\r\nconst backfillReceiptMetadata = (receipts: Receipt[]): Receipt[] => {\r\n  let mutated = false;\r\n  const updated = receipts.map(receipt => {\r\n    const normalized = ensureReceiptMetadata(receipt);\r\n    if (normalized !== receipt) {\r\n      mutated = true;\r\n    }\r\n    return normalized;\r\n  });\r\n  return mutated ? updated : receipts;\r\n};\r\n\r\nconst initialReceipts: Receipt[] = []; // Database is source of truth\r\n\r\nlet systemIdCounter = getMaxSystemIdCounter(initialReceipts, SYSTEM_ID_PREFIX);\r\nlet businessIdCounter = getMaxBusinessIdCounter(initialReceipts, BUSINESS_ID_PREFIX);\r\n\r\nconst getNextSystemId = (): SystemId => {\r\n  systemIdCounter += 1;\r\n  return asSystemId(generateSystemId(RECEIPT_ENTITY, systemIdCounter));\r\n};\r\n\r\nconst ensureReceiptBusinessId = (receipts: Receipt[], provided?: BusinessId | string): BusinessId => {\r\n  if (provided && `${provided}`.trim().length > 0) {\r\n    const normalized = `${provided}`.trim().toUpperCase();\r\n    const parsedCounter = extractCounterFromBusinessId(normalized, BUSINESS_ID_PREFIX);\r\n    if (parsedCounter > businessIdCounter) {\r\n      businessIdCounter = parsedCounter;\r\n    }\r\n    return asBusinessId(normalized);\r\n  }\r\n\r\n  const existingIds = receipts.map(receipt => receipt.id as string).filter(Boolean);\r\n  const { nextId, updatedCounter } = findNextAvailableBusinessId(\r\n    BUSINESS_ID_PREFIX,\r\n    existingIds,\r\n    businessIdCounter,\r\n    BUSINESS_ID_DIGITS\r\n  );\r\n  businessIdCounter = updatedCounter;\r\n  return asBusinessId(nextId);\r\n};\r\n\r\nexport const useReceiptStore = create<ReceiptStore>()(\r\n  subscribeWithSelector(\r\n    (set, get) => ({\r\n      data: initialReceipts,\r\n      businessIdCounter,\r\n      systemIdCounter,\r\n      initialized: false,\r\n      \r\n      add: (item: ReceiptInput): Receipt => {\r\n        let createdReceipt: Receipt | null = null;\r\n        set(state => {\r\n          const systemId = getNextSystemId();\r\n          const id = ensureReceiptBusinessId(state.data, item.id);\r\n          const createdBy = item.createdBy ?? getCurrentReceiptAuthor();\r\n          \r\n          const newReceipt: Receipt = { \r\n            ...item, \r\n            systemId, \r\n            id,\r\n            createdBy,\r\n            createdAt: item.createdAt || new Date().toISOString(),\r\n            status: normalizeReceiptStatus(item.status),\r\n            orderAllocations: item.orderAllocations ?? [],\r\n          };\r\n\r\n          const normalizedReceipt = ensureReceiptMetadata(newReceipt);\r\n          createdReceipt = normalizedReceipt;\r\n\r\n          return { \r\n            data: [...state.data, normalizedReceipt],\r\n            businessIdCounter,\r\n            systemIdCounter\r\n          };\r\n        });\r\n        // Sync to API\r\n        if (createdReceipt) {\r\n          syncToAPI('create', createdReceipt).catch(console.error);\r\n        }\r\n        return createdReceipt!;\r\n      },\r\n      \r\n      addMultiple: (items: ReceiptInput[]) => {\r\n        const created: Receipt[] = [];\r\n        set(state => {\r\n          items.forEach(item => {\r\n            const context = [...state.data, ...created];\r\n            const systemId = getNextSystemId();\r\n            const id = ensureReceiptBusinessId(context, item.id);\r\n            const createdBy = item.createdBy ?? getCurrentReceiptAuthor();\r\n            \r\n            const newReceipt: Receipt = { \r\n              ...item, \r\n              systemId, \r\n              id,\r\n              createdBy,\r\n              createdAt: item.createdAt || new Date().toISOString(),\r\n              status: normalizeReceiptStatus(item.status),\r\n              orderAllocations: item.orderAllocations ?? [],\r\n            };\r\n            created.push(ensureReceiptMetadata(newReceipt));\r\n          });\r\n          \r\n          return { \r\n            data: [...state.data, ...created],\r\n            businessIdCounter,\r\n            systemIdCounter\r\n          };\r\n        });\r\n        // Sync all to API\r\n        created.forEach(receipt => {\r\n          syncToAPI('create', receipt).catch(console.error);\r\n        });\r\n      },\r\n      \r\n      update: (systemId: SystemId, item: Receipt) => {\r\n        const updated = { ...item, status: normalizeReceiptStatus(item.status), updatedAt: new Date().toISOString() };\r\n        set(state => ({\r\n          data: state.data.map(r => r.systemId === systemId ? updated : r),\r\n          businessIdCounter,\r\n          systemIdCounter\r\n        }));\r\n        // Sync to API\r\n        syncToAPI('update', updated).catch(console.error);\r\n      },\r\n      \r\n      remove: (systemId: SystemId) => {\r\n        set(state => ({\r\n          data: state.data.filter(r => r.systemId !== systemId),\r\n          businessIdCounter,\r\n          systemIdCounter\r\n        }));\r\n        // Sync to API\r\n        syncToAPI('delete', { systemId }).catch(console.error);\r\n      },\r\n      \r\n      findById: (systemId: SystemId) => {\r\n        return get().data.find(r => r.systemId === systemId);\r\n      },\r\n      \r\n      getActive: () => {\r\n        return get().data.filter(r => r.status !== 'cancelled');\r\n      },\r\n      \r\n      cancel: (systemId: SystemId, reason?: string) => {\r\n        const receipt = get().findById(systemId);\r\n        if (receipt && receipt.status !== 'cancelled') {\r\n          const historyEntry = createHistoryEntry(\r\n            'cancelled',\r\n            `ƒê√£ h·ªßy phi·∫øu thu${reason ? `: ${reason}` : ''}`,\r\n            { oldValue: 'Ho√†n th√†nh', newValue: 'ƒê√£ h·ªßy', note: reason }\r\n          );\r\n          \r\n          get().update(systemId, {\r\n            ...receipt,\r\n            status: 'cancelled',\r\n            cancelledAt: new Date().toISOString(),\r\n            activityHistory: [...(receipt.activityHistory || []), historyEntry],\r\n          });\r\n        }\r\n      },\r\n      \r\n      loadFromAPI: async () => {\r\n        try {\r\n          // NOTE: Use React Query hooks for paginated data. This only loads initial batch.\r\n          const response = await fetch('/api/receipts?limit=30');\r\n          if (!response.ok) return;\r\n          const json = await response.json();\r\n          const apiData = json.data || [];\r\n          if (apiData.length > 0) {\r\n            const normalized = backfillReceiptMetadata(apiData.map((receipt: Receipt) => ({\r\n              ...receipt,\r\n              status: normalizeReceiptStatus(receipt.status),\r\n            })));\r\n            const nextSystemCounter = getMaxSystemIdCounter(normalized, SYSTEM_ID_PREFIX);\r\n            const nextBusinessCounter = getMaxBusinessIdCounter(normalized, BUSINESS_ID_PREFIX);\r\n            systemIdCounter = nextSystemCounter;\r\n            businessIdCounter = nextBusinessCounter;\r\n            set({ \r\n              data: normalized, \r\n              systemIdCounter, \r\n              businessIdCounter,\r\n              initialized: true \r\n            });\r\n          } else {\r\n            set({ initialized: true });\r\n          }\r\n        } catch (error) {\r\n          console.error('[Receipts API] loadFromAPI error:', error);\r\n        }\r\n      },\r\n    })\r\n  )\r\n);\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 2006, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/payments/store.ts"],"sourcesContent":["import { create } from 'zustand';\r\nimport type { Payment } from './types';\r\nimport type { HistoryEntry } from '../../components/ActivityHistory';\r\n// REMOVED: import { data as initialData } from './data'; // Mock data no longer used - database is source of truth\r\nimport {\r\n  extractCounterFromBusinessId,\r\n  findNextAvailableBusinessId,\r\n  generateSystemId,\r\n  getMaxBusinessIdCounter,\r\n  getMaxSystemIdCounter,\r\n  type EntityType,\r\n} from '../../lib/id-utils';\r\nimport { asBusinessId, asSystemId, type BusinessId, type SystemId } from '../../lib/id-types';\r\nimport { pickAccount, pickPaymentMethod, pickPaymentType, pickTargetGroup } from '@/features/finance/document-lookups';\r\nimport { useEmployeeStore } from '../employees/store';\r\nimport { getCurrentUserSystemId } from '../../contexts/auth-context';\r\n\r\n// API sync helpers\r\nasync function syncToAPI(action: 'create' | 'update' | 'delete', data: any): Promise<boolean> {\r\n  try {\r\n    const endpoint = action === 'create' ? '/api/payments' : `/api/payments/${data.systemId}`;\r\n    const method = action === 'create' ? 'POST' : action === 'update' ? 'PATCH' : 'DELETE';\r\n    \r\n    const response = await fetch(endpoint, {\r\n      method,\r\n      headers: { 'Content-Type': 'application/json' },\r\n      body: action !== 'delete' ? JSON.stringify(data) : undefined,\r\n    });\r\n    \r\n    if (!response.ok) {\r\n      console.error(`[Payments API] ${action} failed:`, await response.text());\r\n      return false;\r\n    }\r\n    return true;\r\n  } catch (error) {\r\n    console.error(`[Payments API] ${action} error:`, error);\r\n    return false;\r\n  }\r\n}\r\n\r\n// Helper to get current user info\r\nconst getCurrentUserInfo = () => {\r\n  const currentUserSystemId = getCurrentUserSystemId?.() || 'SYSTEM';\r\n  const employee = useEmployeeStore.getState().data.find(e => e.systemId === currentUserSystemId);\r\n  return {\r\n    systemId: currentUserSystemId,\r\n    name: employee?.fullName || 'H·ªá th·ªëng',\r\n    avatar: employee?.avatarUrl,\r\n  };\r\n};\r\n\r\n// Helper to create history entry\r\nconst createHistoryEntry = (\r\n  action: HistoryEntry['action'],\r\n  description: string,\r\n  metadata?: HistoryEntry['metadata']\r\n): HistoryEntry => ({\r\n  id: crypto.randomUUID(),\r\n  action,\r\n  timestamp: new Date(),\r\n  user: getCurrentUserInfo(),\r\n  description,\r\n  metadata,\r\n});\r\n\r\nexport type PaymentInput = Omit<Payment, 'systemId' | 'id'> & { id?: BusinessId | string };\r\n\r\ninterface PaymentStore {\r\n  data: Payment[];\r\n  businessIdCounter: number;\r\n  systemIdCounter: number;\r\n  initialized: boolean;\r\n  add: (item: PaymentInput) => Payment;\r\n  addMultiple: (items: PaymentInput[]) => void;\r\n  update: (systemId: SystemId, item: Payment) => void;\r\n  remove: (systemId: SystemId) => void;\r\n  findById: (systemId: SystemId) => Payment | undefined;\r\n  getActive: () => Payment[];\r\n  cancel: (systemId: SystemId, reason?: string) => void;\r\n  loadFromAPI: () => Promise<void>;\r\n}\r\n\r\nconst PAYMENT_ENTITY: EntityType = 'payments';\r\nconst SYSTEM_ID_PREFIX = 'PAYMENT';\r\nconst BUSINESS_ID_PREFIX = 'PC';\r\nconst BUSINESS_ID_DIGITS = 6;\r\nconst PURCHASE_ORDER_SYSTEM_PREFIX = 'PURCHASE';\r\nconst PURCHASE_ORDER_BUSINESS_PREFIX = 'PO';\r\n\r\nconst normalizePaymentStatus = (status?: Payment['status']): Payment['status'] =>\r\n  status === 'cancelled' ? 'cancelled' : 'completed';\r\n\r\nconst normalizePayment = (payment: Payment): Payment => ({\r\n  ...payment,\r\n  status: normalizePaymentStatus(payment.status),\r\n});\r\n\r\nconst ensurePaymentMetadata = (payment: Payment): Payment => {\r\n  let mutated = false;\r\n  const updates: Partial<Payment> = {};\r\n\r\n  const targetGroup = pickTargetGroup({\r\n    systemId: payment.recipientTypeSystemId,\r\n    name: payment.recipientTypeName,\r\n  });\r\n  if (targetGroup) {\r\n    if (payment.recipientTypeSystemId !== targetGroup.systemId) {\r\n      updates.recipientTypeSystemId = targetGroup.systemId;\r\n      mutated = true;\r\n    }\r\n    if (payment.recipientTypeName !== targetGroup.name) {\r\n      updates.recipientTypeName = targetGroup.name;\r\n      mutated = true;\r\n    }\r\n  }\r\n\r\n  const paymentMethod = pickPaymentMethod({\r\n    systemId: payment.paymentMethodSystemId,\r\n    name: payment.paymentMethodName,\r\n  });\r\n  if (paymentMethod) {\r\n    if (payment.paymentMethodSystemId !== paymentMethod.systemId) {\r\n      updates.paymentMethodSystemId = paymentMethod.systemId;\r\n      mutated = true;\r\n    }\r\n    if (payment.paymentMethodName !== paymentMethod.name) {\r\n      updates.paymentMethodName = paymentMethod.name;\r\n      mutated = true;\r\n    }\r\n  }\r\n\r\n  const account = pickAccount({\r\n    accountSystemId: payment.accountSystemId,\r\n    branchSystemId: payment.branchSystemId,\r\n    paymentMethodName: paymentMethod?.name ?? payment.paymentMethodName,\r\n  });\r\n  if (account && payment.accountSystemId !== account.systemId) {\r\n    updates.accountSystemId = account.systemId;\r\n    mutated = true;\r\n  }\r\n\r\n  const paymentType = pickPaymentType({\r\n    systemId: payment.paymentReceiptTypeSystemId,\r\n    name: payment.paymentReceiptTypeName,\r\n  });\r\n  if (paymentType) {\r\n    if (payment.paymentReceiptTypeSystemId !== paymentType.systemId) {\r\n      updates.paymentReceiptTypeSystemId = paymentType.systemId;\r\n      mutated = true;\r\n    }\r\n    if (payment.paymentReceiptTypeName !== paymentType.name) {\r\n      updates.paymentReceiptTypeName = paymentType.name;\r\n      mutated = true;\r\n    }\r\n  }\r\n\r\n  const normalizedGroupName = targetGroup?.name?.trim().toLowerCase();\r\n  if (normalizedGroupName === 'kh√°ch h√†ng') {\r\n    if (!payment.customerName && payment.recipientName) {\r\n      updates.customerName = payment.recipientName;\r\n      mutated = true;\r\n    }\r\n    if (!payment.customerSystemId && payment.recipientSystemId) {\r\n      updates.customerSystemId = payment.recipientSystemId;\r\n      mutated = true;\r\n    }\r\n  }\r\n\r\n  return mutated ? { ...payment, ...updates } : payment;\r\n};\r\n\r\nconst backfillPaymentMetadata = (payments: Payment[]): Payment[] => {\r\n  let mutated = false;\r\n  const updated = payments.map(payment => {\r\n    const normalized = ensurePaymentMetadata(payment);\r\n    if (normalized !== payment) {\r\n      mutated = true;\r\n    }\r\n    return normalized;\r\n  });\r\n  return mutated ? updated : payments;\r\n};\r\n\r\nconst initialPayments: Payment[] = []; // Database is source of truth\r\n\r\nlet systemIdCounter = getMaxSystemIdCounter(initialPayments, SYSTEM_ID_PREFIX);\r\nlet businessIdCounter = getMaxBusinessIdCounter(initialPayments, BUSINESS_ID_PREFIX);\r\n\r\nconst getNextSystemId = (): SystemId => {\r\n  systemIdCounter += 1;\r\n  return asSystemId(generateSystemId(PAYMENT_ENTITY, systemIdCounter));\r\n};\r\n\r\nconst ensurePaymentBusinessId = (payments: Payment[], provided?: BusinessId | string): BusinessId => {\r\n  if (provided && `${provided}`.trim().length > 0) {\r\n    const normalized = `${provided}`.trim().toUpperCase();\r\n    const parsedCounter = extractCounterFromBusinessId(normalized, BUSINESS_ID_PREFIX);\r\n    if (parsedCounter > businessIdCounter) {\r\n      businessIdCounter = parsedCounter;\r\n    }\r\n    return asBusinessId(normalized);\r\n  }\r\n\r\n  const existingIds = payments.map(payment => payment.id as string).filter(Boolean);\r\n  const { nextId, updatedCounter } = findNextAvailableBusinessId(\r\n    BUSINESS_ID_PREFIX,\r\n    existingIds,\r\n    businessIdCounter,\r\n    BUSINESS_ID_DIGITS\r\n  );\r\n  businessIdCounter = updatedCounter;\r\n  return asBusinessId(nextId);\r\n};\r\n\r\nconst reconcileLinkedDocuments = (payment: Payment): Payment => {\r\n  if (!payment.originalDocumentId) {\r\n    return payment;\r\n  }\r\n\r\n  const normalizedDocId = payment.originalDocumentId.toUpperCase();\r\n  const nextPayment = { ...payment };\r\n\r\n  if (!nextPayment.purchaseOrderSystemId && normalizedDocId.startsWith(PURCHASE_ORDER_SYSTEM_PREFIX)) {\r\n    nextPayment.purchaseOrderSystemId = asSystemId(payment.originalDocumentId);\r\n  }\r\n\r\n  if (!nextPayment.purchaseOrderId && normalizedDocId.startsWith(PURCHASE_ORDER_BUSINESS_PREFIX)) {\r\n    nextPayment.purchaseOrderId = asBusinessId(payment.originalDocumentId);\r\n  }\r\n\r\n  return nextPayment;\r\n};\r\n\r\nconst buildPayment = (input: PaymentInput, existingPayments: Payment[]): Payment => {\r\n  const systemId = getNextSystemId();\r\n  const id = ensurePaymentBusinessId(existingPayments, input.id);\r\n  const basePayment: Payment = {\r\n    ...input,\r\n    systemId,\r\n    id,\r\n    createdAt: input.createdAt || new Date().toISOString(),\r\n    status: normalizePaymentStatus(input.status),\r\n  };\r\n\r\n  return reconcileLinkedDocuments(basePayment);\r\n};\r\n\r\nexport const usePaymentStore = create<PaymentStore>()(\r\n  (set, get) => ({\r\n      data: initialPayments,\r\n      businessIdCounter,\r\n      systemIdCounter,\r\n      initialized: false,\r\n      \r\n      add: (item) => {\r\n        let createdPayment: Payment | null = null;\r\n        set(state => {\r\n          const newPayment = buildPayment(item, state.data);\r\n          createdPayment = newPayment;\r\n          return {\r\n            data: [...state.data, newPayment],\r\n            businessIdCounter,\r\n            systemIdCounter,\r\n          };\r\n        });\r\n        // Sync to API\r\n        if (createdPayment) {\r\n          syncToAPI('create', createdPayment).catch(console.error);\r\n        }\r\n        return createdPayment!;\r\n      },\r\n      \r\n      addMultiple: (items) => {\r\n        const created: Payment[] = [];\r\n        set(state => {\r\n          items.forEach(item => {\r\n            const context = [...state.data, ...created];\r\n            const payment = buildPayment(item, context);\r\n            created.push(payment);\r\n          });\r\n\r\n          return {\r\n            data: [...state.data, ...created],\r\n            businessIdCounter,\r\n            systemIdCounter,\r\n          };\r\n        });\r\n        // Sync all to API\r\n        created.forEach(payment => {\r\n          syncToAPI('create', payment).catch(console.error);\r\n        });\r\n      },\r\n      \r\n      update: (systemId, item) => {\r\n        const updated = reconcileLinkedDocuments({\r\n          ...item,\r\n          systemId,\r\n          status: normalizePaymentStatus(item.status),\r\n          updatedAt: new Date().toISOString(),\r\n        });\r\n        set(state => ({\r\n          data: state.data.map(payment =>\r\n            payment.systemId === systemId ? updated : payment\r\n          ),\r\n          businessIdCounter,\r\n          systemIdCounter,\r\n        }));\r\n        // Sync to API\r\n        syncToAPI('update', updated).catch(console.error);\r\n      },\r\n      \r\n      remove: (systemId) => {\r\n        set(state => ({\r\n          data: state.data.filter(payment => payment.systemId !== systemId),\r\n          businessIdCounter,\r\n          systemIdCounter,\r\n        }));\r\n        // Sync to API\r\n        syncToAPI('delete', { systemId }).catch(console.error);\r\n      },\r\n      \r\n      findById: (systemId) => {\r\n        return get().data.find(payment => payment.systemId === systemId);\r\n      },\r\n      \r\n      getActive: () => {\r\n        return get().data.filter(payment => payment.status !== 'cancelled');\r\n      },\r\n      \r\n      cancel: (systemId: SystemId, reason?: string) => {\r\n        const payment = get().findById(systemId);\r\n        if (payment && payment.status !== 'cancelled') {\r\n          const historyEntry = createHistoryEntry(\r\n            'cancelled',\r\n            `ƒê√£ h·ªßy phi·∫øu chi${reason ? `: ${reason}` : ''}`,\r\n            { oldValue: 'Ho√†n th√†nh', newValue: 'ƒê√£ h·ªßy', note: reason }\r\n          );\r\n          \r\n          get().update(systemId, {\r\n            ...payment,\r\n            status: 'cancelled',\r\n            cancelledAt: new Date().toISOString(),\r\n            activityHistory: [...(payment.activityHistory || []), historyEntry],\r\n          });\r\n        }\r\n      },\r\n      \r\n      loadFromAPI: async () => {\r\n        try {\r\n          // NOTE: Use React Query hooks for paginated data. This only loads initial batch.\r\n          const response = await fetch('/api/payments?limit=30');\r\n          if (!response.ok) return;\r\n          const json = await response.json();\r\n          const apiData = json.data || [];\r\n          if (apiData.length > 0) {\r\n            const normalized = backfillPaymentMetadata(apiData.map(normalizePayment));\r\n            const nextSystemCounter = getMaxSystemIdCounter(normalized, SYSTEM_ID_PREFIX);\r\n            const nextBusinessCounter = getMaxBusinessIdCounter(normalized, BUSINESS_ID_PREFIX);\r\n            systemIdCounter = nextSystemCounter;\r\n            businessIdCounter = nextBusinessCounter;\r\n            set({ \r\n              data: normalized, \r\n              systemIdCounter, \r\n              businessIdCounter,\r\n              initialized: true \r\n            });\r\n          } else {\r\n            set({ initialized: true });\r\n          }\r\n        } catch (error) {\r\n          console.error('[Payments API] loadFromAPI error:', error);\r\n        }\r\n      },\r\n    })\r\n);\r\n"],"names":[],"mappings":";;;;AAAA;AAGA,mHAAmH;AACnH;AAQA;AACA;AACA;AACA;;;;;;;AAEA,mBAAmB;AACnB,eAAe,UAAU,MAAsC,EAAE,IAAS;IACxE,IAAI;QACF,MAAM,WAAW,WAAW,WAAW,kBAAkB,CAAC,cAAc,EAAE,KAAK,QAAQ,EAAE;QACzF,MAAM,SAAS,WAAW,WAAW,SAAS,WAAW,WAAW,UAAU;QAE9E,MAAM,WAAW,MAAM,MAAM,UAAU;YACrC;YACA,SAAS;gBAAE,gBAAgB;YAAmB;YAC9C,MAAM,WAAW,WAAW,KAAK,SAAS,CAAC,QAAQ;QACrD;QAEA,IAAI,CAAC,SAAS,EAAE,EAAE;YAChB,QAAQ,KAAK,CAAC,CAAC,eAAe,EAAE,OAAO,QAAQ,CAAC,EAAE,MAAM,SAAS,IAAI;YACrE,OAAO;QACT;QACA,OAAO;IACT,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,CAAC,eAAe,EAAE,OAAO,OAAO,CAAC,EAAE;QACjD,OAAO;IACT;AACF;AAEA,kCAAkC;AAClC,MAAM,qBAAqB;IACzB,MAAM,sBAAsB,sJAAsB,QAAQ;IAC1D,MAAM,WAAW,kJAAgB,CAAC,QAAQ,GAAG,IAAI,CAAC,IAAI,CAAC,CAAA,IAAK,EAAE,QAAQ,KAAK;IAC3E,OAAO;QACL,UAAU;QACV,MAAM,UAAU,YAAY;QAC5B,QAAQ,UAAU;IACpB;AACF;AAEA,iCAAiC;AACjC,MAAM,qBAAqB,CACzB,QACA,aACA,WACiB,CAAC;QAClB,IAAI,OAAO,UAAU;QACrB;QACA,WAAW,IAAI;QACf,MAAM;QACN;QACA;IACF,CAAC;AAmBD,MAAM,iBAA6B;AACnC,MAAM,mBAAmB;AACzB,MAAM,qBAAqB;AAC3B,MAAM,qBAAqB;AAC3B,MAAM,+BAA+B;AACrC,MAAM,iCAAiC;AAEvC,MAAM,yBAAyB,CAAC,SAC9B,WAAW,cAAc,cAAc;AAEzC,MAAM,mBAAmB,CAAC,UAA8B,CAAC;QACvD,GAAG,OAAO;QACV,QAAQ,uBAAuB,QAAQ,MAAM;IAC/C,CAAC;AAED,MAAM,wBAAwB,CAAC;IAC7B,IAAI,UAAU;IACd,MAAM,UAA4B,CAAC;IAEnC,MAAM,cAAc,IAAA,6JAAe,EAAC;QAClC,UAAU,QAAQ,qBAAqB;QACvC,MAAM,QAAQ,iBAAiB;IACjC;IACA,IAAI,aAAa;QACf,IAAI,QAAQ,qBAAqB,KAAK,YAAY,QAAQ,EAAE;YAC1D,QAAQ,qBAAqB,GAAG,YAAY,QAAQ;YACpD,UAAU;QACZ;QACA,IAAI,QAAQ,iBAAiB,KAAK,YAAY,IAAI,EAAE;YAClD,QAAQ,iBAAiB,GAAG,YAAY,IAAI;YAC5C,UAAU;QACZ;IACF;IAEA,MAAM,gBAAgB,IAAA,+JAAiB,EAAC;QACtC,UAAU,QAAQ,qBAAqB;QACvC,MAAM,QAAQ,iBAAiB;IACjC;IACA,IAAI,eAAe;QACjB,IAAI,QAAQ,qBAAqB,KAAK,cAAc,QAAQ,EAAE;YAC5D,QAAQ,qBAAqB,GAAG,cAAc,QAAQ;YACtD,UAAU;QACZ;QACA,IAAI,QAAQ,iBAAiB,KAAK,cAAc,IAAI,EAAE;YACpD,QAAQ,iBAAiB,GAAG,cAAc,IAAI;YAC9C,UAAU;QACZ;IACF;IAEA,MAAM,UAAU,IAAA,yJAAW,EAAC;QAC1B,iBAAiB,QAAQ,eAAe;QACxC,gBAAgB,QAAQ,cAAc;QACtC,mBAAmB,eAAe,QAAQ,QAAQ,iBAAiB;IACrE;IACA,IAAI,WAAW,QAAQ,eAAe,KAAK,QAAQ,QAAQ,EAAE;QAC3D,QAAQ,eAAe,GAAG,QAAQ,QAAQ;QAC1C,UAAU;IACZ;IAEA,MAAM,cAAc,IAAA,6JAAe,EAAC;QAClC,UAAU,QAAQ,0BAA0B;QAC5C,MAAM,QAAQ,sBAAsB;IACtC;IACA,IAAI,aAAa;QACf,IAAI,QAAQ,0BAA0B,KAAK,YAAY,QAAQ,EAAE;YAC/D,QAAQ,0BAA0B,GAAG,YAAY,QAAQ;YACzD,UAAU;QACZ;QACA,IAAI,QAAQ,sBAAsB,KAAK,YAAY,IAAI,EAAE;YACvD,QAAQ,sBAAsB,GAAG,YAAY,IAAI;YACjD,UAAU;QACZ;IACF;IAEA,MAAM,sBAAsB,aAAa,MAAM,OAAO;IACtD,IAAI,wBAAwB,cAAc;QACxC,IAAI,CAAC,QAAQ,YAAY,IAAI,QAAQ,aAAa,EAAE;YAClD,QAAQ,YAAY,GAAG,QAAQ,aAAa;YAC5C,UAAU;QACZ;QACA,IAAI,CAAC,QAAQ,gBAAgB,IAAI,QAAQ,iBAAiB,EAAE;YAC1D,QAAQ,gBAAgB,GAAG,QAAQ,iBAAiB;YACpD,UAAU;QACZ;IACF;IAEA,OAAO,UAAU;QAAE,GAAG,OAAO;QAAE,GAAG,OAAO;IAAC,IAAI;AAChD;AAEA,MAAM,0BAA0B,CAAC;IAC/B,IAAI,UAAU;IACd,MAAM,UAAU,SAAS,GAAG,CAAC,CAAA;QAC3B,MAAM,aAAa,sBAAsB;QACzC,IAAI,eAAe,SAAS;YAC1B,UAAU;QACZ;QACA,OAAO;IACT;IACA,OAAO,UAAU,UAAU;AAC7B;AAEA,MAAM,kBAA6B,EAAE,EAAE,8BAA8B;AAErE,IAAI,kBAAkB,IAAA,2IAAqB,EAAC,iBAAiB;AAC7D,IAAI,oBAAoB,IAAA,6IAAuB,EAAC,iBAAiB;AAEjE,MAAM,kBAAkB;IACtB,mBAAmB;IACnB,OAAO,IAAA,gIAAU,EAAC,IAAA,sIAAgB,EAAC,gBAAgB;AACrD;AAEA,MAAM,0BAA0B,CAAC,UAAqB;IACpD,IAAI,YAAY,GAAG,UAAU,CAAC,IAAI,GAAG,MAAM,GAAG,GAAG;QAC/C,MAAM,aAAa,GAAG,UAAU,CAAC,IAAI,GAAG,WAAW;QACnD,MAAM,gBAAgB,IAAA,kJAA4B,EAAC,YAAY;QAC/D,IAAI,gBAAgB,mBAAmB;YACrC,oBAAoB;QACtB;QACA,OAAO,IAAA,kIAAY,EAAC;IACtB;IAEA,MAAM,cAAc,SAAS,GAAG,CAAC,CAAA,UAAW,QAAQ,EAAE,EAAY,MAAM,CAAC;IACzE,MAAM,EAAE,MAAM,EAAE,cAAc,EAAE,GAAG,IAAA,iJAA2B,EAC5D,oBACA,aACA,mBACA;IAEF,oBAAoB;IACpB,OAAO,IAAA,kIAAY,EAAC;AACtB;AAEA,MAAM,2BAA2B,CAAC;IAChC,IAAI,CAAC,QAAQ,kBAAkB,EAAE;QAC/B,OAAO;IACT;IAEA,MAAM,kBAAkB,QAAQ,kBAAkB,CAAC,WAAW;IAC9D,MAAM,cAAc;QAAE,GAAG,OAAO;IAAC;IAEjC,IAAI,CAAC,YAAY,qBAAqB,IAAI,gBAAgB,UAAU,CAAC,+BAA+B;QAClG,YAAY,qBAAqB,GAAG,IAAA,gIAAU,EAAC,QAAQ,kBAAkB;IAC3E;IAEA,IAAI,CAAC,YAAY,eAAe,IAAI,gBAAgB,UAAU,CAAC,iCAAiC;QAC9F,YAAY,eAAe,GAAG,IAAA,kIAAY,EAAC,QAAQ,kBAAkB;IACvE;IAEA,OAAO;AACT;AAEA,MAAM,eAAe,CAAC,OAAqB;IACzC,MAAM,WAAW;IACjB,MAAM,KAAK,wBAAwB,kBAAkB,MAAM,EAAE;IAC7D,MAAM,cAAuB;QAC3B,GAAG,KAAK;QACR;QACA;QACA,WAAW,MAAM,SAAS,IAAI,IAAI,OAAO,WAAW;QACpD,QAAQ,uBAAuB,MAAM,MAAM;IAC7C;IAEA,OAAO,yBAAyB;AAClC;AAEO,MAAM,kBAAkB,IAAA,kJAAM,IACnC,CAAC,KAAK,MAAQ,CAAC;QACX,MAAM;QACN;QACA;QACA,aAAa;QAEb,KAAK,CAAC;YACJ,IAAI,iBAAiC;YACrC,IAAI,CAAA;gBACF,MAAM,aAAa,aAAa,MAAM,MAAM,IAAI;gBAChD,iBAAiB;gBACjB,OAAO;oBACL,MAAM;2BAAI,MAAM,IAAI;wBAAE;qBAAW;oBACjC;oBACA;gBACF;YACF;YACA,cAAc;YACd,IAAI,gBAAgB;gBAClB,UAAU,UAAU,gBAAgB,KAAK,CAAC,QAAQ,KAAK;YACzD;YACA,OAAO;QACT;QAEA,aAAa,CAAC;YACZ,MAAM,UAAqB,EAAE;YAC7B,IAAI,CAAA;gBACF,MAAM,OAAO,CAAC,CAAA;oBACZ,MAAM,UAAU;2BAAI,MAAM,IAAI;2BAAK;qBAAQ;oBAC3C,MAAM,UAAU,aAAa,MAAM;oBACnC,QAAQ,IAAI,CAAC;gBACf;gBAEA,OAAO;oBACL,MAAM;2BAAI,MAAM,IAAI;2BAAK;qBAAQ;oBACjC;oBACA;gBACF;YACF;YACA,kBAAkB;YAClB,QAAQ,OAAO,CAAC,CAAA;gBACd,UAAU,UAAU,SAAS,KAAK,CAAC,QAAQ,KAAK;YAClD;QACF;QAEA,QAAQ,CAAC,UAAU;YACjB,MAAM,UAAU,yBAAyB;gBACvC,GAAG,IAAI;gBACP;gBACA,QAAQ,uBAAuB,KAAK,MAAM;gBAC1C,WAAW,IAAI,OAAO,WAAW;YACnC;YACA,IAAI,CAAA,QAAS,CAAC;oBACZ,MAAM,MAAM,IAAI,CAAC,GAAG,CAAC,CAAA,UACnB,QAAQ,QAAQ,KAAK,WAAW,UAAU;oBAE5C;oBACA;gBACF,CAAC;YACD,cAAc;YACd,UAAU,UAAU,SAAS,KAAK,CAAC,QAAQ,KAAK;QAClD;QAEA,QAAQ,CAAC;YACP,IAAI,CAAA,QAAS,CAAC;oBACZ,MAAM,MAAM,IAAI,CAAC,MAAM,CAAC,CAAA,UAAW,QAAQ,QAAQ,KAAK;oBACxD;oBACA;gBACF,CAAC;YACD,cAAc;YACd,UAAU,UAAU;gBAAE;YAAS,GAAG,KAAK,CAAC,QAAQ,KAAK;QACvD;QAEA,UAAU,CAAC;YACT,OAAO,MAAM,IAAI,CAAC,IAAI,CAAC,CAAA,UAAW,QAAQ,QAAQ,KAAK;QACzD;QAEA,WAAW;YACT,OAAO,MAAM,IAAI,CAAC,MAAM,CAAC,CAAA,UAAW,QAAQ,MAAM,KAAK;QACzD;QAEA,QAAQ,CAAC,UAAoB;YAC3B,MAAM,UAAU,MAAM,QAAQ,CAAC;YAC/B,IAAI,WAAW,QAAQ,MAAM,KAAK,aAAa;gBAC7C,MAAM,eAAe,mBACnB,aACA,CAAC,gBAAgB,EAAE,SAAS,CAAC,EAAE,EAAE,QAAQ,GAAG,IAAI,EAChD;oBAAE,UAAU;oBAAc,UAAU;oBAAU,MAAM;gBAAO;gBAG7D,MAAM,MAAM,CAAC,UAAU;oBACrB,GAAG,OAAO;oBACV,QAAQ;oBACR,aAAa,IAAI,OAAO,WAAW;oBACnC,iBAAiB;2BAAK,QAAQ,eAAe,IAAI,EAAE;wBAAG;qBAAa;gBACrE;YACF;QACF;QAEA,aAAa;YACX,IAAI;gBACF,iFAAiF;gBACjF,MAAM,WAAW,MAAM,MAAM;gBAC7B,IAAI,CAAC,SAAS,EAAE,EAAE;gBAClB,MAAM,OAAO,MAAM,SAAS,IAAI;gBAChC,MAAM,UAAU,KAAK,IAAI,IAAI,EAAE;gBAC/B,IAAI,QAAQ,MAAM,GAAG,GAAG;oBACtB,MAAM,aAAa,wBAAwB,QAAQ,GAAG,CAAC;oBACvD,MAAM,oBAAoB,IAAA,2IAAqB,EAAC,YAAY;oBAC5D,MAAM,sBAAsB,IAAA,6IAAuB,EAAC,YAAY;oBAChE,kBAAkB;oBAClB,oBAAoB;oBACpB,IAAI;wBACF,MAAM;wBACN;wBACA;wBACA,aAAa;oBACf;gBACF,OAAO;oBACL,IAAI;wBAAE,aAAa;oBAAK;gBAC1B;YACF,EAAE,OAAO,OAAO;gBACd,QAAQ,KAAK,CAAC,qCAAqC;YACrD;QACF;IACF,CAAC"}},
    {"offset": {"line": 2339, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/sales-returns/store.ts"],"sourcesContent":["import { formatDate, formatDateTime, formatDateTimeSeconds, formatDateCustom, parseDate, getCurrentDate } from '@/lib/date-utils';\r\nimport { createCrudStore } from '../../lib/store-factory';\r\nimport type { SalesReturn, ReturnLineItem } from './types';\r\n// REMOVED: import { data as initialData } from './data'; // Mock data no longer used - database is source of truth\r\nimport { GHTKService, type GHTKCreateOrderParams } from '../settings/shipping/integrations/ghtk-service';\r\nimport { loadShippingConfig } from '../../lib/utils/shipping-config-migration';\r\nimport { toast } from 'sonner';\r\n\r\n// Other stores\r\nimport { useOrderStore } from '../orders/store';\r\nimport { useProductStore } from '../products/store';\r\nimport { useStockHistoryStore } from '../stock-history/store';\r\nimport { useCustomerStore } from '../customers/store';\r\nimport { createPaymentDocument, createReceiptDocument } from '../finance/document-helpers';\r\nimport { useShippingPartnerStore } from '../settings/shipping/store';\r\nimport { asBusinessId, asSystemId, type SystemId } from '../../lib/id-types';\r\nimport { isComboProduct } from '../products/combo-utils';\r\nimport { generateSystemId, getMaxSystemIdCounter } from '../../lib/id-utils';\r\n\r\n/**\r\n * ‚úÖ Helper: Expand combo return items to child products\r\n * When a combo is returned, we need to add stock back to child products\r\n */\r\nconst getReturnStockItems = (returnItems: ReturnLineItem[]) => {\r\n    const { findById } = useProductStore.getState();\r\n    const expandedItems: { productSystemId: SystemId; productName: string; quantity: number }[] = [];\r\n    \r\n    returnItems.forEach(item => {\r\n        const product = findById(item.productSystemId);\r\n        if (product && isComboProduct(product) && product.comboItems) {\r\n            // Combo ‚Üí expand to child products\r\n            product.comboItems.forEach(comboItem => {\r\n                const childProduct = findById(comboItem.productSystemId);\r\n                expandedItems.push({\r\n                    productSystemId: comboItem.productSystemId,\r\n                    productName: childProduct?.name || 'SP kh√¥ng x√°c ƒë·ªãnh',\r\n                    quantity: comboItem.quantity * item.returnQuantity\r\n                });\r\n            });\r\n        } else {\r\n            // Regular product\r\n            expandedItems.push({\r\n                productSystemId: asSystemId(item.productSystemId),\r\n                productName: item.productName,\r\n                quantity: item.returnQuantity\r\n            });\r\n        }\r\n    });\r\n    return expandedItems;\r\n};\r\n\r\nconst baseStore = createCrudStore<SalesReturn>([], 'sales-returns', {\r\n  apiEndpoint: '/api/sales-returns',\r\n});\r\n\r\nconst originalAdd = baseStore.getState().add;\r\n\r\nconst augmentedMethods = {\r\n  addWithSideEffects: (item: Omit<SalesReturn, 'systemId' | 'id'> & { creatorId: string }) => {\r\n    const orderSystemId = asSystemId(item.orderSystemId);\r\n    const orderBusinessId = asBusinessId(item.orderId);\r\n    const customerSystemId = asSystemId(item.customerSystemId);\r\n    const branchSystemId = asSystemId(item.branchSystemId);\r\n    const creatorSystemId = asSystemId(item.creatorSystemId ?? item.creatorId ?? 'SYSTEM');\r\n    const exchangeOrderSystemId = item.exchangeOrderSystemId ? asSystemId(item.exchangeOrderSystemId) : undefined;\r\n    const accountSystemId = item.accountSystemId ? asSystemId(item.accountSystemId) : undefined;\r\n    const paymentVoucherSystemId = item.paymentVoucherSystemId ? asSystemId(item.paymentVoucherSystemId) : undefined;\r\n    const paymentVoucherSystemIds = item.paymentVoucherSystemIds?.map(asSystemId);\r\n    const receiptVoucherSystemIds = item.receiptVoucherSystemIds?.map(asSystemId);\r\n\r\n    const formattedItems = item.items.map(lineItem => ({\r\n      ...lineItem,\r\n      productSystemId: asSystemId(lineItem.productSystemId),\r\n      productId: asBusinessId(lineItem.productId),\r\n    }));\r\n\r\n    const formattedPayments = item.payments?.map(payment => ({\r\n      ...payment,\r\n      accountSystemId: asSystemId(payment.accountSystemId),\r\n    }));\r\n\r\n    const formattedRefunds = item.refunds?.map(refund => ({\r\n      ...refund,\r\n      accountSystemId: asSystemId(refund.accountSystemId),\r\n    }));\r\n\r\n    const newItemData: Omit<SalesReturn, 'systemId'> = {\r\n      id: asBusinessId(''),\r\n      orderSystemId,\r\n      orderId: orderBusinessId,\r\n      customerSystemId,\r\n      customerName: item.customerName,\r\n      branchSystemId,\r\n      branchName: item.branchName,\r\n      returnDate: item.returnDate,\r\n      reason: item.reason,\r\n      note: item.note,\r\n      notes: item.notes,\r\n      reference: item.reference,\r\n      items: formattedItems,\r\n      totalReturnValue: item.totalReturnValue,\r\n      isReceived: item.isReceived,\r\n      exchangeItems: item.exchangeItems ?? [],\r\n      exchangeOrderSystemId,\r\n      subtotalNew: item.subtotalNew,\r\n      shippingFeeNew: item.shippingFeeNew,\r\n      discountNew: item.discountNew,\r\n      discountNewType: item.discountNewType,\r\n      grandTotalNew: item.grandTotalNew,\r\n      deliveryMethod: item.deliveryMethod,\r\n      shippingPartnerId: item.shippingPartnerId,\r\n      shippingServiceId: item.shippingServiceId,\r\n      shippingAddress: item.shippingAddress,\r\n      packageInfo: item.packageInfo,\r\n      configuration: item.configuration,\r\n      finalAmount: item.finalAmount,\r\n      refundMethod: item.refundMethod,\r\n      refundAmount: item.refundAmount,\r\n      accountSystemId,\r\n      refunds: formattedRefunds,\r\n      payments: formattedPayments,\r\n      paymentVoucherSystemId,\r\n      paymentVoucherSystemIds,\r\n      receiptVoucherSystemIds,\r\n      creatorSystemId,\r\n      creatorName: item.creatorName,\r\n    };\r\n\r\n    // --- Side Effects ---\r\n    const { update: updateOrder, findById: findOrderById, add: addOrder } = useOrderStore.getState();\r\n    const { updateInventory } = useProductStore.getState();\r\n    const { addEntry: addStockHistory } = useStockHistoryStore.getState();\r\n    const { updateDebt, incrementReturnStats } = useCustomerStore.getState();\r\n    const order = findOrderById(newItemData.orderSystemId);\r\n    if (!order) return { newReturn: null, newOrderSystemId: null };\r\n\r\n    // ‚úÖ IMPORTANT: Create the return FIRST to get IDs for exchange order\r\n    const newReturn = originalAdd(newItemData);\r\n    if (!newReturn) return { newReturn: null, newOrderSystemId: null };\r\n\r\n    // ‚úÖ Update customer return stats\r\n    const totalReturnQty = newItemData.items.reduce((sum, item) => sum + item.returnQuantity, 0);\r\n    if (totalReturnQty > 0) {\r\n        incrementReturnStats(newItemData.customerSystemId, totalReturnQty);\r\n    }\r\n\r\n    let newOrderSystemId: SystemId | undefined;\r\n\r\n    // Create a new sales order for the exchange items\r\n    if (newItemData.exchangeItems && newItemData.exchangeItems.length > 0) {\r\n        console.log('üîÑ [Sales Return] Creating exchange order...', {\r\n        exchangeItems: newItemData.exchangeItems,\r\n        finalAmount: newItemData.finalAmount,\r\n        payments: newItemData.payments,\r\n        });\r\n        \r\n      // ‚úÖ Calculate payments for exchange order based on sales return logic\r\n      const exchangeOrderPayments =\r\n        newItemData.finalAmount > 0 && newItemData.payments\r\n        ? newItemData.payments.map(p => ({\r\n          method: p.method,\r\n          accountSystemId: p.accountSystemId,\r\n          amount: p.amount,\r\n          }))\r\n        : [];\r\n        // If company refunded customer (finalAmount < 0)\r\n        // The exchange order will have COD = grandTotal (shipper collects on delivery)\r\n        // No payments array needed - will be handled by COD in shipping\r\n        \r\n        // ‚úÖ Determine status and packagings based on delivery method\r\n        let finalMainStatus: 'ƒê·∫∑t h√†ng' | 'ƒêang giao d·ªãch' = 'ƒê·∫∑t h√†ng';\r\n        let finalDeliveryStatus: string = 'Ch·ªù ƒë√≥ng g√≥i';\r\n        const packagings: any[] = [];\r\n        const now = formatDateCustom(getCurrentDate(), 'yyyy-MM-dd HH:mm');\r\n        \r\n        // ‚úÖ Helper to get next packaging systemId\r\n        const PACKAGING_SYSTEM_ID_PREFIX = 'PACKAGE';\r\n        const allOrders = useOrderStore.getState().data;\r\n        const allPackagings = allOrders.flatMap(o => o.packagings || []);\r\n        const maxPackagingCounter = getMaxSystemIdCounter(allPackagings, PACKAGING_SYSTEM_ID_PREFIX);\r\n        let packagingCounter = maxPackagingCounter;\r\n        const getNextPackagingSystemId = () => {\r\n            packagingCounter++;\r\n            return asSystemId(generateSystemId('packaging', packagingCounter));\r\n        };\r\n        \r\n        // Check if using shipping partner or pickup\r\n      const isPickup = newItemData.deliveryMethod === 'pickup';\r\n      const isShippingPartner = newItemData.shippingPartnerId && newItemData.shippingServiceId;\r\n        \r\n        if (isPickup) {\r\n            // Nh·∫≠n t·∫°i c·ª≠a h√†ng - T·∫°o packaging request ngay\r\n            finalMainStatus = 'ƒêang giao d·ªãch';\r\n            finalDeliveryStatus = 'Ch·ªù ƒë√≥ng g√≥i';\r\n            packagings.push({\r\n                systemId: getNextPackagingSystemId(), // ‚úÖ Use proper format PACKAGE000001\r\n                id: '',\r\n                requestDate: now,\r\n          requestingEmployeeId: creatorSystemId,\r\n          requestingEmployeeName: newItemData.creatorName,\r\n                status: 'Ch·ªù ƒë√≥ng g√≥i',\r\n                printStatus: 'Ch∆∞a in',\r\n                deliveryStatus: 'Ch·ªù ƒë√≥ng g√≥i',\r\n            });\r\n        } else if (isShippingPartner) {\r\n            // ƒê·∫©y qua h√£ng v·∫≠n chuy·ªÉn - T·∫°o packaging ƒë√£ ƒë√≥ng g√≥i v·ªõi tracking\r\n            finalMainStatus = 'ƒêang giao d·ªãch';\r\n            finalDeliveryStatus = 'Ch·ªù l·∫•y h√†ng';\r\n            \r\n            // Get partner info\r\n            const { data: partners } = useShippingPartnerStore.getState();\r\n            const partner = partners.find(p => p.systemId === newItemData.shippingPartnerId);\r\n            const service = partner?.services.find(s => s.id === newItemData.shippingServiceId);\r\n            \r\n            packagings.push({\r\n                systemId: getNextPackagingSystemId(), // ‚úÖ Use proper format PACKAGE000001\r\n                id: '',\r\n                requestDate: now,\r\n                confirmDate: now,\r\n              requestingEmployeeId: creatorSystemId,\r\n              requestingEmployeeName: newItemData.creatorName,\r\n              confirmingEmployeeId: creatorSystemId,\r\n              confirmingEmployeeName: newItemData.creatorName,\r\n                status: 'ƒê√£ ƒë√≥ng g√≥i',\r\n                deliveryStatus: 'Ch·ªù l·∫•y h√†ng',\r\n                printStatus: 'Ch∆∞a in',\r\n                deliveryMethod: 'D·ªãch v·ª• giao h√†ng',\r\n                carrier: partner?.name,\r\n                service: service?.name,\r\n              trackingCode: newItemData.packageInfo?.trackingCode || `VC${Date.now()}`,\r\n              shippingFeeToPartner: newItemData.shippingFeeNew,\r\n                codAmount: 0, // Will be calculated based on payments\r\n                payer: 'Ng∆∞·ªùi nh·∫≠n',\r\n              weight: newItemData.packageInfo?.weight,\r\n              dimensions: newItemData.packageInfo?.dimensions,\r\n            });\r\n        }\r\n        // else: deliver-later ‚Üí keep default 'ƒê·∫∑t h√†ng', 'Ch·ªù ƒë√≥ng g√≥i', no packagings\r\n        \r\n        const newOrderPayload = {\r\n            id: '', // ‚úÖ Empty string triggers auto-generation of business ID (DH...)\r\n            customerSystemId: order.customerSystemId,\r\n            customerName: order.customerName,\r\n            branchSystemId: order.branchSystemId, // ‚úÖ Use systemId only\r\n            branchName: order.branchName,\r\n            salespersonId: creatorSystemId,\r\n            salesperson: newItemData.creatorName,\r\n            orderDate: formatDateCustom(getCurrentDate(), 'yyyy-MM-dd HH:mm'),\r\n            lineItems: newItemData.exchangeItems,\r\n            subtotal: newItemData.subtotalNew,\r\n            shippingFee: newItemData.shippingFeeNew,\r\n            tax: 0,\r\n            // ‚úÖ IMPORTANT: grandTotal should be NET amount (after subtracting return value)\r\n            // grandTotal = subtotalNew + shippingFee - totalReturnValue\r\n            grandTotal: newItemData.finalAmount > 0 ? newItemData.finalAmount : newItemData.grandTotalNew,\r\n            // ‚úÖ Store return value info for display\r\n            linkedSalesReturnId: newReturn.id, // ‚úÖ Fixed: Use newReturn.id (business ID)\r\n            linkedSalesReturnSystemId: newReturn.systemId, // ‚úÖ Add systemId for linking\r\n            linkedSalesReturnValue: newItemData.totalReturnValue, // Value of returned items\r\n            payments: exchangeOrderPayments, // ‚úÖ Set payments based on sales return scenario\r\n            notes: `ƒê∆°n h√†ng ƒë·ªïi t·ª´ phi·∫øu tr·∫£ ${newReturn.id} c·ªßa ƒë∆°n h√†ng ${order.id}`, // ‚úÖ Fixed: Use newReturn.id\r\n            sourceSalesReturnId: newReturn.id, // ‚úÖ Fixed: Use newReturn.id\r\n            // ‚úÖ Pass shipping info from form\r\n            deliveryMethod: newItemData.deliveryMethod === 'pickup' ? 'Nh·∫≠n t·∫°i c·ª≠a h√†ng' : 'D·ªãch v·ª• giao h√†ng',\r\n            shippingPartnerId: newItemData.shippingPartnerId,\r\n            shippingServiceId: newItemData.shippingServiceId,\r\n            shippingAddress: newItemData.shippingAddress,\r\n            packageInfo: newItemData.packageInfo,\r\n            configuration: newItemData.configuration,\r\n            // ‚úÖ Add required status fields based on delivery method\r\n            status: finalMainStatus,\r\n            paymentStatus: exchangeOrderPayments.length > 0 ? \r\n              (exchangeOrderPayments.reduce((sum, p) => sum + p.amount, 0) >= newItemData.grandTotalNew ? 'Thanh to√°n to√†n b·ªô' : 'Thanh to√°n 1 ph·∫ßn') \r\n                : 'Ch∆∞a thanh to√°n' as const,\r\n            deliveryStatus: finalDeliveryStatus,\r\n            printStatus: 'Ch∆∞a in' as const,\r\n            stockOutStatus: 'Ch∆∞a xu·∫•t kho' as const,\r\n            returnStatus: 'Ch∆∞a tr·∫£ h√†ng' as const,\r\n            codAmount: 0, // Will be calculated by ShippingIntegration based on payments\r\n            packagings: packagings,\r\n        };\r\n        \r\n        console.log('üì¶ [Sales Return] New order payload:', newOrderPayload);\r\n        \r\n        const newOrder = addOrder(newOrderPayload as any);\r\n        \r\n        console.log('‚úÖ [Sales Return] New order created:', newOrder);\r\n        \r\n        if (newOrder) {\r\n          newOrderSystemId = asSystemId(newOrder.systemId);\r\n          // ‚úÖ Save exchange order systemId to sales return\r\n          (newItemData as SalesReturn).exchangeOrderSystemId = newOrderSystemId;\r\n            \r\n            console.log('üéâ [Sales Return] Exchange order systemId:', newOrderSystemId);\r\n        } else {\r\n            console.error('‚ùå [Sales Return] Failed to create exchange order!');\r\n        }\r\n    }\r\n\r\n    // Adjust customer debt if needed\r\n    const creditAmount = newItemData.totalReturnValue - newItemData.grandTotalNew - (newItemData.refundAmount || 0);\r\n    if (creditAmount > 0) {\r\n      updateDebt(newItemData.customerSystemId, -creditAmount);\r\n    }\r\n    \r\n    // ‚úÖ newReturn already created above, use it directly\r\n    // ‚úÖ NOW create vouchers with correct originalDocumentId\r\n    // Handle Financials AFTER creating the return\r\n    const finalAmount = newItemData.finalAmount;\r\n\r\n    if (finalAmount < 0 && newItemData.refunds && newItemData.refunds.length > 0) {\r\n      const createdVoucherIds: SystemId[] = [];\r\n\r\n      newItemData.refunds.forEach(refund => {\r\n        if (!refund.amount || refund.amount <= 0) {\r\n          return;\r\n        }\r\n\r\n        const { document, error } = createPaymentDocument({\r\n          amount: refund.amount,\r\n          description: `Ho√†n ti·ªÅn ƒë·ªïi/tr·∫£ h√†ng t·ª´ ƒë∆°n ${order.id} (Phi·∫øu: ${newReturn.id}) qua ${refund.method}`,\r\n          recipientName: newItemData.customerName,\r\n          recipientSystemId: newItemData.customerSystemId,\r\n          customerSystemId: newItemData.customerSystemId,\r\n          customerName: newItemData.customerName,\r\n          paymentMethodName: refund.method,\r\n          accountSystemId: refund.accountSystemId,\r\n          paymentTypeName: 'Ho√†n ti·ªÅn kh√°ch h√†ng',\r\n          branchSystemId: newReturn.branchSystemId,\r\n          branchName: newReturn.branchName,\r\n          createdBy: creatorSystemId,\r\n          originalDocumentId: newReturn.id,\r\n          linkedSalesReturnSystemId: newReturn.systemId,\r\n          linkedOrderSystemId: newReturn.orderSystemId,\r\n          category: 'complaint_refund',\r\n          affectsDebt: true, // ‚úÖ Ho√†n ti·ªÅn kh√°ch h√†ng ·∫£nh h∆∞·ªüng c√¥ng n·ª£ (gi·∫£m c√¥ng n·ª£)\r\n        });\r\n\r\n        if (error) {\r\n          console.error('[Sales Return] Failed to create payment voucher:', error);\r\n          toast.error(`Kh√¥ng th·ªÉ t·∫°o phi·∫øu chi ho√†n ti·ªÅn: ${error}`);\r\n          return;\r\n        }\r\n\r\n        if (document) {\r\n          createdVoucherIds.push(asSystemId(document.systemId));\r\n        }\r\n      });\r\n\r\n      if (createdVoucherIds.length > 0) {\r\n        baseStore.getState().update(newReturn.systemId, {\r\n          ...newReturn,\r\n          paymentVoucherSystemIds: createdVoucherIds,\r\n        });\r\n      }\r\n    } else if (finalAmount > 0 && newItemData.payments && newItemData.payments.length > 0) {\r\n      const createdVoucherIds: SystemId[] = [];\r\n\r\n      newItemData.payments.forEach(payment => {\r\n        if (!payment.amount || payment.amount <= 0) {\r\n          return;\r\n        }\r\n\r\n        const { document, error } = createReceiptDocument({\r\n          amount: payment.amount,\r\n          description: `Thu ti·ªÅn ch√™nh l·ªách ƒë·ªïi h√†ng t·ª´ ƒë∆°n ${order.id} (Phi·∫øu: ${newReturn.id})`,\r\n          customerName: newReturn.customerName,\r\n          customerSystemId: newItemData.customerSystemId,\r\n          paymentMethodName: payment.method,\r\n          accountSystemId: payment.accountSystemId,\r\n          receiptTypeName: 'Thanh to√°n cho ƒë∆°n h√†ng',\r\n          branchSystemId: newReturn.branchSystemId,\r\n          branchName: newReturn.branchName,\r\n          createdBy: creatorSystemId,\r\n          originalDocumentId: newReturn.id,\r\n          linkedSalesReturnSystemId: newReturn.systemId,\r\n          linkedOrderSystemId: newReturn.orderSystemId,\r\n          category: 'sale',\r\n          affectsDebt: false,\r\n        });\r\n\r\n        if (error) {\r\n          console.error('[Sales Return] Failed to create receipt voucher:', error);\r\n          toast.error(`Kh√¥ng th·ªÉ t·∫°o phi·∫øu thu ƒë·ªïi h√†ng: ${error}`);\r\n          return;\r\n        }\r\n\r\n        if (document) {\r\n          createdVoucherIds.push(asSystemId(document.systemId));\r\n        }\r\n      });\r\n\r\n      if (createdVoucherIds.length > 0) {\r\n        baseStore.getState().update(newReturn.systemId, {\r\n          ...newReturn,\r\n          receiptVoucherSystemIds: createdVoucherIds,\r\n        });\r\n      }\r\n    }\r\n\r\n    // ‚úÖ Update inventory for returned items ONLY if isReceived = true\r\n    // ‚úÖ For combo products, add stock to child products instead\r\n    if (newReturn.isReceived) {\r\n        console.log('‚úÖ [Sales Return] Updating inventory - items received');\r\n        \r\n        // Expand combo items to child products\r\n        const stockItems = getReturnStockItems(newReturn.items);\r\n        \r\n        stockItems.forEach(item => {\r\n          if (item.quantity > 0) {\r\n            const product = useProductStore.getState().findById(item.productSystemId);\r\n            const oldStock = product?.inventoryByBranch[newReturn.branchSystemId] || 0;\r\n            updateInventory(item.productSystemId, newReturn.branchSystemId, item.quantity); // Add stock back\r\n            addStockHistory({\r\n              productId: item.productSystemId,\r\n              date: getCurrentDate().toISOString(),\r\n              employeeName: newReturn.creatorName,\r\n              action: 'Nh·∫≠p h√†ng t·ª´ kh√°ch tr·∫£',\r\n              quantityChange: item.quantity,\r\n              newStockLevel: oldStock + item.quantity,\r\n              documentId: newReturn.id, // ‚úÖ Use business ID for document reference\r\n              branchSystemId: newReturn.branchSystemId,\r\n              branch: newReturn.branchName,\r\n            });\r\n          }\r\n        });\r\n    } else {\r\n        console.log('‚è∏Ô∏è [Sales Return] Inventory NOT updated - waiting for receipt confirmation');\r\n    }\r\n\r\n    // Update original order's return status\r\n    const previousReturnsForOrder = baseStore.getState().data.filter(r => r.orderSystemId === order.systemId);\r\n    const totalReturnedQty = previousReturnsForOrder.flatMap(r => r.items).reduce((sum, item) => sum + item.returnQuantity, 0);\r\n    const totalOrderedQty = order.lineItems.reduce((sum, item) => sum + item.quantity, 0);\r\n    const newReturnStatus = totalReturnedQty >= totalOrderedQty ? 'Tr·∫£ h√†ng to√†n b·ªô' : 'Tr·∫£ h√†ng m·ªôt ph·∫ßn';\r\n    updateOrder(order.systemId, { ...order, returnStatus: newReturnStatus });\r\n    \r\n    return { newReturn, newOrderSystemId };\r\n  },\r\n  \r\n  /**\r\n   * ‚úÖ Confirm receipt of returned items and update inventory\r\n   * Use this when isReceived was false initially and items are now received\r\n   * ‚úÖ For combo products, add stock to child products instead\r\n   */\r\n  confirmReceipt: (returnSystemId: SystemId) => {\r\n    const salesReturn = baseStore.getState().findById(returnSystemId);\r\n    if (!salesReturn) {\r\n      console.error('‚ùå [Sales Return] Return not found:', returnSystemId);\r\n      return { success: false, message: 'Kh√¥ng t√¨m th·∫•y phi·∫øu tr·∫£ h√†ng' };\r\n    }\r\n    \r\n    if (salesReturn.isReceived) {\r\n      console.warn('‚ö†Ô∏è [Sales Return] Already received:', returnSystemId);\r\n      return { success: false, message: 'H√†ng ƒë√£ ƒë∆∞·ª£c nh·∫≠n tr∆∞·ªõc ƒë√≥' };\r\n    }\r\n    \r\n    const { updateInventory } = useProductStore.getState();\r\n    const { addEntry: addStockHistory } = useStockHistoryStore.getState();\r\n    \r\n    // ‚úÖ Expand combo items to child products\r\n    const stockItems = getReturnStockItems(salesReturn.items);\r\n    \r\n    // Update inventory for all returned items (including expanded combo children)\r\n    stockItems.forEach(item => {\r\n      if (item.quantity > 0) {\r\n        const product = useProductStore.getState().findById(item.productSystemId);\r\n        const oldStock = product?.inventoryByBranch[salesReturn.branchSystemId] || 0;\r\n        updateInventory(item.productSystemId, salesReturn.branchSystemId, item.quantity);\r\n        addStockHistory({\r\n          productId: item.productSystemId,\r\n          date: getCurrentDate().toISOString(),\r\n          employeeName: salesReturn.creatorName,\r\n          action: 'Nh·∫≠p h√†ng t·ª´ kh√°ch tr·∫£ (x√°c nh·∫≠n)',\r\n          quantityChange: item.quantity,\r\n          newStockLevel: oldStock + item.quantity,\r\n          documentId: salesReturn.id,\r\n          branchSystemId: salesReturn.branchSystemId,\r\n          branch: salesReturn.branchName,\r\n        });\r\n      }\r\n    });\r\n    \r\n    // Update the return record\r\n    baseStore.getState().update(returnSystemId, {\r\n      ...salesReturn,\r\n      isReceived: true,\r\n    });\r\n    \r\n    console.log('‚úÖ [Sales Return] Receipt confirmed and inventory updated:', returnSystemId);\r\n    return { success: true, message: 'ƒê√£ x√°c nh·∫≠n nh·∫≠n h√†ng v√† c·∫≠p nh·∫≠t t·ªìn kho' };\r\n  },\r\n};\r\n\r\n// Export typed hook\r\nexport const useSalesReturnStore = (): any => {\r\n  const state = baseStore();\r\n  return {\r\n    ...state,\r\n    ...augmentedMethods,\r\n  };\r\n};\r\n\r\n// Export getState for non-hook usage\r\nuseSalesReturnStore.getState = (): any => {\r\n  const state = baseStore.getState();\r\n  return {\r\n    ...state,\r\n    ...augmentedMethods,\r\n  };\r\n};\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 2824, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/shipments/store.ts"],"sourcesContent":["/**\r\n * Shipment Store - Entity ri√™ng cho v·∫≠n ƒë∆°n\r\n * \r\n * ‚ö†Ô∏è ID Format theo ID-GOVERNANCE.md:\r\n * - SystemId: SHIPMENT000001\r\n * - BusinessId: VC000001\r\n * \r\n * Relationship: Shipment 1:1 Packaging (via packagingSystemId)\r\n */\r\n\r\nimport { create } from 'zustand';\r\nimport type { SystemId, BusinessId } from '../../lib/id-types';\r\nimport { asSystemId, asBusinessId } from '../../lib/id-types';\r\nimport { generateSystemId, generateBusinessId, getMaxSystemIdCounter, getMaxBusinessIdCounter } from '../../lib/id-utils';\r\nimport type { Shipment } from './types';\r\n\r\n// ========================================\r\n// CONSTANTS\r\n// ========================================\r\n\r\nconst SHIPMENT_SYSTEM_ID_PREFIX = 'SHIPMENT';\r\nconst SHIPMENT_BUSINESS_ID_PREFIX = 'VC';\r\n\r\n// ========================================\r\n// INITIAL SEED DATA\r\n// ========================================\r\n\r\nconst initialData: Shipment[] = [\r\n    {\r\n        systemId: asSystemId('SHIPMENT000001'),\r\n        id: asBusinessId('VC000001'),\r\n        packagingSystemId: asSystemId('PACKAGE000001'),\r\n        orderSystemId: asSystemId('ORDER000001'),\r\n        orderId: asBusinessId('DH000001'),\r\n        trackingCode: 'GHN000001',\r\n        carrier: 'GHN',\r\n        service: 'Chu·∫©n',\r\n        deliveryStatus: 'ƒê√£ giao h√†ng',\r\n        printStatus: 'ƒê√£ in',\r\n        reconciliationStatus: 'ƒê√£ ƒë·ªëi so√°t',\r\n        shippingFeeToPartner: 25000,\r\n        codAmount: 0,\r\n        payer: 'Ng∆∞·ªùi g·ª≠i',\r\n        createdAt: '2025-11-01 08:30',\r\n        dispatchedAt: '2025-11-02 08:00',\r\n        deliveredAt: '2025-11-05 15:30',\r\n    },\r\n    {\r\n        systemId: asSystemId('SHIPMENT000002'),\r\n        id: asBusinessId('VC000002'),\r\n        packagingSystemId: asSystemId('PACKAGE000002'),\r\n        orderSystemId: asSystemId('ORDER000002'),\r\n        orderId: asBusinessId('DH000002'),\r\n        trackingCode: 'JT000245',\r\n        carrier: 'J&T Express',\r\n        service: 'G√≥i chu·∫©n',\r\n        deliveryStatus: 'ƒêang giao h√†ng',\r\n        printStatus: 'ƒê√£ in',\r\n        reconciliationStatus: 'Ch∆∞a ƒë·ªëi so√°t',\r\n        shippingFeeToPartner: 30000,\r\n        codAmount: 5000000,\r\n        payer: 'Ng∆∞·ªùi nh·∫≠n',\r\n        createdAt: '2025-11-03 16:00',\r\n        dispatchedAt: '2025-11-04 09:00',\r\n    },\r\n    // Th√™m d·ªØ li·ªáu m·∫´u m·ªõi\r\n    {\r\n        systemId: asSystemId('SHIPMENT000003'),\r\n        id: asBusinessId('VC000003'),\r\n        packagingSystemId: asSystemId('PACKAGE000005'),\r\n        orderSystemId: asSystemId('ORDER000005'),\r\n        orderId: asBusinessId('DH000005'),\r\n        trackingCode: 'GHTK123456',\r\n        carrier: 'GHTK',\r\n        service: 'Nhanh',\r\n        deliveryStatus: 'ƒê√£ giao h√†ng',\r\n        printStatus: 'ƒê√£ in',\r\n        reconciliationStatus: 'Ch∆∞a ƒë·ªëi so√°t',\r\n        shippingFeeToPartner: 35000,\r\n        codAmount: 12500000,\r\n        payer: 'Ng∆∞·ªùi nh·∫≠n',\r\n        createdAt: '2025-11-08 10:00',\r\n        dispatchedAt: '2025-11-08 14:00',\r\n        deliveredAt: '2025-11-10 11:30',\r\n    },\r\n    {\r\n        systemId: asSystemId('SHIPMENT000004'),\r\n        id: asBusinessId('VC000004'),\r\n        packagingSystemId: asSystemId('PACKAGE000006'),\r\n        orderSystemId: asSystemId('ORDER000006'),\r\n        orderId: asBusinessId('DH000006'),\r\n        trackingCode: 'VTP789012',\r\n        carrier: 'Viettel Post',\r\n        service: 'Ti√™u chu·∫©n',\r\n        deliveryStatus: 'ƒêang giao h√†ng',\r\n        printStatus: 'ƒê√£ in',\r\n        reconciliationStatus: 'Ch∆∞a ƒë·ªëi so√°t',\r\n        shippingFeeToPartner: 28000,\r\n        codAmount: 8900000,\r\n        payer: 'Ng∆∞·ªùi nh·∫≠n',\r\n        createdAt: '2025-11-09 09:15',\r\n        dispatchedAt: '2025-11-09 15:30',\r\n    },\r\n    {\r\n        systemId: asSystemId('SHIPMENT000005'),\r\n        id: asBusinessId('VC000005'),\r\n        packagingSystemId: asSystemId('PACKAGE000007'),\r\n        orderSystemId: asSystemId('ORDER000007'),\r\n        orderId: asBusinessId('DH000007'),\r\n        trackingCode: 'GHN345678',\r\n        carrier: 'GHN',\r\n        service: 'Express',\r\n        deliveryStatus: 'ƒê√£ giao h√†ng',\r\n        printStatus: 'ƒê√£ in',\r\n        reconciliationStatus: 'Ch∆∞a ƒë·ªëi so√°t',\r\n        shippingFeeToPartner: 45000,\r\n        codAmount: 23800000,\r\n        payer: 'Ng∆∞·ªùi nh·∫≠n',\r\n        createdAt: '2025-11-07 08:00',\r\n        dispatchedAt: '2025-11-07 10:00',\r\n        deliveredAt: '2025-11-08 09:30',\r\n    },\r\n    {\r\n        systemId: asSystemId('SHIPMENT000006'),\r\n        id: asBusinessId('VC000006'),\r\n        packagingSystemId: asSystemId('PACKAGE000008'),\r\n        orderSystemId: asSystemId('ORDER000008'),\r\n        orderId: asBusinessId('DH000008'),\r\n        trackingCode: 'BEST567890',\r\n        carrier: 'Best Express',\r\n        service: 'Ti·∫øt ki·ªám',\r\n        deliveryStatus: 'Ch·ªù l·∫•y h√†ng',\r\n        printStatus: 'ƒê√£ in',\r\n        reconciliationStatus: 'Ch∆∞a ƒë·ªëi so√°t',\r\n        shippingFeeToPartner: 22000,\r\n        codAmount: 4500000,\r\n        payer: 'Ng∆∞·ªùi nh·∫≠n',\r\n        createdAt: '2025-11-10 07:30',\r\n    },\r\n    {\r\n        systemId: asSystemId('SHIPMENT000007'),\r\n        id: asBusinessId('VC000007'),\r\n        packagingSystemId: asSystemId('PACKAGE000009'),\r\n        orderSystemId: asSystemId('ORDER000009'),\r\n        orderId: asBusinessId('DH000009'),\r\n        trackingCode: 'NJV901234',\r\n        carrier: 'Ninja Van',\r\n        service: 'Standard',\r\n        deliveryStatus: 'ƒê√£ giao h√†ng',\r\n        printStatus: 'ƒê√£ in',\r\n        reconciliationStatus: 'ƒê√£ ƒë·ªëi so√°t',\r\n        shippingFeeToPartner: 32000,\r\n        codAmount: 15600000,\r\n        payer: 'Ng∆∞·ªùi g·ª≠i',\r\n        createdAt: '2025-11-05 11:00',\r\n        dispatchedAt: '2025-11-05 16:00',\r\n        deliveredAt: '2025-11-07 14:30',\r\n    },\r\n    {\r\n        systemId: asSystemId('SHIPMENT000008'),\r\n        id: asBusinessId('VC000008'),\r\n        packagingSystemId: asSystemId('PACKAGE000010'),\r\n        orderSystemId: asSystemId('ORDER000010'),\r\n        orderId: asBusinessId('DH000010'),\r\n        trackingCode: 'JT567891',\r\n        carrier: 'J&T Express',\r\n        service: 'Si√™u t·ªëc',\r\n        deliveryStatus: 'ƒêang giao h√†ng',\r\n        printStatus: 'ƒê√£ in',\r\n        reconciliationStatus: 'Ch∆∞a ƒë·ªëi so√°t',\r\n        shippingFeeToPartner: 55000,\r\n        codAmount: 31200000,\r\n        payer: 'Ng∆∞·ªùi nh·∫≠n',\r\n        createdAt: '2025-11-10 14:00',\r\n        dispatchedAt: '2025-11-10 16:30',\r\n    },\r\n];\r\n\r\n// ========================================\r\n// STORE INTERFACE\r\n// ========================================\r\n\r\nexport interface ShipmentStoreState {\r\n    data: Shipment[];\r\n    \r\n    // CRUD\r\n    findById: (systemId: string) => Shipment | undefined;\r\n    findByPackagingSystemId: (packagingSystemId: string) => Shipment | undefined;\r\n    findByTrackingCode: (trackingCode: string) => Shipment | undefined;\r\n    \r\n    // Actions\r\n    createShipment: (data: Omit<Shipment, 'systemId' | 'id'>) => Shipment;\r\n    updateShipment: (systemId: SystemId, updates: Partial<Shipment>) => void;\r\n    deleteShipment: (systemId: SystemId) => void;\r\n    \r\n    // Counters\r\n    getNextSystemId: () => SystemId;\r\n    getNextBusinessId: () => BusinessId;\r\n}\r\n\r\n// ========================================\r\n// HELPER FUNCTIONS\r\n// ========================================\r\n\r\nlet shipmentSystemIdCounter = 0;\r\nlet shipmentBusinessIdCounter = 0;\r\n\r\nfunction initCounters(shipments: Shipment[]) {\r\n    shipmentSystemIdCounter = getMaxSystemIdCounter(shipments, SHIPMENT_SYSTEM_ID_PREFIX);\r\n    shipmentBusinessIdCounter = getMaxBusinessIdCounter(shipments, SHIPMENT_BUSINESS_ID_PREFIX);\r\n}\r\n\r\nfunction getNextShipmentSystemId(): SystemId {\r\n    shipmentSystemIdCounter++;\r\n    return generateSystemId('shipments', shipmentSystemIdCounter) as SystemId;\r\n}\r\n\r\nfunction getNextShipmentBusinessId(): BusinessId {\r\n    shipmentBusinessIdCounter++;\r\n    return generateBusinessId('shipments', shipmentBusinessIdCounter) as BusinessId;\r\n}\r\n\r\n// Initialize counters\r\ninitCounters(initialData);\r\n\r\n// ========================================\r\n// STORE CREATION\r\n// ========================================\r\n\r\nexport const useShipmentStore = create<ShipmentStoreState>()(\r\n    (set, get) => ({\r\n            data: initialData,\r\n            \r\n            findById: (systemId: string) => {\r\n                return get().data.find(s => s.systemId === systemId);\r\n            },\r\n            \r\n            findByPackagingSystemId: (packagingSystemId: string) => {\r\n                return get().data.find(s => s.packagingSystemId === packagingSystemId);\r\n            },\r\n            \r\n            findByTrackingCode: (trackingCode: string) => {\r\n                return get().data.find(s => s.trackingCode === trackingCode);\r\n            },\r\n            \r\n            createShipment: (data: Omit<Shipment, 'systemId' | 'id'>) => {\r\n                const newShipment: Shipment = {\r\n                    systemId: getNextShipmentSystemId(),\r\n                    id: getNextShipmentBusinessId(),\r\n                    ...data,\r\n                };\r\n                \r\n                set(state => ({\r\n                    data: [...state.data, newShipment]\r\n                }));\r\n                \r\n                return newShipment;\r\n            },\r\n            \r\n            updateShipment: (systemId: SystemId, updates: Partial<Shipment>) => {\r\n                set(state => ({\r\n                    data: state.data.map(s => \r\n                        s.systemId === systemId \r\n                            ? { ...s, ...updates }\r\n                            : s\r\n                    )\r\n                }));\r\n            },\r\n            \r\n            deleteShipment: (systemId: SystemId) => {\r\n                set(state => ({\r\n                    data: state.data.filter(s => s.systemId !== systemId)\r\n                }));\r\n            },\r\n            \r\n            getNextSystemId: () => getNextShipmentSystemId(),\r\n            getNextBusinessId: () => getNextShipmentBusinessId(),\r\n        })\r\n);\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 3064, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/orders/store.ts"],"sourcesContent":["import { create } from 'zustand';\r\n// persist middleware removed - database is now source of truth\r\nimport { formatDate, formatDateCustom, toISODate, toISODateTime } from '../../lib/date-utils';\r\nimport { getApiUrl } from '../../lib/api-config';\r\nimport { createCrudStore } from '../../lib/store-factory';\r\n// REMOVED: import { data as initialDataOmit } from './data'; // Mock data no longer used - database is source of truth\r\nimport type { Order, OrderPayment, Packaging, OrderMainStatus, OrderDeliveryStatus, PackagingStatus, OrderPaymentStatus, OrderDeliveryMethod } from './types';\r\nimport type { SystemId, BusinessId } from '../../lib/id-types';\r\nimport { asSystemId, asBusinessId } from '../../lib/id-types';\r\nimport { generateSystemId, getMaxSystemIdCounter } from '../../lib/id-utils';\r\n\r\nimport { useEmployeeStore } from '../employees/store';\r\n// REMOVED: Voucher store no longer exists - using Payment/Receipt stores instead\r\nimport { useProductStore } from '../products/store';\r\nimport { isComboProduct } from '../products/combo-utils';\r\nimport { useStockHistoryStore } from '../stock-history/store';\r\nimport { useCustomerStore } from '../customers/store';\r\nimport { useReceiptTypeStore } from '../settings/receipt-types/store';\r\n// REMOVED: import type { Voucher } from '../vouchers/types';\r\nimport { useCashbookStore } from '../cashbook/store';\r\nimport { useReceiptStore } from '../receipts/store';\r\nimport type { Receipt, ReceiptOrderAllocation } from '../receipts/types';\r\nimport { useSalesReturnStore } from '../sales-returns/store';\r\nimport { createPaymentDocument, createReceiptDocument } from '../finance/document-helpers';\r\nimport { useShipmentStore } from '../shipments/store';\r\nimport type { Shipment } from '../shipments/types';\r\n\r\nimport { getCurrentUserSystemId } from '../../contexts/auth-context';\r\n\r\nimport { useSalesManagementSettingsStore } from '../settings/sales/sales-management-store';\r\nimport {\r\n  getCurrentUserInfo,\r\n  createCreatedEntry,\r\n  createHistoryEntry,\r\n  appendHistoryEntry,\r\n  type HistoryEntry\r\n} from '../../lib/activity-history-helper';\r\n\r\n// ‚úÖ Helper to get branch systemId\r\nconst getBranchId = (order: Order) => order.branchSystemId;\r\n\r\nconst deliveryStatusesBlockedForCancellation: OrderDeliveryStatus[] = [\r\n    'ƒêang giao h√†ng',\r\n    'ƒê√£ giao h√†ng',\r\n    'Ch·ªù giao l·∫°i',\r\n];\r\n\r\nconst IN_STORE_PICKUP_PREFIX = 'INSTORE';\r\n\r\nconst PACKAGING_CODE_PREFIX = 'DG';\r\nconst PACKAGING_SYSTEM_ID_PREFIX = 'PACKAGE';\r\n\r\n// ‚úÖ Track packaging systemId counter globally\r\nlet packagingSystemIdCounter = 0;\r\n\r\n// ‚úÖ Initialize counter from all existing packagings across all orders\r\nconst initPackagingCounter = (orders: Order[]): void => {\r\n    const allPackagings = orders.flatMap(o => o.packagings || []);\r\n    packagingSystemIdCounter = getMaxSystemIdCounter(allPackagings, PACKAGING_SYSTEM_ID_PREFIX);\r\n};\r\n\r\n// ‚úÖ Generate next packaging systemId\r\nconst getNextPackagingSystemId = (): SystemId => {\r\n    packagingSystemIdCounter++;\r\n    return asSystemId(generateSystemId('packaging', packagingSystemIdCounter));\r\n};\r\n\r\nconst getPackagingSuffixFromOrderId = (orderId?: BusinessId) => {\r\n    if (!orderId) return '';\r\n    const rawValue = `${orderId}`;\r\n    const suffix = rawValue.replace(/^[A-Z-]+/, '');\r\n    return suffix || rawValue;\r\n};\r\n\r\n// Count only active packagings (not cancelled) for numbering\r\nconst getActivePackagingCount = (packagings: Packaging[]): number => {\r\n    return packagings.filter(p => p.status !== 'H·ªßy ƒë√≥ng g√≥i').length;\r\n};\r\n\r\nconst buildPackagingBusinessId = (orderId: BusinessId, activeIndex: number, activeCount: number): BusinessId => {\r\n    const suffix = getPackagingSuffixFromOrderId(orderId);\r\n    const baseCode = `${PACKAGING_CODE_PREFIX}${suffix || '000000'}`;\r\n    // Only add suffix if there are multiple active packagings\r\n    if (activeCount > 1 && activeIndex > 0) {\r\n        const paddedIndex = String(activeIndex + 1).padStart(2, '0');\r\n        return asBusinessId(`${baseCode}-${paddedIndex}`);\r\n    }\r\n    return asBusinessId(baseCode);\r\n};\r\n\r\nconst getReturnedValueForOrder = (orderSystemId: SystemId): number => {\r\n    return useSalesReturnStore.getState().data\r\n        .filter(sr => sr.orderSystemId === orderSystemId)\r\n        .reduce((sum, sr) => sum + sr.totalReturnValue, 0);\r\n};\r\n\r\nconst calculateActualDebt = (order: Order): number => {\r\n    const totalReturnedValue = getReturnedValueForOrder(order.systemId);\r\n    return Math.max(order.grandTotal - totalReturnedValue, 0);\r\n};\r\n\r\nconst calculateTotalPaid = (payments: OrderPayment[]): number => {\r\n    return payments.reduce((sum, payment) => sum + payment.amount, 0);\r\n};\r\n\r\nconst getOrderOutstandingAmount = (order: Order): number => {\r\n    const actualDebt = calculateActualDebt(order);\r\n    const totalPaid = calculateTotalPaid(order.payments ?? []);\r\n    return Math.max(actualDebt - totalPaid, 0);\r\n};\r\n\r\nconst applyPaymentToOrder = (order: Order, payment: OrderPayment): Order => {\r\n    const updatedPayments = [...(order.payments ?? []), payment];\r\n    const totalPaid = calculateTotalPaid(updatedPayments);\r\n    const actualDebt = calculateActualDebt(order);\r\n\r\n    let newPaymentStatus: OrderPaymentStatus = 'Ch∆∞a thanh to√°n';\r\n    if (totalPaid >= actualDebt) {\r\n        newPaymentStatus = 'Thanh to√°n to√†n b·ªô';\r\n    } else if (totalPaid > 0) {\r\n        newPaymentStatus = 'Thanh to√°n 1 ph·∫ßn';\r\n    }\r\n\r\n    const wasCompleted = order.status === 'Ho√†n th√†nh';\r\n    let newStatus = order.status;\r\n    let newCompletedDate = order.completedDate;\r\n\r\n    if (newPaymentStatus === 'Thanh to√°n to√†n b·ªô' && order.deliveryStatus === 'ƒê√£ giao h√†ng') {\r\n        newStatus = 'Ho√†n th√†nh';\r\n        newCompletedDate = toISODateTime(new Date());\r\n        if (!wasCompleted) {\r\n            const { incrementOrderStats } = useCustomerStore.getState();\r\n            incrementOrderStats(order.customerSystemId, order.grandTotal);\r\n        }\r\n    }\r\n\r\n    const { updateDebtTransactionPayment } = useCustomerStore.getState();\r\n    updateDebtTransactionPayment(order.customerSystemId, order.id, payment.amount);\r\n\r\n    return {\r\n        ...order,\r\n        payments: updatedPayments,\r\n        paymentStatus: newPaymentStatus,\r\n        status: newStatus,\r\n        completedDate: newCompletedDate,\r\n        paidAmount: totalPaid,\r\n    };\r\n};\r\n\r\nconst shouldAutoAllocateReceipt = (receipt: Receipt): boolean => {\r\n    return (\r\n        receipt.status === 'completed' &&\r\n        receipt.affectsDebt &&\r\n        !!receipt.customerSystemId &&\r\n        !receipt.linkedOrderSystemId\r\n    );\r\n};\r\n\r\nconst getAllocatedAmount = (receipt: Receipt): number => {\r\n    return receipt.orderAllocations?.reduce((sum, allocation) => sum + allocation.amount, 0) ?? 0;\r\n};\r\n\r\nconst autoAllocateReceiptToOrders = (receipt: Receipt) => {\r\n    if (!shouldAutoAllocateReceipt(receipt)) {\r\n        return;\r\n    }\r\n\r\n    const remainingAmount = receipt.amount - getAllocatedAmount(receipt);\r\n    if (remainingAmount <= 0) {\r\n        return;\r\n    }\r\n\r\n    const candidateOrders = baseStore.getState().data\r\n        .filter(order => order.customerSystemId === receipt.customerSystemId && order.status !== 'ƒê√£ h·ªßy')\r\n        .map(order => ({ order, outstanding: getOrderOutstandingAmount(order) }))\r\n        .filter(entry => entry.outstanding > 0)\r\n        .sort((a, b) => {\r\n            const aTime = a.order.orderDate ? new Date(a.order.orderDate).getTime() : 0;\r\n            const bTime = b.order.orderDate ? new Date(b.order.orderDate).getTime() : 0;\r\n            return aTime - bTime;\r\n        });\r\n\r\n    if (!candidateOrders.length) {\r\n        return;\r\n    }\r\n\r\n    let amountToDistribute = remainingAmount;\r\n    const updatedOrders = new Map<SystemId, Order>();\r\n    const allocationEntries: ReceiptOrderAllocation[] = [];\r\n\r\n    for (const { order } of candidateOrders) {\r\n        if (amountToDistribute <= 0) {\r\n            break;\r\n        }\r\n\r\n        const currentOrderState = updatedOrders.get(order.systemId) ?? order;\r\n        const outstanding = getOrderOutstandingAmount(currentOrderState);\r\n        if (outstanding <= 0) {\r\n            continue;\r\n        }\r\n\r\n        const allocationAmount = Math.min(outstanding, amountToDistribute);\r\n        if (allocationAmount <= 0) {\r\n            continue;\r\n        }\r\n\r\n        const paymentEntry: OrderPayment = {\r\n            systemId: receipt.systemId,\r\n            id: receipt.id,\r\n            date: receipt.date,\r\n            amount: allocationAmount,\r\n            method: receipt.paymentMethodName,\r\n            createdBy: asSystemId(receipt.createdBy),\r\n            description: receipt.description ?? `Thanh to√°n t·ª´ phi·∫øu thu ${receipt.id}`,\r\n        };\r\n\r\n        const updatedOrder = applyPaymentToOrder(currentOrderState, paymentEntry);\r\n        updatedOrders.set(order.systemId, updatedOrder);\r\n        allocationEntries.push({\r\n            orderSystemId: order.systemId,\r\n            orderId: order.id,\r\n            amount: allocationAmount,\r\n        });\r\n\r\n        amountToDistribute -= allocationAmount;\r\n    }\r\n\r\n    if (!allocationEntries.length) {\r\n        return;\r\n    }\r\n\r\n    baseStore.setState(state => {\r\n        const data = state.data.map(order => updatedOrders.get(order.systemId) ?? order);\r\n        return { data };\r\n    });\r\n\r\n    const receiptStore = useReceiptStore.getState();\r\n    const latestReceipt = receiptStore.findById(receipt.systemId);\r\n    if (!latestReceipt) {\r\n        return;\r\n    }\r\n\r\n    receiptStore.update(receipt.systemId, {\r\n        ...latestReceipt,\r\n        orderAllocations: [...(latestReceipt.orderAllocations ?? []), ...allocationEntries],\r\n    });\r\n};\r\n\r\nconst ensureOrderPackagingIdentifiers = (order: Order): Order | null => {\r\n    if (!order.packagings || order.packagings.length === 0) {\r\n        return null;\r\n    }\r\n\r\n    // Count only active packagings for proper numbering\r\n    const activePackagings = order.packagings.filter(p => p.status !== 'H·ªßy ƒë√≥ng g√≥i');\r\n    const activeCount = activePackagings.length;\r\n    let changed = false;\r\n    let activeIndex = 0;\r\n\r\n    const updatedPackagings = order.packagings.map((pkg, idx) => {\r\n        const isCancelled = pkg.status === 'H·ªßy ƒë√≥ng g√≥i';\r\n        const hasId = typeof pkg.id === 'string' && pkg.id.trim().length > 0;\r\n        // ‚úÖ Check for temp systemId or old format (PKG_)\r\n        const hasTempOrOldSystemId = pkg.systemId?.startsWith('PKG_TEMP_') || pkg.systemId?.startsWith('PKG_');\r\n        const hasValidSystemId = pkg.systemId?.startsWith(PACKAGING_SYSTEM_ID_PREFIX);\r\n        const shouldFixTracking = pkg.deliveryMethod === 'Nh·∫≠n t·∫°i c·ª≠a h√†ng' && pkg.trackingCode === `${IN_STORE_PICKUP_PREFIX}-`;\r\n\r\n        // For cancelled packagings, keep existing ID\r\n        if (isCancelled) {\r\n            if (!hasId || (hasTempOrOldSystemId && !hasValidSystemId)) {\r\n                // Still need to assign an ID if missing\r\n                const nextPkg = { ...pkg };\r\n                if (!hasId) {\r\n                    nextPkg.id = buildPackagingBusinessId(order.id, 0, 1);\r\n                }\r\n                if (hasTempOrOldSystemId && !hasValidSystemId) {\r\n                    nextPkg.systemId = getNextPackagingSystemId();\r\n                }\r\n                changed = true;\r\n                return nextPkg;\r\n            }\r\n            return pkg;\r\n        }\r\n\r\n        // For active packagings, use activeIndex for numbering\r\n        const currentActiveIndex = activeIndex;\r\n        activeIndex++;\r\n\r\n        if (hasId && !shouldFixTracking && hasValidSystemId) {\r\n            return pkg;\r\n        }\r\n\r\n        const nextPkg = { ...pkg };\r\n        if (!hasId) {\r\n            nextPkg.id = buildPackagingBusinessId(order.id, currentActiveIndex, activeCount);\r\n            changed = true;\r\n        }\r\n        \r\n        // ‚úÖ Fix temporary/old systemId to proper format PACKAGE000001\r\n        if (hasTempOrOldSystemId && !hasValidSystemId) {\r\n            nextPkg.systemId = getNextPackagingSystemId();\r\n            changed = true;\r\n        }\r\n\r\n        if (shouldFixTracking) {\r\n            const resolvedId = nextPkg.id ?? buildPackagingBusinessId(order.id, currentActiveIndex, activeCount);\r\n            nextPkg.trackingCode = `${IN_STORE_PICKUP_PREFIX}-${resolvedId}`;\r\n            changed = true;\r\n        }\r\n\r\n        return nextPkg;\r\n    });\r\n\r\n    return changed ? { ...order, packagings: updatedPackagings } : null;\r\n};\r\n\r\nconst ensureCancellationAllowed = (order: Order | undefined, actionLabel: string) => {\r\n    if (!order) return false;\r\n\r\n    const { allowCancelAfterExport } = useSalesManagementSettingsStore.getState();\r\n    if (allowCancelAfterExport) {\r\n        return true;\r\n    }\r\n\r\n    const hasLeftWarehouse =\r\n        order.stockOutStatus === 'Xu·∫•t kho to√†n b·ªô' ||\r\n        deliveryStatusesBlockedForCancellation.includes(order.deliveryStatus);\r\n\r\n    if (hasLeftWarehouse) {\r\n        alert(\r\n            `Kh√¥ng th·ªÉ ${actionLabel} v√¨ ƒë∆°n h√†ng ƒë√£ xu·∫•t kho. V√†o C·∫•u h√¨nh b√°n h√†ng -> Thi·∫øt l·∫≠p qu·∫£n l√Ω b√°n h√†ng v√† b·∫≠t \"Cho ph√©p h·ªßy ƒë∆°n h√†ng sau khi xu·∫•t kho\".`,\r\n        );\r\n        return false;\r\n    }\r\n\r\n    return true;\r\n};\r\n\r\n/**\r\n * ‚úÖ Helper ƒë·ªÉ x·ª≠ l√Ω stock cho combo ho·∫∑c s·∫£n ph·∫©m th∆∞·ªùng\r\n * Combo kh√¥ng c√≥ t·ªìn kho th·ª±c t·∫ø - thao t√°c tr√™n SP con\r\n */\r\ntype StockOperation = 'commit' | 'uncommit' | 'dispatch' | 'complete' | 'return';\r\n\r\nconst processLineItemStock = (\r\n    lineItem: { productSystemId: string; quantity: number },\r\n    branchSystemId: string,\r\n    operation: StockOperation,\r\n    orderQuantity: number = 1 // S·ªë l∆∞·ª£ng ƒë·∫∑t c·ªßa line item\r\n) => {\r\n    const { \r\n        findById: findProductById, \r\n        commitStock, \r\n        uncommitStock, \r\n        dispatchStock, \r\n        completeDelivery, \r\n        returnStockFromTransit \r\n    } = useProductStore.getState();\r\n    \r\n    const product = findProductById(asSystemId(lineItem.productSystemId));\r\n    \r\n    // X√°c ƒë·ªãnh danh s√°ch items c·∫ßn x·ª≠ l√Ω (SP con n·∫øu combo, ho·∫∑c ch√≠nh SP n·∫øu th∆∞·ªùng)\r\n    const itemsToProcess: { productSystemId: SystemId; quantity: number }[] = [];\r\n    \r\n    if (product && isComboProduct(product) && product.comboItems) {\r\n        // Combo: x·ª≠ l√Ω t·∫•t c·∫£ SP con\r\n        product.comboItems.forEach(comboItem => {\r\n            itemsToProcess.push({\r\n                productSystemId: asSystemId(comboItem.productSystemId),\r\n                quantity: orderQuantity * comboItem.quantity, // S·ªë l∆∞·ª£ng combo √ó s·ªë l∆∞·ª£ng SP con\r\n            });\r\n        });\r\n    } else {\r\n        // S·∫£n ph·∫©m th∆∞·ªùng\r\n        itemsToProcess.push({\r\n            productSystemId: asSystemId(lineItem.productSystemId),\r\n            quantity: orderQuantity,\r\n        });\r\n    }\r\n    \r\n    // Th·ª±c hi·ªán operation cho t·ª´ng item\r\n    itemsToProcess.forEach(item => {\r\n        const branchId = asSystemId(branchSystemId);\r\n        switch (operation) {\r\n            case 'commit':\r\n                commitStock(item.productSystemId, branchId, item.quantity);\r\n                break;\r\n            case 'uncommit':\r\n                uncommitStock(item.productSystemId, branchId, item.quantity);\r\n                break;\r\n            case 'dispatch':\r\n                dispatchStock(item.productSystemId, branchId, item.quantity);\r\n                break;\r\n            case 'complete':\r\n                completeDelivery(item.productSystemId, branchId, item.quantity);\r\n                break;\r\n            case 'return':\r\n                returnStockFromTransit(item.productSystemId, branchId, item.quantity);\r\n                break;\r\n        }\r\n    });\r\n    \r\n    return itemsToProcess; // Return ƒë·ªÉ c√≥ th·ªÉ d√πng cho stock history\r\n};\r\n\r\n/**\r\n * ‚úÖ Helper ƒë·ªÉ l·∫•y danh s√°ch stock items t·ª´ line items (m·ªü r·ªông combo th√†nh SP con)\r\n * D√πng trong webhook GHTK ho·∫∑c c√°c thao t√°c batch\r\n */\r\nconst getComboStockItems = (lineItems: { productSystemId: string; quantity: number }[]): { productSystemId: SystemId; quantity: number }[] => {\r\n    const { findById: findProductById } = useProductStore.getState();\r\n    const stockItems: { productSystemId: SystemId; quantity: number }[] = [];\r\n    \r\n    lineItems.forEach(item => {\r\n        const product = findProductById(asSystemId(item.productSystemId));\r\n        \r\n        if (product && isComboProduct(product) && product.comboItems) {\r\n            // Combo: m·ªü r·ªông th√†nh SP con\r\n            product.comboItems.forEach(comboItem => {\r\n                stockItems.push({\r\n                    productSystemId: asSystemId(comboItem.productSystemId),\r\n                    quantity: item.quantity * comboItem.quantity,\r\n                });\r\n            });\r\n        } else {\r\n            // S·∫£n ph·∫©m th∆∞·ªùng\r\n            stockItems.push({\r\n                productSystemId: asSystemId(item.productSystemId),\r\n                quantity: item.quantity,\r\n            });\r\n        }\r\n    });\r\n    \r\n    return stockItems;\r\n};\r\n\r\nconst createOrderRefundVoucher = (order: Order, amount: number, employeeId: SystemId) => {\r\n    const lastPositivePayment = [...(order.payments ?? [])].reverse().find(p => p.amount > 0);\r\n    const { document, error } = createPaymentDocument({\r\n        amount,\r\n        description: `Ho√†n ti·ªÅn do h·ªßy ƒë∆°n ${order.id}`,\r\n        recipientName: order.customerName,\r\n        recipientSystemId: order.customerSystemId,\r\n        customerSystemId: order.customerSystemId,\r\n        customerName: order.customerName,\r\n        branchSystemId: order.branchSystemId,\r\n        branchName: order.branchName,\r\n        createdBy: employeeId,\r\n        paymentMethodName: lastPositivePayment?.method || 'Ti·ªÅn m·∫∑t',\r\n        paymentTypeName: 'Ho√†n ti·ªÅn kh√°ch h√†ng',\r\n        originalDocumentId: order.id,\r\n        linkedOrderSystemId: order.systemId,\r\n        affectsDebt: true,\r\n        category: 'other',\r\n    });\r\n\r\n    if (!document) {\r\n        console.error('[cancelOrder] Kh√¥ng th·ªÉ t·∫°o phi·∫øu chi ho√†n ti·ªÅn', error);\r\n        return null;\r\n    }\r\n\r\n    return document;\r\n};\r\n\r\n// REMOVED: initialDataOmit transformation - database is source of truth\r\nconst initialData: Order[] = [];\r\n\r\nconst baseStore = createCrudStore<Order>([], 'orders', {\r\n  businessIdField: 'id',\r\n  apiEndpoint: '/api/orders',\r\n  getCurrentUser: () => {\r\n    return asSystemId(getCurrentUserSystemId());\r\n  }\r\n});\r\n\r\n// ‚úÖ API Sync helpers\r\nconst API_ENDPOINT = '/api/orders';\r\n\r\nconst syncToApi = {\r\n  create: async (order: Order) => {\r\n    try {\r\n      const response = await fetch(API_ENDPOINT, {\r\n        method: 'POST',\r\n        credentials: 'include',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify(order),\r\n      });\r\n      if (!response.ok) console.warn('[Order API] Create sync failed');\r\n      else console.log('[Order API] Created:', order.systemId);\r\n    } catch (e) {\r\n      console.warn('[Order API] Create sync error:', e);\r\n    }\r\n  },\r\n  update: async (systemId: SystemId, updates: Partial<Order>) => {\r\n    try {\r\n      const response = await fetch(`${API_ENDPOINT}/${systemId}`, {\r\n        method: 'PATCH',\r\n        credentials: 'include',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify(updates),\r\n      });\r\n      if (!response.ok) console.warn('[Order API] Update sync failed');\r\n      else console.log('[Order API] Updated:', systemId);\r\n    } catch (e) {\r\n      console.warn('[Order API] Update sync error:', e);\r\n    }\r\n  },\r\n  delete: async (systemId: SystemId, hard = false) => {\r\n    try {\r\n      const response = await fetch(`${API_ENDPOINT}/${systemId}`, {\r\n        method: 'DELETE',\r\n        credentials: 'include',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({ hard }),\r\n      });\r\n      if (!response.ok) console.warn('[Order API] Delete sync failed');\r\n      else console.log('[Order API] Deleted:', systemId);\r\n    } catch (e) {\r\n      console.warn('[Order API] Delete sync error:', e);\r\n    }\r\n  },\r\n  restore: async (systemId: SystemId) => {\r\n    try {\r\n      const response = await fetch(`${API_ENDPOINT}/${systemId}/restore`, {\r\n        method: 'POST',\r\n        credentials: 'include',\r\n        headers: { 'Content-Type': 'application/json' },\r\n      });\r\n      if (!response.ok) console.warn('[Order API] Restore sync failed');\r\n      else console.log('[Order API] Restored:', systemId);\r\n    } catch (e) {\r\n      console.warn('[Order API] Restore sync error:', e);\r\n    }\r\n  },\r\n};\r\n\r\n// ‚úÖ Wrap base store methods with API sync\r\nconst originalAdd = baseStore.getState().add;\r\nconst originalUpdate = baseStore.getState().update;\r\nconst originalRemove = baseStore.getState().remove;\r\nconst originalHardDelete = baseStore.getState().hardDelete;\r\nconst originalRestore = baseStore.getState().restore;\r\n\r\nbaseStore.setState({\r\n  add: (item: Omit<Order, 'systemId'>) => {\r\n    const result = originalAdd(item);\r\n    syncToApi.create(result);\r\n    return result;\r\n  },\r\n  update: (systemId: SystemId, updates: Partial<Order>) => {\r\n    originalUpdate(systemId, updates);\r\n    syncToApi.update(systemId, updates);\r\n  },\r\n  remove: (systemId: SystemId) => {\r\n    originalRemove(systemId);\r\n    syncToApi.delete(systemId, false);\r\n  },\r\n  hardDelete: (systemId: SystemId) => {\r\n    originalHardDelete(systemId);\r\n    syncToApi.delete(systemId, true);\r\n  },\r\n  restore: (systemId: SystemId) => {\r\n    originalRestore(systemId);\r\n    syncToApi.restore(systemId);\r\n  },\r\n});\r\n\r\n// ‚úÖ MIGRATION: Ensure all orders have paidAmount field (backward compatibility)\r\nbaseStore.setState(state => ({\r\n  data: state.data.map(order => ({\r\n    ...order,\r\n    paidAmount: order.paidAmount ?? 0, // Default to 0 if undefined\r\n  }))\r\n}));\r\n\r\n// ‚úÖ MIGRATION: Merge seed data - add new orders from initialData if not exist in persisted store\r\nbaseStore.setState(state => {\r\n  const existingIds = new Set(state.data.map(o => o.systemId));\r\n  const newOrders = initialData.filter(o => !existingIds.has(o.systemId));\r\n  if (newOrders.length > 0) {\r\n    return { data: [...state.data, ...newOrders] };\r\n  }\r\n  return state;\r\n});\r\n\r\n// ‚úÖ MIGRATION: Fix order status - orders with full payment and delivery should be \"Ho√†n th√†nh\"\r\nbaseStore.setState(state => ({\r\n  data: state.data.map(order => {\r\n    // If order is already completed or cancelled, skip\r\n    if (order.status === 'Ho√†n th√†nh' || order.status === 'ƒê√£ h·ªßy') {\r\n      return order;\r\n    }\r\n    \r\n    // Check if all active packagings are delivered\r\n    const activePackagings = order.packagings.filter(p => p.status !== 'H·ªßy ƒë√≥ng g√≥i');\r\n    const isAllDelivered = activePackagings.length > 0 && activePackagings.every(p => p.deliveryStatus === 'ƒê√£ giao h√†ng');\r\n    \r\n    // If fully paid and fully delivered, update status to \"Ho√†n th√†nh\"\r\n    if (order.paymentStatus === 'Thanh to√°n to√†n b·ªô' && (isAllDelivered || order.deliveryStatus === 'ƒê√£ giao h√†ng')) {\r\n      return {\r\n        ...order,\r\n        status: 'Ho√†n th√†nh' as OrderMainStatus,\r\n        completedDate: order.completedDate || toISODateTime(new Date()),\r\n      };\r\n    }\r\n    \r\n    return order;\r\n  })\r\n}));\r\n\r\nconst originalAddWithStock = baseStore.getState().add;\r\n\r\nbaseStore.setState({\r\n    add: (item) => {\r\n        const { commitStock, findById: findProductById } = useProductStore.getState();\r\n        const userInfo = getCurrentUserInfo();\r\n        const newItem = originalAddWithStock(item);\r\n        if (newItem) {\r\n            const hydratedPackagings = ensureOrderPackagingIdentifiers(newItem);\r\n            if (hydratedPackagings) {\r\n                Object.assign(newItem, hydratedPackagings);\r\n                baseStore.setState(state => ({\r\n                    data: state.data.map(order => order.systemId === hydratedPackagings.systemId ? hydratedPackagings : order),\r\n                }));\r\n            }\r\n            newItem.lineItems.forEach(li => {\r\n                const product = findProductById(asSystemId(li.productSystemId));\r\n                \r\n                // ‚úÖ X·ª≠ l√Ω combo: commit stock c·ªßa SP con thay v√¨ combo\r\n                if (product && isComboProduct(product) && product.comboItems) {\r\n                    product.comboItems.forEach(comboItem => {\r\n                        // Commit stock = s·ªë l∆∞·ª£ng combo √ó s·ªë l∆∞·ª£ng SP con trong combo\r\n                        const totalQuantity = li.quantity * comboItem.quantity;\r\n                        commitStock(asSystemId(comboItem.productSystemId), asSystemId(newItem.branchSystemId), totalQuantity);\r\n                    });\r\n                } else {\r\n                    // S·∫£n ph·∫©m th∆∞·ªùng: commit stock nh∆∞ b√¨nh th∆∞·ªùng\r\n                    commitStock(asSystemId(li.productSystemId), asSystemId(newItem.branchSystemId), li.quantity);\r\n                }\r\n            });\r\n            \r\n            // ‚úÖ C·∫≠p nh·∫≠t lastPurchaseDate khi t·∫°o ƒë∆°n m·ªõi (ƒë·ªÉ SLA/churn risk ho·∫°t ƒë·ªông ƒë√∫ng)\r\n            if (newItem.customerSystemId) {\r\n                const { update: updateCustomer, findById: findCustomer } = useCustomerStore.getState();\r\n                const customer = findCustomer(newItem.customerSystemId);\r\n                if (customer) {\r\n                    updateCustomer(newItem.customerSystemId, {\r\n                        lastPurchaseDate: new Date().toISOString().split('T')[0],\r\n                    });\r\n                }\r\n            }\r\n            \r\n            // ‚úÖ Add activity history entry\r\n            const historyEntry = createCreatedEntry(\r\n                userInfo,\r\n                `${userInfo.name} ƒë√£ t·∫°o ƒë∆°n h√†ng ${newItem.id} cho kh√°ch h√†ng ${newItem.customerName} (T·ªïng: ${newItem.grandTotal.toLocaleString('vi-VN')}ƒë)`\r\n            );\r\n            baseStore.setState(state => ({\r\n                data: state.data.map(order => order.systemId === newItem.systemId ? { ...order, activityHistory: [historyEntry] } : order),\r\n            }));\r\n        }\r\n        return newItem;\r\n    },\r\n});\r\n\r\nconst backfillPackagingIdentifiers = () => {\r\n    const currentState = baseStore.getState();\r\n    let changed = false;\r\n    const updatedData = currentState.data.map(order => {\r\n        const updatedOrder = ensureOrderPackagingIdentifiers(order);\r\n        if (updatedOrder) {\r\n            changed = true;\r\n            return updatedOrder;\r\n        }\r\n        return order;\r\n    });\r\n\r\n    if (changed) {\r\n        baseStore.setState({ data: updatedData });\r\n    }\r\n};\r\n\r\nbackfillPackagingIdentifiers();\r\n\r\nconst augmentedMethods = {\r\n    cancelOrder: (\r\n        systemId: SystemId,\r\n        employeeId: SystemId,\r\n        options?: { reason?: string; restock?: boolean }\r\n    ) => {\r\n        const { reason, restock = true } = options ?? {};\r\n        const currentOrder = baseStore.getState().data.find(o => o.systemId === systemId);\r\n        if (!ensureCancellationAllowed(currentOrder, 'h·ªßy ƒë∆°n h√†ng')) {\r\n            return;\r\n        }\r\n\r\n        baseStore.setState(state => {\r\n            const orderToCancel = state.data.find(o => o.systemId === systemId);\r\n            if (!orderToCancel || orderToCancel.status === 'ƒê√£ h·ªßy') {\r\n                return state;\r\n            }\r\n\r\n            const employee = useEmployeeStore.getState().findById(employeeId as SystemId);\r\n            const now = toISODateTime(new Date());\r\n            const cancellationReason = (reason && reason.trim().length > 0)\r\n                ? reason.trim()\r\n                : orderToCancel.cancellationReason || `H·ªßy b·ªüi ${employee?.fullName || 'H·ªá th·ªëng'}`;\r\n\r\n            // ‚úÖ Uncommit stock (h·ªó tr·ª£ combo)\r\n            if (restock) {\r\n                orderToCancel.lineItems.forEach(item => {\r\n                    processLineItemStock(item, orderToCancel.branchSystemId, 'uncommit', item.quantity);\r\n                });\r\n            }\r\n\r\n            const hasDispatchedStock = orderToCancel.stockOutStatus === 'Xu·∫•t kho to√†n b·ªô'\r\n                || ['Ch·ªù l·∫•y h√†ng', 'ƒêang giao h√†ng', 'ƒê√£ giao h√†ng', 'Ch·ªù giao l·∫°i'].includes(orderToCancel.deliveryStatus);\r\n\r\n            // ‚úÖ Return stock from transit (h·ªó tr·ª£ combo)\r\n            if (restock && hasDispatchedStock) {\r\n                orderToCancel.lineItems.forEach(item => {\r\n                    processLineItemStock(item, orderToCancel.branchSystemId, 'return', item.quantity);\r\n                });\r\n            }\r\n\r\n            const existingPayments = orderToCancel.payments ?? [];\r\n            const netCollected = existingPayments.reduce((sum, payment) => sum + payment.amount, 0);\r\n            let refundPaymentEntry: OrderPayment | null = null;\r\n            const refundAmount = netCollected > 0 ? netCollected : 0;\r\n\r\n            if (refundAmount > 0) {\r\n                const refundVoucher = createOrderRefundVoucher(orderToCancel, refundAmount, employeeId);\r\n                if (!refundVoucher) {\r\n                    alert('Kh√¥ng th·ªÉ t·∫°o phi·∫øu chi ho√†n ti·ªÅn. Vui l√≤ng ki·ªÉm tra c·∫•u h√¨nh t√†i ch√≠nh tr∆∞·ªõc khi h·ªßy ƒë∆°n.');\r\n                    return state;\r\n                }\r\n\r\n                refundPaymentEntry = {\r\n                    systemId: refundVoucher.systemId,\r\n                    id: refundVoucher.id,\r\n                    date: refundVoucher.date,\r\n                    amount: -refundAmount,\r\n                    method: refundVoucher.paymentMethodName,\r\n                    createdBy: employeeId,\r\n                    description: `Ho√†n ti·ªÅn khi h·ªßy ƒë∆°n ${orderToCancel.id}`,\r\n                };\r\n            }\r\n\r\n            const updatedPayments = refundPaymentEntry ? [...existingPayments, refundPaymentEntry] : existingPayments;\r\n            const updatedPaidAmount = Math.max(0, (orderToCancel.paidAmount ?? 0) - refundAmount);\r\n            const updatedPackagings = orderToCancel.packagings.map(pkg => {\r\n                if (pkg.status === 'H·ªßy ƒë√≥ng g√≥i' && pkg.deliveryStatus === 'ƒê√£ h·ªßy') {\r\n                    return pkg;\r\n                }\r\n                return {\r\n                    ...pkg,\r\n                    status: 'H·ªßy ƒë√≥ng g√≥i' as PackagingStatus,\r\n                    deliveryStatus: 'ƒê√£ h·ªßy' as OrderDeliveryStatus,\r\n                    cancelDate: now,\r\n                    cancelReason: pkg.cancelReason ?? cancellationReason,\r\n                    cancelingEmployeeId: employeeId,\r\n                    cancelingEmployeeName: employee?.fullName || 'H·ªá th·ªëng',\r\n                };\r\n            });\r\n\r\n            const updatedOrder = {\r\n                ...orderToCancel,\r\n                status: 'ƒê√£ h·ªßy' as OrderMainStatus,\r\n                cancelledDate: now,\r\n                cancellationReason,\r\n                deliveryStatus: 'ƒê√£ h·ªßy' as OrderDeliveryStatus,\r\n                stockOutStatus: restock ? 'Ch∆∞a xu·∫•t kho' as const : orderToCancel.stockOutStatus,\r\n                payments: updatedPayments,\r\n                paidAmount: updatedPaidAmount,\r\n                paymentStatus: refundPaymentEntry ? 'Ch∆∞a thanh to√°n' as OrderPaymentStatus : orderToCancel.paymentStatus,\r\n                packagings: updatedPackagings,\r\n                cancellationMetadata: {\r\n                    restockItems: restock,\r\n                    notifyCustomer: false,\r\n                    emailNotifiedAt: undefined,\r\n                },\r\n                activityHistory: appendHistoryEntry(\r\n                    orderToCancel.activityHistory,\r\n                    createHistoryEntry(\r\n                        'cancelled',\r\n                        getCurrentUserInfo(),\r\n                        `${employee?.fullName || 'H·ªá th·ªëng'} ƒë√£ h·ªßy ƒë∆°n h√†ng. L√Ω do: ${cancellationReason}${refundAmount > 0 ? `. Ho√†n ti·ªÅn: ${refundAmount.toLocaleString('vi-VN')}ƒë` : ''}`\r\n                    )\r\n                ),\r\n            };\r\n\r\n            // ‚úÖ Remove debt transaction from customer\r\n            useCustomerStore.getState().removeDebtTransaction(orderToCancel.customerSystemId, orderToCancel.id);\r\n\r\n            return { data: state.data.map(o => (o.systemId === systemId ? updatedOrder : o)) };\r\n        });\r\n    },\r\n\r\n    addPayment: (orderSystemId: SystemId, paymentData: { amount: number; method: string }, employeeId: SystemId) => {\r\n        // --- Side effects must happen outside setState ---\r\n        const order = baseStore.getState().findById(orderSystemId as SystemId);\r\n        const employee = useEmployeeStore.getState().findById(employeeId as SystemId);\r\n\r\n        if (!order || !employee) {\r\n            console.error(\"Order or employee not found for payment.\");\r\n            return;\r\n        }\r\n\r\n        const { document: createdReceipt, error } = createReceiptDocument({\r\n            amount: paymentData.amount,\r\n            description: `Thanh to√°n cho ƒë∆°n h√†ng ${order.id}`,\r\n            customerName: order.customerName,\r\n            customerSystemId: order.customerSystemId,\r\n            branchSystemId: order.branchSystemId,\r\n            branchName: order.branchName,\r\n            createdBy: employeeId,\r\n            paymentMethodName: paymentData.method,\r\n            receiptTypeName: 'Thanh to√°n cho ƒë∆°n h√†ng',\r\n            originalDocumentId: order.id,\r\n            linkedOrderSystemId: order.systemId,\r\n            affectsDebt: true,\r\n        });\r\n\r\n        if (!createdReceipt) {\r\n            console.error('Failed to create receipt', error);\r\n            alert('Kh√¥ng th·ªÉ t·∫°o phi·∫øu thu cho ƒë∆°n h√†ng. Vui l√≤ng ki·ªÉm tra c·∫•u h√¨nh ch·ª©ng t·ª´.');\r\n            return;\r\n        }\r\n\r\n        // 2. Now, update the order state with the created receipt info\r\n        baseStore.setState(state => {\r\n            const orderIndex = state.data.findIndex(o => o.systemId === orderSystemId);\r\n            if (orderIndex === -1) return state;\r\n\r\n            const orderToUpdate = state.data[orderIndex];\r\n            const newPayment: OrderPayment = {\r\n                systemId: createdReceipt.systemId,\r\n                id: createdReceipt.id,\r\n                date: createdReceipt.date,\r\n                amount: createdReceipt.amount,\r\n                method: createdReceipt.paymentMethodName,\r\n                createdBy: asSystemId(createdReceipt.createdBy),\r\n                description: createdReceipt.description,\r\n            };\r\n\r\n            const updatedOrder = applyPaymentToOrder(orderToUpdate, newPayment);\r\n            \r\n            // ‚úÖ Add activity history entry\r\n            updatedOrder.activityHistory = appendHistoryEntry(\r\n                orderToUpdate.activityHistory,\r\n                createHistoryEntry(\r\n                    'payment_made',\r\n                    getCurrentUserInfo(),\r\n                    `${employee?.fullName || 'Nh√¢n vi√™n'} ƒë√£ thanh to√°n ${paymentData.amount.toLocaleString('vi-VN')}ƒë b·∫±ng ${paymentData.method}`\r\n                )\r\n            );\r\n            \r\n            const newData = [...state.data];\r\n            newData[orderIndex] = updatedOrder;\r\n\r\n            return { data: newData };\r\n        });\r\n    },\r\n\r\n    requestPackaging: (orderSystemId: SystemId, employeeId: SystemId, assignedEmployeeId?: SystemId) => {\r\n        baseStore.setState(state => {\r\n            const order = state.data.find(o => o.systemId === orderSystemId);\r\n            if (!order) return state;\r\n            const employee = useEmployeeStore.getState().findById(employeeId as SystemId);\r\n            const assignedEmployee = assignedEmployeeId ? useEmployeeStore.getState().findById(assignedEmployeeId as SystemId) : null;\r\n            \r\n            // Count only active packagings for proper numbering\r\n            const activePackagings = order.packagings.filter(p => p.status !== 'H·ªßy ƒë√≥ng g√≥i');\r\n            const activeCountAfterInsert = activePackagings.length + 1;\r\n            const newActiveIndex = activePackagings.length; // This will be the index in active packagings\r\n            \r\n            const newPackaging: Packaging = {\r\n                systemId: getNextPackagingSystemId(), // ‚úÖ Use proper format PACKAGE000001\r\n                id: buildPackagingBusinessId(order.id, newActiveIndex, activeCountAfterInsert),\r\n                requestDate: toISODateTime(new Date()),\r\n                requestingEmployeeId: employeeId,\r\n                requestingEmployeeName: employee?.fullName || 'N/A',\r\n                assignedEmployeeId,\r\n                assignedEmployeeName: assignedEmployee?.fullName,\r\n                status: 'Ch·ªù ƒë√≥ng g√≥i',\r\n                printStatus: 'Ch∆∞a in',\r\n            };\r\n\r\n            const updatedOrder = { ...order, packagings: [...order.packagings, newPackaging], deliveryStatus: 'Ch·ªù ƒë√≥ng g√≥i' as OrderDeliveryStatus };\r\n            return { data: state.data.map(o => o.systemId === orderSystemId ? updatedOrder : o) };\r\n        });\r\n    },\r\n\r\n    confirmPackaging: (orderSystemId: SystemId, packagingSystemId: SystemId, employeeId: SystemId) => {\r\n        // ‚úÖ Check negative packing setting\r\n        const { allowNegativePacking } = useSalesManagementSettingsStore.getState();\r\n        if (!allowNegativePacking) {\r\n            const order = baseStore.getState().data.find(o => o.systemId === orderSystemId);\r\n            if (order) {\r\n                const { findById: findProductById } = useProductStore.getState();\r\n                for (const item of order.lineItems) {\r\n                    const product = findProductById(asSystemId(item.productSystemId));\r\n                    \r\n                    if (product && isComboProduct(product) && product.comboItems) {\r\n                        for (const comboItem of product.comboItems) {\r\n                            const childProduct = findProductById(asSystemId(comboItem.productSystemId));\r\n                            const requiredQty = item.quantity * comboItem.quantity;\r\n                            const currentStock = childProduct?.inventoryByBranch?.[order.branchSystemId] || 0;\r\n                            if (currentStock < requiredQty) {\r\n                                alert(`Kh√¥ng th·ªÉ ƒë√≥ng g√≥i: S·∫£n ph·∫©m \"${childProduct?.name}\" kh√¥ng ƒë·ªß t·ªìn kho (C√≥: ${currentStock}, C·∫ßn: ${requiredQty})`);\r\n                                return baseStore.getState();\r\n                            }\r\n                        }\r\n                    } else {\r\n                        const currentStock = product?.inventoryByBranch?.[order.branchSystemId] || 0;\r\n                        if (currentStock < item.quantity) {\r\n                            alert(`Kh√¥ng th·ªÉ ƒë√≥ng g√≥i: S·∫£n ph·∫©m \"${item.productName}\" kh√¥ng ƒë·ªß t·ªìn kho (C√≥: ${currentStock}, C·∫ßn: ${item.quantity})`);\r\n                            return baseStore.getState();\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        }\r\n\r\n        baseStore.setState(state => {\r\n            const dataCopy = [...state.data];\r\n            const orderIndex = dataCopy.findIndex(o => o.systemId === orderSystemId);\r\n            if (orderIndex === -1) return state;\r\n    \r\n        const orderCopy = { ...dataCopy[orderIndex] };\r\n            const packagingIndex = orderCopy.packagings.findIndex(p => p.systemId === packagingSystemId);\r\n            if (packagingIndex === -1) return state;\r\n            \r\n            const employee = useEmployeeStore.getState().findById(employeeId as SystemId);\r\n    \r\n        const packagingsCopy = [...orderCopy.packagings];\r\n            packagingsCopy[packagingIndex] = {\r\n                ...packagingsCopy[packagingIndex],\r\n                status: 'ƒê√£ ƒë√≥ng g√≥i' as PackagingStatus,\r\n                confirmDate: toISODateTime(new Date()),\r\n                confirmingEmployeeId: employeeId,\r\n                confirmingEmployeeName: employee?.fullName || 'N/A',\r\n            };\r\n    \r\n        orderCopy.packagings = packagingsCopy;\r\n        orderCopy.deliveryStatus = 'ƒê√£ ƒë√≥ng g√≥i' as OrderDeliveryStatus;\r\n            \r\n            dataCopy[orderIndex] = orderCopy;\r\n    \r\n        return { data: dataCopy };\r\n        });\r\n    },\r\n\r\n    cancelPackagingRequest: (orderSystemId: SystemId, packagingSystemId: SystemId, employeeId: SystemId, reason: string) => {\r\n        baseStore.setState(state => {\r\n             const order = state.data.find(o => o.systemId === orderSystemId);\r\n            if (!order) return state;\r\n            const employee = useEmployeeStore.getState().findById(employeeId as SystemId);\r\n\r\n            const updatedPackagings = order.packagings.map(p => {\r\n                if (p.systemId === packagingSystemId) {\r\n                    return {\r\n                        ...p,\r\n                        status: 'H·ªßy ƒë√≥ng g√≥i' as PackagingStatus,\r\n                        cancelDate: toISODateTime(new Date()),\r\n                        cancelingEmployeeId: employeeId,\r\n                        cancelingEmployeeName: employee?.fullName || 'N/A',\r\n                        cancelReason: reason,\r\n                    };\r\n                }\r\n                return p;\r\n            });\r\n            const isAnyActivePackaging = updatedPackagings.some(p => p.status !== 'H·ªßy ƒë√≥ng g√≥i');\r\n            const updatedOrder = { ...order, packagings: updatedPackagings, deliveryStatus: isAnyActivePackaging ? order.deliveryStatus : 'Ch·ªù ƒë√≥ng g√≥i' as OrderDeliveryStatus };\r\n            return { data: state.data.map(o => o.systemId === orderSystemId ? updatedOrder : o) };\r\n        });\r\n    },\r\n    \r\n    processInStorePickup: (orderSystemId: SystemId, packagingSystemId: SystemId) => {\r\n        baseStore.setState(state => {\r\n            const order = state.data.find(o => o.systemId === orderSystemId);\r\n            if (!order) return state;\r\n    \r\n            const totalCount = order.packagings.length;\r\n            const updatedPackagings = order.packagings.map((p, index) => {\r\n                if (p.systemId === packagingSystemId) {\r\n                    const hasId = typeof p.id === 'string' && p.id.trim().length > 0;\r\n                    const resolvedId = hasId ? p.id : buildPackagingBusinessId(order.id, index, totalCount);\r\n                    return {\r\n                        ...p,\r\n                        id: resolvedId,\r\n                        deliveryMethod: 'Nh·∫≠n t·∫°i c·ª≠a h√†ng' as OrderDeliveryMethod,\r\n                        deliveryStatus: 'ƒê√£ ƒë√≥ng g√≥i' as OrderDeliveryStatus,\r\n                        // trackingCode will be set when shipment is created in confirmInStorePickup\r\n                    };\r\n                }\r\n                return p;\r\n            });\r\n            \r\n            const updatedOrder = { \r\n                ...order, \r\n                packagings: updatedPackagings, \r\n                deliveryStatus: 'ƒê√£ ƒë√≥ng g√≥i' as OrderDeliveryStatus \r\n            };\r\n    \r\n            return { data: state.data.map(o => o.systemId === orderSystemId ? updatedOrder : o) };\r\n        });\r\n    },\r\n    \r\n    confirmInStorePickup: (orderSystemId: SystemId, packagingSystemId: SystemId, employeeId: SystemId) => {\r\n        console.log('üü¢ [confirmInStorePickup] Called with:', { orderSystemId, packagingSystemId, employeeId });\r\n        \r\n        // ‚úÖ Check negative stock out setting\r\n        const { allowNegativeStockOut } = useSalesManagementSettingsStore.getState();\r\n        if (!allowNegativeStockOut) {\r\n            const order = baseStore.getState().data.find(o => o.systemId === orderSystemId);\r\n            if (order) {\r\n                const { findById: findProductById } = useProductStore.getState();\r\n                for (const item of order.lineItems) {\r\n                    const product = findProductById(asSystemId(item.productSystemId));\r\n                    \r\n                    if (product && isComboProduct(product) && product.comboItems) {\r\n                        for (const comboItem of product.comboItems) {\r\n                            const childProduct = findProductById(asSystemId(comboItem.productSystemId));\r\n                            const requiredQty = item.quantity * comboItem.quantity;\r\n                            const currentStock = childProduct?.inventoryByBranch?.[order.branchSystemId] || 0;\r\n                            if (currentStock < requiredQty) {\r\n                                alert(`Kh√¥ng th·ªÉ xu·∫•t kho: S·∫£n ph·∫©m \"${childProduct?.name}\" kh√¥ng ƒë·ªß t·ªìn kho (C√≥: ${currentStock}, C·∫ßn: ${requiredQty})`);\r\n                                return baseStore.getState();\r\n                            }\r\n                        }\r\n                    } else {\r\n                        const currentStock = product?.inventoryByBranch?.[order.branchSystemId] || 0;\r\n                        if (currentStock < item.quantity) {\r\n                            alert(`Kh√¥ng th·ªÉ xu·∫•t kho: S·∫£n ph·∫©m \"${item.productName}\" kh√¥ng ƒë·ªß t·ªìn kho (C√≥: ${currentStock}, C·∫ßn: ${item.quantity})`);\r\n                            return baseStore.getState();\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        }\r\n\r\n        baseStore.setState(state => {\r\n            const order = state.data.find(o => o.systemId === orderSystemId);\r\n            if (!order) {\r\n                console.error('‚ùå [confirmInStorePickup] Order not found:', orderSystemId);\r\n                return state;\r\n            }\r\n    \r\n            console.log('üìã [confirmInStorePickup] Order found:', order.id);\r\n            console.log('üìã [confirmInStorePickup] Line items:', order.lineItems.length);\r\n            \r\n            // Stock logic\r\n            const { addEntry: addStockHistory } = useStockHistoryStore.getState();\r\n            const employeeData = useEmployeeStore.getState().findById(employeeId as SystemId);\r\n            const now = toISODateTime(new Date());\r\n    \r\n            order.lineItems.forEach((item, index) => {\r\n                console.log(`üì¶ [confirmInStorePickup] Dispatching item ${index + 1}:`, {\r\n                    productSystemId: item.productSystemId,\r\n                    productName: item.productName,\r\n                    quantity: item.quantity,\r\n                    branchSystemId: getBranchId(order)\r\n                });\r\n                \r\n                // ‚úÖ Dispatch stock (h·ªó tr·ª£ combo - s·∫Ω dispatch SP con)\r\n                const processedItems = processLineItemStock(item, getBranchId(order), 'dispatch', item.quantity);\r\n                \r\n                // ‚úÖ Add stock history entry for each processed item (SP con n·∫øu combo)\r\n                processedItems.forEach(processedItem => {\r\n                    const product = useProductStore.getState().findById(processedItem.productSystemId);\r\n                    const currentStock = product?.inventoryByBranch?.[getBranchId(order)] || 0;\r\n                    \r\n                    addStockHistory({\r\n                        date: now,\r\n                        productId: processedItem.productSystemId,\r\n                        action: 'Xu·∫•t kho (ƒê∆°n h√†ng)',\r\n                        quantityChange: -processedItem.quantity,\r\n                        newStockLevel: currentStock, // After dispatch\r\n                        documentId: order.id,\r\n                        branchSystemId: getBranchId(order),\r\n                        branch: order.branchName,\r\n                        employeeName: employeeData?.fullName || 'H·ªá th·ªëng',\r\n                    });\r\n                });\r\n            });\r\n    \r\n            // Status update logic - will be updated with trackingCode after shipment creation\r\n            let updatedPackagings = order.packagings.map(p => {\r\n                if (p.systemId === packagingSystemId) {\r\n                    return { \r\n                        ...p, \r\n                        deliveryStatus: 'ƒê√£ giao h√†ng' as OrderDeliveryStatus, \r\n                        deliveredDate: toISODateTime(new Date()) \r\n                    };\r\n                }\r\n                return p;\r\n            });\r\n    \r\n            const isAllDelivered = updatedPackagings.every(p => p.status === 'H·ªßy ƒë√≥ng g√≥i' || p.deliveryStatus === 'ƒê√£ giao h√†ng');\r\n            \r\n            let newStatus = order.status === 'ƒê·∫∑t h√†ng' ? 'ƒêang giao d·ªãch' : order.status;\r\n            let newCompletedDate = order.completedDate;\r\n            if (isAllDelivered && order.paymentStatus === 'Thanh to√°n to√†n b·ªô') {\r\n                newStatus = 'Ho√†n th√†nh';\r\n                newCompletedDate = toISODateTime(new Date());\r\n            }\r\n    \r\n            \r\n            const employee = useEmployeeStore.getState().findById(employeeId as SystemId);\r\n            \r\n            // ‚úÖ Create shipment record for INSTORE pickup\r\n            const packaging = order.packagings.find(p => p.systemId === packagingSystemId);\r\n            let newShipment: Shipment | null = null;\r\n            if (packaging) {\r\n                const { createShipment, updateShipment } = useShipmentStore.getState();\r\n                newShipment = createShipment({\r\n                    packagingSystemId: packagingSystemId,\r\n                    orderSystemId: orderSystemId,\r\n                    orderId: order.id,\r\n                    trackingCode: '', // Will be set to shipment business ID below\r\n                    carrier: 'Nh·∫≠n t·∫°i c·ª≠a h√†ng',\r\n                    service: 'Nh·∫≠n t·∫°i c·ª≠a h√†ng',\r\n                    deliveryStatus: 'ƒê√£ giao h√†ng',\r\n                    printStatus: 'Ch∆∞a in',\r\n                    reconciliationStatus: 'Ch∆∞a ƒë·ªëi so√°t',\r\n                    shippingFeeToPartner: 0,\r\n                    codAmount: 0,\r\n                    payer: 'Ng∆∞·ªùi g·ª≠i',\r\n                    createdAt: now,\r\n                    dispatchedAt: now,\r\n                    deliveredAt: now,\r\n                });\r\n                // Update shipment trackingCode to use its own business ID\r\n                if (newShipment) {\r\n                    updateShipment(newShipment.systemId, {\r\n                        trackingCode: newShipment.id, // Use shipment business ID (VC000XXX)\r\n                    });\r\n                    // Update packaging with shipment trackingCode\r\n                    updatedPackagings = updatedPackagings.map(p => {\r\n                        if (p.systemId === packagingSystemId) {\r\n                            return { ...p, trackingCode: newShipment!.id };\r\n                        }\r\n                        return p;\r\n                    });\r\n                }\r\n                console.log('‚úÖ [confirmInStorePickup] Shipment created:', newShipment?.id);\r\n            }\r\n            \r\n            const updatedOrder = { \r\n                ...order, \r\n                packagings: updatedPackagings, \r\n                deliveryStatus: 'ƒê√£ giao h√†ng' as OrderDeliveryStatus,\r\n                status: newStatus,\r\n                completedDate: newCompletedDate,\r\n                stockOutStatus: 'Xu·∫•t kho to√†n b·ªô' as const,\r\n                dispatchedDate: toISODateTime(new Date()),\r\n                dispatchedByEmployeeId: employeeId,\r\n                dispatchedByEmployeeName: employee?.fullName,\r\n            };\r\n    \r\n            console.log('‚úÖ [confirmInStorePickup] Stock dispatched successfully');\r\n            return { data: state.data.map(o => o.systemId === orderSystemId ? updatedOrder : o) };\r\n        });\r\n    },    \r\n    confirmPartnerShipment: async (orderSystemId: SystemId, packagingSystemId: SystemId, shipmentData: any): Promise<{ success: boolean; message: string }> => {\r\n        try {\r\n            const order = baseStore.getState().data.find(o => o.systemId === orderSystemId);\r\n            if (!order) {\r\n                return { success: false, message: 'Kh√¥ng t√¨m th·∫•y ƒë∆°n h√†ng' };\r\n            }\r\n\r\n            // ‚úÖ Check negative packing setting (covers creating shipment)\r\n            const { allowNegativePacking } = useSalesManagementSettingsStore.getState();\r\n            if (!allowNegativePacking) {\r\n                const { findById: findProductById } = useProductStore.getState();\r\n                for (const item of order.lineItems) {\r\n                    const product = findProductById(asSystemId(item.productSystemId));\r\n                    \r\n                    if (product && isComboProduct(product) && product.comboItems) {\r\n                        for (const comboItem of product.comboItems) {\r\n                            const childProduct = findProductById(asSystemId(comboItem.productSystemId));\r\n                            const requiredQty = item.quantity * comboItem.quantity;\r\n                            const currentStock = childProduct?.inventoryByBranch?.[order.branchSystemId] || 0;\r\n                            if (currentStock < requiredQty) {\r\n                                return { success: false, message: `Kh√¥ng th·ªÉ t·∫°o v·∫≠n ƒë∆°n: S·∫£n ph·∫©m \"${childProduct?.name}\" kh√¥ng ƒë·ªß t·ªìn kho` };\r\n                            }\r\n                        }\r\n                    } else {\r\n                        const currentStock = product?.inventoryByBranch?.[order.branchSystemId] || 0;\r\n                        if (currentStock < item.quantity) {\r\n                            return { success: false, message: `Kh√¥ng th·ªÉ t·∫°o v·∫≠n ƒë∆°n: S·∫£n ph·∫©m \"${item.productName}\" kh√¥ng ƒë·ªß t·ªìn kho` };\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n\r\n            // ‚úÖ Get GHTK preview params from window (set by ShippingIntegration)\r\n            const ghtkParams = (window as any).__ghtkPreviewParams;\r\n            \r\n            if (!ghtkParams) {\r\n                return { success: false, message: 'Thi·∫øu th√¥ng tin v·∫≠n chuy·ªÉn. Vui l√≤ng ch·ªçn d·ªãch v·ª• v·∫≠n chuy·ªÉn.' };\r\n            }\r\n\r\n            // ‚úÖ Import GHTK service dynamically\r\n            const { GHTKService } = await import('../settings/shipping/integrations/ghtk-service');\r\n            const { getGHTKCredentials } = await import('../../lib/utils/get-shipping-credentials');\r\n            \r\n            const { apiToken, partnerCode } = getGHTKCredentials();\r\n            const ghtkService = new GHTKService(apiToken, partnerCode);\r\n\r\n            console.log('üì§ [confirmPartnerShipment] Calling GHTK API with params:', ghtkParams);\r\n\r\n            // ‚úÖ Call real GHTK API\r\n            const result = await ghtkService.createOrder(ghtkParams);\r\n\r\n            if (!result.success || !result.order) {\r\n                throw new Error(result.message || 'Kh√¥ng th·ªÉ t·∫°o ƒë∆°n v·∫≠n chuy·ªÉn');\r\n            }\r\n\r\n            // ‚úÖ Update order with real tracking code from GHTK\r\n            const trackingCode = result.order.label;\r\n            const ghtkTrackingId = result.order.tracking_id;\r\n            const estimatedPickTime = result.order.estimated_pick_time;\r\n            const estimatedDeliverTime = result.order.estimated_deliver_time;\r\n\r\n            baseStore.setState(state => {\r\n                const updatedPackagings = order.packagings.map(p => {\r\n                    if (p.systemId === packagingSystemId) {\r\n                        return {\r\n                            ...p,\r\n                            deliveryMethod: 'D·ªãch v·ª• giao h√†ng' as OrderDeliveryMethod,\r\n                            deliveryStatus: 'Ch·ªù l·∫•y h√†ng' as OrderDeliveryStatus,\r\n                            carrier: 'GHTK',\r\n                            service: result.order?.fee ? `${result.order.fee}ƒë` : 'Standard',\r\n                            trackingCode: trackingCode,\r\n                            shippingFeeToPartner: parseInt(result.order?.fee || '0') || 0,\r\n                            codAmount: ghtkParams.pick_money || 0,\r\n                            payer: (ghtkParams.is_freeship === 1 ? 'Ng∆∞·ªùi g·ª≠i' : 'Ng∆∞·ªùi nh·∫≠n') as 'Ng∆∞·ªùi g·ª≠i' | 'Ng∆∞·ªùi nh·∫≠n',\r\n                            noteToShipper: ghtkParams.note || '',\r\n                            weight: ghtkParams.weight,\r\n                            dimensions: `${ghtkParams.products?.[0]?.length || 10}√ó${ghtkParams.products?.[0]?.width || 10}√ó${ghtkParams.products?.[0]?.height || 10}`,\r\n                            // ‚úÖ Store GHTK specific data\r\n                            ghtkTrackingId: String(ghtkTrackingId),\r\n                            estimatedPickTime: estimatedPickTime,\r\n                            estimatedDeliverTime: estimatedDeliverTime,\r\n                        };\r\n                    }\r\n                    return p;\r\n                });\r\n                \r\n                const updatedOrder = { \r\n                    ...order, \r\n                    packagings: updatedPackagings, \r\n                    deliveryStatus: 'Ch·ªù l·∫•y h√†ng' as OrderDeliveryStatus, \r\n                    status: 'ƒêang giao d·ªãch' as OrderMainStatus \r\n                };\r\n                \r\n                return { data: state.data.map(o => o.systemId === orderSystemId ? updatedOrder : o) };\r\n            });\r\n\r\n            console.log('‚úÖ [confirmPartnerShipment] GHTK order created successfully:', {\r\n                trackingCode,\r\n                ghtkTrackingId,\r\n                estimatedPickTime,\r\n                estimatedDeliverTime\r\n            });\r\n\r\n            return { \r\n                success: true, \r\n                message: `T·∫°o v·∫≠n ƒë∆°n th√†nh c√¥ng! M√£ v·∫≠n ƒë∆°n: ${trackingCode}` \r\n            };\r\n\r\n        } catch (error) {\r\n            console.error('‚ùå [confirmPartnerShipment] Error:', error);\r\n            \r\n            let errorMessage = 'Vui l√≤ng th·ª≠ l·∫°i';\r\n            if (error instanceof Error) {\r\n                errorMessage = error.message;\r\n            }\r\n            \r\n            return { \r\n                success: false, \r\n                message: `L·ªói t·∫°o ƒë∆°n v·∫≠n chuy·ªÉn: ${errorMessage}` \r\n            };\r\n        }\r\n    },\r\n\r\n    dispatchFromWarehouse: (orderSystemId: SystemId, packagingSystemId: SystemId, employeeId: SystemId) => {\r\n        // ‚úÖ Check negative stock out setting\r\n        const { allowNegativeStockOut } = useSalesManagementSettingsStore.getState();\r\n        if (!allowNegativeStockOut) {\r\n            const order = baseStore.getState().data.find(o => o.systemId === orderSystemId);\r\n            if (order) {\r\n                const { findById: findProductById } = useProductStore.getState();\r\n                for (const item of order.lineItems) {\r\n                    const product = findProductById(asSystemId(item.productSystemId));\r\n                    \r\n                    if (product && isComboProduct(product) && product.comboItems) {\r\n                        for (const comboItem of product.comboItems) {\r\n                            const childProduct = findProductById(asSystemId(comboItem.productSystemId));\r\n                            const requiredQty = item.quantity * comboItem.quantity;\r\n                            const currentStock = childProduct?.inventoryByBranch?.[order.branchSystemId] || 0;\r\n                            if (currentStock < requiredQty) {\r\n                                alert(`Kh√¥ng th·ªÉ xu·∫•t kho: S·∫£n ph·∫©m \"${childProduct?.name}\" kh√¥ng ƒë·ªß t·ªìn kho (C√≥: ${currentStock}, C·∫ßn: ${requiredQty})`);\r\n                                return baseStore.getState();\r\n                            }\r\n                        }\r\n                    } else {\r\n                        const currentStock = product?.inventoryByBranch?.[order.branchSystemId] || 0;\r\n                        if (currentStock < item.quantity) {\r\n                            alert(`Kh√¥ng th·ªÉ xu·∫•t kho: S·∫£n ph·∫©m \"${item.productName}\" kh√¥ng ƒë·ªß t·ªìn kho (C√≥: ${currentStock}, C·∫ßn: ${item.quantity})`);\r\n                            return baseStore.getState();\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        }\r\n\r\n        baseStore.setState(state => {\r\n            const order = state.data.find(o => o.systemId === orderSystemId);\r\n            if (!order) return state;\r\n\r\n            const { addEntry: addStockHistory } = useStockHistoryStore.getState();\r\n            const employeeData = useEmployeeStore.getState().findById(employeeId as SystemId);\r\n            const now = toISODateTime(new Date());\r\n            \r\n            order.lineItems.forEach(item => {\r\n                // ‚úÖ Dispatch stock (h·ªó tr·ª£ combo - s·∫Ω dispatch SP con)\r\n                const processedItems = processLineItemStock(item, getBranchId(order), 'dispatch', item.quantity);\r\n                \r\n                // ‚úÖ Add stock history entry for each processed item\r\n                processedItems.forEach(processedItem => {\r\n                    const product = useProductStore.getState().findById(processedItem.productSystemId);\r\n                    const currentStock = product?.inventoryByBranch?.[getBranchId(order)] || 0;\r\n                    \r\n                    addStockHistory({\r\n                        date: now,\r\n                        productId: processedItem.productSystemId,\r\n                        action: 'Xu·∫•t kho (ƒê∆°n h√†ng)',\r\n                        quantityChange: -processedItem.quantity,\r\n                        newStockLevel: currentStock,\r\n                        documentId: order.id,\r\n                        branchSystemId: getBranchId(order),\r\n                        branch: order.branchName,\r\n                        employeeName: employeeData?.fullName || 'H·ªá th·ªëng',\r\n                    });\r\n                });\r\n            });\r\n            \r\n            const now2 = toISODateTime(new Date());\r\n            \r\n            const updatedPackagings = order.packagings.map(p => \r\n                p.systemId === packagingSystemId ? { ...p, deliveryStatus: 'ƒêang giao h√†ng' as OrderDeliveryStatus } : p\r\n            );\r\n\r\n            const updatedOrder = {\r\n                ...order,\r\n                packagings: updatedPackagings,\r\n                deliveryStatus: 'ƒêang giao h√†ng' as OrderDeliveryStatus,\r\n                stockOutStatus: 'Xu·∫•t kho to√†n b·ªô' as const,\r\n                dispatchedDate: now2,\r\n                dispatchedByEmployeeId: employeeId,\r\n                dispatchedByEmployeeName: employeeData?.fullName,\r\n                status: order.status === 'ƒê·∫∑t h√†ng' ? 'ƒêang giao d·ªãch' : order.status,\r\n            };\r\n            return { data: state.data.map(o => o.systemId === orderSystemId ? updatedOrder : o) };\r\n        });\r\n    },\r\n\r\n    completeDelivery: (orderSystemId: SystemId, packagingSystemId: SystemId, employeeId: SystemId) => {\r\n        baseStore.setState(state => {\r\n            const order = state.data.find(o => o.systemId === orderSystemId);\r\n            if (!order) return state;\r\n            \r\n            // ‚úÖ Complete delivery (h·ªó tr·ª£ combo - s·∫Ω complete SP con)\r\n            order.lineItems.forEach(item => {\r\n                processLineItemStock(item, getBranchId(order), 'complete', item.quantity);\r\n            });\r\n\r\n            const updatedPackagings = order.packagings.map(p => \r\n                p.systemId === packagingSystemId ? { ...p, deliveryStatus: 'ƒê√£ giao h√†ng' as OrderDeliveryStatus, deliveredDate: toISODateTime(new Date()) } : p\r\n            );\r\n            \r\n            const isAllDelivered = updatedPackagings.every(p => p.status === 'H·ªßy ƒë√≥ng g√≥i' || p.deliveryStatus === 'ƒê√£ giao h√†ng');\r\n            let newStatus = order.status;\r\n            let newCompletedDate = order.completedDate;\r\n            \r\n            // ‚úÖ Khi t·∫•t c·∫£ ƒë∆°n ƒë√£ giao ‚Üí t·∫°o c√¥ng n·ª£ (n·∫øu c√≥) v√† c·∫≠p nh·∫≠t stats\r\n            if (isAllDelivered && order.status !== 'Ho√†n th√†nh') {\r\n                // T√≠nh c√¥ng n·ª£ c√≤n l·∫°i\r\n                const totalPaid = (order.payments || []).reduce((sum, p) => sum + p.amount, 0);\r\n                const debtAmount = Math.max(0, order.grandTotal - totalPaid);\r\n                \r\n                // ‚úÖ T·∫°o c√¥ng n·ª£ CH·ªà KHI giao h√†ng th√†nh c√¥ng\r\n                if (debtAmount > 0) {\r\n                    const { addDebtTransaction } = useCustomerStore.getState();\r\n                    const dueDate = new Date();\r\n                    dueDate.setDate(dueDate.getDate() + 30);\r\n                    addDebtTransaction(order.customerSystemId, {\r\n                        systemId: asSystemId(`DEBT_${order.systemId}`),\r\n                        orderId: order.id,\r\n                        orderDate: order.orderDate.split('T')[0],\r\n                        amount: debtAmount,\r\n                        dueDate: dueDate.toISOString().split('T')[0],\r\n                        isPaid: false,\r\n                        remainingAmount: debtAmount,\r\n                        notes: 'C√¥ng n·ª£ t·ª´ ƒë∆°n h√†ng ƒë√£ giao th√†nh c√¥ng',\r\n                    });\r\n                }\r\n                \r\n                // Update customer stats\r\n                const { incrementOrderStats } = useCustomerStore.getState();\r\n                incrementOrderStats(order.customerSystemId, order.grandTotal);\r\n            }\r\n            \r\n            // Check if order is fully complete (delivered + fully paid)\r\n            if (isAllDelivered && order.paymentStatus === 'Thanh to√°n to√†n b·ªô') {\r\n                newStatus = 'Ho√†n th√†nh';\r\n                newCompletedDate = toISODateTime(new Date());\r\n            }\r\n\r\n            const employee = useEmployeeStore.getState().findById(employeeId as SystemId);\r\n            const updatedOrder = { \r\n                ...order, \r\n                packagings: updatedPackagings, \r\n                deliveryStatus: 'ƒê√£ giao h√†ng' as OrderDeliveryStatus, \r\n                status: newStatus, \r\n                completedDate: newCompletedDate,\r\n                activityHistory: appendHistoryEntry(\r\n                    order.activityHistory,\r\n                    createHistoryEntry(\r\n                        'status_changed',\r\n                        getCurrentUserInfo(),\r\n                        `${employee?.fullName || 'Nh√¢n vi√™n'} ƒë√£ x√°c nh·∫≠n giao h√†ng th√†nh c√¥ng${newStatus === 'Ho√†n th√†nh' ? '. ƒê∆°n h√†ng ho√†n th√†nh' : ''}`\r\n                    )\r\n                ),\r\n            };\r\n            return { data: state.data.map(o => o.systemId === orderSystemId ? updatedOrder : o) };\r\n        });\r\n    },\r\n\r\n    failDelivery: (orderSystemId: SystemId, packagingSystemId: SystemId, employeeId: SystemId, reason: string) => {\r\n        baseStore.setState(state => {\r\n            const order = state.data.find(o => o.systemId === orderSystemId);\r\n            if (!order) return state;\r\n            const { incrementFailedDeliveryStats } = useCustomerStore.getState();\r\n            \r\n            // ‚úÖ Return stock from transit (h·ªó tr·ª£ combo - s·∫Ω return SP con)\r\n            order.lineItems.forEach(item => {\r\n                processLineItemStock(item, getBranchId(order), 'return', item.quantity);\r\n            });\r\n\r\n            // ‚úÖ Update customer failed delivery stats\r\n            incrementFailedDeliveryStats(order.customerSystemId);\r\n\r\n            const updatedPackagings = order.packagings.map(p => \r\n                p.systemId === packagingSystemId ? { ...p, deliveryStatus: 'Ch·ªù giao l·∫°i' as OrderDeliveryStatus, notes: `Giao th·∫•t b·∫°i: ${reason}` } : p\r\n            );\r\n            \r\n            const updatedOrder = { ...order, packagings: updatedPackagings, deliveryStatus: 'Ch·ªù giao l·∫°i' as OrderDeliveryStatus };\r\n            return { data: state.data.map(o => o.systemId === orderSystemId ? updatedOrder : o) };\r\n         });\r\n    },\r\n\r\n    // ‚úÖ H·ªßy giao h√†ng - KH√îNG tr·∫£ h√†ng v·ªÅ kho (h√†ng b·ªã th·∫•t tung/shipper gi·ªØ)\r\n    cancelDeliveryOnly: (orderSystemId: SystemId, packagingSystemId: SystemId, employeeId: SystemId, reason: string) => {\r\n        const currentOrder = baseStore.getState().data.find(o => o.systemId === orderSystemId);\r\n        if (!ensureCancellationAllowed(currentOrder, 'h·ªßy giao h√†ng')) {\r\n            return;\r\n        }\r\n\r\n        baseStore.setState(state => {\r\n            const order = state.data.find(o => o.systemId === orderSystemId);\r\n            if (!order) return state;\r\n\r\n            // ‚úÖ Get employee info for canceller\r\n            const employeeData = useEmployeeStore.getState().findById(employeeId as SystemId);\r\n\r\n            const updatedPackagings = order.packagings.map(p => \r\n                p.systemId === packagingSystemId ? { \r\n                    ...p, \r\n                    status: 'H·ªßy ƒë√≥ng g√≥i' as PackagingStatus,\r\n                    deliveryStatus: 'ƒê√£ h·ªßy' as OrderDeliveryStatus,\r\n                    cancelReason: `H·ªßy giao h√†ng: ${reason}`, \r\n                    cancelDate: toISODateTime(new Date()),\r\n                    cancelingEmployeeId: employeeId,\r\n                    cancelingEmployeeName: employeeData?.fullName || 'H·ªá th·ªëng',\r\n                } : p\r\n            );\r\n            \r\n            // ‚úÖ Check if all packagings are cancelled, update order status accordingly\r\n            const allCancelled = updatedPackagings.every(p => p.deliveryStatus === 'ƒê√£ h·ªßy' || p.status === 'H·ªßy ƒë√≥ng g√≥i');\r\n            const hasAnyActive = updatedPackagings.some(p => p.deliveryStatus && p.deliveryStatus !== 'ƒê√£ h·ªßy' && p.status !== 'H·ªßy ƒë√≥ng g√≥i');\r\n            \r\n            let newOrderStatus = order.status;\r\n            let newDeliveryStatus = order.deliveryStatus;\r\n            \r\n            if (allCancelled) {\r\n                // All packagings cancelled ‚Üí order goes back to pending state\r\n                newOrderStatus = 'ƒêang giao d·ªãch' as OrderMainStatus;\r\n                newDeliveryStatus = 'Ch∆∞a giao h√†ng' as OrderDeliveryStatus;\r\n            } else if (hasAnyActive) {\r\n                // Some packagings still active ‚Üí keep current delivery status of remaining active packaging\r\n                const activePackaging = updatedPackagings.find(p => p.deliveryStatus && p.deliveryStatus !== 'ƒê√£ h·ªßy');\r\n                if (activePackaging?.deliveryStatus) {\r\n                    newDeliveryStatus = activePackaging.deliveryStatus;\r\n                }\r\n            }\r\n            \r\n            const updatedOrder = { \r\n                ...order, \r\n                packagings: updatedPackagings,\r\n                status: newOrderStatus,\r\n                deliveryStatus: newDeliveryStatus\r\n            };\r\n            return { data: state.data.map(o => o.systemId === orderSystemId ? updatedOrder : o) };\r\n         });\r\n    },\r\n\r\n    // ‚úÖ H·ªßy giao v√† nh·∫≠n l·∫°i h√†ng - TR·∫¢ h√†ng v·ªÅ kho (ƒë√£ nh·∫≠n l·∫°i t·ª´ shipper)\r\n    cancelDelivery: (orderSystemId: SystemId, packagingSystemId: SystemId, employeeId: SystemId, reason: string) => {\r\n        const currentOrder = baseStore.getState().data.find(o => o.systemId === orderSystemId);\r\n        if (!ensureCancellationAllowed(currentOrder, 'h·ªßy giao h√†ng')) {\r\n            return;\r\n        }\r\n\r\n         baseStore.setState(state => {\r\n            const order = state.data.find(o => o.systemId === orderSystemId);\r\n            if (!order) return state;\r\n            \r\n            // ‚úÖ TR·∫¢ h√†ng t·ª´ \"ƒëang giao\" v·ªÅ \"t·ªìn kho\" (h·ªó tr·ª£ combo - s·∫Ω return SP con)\r\n            order.lineItems.forEach(item => {\r\n                processLineItemStock(item, getBranchId(order), 'return', item.quantity);\r\n            });\r\n\r\n            // ‚úÖ Get employee info for canceller\r\n            const employeeData = useEmployeeStore.getState().findById(employeeId as SystemId);\r\n\r\n            const updatedPackagings = order.packagings.map(p => \r\n                p.systemId === packagingSystemId ? { \r\n                    ...p, \r\n                    status: 'H·ªßy ƒë√≥ng g√≥i' as PackagingStatus,\r\n                    deliveryStatus: 'ƒê√£ h·ªßy' as OrderDeliveryStatus,\r\n                    cancelReason: `H·ªßy giao h√†ng: ${reason}`, \r\n                    cancelDate: toISODateTime(new Date()),\r\n                    cancelingEmployeeId: employeeId,\r\n                    cancelingEmployeeName: employeeData?.fullName || 'H·ªá th·ªëng',\r\n                } : p\r\n            );\r\n            \r\n            // ‚úÖ Check if all packagings are cancelled, update order status accordingly\r\n            const allCancelled = updatedPackagings.every(p => p.deliveryStatus === 'ƒê√£ h·ªßy' || p.status === 'H·ªßy ƒë√≥ng g√≥i');\r\n            const hasAnyActive = updatedPackagings.some(p => p.deliveryStatus && p.deliveryStatus !== 'ƒê√£ h·ªßy' && p.status !== 'H·ªßy ƒë√≥ng g√≥i');\r\n            \r\n            let newOrderStatus = order.status;\r\n            let newDeliveryStatus = order.deliveryStatus;\r\n            \r\n            if (allCancelled) {\r\n                // All packagings cancelled ‚Üí order goes back to pending state\r\n                newOrderStatus = 'ƒêang giao d·ªãch' as OrderMainStatus;\r\n                newDeliveryStatus = 'Ch∆∞a giao h√†ng' as OrderDeliveryStatus;\r\n            } else if (hasAnyActive) {\r\n                // Some packagings still active ‚Üí keep current delivery status of remaining active packaging\r\n                const activePackaging = updatedPackagings.find(p => p.deliveryStatus && p.deliveryStatus !== 'ƒê√£ h·ªßy');\r\n                if (activePackaging?.deliveryStatus) {\r\n                    newDeliveryStatus = activePackaging.deliveryStatus;\r\n                }\r\n            }\r\n            \r\n            const updatedOrder = { \r\n                ...order, \r\n                packagings: updatedPackagings,\r\n                status: newOrderStatus,\r\n                deliveryStatus: newDeliveryStatus\r\n            };\r\n            return { data: state.data.map(o => o.systemId === orderSystemId ? updatedOrder : o) };\r\n         });\r\n    },\r\n\r\n    confirmCodReconciliation: (shipments: (Packaging & { orderSystemId: SystemId })[], employeeId: SystemId) => {\r\n        const { add: addReceipt } = useReceiptStore.getState();\r\n        const { accounts } = useCashbookStore.getState();\r\n        const { data: receiptTypes } = useReceiptTypeStore.getState();\r\n        const employee = useEmployeeStore.getState().findById(employeeId as SystemId);\r\n        const allOrders = baseStore.getState().data;\r\n    \r\n        const totalByPartnerAndBranch: Record<string, { total: number; ids: string[]; branchSystemId: string; branchName: string; partnerName: string; shipmentSystemIds: string[] }> = {};\r\n    \r\n        shipments.forEach(shipment => {\r\n            const order = allOrders.find(o => o.systemId === shipment.orderSystemId);\r\n            if (!order || !shipment.carrier) return;\r\n    \r\n            const key = `${shipment.carrier}-${getBranchId(order)}`;\r\n            if (!totalByPartnerAndBranch[key]) {\r\n                totalByPartnerAndBranch[key] = { total: 0, ids: [], branchSystemId: getBranchId(order), branchName: order.branchName, partnerName: shipment.carrier, shipmentSystemIds: [] };\r\n            }\r\n            totalByPartnerAndBranch[key].total += shipment.codAmount || 0;\r\n            totalByPartnerAndBranch[key].ids.push(shipment.trackingCode || shipment.id);\r\n            totalByPartnerAndBranch[key].shipmentSystemIds.push(shipment.systemId);\r\n        });\r\n    \r\n        const createdReceipts: (any & { shipmentSystemIds: string[] })[] = [];\r\n    \r\n        Object.values(totalByPartnerAndBranch).forEach(group => {\r\n            const account = accounts.find(acc => acc.type === 'bank' && acc.branchSystemId === group.branchSystemId) || accounts.find(acc => acc.type === 'bank');\r\n            const category = receiptTypes.find(c => c.id === 'DOISOATCOD');\r\n            if (account && category) {\r\n                const newReceiptData = {\r\n                    id: '',\r\n                    date: toISODateTime(new Date()),\r\n                    amount: group.total,\r\n                    payerType: 'ƒê·ªëi t√°c v·∫≠n chuy·ªÉn',\r\n                    payerName: group.partnerName,\r\n                    description: `ƒê·ªëi so√°t COD cho c√°c v·∫≠n ƒë∆°n: ${group.ids.join(', ')}`,\r\n                    paymentMethod: 'Chuy·ªÉn kho·∫£n',\r\n                    accountSystemId: account.systemId,\r\n                    originalDocumentId: group.ids.join(', '),\r\n                    createdBy: employee?.fullName || 'N/A',\r\n                    branchSystemId: group.branchSystemId,\r\n                    branchName: group.branchName,\r\n                    paymentReceiptTypeSystemId: category.systemId,\r\n                    paymentReceiptTypeName: category.name,\r\n                    status: 'completed' as const,\r\n                    createdAt: toISODateTime(new Date()),\r\n                    updatedAt: toISODateTime(new Date()),\r\n                    affectsDebt: false,\r\n                };\r\n                const newReceipt = addReceipt(newReceiptData as any);\r\n                if (newReceipt) {\r\n                    createdReceipts.push({ ...newReceipt, shipmentSystemIds: group.shipmentSystemIds });\r\n                }\r\n            }\r\n        });\r\n    \r\n        baseStore.setState(state => {\r\n            const updates = new Map<string, { newPayments: OrderPayment[]; reconciledShipmentIds: string[] }>();\r\n    \r\n            shipments.forEach(shipment => {\r\n                const receiptForShipment = createdReceipts.find(v => v.shipmentSystemIds.includes(shipment.systemId));\r\n                if (!receiptForShipment || !shipment.codAmount || shipment.codAmount <= 0) return;\r\n    \r\n                const orderSystemId = shipment.orderSystemId;\r\n                const orderUpdates = updates.get(orderSystemId) || { newPayments: [], reconciledShipmentIds: [] };\r\n    \r\n                const newPayment: OrderPayment = {\r\n                    systemId: receiptForShipment.systemId,\r\n                    id: receiptForShipment.id,\r\n                    date: receiptForShipment.date,\r\n                    method: 'ƒê·ªëi so√°t COD',\r\n                    amount: shipment.codAmount || 0,\r\n                    createdBy: asSystemId('SYSTEM'),\r\n                    description: `Thanh to√°n COD cho v·∫≠n ƒë∆°n ${shipment.trackingCode || shipment.id}`,\r\n                };\r\n                orderUpdates.newPayments.push(newPayment);\r\n                orderUpdates.reconciledShipmentIds.push(shipment.systemId);\r\n                updates.set(orderSystemId, orderUpdates);\r\n            });\r\n    \r\n            if (updates.size === 0) return state;\r\n    \r\n            const newData = state.data.map(order => {\r\n                if (updates.has(order.systemId)) {\r\n                    const orderUpdates = updates.get(order.systemId)!;\r\n                    let updatedOrder = { ...order };\r\n\r\n                    updatedOrder.packagings = updatedOrder.packagings.map(p =>\r\n                        orderUpdates.reconciledShipmentIds.includes(p.systemId)\r\n                            ? { ...p, reconciliationStatus: 'ƒê√£ ƒë·ªëi so√°t' as const }\r\n                            : p\r\n                    );\r\n\r\n                    for (const payment of orderUpdates.newPayments) {\r\n                        updatedOrder = applyPaymentToOrder(updatedOrder, payment);\r\n                    }\r\n    \r\n                    return updatedOrder;\r\n                }\r\n                return order;\r\n            });\r\n    \r\n            return { data: newData };\r\n        });\r\n    },\r\n\r\n    // ============================================\r\n    // GHTK INTEGRATION METHODS\r\n    // ============================================\r\n\r\n    /**\r\n     * Process GHTK webhook update\r\n     * Called when GHTK pushes status update or from tracking API\r\n     */\r\n    processGHTKWebhook: (webhookData: import('./types').GHTKWebhookPayload) => {\r\n        baseStore.setState(state => {\r\n            // Find order by tracking code or partner_id\r\n            const order = state.data.find(o => \r\n                o.packagings.some(p => \r\n                    p.trackingCode === webhookData.label_id || \r\n                    p.systemId === webhookData.partner_id ||\r\n                    o.systemId === webhookData.partner_id\r\n                )\r\n            );\r\n            \r\n            if (!order) {\r\n                console.warn('[GHTK Webhook] Order not found for:', {\r\n                    label_id: webhookData.label_id,\r\n                    partner_id: webhookData.partner_id\r\n                });\r\n                return state;\r\n            }\r\n            \r\n            // Import status mapping\r\n            const { getGHTKStatusInfo, getGHTKReasonText } = require('../../lib/ghtk-constants');\r\n            \r\n            const statusMapping = getGHTKStatusInfo(webhookData.status_id);\r\n            if (!statusMapping) {\r\n                console.warn('[GHTK Webhook] Unknown status:', webhookData.status_id);\r\n                return state;\r\n            }\r\n            \r\n            console.log('[GHTK Webhook] Processing update:', {\r\n                order: order.id,\r\n                trackingCode: webhookData.label_id,\r\n                statusId: webhookData.status_id,\r\n                statusText: statusMapping.statusText,\r\n                deliveryStatus: statusMapping.deliveryStatus\r\n            });\r\n            \r\n            // Update packaging with new status\r\n            const updatedPackagings = order.packagings.map(p => {\r\n                if (p.trackingCode !== webhookData.label_id && \r\n                    p.systemId !== webhookData.partner_id) {\r\n                    return p;\r\n                }\r\n                \r\n                return {\r\n                    ...p,\r\n                    deliveryStatus: statusMapping.deliveryStatus,\r\n                    partnerStatus: statusMapping.statusText,\r\n                    ghtkStatusId: webhookData.status_id,\r\n                    ghtkReasonCode: webhookData.reason_code,\r\n                    ghtkReasonText: webhookData.reason \r\n                        ? webhookData.reason \r\n                        : (webhookData.reason_code ? getGHTKReasonText(webhookData.reason_code) : undefined),\r\n                    actualWeight: webhookData.weight,\r\n                    actualFee: webhookData.fee,\r\n                    lastSyncedAt: toISODateTime(new Date()),\r\n                    // Update reconciliation status if status = 6 (ƒê√£ ƒë·ªëi so√°t)\r\n                    reconciliationStatus: webhookData.status_id === 6 \r\n                        ? 'ƒê√£ ƒë·ªëi so√°t' as const \r\n                        : p.reconciliationStatus,\r\n                    // Update delivered date if status = 5 or 6\r\n                    deliveredDate: [5, 6].includes(webhookData.status_id) && !p.deliveredDate\r\n                        ? toISODateTime(new Date())\r\n                        : p.deliveredDate,\r\n                };\r\n            });\r\n            \r\n            // Handle stock updates based on status\r\n            if (statusMapping.shouldUpdateStock && statusMapping.stockAction) {\r\n                const { dispatchStock, completeDelivery: productCompleteDelivery, returnStockFromTransit } = useProductStore.getState();\r\n                const { incrementFailedDeliveryStats } = useCustomerStore.getState();\r\n                \r\n                // ‚úÖ Expand combo items to child products\r\n                const stockItems = getComboStockItems(order.lineItems);\r\n                \r\n                stockItems.forEach(item => {\r\n                    switch (statusMapping.stockAction) {\r\n                        case 'dispatch':\r\n                            // Status 3: ƒê√£ l·∫•y h√†ng -> Move to transit\r\n                            dispatchStock(item.productSystemId, asSystemId(getBranchId(order)), item.quantity);\r\n                            break;\r\n                        case 'complete':\r\n                            // Status 5: ƒê√£ giao h√†ng -> Complete delivery\r\n                            productCompleteDelivery(item.productSystemId, asSystemId(getBranchId(order)), item.quantity);\r\n                            break;\r\n                        case 'return':\r\n                            // Status -1, 7, 9, 13, 20: Failed/Returned -> Return stock\r\n                            returnStockFromTransit(item.productSystemId, asSystemId(getBranchId(order)), item.quantity);\r\n                            break;\r\n                    }\r\n                });\r\n                \r\n                // ‚úÖ Increment failed delivery stats for customer if return (moved outside loop)\r\n                if (statusMapping.stockAction === 'return') {\r\n                    const failureStatuses = [7, 9, 13, 20, 21];\r\n                    const currentPackaging = order.packagings.find(p => p.trackingCode === webhookData.label_id);\r\n                    const previousStatusId = currentPackaging?.ghtkStatusId;\r\n                    \r\n                    if (failureStatuses.includes(webhookData.status_id) && (!previousStatusId || !failureStatuses.includes(previousStatusId))) {\r\n                        incrementFailedDeliveryStats(order.customerSystemId);\r\n                    }\r\n                }\r\n                \r\n                console.log('[GHTK Webhook] Stock updated:', {\r\n                    action: statusMapping.stockAction,\r\n                    items: stockItems.length\r\n                });\r\n            }\r\n            \r\n            // Determine order-level delivery status\r\n            const allPackagingsDelivered = updatedPackagings.every(p => \r\n                p.status === 'H·ªßy ƒë√≥ng g√≥i' || \r\n                p.deliveryStatus === 'ƒê√£ giao h√†ng'\r\n            );\r\n            \r\n            let newOrderDeliveryStatus = order.deliveryStatus;\r\n            let newOrderStatus = order.status;\r\n            let newCompletedDate = order.completedDate;\r\n            let newStockOutStatus = order.stockOutStatus;\r\n            \r\n            // Update order delivery status\r\n            if (allPackagingsDelivered) {\r\n                newOrderDeliveryStatus = 'ƒê√£ giao h√†ng';\r\n                \r\n                // Auto-complete order if delivered + paid\r\n                if (order.paymentStatus === 'Thanh to√°n to√†n b·ªô' && order.status !== 'Ho√†n th√†nh') {\r\n                    newOrderStatus = 'Ho√†n th√†nh';\r\n                    newCompletedDate = toISODateTime(new Date());\r\n                    \r\n                    // Update customer stats\r\n                    const { incrementOrderStats } = useCustomerStore.getState();\r\n                    incrementOrderStats(order.customerSystemId, order.grandTotal);\r\n                    \r\n                    console.log('[GHTK Webhook] Order completed:', order.id);\r\n                }\r\n            } else if (statusMapping.statusId === 3) {\r\n                // Status 3: ƒê√£ l·∫•y h√†ng\r\n                newOrderDeliveryStatus = 'ƒêang giao h√†ng';\r\n                newStockOutStatus = 'Xu·∫•t kho to√†n b·ªô';\r\n            } else if ([4, 10].includes(statusMapping.statusId)) {\r\n                // Status 4, 10: ƒêang giao\r\n                newOrderDeliveryStatus = 'ƒêang giao h√†ng';\r\n            }\r\n            \r\n            const updatedOrder = {\r\n                ...order,\r\n                packagings: updatedPackagings,\r\n                deliveryStatus: newOrderDeliveryStatus,\r\n                status: newOrderStatus,\r\n                completedDate: newCompletedDate,\r\n                stockOutStatus: newStockOutStatus,\r\n            };\r\n            \r\n            return {\r\n                data: state.data.map(o => o.systemId === order.systemId ? updatedOrder : o)\r\n            };\r\n        });\r\n    },\r\n\r\n    /**\r\n     * Cancel GHTK shipment\r\n     * ‚ö†Ô∏è Ch·ªâ h·ªßy ƒë∆∞·ª£c khi ƒë∆°n ·ªü tr·∫°ng th√°i: 1, 2, 12 (Ch∆∞a ti·∫øp nh·∫≠n, ƒê√£ ti·∫øp nh·∫≠n, ƒêang l·∫•y h√†ng)\r\n     */\r\n    cancelGHTKShipment: async (orderSystemId: SystemId, packagingSystemId: SystemId, trackingCode: string) => {\r\n        try {\r\n            console.log('[GHTK] Cancelling shipment:', trackingCode);\r\n            \r\n            // ‚úÖ L·∫•y credentials t·ª´ shipping_partners_config\r\n            const { getGHTKCredentials } = await import('../../lib/utils/get-shipping-credentials');\r\n            let credentials;\r\n            \r\n            try {\r\n                credentials = getGHTKCredentials();\r\n            } catch (error: any) {\r\n                return {\r\n                    success: false,\r\n                    message: error.message || 'Ch∆∞a c·∫•u h√¨nh GHTK. Vui l√≤ng v√†o C√†i ƒë·∫∑t ‚Üí ƒê·ªëi t√°c v·∫≠n chuy·ªÉn.'\r\n                };\r\n            }\r\n            \r\n            const response = await fetch(getApiUrl('/shipping/ghtk/cancel-order'), {\r\n                method: 'POST',\r\n                headers: {\r\n                    'Content-Type': 'application/json',\r\n                },\r\n                body: JSON.stringify({\r\n                    trackingCode,\r\n                    apiToken: credentials.apiToken,\r\n                    partnerCode: credentials.partnerCode,\r\n                }),\r\n            });\r\n            \r\n            const data = await response.json();\r\n            \r\n            // ‚úÖ Ki·ªÉm tra response t·ª´ GHTK\r\n            if (!response.ok) {\r\n                throw new Error(data.message || data.error || 'Failed to cancel GHTK shipment');\r\n            }\r\n            \r\n            // ‚úÖ GHTK tr·∫£ success: false khi kh√¥ng th·ªÉ h·ªßy (ƒë√£ l·∫•y h√†ng)\r\n            if (data.success === false) {\r\n                console.log('[GHTK] Cannot cancel:', data.message);\r\n                return { \r\n                    success: false, \r\n                    message: data.message || 'Kh√¥ng th·ªÉ h·ªßy ƒë∆°n h√†ng' \r\n                };\r\n            }\r\n            \r\n            console.log('[GHTK] Cancellation successful:', data.message);\r\n            \r\n            // ‚úÖ CH·ªà update state khi GHTK x√°c nh·∫≠n h·ªßy th√†nh c√¥ng\r\n            baseStore.setState(state => {\r\n                const order = state.data.find(o => o.systemId === orderSystemId);\r\n                if (!order) return state;\r\n                \r\n                const updatedPackagings = order.packagings.map(p => {\r\n                    if (p.systemId !== packagingSystemId) return p;\r\n                    \r\n                    return {\r\n                        ...p,\r\n                        status: 'H·ªßy ƒë√≥ng g√≥i' as PackagingStatus,\r\n                        deliveryStatus: 'ƒê√£ h·ªßy' as OrderDeliveryStatus,\r\n                        cancelDate: toISODateTime(new Date()),\r\n                        cancelReason: 'H·ªßy v·∫≠n ƒë∆°n GHTK',\r\n                        ghtkStatusId: -1,\r\n                        partnerStatus: 'H·ªßy ƒë∆°n h√†ng',\r\n                    };\r\n                });\r\n                \r\n                // ‚úÖ KH√îNG rollback stock - ƒë·ªÉ user t·ª± quy·∫øt ƒë·ªãnh (n√∫t \"H·ªßy giao v√† nh·∫≠n l·∫°i h√†ng\")\r\n                \r\n                const updatedOrder = {\r\n                    ...order,\r\n                    packagings: updatedPackagings,\r\n                };\r\n                \r\n                return {\r\n                    data: state.data.map(o => o.systemId === orderSystemId ? updatedOrder : o)\r\n                };\r\n            });\r\n            \r\n            return { \r\n                success: true, \r\n                message: data.message || 'ƒê√£ h·ªßy v·∫≠n ƒë∆°n GHTK th√†nh c√¥ng' \r\n            };\r\n            \r\n        } catch (error: any) {\r\n            console.error('[GHTK] Cancel error:', error);\r\n            return { \r\n                success: false, \r\n                message: error.message || 'L·ªói khi h·ªßy v·∫≠n ƒë∆°n GHTK' \r\n            };\r\n        }\r\n    },\r\n};\r\n\r\n// Auto-allocate historical receipts on startup\r\nuseReceiptStore.getState().data.forEach(receipt => {\r\n    autoAllocateReceiptToOrders(receipt);\r\n});\r\n\r\n// React to newly created receipts\r\nuseReceiptStore.subscribe(\r\n    state => state.data,\r\n    (currentReceipts, previousReceipts) => {\r\n        const previousIds = new Set((previousReceipts ?? []).map(r => r.systemId));\r\n        currentReceipts.forEach(receipt => {\r\n            if (!previousIds.has(receipt.systemId)) {\r\n                autoAllocateReceiptToOrders(receipt);\r\n            }\r\n        });\r\n    }\r\n);\r\n\r\n\r\n// Export typed hook with all augmented methods\r\nexport const useOrderStore = (): any => {\r\n  const state = baseStore();\r\n  return {\r\n    ...state,\r\n    ...augmentedMethods,\r\n  };\r\n};\r\n\r\n// Export getState for non-hook usage\r\nuseOrderStore.getState = (): any => {\r\n  const state = baseStore.getState();\r\n  return {\r\n    ...state,\r\n    ...augmentedMethods,\r\n  };\r\n};\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 4856, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/warranty/notification-utils.ts"],"sourcesContent":["/**\r\n * Warranty Notification Utilities\r\n * Handle notification settings and events for warranty tickets\r\n * Pattern copied from Complaints notification system\r\n * \r\n * NOTE: Settings are now synced with database via warranty-settings-sync.ts\r\n */\r\n\r\nimport { toast } from \"sonner\";\r\nimport {\r\n  getWarrantyNotificationsSync,\r\n  saveWarrantyNotificationsAsync,\r\n  type WarrantyNotificationSettings,\r\n} from '@/lib/warranty-settings-sync';\r\n\r\n// Re-export interface for backwards compatibility\r\nexport type { WarrantyNotificationSettings } from '@/lib/warranty-settings-sync';\r\n\r\n// Default notification settings\r\nconst defaultNotifications: WarrantyNotificationSettings = {\r\n  emailOnCreate: true,\r\n  emailOnAssign: true,\r\n  emailOnProcessing: false,\r\n  emailOnProcessed: true,\r\n  emailOnReturned: true,\r\n  emailOnOverdue: true,\r\n  smsOnOverdue: false,\r\n  inAppNotifications: true,\r\n  reminderNotifications: true,\r\n};\r\n\r\n/**\r\n * Load notification settings from database (sync version)\r\n * @deprecated Use getWarrantyNotificationsSync from warranty-settings-sync.ts\r\n */\r\nexport function loadWarrantyNotificationSettings(): WarrantyNotificationSettings {\r\n  return getWarrantyNotificationsSync();\r\n}\r\n\r\n/**\r\n * Save notification settings to database\r\n * @deprecated Use saveWarrantyNotificationsAsync from warranty-settings-sync.ts\r\n */\r\nexport function saveWarrantyNotificationSettings(settings: WarrantyNotificationSettings): void {\r\n  // Fire and forget - save to database in background\r\n  saveWarrantyNotificationsAsync(settings).catch(error => {\r\n    console.error('Failed to save warranty notification settings:', error);\r\n  });\r\n}\r\n\r\n/**\r\n * Show toast notification based on settings\r\n */\r\nexport function showWarrantyNotification(\r\n  type: 'success' | 'error' | 'info' | 'warning',\r\n  message: string,\r\n  options?: { id?: string | number; description?: string | undefined; duration?: number }\r\n) {\r\n  const settings = loadWarrantyNotificationSettings();\r\n  \r\n  // Always show if inAppNotifications is enabled\r\n  if (settings.inAppNotifications) {\r\n    switch (type) {\r\n      case 'success':\r\n        toast.success(message, options);\r\n        break;\r\n      case 'error':\r\n        toast.error(message, options);\r\n        break;\r\n      case 'info':\r\n        toast.info(message, options);\r\n        break;\r\n      case 'warning':\r\n        toast.warning(message, options);\r\n        break;\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * Show loading toast (always shown regardless of settings)\r\n */\r\nexport function showWarrantyLoading(message: string) {\r\n  return toast.loading(message);\r\n}\r\n\r\n/**\r\n * Check if a specific notification event is enabled\r\n */\r\nexport function isWarrantyNotificationEnabled(event: keyof WarrantyNotificationSettings): boolean {\r\n  const settings = loadWarrantyNotificationSettings();\r\n  return settings[event] || false;\r\n}\r\n\r\n/**\r\n * Wrapper functions for specific warranty events\r\n */\r\n\r\nexport function notifyWarrantyCreated(ticketId: string) {\r\n  if (isWarrantyNotificationEnabled('emailOnCreate')) {\r\n    showWarrantyNotification('success', `ƒê√£ t·∫°o phi·∫øu b·∫£o h√†nh ${ticketId}`, {\r\n      description: 'Phi·∫øu m·ªõi ƒë√£ ƒë∆∞·ª£c t·∫°o th√†nh c√¥ng',\r\n    });\r\n  }\r\n}\r\n\r\nexport function notifyWarrantyAssigned(ticketId: string, employeeName: string) {\r\n  if (isWarrantyNotificationEnabled('emailOnAssign')) {\r\n    showWarrantyNotification('info', `Phi·∫øu ${ticketId} ƒë∆∞·ª£c g√°n cho ${employeeName}`, {\r\n      description: 'ƒê√£ c·∫≠p nh·∫≠t ng∆∞·ªùi ph·ª• tr√°ch',\r\n    });\r\n  }\r\n}\r\n\r\nexport function notifyWarrantyProcessing(ticketId: string) {\r\n  if (isWarrantyNotificationEnabled('emailOnProcessing')) {\r\n    showWarrantyNotification('info', `Phi·∫øu ${ticketId} ƒëang ƒë∆∞·ª£c x·ª≠ l√Ω`, {\r\n      description: 'Nh√¢n vi√™n ƒë√£ b·∫Øt ƒë·∫ßu x·ª≠ l√Ω phi·∫øu',\r\n    });\r\n  }\r\n}\r\n\r\nexport function notifyWarrantyProcessed(ticketId: string) {\r\n  if (isWarrantyNotificationEnabled('emailOnProcessed')) {\r\n    showWarrantyNotification('success', `Phi·∫øu ${ticketId} ƒë√£ x·ª≠ l√Ω xong`, {\r\n      description: 'S·∫£n ph·∫©m s·∫µn s√†ng ƒë·ªÉ tr·∫£ kh√°ch',\r\n    });\r\n  }\r\n}\r\n\r\nexport function notifyWarrantyReturned(ticketId: string, orderId?: string) {\r\n  if (isWarrantyNotificationEnabled('emailOnReturned')) {\r\n    showWarrantyNotification('success', `Phi·∫øu ${ticketId} ƒë√£ tr·∫£ h√†ng`, {\r\n      description: orderId ? `Li√™n k·∫øt v·ªõi ƒë∆°n h√†ng ${orderId}` : 'ƒê√£ ho√†n t·∫•t quy tr√¨nh',\r\n    });\r\n  }\r\n}\r\n\r\nexport function notifyWarrantyOverdue(ticketId: string, type: 'response' | 'processing' | 'return') {\r\n  if (isWarrantyNotificationEnabled('emailOnOverdue')) {\r\n    const typeLabels = {\r\n      response: 'ph·∫£n h·ªìi',\r\n      processing: 'x·ª≠ l√Ω',\r\n      return: 'tr·∫£ h√†ng',\r\n    };\r\n    \r\n    showWarrantyNotification('warning', `Phi·∫øu ${ticketId} qu√° h·∫°n ${typeLabels[type]}`, {\r\n      description: 'Vui l√≤ng ki·ªÉm tra v√† x·ª≠ l√Ω ngay',\r\n      duration: 10000, // Show longer for overdue warnings\r\n    });\r\n  }\r\n}\r\n\r\nexport function notifyWarrantyReminder(ticketId: string, message: string) {\r\n  if (isWarrantyNotificationEnabled('reminderNotifications')) {\r\n    showWarrantyNotification('info', `Nh·∫Øc nh·ªü: ${ticketId}`, {\r\n      description: message,\r\n      duration: 8000,\r\n    });\r\n  }\r\n}\r\n\r\nexport function notifyWarrantyStatusChange(ticketId: string, oldStatus: string, newStatus: string) {\r\n  showWarrantyNotification('info', `Phi·∫øu ${ticketId} ƒë√£ chuy·ªÉn tr·∫°ng th√°i`, {\r\n    description: `${oldStatus} ‚Üí ${newStatus}`,\r\n  });\r\n}\r\n\r\n/**\r\n * Batch notification for multiple tickets\r\n */\r\nexport function notifyWarrantyBulkAction(action: string, count: number) {\r\n  showWarrantyNotification('success', `ƒê√£ ${action} ${count} phi·∫øu b·∫£o h√†nh`, {\r\n    description: 'Thao t√°c h√†ng lo·∫°t th√†nh c√¥ng',\r\n  });\r\n}\r\n\r\n/**\r\n * Error notification\r\n */\r\nexport function notifyWarrantyError(message: string, details?: string) {\r\n  showWarrantyNotification('error', message, {\r\n    description: details,\r\n    duration: 5000,\r\n  });\r\n}\r\n\r\n/**\r\n * Get notification summary for dashboard\r\n */\r\nexport function getWarrantyNotificationSummary() {\r\n  const settings = loadWarrantyNotificationSettings();\r\n  const enabledCount = Object.values(settings).filter(Boolean).length;\r\n  const totalCount = Object.keys(settings).length;\r\n  \r\n  return {\r\n    enabled: enabledCount,\r\n    total: totalCount,\r\n    percentage: Math.round((enabledCount / totalCount) * 100),\r\n  };\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 5034, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/warranty/use-realtime-updates.ts"],"sourcesContent":["/**\r\n * Realtime Updates Hook for Warranty Module\r\n * Uses in-memory versioning - localStorage has been removed\r\n */\r\n\r\nimport * as React from 'react';\r\nimport { toast } from 'sonner';\r\n\r\n// In-memory version tracking\r\nlet warrantyDataVersion = 0;\r\nconst versionListeners = new Set<() => void>();\r\n\r\ninterface UseRealtimeUpdatesOptions {\r\n  onRefresh: () => void;\r\n  dataVersion: number;\r\n  interval?: number;\r\n}\r\n\r\n/**\r\n * Hook for managing realtime updates with polling\r\n */\r\nexport function useRealtimeUpdates({\r\n  onRefresh,\r\n  dataVersion,\r\n  interval = 30000,\r\n}: UseRealtimeUpdatesOptions) {\r\n  const [hasUpdates, setHasUpdates] = React.useState(false);\r\n  const [isPolling, setIsPolling] = React.useState(false);\r\n  const [lastVersion, setLastVersion] = React.useState(dataVersion);\r\n\r\n  // Subscribe to version changes\r\n  React.useEffect(() => {\r\n    const listener = () => {\r\n      setHasUpdates(true);\r\n    };\r\n    versionListeners.add(listener);\r\n    return () => {\r\n      versionListeners.delete(listener);\r\n    };\r\n  }, []);\r\n\r\n  // Polling effect\r\n  React.useEffect(() => {\r\n    if (!isPolling) return;\r\n\r\n    const timer = setInterval(() => {\r\n      if (warrantyDataVersion > lastVersion) {\r\n        setHasUpdates(true);\r\n      }\r\n    }, interval);\r\n\r\n    return () => clearInterval(timer);\r\n  }, [isPolling, interval, lastVersion]);\r\n\r\n  // Check if data version changed\r\n  React.useEffect(() => {\r\n    if (dataVersion !== lastVersion) {\r\n      setHasUpdates(true);\r\n    }\r\n  }, [dataVersion, lastVersion]);\r\n\r\n  const checkForUpdates = (): boolean => {\r\n    return warrantyDataVersion > lastVersion;\r\n  };\r\n\r\n  const showUpdateNotification = () => {\r\n    toast.info('C√≥ c·∫≠p nh·∫≠t m·ªõi cho b·∫£o h√†nh', {\r\n      duration: 10000,\r\n      position: 'top-right',\r\n      action: {\r\n        label: 'L√†m m·ªõi',\r\n        onClick: () => {\r\n          handleRefresh();\r\n        },\r\n      },\r\n    });\r\n  };\r\n\r\n  const handleRefresh = React.useCallback(() => {\r\n    setLastVersion(warrantyDataVersion);\r\n    setHasUpdates(false);\r\n    onRefresh();\r\n    toast.success('ƒê√£ l√†m m·ªõi d·ªØ li·ªáu b·∫£o h√†nh');\r\n  }, [onRefresh]);\r\n\r\n  const togglePolling = () => {\r\n    setIsPolling(prev => !prev);\r\n    if (!isPolling) {\r\n      toast.info('ƒê√£ b·∫≠t ch·∫ø ƒë·ªô c·∫≠p nh·∫≠t t·ª± ƒë·ªông (30s)', { duration: 3000 });\r\n    } else {\r\n      toast.info('ƒê√£ t·∫Øt ch·∫ø ƒë·ªô c·∫≠p nh·∫≠t t·ª± ƒë·ªông', { duration: 3000 });\r\n    }\r\n  };\r\n\r\n  return {\r\n    hasUpdates,\r\n    isPolling,\r\n    refresh: handleRefresh,\r\n    togglePolling,\r\n  };\r\n}\r\n\r\n/**\r\n * Manual trigger for simulating data updates\r\n * Call this when data changes (e.g., after create/update/delete)\r\n */\r\nexport function triggerWarrantyDataUpdate() {\r\n  warrantyDataVersion++;\r\n  versionListeners.forEach(listener => listener());\r\n}\r\n\r\n/**\r\n * Get current data version\r\n */\r\nexport function getWarrantyDataVersion(): number {\r\n  return warrantyDataVersion;\r\n}\r\n"],"names":[],"mappings":";;;;;;;;AAAA;;;CAGC,GAED;AACA;;;AAEA,6BAA6B;AAC7B,IAAI,sBAAsB;AAC1B,MAAM,mBAAmB,IAAI;AAWtB,SAAS,mBAAmB,EACjC,SAAS,EACT,WAAW,EACX,WAAW,KAAK,EACU;IAC1B,MAAM,CAAC,YAAY,cAAc,GAAG,iNAAc,CAAC;IACnD,MAAM,CAAC,WAAW,aAAa,GAAG,iNAAc,CAAC;IACjD,MAAM,CAAC,aAAa,eAAe,GAAG,iNAAc,CAAC;IAErD,+BAA+B;IAC/B,kNAAe,CAAC;QACd,MAAM,WAAW;YACf,cAAc;QAChB;QACA,iBAAiB,GAAG,CAAC;QACrB,OAAO;YACL,iBAAiB,MAAM,CAAC;QAC1B;IACF,GAAG,EAAE;IAEL,iBAAiB;IACjB,kNAAe,CAAC;QACd,IAAI,CAAC,WAAW;QAEhB,MAAM,QAAQ,YAAY;YACxB,IAAI,sBAAsB,aAAa;gBACrC,cAAc;YAChB;QACF,GAAG;QAEH,OAAO,IAAM,cAAc;IAC7B,GAAG;QAAC;QAAW;QAAU;KAAY;IAErC,gCAAgC;IAChC,kNAAe,CAAC;QACd,IAAI,gBAAgB,aAAa;YAC/B,cAAc;QAChB;IACF,GAAG;QAAC;QAAa;KAAY;IAE7B,MAAM,kBAAkB;QACtB,OAAO,sBAAsB;IAC/B;IAEA,MAAM,yBAAyB;QAC7B,iJAAK,CAAC,IAAI,CAAC,gCAAgC;YACzC,UAAU;YACV,UAAU;YACV,QAAQ;gBACN,OAAO;gBACP,SAAS;oBACP;gBACF;YACF;QACF;IACF;IAEA,MAAM,gBAAgB,oNAAiB,CAAC;QACtC,eAAe;QACf,cAAc;QACd;QACA,iJAAK,CAAC,OAAO,CAAC;IAChB,GAAG;QAAC;KAAU;IAEd,MAAM,gBAAgB;QACpB,aAAa,CAAA,OAAQ,CAAC;QACtB,IAAI,CAAC,WAAW;YACd,iJAAK,CAAC,IAAI,CAAC,wCAAwC;gBAAE,UAAU;YAAK;QACtE,OAAO;YACL,iJAAK,CAAC,IAAI,CAAC,kCAAkC;gBAAE,UAAU;YAAK;QAChE;IACF;IAEA,OAAO;QACL;QACA;QACA,SAAS;QACT;IACF;AACF;AAMO,SAAS;IACd;IACA,iBAAiB,OAAO,CAAC,CAAA,WAAY;AACvC;AAKO,SAAS;IACd,OAAO;AACT"}},
    {"offset": {"line": 5142, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/warranty/initial-data.ts"],"sourcesContent":["import type { WarrantyTicket } from './types';\nimport { asSystemId, asBusinessId } from '../../lib/id-types';\nimport { buildSeedAuditFields } from '@/lib/seed-audit';\n\n/**\n * Initial Warranty Data\n * Empty array - data will be persisted in localStorage by createCrudStore\n * \n * Example of properly typed warranty record:\n * {\n *   systemId: asSystemId('WARRANTY00000001'),\n *   id: asBusinessId('WR001'),\n *   branchSystemId: asSystemId('BRANCH00000001'),\n *   employeeSystemId: asSystemId('NV00000001'),\n *   customerSystemId: asSystemId('CUSTOMER00000001'),\n *   linkedOrderSystemId: asSystemId('ORDER00000123'),\n *   products: [\n *     {\n *       systemId: asSystemId('WARPROD00000001'),\n *       productSystemId: asSystemId('PRODUCT00000045'),\n *       sku: asBusinessId('SKU001'),\n *       ...\n *     }\n *   ],\n *   ...\n * }\n */\nconst seedCustomer = {\n\tsystemId: asSystemId('CUST000001'),\n\tname: 'C√¥ng ty C·ªï ph·∫ßn B·∫•t ƒë·ªông s·∫£n H∆∞ng Th·ªãnh',\n\tphone: '0901112233',\n\taddress: '123 ƒê∆∞·ªùng ABC, Ph∆∞·ªùng 1, Qu·∫≠n 1, TP.HCM',\n};\n\nconst seedBranch = {\n\tsystemId: asSystemId('BRANCH000003'),\n\tname: 'Chi nh√°nh Trung t√¢m',\n};\n\nconst warrantyOwner = {\n\tsystemId: asSystemId('EMP000002'),\n\tname: 'Tr·∫ßn Th·ªã B√¨nh',\n};\n\nexport const warrantyInitialData: WarrantyTicket[] = [\n\t{\n\t\tsystemId: asSystemId('WARRANTY000001'),\n\t\tid: asBusinessId('BH000001'),\n\t\tbranchSystemId: seedBranch.systemId,\n\t\tbranchName: seedBranch.name,\n\t\temployeeSystemId: warrantyOwner.systemId,\n\t\temployeeName: warrantyOwner.name,\n\t\tcustomerSystemId: seedCustomer.systemId,\n\t\tcustomerName: seedCustomer.name,\n\t\tcustomerPhone: seedCustomer.phone,\n\t\tcustomerAddress: seedCustomer.address,\n\t\ttrackingCode: 'GHN-WAR-0001',\n\t\tpublicTrackingCode: 'wh8ut4nz9p',\n\t\tshippingFee: 45000,\n\t\treferenceUrl: 'https://docs.google.com/spreadsheets/d/war-0001',\n\t\tlinkedOrderSystemId: asSystemId('ORDER000001'),\n\t\treceivedImages: [\n\t\t\t'https://images.unsplash.com/photo-1517336714731-489689fd1ca8?auto=format&fit=crop&w=640&q=80',\n\t\t],\n\t\tproducts: [\n\t\t\t{\n\t\t\t\tsystemId: asSystemId('WARPROD000001'),\n\t\t\t\tproductSystemId: asSystemId('SP000001'),\n\t\t\t\tsku: asBusinessId('SP000001'),\n\t\t\t\tproductName: 'Laptop Dell Inspiron 15',\n\t\t\t\tquantity: 1,\n\t\t\t\tunitPrice: 15000000,\n\t\t\t\tissueDescription: 'M√°y t·ª± t·∫Øt khi s·ª≠ d·ª•ng h∆°n 30 ph√∫t',\n\t\t\t\tresolution: 'replace',\n\t\t\t\tdeductionAmount: 0,\n\t\t\t\tproductImages: [\n\t\t\t\t\t'https://images.unsplash.com/photo-1517336714731-489689fd1ca8?auto=format&fit=crop&w=400&q=80',\n\t\t\t\t],\n\t\t\t\tnotes: 'C·∫ßn sao l∆∞u d·ªØ li·ªáu tr∆∞·ªõc khi chuy·ªÉn h√£ng',\n\t\t\t},\n\t\t\t{\n\t\t\t\tsystemId: asSystemId('WARPROD000002'),\n\t\t\t\tproductSystemId: asSystemId('SP000002'),\n\t\t\t\tsku: asBusinessId('SP000002'),\n\t\t\t\tproductName: 'Chu·ªôt Logitech MX Master 3',\n\t\t\t\tquantity: 1,\n\t\t\t\tunitPrice: 2000000,\n\t\t\t\tissueDescription: 'Con lƒÉn b·ªã k·∫πt ƒë·ªãnh k·ª≥',\n\t\t\t\tresolution: 'return',\n\t\t\t\tproductImages: [\n\t\t\t\t\t'https://images.unsplash.com/photo-1481277542470-605612bd2d61?auto=format&fit=crop&w=400&q=80',\n\t\t\t\t],\n\t\t\t\tnotes: 'ƒê√£ v·ªá sinh nh∆∞ng l·ªói t√°i di·ªÖn',\n\t\t\t},\n\t\t],\n\t\tprocessedImages: [\n\t\t\t'https://images.unsplash.com/photo-1517430816045-df4b7de11d1d?auto=format&fit=crop&w=640&q=80',\n\t\t],\n\t\tstatus: 'processed',\n\t\tsettlementStatus: 'pending',\n\t\tstockDeducted: false,\n\t\tprocessingStartedAt: '2025-11-13T01:30:00Z',\n\t\tprocessedAt: '2025-11-13T09:00:00Z',\n\t\tnotes: 'ƒê·ª£i x√°c nh·∫≠n c·ªßa kh√°ch v·ªÅ ph∆∞∆°ng √°n ƒë·ªïi m·ªõi laptop.',\n\t\tsummary: {\n\t\t\ttotalProducts: 2,\n\t\t\ttotalReplaced: 1,\n\t\t\ttotalReturned: 1,\n\t\t\ttotalDeduction: 0,\n\t\t\ttotalOutOfStock: 0,\n\t\t\ttotalSettlement: 0,\n\t\t},\n\t\thistory: [\n\t\t\t{\n\t\t\t\tsystemId: asSystemId('WARHIST000001'),\n\t\t\t\taction: 'create',\n\t\t\t\tactionLabel: 'T·∫°o phi·∫øu b·∫£o h√†nh',\n\t\t\t\tperformedBy: warrantyOwner.name,\n\t\t\t\tperformedBySystemId: warrantyOwner.systemId,\n\t\t\t\tperformedAt: '2025-11-12T09:00:00Z',\n\t\t\t\tnote: 'Ti·∫øp nh·∫≠n phi·∫øu b·∫£o h√†nh t·ª´ kh√°ch H∆∞ng Th·ªãnh.',\n\t\t\t\tlinkedOrderSystemId: asSystemId('ORDER000001'),\n\t\t\t},\n\t\t\t{\n\t\t\t\tsystemId: asSystemId('WARHIST000002'),\n\t\t\t\taction: 'update_status',\n\t\t\t\tactionLabel: 'B·∫Øt ƒë·∫ßu x·ª≠ l√Ω',\n\t\t\t\tperformedBy: warrantyOwner.name,\n\t\t\t\tperformedBySystemId: warrantyOwner.systemId,\n\t\t\t\tperformedAt: '2025-11-13T01:30:00Z',\n\t\t\t\tnote: 'Chuy·ªÉn tr·∫°ng th√°i sang ƒêang x·ª≠ l√Ω v√† g·ª≠i thi·∫øt b·ªã sang ASUS.',\n\t\t\t},\n\t\t\t{\n\t\t\t\tsystemId: asSystemId('WARHIST000003'),\n\t\t\t\taction: 'update_status',\n\t\t\t\tactionLabel: 'Ho√†n t·∫•t x·ª≠ l√Ω',\n\t\t\t\tperformedBy: warrantyOwner.name,\n\t\t\t\tperformedBySystemId: warrantyOwner.systemId,\n\t\t\t\tperformedAt: '2025-11-13T09:00:00Z',\n\t\t\t\tnote: 'Laptop s·∫Ω ƒë·ªïi m√°y m·ªõi, chu·ªôt v·ªá sinh v√† tr·∫£ l·∫°i.',\n\t\t\t},\n\t\t],\n\t\tcomments: [],\n\t\tsubtasks: [],\n\t\tcreatedBy: warrantyOwner.name,\n\t\tcreatedBySystemId: warrantyOwner.systemId,\n\t\tcreatedAt: '2025-11-12T09:00:00Z',\n\t\tupdatedAt: '2025-11-13T09:00:00Z',\n\t\tupdatedBySystemId: warrantyOwner.systemId,\n\t},\n\t{\n\t\tsystemId: asSystemId('WARRANTY000002'),\n\t\tid: asBusinessId('BH000002'),\n\t\tbranchSystemId: seedBranch.systemId,\n\t\tbranchName: seedBranch.name,\n\t\temployeeSystemId: warrantyOwner.systemId,\n\t\temployeeName: warrantyOwner.name,\n\t\tcustomerSystemId: seedCustomer.systemId,\n\t\tcustomerName: seedCustomer.name,\n\t\tcustomerPhone: seedCustomer.phone,\n\t\tcustomerAddress: seedCustomer.address,\n\t\ttrackingCode: 'GHTK-WAR-0452',\n\t\tpublicTrackingCode: 'r9bth1e6md',\n\t\tshippingFee: 30000,\n\t\tlinkedOrderSystemId: asSystemId('ORDER000005'),\n\t\treceivedImages: [\n\t\t\t'https://images.unsplash.com/photo-1581291518823-11e99804a128?auto=format&fit=crop&w=640&q=80',\n\t\t],\n\t\tproducts: [\n\t\t\t{\n\t\t\t\tsystemId: asSystemId('WARPROD000003'),\n\t\t\t\tproductSystemId: asSystemId('SP000008'),\n\t\t\t\tsku: asBusinessId('SP000008'),\n\t\t\t\tproductName: 'B√†n ph√≠m c∆° Keychron K2',\n\t\t\t\tquantity: 1,\n\t\t\t\tunitPrice: 2500000,\n\t\t\t\tissueDescription: 'Ph√≠m space b·ªã k·∫πt sau 1 tu·∫ßn s·ª≠ d·ª•ng',\n\t\t\t\tresolution: 'replace',\n\t\t\t\tproductImages: [\n\t\t\t\t\t'https://images.unsplash.com/photo-1503602642458-232111445657?auto=format&fit=crop&w=400&q=80',\n\t\t\t\t],\n\t\t\t},\n\t\t\t{\n\t\t\t\tsystemId: asSystemId('WARPROD000004'),\n\t\t\t\tproductSystemId: asSystemId('SP000010'),\n\t\t\t\tsku: asBusinessId('SP000010'),\n\t\t\t\tproductName: 'Switch Gateron Yellow',\n\t\t\t\tquantity: 6,\n\t\t\t\tunitPrice: 5000,\n\t\t\t\tissueDescription: 'M·ªôt s·ªë switch kh√¥ng nh·∫≠n t√≠n hi·ªáu sau khi l·∫Øp',\n\t\t\t\tresolution: 'deduct',\n\t\t\t\tdeductionAmount: 60000,\n\t\t\t\tproductImages: [],\n\t\t\t\tnotes: 'Kh√°ch ƒë·ªÅ ngh·ªã ho√†n ti·ªÅn cho s·ªë switch l·ªói',\n\t\t\t},\n\t\t],\n\t\tstatus: 'pending',\n\t\tsettlementStatus: 'pending',\n\t\tstockDeducted: false,\n\t\tnotes: 'ƒêang ch·ªù k·ªπ thu·∫≠t ki·ªÉm tra b√†n ph√≠m.',\n\t\tsummary: {\n\t\t\ttotalProducts: 2,\n\t\t\ttotalReplaced: 0,\n\t\t\ttotalReturned: 0,\n\t\t\ttotalDeduction: 60000,\n\t\t\ttotalOutOfStock: 0,\n\t\t\ttotalSettlement: 60000,\n\t\t},\n\t\thistory: [\n\t\t\t{\n\t\t\t\tsystemId: asSystemId('WARHIST000004'),\n\t\t\t\taction: 'create',\n\t\t\t\tactionLabel: 'T·∫°o phi·∫øu b·∫£o h√†nh',\n\t\t\t\tperformedBy: warrantyOwner.name,\n\t\t\t\tperformedBySystemId: warrantyOwner.systemId,\n\t\t\t\tperformedAt: '2025-11-18T03:00:00Z',\n\t\t\t\tnote: 'Kh√°ch g·ª≠i b√†n ph√≠m Keychron c·∫ßn b·∫£o h√†nh.',\n\t\t\t\tlinkedOrderSystemId: asSystemId('ORDER000005'),\n\t\t\t},\n\t\t],\n\t\tcomments: [],\n\t\tsubtasks: [],\n\t\tcreatedBy: warrantyOwner.name,\n\t\tcreatedBySystemId: warrantyOwner.systemId,\n\t\tcreatedAt: '2025-11-18T03:00:00Z',\n\t\tupdatedAt: '2025-11-18T03:00:00Z',\n\t\tupdatedBySystemId: warrantyOwner.systemId,\n\t},\n];\n\n// Template metadata snippet used when inserting new warranty tickets via seed scripts.\nexport const WARRANTY_SEED_AUDIT_TEMPLATE = buildSeedAuditFields({ createdAt: '2024-02-01T00:00:00Z' });\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 5380, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/warranty/store/base-store.ts"],"sourcesContent":["import { getCurrentDate, toISODateTime } from '../../../lib/date-utils';\r\nimport { createCrudStore } from '../../../lib/store-factory';\r\nimport type { WarrantyTicket } from '../types';\r\nimport { warrantyInitialData } from '../initial-data';\r\nimport { getCurrentUserInfo, getCurrentUserSystemId } from '../../../contexts/auth-context';\r\nimport type { SystemId } from '../../../lib/id-types';\r\n\r\n// Utility: Get Current User Info\r\nexport function getCurrentUserName(): string {\r\n  return getCurrentUserInfo().name;\r\n}\r\n\r\n// Utility: Generate Public Tracking Code\r\nexport function generatePublicTrackingCode(): string {\r\n  const chars = 'abcdefghijklmnopqrstuvwxyz0123456789';\r\n  let result = '';\r\n  for (let i = 0; i < 10; i++) {\r\n    result += chars.charAt(Math.floor(Math.random() * chars.length));\r\n  }\r\n  return result;\r\n}\r\n\r\n// Create Base Store with createCrudStore\r\nexport const baseStore = createCrudStore<WarrantyTicket>(warrantyInitialData, 'warranty', {\r\n  businessIdField: 'id',\r\n  getCurrentUser: getCurrentUserSystemId,\r\n  apiEndpoint: '/api/warranties',\r\n});\r\n\r\n// ‚úÖ API Sync helpers\r\nconst API_ENDPOINT = '/api/warranties';\r\n\r\nconst syncToApi = {\r\n  create: async (warranty: WarrantyTicket) => {\r\n    try {\r\n      const response = await fetch(API_ENDPOINT, {\r\n        method: 'POST',\r\n        credentials: 'include',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify(warranty),\r\n      });\r\n      if (!response.ok) console.warn('[Warranty API] Create sync failed');\r\n      else console.log('[Warranty API] Created:', warranty.systemId);\r\n    } catch (e) {\r\n      console.warn('[Warranty API] Create sync error:', e);\r\n    }\r\n  },\r\n  update: async (systemId: SystemId, updates: Partial<WarrantyTicket>) => {\r\n    try {\r\n      const response = await fetch(`${API_ENDPOINT}/${systemId}`, {\r\n        method: 'PATCH',\r\n        credentials: 'include',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify(updates),\r\n      });\r\n      if (!response.ok) console.warn('[Warranty API] Update sync failed');\r\n      else console.log('[Warranty API] Updated:', systemId);\r\n    } catch (e) {\r\n      console.warn('[Warranty API] Update sync error:', e);\r\n    }\r\n  },\r\n  delete: async (systemId: SystemId, hard = false) => {\r\n    try {\r\n      const response = await fetch(`${API_ENDPOINT}/${systemId}`, {\r\n        method: 'DELETE',\r\n        credentials: 'include',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({ hard }),\r\n      });\r\n      if (!response.ok) console.warn('[Warranty API] Delete sync failed');\r\n      else console.log('[Warranty API] Deleted:', systemId);\r\n    } catch (e) {\r\n      console.warn('[Warranty API] Delete sync error:', e);\r\n    }\r\n  },\r\n  restore: async (systemId: SystemId) => {\r\n    try {\r\n      const response = await fetch(`${API_ENDPOINT}/${systemId}/restore`, {\r\n        method: 'POST',\r\n        credentials: 'include',\r\n        headers: { 'Content-Type': 'application/json' },\r\n      });\r\n      if (!response.ok) console.warn('[Warranty API] Restore sync failed');\r\n      else console.log('[Warranty API] Restored:', systemId);\r\n    } catch (e) {\r\n      console.warn('[Warranty API] Restore sync error:', e);\r\n    }\r\n  },\r\n};\r\n\r\n// Export original CRUD methods for overriding (before wrapping)\r\nexport const originalAdd = baseStore.getState().add;\r\nexport const originalUpdate = baseStore.getState().update;\r\nexport const originalRemove = baseStore.getState().remove;\r\n\r\n// ‚úÖ Wrap base store methods with API sync (for direct usage)\r\nconst originalHardDelete = baseStore.getState().hardDelete;\r\nconst originalRestore = baseStore.getState().restore;\r\n\r\nbaseStore.setState({\r\n  hardDelete: (systemId: SystemId) => {\r\n    originalHardDelete(systemId);\r\n    syncToApi.delete(systemId, true);\r\n  },\r\n  restore: (systemId: SystemId) => {\r\n    originalRestore(systemId);\r\n    syncToApi.restore(systemId);\r\n  },\r\n});\r\n\r\n// Export sync helpers for use in index.ts (where add/update are overridden)\r\nexport { syncToApi };\r\n"],"names":[],"mappings":";;;;;;;;;;;;;;;;AACA;AAEA;AACA;;;;AAIO,SAAS;IACd,OAAO,IAAA,kJAAkB,IAAG,IAAI;AAClC;AAGO,SAAS;IACd,MAAM,QAAQ;IACd,IAAI,SAAS;IACb,IAAK,IAAI,IAAI,GAAG,IAAI,IAAI,IAAK;QAC3B,UAAU,MAAM,MAAM,CAAC,KAAK,KAAK,CAAC,KAAK,MAAM,KAAK,MAAM,MAAM;IAChE;IACA,OAAO;AACT;AAGO,MAAM,YAAY,IAAA,0IAAe,EAAiB,8JAAmB,EAAE,YAAY;IACxF,iBAAiB;IACjB,gBAAgB,sJAAsB;IACtC,aAAa;AACf;AAEA,qBAAqB;AACrB,MAAM,eAAe;AAErB,MAAM,YAAY;IAChB,QAAQ,OAAO;QACb,IAAI;YACF,MAAM,WAAW,MAAM,MAAM,cAAc;gBACzC,QAAQ;gBACR,aAAa;gBACb,SAAS;oBAAE,gBAAgB;gBAAmB;gBAC9C,MAAM,KAAK,SAAS,CAAC;YACvB;YACA,IAAI,CAAC,SAAS,EAAE,EAAE,QAAQ,IAAI,CAAC;iBAC1B,QAAQ,GAAG,CAAC,2BAA2B,SAAS,QAAQ;QAC/D,EAAE,OAAO,GAAG;YACV,QAAQ,IAAI,CAAC,qCAAqC;QACpD;IACF;IACA,QAAQ,OAAO,UAAoB;QACjC,IAAI;YACF,MAAM,WAAW,MAAM,MAAM,GAAG,aAAa,CAAC,EAAE,UAAU,EAAE;gBAC1D,QAAQ;gBACR,aAAa;gBACb,SAAS;oBAAE,gBAAgB;gBAAmB;gBAC9C,MAAM,KAAK,SAAS,CAAC;YACvB;YACA,IAAI,CAAC,SAAS,EAAE,EAAE,QAAQ,IAAI,CAAC;iBAC1B,QAAQ,GAAG,CAAC,2BAA2B;QAC9C,EAAE,OAAO,GAAG;YACV,QAAQ,IAAI,CAAC,qCAAqC;QACpD;IACF;IACA,QAAQ,OAAO,UAAoB,OAAO,KAAK;QAC7C,IAAI;YACF,MAAM,WAAW,MAAM,MAAM,GAAG,aAAa,CAAC,EAAE,UAAU,EAAE;gBAC1D,QAAQ;gBACR,aAAa;gBACb,SAAS;oBAAE,gBAAgB;gBAAmB;gBAC9C,MAAM,KAAK,SAAS,CAAC;oBAAE;gBAAK;YAC9B;YACA,IAAI,CAAC,SAAS,EAAE,EAAE,QAAQ,IAAI,CAAC;iBAC1B,QAAQ,GAAG,CAAC,2BAA2B;QAC9C,EAAE,OAAO,GAAG;YACV,QAAQ,IAAI,CAAC,qCAAqC;QACpD;IACF;IACA,SAAS,OAAO;QACd,IAAI;YACF,MAAM,WAAW,MAAM,MAAM,GAAG,aAAa,CAAC,EAAE,SAAS,QAAQ,CAAC,EAAE;gBAClE,QAAQ;gBACR,aAAa;gBACb,SAAS;oBAAE,gBAAgB;gBAAmB;YAChD;YACA,IAAI,CAAC,SAAS,EAAE,EAAE,QAAQ,IAAI,CAAC;iBAC1B,QAAQ,GAAG,CAAC,4BAA4B;QAC/C,EAAE,OAAO,GAAG;YACV,QAAQ,IAAI,CAAC,sCAAsC;QACrD;IACF;AACF;AAGO,MAAM,cAAc,UAAU,QAAQ,GAAG,GAAG;AAC5C,MAAM,iBAAiB,UAAU,QAAQ,GAAG,MAAM;AAClD,MAAM,iBAAiB,UAAU,QAAQ,GAAG,MAAM;AAEzD,6DAA6D;AAC7D,MAAM,qBAAqB,UAAU,QAAQ,GAAG,UAAU;AAC1D,MAAM,kBAAkB,UAAU,QAAQ,GAAG,OAAO;AAEpD,UAAU,QAAQ,CAAC;IACjB,YAAY,CAAC;QACX,mBAAmB;QACnB,UAAU,MAAM,CAAC,UAAU;IAC7B;IACA,SAAS,CAAC;QACR,gBAAgB;QAChB,UAAU,OAAO,CAAC;IACpB;AACF"}},
    {"offset": {"line": 5508, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/warranty/store/stock-management.ts"],"sourcesContent":["import { getCurrentDate, toISODateTime } from '../../../lib/date-utils';\r\nimport { useProductStore } from '../../products/store';\r\nimport { useStockHistoryStore } from '../../stock-history/store';\r\nimport { toast } from 'sonner';\r\nimport type { WarrantyTicket } from '../types';\r\nimport { getCurrentUserName } from './base-store';\r\n\r\n/**\r\n * Commit stock khi t·∫°o warranty (reserve h√†ng cho ƒë·ªïi m·ªõi)\r\n * Reuse productStore.commitStock()\r\n */\r\nexport function commitWarrantyStock(ticket: WarrantyTicket) {\r\n  const replaceProducts = ticket.products.filter(p => p.resolution === 'replace');\r\n  \r\n  if (replaceProducts.length > 0) {\r\n    const productStore = useProductStore.getState();\r\n    const productCache = new Map<string, any>();\r\n    productStore.data.forEach(p => productCache.set(p.id, p));\r\n    \r\n    replaceProducts.forEach(warrantyProduct => {\r\n      if (!warrantyProduct.sku) {\r\n        console.warn('S·∫£n ph·∫©m thi·∫øu SKU, b·ªè qua commit:', warrantyProduct.productName);\r\n        return;\r\n      }\r\n      \r\n      const product = productCache.get(warrantyProduct.sku);\r\n      \r\n      if (!product) {\r\n        console.warn('Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m trong kho:', warrantyProduct.sku);\r\n        return;\r\n      }\r\n      \r\n      const quantityToCommit = warrantyProduct.quantity || 1;\r\n      \r\n      // Reuse productStore.commitStock()\r\n      productStore.commitStock(product.systemId as any, ticket.branchSystemId as any, quantityToCommit);\r\n      \r\n      console.log('‚úÖ [COMMIT STOCK] Gi·ªØ h√†ng thay th·∫ø:', {\r\n        productId: product.id,\r\n        productName: product.name,\r\n        quantity: quantityToCommit,\r\n        warranty: ticket.id,\r\n        branch: ticket.branchName\r\n      });\r\n    });\r\n  }\r\n}\r\n\r\n/**\r\n * Uncommit stock khi x√≥a warranty (gi·∫£i ph√≥ng h√†ng gi·ªØ ch·ªó)\r\n * Reuse productStore.uncommitStock()\r\n */\r\nexport function uncommitWarrantyStock(ticket: WarrantyTicket, options?: { silent?: boolean }) {\r\n  const replaceProducts = ticket.products.filter(p => p.resolution === 'replace');\r\n  \r\n  if (replaceProducts.length > 0) {\r\n    const productStore = useProductStore.getState();\r\n    const productCache = new Map<string, any>();\r\n    productStore.data.forEach(p => productCache.set(p.id, p));\r\n    \r\n    replaceProducts.forEach(warrantyProduct => {\r\n      if (!warrantyProduct.sku) return;\r\n      \r\n      const product = productCache.get(warrantyProduct.sku);\r\n      \r\n      if (product) {\r\n      const quantityToUncommit = warrantyProduct.quantity || 1;\r\n      \r\n      // Reuse productStore.uncommitStock()\r\n      productStore.uncommitStock(product.systemId as any, ticket.branchSystemId as any, quantityToUncommit);        console.log('ƒê√£ uncommit stock:', {\r\n          productId: product.id,\r\n          quantity: quantityToUncommit,\r\n          warranty: ticket.id\r\n        });\r\n      }\r\n    });\r\n    \r\n    if (!options?.silent) {\r\n      toast.info('ƒê√£ gi·∫£i ph√≥ng h√†ng gi·ªØ ch·ªó', {\r\n        description: `${replaceProducts.length} s·∫£n ph·∫©m ƒë√£ ƒë∆∞·ª£c tr·∫£ l·∫°i kho c√≥ th·ªÉ b√°n`,\r\n        duration: 3000\r\n      });\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * Xu·∫•t kho khi 'completed' - D√πng dispatchStock gi·ªëng ƒë∆°n h√†ng\r\n * NEW LOGIC: B∆∞·ªõc 4 - K·∫øt th√∫c\r\n */\r\nexport function deductWarrantyStock(ticket: WarrantyTicket) {\r\n  console.log('üì§ [DEDUCT FUNCTION CALLED]:', {\r\n    ticketId: ticket.id,\r\n    ticketStatus: ticket.status,\r\n    stockDeducted: ticket.stockDeducted,\r\n    productsCount: ticket.products.length,\r\n    replaceProducts: ticket.products.filter(p => p.resolution === 'replace').length\r\n  });\r\n  \r\n  const replacedProducts = ticket.products.filter(p => p.resolution === 'replace');\r\n  \r\n  if (replacedProducts.length > 0) {\r\n    const productStore = useProductStore.getState();\r\n    const stockHistoryStore = useStockHistoryStore.getState();\r\n    const productCache = new Map<string, any>();\r\n    productStore.data.forEach(p => productCache.set(p.id, p));\r\n    \r\n    const deductionResults: string[] = [];\r\n    let hasErrors = false;\r\n    \r\n    replacedProducts.forEach(warrantyProduct => {\r\n      if (!warrantyProduct.sku) {\r\n        deductionResults.push(`S·∫£n ph·∫©m \"${warrantyProduct.productName}\" kh√¥ng c√≥ SKU`);\r\n        hasErrors = true;\r\n        return;\r\n      }\r\n      \r\n      const product = productCache.get(warrantyProduct.sku);\r\n      \r\n      if (!product) {\r\n        deductionResults.push(`Kh√¥ng t√¨m th·∫•y SP SKU: ${warrantyProduct.sku}`);\r\n        hasErrors = true;\r\n        return;\r\n      }\r\n      \r\n      const currentInventory = product.inventoryByBranch[ticket.branchSystemId] || 0;\r\n      const quantityToDeduct = warrantyProduct.quantity || 1;\r\n      \r\n      console.log('üì§ [DEDUCT] Before:', {\r\n        productId: product.id,\r\n        currentInventory,\r\n        quantityToDeduct,\r\n        branchSystemId: ticket.branchSystemId\r\n      });\r\n      \r\n      if (currentInventory < quantityToDeduct) {\r\n        deductionResults.push(`${product.name} (${product.id}): Kh√¥ng ƒë·ªß h√†ng (T·ªìn: ${currentInventory}, C·∫ßn: ${quantityToDeduct})`);\r\n        hasErrors = true;\r\n        return;\r\n      }\r\n      \r\n      // ‚úÖ Xu·∫•t kho tr·ª±c ti·∫øp (kh√¥ng d√πng dispatchStock v√¨ warranty kh√¥ng c√≥ inTransit)\r\n      // -T·ªìn kho\r\n      productStore.updateInventory(product.systemId as any, ticket.branchSystemId as any, -quantityToDeduct);\r\n      // -ƒêang giao d·ªãch (uncommit)\r\n      productStore.uncommitStock(product.systemId as any, ticket.branchSystemId as any, quantityToDeduct);\r\n      \r\n      // ‚úÖ L·∫•y l·∫°i product sau khi update\r\n      const freshProductStore = useProductStore.getState();\r\n      const updatedProduct = freshProductStore.data.find(p => p.systemId === product.systemId);\r\n      const newStockLevel = updatedProduct?.inventoryByBranch[ticket.branchSystemId] || currentInventory - quantityToDeduct;\r\n      \r\n      console.log('‚úÖ [DEDUCT] After:', {\r\n        productId: product.id,\r\n        newStockLevel,\r\n        expectedLevel: currentInventory - quantityToDeduct\r\n      });\r\n      \r\n      stockHistoryStore.addEntry({\r\n        productId: product.systemId,\r\n        date: toISODateTime(getCurrentDate()),\r\n        employeeName: getCurrentUserName(),\r\n        action: 'Xu·∫•t b·∫£o h√†nh (ƒë·ªïi m·ªõi)',\r\n        quantityChange: -quantityToDeduct,\r\n        newStockLevel,\r\n        documentId: ticket.id, // Business ID for display (BH000001)\r\n        branchSystemId: ticket.branchSystemId,\r\n        branch: ticket.branchName,\r\n      });\r\n      \r\n      deductionResults.push(`${product.name} (${product.id}): Tr·ª´ ${quantityToDeduct} c√°i (C√≤n: ${newStockLevel})`);\r\n    });\r\n    \r\n    if (hasErrors) {\r\n      toast.error('C√≥ l·ªói khi xu·∫•t kho', {\r\n        description: deductionResults.join('\\n'),\r\n        duration: 6000,\r\n      });\r\n    } else {\r\n      toast.success('ƒê√£ xu·∫•t kho s·∫£n ph·∫©m thay th·∫ø', {\r\n        description: `Xu·∫•t ${replacedProducts.length} s·∫£n ph·∫©m t·∫°i chi nh√°nh ${ticket.branchName}`,\r\n        duration: 4000,\r\n      });\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * Ho√†n kho khi h·ªßy warranty - Ng∆∞·ª£c l·∫°i v·ªõi dispatchStock\r\n * NEW LOGIC: +T·ªìn kho + +ƒêang giao d·ªãch\r\n */\r\nexport function rollbackWarrantyStock(ticket: WarrantyTicket) {\r\n  console.log('üîÑ [ROLLBACK FUNCTION CALLED]:', {\r\n    ticketId: ticket.id,\r\n    ticketStatus: ticket.status,\r\n    stockDeducted: ticket.stockDeducted,\r\n    productsCount: ticket.products.length,\r\n    replaceProducts: ticket.products.filter(p => p.resolution === 'replace').length\r\n  });\r\n  \r\n  const replacedProducts = ticket.products.filter(p => p.resolution === 'replace');\r\n  \r\n  if (replacedProducts.length > 0) {\r\n    const productStore = useProductStore.getState();\r\n    const stockHistoryStore = useStockHistoryStore.getState();\r\n    const productCache = new Map<string, any>();\r\n    productStore.data.forEach(p => productCache.set(p.id, p));\r\n    \r\n    const rollbackResults: string[] = [];\r\n    \r\n    replacedProducts.forEach(warrantyProduct => {\r\n      if (!warrantyProduct.sku) {\r\n        rollbackResults.push(`S·∫£n ph·∫©m \"${warrantyProduct.productName}\" kh√¥ng c√≥ SKU`);\r\n        return;\r\n      }\r\n      \r\n      const product = productCache.get(warrantyProduct.sku);\r\n      \r\n      if (!product) {\r\n        rollbackResults.push(`Kh√¥ng t√¨m th·∫•y SP SKU: ${warrantyProduct.sku}`);\r\n        return;\r\n      }\r\n      \r\n      const quantityToRollback = warrantyProduct.quantity || 1;\r\n      const currentInventory = product.inventoryByBranch[ticket.branchSystemId] || 0;\r\n      \r\n      console.log('üîÑ [ROLLBACK] Before:', {\r\n        productId: product.id,\r\n        currentInventory,\r\n        quantityToRollback,\r\n        branchSystemId: ticket.branchSystemId\r\n      });\r\n      \r\n      // ‚úÖ Ho√†n kho: +T·ªìn kho (warranty xu·∫•t tr·ª±c ti·∫øp, kh√¥ng qua inTransit)\r\n      productStore.updateInventory(product.systemId as any, ticket.branchSystemId as any, quantityToRollback);\r\n      \r\n      // ‚úÖ L·∫•y l·∫°i product sau khi update ƒë·ªÉ c√≥ inventory m·ªõi\r\n      const freshProductStore = useProductStore.getState();\r\n      const updatedProduct = freshProductStore.data.find(p => p.systemId === product.systemId);\r\n      const newStockLevel = updatedProduct?.inventoryByBranch[ticket.branchSystemId] || currentInventory + quantityToRollback;\r\n      \r\n      console.log('‚úÖ [ROLLBACK] After:', {\r\n        productId: product.id,\r\n        newStockLevel,\r\n        expectedLevel: currentInventory + quantityToRollback\r\n      });\r\n      \r\n      // Note: Kh√¥ng c·∫ßn uncommit v√¨ khi deduct ƒë√£ uncommit r·ªìi\r\n      \r\n      stockHistoryStore.addEntry({\r\n        productId: product.systemId,\r\n        date: toISODateTime(getCurrentDate()),\r\n        employeeName: getCurrentUserName(),\r\n        action: 'Ho√†n kho (H·ªßy b·∫£o h√†nh)',\r\n        quantityChange: quantityToRollback,\r\n        newStockLevel,\r\n        documentId: ticket.id,\r\n        branchSystemId: ticket.branchSystemId,\r\n        branch: ticket.branchName,\r\n      });\r\n      \r\n      rollbackResults.push(`${product.name} (${product.id}): Ho√†n ${quantityToRollback} c√°i`);\r\n    });\r\n    \r\n    toast.info('ƒê√£ ho√†n kho s·∫£n ph·∫©m thay th·∫ø', {\r\n      description: rollbackResults.join('\\n'),\r\n      duration: 4000,\r\n    });\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 5734, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/warranty/store/product-management.ts"],"sourcesContent":["import { getCurrentDate, toISODateTime } from '../../../lib/date-utils';\r\nimport { asSystemId } from '../../../lib/id-types';\r\nimport type { SystemId } from '../../../lib/id-types';\r\nimport type { WarrantyProduct, WarrantyHistory, WarrantyTicket } from '../types';\r\nimport { baseStore, originalUpdate, getCurrentUserName } from './base-store';\r\nimport { commitWarrantyStock, uncommitWarrantyStock } from './stock-management';\r\n\r\n/**\r\n * T√≠nh summary t·ª´ danh s√°ch s·∫£n ph·∫©m\r\n */\r\nexport function calculateSummary(products: WarrantyProduct[]) {\r\n  const outOfStockProducts = products.filter(p => p.resolution === 'out_of_stock' || p.resolution === 'deduct');\r\n  \r\n  const totalSettlement = outOfStockProducts.reduce((sum, p) => {\r\n    if (p.resolution === 'deduct') return sum + (p.deductionAmount || 0);\r\n    if (p.resolution === 'out_of_stock') return sum + ((p.quantity || 1) * (p.unitPrice || 0));\r\n    return sum;\r\n  }, 0);\r\n  \r\n  return {\r\n    totalProducts: products.reduce((sum, p) => sum + (p.quantity || 1), 0),\r\n    totalReplaced: products.filter(p => p.resolution === 'replace').reduce((sum, p) => sum + (p.quantity || 1), 0),\r\n    totalReturned: products.filter(p => p.resolution === 'return').reduce((sum, p) => sum + (p.quantity || 1), 0),\r\n    totalDeduction: totalSettlement,\r\n    totalOutOfStock: outOfStockProducts.reduce((sum, p) => sum + (p.quantity || 1), 0),\r\n    totalSettlement: totalSettlement,\r\n  };\r\n}\r\n\r\nfunction adjustReplacementStock(\r\n  ticket: WarrantyTicket,\r\n  previousProduct?: WarrantyProduct,\r\n  nextProduct?: WarrantyProduct\r\n) {\r\n  if (!ticket) return;\r\n\r\n  const previousQty = previousProduct?.resolution === 'replace' ? (previousProduct.quantity || 1) : 0;\r\n  const nextQty = nextProduct?.resolution === 'replace' ? (nextProduct.quantity || 1) : 0;\r\n\r\n  if (previousQty === nextQty) {\r\n    return;\r\n  }\r\n\r\n  const diff = Math.abs(nextQty - previousQty);\r\n  const referenceProduct = nextQty > previousQty ? nextProduct : previousProduct;\r\n  if (!referenceProduct || diff <= 0) return;\r\n\r\n  const tempProduct: WarrantyProduct = {\r\n    ...referenceProduct,\r\n    quantity: diff,\r\n  };\r\n\r\n  const tempTicket = {\r\n    ...ticket,\r\n    products: [tempProduct],\r\n  } as WarrantyTicket;\r\n\r\n  if (nextQty > previousQty) {\r\n    commitWarrantyStock(tempTicket);\r\n  } else {\r\n    uncommitWarrantyStock(tempTicket, { silent: true });\r\n  }\r\n}\r\n\r\n/**\r\n * Th√™m s·∫£n ph·∫©m v√†o phi·∫øu b·∫£o h√†nh\r\n */\r\nexport function addProduct(ticketSystemId: SystemId, product: Omit<WarrantyProduct, 'systemId'>) {\r\n  const ticket = baseStore.getState().data.find(t => t.systemId === ticketSystemId);\r\n  if (!ticket) return;\r\n  \r\n  const newProduct: WarrantyProduct = {\r\n    ...product,\r\n    systemId: asSystemId(`WP_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`),\r\n  };\r\n\r\n  adjustReplacementStock(ticket, undefined, newProduct);\r\n  \r\n  const updatedProducts = [...ticket.products, newProduct];\r\n  const summary = calculateSummary(updatedProducts);\r\n  \r\n  originalUpdate(ticketSystemId, {\r\n    ...ticket,\r\n    products: updatedProducts,\r\n    summary,\r\n    updatedAt: toISODateTime(getCurrentDate()),\r\n  } as any);\r\n  \r\n  // Add history\r\n  const resolutionLabels: Record<string, string> = {\r\n    replace: 'Thay th·∫ø',\r\n    refund: 'Ho√†n ti·ªÅn',\r\n    deduct: 'Tr·ª´ ti·ªÅn',\r\n    warranty_extension: 'Gia h·∫°n BH',\r\n    no_warranty: 'Kh√¥ng BH',\r\n    out_of_stock: 'H·∫øt h√†ng',\r\n    return: 'Tr·∫£ h√†ng'\r\n  };\r\n  const resolution = resolutionLabels[newProduct.resolution] || newProduct.resolution;\r\n  const quantity = newProduct.quantity || 1;\r\n  \r\n  addHistory(ticketSystemId, `Th√™m SP: ${newProduct.productName} (${resolution}, SL: ${quantity})`, getCurrentUserName());\r\n}\r\n\r\n/**\r\n * C·∫≠p nh·∫≠t s·∫£n ph·∫©m trong phi·∫øu\r\n */\r\nexport function updateProduct(ticketSystemId: SystemId, productSystemId: SystemId, updates: Partial<WarrantyProduct>) {\r\n  const ticket = baseStore.getState().data.find(t => t.systemId === ticketSystemId);\r\n  if (!ticket) return;\r\n  const originalProduct = ticket.products.find(p => p.systemId === productSystemId);\r\n  if (!originalProduct) return;\r\n  \r\n  const updatedProducts = ticket.products.map(p =>\r\n    p.systemId === productSystemId ? { ...p, ...updates } : p\r\n  );\r\n  \r\n  const summary = calculateSummary(updatedProducts);\r\n  const updatedProduct = updatedProducts.find(p => p.systemId === productSystemId);\r\n  adjustReplacementStock(ticket, originalProduct, updatedProduct);\r\n  \r\n  originalUpdate(ticketSystemId, {\r\n    ...ticket,\r\n    products: updatedProducts,\r\n    summary,\r\n    updatedAt: toISODateTime(getCurrentDate()),\r\n  } as any);\r\n  \r\n  // Add history\r\n  if (updatedProduct) {\r\n    addHistory(ticketSystemId, `C·∫≠p nh·∫≠t SP: ${updatedProduct.productName}`, getCurrentUserName());\r\n  }\r\n}\r\n\r\n/**\r\n * X√≥a s·∫£n ph·∫©m kh·ªèi phi·∫øu\r\n */\r\nexport function removeProduct(ticketSystemId: SystemId, productSystemId: SystemId) {\r\n  const ticket = baseStore.getState().data.find(t => t.systemId === ticketSystemId);\r\n  if (!ticket) return;\r\n  \r\n  const productToRemove = ticket.products.find(p => p.systemId === productSystemId);\r\n  const updatedProducts = ticket.products.filter(p => p.systemId !== productSystemId);\r\n  \r\n  const summary = calculateSummary(updatedProducts);\r\n\r\n  if (productToRemove) {\r\n    adjustReplacementStock(ticket, productToRemove, undefined);\r\n  }\r\n  \r\n  originalUpdate(ticketSystemId, {\r\n    ...ticket,\r\n    products: updatedProducts,\r\n    summary,\r\n    updatedAt: toISODateTime(getCurrentDate()),\r\n  } as any);\r\n  \r\n  if (productToRemove) {\r\n    addHistory(ticketSystemId, `X√≥a SP: ${productToRemove.productName}`, getCurrentUserName());\r\n  }\r\n}\r\n\r\n/**\r\n * T√≠nh to√°n l·∫°i summary\r\n */\r\nexport function recalculateSummary(ticketSystemId: SystemId) {\r\n  const ticket = baseStore.getState().data.find(t => t.systemId === ticketSystemId);\r\n  if (!ticket) return;\r\n  \r\n  const summary = calculateSummary(ticket.products);\r\n  \r\n  originalUpdate(ticketSystemId, {\r\n    ...ticket,\r\n    summary,\r\n  } as any);\r\n}\r\n\r\n/**\r\n * Helper: T√≠nh tr·∫°ng th√°i thanh to√°n\r\n */\r\nexport function calculateSettlementStatus(\r\n  totalSettlement: number, \r\n  totalPaid: number, \r\n  shippingFee: number = 0\r\n): 'pending' | 'partial' | 'completed' {\r\n  if (totalSettlement <= 0) return 'completed';\r\n  \r\n  const netAmount = totalSettlement - shippingFee;\r\n  if (netAmount <= 0) return 'completed';\r\n  \r\n  if (totalPaid === 0) return 'pending';\r\n  if (totalPaid >= netAmount) return 'completed';\r\n  return 'partial';\r\n}\r\n\r\n/**\r\n * Th√™m l·ªãch s·ª≠ (internal use only)\r\n */\r\nexport function addHistory(\r\n  ticketSystemId: SystemId, \r\n  action: string, \r\n  performedBy: string, \r\n  note?: string,\r\n  metadata?: Record<string, any>\r\n) {\r\n  const ticket = baseStore.getState().data.find(t => t.systemId === ticketSystemId);\r\n  if (!ticket) return;\r\n  \r\n  const historyEntry: WarrantyHistory = {\r\n    systemId: asSystemId(`WH_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`),\r\n    action,\r\n    actionLabel: action,\r\n    performedBy,\r\n    performedAt: toISODateTime(getCurrentDate()),\r\n    note,\r\n    metadata,\r\n  };\r\n  \r\n  originalUpdate(ticketSystemId, {\r\n    ...ticket,\r\n    history: [...(ticket.history || []), historyEntry],\r\n  } as any);\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 5918, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/warranty/store/status-management.ts"],"sourcesContent":["import { getCurrentDate, toISODateTime } from '../../../lib/date-utils';\r\nimport type { SystemId } from '../../../lib/id-types';\r\nimport type { WarrantyTicket, WarrantyStatus } from '../types';\r\nimport { baseStore, originalUpdate, getCurrentUserName } from './base-store';\r\nimport { addHistory } from './product-management';\r\nimport { deductWarrantyStock, rollbackWarrantyStock } from './stock-management';\r\nimport {\r\n  notifyWarrantyProcessing,\r\n  notifyWarrantyProcessed,\r\n  notifyWarrantyReturned,\r\n} from '../notification-utils';\r\nimport { triggerWarrantyDataUpdate } from '../use-realtime-updates';\r\n\r\ntype TimestampKey = 'processingStartedAt' | 'processedAt' | 'returnedAt' | 'completedAt';\r\n\r\nconst STATUS_ORDER: Record<WarrantyStatus, number> = {\r\n  incomplete: 0,\r\n  pending: 1,\r\n  processed: 2,\r\n  returned: 3,\r\n  completed: 4,\r\n  cancelled: 5,\r\n};\r\n\r\nconst TIMESTAMP_STAGES: Array<{ key: TimestampKey; stageOrder: number }> = [\r\n  { key: 'processingStartedAt', stageOrder: STATUS_ORDER.pending },\r\n  { key: 'processedAt', stageOrder: STATUS_ORDER.processed },\r\n  { key: 'returnedAt', stageOrder: STATUS_ORDER.returned },\r\n  { key: 'completedAt', stageOrder: STATUS_ORDER.completed },\r\n];\r\n\r\nfunction computeTimestampUpdates(\r\n  ticket: WarrantyTicket,\r\n  newStatus: WarrantyStatus,\r\n  nowIso: string\r\n): Partial<Pick<WarrantyTicket, TimestampKey>> {\r\n  const updates: Partial<Pick<WarrantyTicket, TimestampKey>> = {};\r\n  const oldOrder = STATUS_ORDER[ticket.status] ?? 0;\r\n  const newOrder = STATUS_ORDER[newStatus] ?? oldOrder;\r\n\r\n  TIMESTAMP_STAGES.forEach(({ key, stageOrder }) => {\r\n    const currentValue = ticket[key];\r\n    const crossedForward = newOrder >= stageOrder && oldOrder < stageOrder;\r\n\r\n    if (newStatus !== 'cancelled' && crossedForward && !currentValue) {\r\n      updates[key] = nowIso;\r\n      return;\r\n    }\r\n\r\n    const movedBackward = newOrder < stageOrder;\r\n    if (movedBackward && currentValue) {\r\n      updates[key] = undefined;\r\n    }\r\n  });\r\n\r\n  return updates;\r\n}\r\n\r\n/**\r\n * C·∫≠p nh·∫≠t tr·∫°ng th√°i phi·∫øu b·∫£o h√†nh\r\n * NEW LOGIC theo y√™u c·∫ßu:\r\n * - pending: +ƒêang giao d·ªãch (commitWarrantyStock)\r\n * - processed: Kh√¥ng ƒë·ªông kho\r\n * - returned: Kh√¥ng ƒë·ªông kho\r\n * - completed: -ƒêang giao d·ªãch + -T·ªìn kho (deductWarrantyStock)\r\n */\r\nexport function updateStatus(ticketSystemId: SystemId, newStatus: WarrantyTicket['status'], note?: string) {\r\n  const ticket = baseStore.getState().data.find(t => t.systemId === ticketSystemId);\r\n  if (!ticket) return;\r\n  \r\n  console.log('[STATUS CHANGE]', {\r\n    ticketId: ticket.id,\r\n    oldStatus: ticket.status,\r\n    newStatus: newStatus,\r\n    productsCount: ticket.products.length,\r\n    replacedProducts: ticket.products.filter(p => p.resolution === 'replace').length\r\n  });\r\n  \r\n  const nowIso = toISODateTime(getCurrentDate());\r\n  const timestampUpdates = computeTimestampUpdates(ticket, newStatus, nowIso);\r\n  const baseUpdate: WarrantyTicket = {\r\n    ...ticket,\r\n    ...timestampUpdates,\r\n    status: newStatus,\r\n    updatedAt: nowIso,\r\n  };\r\n\r\n  // XU·∫§T KHO khi completed (CH·ªà 1 L·∫¶N DUY NH·∫§T - kh√¥ng tr·ª´ l·∫°i khi reopen)\r\n  if (newStatus === 'completed' && ticket.status !== 'completed' && !ticket.stockDeducted) {\r\n    console.log('[COMPLETED - DEDUCT] Xu·∫•t kho (L·∫¶N ƒê·∫¶U TI√äN):', {\r\n      ticketId: ticket.id,\r\n      oldStatus: ticket.status,\r\n      newStatus: newStatus,\r\n      stockDeducted: ticket.stockDeducted,\r\n      action: '-ƒêang giao d·ªãch + -T·ªìn kho'\r\n    });\r\n    deductWarrantyStock(ticket);\r\n    \r\n    // Set flag ƒë·ªÉ kh√¥ng tr·ª´ l·∫°i l·∫ßn n·ªØa\r\n    originalUpdate(ticketSystemId, {\r\n      ...baseUpdate,\r\n      stockDeducted: true,\r\n    } as any);\r\n  } else if (newStatus === 'completed' && ticket.stockDeducted) {\r\n    console.log('[COMPLETED - SKIP DEDUCT] ƒê√£ tr·ª´ kho r·ªìi, b·ªè qua:', {\r\n      ticketId: ticket.id,\r\n      oldStatus: ticket.status,\r\n      newStatus: newStatus,\r\n      stockDeducted: ticket.stockDeducted\r\n    });\r\n    \r\n    // Ch·ªâ update status, KH√îNG tr·ª´ kho n·ªØa\r\n    originalUpdate(ticketSystemId, baseUpdate as any);\r\n  } else {\r\n    // Normal status update (kh√¥ng ph·∫£i completed)\r\n    originalUpdate(ticketSystemId, baseUpdate as any);\r\n  }\r\n  \r\n  // KH√îNG ROLLBACK KHO khi m·ªü l·∫°i t·ª´ completed\r\n  // L√Ω do:\r\n  // - K·∫øt th√∫c = ƒê∆°n ƒë√£ xong, h√†ng ƒë√£ xu·∫•t, ti·ªÅn ƒë√£ thanh to√°n ƒë·∫ßy ƒë·ªß\r\n  // - M·ªü l·∫°i (completed ‚Üí returned) CH·ªà ƒë·ªÉ xem l·∫°i, KH√îNG ƒë∆∞·ª£c s·ª≠a/thay ƒë·ªïi g√¨\r\n  // - N·∫øu c·∫ßn ƒëi·ªÅu ch·ªânh ‚Üí Ph·∫£i t·∫°o phi·∫øu m·ªõi, ho√†n h√†ng th·ªß c√¥ng, t·∫°o phi·∫øu thu/chi ri√™ng\r\n  // - Gi·ªØ nguy√™n inventory v√† payment history ƒë·ªÉ ƒë·∫£m b·∫£o t√≠nh to√†n v·∫πn d·ªØ li·ªáu\r\n  \r\n  // KH√îNG ROLLBACK KHO khi m·ªü l·∫°i t·ª´ completed\r\n  // L√Ω do:\r\n  // - K·∫øt th√∫c = ƒê∆°n ƒë√£ xong, h√†ng ƒë√£ xu·∫•t, ti·ªÅn ƒë√£ thanh to√°n ƒë·∫ßy ƒë·ªß\r\n  // - M·ªü l·∫°i (completed ‚Üí returned) CH·ªà ƒë·ªÉ xem l·∫°i, KH√îNG ƒë∆∞·ª£c s·ª≠a/thay ƒë·ªïi g√¨\r\n  // - N·∫øu c·∫ßn ƒëi·ªÅu ch·ªânh ‚Üí Ph·∫£i t·∫°o phi·∫øu m·ªõi, ho√†n h√†ng th·ªß c√¥ng, t·∫°o phi·∫øu thu/chi ri√™ng\r\n  // - Gi·ªØ nguy√™n inventory v√† payment history ƒë·ªÉ ƒë·∫£m b·∫£o t√≠nh to√†n v·∫πn d·ªØ li·ªáu\r\n  \r\n  // Add history v·ªõi format r√µ r√†ng\r\n  const statusLabels: Record<string, string> = {\r\n    incomplete: 'Ch∆∞a ƒë·ªß th√¥ng tin',\r\n    pending: 'Ch∆∞a x·ª≠ l√Ω',\r\n    processed: 'ƒê√£ x·ª≠ l√Ω',\r\n    returned: 'ƒê√£ tr·∫£ h√†ng',\r\n    completed: 'K·∫øt th√∫c'\r\n  };\r\n  const oldStatusLabel = statusLabels[ticket.status] || ticket.status;\r\n  const newStatusLabel = statusLabels[newStatus] || newStatus;\r\n  \r\n  // Format history d·ª±a tr√™n h∆∞·ªõng chuy·ªÉn ƒë·ªïi\r\n  let historyAction: string;\r\n  if (ticket.status === 'completed' && (newStatus === 'returned' || newStatus === 'processed')) {\r\n    // M·ªü l·∫°i t·ª´ \"K·∫øt th√∫c\"\r\n    historyAction = `M·ªü l·∫°i t·ª´ ${oldStatusLabel}`;\r\n  } else if (ticket.status === 'returned' && newStatus === 'processed') {\r\n    // M·ªü l·∫°i t·ª´ \"ƒê√£ tr·∫£ h√†ng\"\r\n    historyAction = `M·ªü l·∫°i t·ª´ ${oldStatusLabel}`;\r\n  } else if (newStatus === 'completed') {\r\n    // K·∫øt th√∫c phi·∫øu\r\n    historyAction = 'K·∫øt th√∫c phi·∫øu b·∫£o h√†nh';\r\n  } else {\r\n    // Chuy·ªÉn tr·∫°ng th√°i b√¨nh th∆∞·ªùng\r\n    historyAction = `Chuy·ªÉn tr·∫°ng th√°i: ${oldStatusLabel} ‚Üí ${newStatusLabel}`;\r\n  }\r\n  \r\n  addHistory(ticketSystemId, historyAction, getCurrentUserName(), note);\r\n  \r\n  // Send notifications\r\n  if (ticket.status !== newStatus) {\r\n    if (newStatus === 'pending') {\r\n      notifyWarrantyProcessing(ticket.id);\r\n    } else if (newStatus === 'processed') {\r\n      notifyWarrantyProcessed(ticket.id);\r\n    } else if (newStatus === 'returned') {\r\n      notifyWarrantyReturned(ticket.id, undefined);\r\n    }\r\n  }\r\n  \r\n  triggerWarrantyDataUpdate();\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 6078, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/warranty/store/index.ts"],"sourcesContent":["import { create } from 'zustand';\r\nimport { getCurrentDate, toISODateTime } from '../../../lib/date-utils';\r\nimport { getWorkflowTemplate } from '../../settings/printer/workflow-templates-page';\r\nimport { toast } from 'sonner';\r\nimport { asSystemId } from '../../../lib/id-types';\r\nimport type { SystemId } from '../../../lib/id-types';\r\nimport {\r\n  notifyWarrantyCreated,\r\n} from '../notification-utils';\r\nimport { triggerWarrantyDataUpdate } from '../use-realtime-updates';\r\nimport type { WarrantyTicket, WarrantyProduct } from '../types';\r\nimport type { WarrantyStore } from '../types';\r\n\r\n// Import base store v√† c√°c modules\r\nimport {\r\n  baseStore,\r\n  originalAdd,\r\n  originalUpdate,\r\n  originalRemove,\r\n  generatePublicTrackingCode,\r\n  getCurrentUserName,\r\n  syncToApi,\r\n} from './base-store';\r\n\r\nimport {\r\n  commitWarrantyStock,\r\n  uncommitWarrantyStock,\r\n} from './stock-management';\r\n\r\nimport {\r\n  addProduct,\r\n  updateProduct,\r\n  removeProduct,\r\n  recalculateSummary,\r\n  calculateSummary,\r\n  calculateSettlementStatus,\r\n  addHistory,\r\n} from './product-management';\r\n\r\nimport {\r\n  updateStatus,\r\n} from './status-management';\r\n\r\n// Override add() for custom logic\r\nbaseStore.setState({\r\n  add: (item: Omit<WarrantyTicket, 'systemId'>) => {\r\n    // Auto ID generation by createCrudStore\r\n    const newTicket = originalAdd(item);\r\n    \r\n    // Copy workflow template subtasks\r\n    const subtasks = getWorkflowTemplate('warranty');\r\n    if (subtasks && subtasks.length > 0) {\r\n      newTicket.subtasks = subtasks;\r\n    }\r\n    \r\n    // Generate public tracking code\r\n    if (!newTicket.publicTrackingCode) {\r\n      newTicket.publicTrackingCode = generatePublicTrackingCode();\r\n    }\r\n    \r\n    // Commit stock for replace products\r\n    commitWarrantyStock(newTicket);\r\n    \r\n    // Add initial history\r\n    if (!newTicket.history || newTicket.history.length === 0) {\r\n      newTicket.history = [{\r\n        systemId: asSystemId(`WH_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`),\r\n        action: 'T·∫°o phi·∫øu b·∫£o h√†nh',\r\n        actionLabel: 'T·∫°o phi·∫øu b·∫£o h√†nh',\r\n        performedBy: getCurrentUserName(),\r\n        performedAt: toISODateTime(getCurrentDate()),\r\n      }];\r\n    }\r\n    \r\n    // Update state to include subtasks, history, publicTrackingCode\r\n    baseStore.setState((state) => ({\r\n      data: state.data.map(t => t.systemId === newTicket.systemId ? newTicket : t)\r\n    }));\r\n    \r\n    // ‚úÖ Sync to API\r\n    syncToApi.create(newTicket);\r\n    \r\n    // Send notification\r\n    notifyWarrantyCreated(newTicket.id);\r\n    \r\n    // Trigger realtime update\r\n    triggerWarrantyDataUpdate();\r\n    \r\n    return newTicket;\r\n  },\r\n  \r\n  update: (systemId: SystemId, updates: any) => {\r\n    const oldTicket = baseStore.getState().data.find(t => t.systemId === systemId);\r\n    if (!oldTicket) return;\r\n    \r\n    // Check if history is explicitly provided\r\n    const hasExplicitHistory = updates.history && updates.history.length > (oldTicket.history?.length || 0);\r\n    \r\n    // Track changes for auto-history\r\n    const changes: string[] = [];\r\n    \r\n    if (!hasExplicitHistory) {\r\n      if (updates.customerName && updates.customerName !== oldTicket.customerName) {\r\n        changes.push(`T√™n kh√°ch h√†ng: \"${oldTicket.customerName}\" ‚Üí \"${updates.customerName}\"`);\r\n      }\r\n      if (updates.customerPhone && updates.customerPhone !== oldTicket.customerPhone) {\r\n        changes.push(`S·ªë ƒëi·ªán tho·∫°i: \"${oldTicket.customerPhone}\" ‚Üí \"${updates.customerPhone}\"`);\r\n      }\r\n      if (updates.trackingCode && updates.trackingCode !== oldTicket.trackingCode) {\r\n        changes.push(`M√£ v·∫≠n ƒë∆°n: \"${oldTicket.trackingCode}\" ‚Üí \"${updates.trackingCode}\"`);\r\n      }\r\n    }\r\n    \r\n    originalUpdate(systemId, updates);\r\n    \r\n    // ‚úÖ Sync to API\r\n    syncToApi.update(systemId, updates);\r\n    \r\n    // Add auto-history\r\n    if (!hasExplicitHistory && changes.length > 0) {\r\n      changes.forEach(change => {\r\n        addHistory(systemId, change, getCurrentUserName());\r\n      });\r\n    }\r\n    \r\n    // Trigger realtime update\r\n    triggerWarrantyDataUpdate();\r\n  },\r\n  \r\n  remove: (systemId: SystemId) => {\r\n    const ticket = baseStore.getState().data.find(t => t.systemId === systemId);\r\n    \r\n    if (ticket) {\r\n      // Add history before deletion\r\n      addHistory(systemId, 'X√≥a phi·∫øu b·∫£o h√†nh (chuy·ªÉn v√†o th√πng r√°c)', getCurrentUserName());\r\n      \r\n      // Uncommit stock\r\n      uncommitWarrantyStock(ticket);\r\n    }\r\n    \r\n    originalRemove(systemId);\r\n    \r\n    // ‚úÖ Sync to API\r\n    syncToApi.delete(systemId, false);\r\n    \r\n    // Trigger realtime update\r\n    triggerWarrantyDataUpdate();\r\n  },\r\n});\r\n\r\nexport const useWarrantyStore = create<WarrantyStore>()((set, get) => ({\r\n  ...baseStore.getState(),\r\n  \r\n  // Warranty-specific methods\r\n  addProduct,\r\n  updateProduct,\r\n  removeProduct,\r\n  updateStatus,\r\n  addHistory,\r\n  recalculateSummary,\r\n  calculateSummary,\r\n  calculateSettlementStatus,\r\n  \r\n  // Placeholder methods for backward compatibility\r\n  addComment: () => console.warn('addComment: Use generic Comments component instead'),\r\n  updateComment: () => console.warn('updateComment: Use generic Comments component instead'),\r\n  deleteComment: () => console.warn('deleteComment: Use generic Comments component instead'),\r\n  replyComment: () => console.warn('replyComment: Use generic Comments component instead'),\r\n  generateNextSystemId: () => {\r\n    // Generate next systemId using same pattern as createCrudStore\r\n    const maxSystemId = baseStore.getState().data.reduce((max, item) => {\r\n      const match = item.systemId.match(/WARRANTY(\\d{6})/);\r\n      return match ? Math.max(max, parseInt(match[1])) : max;\r\n    }, 0);\r\n    return asSystemId(`WARRANTY${String(maxSystemId + 1).padStart(6, '0')}`);\r\n  },\r\n  _migrate: () => console.warn('_migrate: No longer needed with createCrudStore'),\r\n}));\r\n\r\n// Subscribe to base store changes\r\nbaseStore.subscribe((state) => {\r\n  useWarrantyStore.setState(state as any);\r\n});\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 6223, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/warranty/store.ts"],"sourcesContent":["export { useWarrantyStore } from './store/index';\r\n"],"names":[],"mappings":";AAAA"}},
    {"offset": {"line": 6230, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/warranty/utils/warranty-checker.ts"],"sourcesContent":["import type { Order } from '../../orders/types';\r\nimport type { WarrantyProduct } from '../types';\r\nimport { parseDate, addMonths, isDateBefore, toISODate, getCurrentDate } from '../../../lib/date-utils';\r\n\r\n/**\r\n * Th√¥ng tin b·∫£o h√†nh c·ªßa s·∫£n ph·∫©m t·ª´ ƒë∆°n h√†ng\r\n */\r\nexport interface ProductWarrantyInfo {\r\n  orderId: string;\r\n  orderDate: string;\r\n  productName: string;\r\n  quantity: number;\r\n  unitPrice: number;\r\n  warrantyPeriodMonths: number;\r\n  warrantyExpiry: string;\r\n  isExpired: boolean;\r\n  daysRemaining: number;\r\n}\r\n\r\n/**\r\n * K·∫øt qu·∫£ ki·ªÉm tra b·∫£o h√†nh\r\n */\r\nexport interface WarrantyCheckResult {\r\n  isValid: boolean;\r\n  totalPurchased: number;\r\n  totalStillUnderWarranty: number;\r\n  totalExpired: number;\r\n  availableQuantity: number;\r\n  warnings: string[];\r\n  productHistory: ProductWarrantyInfo[];\r\n}\r\n\r\n/**\r\n * T√≠nh ng√†y h·∫øt h·∫°n b·∫£o h√†nh\r\n */\r\nexport function calculateWarrantyExpiry(orderDate: string, warrantyMonths: number): string {\r\n  const date = parseDate(orderDate);\r\n  if (!date) return orderDate;\r\n  \r\n  const expiry = addMonths(date, warrantyMonths);\r\n  return toISODate(expiry);\r\n}\r\n\r\n/**\r\n * T√≠nh s·ªë ng√†y c√≤n l·∫°i ƒë·∫øn h·∫øt h·∫°n (< 0 nghƒ©a l√† ƒë√£ h·∫øt h·∫°n)\r\n */\r\nexport function calculateDaysRemaining(expiryDate: string): number {\r\n  const expiry = parseDate(expiryDate);\r\n  const today = getCurrentDate();\r\n  \r\n  if (!expiry) return -999;\r\n  \r\n  const diff = expiry.getTime() - today.getTime();\r\n  return Math.ceil(diff / (1000 * 60 * 60 * 24));\r\n}\r\n\r\n/**\r\n * L·∫•y l·ªãch s·ª≠ mua h√†ng c·ªßa s·∫£n ph·∫©m t·ª´ kh√°ch h√†ng\r\n */\r\nexport function getProductPurchaseHistory(\r\n  customerName: string,\r\n  productName: string,\r\n  allOrders: Order[],\r\n  defaultWarrantyMonths: number = 12\r\n): ProductWarrantyInfo[] {\r\n  // L·ªçc ƒë∆°n h√†ng c·ªßa kh√°ch (ƒë√£ ho√†n th√†nh)\r\n  const customerOrders = allOrders.filter(\r\n    order => \r\n      order.customerName === customerName && \r\n      order.status === 'Ho√†n th√†nh' // Ch·ªâ t√≠nh ƒë∆°n ƒë√£ ho√†n th√†nh\r\n  );\r\n\r\n  const history: ProductWarrantyInfo[] = [];\r\n\r\n  // Duy·ªát qua t·ª´ng ƒë∆°n h√†ng\r\n  for (const order of customerOrders) {\r\n    // T√¨m s·∫£n ph·∫©m trong ƒë∆°n h√†ng\r\n    const matchingItems = order.lineItems.filter(item => \r\n      item.productName.toLowerCase().includes(productName.toLowerCase()) ||\r\n      productName.toLowerCase().includes(item.productName.toLowerCase())\r\n    );\r\n\r\n    for (const item of matchingItems) {\r\n      // L·∫•y th·ªùi gian b·∫£o h√†nh (t·ª´ s·∫£n ph·∫©m ho·∫∑c m·∫∑c ƒë·ªãnh 12 th√°ng)\r\n      const warrantyMonths = (item as any).warrantyPeriodMonths || defaultWarrantyMonths;\r\n      \r\n      // T√≠nh ng√†y h·∫øt h·∫°n\r\n      const expiryDate = calculateWarrantyExpiry(order.orderDate, warrantyMonths);\r\n      const daysRemaining = calculateDaysRemaining(expiryDate);\r\n      \r\n      history.push({\r\n        orderId: order.id,\r\n        orderDate: order.orderDate,\r\n        productName: item.productName,\r\n        quantity: item.quantity,\r\n        unitPrice: item.unitPrice,\r\n        warrantyPeriodMonths: warrantyMonths,\r\n        warrantyExpiry: expiryDate,\r\n        isExpired: daysRemaining < 0,\r\n        daysRemaining,\r\n      });\r\n    }\r\n  }\r\n\r\n  // S·∫Øp x·∫øp theo ng√†y mua (FIFO - c≈© nh·∫•t tr∆∞·ªõc)\r\n  return history.sort((a, b) => \r\n    new Date(a.orderDate).getTime() - new Date(b.orderDate).getTime()\r\n  );\r\n}\r\n\r\n/**\r\n * Ki·ªÉm tra b·∫£o h√†nh s·∫£n ph·∫©m theo FIFO\r\n */\r\nexport function checkWarrantyStatus(\r\n  customerName: string,\r\n  productName: string,\r\n  requestedQuantity: number,\r\n  allOrders: Order[],\r\n  defaultWarrantyMonths: number = 12\r\n): WarrantyCheckResult {\r\n  // L·∫•y l·ªãch s·ª≠ mua h√†ng\r\n  const history = getProductPurchaseHistory(\r\n    customerName,\r\n    productName,\r\n    allOrders,\r\n    defaultWarrantyMonths\r\n  );\r\n\r\n  const warnings: string[] = [];\r\n  \r\n  // Check 1: Kh√°ch ch∆∞a t·ª´ng mua s·∫£n ph·∫©m n√†y\r\n  if (history.length === 0) {\r\n    warnings.push(`‚ùå Kh√°ch h√†ng ch∆∞a t·ª´ng mua \"${productName}\"`);\r\n    return {\r\n      isValid: false,\r\n      totalPurchased: 0,\r\n      totalStillUnderWarranty: 0,\r\n      totalExpired: 0,\r\n      availableQuantity: 0,\r\n      warnings,\r\n      productHistory: [],\r\n    };\r\n  }\r\n\r\n  // T√≠nh t·ªïng s·ªë l∆∞·ª£ng\r\n  const totalPurchased = history.reduce((sum, h) => sum + h.quantity, 0);\r\n  const totalStillUnderWarranty = history\r\n    .filter(h => !h.isExpired)\r\n    .reduce((sum, h) => sum + h.quantity, 0);\r\n  const totalExpired = history\r\n    .filter(h => h.isExpired)\r\n    .reduce((sum, h) => sum + h.quantity, 0);\r\n\r\n  // Check 2: S·ªë l∆∞·ª£ng g·ª≠i > S·ªë l∆∞·ª£ng ƒë√£ mua\r\n  if (requestedQuantity > totalPurchased) {\r\n    warnings.push(\r\n      `‚ö†Ô∏è Kh√°ch g·ª≠i ${requestedQuantity} c√°i nh∆∞ng ch·ªâ mua ${totalPurchased} c√°i`\r\n    );\r\n  }\r\n\r\n  // Check 3: Ph√¢n b·ªï theo FIFO v√† ki·ªÉm tra h·∫øt h·∫°n\r\n  let remainingToCheck = requestedQuantity;\r\n  let availableCount = 0;\r\n\r\n  for (const purchase of history) {\r\n    if (remainingToCheck <= 0) break;\r\n\r\n    const qtyToCheck = Math.min(remainingToCheck, purchase.quantity);\r\n    \r\n    if (!purchase.isExpired) {\r\n      availableCount += qtyToCheck;\r\n      \r\n      // C·∫£nh b√°o s·∫Øp h·∫øt h·∫°n (< 30 ng√†y)\r\n      if (purchase.daysRemaining <= 30 && purchase.daysRemaining > 0) {\r\n        warnings.push(\r\n          `‚è∞ ${qtyToCheck} c√°i t·ª´ ƒë∆°n #${purchase.orderId} s·∫Øp h·∫øt h·∫°n (c√≤n ${purchase.daysRemaining} ng√†y)`\r\n        );\r\n      }\r\n    } else {\r\n      warnings.push(\r\n        `‚ùå ${qtyToCheck} c√°i t·ª´ ƒë∆°n #${purchase.orderId} ƒë√£ h·∫øt h·∫°n b·∫£o h√†nh (${-purchase.daysRemaining} ng√†y)`\r\n      );\r\n    }\r\n\r\n    remainingToCheck -= qtyToCheck;\r\n  }\r\n\r\n  // Check 4: T·∫•t c·∫£ ƒë·ªÅu h·∫øt h·∫°n\r\n  if (availableCount === 0 && requestedQuantity > 0) {\r\n    warnings.push(`üö´ T·∫§T C·∫¢ ${requestedQuantity} s·∫£n ph·∫©m ƒë·ªÅu ƒê√É H·∫æT H·∫†N b·∫£o h√†nh`);\r\n  }\r\n\r\n  // Check 5: M·ªôt s·ªë h·∫øt h·∫°n, m·ªôt s·ªë c√≤n\r\n  if (availableCount > 0 && availableCount < requestedQuantity) {\r\n    warnings.push(\r\n      `‚ö†Ô∏è Ch·ªâ ${availableCount}/${requestedQuantity} c√°i c√≤n b·∫£o h√†nh. ${requestedQuantity - availableCount} c√°i ƒë√£ h·∫øt h·∫°n.`\r\n    );\r\n  }\r\n\r\n  return {\r\n    isValid: availableCount > 0,\r\n    totalPurchased,\r\n    totalStillUnderWarranty,\r\n    totalExpired,\r\n    availableQuantity: availableCount,\r\n    warnings,\r\n    productHistory: history,\r\n  };\r\n}\r\n\r\n/**\r\n * T·∫°o th√¥ng b√°o cho nh√¢n vi√™n\r\n */\r\nexport function generateWarrantyWarningMessage(result: WarrantyCheckResult): string {\r\n  if (result.warnings.length === 0) {\r\n    return '‚úÖ T·∫•t c·∫£ s·∫£n ph·∫©m ƒë·ªÅu c√≤n trong th·ªùi h·∫°n b·∫£o h√†nh';\r\n  }\r\n\r\n  return result.warnings.join('\\n');\r\n}\r\n\r\n/**\r\n * L·∫•y badge color cho tr·∫°ng th√°i b·∫£o h√†nh\r\n */\r\nexport function getWarrantyStatusBadge(daysRemaining: number): {\r\n  label: string;\r\n  variant: 'default' | 'success' | 'warning' | 'destructive';\r\n} {\r\n  if (daysRemaining < 0) {\r\n    return { label: 'H·∫øt h·∫°n', variant: 'destructive' };\r\n  }\r\n  if (daysRemaining <= 7) {\r\n    return { label: 'H·∫øt h·∫°n trong 7 ng√†y', variant: 'destructive' };\r\n  }\r\n  if (daysRemaining <= 30) {\r\n    return { label: 'S·∫Øp h·∫øt h·∫°n', variant: 'warning' };\r\n  }\r\n  if (daysRemaining <= 90) {\r\n    return { label: `C√≤n ${daysRemaining} ng√†y`, variant: 'default' };\r\n  }\r\n  return { label: 'C√≤n h·∫°n', variant: 'success' };\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 6390, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/warranty/types.ts"],"sourcesContent":["/**\r\n * Warranty Management Types\r\n * \r\n * H·ªá th·ªëng qu·∫£n l√Ω b·∫£o h√†nh s·∫£n ph·∫©m\r\n * - Ti·∫øp nh·∫≠n s·∫£n ph·∫©m b·∫£o h√†nh t·ª´ kh√°ch h√†ng\r\n * - X·ª≠ l√Ω v√† theo d√µi t√¨nh tr·∫°ng s·∫£n ph·∫©m\r\n * - Ghi log l·ªãch s·ª≠ thao t√°c\r\n */\r\n\r\nimport type { Subtask } from '../../components/shared/subtask-list';\r\nimport type { SystemId, BusinessId } from '../../lib/id-types';\r\nimport type { Customer } from '../customers/types';\r\nimport type { WarrantyCustomerInfo } from './types/ui';\r\n\r\nexport type {\r\n  WarrantyCustomerInfo,\r\n  WarrantyBranchContext,\r\n  WarrantyVoucherDialogBaseProps,\r\n} from './types/ui';\r\nexport type { WarrantyStore } from './types/store';\r\n\r\n// ====================================\r\n// Tr·∫°ng th√°i phi·∫øu b·∫£o h√†nh\r\n// ====================================\r\nexport type WarrantyStatus = \r\n  | 'incomplete'    // Ch∆∞a ƒë·∫ßy ƒë·ªß (ch·ªâ c√≥ info c∆° b·∫£n, ch∆∞a c√≥ danh s√°ch s·∫£n ph·∫©m)\r\n  | 'pending'       // Ch∆∞a x·ª≠ l√Ω (ƒë√£ c√≥ danh s√°ch SP, ƒëang ch·ªù x·ª≠ l√Ω)\r\n  | 'processed'     // ƒê√£ x·ª≠ l√Ω (ƒë√£ x·ª≠ l√Ω xong)\r\n  | 'returned'      // ƒê√£ tr·∫£ (ƒë√£ tr·∫£ h√†ng cho kh√°ch)\r\n  | 'completed'     // K·∫øt th√∫c (ƒë√£ tr·∫£ h√†ng + thanh to√°n ƒë·∫ßy ƒë·ªß)\r\n  | 'cancelled';    // ƒê√£ h·ªßy (phi·∫øu b·ªã h·ªßy)\r\n\r\nexport const WARRANTY_STATUS_LABELS: Record<WarrantyStatus, string> = {\r\n  incomplete: 'Ch∆∞a ƒë·∫ßy ƒë·ªß',\r\n  pending: 'Ch∆∞a x·ª≠ l√Ω',\r\n  processed: 'ƒê√£ x·ª≠ l√Ω',\r\n  returned: 'ƒê√£ tr·∫£',\r\n  completed: 'K·∫øt th√∫c',\r\n  cancelled: 'ƒê√£ h·ªßy',\r\n};\r\n\r\nexport const WARRANTY_STATUS_COLORS: Record<WarrantyStatus, string> = {\r\n  incomplete: 'bg-orange-100 text-orange-800',\r\n  pending: 'bg-yellow-100 text-yellow-800',\r\n  processed: 'bg-green-100 text-green-800',\r\n  returned: 'bg-gray-100 text-gray-800',\r\n  completed: 'bg-blue-100 text-blue-800',\r\n  cancelled: 'bg-red-100 text-red-800 line-through',\r\n};\r\n\r\n// ====================================\r\n// Tr·∫°ng th√°i thanh to√°n b√π tr·ª´ (cho WarrantyTicket)\r\n// ====================================\r\nexport type WarrantySettlementStatus = 'pending' | 'partial' | 'completed';\r\n\r\nexport const WARRANTY_SETTLEMENT_STATUS_LABELS: Record<WarrantySettlementStatus, string> = {\r\n  pending: 'Ch∆∞a thanh to√°n',\r\n  partial: 'Thanh to√°n m·ªôt ph·∫ßn',\r\n  completed: 'ƒê√£ thanh to√°n',\r\n};\r\n\r\nexport const WARRANTY_SETTLEMENT_STATUS_COLORS: Record<WarrantySettlementStatus, string> = {\r\n  pending: 'bg-red-100 text-red-800',\r\n  partial: 'bg-orange-100 text-orange-800',\r\n  completed: 'bg-green-100 text-green-800',\r\n};\r\n\r\n// ====================================\r\n// C√°ch x·ª≠ l√Ω s·∫£n ph·∫©m b·∫£o h√†nh\r\n// ====================================\r\nexport type ResolutionType = \r\n  | 'return'    // Tr·∫£ l·∫°i (tr·∫£ nguy√™n hi·ªán tr·∫°ng)\r\n  | 'replace'   // ƒê·ªïi m·ªõi (thay th·∫ø s·∫£n ph·∫©m m·ªõi)\r\n  | 'deduct'    // Tr·ª´ ti·ªÅn (ƒë·ªïi tr·∫£ c√≥ ho√†n ti·ªÅn 1 ph·∫ßn)\r\n  | 'out_of_stock'; // H·∫øt h√†ng (kh√¥ng c√≥ ƒë·ªÉ ƒë·ªïi)\r\n\r\nexport const RESOLUTION_LABELS: Record<ResolutionType, string> = {\r\n  return: 'Tr·∫£ l·∫°i',\r\n  replace: 'ƒê·ªïi m·ªõi',\r\n  deduct: 'Tr·ª´ ti·ªÅn',\r\n  out_of_stock: 'H·∫øt h√†ng',\r\n};\r\n\r\n// ====================================\r\n// B√π tr·ª´ thanh to√°n\r\n// ====================================\r\nexport type SettlementType = \r\n  | 'cash'              // Tr·∫£ ti·ªÅn m·∫∑t ngay\r\n  | 'transfer'          // Chuy·ªÉn kho·∫£n\r\n  | 'debt'              // Ghi c√¥ng n·ª£ (tr·∫£ sau)\r\n  | 'voucher'           // T·∫°o voucher tr·ª´ ƒë∆°n h√†ng sau\r\n  | 'order_deduction'   // Tr·ª´ v√†o ti·ªÅn h√†ng (ƒë∆°n h√†ng hi·ªán t·∫°i/t∆∞∆°ng lai)\r\n  | 'mixed';            // K·∫øt h·ª£p nhi·ªÅu ph∆∞∆°ng th·ª©c\r\n\r\nexport const SETTLEMENT_TYPE_LABELS: Record<SettlementType, string> = {\r\n  cash: 'Tr·∫£ ti·ªÅn m·∫∑t',\r\n  transfer: 'Chuy·ªÉn kho·∫£n',\r\n  debt: 'Ghi c√¥ng n·ª£',\r\n  voucher: 'T·∫°o voucher',\r\n  order_deduction: 'Tr·ª´ v√†o ti·ªÅn h√†ng',\r\n  mixed: 'K·∫øt h·ª£p nhi·ªÅu ph∆∞∆°ng th·ª©c',\r\n};\r\n\r\nexport type SettlementStatus = 'pending' | 'partial' | 'completed' | 'cancelled';\r\n\r\nexport const SETTLEMENT_STATUS_LABELS: Record<SettlementStatus, string> = {\r\n  pending: 'Ch∆∞a b√π tr·ª´',\r\n  partial: 'B√π tr·ª´ 1 ph·∫ßn',\r\n  completed: 'ƒê√£ ho√†n th√†nh',\r\n  cancelled: 'ƒê√£ h·ªßy',\r\n};\r\n\r\n// S·∫£n ph·∫©m c·∫ßn b√π tr·ª´\r\nexport interface UnsettledProduct {\r\n  productName: string;\r\n  quantity: number;\r\n  unitPrice: number;\r\n  totalPrice: number;\r\n  reason: 'out_of_stock' | 'discontinued' | 'defective';\r\n}\r\n\r\n// Chi ti·∫øt t·ª´ng ph∆∞∆°ng th·ª©c b√π tr·ª´ (cho mixed settlement)\r\nexport interface SettlementMethod {\r\n  systemId: SystemId;               // BRANDED TYPE\r\n  type: Exclude<SettlementType, 'mixed'>; // Kh√¥ng cho nested mixed\r\n  amount: number;\r\n  status: SettlementStatus;\r\n  \r\n  // Th√¥ng tin chi ti·∫øt theo t·ª´ng lo·∫°i\r\n  linkedOrderSystemId?: SystemId | undefined;   // Link to order (BRANDED TYPE)\r\n  paymentVoucherId?: SystemId | undefined;      // Cho cash/transfer (BRANDED TYPE)\r\n  debtTransactionId?: SystemId | undefined;     // Cho debt (BRANDED TYPE)\r\n  voucherCode?: string | undefined;             // Cho voucher\r\n  bankAccount?: string | undefined;             // Cho transfer\r\n  transactionCode?: string | undefined;         // Cho transfer\r\n  dueDate?: string | undefined;                 // Cho debt\r\n  \r\n  notes?: string | undefined;\r\n  createdAt: string;\r\n  completedAt?: string | undefined;\r\n}\r\n\r\n// Th√¥ng tin b√π tr·ª´\r\nexport interface WarrantySettlement {\r\n  systemId: SystemId;               // BRANDED TYPE\r\n  warrantyId: SystemId;             // BRANDED TYPE - Reference to warranty ticket\r\n  \r\n  // Th√¥ng tin b√π tr·ª´\r\n  settlementType: SettlementType;\r\n  totalAmount: number;          // T·ªïng ti·ªÅn c·∫ßn b√π tr·ª´\r\n  settledAmount: number;        // S·ªë ti·ªÅn ƒë√£ b√π tr·ª´\r\n  remainingAmount: number;      // S·ªë ti·ªÅn c√≤n l·∫°i\r\n  \r\n  // Chi ti·∫øt s·∫£n ph·∫©m kh√¥ng ƒë·ªïi ƒë∆∞·ª£c\r\n  unsettledProducts: UnsettledProduct[];\r\n  \r\n  // Cho single settlement type\r\n  paymentVoucherId?: SystemId | undefined;      // ID phi·∫øu chi (BRANDED TYPE)\r\n  debtTransactionId?: SystemId | undefined;     // ID giao d·ªãch c√¥ng n·ª£ (BRANDED TYPE)\r\n  voucherCode?: string | undefined;             // M√£ voucher (n·∫øu t·∫°o voucher)\r\n  linkedOrderSystemId?: SystemId | undefined;   // Link to order (BRANDED TYPE)\r\n  \r\n  // Cho mixed settlement type\r\n  methods?: SettlementMethod[] | undefined;     // Danh s√°ch c√°c ph∆∞∆°ng th·ª©c b√π tr·ª´ (khi type = 'mixed')\r\n  \r\n  status: SettlementStatus;\r\n  settledAt?: string | undefined;\r\n  settledBy?: SystemId | undefined;             // BRANDED TYPE - Employee who settled\r\n  notes: string;\r\n  createdAt: string;\r\n  updatedAt?: string | undefined;\r\n}\r\n\r\n// ====================================\r\n// Status workflow rules\r\n// ====================================\r\nexport const WARRANTY_STATUS_TRANSITIONS: Record<WarrantyStatus, WarrantyStatus[]> = {\r\n  incomplete: ['pending'],    // Ch∆∞a ƒë·∫ßy ƒë·ªß ‚Üí Ch∆∞a x·ª≠ l√Ω\r\n  pending: ['processed'],     // Ch∆∞a x·ª≠ l√Ω ‚Üí ƒê√£ x·ª≠ l√Ω\r\n  processed: ['returned'],    // ƒê√£ x·ª≠ l√Ω ‚Üí ƒê√£ tr·∫£\r\n  returned: ['completed'],    // ƒê√£ tr·∫£ ‚Üí K·∫øt th√∫c (sau khi thanh to√°n ƒë·∫ßy ƒë·ªß)\r\n  completed: [],              // K·∫øt th√∫c ‚Üí Final state\r\n  cancelled: [],              // ƒê√£ h·ªßy ‚Üí Final state\r\n};\r\n\r\nexport const WARRANTY_STATUS_TRANSITION_LABELS: Partial<Record<WarrantyStatus, Partial<Record<WarrantyStatus, string>>>> = {\r\n  incomplete: {\r\n    pending: 'B·∫Øt ƒë·∫ßu x·ª≠ l√Ω',\r\n  },\r\n  pending: {\r\n    processed: 'Ho√†n th√†nh x·ª≠ l√Ω',\r\n  },\r\n  processed: {\r\n    returned: 'Tr·∫£ h√†ng cho kh√°ch',\r\n  },\r\n  returned: {\r\n    completed: 'K·∫øt th√∫c phi·∫øu b·∫£o h√†nh',\r\n  },\r\n  completed: {},\r\n  cancelled: {},\r\n};\r\n\r\n// Helper function to validate status transition\r\nexport function canTransitionStatus(currentStatus: WarrantyStatus, newStatus: WarrantyStatus): boolean {\r\n  return WARRANTY_STATUS_TRANSITIONS[currentStatus].includes(newStatus);\r\n}\r\n\r\n// Helper function to get next allowed statuses\r\nexport function getNextAllowedStatuses(currentStatus: WarrantyStatus): WarrantyStatus[] {\r\n  return WARRANTY_STATUS_TRANSITIONS[currentStatus];\r\n}\r\n\r\n// ====================================\r\n// S·∫£n ph·∫©m trong phi·∫øu b·∫£o h√†nh\r\n// ====================================\r\nexport interface WarrantyProduct {\r\n  systemId: SystemId;             // ID h·ªá th·ªëng (BRANDED TYPE)\r\n  productSystemId?: SystemId | undefined;     // Link to Product entity (BRANDED TYPE)\r\n  sku?: BusinessId | undefined;               // M√£ SKU s·∫£n ph·∫©m (BRANDED TYPE - Business ID)\r\n  productName: string;            // T√™n s·∫£n ph·∫©m (textbox)\r\n  quantity?: number | undefined;              // S·ªë l∆∞·ª£ng (m·∫∑c ƒë·ªãnh 1)\r\n  unitPrice?: number | undefined;             // ƒê∆°n gi√° (ƒë·ªÉ t√≠nh th√†nh ti·ªÅn)\r\n  issueDescription: string;       // T√¨nh tr·∫°ng/Ghi ch√∫ (textbox)\r\n  resolution: ResolutionType;     // C√°ch x·ª≠ l√Ω (Tr·∫£ l·∫°i/ƒê·ªïi m·ªõi/Tr·ª´ ti·ªÅn)\r\n  deductionAmount?: number | undefined;       // S·ªë ti·ªÅn tr·ª´ (n·∫øu ch·ªçn \"Tr·ª´ ti·ªÅn\")\r\n  productImages: string[];        // H√¨nh ·∫£nh s·∫£n ph·∫©m th·ª±c t·∫ø l√∫c nh·∫≠n\r\n  notes?: string | undefined;                 // Ghi ch√∫ b·ªï sung cho s·∫£n ph·∫©m\r\n}\r\n\r\n// ====================================\r\n// L·ªãch s·ª≠ thao t√°c\r\n// ====================================\r\nexport interface WarrantyHistory {\r\n  systemId: SystemId;             // ID h·ªá th·ªëng (BRANDED TYPE)\r\n  action: string;                 // H√†nh ƒë·ªông (VD: \"create\", \"add_product\", \"update_status\", \"upload_image\")\r\n  actionLabel: string;            // M√¥ t·∫£ hi·ªÉn th·ªã (VD: \"T·∫°o phi·∫øu\", \"Th√™m s·∫£n ph·∫©m #1\")\r\n  entityType?: string | undefined;            // Lo·∫°i ƒë·ªëi t∆∞·ª£ng (VD: \"product\", \"image\", \"status\")\r\n  entityId?: SystemId | undefined;            // ID ƒë·ªëi t∆∞·ª£ng (BRANDED TYPE)\r\n  changes?: {                     // Chi ti·∫øt thay ƒë·ªïi (for version control)\r\n    field: string;                // Tr∆∞·ªùng thay ƒë·ªïi\r\n    oldValue: any;                // Gi√° tr·ªã c≈©\r\n    newValue: any;                // Gi√° tr·ªã m·ªõi\r\n  }[] | undefined;\r\n  performedBy: string;            // Ng∆∞·ªùi th·ª±c hi·ªán (t√™n nh√¢n vi√™n)\r\n  performedBySystemId?: SystemId | undefined; // SystemId c·ªßa nh√¢n vi√™n (BRANDED TYPE)\r\n  performedAt: string;            // Th·ªùi gian th·ª±c hi·ªán (ISO datetime)\r\n  note?: string | undefined;                  // Ghi ch√∫ th√™m (optional)\r\n  metadata?: Record<string, any> | undefined; // Metadata cho action (paymentSystemId, receiptSystemId, etc.)\r\n  \r\n  // Link to related documents (BRANDED TYPES)\r\n  linkedOrderSystemId?: SystemId | undefined;   // Link to order (BRANDED TYPE)\r\n  linkedVoucherSystemId?: SystemId | undefined; // Link to payment voucher (BRANDED TYPE)\r\n}\r\n\r\n// ====================================\r\n// Comment (B√¨nh lu·∫≠n)\r\n// ====================================\r\nexport interface WarrantyComment {\r\n  systemId: SystemId;             // ID h·ªá th·ªëng (BRANDED TYPE)\r\n  content: string;                // N·ªôi dung HTML t·ª´ TipTap editor\r\n  contentText: string;            // N·ªôi dung plain text (for search)\r\n  createdBy: string;              // Ng∆∞·ªùi comment (t√™n nh√¢n vi√™n)\r\n  createdBySystemId: SystemId;    // SystemId c·ªßa nh√¢n vi√™n (BRANDED TYPE)\r\n  createdAt: string;              // Th·ªùi gian comment (ISO datetime)\r\n  updatedAt?: string | undefined;             // Th·ªùi gian ch·ªânh s·ª≠a (n·∫øu c√≥)\r\n  attachments?: string[] | undefined;         // H√¨nh ·∫£nh ƒë√≠nh k√®m\r\n  mentions?: SystemId[] | undefined;          // Danh s√°ch systemId nh√¢n vi√™n ƒë∆∞·ª£c tag (BRANDED TYPE)\r\n  parentId?: SystemId | undefined;            // ID comment cha (BRANDED TYPE)\r\n  isEdited?: boolean | undefined;             // ƒê√£ ch·ªânh s·ª≠a\r\n  isDeleted?: boolean | undefined;            // ƒê√£ x√≥a (soft delete)\r\n}\r\n\r\n// ====================================\r\n// Phi·∫øu b·∫£o h√†nh (Warranty Ticket)\r\n// ====================================\r\nexport interface WarrantyTicket {\r\n  // ====================================\r\n  // ID & Basic Info\r\n  // ====================================\r\n  systemId: SystemId;             // ID h·ªá th·ªëng (primary key, duy nh·∫•t) - BRANDED TYPE\r\n  id: BusinessId;                 // ID hi·ªÉn th·ªã/M√£ phi·∫øu b·∫£o h√†nh (BRANDED TYPE - Business ID)\r\n  \r\n  // ====================================\r\n  // Th√¥ng tin chi nh√°nh & nh√¢n vi√™n\r\n  // ====================================\r\n  branchSystemId: SystemId;       // Chi nh√°nh x·ª≠ l√Ω (BRANDED TYPE)\r\n  branchName: string;             // T√™n chi nh√°nh\r\n  employeeSystemId: SystemId;     // Nh√¢n vi√™n ph·ª• tr√°ch (BRANDED TYPE)\r\n  employeeName: string;           // T√™n nh√¢n vi√™n\r\n  \r\n  // ====================================\r\n  // Th√¥ng tin kh√°ch h√†ng\r\n  // ====================================\r\n  customerSystemId?: SystemId | undefined;    // Link to Customer entity (BRANDED TYPE)\r\n  customerName: string;           // T√™n kh√°ch h√†ng\r\n  customerPhone: string;          // S·ªë ƒëi·ªán tho·∫°i\r\n  customerAddress: string;        // ƒê·ªãa ch·ªâ\r\n  \r\n  // ====================================\r\n  // Th√¥ng tin v·∫≠n chuy·ªÉn\r\n  // ====================================\r\n  trackingCode: string;           // M√£ v·∫≠n ƒë∆°n (GHTK, GHN, etc.)\r\n  publicTrackingCode?: string | undefined;    // M√£ tra c·ª©u c√¥ng khai (cho kh√°ch h√†ng)\r\n  shippingFee?: number | undefined;           // Ph√≠ c∆∞·ªõc (optional)\r\n  \r\n  // ====================================\r\n  // Tham chi·∫øu b√™n ngo√†i\r\n  // ====================================\r\n  referenceUrl?: string | undefined;          // ƒê∆∞·ªùng d·∫´n (URL)\r\n  externalReference?: string | undefined;     // M√£ tham chi·∫øu\r\n  \r\n  // ====================================\r\n  // H√¨nh ·∫£nh & S·∫£n ph·∫©m\r\n  // ====================================\r\n  receivedImages: string[];       // H√¨nh ·∫£nh ƒë∆°n h√†ng l√∫c nh·∫≠n (upload khi t·∫°o phi·∫øu)\r\n  products: WarrantyProduct[];    // Danh s√°ch s·∫£n ph·∫©m b·∫£o h√†nh\r\n  processedImages?: string[] | undefined;     // H√¨nh ·∫£nh ƒë∆°n h√†ng ƒë√£ x·ª≠ l√Ω xong (upload sau khi x·ª≠ l√Ω)\r\n  \r\n  // ====================================\r\n  // Tr·∫°ng th√°i\r\n  // ====================================\r\n  status: WarrantyStatus;         // Tr·∫°ng th√°i phi·∫øu (M·ªõi/Ch∆∞a x·ª≠ l√Ω/ƒê√£ x·ª≠ l√Ω/ƒê√£ tr·∫£)\r\n  statusReason?: string | undefined;          // L√Ω do chuy·ªÉn tr·∫°ng th√°i\r\n  settlementStatus?: WarrantySettlementStatus | undefined; // Tr·∫°ng th√°i thanh to√°n (Ch∆∞a thanh to√°n/Thanh to√°n m·ªôt ph·∫ßn/ƒê√£ thanh to√°n)\r\n  stockDeducted?: boolean | undefined;        // Flag: ƒê√£ tr·ª´ kho khi completed (tr√°nh tr·ª´ l·∫°i khi reopen)\r\n  \r\n  // ====================================\r\n  // Timestamps theo tr·∫°ng th√°i\r\n  // ====================================\r\n  processingStartedAt?: string | undefined;   // Th·ªùi ƒëi·ªÉm b·∫Øt ƒë·∫ßu x·ª≠ l√Ω (new -> pending)\r\n  processedAt?: string | undefined;           // Th·ªùi ƒëi·ªÉm x·ª≠ l√Ω xong (pending -> processed)\r\n  returnedAt?: string | undefined;            // Th·ªùi ƒëi·ªÉm tr·∫£ h√†ng (processed -> returned)\r\n  completedAt?: string | undefined;           // Th·ªùi ƒëi·ªÉm k·∫øt th√∫c phi·∫øu (returned -> completed)\r\n  cancelledAt?: string | undefined;           // Th·ªùi ƒëi·ªÉm h·ªßy (n·∫øu c√≥)\r\n  cancelReason?: string | undefined;          // L√Ω do h·ªßy (khi h·ªßy phi·∫øu)\r\n  \r\n  // ====================================\r\n  // Li√™n k·∫øt v·ªõi ƒë∆°n h√†ng\r\n  // ====================================\r\n  linkedOrderSystemId?: SystemId | undefined; // Link to order (BRANDED TYPE)\r\n  \r\n  // ====================================\r\n  // DEPRECATED - No longer used after simplification\r\n  // ====================================\r\n  // version: number;                // REMOVED - Version control kh√¥ng c·∫ßn thi·∫øt\r\n  // previousVersions?: {...}[];     // REMOVED - Kh√¥ng track versions n·ªØa\r\n  \r\n  // ====================================\r\n  // Ghi ch√∫\r\n  // ====================================\r\n  notes?: string | undefined;                 // Ghi ch√∫ ƒë∆°n h√†ng\r\n  \r\n  // ====================================\r\n  // T·ªïng h·ª£p\r\n  // ====================================\r\n  summary: {\r\n    totalProducts: number;        // T·ªïng s·ªë s·∫£n ph·∫©m g·ª≠i b·∫£o h√†nh\r\n    totalReplaced: number;        // S·ªë l∆∞·ª£ng ƒë∆∞·ª£c ƒë·ªïi tr·∫£\r\n    totalReturned?: number | undefined;       // S·ªë l∆∞·ª£ng tr·∫£ l·∫°i kh√°ch\r\n    totalDeduction: number;       // T·ªïng ti·ªÅn tr·ª´\r\n    totalOutOfStock?: number | undefined;     // S·ªë l∆∞·ª£ng h·∫øt h√†ng (c·∫ßn b√π tr·ª´)\r\n    totalSettlement?: number | undefined;     // T·ªïng ti·ªÅn c·∫ßn b√π tr·ª´ (Rename suggestion: totalRefund)\r\n  };\r\n  \r\n  // ====================================\r\n  // Thanh to√°n b√π tr·ª´ (snapshot Phase 2)\r\n  // ====================================\r\n  settlement?: WarrantySettlement | undefined; // L∆∞u l·ªãch s·ª≠ t·ªïng h·ª£p ph∆∞∆°ng th·ª©c b√π tr·ª´\r\n  \r\n  // ====================================\r\n  // L·ªãch s·ª≠ thao t√°c\r\n  // ====================================\r\n  history: WarrantyHistory[];     // L·ªãch s·ª≠ t·∫•t c·∫£ thao t√°c\r\n  \r\n  // ====================================\r\n  // B√¨nh lu·∫≠n\r\n  // ====================================\r\n  comments: WarrantyComment[];    // Danh s√°ch b√¨nh lu·∫≠n\r\n  \r\n  // ====================================\r\n  // Quy tr√¨nh x·ª≠ l√Ω (Subtasks)\r\n  // ====================================\r\n  subtasks?: Subtask[] | undefined;           // Danh s√°ch c√¥ng vi·ªác c·∫ßn th·ª±c hi·ªán\r\n  \r\n  // ====================================\r\n  // Audit fields\r\n  // ====================================\r\n  createdBy: string;              // Ng∆∞·ªùi t·∫°o (t√™n nh√¢n vi√™n)\r\n  createdBySystemId?: SystemId | undefined;   // SystemId c·ªßa ng∆∞·ªùi t·∫°o (BRANDED TYPE)\r\n  createdAt: string;              // Ng√†y t·∫°o (ISO datetime)\r\n  updatedAt: string;              // Ng√†y c·∫≠p nh·∫≠t cu·ªëi (ISO datetime)\r\n  updatedBySystemId?: SystemId | undefined;   // SystemId c·ªßa ng∆∞·ªùi c·∫≠p nh·∫≠t cu·ªëi (BRANDED TYPE)\r\n}\r\n\r\n// ====================================\r\n// Form values cho React Hook Form\r\n// ====================================\r\nexport interface WarrantyFormValues {\r\n  // ===== ID =====\r\n  id?: BusinessId | undefined;                // M√£ phi·∫øu b·∫£o h√†nh (BRANDED TYPE - Business ID)\r\n  \r\n  // ===== Section 1: Th√¥ng tin kh√°ch h√†ng (REUSE CustomerSelector) =====\r\n  customer: (Customer | WarrantyCustomerInfo) | null; // CustomerSelector l∆∞u full Customer, fallback snapshot\r\n  \r\n  // ===== Section 2: Th√¥ng tin b·ªï sung (Adapted OrderInfoCard) =====\r\n  branchSystemId: SystemId;       // B√°n t·∫°i (chi nh√°nh) - required (BRANDED TYPE)\r\n  employeeSystemId: SystemId;     // L√†m b·ªüi (nh√¢n vi√™n) - required (BRANDED TYPE)\r\n  trackingCode: string;           // M√£ v·∫≠n ƒë∆°n (required)\r\n  shippingFee?: number | undefined;           // Ph√≠ c∆∞·ªõc\r\n  referenceUrl?: string | undefined;          // ƒê∆∞·ªùng d·∫´n (URL)\r\n  externalReference?: string | undefined;     // M√£ tham chi·∫øu\r\n  \r\n  // ===== Section 2B: H√¨nh ·∫£nh (50-50) =====\r\n  receivedImages: string[];       // H√¨nh ·∫£nh ƒë∆°n h√†ng l√∫c nh·∫≠n (required)\r\n  processedImages?: string[] | undefined;     // H√¨nh ·∫£nh ƒë√£ x·ª≠ l√Ω (th√™m sau)\r\n  \r\n  // ===== Section 3: Th√¥ng tin s·∫£n ph·∫©m (Warranty-specific) =====\r\n  products: WarrantyProduct[];    // S·∫£n ph·∫©m b·∫£o h√†nh (c√≥ th·ªÉ t·∫°o ngay)\r\n  \r\n  // ===== Section 4: Ghi ch√∫ (REUSE OrderNotes) =====\r\n  notes?: string | undefined;                 // Ghi ch√∫ ƒë∆°n h√†ng\r\n  \r\n  // ===== Section 5: Thanh to√°n (Adapted OrderSummary) =====\r\n  status: WarrantyStatus;         // Tr·∫°ng th√°i phi·∫øu\r\n  \r\n  // ===== B√π tr·ª´ (inline trong card thanh to√°n) =====\r\n  settlementMethod?: string | undefined;      // 'cash' | 'transfer' | 'debt' | 'voucher' | 'order_deduction'\r\n  settlementAmount?: number | undefined;      // S·ªë ti·ªÅn b√π tr·ª´\r\n  settlementBankAccount?: string | undefined; // S·ªë t√†i kho·∫£n (transfer)\r\n  settlementTransactionCode?: string | undefined; // M√£ giao d·ªãch (transfer)\r\n  settlementDueDate?: string | undefined;     // Ng√†y h·∫πn tr·∫£ (debt)\r\n  settlementVoucherCode?: string | undefined; // M√£ voucher (voucher)\r\n  linkedOrderSystemId?: SystemId | undefined; // Link to order (BRANDED TYPE)\r\n}\r\n"],"names":[],"mappings":"AAAA;;;;;;;CAOC;;;;;;;;;;;;;;;;;;;;;;;;AAyBM,MAAM,yBAAyD;IACpE,YAAY;IACZ,SAAS;IACT,WAAW;IACX,UAAU;IACV,WAAW;IACX,WAAW;AACb;AAEO,MAAM,yBAAyD;IACpE,YAAY;IACZ,SAAS;IACT,WAAW;IACX,UAAU;IACV,WAAW;IACX,WAAW;AACb;AAOO,MAAM,oCAA8E;IACzF,SAAS;IACT,SAAS;IACT,WAAW;AACb;AAEO,MAAM,oCAA8E;IACzF,SAAS;IACT,SAAS;IACT,WAAW;AACb;AAWO,MAAM,oBAAoD;IAC/D,QAAQ;IACR,SAAS;IACT,QAAQ;IACR,cAAc;AAChB;AAaO,MAAM,yBAAyD;IACpE,MAAM;IACN,UAAU;IACV,MAAM;IACN,SAAS;IACT,iBAAiB;IACjB,OAAO;AACT;AAIO,MAAM,2BAA6D;IACxE,SAAS;IACT,SAAS;IACT,WAAW;IACX,WAAW;AACb;AAkEO,MAAM,8BAAwE;IACnF,YAAY;QAAC;KAAU;IACvB,SAAS;QAAC;KAAY;IACtB,WAAW;QAAC;KAAW;IACvB,UAAU;QAAC;KAAY;IACvB,WAAW,EAAE;IACb,WAAW,EAAE;AACf;AAEO,MAAM,oCAA8G;IACzH,YAAY;QACV,SAAS;IACX;IACA,SAAS;QACP,WAAW;IACb;IACA,WAAW;QACT,UAAU;IACZ;IACA,UAAU;QACR,WAAW;IACb;IACA,WAAW,CAAC;IACZ,WAAW,CAAC;AACd;AAGO,SAAS,oBAAoB,aAA6B,EAAE,SAAyB;IAC1F,OAAO,2BAA2B,CAAC,cAAc,CAAC,QAAQ,CAAC;AAC7D;AAGO,SAAS,uBAAuB,aAA6B;IAClE,OAAO,2BAA2B,CAAC,cAAc;AACnD"}},
    {"offset": {"line": 6509, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/complaints/store.ts"],"sourcesContent":["import { create } from \"zustand\";\r\nimport { ENTITY_PREFIXES } from \"@/lib/smart-prefix\";\r\nimport { asSystemId, asBusinessId, type SystemId, type BusinessId } from \"@/lib/id-types\";\r\nimport type {\r\n  Complaint,\r\n  ComplaintStatus,\r\n  ComplaintType,\r\n  ComplaintResolution,\r\n  ComplaintVerification,\r\n  ComplaintAction,\r\n  ComplaintImage,\r\n} from \"./types\";\r\n\r\nconst complaintSeedData: Complaint[] = [\r\n  {\r\n    systemId: asSystemId(\"COMPLAINT000001\"),\r\n    id: asBusinessId(\"PKN000001\"),\r\n    publicTrackingCode: \"rb5n8xzhrm\",\r\n    orderSystemId: asSystemId(\"ORDER000001\"),\r\n    orderCode: \"DH000001\",\r\n    orderValue: 16550000,\r\n    branchSystemId: asSystemId(\"BRANCH000003\"),\r\n    branchName: \"Chi nh√°nh Trung t√¢m\",\r\n    customerSystemId: asSystemId(\"CUST000001\"),\r\n    customerId: \"KH000001\",\r\n    customerName: \"C√¥ng ty C·ªï ph·∫ßn B·∫•t ƒë·ªông s·∫£n H∆∞ng Th·ªãnh\",\r\n    customerPhone: \"0901112233\",\r\n    type: \"missing-items\",\r\n    description: \"Kh√°ch nh·∫≠n thi·∫øu adapter USB-C trong h·ªôp laptop Dell Inspiron 15.\",\r\n    images: [\r\n      {\r\n        id: asSystemId(\"CMPIMG000001\"),\r\n        url: \"https://images.unsplash.com/photo-1517336714731-489689fd1ca8?auto=format&fit=crop&w=640&q=80\",\r\n        uploadedBy: asSystemId(\"EMP000002\"),\r\n        uploadedAt: new Date(\"2025-11-14T09:00:00Z\"),\r\n        description: \"·∫¢nh kh√°ch ch·ª•p h·ªôp s·∫£n ph·∫©m\",\r\n        type: \"initial\",\r\n      },\r\n    ],\r\n    employeeImages: [],\r\n    status: \"investigating\",\r\n    verification: \"pending-verification\",\r\n    createdBy: asSystemId(\"EMP000002\"),\r\n    createdAt: new Date(\"2025-11-14T08:45:00Z\"),\r\n    assignedTo: asSystemId(\"EMP000005\"),\r\n    assigneeName: \"L√™ VƒÉn Kho\", // T√™n nh√¢n vi√™n x·ª≠ l√Ω\r\n    assignedAt: new Date(\"2025-11-14T09:15:00Z\"),\r\n    investigationNote: \"Kho x√°c nh·∫≠n thi·∫øu ph·ª• ki·ªán trong ki·ªán h√†ng. ƒêang ki·ªÉm tra t·ªìn kho ƒë·ªÉ g·ª≠i b·ªï sung.\",\r\n    evidenceImages: [],\r\n    proposedSolution: \"G·ª≠i b·ªï sung adapter trong 24h v√† t·∫∑ng voucher 2% cho ƒë∆°n ti·∫øp theo.\",\r\n    timeline: [\r\n      {\r\n        id: asSystemId(\"CMPACT000001\"),\r\n        actionType: \"created\",\r\n        performedBy: asSystemId(\"EMP000002\"),\r\n        performedAt: new Date(\"2025-11-14T08:45:00Z\"),\r\n        note: \"T·∫°o phi·∫øu khi·∫øu n·∫°i t·ª´ kh√°ch H∆∞ng Th·ªãnh.\",\r\n      },\r\n      {\r\n        id: asSystemId(\"CMPACT000002\"),\r\n        actionType: \"assigned\",\r\n        performedBy: asSystemId(\"EMP000002\"),\r\n        performedAt: new Date(\"2025-11-14T09:15:00Z\"),\r\n        note: \"Giao cho nh√¢n vi√™n kho ki·ªÉm tra.\",\r\n      },\r\n      {\r\n        id: asSystemId(\"CMPACT000003\"),\r\n        actionType: \"investigated\",\r\n        performedBy: asSystemId(\"EMP000005\"),\r\n        performedAt: new Date(\"2025-11-14T11:00:00Z\"),\r\n        note: \"ƒêang ch·ªù adapter b·ªï sung t·ª´ kho trung t√¢m.\",\r\n      },\r\n    ],\r\n    priority: \"high\",\r\n    tags: [\"H∆∞ng Th·ªãnh\", \"Thi·∫øu ph·ª• ki·ªán\"],\r\n    updatedAt: new Date(\"2025-11-14T11:15:00Z\"),\r\n    affectedProducts: [\r\n      {\r\n        productSystemId: asSystemId(\"SP000001\"),\r\n        productId: \"SP000001\",\r\n        productName: \"Laptop Dell Inspiron 15\",\r\n        unitPrice: 15000000,\r\n        quantityOrdered: 1,\r\n        quantityReceived: 1,\r\n        quantityMissing: 1,\r\n        quantityDefective: 0,\r\n        quantityExcess: 0,\r\n        issueType: \"missing\",\r\n        note: \"Thi·∫øu adapter USB-C trong h·ªôp\",\r\n        resolutionType: \"replacement\",\r\n      },\r\n    ],\r\n  },\r\n  {\r\n    systemId: asSystemId(\"COMPLAINT000002\"),\r\n    id: asBusinessId(\"PKN000002\"),\r\n    publicTrackingCode: \"m1p9l0sdxz\",\r\n    orderSystemId: asSystemId(\"ORDER000005\"),\r\n    orderCode: \"DH000005\",\r\n    orderValue: 3775000,\r\n    branchSystemId: asSystemId(\"BRANCH000004\"),\r\n    branchName: \"Chi nh√°nh Qu·∫≠n 3\",\r\n    customerSystemId: asSystemId(\"CUST000001\"),\r\n    customerId: \"KH000001\",\r\n    customerName: \"C√¥ng ty C·ªï ph·∫ßn B·∫•t ƒë·ªông s·∫£n H∆∞ng Th·ªãnh\",\r\n    customerPhone: \"0901112233\",\r\n    type: \"product-condition\",\r\n    description: \"Keycap custom b·ªã tr·∫ßy v√† 6 switch Gateron kh√¥ng nh·∫≠n t√≠n hi·ªáu sau khi l·∫Øp.\",\r\n    images: [\r\n      {\r\n        id: asSystemId(\"CMPIMG000002\"),\r\n        url: \"https://images.unsplash.com/photo-1503602642458-232111445657?auto=format&fit=crop&w=640&q=80\",\r\n        uploadedBy: asSystemId(\"EMP000003\"),\r\n        uploadedAt: new Date(\"2025-11-19T02:20:00Z\"),\r\n        description: \"·∫¢nh kh√°ch g·ª≠i v·ªÅ keycap tr·∫ßy\",\r\n        type: \"initial\",\r\n      },\r\n      {\r\n        id: asSystemId(\"CMPIMG000003\"),\r\n        url: \"https://images.unsplash.com/photo-1478562853135-c3c9e3ef7905?auto=format&fit=crop&w=640&q=80\",\r\n        uploadedBy: asSystemId(\"EMP000003\"),\r\n        uploadedAt: new Date(\"2025-11-19T02:25:00Z\"),\r\n        description: \"·∫¢nh switch l·ªói\",\r\n        type: \"initial\",\r\n      },\r\n    ],\r\n    employeeImages: [],\r\n    status: \"resolved\",\r\n    verification: \"verified-correct\",\r\n    createdBy: asSystemId(\"EMP000003\"),\r\n    createdAt: new Date(\"2025-11-19T02:10:00Z\"),\r\n    assignedTo: asSystemId(\"EMP000003\"),\r\n    assigneeName: \"Tr·∫ßn Th·ªã Hoa\", // T√™n nh√¢n vi√™n x·ª≠ l√Ω\r\n    assignedAt: new Date(\"2025-11-19T02:15:00Z\"),\r\n    investigationNote: \"ƒê√£ test t·∫°i c·ª≠a h√†ng, x√°c nh·∫≠n 6 switch l·ªói. Keycap b·ªã tr·∫ßy do qu√° tr√¨nh ƒë√≥ng g√≥i.\",\r\n    evidenceImages: [\r\n      \"https://images.unsplash.com/photo-1485827404703-89b55fcc595e?auto=format&fit=crop&w=640&q=80\",\r\n    ],\r\n    proposedSolution: \"Ho√†n 60.000ƒë cho switch l·ªói v√† g·ª≠i k√®m b·ªô switch m·ªõi d·ª± ph√≤ng.\",\r\n    timeline: [\r\n      {\r\n        id: asSystemId(\"CMPACT000004\"),\r\n        actionType: \"created\",\r\n        performedBy: asSystemId(\"EMP000003\"),\r\n        performedAt: new Date(\"2025-11-19T02:10:00Z\"),\r\n        note: \"Kh√°ch b√°o switch l·ªói v√† keycap tr·∫ßy.\",\r\n      },\r\n      {\r\n        id: asSystemId(\"CMPACT000005\"),\r\n        actionType: \"investigated\",\r\n        performedBy: asSystemId(\"EMP000003\"),\r\n        performedAt: new Date(\"2025-11-19T10:30:00Z\"),\r\n        note: \"ƒê√£ ki·ªÉm tra th·ª±c t·∫ø, x√°c nh·∫≠n l·ªói.\",\r\n      },\r\n      {\r\n        id: asSystemId(\"CMPACT000006\"),\r\n        actionType: \"verified\",\r\n        performedBy: asSystemId(\"EMP000003\"),\r\n        performedAt: new Date(\"2025-11-20T04:00:00Z\"),\r\n        note: \"X√°c nh·∫≠n l·ªói thu·ªôc v·ªÅ kho ƒë√≥ng g√≥i.\",\r\n      },\r\n      {\r\n        id: asSystemId(\"CMPACT000007\"),\r\n        actionType: \"resolved\",\r\n        performedBy: asSystemId(\"EMP000003\"),\r\n        performedAt: new Date(\"2025-11-20T05:00:00Z\"),\r\n        note: \"Ho√†n ti·ªÅn v√† t·∫°o voucher xin l·ªói kh√°ch.\",\r\n      },\r\n    ],\r\n    resolution: \"refund\",\r\n    resolutionNote: \"Ho√†n 60.000ƒë cho switch l·ªói, t·∫∑ng voucher 5% v√† g·ª≠i switch m·ªõi.\",\r\n    resolvedBy: asSystemId(\"EMP000003\"),\r\n    resolvedAt: new Date(\"2025-11-20T05:00:00Z\"),\r\n    responsibleUserId: asSystemId(\"EMP000003\"),\r\n    isVerifiedCorrect: true,\r\n    priority: \"medium\",\r\n    tags: [\"Keychron\", \"Switch l·ªói\"],\r\n    updatedAt: new Date(\"2025-11-20T05:30:00Z\"),\r\n    affectedProducts: [\r\n      {\r\n        productSystemId: asSystemId(\"SP000008\"),\r\n        productId: \"SP000008\",\r\n        productName: \"B√†n ph√≠m c∆° Keychron K2\",\r\n        unitPrice: 2500000,\r\n        quantityOrdered: 1,\r\n        quantityReceived: 1,\r\n        quantityMissing: 0,\r\n        quantityDefective: 1,\r\n        quantityExcess: 0,\r\n        issueType: \"defective\",\r\n        note: \"Keycap tr·∫ßy nh·∫π\",\r\n        resolutionType: \"replacement\",\r\n      },\r\n      {\r\n        productSystemId: asSystemId(\"SP000010\"),\r\n        productId: \"SP000010\",\r\n        productName: \"Switch Gateron Yellow\",\r\n        unitPrice: 5000,\r\n        quantityOrdered: 90,\r\n        quantityReceived: 90,\r\n        quantityMissing: 0,\r\n        quantityDefective: 6,\r\n        quantityExcess: 0,\r\n        issueType: \"defective\",\r\n        note: \"6 switch kh√¥ng nh·∫≠n t√≠n hi·ªáu\",\r\n        resolutionType: \"refund\",\r\n      },\r\n    ],\r\n  },\r\n];\r\n\r\n// =============================================\r\n// HELPER FUNCTIONS\r\n// =============================================\r\n\r\n/**\r\n * Generate random public tracking code (10 chars: a-z, 0-9)\r\n * Example: rb5n8xzhrm\r\n */\r\nfunction generatePublicTrackingCode(): string {\r\n  const chars = 'abcdefghijklmnopqrstuvwxyz0123456789';\r\n  let result = '';\r\n  for (let i = 0; i < 10; i++) {\r\n    result += chars.charAt(Math.floor(Math.random() * chars.length));\r\n  }\r\n  return result;\r\n}\r\n\r\n// =============================================\r\n// STORE STATE INTERFACE\r\n// =============================================\r\n\r\ninterface ComplaintFilters {\r\n  status: ComplaintStatus | \"all\";\r\n  type: ComplaintType | \"all\";\r\n  verification: ComplaintVerification | \"all\";\r\n  assignedTo: SystemId | \"all\";  // Use SystemId for assignedTo\r\n  dateRange?: { from: Date; to: Date };\r\n  priority?: \"low\" | \"medium\" | \"high\" | \"urgent\" | \"all\";\r\n}\r\n\r\ninterface ComplaintStore {\r\n  // State\r\n  complaints: Complaint[];\r\n  filters: ComplaintFilters;\r\n  searchQuery: string;\r\n  selectedComplaintId: SystemId | null;\r\n\r\n  // Actions - CRUD (s·ª≠ d·ª•ng store-factory internally)\r\n  addComplaint: (complaint: Omit<Complaint, \"systemId\" | \"createdAt\" | \"updatedAt\" | \"timeline\" | \"id\"> & { id?: BusinessId }) => SystemId;\r\n  updateComplaint: (systemId: SystemId, updates: Partial<Complaint>) => void;\r\n  deleteComplaint: (systemId: SystemId) => void;\r\n  getComplaintById: (systemId: SystemId) => Complaint | undefined;\r\n\r\n  // Actions - Workflow\r\n  assignComplaint: (id: SystemId, userId: SystemId, userName?: string) => void;\r\n  startInvestigation: (id: SystemId, note: string) => void;\r\n  submitEvidence: (id: SystemId, evidenceImages: string[], investigationNote: string, proposedSolution: string) => void;\r\n  verifyComplaint: (id: SystemId, isCorrect: boolean, note: string) => void;\r\n  resolveComplaint: (\r\n    id: SystemId,\r\n    resolution: ComplaintResolution,\r\n    resolutionNote: string,\r\n    responsibleUserId?: SystemId\r\n  ) => void;\r\n  rejectComplaint: (id: SystemId, reason: string) => void;\r\n\r\n  // Actions - Images\r\n  addComplaintImage: (id: SystemId, image: ComplaintImage) => void;\r\n  removeComplaintImage: (id: SystemId, imageId: SystemId) => void;\r\n\r\n  // Actions - Filters & Search\r\n  setFilters: (filters: Partial<ComplaintFilters>) => void;\r\n  resetFilters: () => void;\r\n  setSearchQuery: (query: string) => void;\r\n  setSelectedComplaint: (id: SystemId | null) => void;\r\n\r\n  // Computed\r\n  getFilteredComplaints: () => Complaint[];\r\n  getComplaintsByStatus: (status: ComplaintStatus) => Complaint[];\r\n  getComplaintsByAssignee: (userId: SystemId) => Complaint[];\r\n  getStats: () => {\r\n    total: number;\r\n    pending: number;\r\n    investigating: number;\r\n    resolved: number;\r\n    rejected: number;\r\n    verifiedCorrect: number;\r\n    verifiedIncorrect: number;\r\n  };\r\n}\r\n\r\n// =============================================\r\n// DEFAULT VALUES\r\n// =============================================\r\n\r\nconst defaultFilters: ComplaintFilters = {\r\n  status: \"all\",\r\n  type: \"all\",\r\n  verification: \"all\",\r\n  assignedTo: \"all\",\r\n  priority: \"all\",\r\n};\r\n\r\n// =============================================\r\n// STORE IMPLEMENTATION\r\n// =============================================\r\n\r\nexport const useComplaintStore = create<ComplaintStore>()(\r\n  (set, get) => ({\r\n      // Initial State - Load sample data if empty\r\n      complaints: complaintSeedData,\r\n      filters: defaultFilters,\r\n      searchQuery: \"\",\r\n      selectedComplaintId: null,\r\n\r\n      // =============================================\r\n      // CRUD ACTIONS (Using store-factory logic)\r\n      // =============================================\r\n\r\n      addComplaint: (complaintData) => {\r\n        const currentComplaints = get().complaints;\r\n        \r\n        const BUSINESS_PREFIX = ENTITY_PREFIXES['complaints']; // 'PKN'\r\n        const SYSTEM_PREFIX = 'COMPLAINT';\r\n        \r\n        // Generate SystemId (6 digits) - COMPLAINT000001, COMPLAINT000002\r\n        const maxSystemIdNumber = currentComplaints.length > 0\r\n          ? Math.max(...currentComplaints.map(c => {\r\n              const match = c.systemId.match(/COMPLAINT(\\d{6})/);\r\n              return match ? parseInt(match[1]) : 0;\r\n            }))\r\n          : 0;\r\n        const systemId = asSystemId(`${SYSTEM_PREFIX}${String(maxSystemIdNumber + 1).padStart(6, '0')}`);\r\n        \r\n        // Generate Business ID (6 digits) - PKN000001, PKN000002 (if not provided)\r\n        let idValue: BusinessId | null = complaintData.id ?? null;\r\n        let id: string = idValue ? String(idValue) : '';\r\n        if (!id) {\r\n          const maxBusinessIdNumber = currentComplaints.length > 0\r\n            ? Math.max(...currentComplaints.map(c => {\r\n                const match = c.id?.match(/PKN(\\d{6})/);\r\n                return match ? parseInt(match[1]) : 0;\r\n              }))\r\n            : 0;\r\n          id = `${BUSINESS_PREFIX}${String(maxBusinessIdNumber + 1).padStart(6, '0')}`;\r\n        } else {\r\n          // Validate unique ID (case-insensitive)\r\n          const existingIds = currentComplaints.map(c => c.id?.toLowerCase());\r\n          if (existingIds.includes(id.toLowerCase())) {\r\n            throw new Error(`M√£ \"${id}\" ƒë√£ t·ªìn t·∫°i! Vui l√≤ng s·ª≠ d·ª•ng m√£ kh√°c.`);\r\n          }\r\n          // Sanitize ID: uppercase + remove spaces\r\n          id = id.toUpperCase().trim().replace(/\\s+/g, '');\r\n        }\r\n        const businessId = asBusinessId(id);\r\n        \r\n        // [NOTE] Generate public tracking code for customer\r\n        const publicTrackingCode = (complaintData as any).publicTrackingCode || generatePublicTrackingCode();\r\n        \r\n        const now = new Date();\r\n\r\n        const initialAction: ComplaintAction = {\r\n          id: asSystemId(`action_${Date.now()}`),\r\n          actionType: \"created\",\r\n          performedBy: complaintData.createdBy,\r\n          performedAt: now,\r\n          note: complaintData.description,\r\n        };\r\n\r\n        const newComplaint: Complaint = {\r\n          ...complaintData,\r\n          systemId,\r\n          id: businessId,\r\n          publicTrackingCode, // [NOTE] Add tracking code\r\n          createdAt: now,\r\n          updatedAt: now,\r\n          status: \"pending\",\r\n          verification: \"pending-verification\",\r\n          timeline: [initialAction],\r\n        };\r\n\r\n        set((state) => ({\r\n          complaints: [newComplaint, ...state.complaints],\r\n        }));\r\n\r\n        return systemId; // Return systemId for internal use\r\n      },\r\n\r\n      updateComplaint: (systemId, updates) => {\r\n        set((state) => ({\r\n          complaints: state.complaints.map((complaint) =>\r\n            complaint.systemId === systemId\r\n              ? { ...complaint, ...updates, updatedAt: new Date() }\r\n              : complaint\r\n          ),\r\n        }));\r\n      },\r\n\r\n      deleteComplaint: (systemId) => {\r\n        set((state) => ({\r\n          complaints: state.complaints.filter((c) => c.systemId !== systemId),\r\n        }));\r\n      },\r\n\r\n      getComplaintById: (systemId) => {\r\n        return get().complaints.find((c) => c.systemId === systemId);\r\n      },\r\n\r\n      // =============================================\r\n      // WORKFLOW ACTIONS\r\n      // =============================================\r\n\r\n      assignComplaint: (id, userId, userName) => {\r\n        const complaint = get().complaints.find((c) => c.systemId === id);\r\n        if (!complaint) return;\r\n\r\n        const action: ComplaintAction = {\r\n          id: asSystemId(`action_${Date.now()}`),\r\n          actionType: \"assigned\",\r\n          performedBy: userId,\r\n          performedAt: new Date(),\r\n          note: userName \r\n            ? `Khi·∫øu n·∫°i ƒë∆∞·ª£c giao cho ${userName}` \r\n            : `Khi·∫øu n·∫°i ƒë∆∞·ª£c giao cho nh√¢n vi√™n x·ª≠ l√Ω`,\r\n        };\r\n\r\n        get().updateComplaint(id, {\r\n          assignedTo: userId,\r\n          assigneeName: userName,\r\n          assignedAt: new Date(),\r\n          status: \"investigating\",\r\n          timeline: [...complaint.timeline, action],\r\n        });\r\n      },\r\n\r\n      startInvestigation: (id, note) => {\r\n        const complaint = get().complaints.find((c) => c.systemId === id);\r\n        if (!complaint) return;\r\n\r\n        const action: ComplaintAction = {\r\n          id: asSystemId(`action_${Date.now()}`),\r\n          actionType: \"investigated\",\r\n          performedBy: complaint.assignedTo || complaint.createdBy,\r\n          performedAt: new Date(),\r\n          note,\r\n        };\r\n\r\n        get().updateComplaint(id, {\r\n          status: \"investigating\",\r\n          timeline: [...complaint.timeline, action],\r\n        });\r\n      },\r\n\r\n      submitEvidence: (id, evidenceImages, investigationNote, proposedSolution) => {\r\n        const complaint = get().complaints.find((c) => c.systemId === id);\r\n        if (!complaint) return;\r\n\r\n        const action: ComplaintAction = {\r\n          id: asSystemId(`action_${Date.now()}`),\r\n          actionType: \"investigated\",\r\n          performedBy: complaint.assignedTo || complaint.createdBy,\r\n          performedAt: new Date(),\r\n          note: investigationNote,\r\n          images: evidenceImages,\r\n        };\r\n\r\n        get().updateComplaint(id, {\r\n          evidenceImages,\r\n          investigationNote,\r\n          proposedSolution,\r\n          timeline: [...complaint.timeline, action],\r\n        });\r\n      },\r\n\r\n      verifyComplaint: (id, isCorrect, note) => {\r\n        const complaint = get().complaints.find((c) => c.systemId === id);\r\n        if (!complaint) return;\r\n\r\n        const action: ComplaintAction = {\r\n          id: asSystemId(`action_${Date.now()}`),\r\n          actionType: \"verified\",\r\n          performedBy: complaint.createdBy, // Manager verify\r\n          performedAt: new Date(),\r\n          note,\r\n        };\r\n\r\n        get().updateComplaint(id, {\r\n          verification: isCorrect ? \"verified-correct\" : \"verified-incorrect\",\r\n          isVerifiedCorrect: isCorrect,\r\n          timeline: [...complaint.timeline, action],\r\n        });\r\n      },\r\n\r\n      resolveComplaint: (id, resolution, resolutionNote, responsibleUserId) => {\r\n        const complaint = get().complaints.find((c) => c.systemId === id);\r\n        if (!complaint) return;\r\n\r\n        const action: ComplaintAction = {\r\n          id: asSystemId(`action_${Date.now()}`),\r\n          actionType: \"resolved\",\r\n          performedBy: complaint.createdBy, // Manager resolves\r\n          performedAt: new Date(),\r\n          note: resolutionNote,\r\n        };\r\n\r\n        const updatePayload: Partial<Complaint> = {\r\n          status: \"resolved\",\r\n          resolution,\r\n          resolutionNote,\r\n          resolvedBy: complaint.createdBy,\r\n          resolvedAt: new Date(),\r\n          timeline: [...complaint.timeline, action],\r\n        };\r\n        if (responsibleUserId) {\r\n          updatePayload.responsibleUserId = responsibleUserId;\r\n        }\r\n        get().updateComplaint(id, updatePayload);\r\n      },\r\n\r\n      rejectComplaint: (id, reason) => {\r\n        const complaint = get().complaints.find((c) => c.systemId === id);\r\n        if (!complaint) return;\r\n\r\n        const action: ComplaintAction = {\r\n          id: asSystemId(`action_${Date.now()}`),\r\n          actionType: \"rejected\",\r\n          performedBy: complaint.createdBy,\r\n          performedAt: new Date(),\r\n          note: reason,\r\n        };\r\n\r\n        get().updateComplaint(id, {\r\n          status: \"ended\",\r\n          resolution: \"rejected\",\r\n          resolutionNote: reason,\r\n          resolvedBy: complaint.createdBy,\r\n          resolvedAt: new Date(),\r\n          timeline: [...complaint.timeline, action],\r\n        });\r\n      },\r\n\r\n      // =============================================\r\n      // IMAGE ACTIONS\r\n      // =============================================\r\n\r\n      addComplaintImage: (id, image) => {\r\n        const complaint = get().complaints.find((c) => c.systemId === id);\r\n        if (!complaint) return;\r\n\r\n        get().updateComplaint(id, {\r\n          images: [...complaint.images, image],\r\n        });\r\n      },\r\n\r\n      removeComplaintImage: (id, imageId) => {\r\n        const complaint = get().complaints.find((c) => c.systemId === id);\r\n        if (!complaint) return;\r\n\r\n        get().updateComplaint(id, {\r\n          images: complaint.images.filter((img) => img.id !== imageId),\r\n        });\r\n      },\r\n\r\n      // =============================================\r\n      // FILTER & SEARCH ACTIONS\r\n      // =============================================\r\n\r\n      setFilters: (filters) => {\r\n        set((state) => ({\r\n          filters: { ...state.filters, ...filters },\r\n        }));\r\n      },\r\n\r\n      resetFilters: () => {\r\n        set({ filters: defaultFilters });\r\n      },\r\n\r\n      setSearchQuery: (query) => {\r\n        set({ searchQuery: query });\r\n      },\r\n\r\n      setSelectedComplaint: (id) => {\r\n        set({ selectedComplaintId: id });\r\n      },\r\n\r\n      // =============================================\r\n      // COMPUTED GETTERS\r\n      // =============================================\r\n\r\n      getFilteredComplaints: () => {\r\n        const { complaints, filters, searchQuery } = get();\r\n\r\n        return complaints.filter((complaint) => {\r\n          // Status filter\r\n          if (filters.status !== \"all\" && complaint.status !== filters.status) {\r\n            return false;\r\n          }\r\n\r\n          // Type filter\r\n          if (filters.type !== \"all\" && complaint.type !== filters.type) {\r\n            return false;\r\n          }\r\n\r\n          // Verification filter\r\n          if (filters.verification !== \"all\" && complaint.verification !== filters.verification) {\r\n            return false;\r\n          }\r\n\r\n          // Assignee filter\r\n          if (filters.assignedTo !== \"all\" && complaint.assignedTo !== filters.assignedTo) {\r\n            return false;\r\n          }\r\n\r\n          // Priority filter\r\n          if (filters.priority !== \"all\" && complaint.priority !== filters.priority) {\r\n            return false;\r\n          }\r\n\r\n          // Date range filter\r\n          if (filters.dateRange) {\r\n            const complaintDate = new Date(complaint.createdAt);\r\n            if (complaintDate < filters.dateRange.from || complaintDate > filters.dateRange.to) {\r\n              return false;\r\n            }\r\n          }\r\n\r\n          // Search query\r\n          if (searchQuery) {\r\n            const query = searchQuery.toLowerCase();\r\n            return (\r\n              (complaint.orderCode || complaint.orderSystemId).toLowerCase().includes(query) || // [NOTE] Fallback\r\n              complaint.customerName.toLowerCase().includes(query) ||\r\n              complaint.customerPhone.includes(query) ||\r\n              complaint.description.toLowerCase().includes(query) ||\r\n              complaint.id.toLowerCase().includes(query) // Search by business ID too\r\n            );\r\n          }\r\n\r\n          return true;\r\n        });\r\n      },\r\n\r\n      getComplaintsByStatus: (status) => {\r\n        return get().complaints.filter((c) => c.status === status);\r\n      },\r\n\r\n      getComplaintsByAssignee: (userId) => {\r\n        return get().complaints.filter((c) => c.assignedTo === userId);\r\n      },\r\n\r\n      getStats: () => {\r\n        const complaints = get().complaints;\r\n\r\n        return {\r\n          total: complaints.length,\r\n          pending: complaints.filter((c) => c.status === \"pending\").length,\r\n          investigating: complaints.filter((c) => c.status === \"investigating\").length,\r\n          resolved: complaints.filter((c) => c.status === \"resolved\").length,\r\n          rejected: complaints.filter((c) => c.resolution === \"rejected\").length,\r\n          verifiedCorrect: complaints.filter((c) => c.verification === \"verified-correct\").length,\r\n          verifiedIncorrect: complaints.filter((c) => c.verification === \"verified-incorrect\").length,\r\n        };\r\n      },\r\n    })\r\n);\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 7074, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/complaints/types.ts"],"sourcesContent":["// =============================================\r\n// COMPLAINT TYPES & INTERFACES\r\n// =============================================\r\n\r\nimport type { Subtask } from '../../components/shared/subtask-list';\r\nimport { type SystemId, type BusinessId } from '../../lib/id-types';\r\n\r\nexport type ComplaintType =\r\n  | \"wrong-product\" // Sai h√†ng\r\n  | \"missing-items\" // Thi·∫øu h√†ng\r\n  | \"wrong-packaging\" // ƒê√≥ng g√≥i sai quy c√°ch\r\n  | \"warehouse-defect\" // Tr·∫£ h√†ng l·ªói do kho\r\n  | \"product-condition\"; // Kh√°ch ph√†n n√†n v·ªÅ t√¨nh tr·∫°ng h√†ng\r\n\r\nexport type ComplaintStatus =\r\n  | \"pending\" // Ch·ªù x·ª≠ l√Ω\r\n  | \"investigating\" // ƒêang ki·ªÉm tra\r\n  | \"resolved\" // ƒê√£ gi·∫£i quy·∫øt\r\n  | \"cancelled\" // ƒê√£ h·ªßy\r\n  | \"ended\"; // K·∫øt th√∫c\r\n\r\nexport type ComplaintResolution =\r\n  | \"refund\" // Tr·ª´ ti·ªÅn v√†o ƒë∆°n h√†ng\r\n  | \"return-shipping\" // G·ª≠i tr·∫£ h√†ng (shop ch·ªãu ph√≠)\r\n  | \"advice-only\" // T∆∞ v·∫•n/h·ªó tr·ª£\r\n  | \"replacement\" // ƒê·ªïi s·∫£n ph·∫©m\r\n  | \"rejected\"; // Kh√¥ng ch·∫•p nh·∫≠n\r\n\r\nexport type ComplaintVerification =\r\n  | \"verified-correct\" // X√°c nh·∫≠n ƒë√∫ng\r\n  | \"verified-incorrect\" // X√°c nh·∫≠n sai\r\n  | \"pending-verification\"; // Ch∆∞a x√°c minh\r\n\r\nexport interface ComplaintImage {\r\n  id: SystemId;\r\n  url: string;\r\n  uploadedBy: SystemId; // userId (branded)\r\n  uploadedAt: Date;\r\n  description?: string;\r\n  type: \"initial\" | \"evidence\"; // initial = t·ª´ kh√°ch, evidence = b·∫±ng ch·ª©ng t·ª´ nh√¢n vi√™n\r\n}\r\n\r\nexport interface ComplaintAction {\r\n  id: SystemId;\r\n  actionType: \r\n    | \"created\" \r\n    | \"assigned\" \r\n    | \"investigated\" \r\n    | \"verified\" \r\n    | \"verified-correct\"\r\n    | \"verified-incorrect\"\r\n    | \"resolved\" \r\n    | \"rejected\" \r\n    | \"cancelled\"\r\n    | \"ended\"\r\n    | \"reopened\"\r\n    | \"status-changed\"\r\n    | \"commented\";\r\n  performedBy: SystemId; // userId (branded)\r\n  performedAt: Date;\r\n  note?: string;\r\n  images?: string[]; // image ids\r\n  metadata?: Record<string, any>; // Additional data for specific actions\r\n}\r\n\r\nexport interface Complaint {\r\n  systemId: SystemId; // System-generated, immutable - d√πng trong code (branded)\r\n  id: BusinessId; // User-facing, auto-generated t·ª´ systemId - d√πng hi·ªÉn th·ªã (VD: COM001) (branded)\r\n  publicTrackingCode?: string; // M√£ tracking c√¥ng khai random (VD: rb5n8xzhrm) - cho kh√°ch h√†ng tra c·ª©u\r\n  \r\n  // Th√¥ng tin ƒë∆°n h√†ng li√™n quan\r\n  orderSystemId: SystemId; // SystemId c·ªßa ƒë∆°n h√†ng (ORD00000001) - d√πng ƒë·ªÉ query (branded)\r\n  orderCode?: string; // M√£ ƒë∆°n h√†ng hi·ªÉn th·ªã (ORD001) - ch·ªâ ƒë·ªÉ hi·ªÉn th·ªã, c√≥ th·ªÉ l·∫•y t·ª´ order\r\n  orderValue?: number; // Gi√° tr·ªã ƒë∆°n h√†ng\r\n  \r\n  // Th√¥ng tin chi nh√°nh (l·∫•y t·ª´ ƒë∆°n h√†ng)\r\n  branchSystemId: SystemId; // SystemId c·ªßa chi nh√°nh (t·ª´ order.branchSystemId) (branded)\r\n  branchName: string; // T√™n chi nh√°nh (t·ª´ order.branchName)\r\n  \r\n  // Th√¥ng tin kh√°ch h√†ng\r\n  customerSystemId: SystemId; // SystemId c·ªßa kh√°ch h√†ng (CUS00000001) - d√πng ƒë·ªÉ query (branded)\r\n  customerId?: string; // M√£ kh√°ch h√†ng hi·ªÉn th·ªã (CUS001) - ch·ªâ ƒë·ªÉ hi·ªÉn th·ªã\r\n  customerName: string;\r\n  customerPhone: string;\r\n\r\n  // Th√¥ng tin khi·∫øu n·∫°i\r\n  type: ComplaintType;\r\n  description: string; // M√¥ t·∫£ ban ƒë·∫ßu t·ª´ manager/kh√°ch\r\n  images: ComplaintImage[]; // H√¨nh ·∫£nh t·ª´ kh√°ch (type: 'initial')\r\n  employeeImages?: Array<{  // H√¨nh ·∫£nh t·ª´ nh√¢n vi√™n ki·ªÉm tra (field ri√™ng)\r\n    id: SystemId;\r\n    url: string;\r\n    uploadedBy: SystemId;  // (branded)\r\n    uploadedAt: Date;\r\n  }>;\r\n\r\n  // Tr·∫°ng th√°i\r\n  status: ComplaintStatus;\r\n  verification: ComplaintVerification;\r\n  resolution?: ComplaintResolution;\r\n\r\n  // Ng∆∞·ªùi x·ª≠ l√Ω\r\n  createdBy: SystemId; // userId - Manager t·∫°o (branded)\r\n  createdAt: Date;\r\n  assignedTo?: SystemId; // userId - Nh√¢n vi√™n ƒë∆∞·ª£c giao x·ª≠ l√Ω (branded)\r\n  assigneeName?: string; // T√™n nh√¢n vi√™n x·ª≠ l√Ω (denormalized for display)\r\n  assignedAt?: Date;\r\n\r\n  // X·ª≠ l√Ω\r\n  investigationNote?: string; // Ghi ch√∫ ki·ªÉm tra t·ª´ nh√¢n vi√™n\r\n  evidenceImages?: string[]; // H√¨nh ·∫£nh camera, b·∫±ng ch·ª©ng\r\n  proposedSolution?: string; // ƒê·ªÅ xu·∫•t gi·∫£i ph√°p t·ª´ nh√¢n vi√™n\r\n  resolutionNote?: string; // Ghi ch√∫ c√°ch x·ª≠ l√Ω cu·ªëi c√πng\r\n\r\n  // KPI\r\n  isVerifiedCorrect?: boolean; // true = l·ªói th·∫≠t, false = kh√°ch sai\r\n  responsibleUserId?: SystemId; // Ng∆∞·ªùi ch·ªãu tr√°ch nhi·ªám (n·∫øu l·ªói ƒë√∫ng) (branded)\r\n  \r\n  // NEW: Qu·∫£n l√Ω s·∫£n ph·∫©m thi·∫øu/l·ªói t·ª´ ƒë∆°n h√†ng\r\n  affectedProducts?: Array<{\r\n      productSystemId: SystemId;\r\n    productId: string;           // SKU\r\n    productName: string;\r\n    unitPrice: number;           // NEW: Gi√° ƒë∆°n v·ªã\r\n    quantityOrdered: number;     // S·ªë l∆∞·ª£ng tr√™n ƒë∆°n\r\n    quantityReceived: number;    // S·ªë l∆∞·ª£ng kh√°ch nh·∫≠n ƒë∆∞·ª£c\r\n    quantityMissing: number;     // S·ªë l∆∞·ª£ng thi·∫øu\r\n    quantityDefective: number;   // S·ªë l∆∞·ª£ng h·ªèng/l·ªói\r\n    quantityExcess: number;      // NEW: S·ªë l∆∞·ª£ng th·ª´a\r\n    issueType: 'excess' | 'missing' | 'defective' | 'other'; // NEW: Lo·∫°i v·∫•n ƒë·ªÅ\r\n    note?: string;               // Ghi ch√∫ chung\r\n    resolutionType?: 'refund' | 'replacement' | 'ignore'; // C√°ch x·ª≠ l√Ω\r\n  }>;\r\n  \r\n  // NEW: Theo d√µi ƒëi·ªÅu ch·ªânh kho\r\n  inventoryAdjustment?: {\r\n    adjusted: boolean;           // ƒê√£ ƒëi·ªÅu ch·ªânh kho ch∆∞a\r\n    adjustedBy: SystemId;  // (branded)\r\n    adjustedAt: Date;\r\n    adjustmentNote: string;\r\n    inventoryCheckSystemId?: SystemId;  // ‚úÖ Foreign Key - Link to Inventory Check (branded)\r\n    items: Array<{\r\n      productSystemId: SystemId;  // (branded)\r\n      productId: string;\r\n      productName: string;\r\n      quantityAdjusted: number;  // S·ªë l∆∞·ª£ng c·ªông l·∫°i (+) ho·∫∑c tr·ª´ (-)\r\n      reason: string;\r\n      branchSystemId: SystemId;  // (branded)\r\n    }>;\r\n  };\r\n  \r\n  // NEW: L·ªãch s·ª≠ phi·∫øu chi/thu ƒë√£ h·ªßy (khi reopen/cancel/change verification)\r\n  cancelledPaymentsReceipts?: Array<{\r\n    paymentReceiptSystemId: SystemId;\r\n    paymentReceiptId: BusinessId;    // PC001, PT001\r\n    type: 'payment' | 'receipt';\r\n    amount: number;\r\n    cancelledAt: Date;\r\n    cancelledBy: SystemId;  // (branded)\r\n    cancelledReason: string;     // \"M·ªü l·∫°i khi·∫øu n·∫°i\", \"H·ªßy khi·∫øu n·∫°i\", \"ƒê·ªïi verification\"\r\n  }>;\r\n  \r\n  // NEW: L·ªãch s·ª≠ thay ƒë·ªïi kho (tracking m·ªçi l·∫ßn ƒëi·ªÅu ch·ªânh v√† reverse)\r\n  inventoryHistory?: Array<{\r\n    adjustedAt: Date;\r\n    adjustedBy: SystemId;  // (branded)\r\n    adjustmentType: 'initial' | 'reversed';  // initial = ƒëi·ªÅu ch·ªânh l·∫ßn ƒë·∫ßu, reversed = kh√¥i ph·ª•c\r\n    reason: string;                          // \"X√°c nh·∫≠n ƒë√∫ng - ƒëi·ªÅu ch·ªânh kho\", \"M·ªü l·∫°i - kh√¥i ph·ª•c kho\"\r\n    items: Array<{\r\n      productSystemId: SystemId;  // (branded)\r\n      productId: string;\r\n      productName: string;\r\n      quantityAdjusted: number;              // S·ªë l∆∞·ª£ng ƒë√£ thay ƒë·ªïi (+/-)\r\n      branchSystemId: SystemId;  // (branded)\r\n    }>;\r\n  }>;\r\n  \r\n  // Metadata\r\n  resolvedBy?: SystemId; // userId - Ng∆∞·ªùi gi·∫£i quy·∫øt (branded)\r\n  resolvedAt?: Date;\r\n  cancelledBy?: SystemId; // userId - Ng∆∞·ªùi h·ªßy (branded)\r\n  cancelledAt?: Date;\r\n  endedBy?: SystemId; // userId - Ng∆∞·ªùi k·∫øt th√∫c (branded)\r\n  endedAt?: Date;\r\n  updatedAt: Date;\r\n  priority: \"low\" | \"medium\" | \"high\" | \"urgent\";\r\n  tags?: string[];\r\n\r\n  // Timeline\r\n  timeline: ComplaintAction[];\r\n\r\n  // Workflow\r\n  subtasks?: Subtask[]; // Quy tr√¨nh x·ª≠ l√Ω khi·∫øu n·∫°i\r\n}\r\n\r\n// =============================================\r\n// CONSTANTS\r\n// =============================================\r\n\r\nexport const complaintTypeLabels: Record<ComplaintType, string> = {\r\n  \"wrong-product\": \"Sai h√†ng\",\r\n  \"missing-items\": \"Thi·∫øu h√†ng\",\r\n  \"wrong-packaging\": \"ƒê√≥ng g√≥i sai quy c√°ch\",\r\n  \"warehouse-defect\": \"Tr·∫£ h√†ng l·ªói do kho\",\r\n  \"product-condition\": \"Ph√†n n√†n v·ªÅ t√¨nh tr·∫°ng h√†ng\",\r\n};\r\n\r\nexport const complaintTypeColors: Record<ComplaintType, string> = {\r\n  \"wrong-product\": \"bg-red-500/10 text-red-700 border-red-200\",\r\n  \"missing-items\": \"bg-orange-500/10 text-orange-700 border-orange-200\",\r\n  \"wrong-packaging\": \"bg-yellow-500/10 text-yellow-700 border-yellow-200\",\r\n  \"warehouse-defect\": \"bg-purple-500/10 text-purple-700 border-purple-200\",\r\n  \"product-condition\": \"bg-pink-500/10 text-pink-700 border-pink-200\",\r\n};\r\n\r\nexport const complaintStatusLabels: Record<ComplaintStatus, string> = {\r\n  pending: \"Ch·ªù x·ª≠ l√Ω\",\r\n  investigating: \"ƒêang ki·ªÉm tra\",\r\n  resolved: \"ƒê√£ gi·∫£i quy·∫øt\",\r\n  cancelled: \"ƒê√£ h·ªßy\",\r\n  ended: \"K·∫øt th√∫c\",\r\n};\r\n\r\nexport const complaintStatusColors: Record<ComplaintStatus, string> = {\r\n  pending: \"bg-gray-500/10 text-gray-700 border-gray-200\",\r\n  investigating: \"bg-blue-500/10 text-blue-700 border-blue-200\",\r\n  resolved: \"bg-green-500/10 text-green-700 border-green-200\",\r\n  cancelled: \"bg-red-500/10 text-red-700 border-red-200\",\r\n  ended: \"bg-purple-500/10 text-purple-700 border-purple-200\",\r\n};\r\n\r\nexport const complaintResolutionLabels: Record<ComplaintResolution, string> = {\r\n  refund: \"Tr·ª´ ti·ªÅn v√†o ƒë∆°n h√†ng\",\r\n  \"return-shipping\": \"G·ª≠i tr·∫£ h√†ng (shop ch·ªãu ph√≠)\",\r\n  \"advice-only\": \"T∆∞ v·∫•n/H·ªó tr·ª£\",\r\n  replacement: \"ƒê·ªïi s·∫£n ph·∫©m\",\r\n  rejected: \"T·ª´ ch·ªëi khi·∫øu n·∫°i\",\r\n};\r\n\r\nexport const complaintVerificationLabels: Record<ComplaintVerification, string> = {\r\n  \"verified-correct\": \"X√°c nh·∫≠n ƒë√∫ng\",\r\n  \"verified-incorrect\": \"X√°c nh·∫≠n sai\",\r\n  \"pending-verification\": \"Ch∆∞a x√°c minh\",\r\n};\r\n\r\nexport const complaintVerificationColors: Record<ComplaintVerification, string> = {\r\n  \"verified-correct\": \"bg-red-500/10 text-red-700 border-red-200\",\r\n  \"verified-incorrect\": \"bg-green-500/10 text-green-700 border-green-200\",\r\n  \"pending-verification\": \"bg-gray-500/10 text-gray-700 border-gray-200\",\r\n};\r\n\r\nexport const complaintPriorityLabels = {\r\n  low: \"Th·∫•p\",\r\n  medium: \"Trung b√¨nh\",\r\n  high: \"Cao\",\r\n  urgent: \"Kh·∫©n c·∫•p\",\r\n};\r\n\r\nexport const complaintPriorityColors = {\r\n  low: \"bg-gray-500/10 text-gray-700 border-gray-200\",\r\n  medium: \"bg-blue-500/10 text-blue-700 border-blue-200\",\r\n  high: \"bg-orange-500/10 text-orange-700 border-orange-200\",\r\n  urgent: \"bg-red-500/10 text-red-700 border-red-200\",\r\n};\r\n\r\n// =============================================\r\n// HELPER FUNCTIONS\r\n// =============================================\r\n\r\nexport function getComplaintTypeLabel(type: ComplaintType): string {\r\n  return complaintTypeLabels[type];\r\n}\r\n\r\nexport function getComplaintStatusLabel(status: ComplaintStatus): string {\r\n  return complaintStatusLabels[status];\r\n}\r\n\r\nexport function getComplaintResolutionLabel(resolution: ComplaintResolution): string {\r\n  return complaintResolutionLabels[resolution];\r\n}\r\n"],"names":[],"mappings":"AAAA,gDAAgD;AAChD,+BAA+B;AAC/B,gDAAgD;;;;;;;;;;;;;;;;;;;;;;;;;;;AAqMzC,MAAM,sBAAqD;IAChE,iBAAiB;IACjB,iBAAiB;IACjB,mBAAmB;IACnB,oBAAoB;IACpB,qBAAqB;AACvB;AAEO,MAAM,sBAAqD;IAChE,iBAAiB;IACjB,iBAAiB;IACjB,mBAAmB;IACnB,oBAAoB;IACpB,qBAAqB;AACvB;AAEO,MAAM,wBAAyD;IACpE,SAAS;IACT,eAAe;IACf,UAAU;IACV,WAAW;IACX,OAAO;AACT;AAEO,MAAM,wBAAyD;IACpE,SAAS;IACT,eAAe;IACf,UAAU;IACV,WAAW;IACX,OAAO;AACT;AAEO,MAAM,4BAAiE;IAC5E,QAAQ;IACR,mBAAmB;IACnB,eAAe;IACf,aAAa;IACb,UAAU;AACZ;AAEO,MAAM,8BAAqE;IAChF,oBAAoB;IACpB,sBAAsB;IACtB,wBAAwB;AAC1B;AAEO,MAAM,8BAAqE;IAChF,oBAAoB;IACpB,sBAAsB;IACtB,wBAAwB;AAC1B;AAEO,MAAM,0BAA0B;IACrC,KAAK;IACL,QAAQ;IACR,MAAM;IACN,QAAQ;AACV;AAEO,MAAM,0BAA0B;IACrC,KAAK;IACL,QAAQ;IACR,MAAM;IACN,QAAQ;AACV;AAMO,SAAS,sBAAsB,IAAmB;IACvD,OAAO,mBAAmB,CAAC,KAAK;AAClC;AAEO,SAAS,wBAAwB,MAAuB;IAC7D,OAAO,qBAAqB,CAAC,OAAO;AACtC;AAEO,SAAS,4BAA4B,UAA+B;IACzE,OAAO,yBAAyB,CAAC,WAAW;AAC9C"}},
    {"offset": {"line": 7173, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/reports/customer-sla-report/sla-utils.ts"],"sourcesContent":["import type { Customer } from '../../customers/types';\r\nimport type { CustomerSlaSetting } from '../../settings/customers/types';\r\nimport type { \r\n  CustomerSlaAlert, \r\n  DebtAlert, \r\n  CustomerHealthAlert, \r\n  SlaAlertLevel,\r\n  ReportSummary \r\n} from './types';\r\nimport { differenceInDays, parseISO, format } from 'date-fns';\r\n\r\n/**\r\n * T√≠nh to√°n alert level d·ª±a tr√™n s·ªë ng√†y c√≤n l·∫°i v√† c·∫•u h√¨nh SLA\r\n * - daysRemaining < 0 means overdue\r\n * - criticalDays = s·ªë ng√†y qu√° h·∫°n ƒë·ªÉ coi l√† nghi√™m tr·ªçng\r\n * - warningDays = s·ªë ng√†y TR∆Ø·ªöC target ƒë·ªÉ b·∫Øt ƒë·∫ßu c·∫£nh b√°o\r\n */\r\nexport function calculateAlertLevel(\r\n  daysRemaining: number, \r\n  slaSetting: CustomerSlaSetting\r\n): SlaAlertLevel {\r\n  if (daysRemaining < -slaSetting.criticalDays) return 'overdue'; // Qu√° h·∫°n > criticalDays ng√†y\r\n  if (daysRemaining < 0) return 'critical'; // Qu√° h·∫°n nh∆∞ng ch∆∞a ƒë·∫øn criticalDays\r\n  if (daysRemaining <= slaSetting.warningDays) return 'warning'; // C√≤n <= warningDays ng√†y\r\n  return 'normal';\r\n}\r\n\r\n/**\r\n * L·∫•y danh s√°ch kh√°ch h√†ng c·∫ßn follow-up (li√™n h·ªá ƒë·ªãnh k·ª≥)\r\n */\r\nexport function getFollowUpAlerts(\r\n  customers: Customer[],\r\n  slaSettings: CustomerSlaSetting[]\r\n): CustomerSlaAlert[] {\r\n  // Simplified: only 1 SLA per type\r\n  const followUpSla = slaSettings.find(s => s.slaType === 'follow-up' && s.isActive);\r\n  \r\n  if (!followUpSla) return [];\r\n\r\n  const today = new Date();\r\n  const alerts: CustomerSlaAlert[] = [];\r\n\r\n  for (const customer of customers) {\r\n    if (customer.isDeleted || customer.status === 'Ng·ª´ng Giao D·ªãch') continue;\r\n\r\n    // L·∫•y ng√†y li√™n h·ªá cu·ªëi (d·ª±a tr√™n lastPurchaseDate ho·∫∑c updatedAt)\r\n    const lastContactDate = customer.lastPurchaseDate \r\n      || customer.updatedAt \r\n      || customer.createdAt;\r\n    \r\n    if (!lastContactDate) continue;\r\n\r\n    const lastContact = parseISO(lastContactDate);\r\n    const daysSinceContact = differenceInDays(today, lastContact);\r\n    const daysRemaining = followUpSla.targetDays - daysSinceContact;\r\n\r\n    // Hi·ªÉn th·ªã alert khi c√≤n <= warningDays ng√†y ho·∫∑c ƒë√£ qu√° h·∫°n\r\n    if (daysRemaining <= followUpSla.warningDays) {\r\n      alerts.push({\r\n        systemId: customer.systemId,\r\n        customer,\r\n        slaType: 'follow-up',\r\n        slaName: followUpSla.name,\r\n        daysRemaining,\r\n        alertLevel: calculateAlertLevel(daysRemaining, followUpSla),\r\n        targetDate: format(\r\n          new Date(lastContact.getTime() + followUpSla.targetDays * 24 * 60 * 60 * 1000),\r\n          'yyyy-MM-dd'\r\n        ),\r\n        lastActivityDate: lastContactDate,\r\n        ...(customer.accountManagerName ? { assignee: customer.accountManagerName } : {}),\r\n      });\r\n    }\r\n  }\r\n\r\n  return alerts.sort((a, b) => a.daysRemaining - b.daysRemaining);\r\n}\r\n\r\n/**\r\n * L·∫•y danh s√°ch kh√°ch h√†ng c·∫ßn k√≠ch ho·∫°t l·∫°i (kh√¥ng ho·∫°t ƒë·ªông l√¢u)\r\n */\r\nexport function getReEngagementAlerts(\r\n  customers: Customer[],\r\n  slaSettings: CustomerSlaSetting[]\r\n): CustomerSlaAlert[] {\r\n  // Simplified: only 1 SLA per type\r\n  const reEngageSla = slaSettings.find(s => s.slaType === 're-engagement' && s.isActive);\r\n  \r\n  if (!reEngageSla) return [];\r\n\r\n  const today = new Date();\r\n  const alerts: CustomerSlaAlert[] = [];\r\n\r\n  for (const customer of customers) {\r\n    if (customer.isDeleted || customer.status === 'Ng·ª´ng Giao D·ªãch') continue;\r\n\r\n    // Ch·ªâ x√©t kh√°ch ƒë√£ t·ª´ng mua h√†ng\r\n    if (!customer.lastPurchaseDate || !customer.totalOrders) continue;\r\n\r\n    const lastPurchase = parseISO(customer.lastPurchaseDate);\r\n    const daysSincePurchase = differenceInDays(today, lastPurchase);\r\n    const daysRemaining = reEngageSla.targetDays - daysSincePurchase;\r\n\r\n    // Hi·ªÉn th·ªã alert khi c√≤n <= warningDays ng√†y ho·∫∑c ƒë√£ qu√° h·∫°n\r\n    if (daysRemaining <= reEngageSla.warningDays) {\r\n      alerts.push({\r\n        systemId: customer.systemId,\r\n        customer,\r\n        slaType: 're-engagement',\r\n        slaName: reEngageSla.name,\r\n        daysRemaining,\r\n        alertLevel: calculateAlertLevel(daysRemaining, reEngageSla),\r\n        targetDate: format(\r\n          new Date(lastPurchase.getTime() + reEngageSla.targetDays * 24 * 60 * 60 * 1000),\r\n          'yyyy-MM-dd'\r\n        ),\r\n        lastActivityDate: customer.lastPurchaseDate,\r\n        ...(customer.accountManagerName ? { assignee: customer.accountManagerName } : {}),\r\n      });\r\n    }\r\n  }\r\n\r\n  return alerts.sort((a, b) => a.daysRemaining - b.daysRemaining);\r\n}\r\n\r\n/**\r\n * L·∫•y danh s√°ch kh√°ch h√†ng c√≥ v·∫•n ƒë·ªÅ c√¥ng n·ª£\r\n */\r\nexport function getDebtAlerts(customers: Customer[]): DebtAlert[] {\r\n  const alerts: DebtAlert[] = [];\r\n\r\n  for (const customer of customers) {\r\n    if (customer.isDeleted) continue;\r\n\r\n    // Ch·ªâ x√©t kh√°ch c√≥ c√¥ng n·ª£\r\n    const currentDebt = customer.currentDebt || 0;\r\n    if (currentDebt <= 0) continue;\r\n\r\n    // T√≠nh s·ªë ti·ªÅn qu√° h·∫°n v√† ng√†y qu√° h·∫°n\r\n    let overdueAmount = 0;\r\n    let maxDaysOverdue = 0;\r\n    let oldestDueDate: string | undefined;\r\n\r\n    if (customer.debtTransactions) {\r\n      const today = new Date();\r\n      for (const txn of customer.debtTransactions) {\r\n        if (txn.isPaid) continue;\r\n        \r\n        const dueDate = parseISO(txn.dueDate);\r\n        const daysOverdue = differenceInDays(today, dueDate);\r\n        \r\n        if (daysOverdue > 0) {\r\n          overdueAmount += txn.remainingAmount || txn.amount;\r\n          if (daysOverdue > maxDaysOverdue) {\r\n            maxDaysOverdue = daysOverdue;\r\n            oldestDueDate = txn.dueDate;\r\n          }\r\n        }\r\n      }\r\n    }\r\n\r\n    // L·∫•y debtStatus t·ª´ customer ho·∫∑c t√≠nh to√°n\r\n    const debtStatus = customer.debtStatus || 'Ch∆∞a ƒë·∫øn h·∫°n';\r\n\r\n    // Ch·ªâ hi·ªÉn th·ªã n·∫øu c√≥ n·ª£ qu√° h·∫°n ho·∫∑c s·∫Øp ƒë·∫øn h·∫°n\r\n    if (overdueAmount > 0 || debtStatus !== 'Ch∆∞a ƒë·∫øn h·∫°n') {\r\n      alerts.push({\r\n        systemId: customer.systemId,\r\n        customer,\r\n        totalDebt: currentDebt,\r\n        overdueAmount,\r\n        daysOverdue: maxDaysOverdue,\r\n        debtStatus,\r\n        ...(oldestDueDate ? { oldestDueDate } : {}),\r\n      });\r\n    }\r\n  }\r\n\r\n  return alerts.sort((a, b) => b.daysOverdue - a.daysOverdue);\r\n}\r\n\r\n/**\r\n * L·∫•y danh s√°ch kh√°ch h√†ng c√≥ r·ªßi ro churn cao\r\n */\r\nexport function getHealthAlerts(customers: Customer[]): CustomerHealthAlert[] {\r\n  const today = new Date();\r\n  const alerts: CustomerHealthAlert[] = [];\r\n\r\n  for (const customer of customers) {\r\n    if (customer.isDeleted || customer.status === 'Ng·ª´ng Giao D·ªãch') continue;\r\n\r\n    const healthScore = customer.healthScore || 50;\r\n    const churnRisk = customer.churnRisk || 'low';\r\n\r\n    // Ch·ªâ hi·ªÉn th·ªã n·∫øu c√≥ r·ªßi ro medium ho·∫∑c high, ho·∫∑c health score < 50\r\n    if (churnRisk !== 'low' || healthScore < 50) {\r\n      const daysSinceLastPurchase = customer.lastPurchaseDate\r\n        ? differenceInDays(today, parseISO(customer.lastPurchaseDate))\r\n        : 999;\r\n\r\n      alerts.push({\r\n        systemId: customer.systemId,\r\n        customer,\r\n        healthScore,\r\n        churnRisk,\r\n        ...(customer.segment ? { segment: customer.segment } : {}),\r\n        daysSinceLastPurchase,\r\n        totalOrders: customer.totalOrders || 0,\r\n        totalSpent: customer.totalSpent || 0,\r\n      });\r\n    }\r\n  }\r\n\r\n  return alerts.sort((a, b) => a.healthScore - b.healthScore);\r\n}\r\n\r\n/**\r\n * T√≠nh to√°n summary cho report\r\n */\r\nexport function calculateReportSummary(\r\n  customers: Customer[],\r\n  slaSettings: CustomerSlaSetting[]\r\n): ReportSummary {\r\n  const followUpAlerts = getFollowUpAlerts(customers, slaSettings);\r\n  const reEngagementAlerts = getReEngagementAlerts(customers, slaSettings);\r\n  const debtAlerts = getDebtAlerts(customers);\r\n  const healthAlerts = getHealthAlerts(customers);\r\n\r\n  const criticalCount = \r\n    followUpAlerts.filter(a => a.alertLevel === 'critical' || a.alertLevel === 'overdue').length +\r\n    reEngagementAlerts.filter(a => a.alertLevel === 'critical' || a.alertLevel === 'overdue').length +\r\n    debtAlerts.filter(a => a.daysOverdue > 15).length +\r\n    healthAlerts.filter(a => a.churnRisk === 'high').length;\r\n\r\n  return {\r\n    totalCustomers: customers.filter(c => !c.isDeleted).length,\r\n    followUpAlerts: followUpAlerts.length,\r\n    reEngagementAlerts: reEngagementAlerts.length,\r\n    debtAlerts: debtAlerts.length,\r\n    healthAlerts: healthAlerts.length,\r\n    criticalCount,\r\n  };\r\n}\r\n\r\n/**\r\n * Format s·ªë ng√†y c√≤n l·∫°i th√†nh text\r\n */\r\nexport function formatDaysRemaining(days: number): string {\r\n  if (days < 0) return `Qu√° ${Math.abs(days)} ng√†y`;\r\n  if (days === 0) return 'H√¥m nay';\r\n  return `C√≤n ${days} ng√†y`;\r\n}\r\n\r\n/**\r\n * Get color class based on alert level\r\n */\r\nexport function getAlertLevelColor(level: SlaAlertLevel): string {\r\n  switch (level) {\r\n    case 'overdue': return 'text-red-600 bg-red-50';\r\n    case 'critical': return 'text-orange-600 bg-orange-50';\r\n    case 'warning': return 'text-yellow-600 bg-yellow-50';\r\n    default: return 'text-green-600 bg-green-50';\r\n  }\r\n}\r\n\r\n/**\r\n * Get badge variant based on alert level\r\n */\r\nexport function getAlertBadgeVariant(level: SlaAlertLevel): 'destructive' | 'warning' | 'default' | 'secondary' {\r\n  switch (level) {\r\n    case 'overdue': return 'destructive';\r\n    case 'critical': return 'warning';\r\n    case 'warning': return 'default';\r\n    default: return 'secondary';\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}}]
}