{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/lib/id-types.ts"],"sourcesContent":["/**\r\n * Type-safe ID System\r\n * \r\n * Prevents mixing systemId with business ID at compile time\r\n */\r\n\r\n// Branded types for type safety\r\nexport type SystemId = string & { readonly __brand: 'SystemId' };\r\nexport type BusinessId = string & { readonly __brand: 'BusinessId' };\r\n\r\n/**\r\n * Create a SystemId from a string\r\n * Use this when you know for sure it's a systemId\r\n */\r\nexport function asSystemId(id: string): SystemId {\r\n  return id as SystemId;\r\n}\r\n\r\n/**\r\n * Create a BusinessId from a string\r\n * Use this when you know for sure it's a business ID\r\n */\r\nexport function asBusinessId(id: string): BusinessId {\r\n  return id as BusinessId;\r\n}\r\n\r\n/**\r\n * Check if a string is a valid systemId format\r\n */\r\nexport function isSystemIdFormat(id: string): boolean {\r\n  // SystemId: 8 digits + prefix (e.g., NV00000001, VOUCHER00000123)\r\n  return /^[A-Z]+\\d{8}$/.test(id);\r\n}\r\n\r\n/**\r\n * Check if a string is a valid business ID format\r\n */\r\nexport function isBusinessIdFormat(id: string): boolean {\r\n  // Business ID: shorter, variable length (e.g., NV001, PT000001)\r\n  return /^[A-Z]+\\d{3,6}$/.test(id);\r\n}\r\n\r\n/**\r\n * Safely convert unknown ID to proper type\r\n */\r\nexport function parseId(id: string): { type: 'system' | 'business'; value: SystemId | BusinessId } {\r\n  if (isSystemIdFormat(id)) {\r\n    return { type: 'system', value: asSystemId(id) };\r\n  }\r\n  if (isBusinessIdFormat(id)) {\r\n    return { type: 'business', value: asBusinessId(id) };\r\n  }\r\n  throw new Error(`Invalid ID format: ${id}`);\r\n}\r\n\r\n/**\r\n * ID Pair - Always keep systemId and businessId together\r\n */\r\nexport interface IDPair {\r\n  systemId: SystemId;\r\n  businessId: BusinessId;\r\n}\r\n\r\n/**\r\n * Entity with dual IDs\r\n */\r\nexport interface DualIDEntity {\r\n  systemId: SystemId;\r\n  id: BusinessId;\r\n}\r\n\r\n/**\r\n * Store methods with type-safe IDs\r\n */\r\nexport interface TypeSafeStore<T extends DualIDEntity> {\r\n  /** Find by systemId (for queries, relationships) */\r\n  findBySystemId(systemId: SystemId): T | null;\r\n  \r\n  /** Find by business ID (for user input, display) */\r\n  findByBusinessId(businessId: BusinessId): T | null;\r\n  \r\n  /** Update by systemId (always use systemId for updates) */\r\n  updateBySystemId(systemId: SystemId, updates: Partial<T>): void;\r\n  \r\n  /** Delete by systemId (always use systemId for deletes) */\r\n  deleteBySystemId(systemId: SystemId): void;\r\n}\r\n\r\n/**\r\n * Route params with type-safe IDs\r\n */\r\nexport interface RouteParams {\r\n  systemId?: SystemId;\r\n  id?: BusinessId;\r\n}\r\n\r\n/**\r\n * Link builder - always uses systemId\r\n */\r\nexport function buildEntityLink(path: string, entity: DualIDEntity): string {\r\n  return path.replace(':systemId', entity.systemId);\r\n}\r\n\r\n/**\r\n * Display ID - always uses business ID\r\n */\r\nexport function getDisplayId(entity: DualIDEntity): string {\r\n  return entity.id;\r\n}\r\n\r\n/**\r\n * Runtime guard: ensures a string is valid SystemId format and casts it\r\n * Logs warning if format is invalid\r\n */\r\nexport function ensureSystemId(id: string, context?: string): SystemId {\r\n  if (!isSystemIdFormat(id)) {\r\n    console.warn(`[ensureSystemId] Invalid SystemId format: \"${id}\"${context ? ` in ${context}` : ''}`);\r\n  }\r\n  return asSystemId(id);\r\n}\r\n\r\n/**\r\n * Runtime guard: ensures a string is valid BusinessId format and casts it\r\n * Logs warning if format is invalid\r\n */\r\nexport function ensureBusinessId(id: string, context?: string): BusinessId {\r\n  if (!isBusinessIdFormat(id)) {\r\n    console.warn(`[ensureBusinessId] Invalid BusinessId format: \"${id}\"${context ? ` in ${context}` : ''}`);\r\n  }\r\n  return asBusinessId(id);\r\n}\r\n"],"names":[],"mappings":"AAAA;;;;CAIC,GAED,gCAAgC;;;;;;;;;;;;;;;;;;;;;AAQzB,SAAS,WAAW,EAAU;IACnC,OAAO;AACT;AAMO,SAAS,aAAa,EAAU;IACrC,OAAO;AACT;AAKO,SAAS,iBAAiB,EAAU;IACzC,kEAAkE;IAClE,OAAO,gBAAgB,IAAI,CAAC;AAC9B;AAKO,SAAS,mBAAmB,EAAU;IAC3C,gEAAgE;IAChE,OAAO,kBAAkB,IAAI,CAAC;AAChC;AAKO,SAAS,QAAQ,EAAU;IAChC,IAAI,iBAAiB,KAAK;QACxB,OAAO;YAAE,MAAM;YAAU,OAAO,WAAW;QAAI;IACjD;IACA,IAAI,mBAAmB,KAAK;QAC1B,OAAO;YAAE,MAAM;YAAY,OAAO,aAAa;QAAI;IACrD;IACA,MAAM,IAAI,MAAM,CAAC,mBAAmB,EAAE,IAAI;AAC5C;AA8CO,SAAS,gBAAgB,IAAY,EAAE,MAAoB;IAChE,OAAO,KAAK,OAAO,CAAC,aAAa,OAAO,QAAQ;AAClD;AAKO,SAAS,aAAa,MAAoB;IAC/C,OAAO,OAAO,EAAE;AAClB;AAMO,SAAS,eAAe,EAAU,EAAE,OAAgB;IACzD,IAAI,CAAC,iBAAiB,KAAK;QACzB,QAAQ,IAAI,CAAC,CAAC,2CAA2C,EAAE,GAAG,CAAC,EAAE,UAAU,CAAC,IAAI,EAAE,SAAS,GAAG,IAAI;IACpG;IACA,OAAO,WAAW;AACpB;AAMO,SAAS,iBAAiB,EAAU,EAAE,OAAgB;IAC3D,IAAI,CAAC,mBAAmB,KAAK;QAC3B,QAAQ,IAAI,CAAC,CAAC,+CAA+C,EAAE,GAAG,CAAC,EAAE,UAAU,CAAC,IAAI,EAAE,SAAS,GAAG,IAAI;IACxG;IACA,OAAO,aAAa;AACtB"}},
    {"offset": {"line": 80, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/lib/import-export/import-export-store.ts"],"sourcesContent":["/**\r\n * Import/Export Store\r\n * \r\n * Lưu lịch sử import/export với Zustand persist (localStorage)\r\n * Khi migrate sang Next.js, sẽ chuyển sang API\r\n */\r\n\r\nimport { create } from 'zustand';\r\nimport type { ImportLogEntry, ExportLogEntry } from './types';\r\n\r\nconst MAX_LOGS = 200;  // Giới hạn để tránh localStorage quá tải\r\n\r\n// Generate simple ID\r\nconst generateLogId = (prefix: string): string => {\r\n  const timestamp = Date.now().toString(36);\r\n  const random = Math.random().toString(36).substring(2, 8);\r\n  return `${prefix}_${timestamp}_${random}`;\r\n};\r\n\r\ninterface ImportExportState {\r\n  importLogs: ImportLogEntry[];\r\n  exportLogs: ExportLogEntry[];\r\n  initialized: boolean;\r\n  \r\n  // Actions\r\n  addImportLog: (log: Omit<ImportLogEntry, 'id'>) => string;\r\n  addExportLog: (log: Omit<ExportLogEntry, 'id'>) => string;\r\n  \r\n  // Queries\r\n  getLogsByEntity: (entityType: string) => {\r\n    imports: ImportLogEntry[];\r\n    exports: ExportLogEntry[];\r\n  };\r\n  getRecentLogs: (limit?: number) => Array<(ImportLogEntry | ExportLogEntry) & { _type: 'import' | 'export' }>;\r\n  getImportLogById: (id: string) => ImportLogEntry | undefined;\r\n  getExportLogById: (id: string) => ExportLogEntry | undefined;\r\n  \r\n  // Management\r\n  deleteLog: (id: string, type: 'import' | 'export') => void;\r\n  clearLogs: (entityType?: string) => void;\r\n}\r\n\r\nexport const useImportExportStore = create<ImportExportState>()(\r\n  (set, get) => ({\r\n    importLogs: [],\r\n    exportLogs: [],\r\n    initialized: false,\r\n    \r\n    addImportLog: (log) => {\r\n        const id = generateLogId('IMP');\r\n        const newLog: ImportLogEntry = { ...log, id };\r\n        \r\n        set((state) => ({\r\n          importLogs: [newLog, ...state.importLogs].slice(0, MAX_LOGS),\r\n        }));\r\n        \r\n        return id;\r\n      },\r\n      \r\n      addExportLog: (log) => {\r\n        const id = generateLogId('EXP');\r\n        const newLog: ExportLogEntry = { ...log, id };\r\n        \r\n        set((state) => ({\r\n          exportLogs: [newLog, ...state.exportLogs].slice(0, MAX_LOGS),\r\n        }));\r\n        \r\n        return id;\r\n      },\r\n      \r\n      getLogsByEntity: (entityType) => ({\r\n        imports: get().importLogs.filter((l) => l.entityType === entityType),\r\n        exports: get().exportLogs.filter((l) => l.entityType === entityType),\r\n      }),\r\n      \r\n      getRecentLogs: (limit = 50) => {\r\n        const all = [\r\n          ...get().importLogs.map((l) => ({ ...l, _type: 'import' as const })),\r\n          ...get().exportLogs.map((l) => ({ ...l, _type: 'export' as const })),\r\n        ];\r\n        return all\r\n          .sort((a, b) => new Date(b.performedAt).getTime() - new Date(a.performedAt).getTime())\r\n          .slice(0, limit);\r\n      },\r\n      \r\n      getImportLogById: (id) => {\r\n        return get().importLogs.find((l) => l.id === id);\r\n      },\r\n      \r\n      getExportLogById: (id) => {\r\n        return get().exportLogs.find((l) => l.id === id);\r\n      },\r\n      \r\n      deleteLog: (id, type) => {\r\n        if (type === 'import') {\r\n          set((state) => ({\r\n            importLogs: state.importLogs.filter((l) => l.id !== id),\r\n          }));\r\n        } else {\r\n          set((state) => ({\r\n            exportLogs: state.exportLogs.filter((l) => l.id !== id),\r\n          }));\r\n        }\r\n      },\r\n      \r\n      clearLogs: (entityType) => {\r\n        if (entityType) {\r\n          set((state) => ({\r\n            importLogs: state.importLogs.filter((l) => l.entityType !== entityType),\r\n            exportLogs: state.exportLogs.filter((l) => l.entityType !== entityType),\r\n          }));\r\n        } else {\r\n          set({ importLogs: [], exportLogs: [] });\r\n        }\r\n      },\r\n      \r\n      loadFromAPI: async () => {\r\n        if (get().initialized) return;\r\n        try {\r\n          const response = await fetch('/api/import-export-logs?limit=500');\r\n          if (response.ok) {\r\n            const json = await response.json();\r\n            const data = json.data || {};\r\n            set({ \r\n              importLogs: data.importLogs || [], \r\n              exportLogs: data.exportLogs || [],\r\n              initialized: true \r\n            });\r\n          }\r\n        } catch (error) {\r\n          console.error('[Import Export Store] loadFromAPI error:', error);\r\n        }\r\n      },\r\n    })\r\n);\r\n\r\n// ============================================\r\n// SELECTORS (for optimization)\r\n// ============================================\r\n\r\nexport const selectImportLogs = (state: ImportExportState) => state.importLogs;\r\nexport const selectExportLogs = (state: ImportExportState) => state.exportLogs;\r\n\r\nexport const selectImportLogsByEntity = (entityType: string) => (state: ImportExportState) =>\r\n  state.importLogs.filter((l) => l.entityType === entityType);\r\n\r\nexport const selectExportLogsByEntity = (entityType: string) => (state: ImportExportState) =>\r\n  state.exportLogs.filter((l) => l.entityType === entityType);\r\n\r\n// ============================================\r\n// FUTURE: API Service (Next.js migration)\r\n// ============================================\r\n// \r\n// export async function saveImportLog(log: Omit<ImportLogEntry, 'id'>) {\r\n//   return fetch('/api/import-export/logs', {\r\n//     method: 'POST',\r\n//     headers: { 'Content-Type': 'application/json' },\r\n//     body: JSON.stringify({ type: 'import', ...log }),\r\n//   }).then(r => r.json());\r\n// }\r\n// \r\n// export async function getImportExportLogs(params: {\r\n//   entityType?: string;\r\n//   type?: 'import' | 'export';\r\n//   limit?: number;\r\n// }) {\r\n//   const query = new URLSearchParams(params as Record<string, string>);\r\n//   return fetch(`/api/import-export/logs?${query}`).then(r => r.json());\r\n// }\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 230, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/lib/import-export/employee-mapping-store.ts"],"sourcesContent":["/**\r\n * Employee Mapping Store\r\n * \r\n * Lưu mapping giữa tên NV máy chấm công → Mã NV hệ thống\r\n * Mapping được lưu để tái sử dụng cho các lần import sau\r\n */\r\n\r\nimport { create } from 'zustand';\r\nimport type { EmployeeMappingEntry } from './types';\r\n\r\n// Generate simple ID\r\nconst generateMappingId = (): string => {\r\n  const timestamp = Date.now().toString(36);\r\n  const random = Math.random().toString(36).substring(2, 6);\r\n  return `MAP_${timestamp}_${random}`;\r\n};\r\n\r\ninterface EmployeeMappingState {\r\n  mappings: EmployeeMappingEntry[];\r\n  initialized: boolean;\r\n  \r\n  // Actions\r\n  addMapping: (entry: Omit<EmployeeMappingEntry, 'id' | 'createdAt' | 'updatedAt'>) => string;\r\n  updateMapping: (id: string, updates: Partial<Omit<EmployeeMappingEntry, 'id'>>) => void;\r\n  deleteMapping: (id: string) => void;\r\n  \r\n  // Bulk actions\r\n  addMappings: (entries: Array<Omit<EmployeeMappingEntry, 'id' | 'createdAt' | 'updatedAt'>>) => void;\r\n  clearMappings: () => void;\r\n  \r\n  // Queries\r\n  findByMachineName: (machineName: string) => EmployeeMappingEntry | undefined;\r\n  findByMachineId: (machineId: number) => EmployeeMappingEntry | undefined;\r\n  findBySystemId: (systemId: string) => EmployeeMappingEntry | undefined;\r\n  \r\n  // Auto-mapping helper\r\n  autoMapEmployees: (\r\n    machineNames: string[],\r\n    systemEmployees: Array<{ systemId: string; businessId: string; fullName: string }>\r\n  ) => {\r\n    mapped: Array<{ machineName: string; systemId: string; systemName: string }>;\r\n    unmapped: string[];\r\n  };\r\n}\r\n\r\n/**\r\n * Normalize tên để so sánh (lowercase, remove diacritics, trim)\r\n */\r\nfunction normalizeName(name: string): string {\r\n  return name\r\n    .toLowerCase()\r\n    .trim()\r\n    .normalize('NFD')\r\n    .replace(/[\\u0300-\\u036f]/g, '') // Remove diacritics\r\n    .replace(/đ/g, 'd')\r\n    .replace(/Đ/g, 'D')\r\n    .replace(/\\s+/g, ' '); // Normalize spaces\r\n}\r\n\r\n/**\r\n * Check if two names match (fuzzy matching)\r\n */\r\nfunction namesMatch(machineName: string, systemName: string): boolean {\r\n  const normalizedMachine = normalizeName(machineName);\r\n  const normalizedSystem = normalizeName(systemName);\r\n  \r\n  // Exact match\r\n  if (normalizedMachine === normalizedSystem) return true;\r\n  \r\n  // Machine name is part of system name\r\n  if (normalizedSystem.includes(normalizedMachine)) return true;\r\n  \r\n  // System name parts match machine name\r\n  const systemParts = normalizedSystem.split(' ');\r\n  const machineParts = normalizedMachine.split(' ');\r\n  \r\n  // Check if all machine parts are in system name\r\n  const allPartsMatch = machineParts.every((part) =>\r\n    systemParts.some((sp) => sp === part || sp.includes(part) || part.includes(sp))\r\n  );\r\n  if (allPartsMatch && machineParts.length >= 2) return true;\r\n  \r\n  // Check last name + first name match\r\n  // VD: \"duc dat\" matches \"Nguyễn Đức Đạt\" (đức đạt)\r\n  if (systemParts.length >= 2 && machineParts.length >= 2) {\r\n    const systemLastParts = systemParts.slice(-2).join(' ');\r\n    if (normalizedMachine === systemLastParts) return true;\r\n  }\r\n  \r\n  return false;\r\n}\r\n\r\nexport const useEmployeeMappingStore = create<EmployeeMappingState>()(\r\n  (set, get) => ({\r\n    mappings: [],\r\n    initialized: false,\r\n    \r\n    addMapping: (entry) => {\r\n        const id = generateMappingId();\r\n        const now = new Date().toISOString();\r\n        const newEntry: EmployeeMappingEntry = {\r\n          ...entry,\r\n          id,\r\n          createdAt: now,\r\n          updatedAt: now,\r\n        };\r\n        \r\n        set((state) => ({\r\n          mappings: [...state.mappings, newEntry],\r\n        }));\r\n        \r\n        return id;\r\n      },\r\n      \r\n      updateMapping: (id, updates) => {\r\n        set((state) => ({\r\n          mappings: state.mappings.map((m) =>\r\n            m.id === id\r\n              ? { ...m, ...updates, updatedAt: new Date().toISOString() }\r\n              : m\r\n          ),\r\n        }));\r\n      },\r\n      \r\n      deleteMapping: (id) => {\r\n        set((state) => ({\r\n          mappings: state.mappings.filter((m) => m.id !== id),\r\n        }));\r\n      },\r\n      \r\n      addMappings: (entries) => {\r\n        const now = new Date().toISOString();\r\n        const newEntries: EmployeeMappingEntry[] = entries.map((entry) => ({\r\n          ...entry,\r\n          id: generateMappingId(),\r\n          createdAt: now,\r\n          updatedAt: now,\r\n        }));\r\n        \r\n        set((state) => ({\r\n          mappings: [...state.mappings, ...newEntries],\r\n        }));\r\n      },\r\n      \r\n      clearMappings: () => {\r\n        set({ mappings: [] });\r\n      },\r\n      \r\n      findByMachineName: (machineName) => {\r\n        const normalized = normalizeName(machineName);\r\n        return get().mappings.find(\r\n          (m) => normalizeName(m.machineName) === normalized\r\n        );\r\n      },\r\n      \r\n      findByMachineId: (machineId) => {\r\n        return get().mappings.find((m) => m.machineEmployeeId === machineId);\r\n      },\r\n      \r\n      findBySystemId: (systemId) => {\r\n        return get().mappings.find((m) => m.systemEmployeeId === systemId);\r\n      },\r\n      \r\n      autoMapEmployees: (machineNames, systemEmployees) => {\r\n        const mapped: Array<{ machineName: string; systemId: string; systemName: string }> = [];\r\n        const unmapped: string[] = [];\r\n        const existingMappings = get().mappings;\r\n        \r\n        for (const machineName of machineNames) {\r\n          // 1. Check existing mapping first\r\n          const existingMapping = existingMappings.find(\r\n            (m) => normalizeName(m.machineName) === normalizeName(machineName)\r\n          );\r\n          \r\n          if (existingMapping) {\r\n            mapped.push({\r\n              machineName,\r\n              systemId: existingMapping.systemEmployeeId,\r\n              systemName: existingMapping.systemEmployeeName,\r\n            });\r\n            continue;\r\n          }\r\n          \r\n          // 2. Try to auto-match with system employees\r\n          const matchedEmployee = systemEmployees.find((emp) =>\r\n            namesMatch(machineName, emp.fullName)\r\n          );\r\n          \r\n          if (matchedEmployee) {\r\n            mapped.push({\r\n              machineName,\r\n              systemId: matchedEmployee.businessId,\r\n              systemName: matchedEmployee.fullName,\r\n            });\r\n          } else {\r\n            unmapped.push(machineName);\r\n          }\r\n        }\r\n        \r\n        return { mapped, unmapped };\r\n      },\r\n      \r\n      loadFromAPI: async () => {\r\n        if (get().initialized) return;\r\n        try {\r\n          // NOTE: Employee mappings are typically small dataset\r\n          const response = await fetch('/api/employee-mappings?limit=100');\r\n          if (response.ok) {\r\n            const json = await response.json();\r\n            const data = json.data || [];\r\n            if (data.length > 0) {\r\n              set({ mappings: data, initialized: true });\r\n            } else {\r\n              set({ initialized: true });\r\n            }\r\n          }\r\n        } catch (error) {\r\n          console.error('[Employee Mapping Store] loadFromAPI error:', error);\r\n        }\r\n      },\r\n    })\r\n);\r\n\r\n// ============================================\r\n// HELPER FUNCTIONS\r\n// ============================================\r\n\r\n/**\r\n * Save auto-mapped results to store\r\n */\r\nexport function saveMappingsFromAutoMap(\r\n  autoMapResult: ReturnType<EmployeeMappingState['autoMapEmployees']>,\r\n  machineIds: Map<string, number> // Map<machineName, machineId>\r\n): void {\r\n  const store = useEmployeeMappingStore.getState();\r\n  \r\n  const newMappings = autoMapResult.mapped\r\n    .filter((m) => !store.findByMachineName(m.machineName)) // Skip existing\r\n    .map((m) => ({\r\n      machineEmployeeId: machineIds.get(m.machineName) || 0,\r\n      machineName: m.machineName,\r\n      systemEmployeeId: m.systemId,\r\n      systemEmployeeName: m.systemName,\r\n    }));\r\n  \r\n  if (newMappings.length > 0) {\r\n    store.addMappings(newMappings);\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 415, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/lib/import-export/utils.ts"],"sourcesContent":["/**\r\n * Import/Export Utilities\r\n * \r\n * Các hàm tiện ích cho import/export:\r\n * - Preview (rà soát) dữ liệu trước khi import\r\n * - Validate fields và rows\r\n * - Transform data\r\n */\r\n\r\nimport type {\r\n  ImportExportConfig,\r\n  ImportPreviewRow,\r\n  ImportPreviewResult,\r\n  ImportPreviewStatus,\r\n  FieldConfig,\r\n} from './types';\r\nimport { formatDateForDisplay } from '@/lib/date-utils';\r\n\r\n// ============================================\r\n// PREVIEW IMPORT DATA\r\n// ============================================\r\n\r\ntype ImportMode = 'insert-only' | 'update-only' | 'upsert';\r\n\r\n/**\r\n * Rà soát dữ liệu trước khi import\r\n * Trả về preview với status từng dòng\r\n */\r\nexport function previewImportData<T>(\r\n  rawRows: Record<string, unknown>[],\r\n  config: ImportExportConfig<T>,\r\n  existingData: T[],\r\n  mode: ImportMode = 'upsert',\r\n  branchSystemId?: string\r\n): ImportPreviewResult<T> {\r\n  const rows: ImportPreviewRow<T>[] = [];\r\n  let validCount = 0;\r\n  let warningCount = 0;\r\n  let errorCount = 0;\r\n  let duplicateCount = 0;\r\n\r\n  // 0. Pre-process all rows if defined (for fill-down logic, multi-row grouping)\r\n  let processedRawRows = rawRows;\r\n  if (config.preProcessRows) {\r\n    processedRawRows = config.preProcessRows(rawRows) as Record<string, unknown>[];\r\n  }\r\n\r\n  processedRawRows.forEach((rawData, index) => {\r\n    const rowErrors: Array<{ field?: string; message: string }> = [];\r\n    const rowWarnings: Array<{ field?: string; message: string }> = [];\r\n\r\n    // 0.5. Apply preTransformRawRow if defined (normalize/merge raw columns)\r\n    let normalizedRawData = rawData;\r\n    if (config.preTransformRawRow) {\r\n      normalizedRawData = config.preTransformRawRow(rawData);\r\n    }\r\n\r\n    // 1. Transform raw data to typed data\r\n    let transformedData = transformImportRow<T>(normalizedRawData, config.fields);\r\n\r\n    // 1.5. Apply postTransformRow if defined (enrich data, lookup IDs, etc.)\r\n    if (config.postTransformRow) {\r\n      transformedData = config.postTransformRow(transformedData, index, branchSystemId);\r\n    }\r\n\r\n    // 2. Validate từng field theo config\r\n    for (const field of config.fields) {\r\n      if (field.hidden) continue; // Skip hidden fields\r\n      \r\n      const value = transformedData[field.key as keyof typeof transformedData];\r\n      const fieldErrors = validateField(value, field, transformedData);\r\n      \r\n      // Separate warnings from errors (warnings start with [Warning])\r\n      fieldErrors.forEach(err => {\r\n        if (err.message.startsWith('[Warning]')) {\r\n          rowWarnings.push({ ...err, message: err.message.replace('[Warning] ', '') });\r\n        } else {\r\n          rowErrors.push(err);\r\n        }\r\n      });\r\n    }\r\n\r\n    // 3. Validate row-level (custom validation) - pass mode so it can skip duplicate checks in upsert\r\n    if (config.validateRow) {\r\n      const rowLevelErrors = config.validateRow(transformedData as T, index, existingData, mode);\r\n      rowLevelErrors.forEach(err => {\r\n        if (err.message.startsWith('[Warning]')) {\r\n          rowWarnings.push({ ...err, message: err.message.replace('[Warning] ', '') });\r\n        } else {\r\n          rowErrors.push(err);\r\n        }\r\n      });\r\n    }\r\n\r\n    // 4. Check existing record (upsert logic)\r\n    let existingRecord: T | null = null;\r\n    let isExisting = false;\r\n    let status: ImportPreviewStatus = 'valid';\r\n\r\n    if (config.findExisting) {\r\n      existingRecord = config.findExisting(transformedData as T, existingData);\r\n    } else if (config.upsertKey) {\r\n      // Default: find by upsertKey\r\n      const businessId = transformedData[config.upsertKey as keyof typeof transformedData];\r\n      existingRecord = existingData.find(\r\n        (e) => e[config.upsertKey as keyof T] === businessId\r\n      ) || null;\r\n    }\r\n\r\n    isExisting = existingRecord !== null;\r\n\r\n    // 5. Determine status based on mode and validation\r\n    if (rowErrors.length > 0) {\r\n      status = 'error';\r\n      errorCount++;\r\n    } else if (isExisting) {\r\n      if (mode === 'insert-only') {\r\n        status = 'duplicate';\r\n        duplicateCount++;\r\n      } else if (mode === 'update-only' || mode === 'upsert') {\r\n        status = 'will-update';\r\n        if (rowWarnings.length > 0) {\r\n          status = 'warning';\r\n          warningCount++;\r\n        } else {\r\n          validCount++;\r\n        }\r\n      }\r\n    } else {\r\n      if (mode === 'update-only') {\r\n        status = 'error';\r\n        errorCount++;\r\n        rowErrors.push({ message: 'Không tìm thấy record để cập nhật' });\r\n      } else if (mode === 'insert-only' || mode === 'upsert') {\r\n        status = 'will-insert';\r\n        if (rowWarnings.length > 0) {\r\n          status = 'warning';\r\n          warningCount++;\r\n        } else {\r\n          validCount++;\r\n        }\r\n      }\r\n    }\r\n\r\n    rows.push({\r\n      rowNumber: index + 2, // Excel row (header = row 1)\r\n      rawData,\r\n      transformedData: rowErrors.length > 0 ? null : transformedData as Partial<T>,\r\n      status,\r\n      errors: rowErrors,\r\n      warnings: rowWarnings,\r\n      isExisting,\r\n      existingRecord: existingRecord || undefined,\r\n    });\r\n  });\r\n\r\n  return {\r\n    rows,\r\n    totalRows: rawRows.length,\r\n    validCount,\r\n    warningCount,\r\n    errorCount,\r\n    duplicateCount,\r\n    isValid: (validCount + warningCount) > 0,\r\n  };\r\n}\r\n\r\n// ============================================\r\n// FIELD VALIDATION\r\n// ============================================\r\n\r\n/**\r\n * Validate một field theo config\r\n */\r\nexport function validateField<T>(\r\n  value: unknown,\r\n  field: FieldConfig<T>,\r\n  row: Partial<T>\r\n): Array<{ field?: string; message: string }> {\r\n  const errors: Array<{ field?: string; message: string }> = [];\r\n  const fieldKey = field.key as string;\r\n\r\n  // Check required\r\n  if (field.required && (value === undefined || value === null || value === '')) {\r\n    errors.push({ field: fieldKey, message: `${field.label} là bắt buộc` });\r\n    return errors; // Skip other validations if required field is empty\r\n  }\r\n\r\n  // Skip validation if value is empty and not required\r\n  if (value === undefined || value === null || value === '') {\r\n    return errors;\r\n  }\r\n\r\n  // Type-specific validation\r\n  switch (field.type) {\r\n    case 'email':\r\n      if (typeof value === 'string' && !/^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/.test(value)) {\r\n        errors.push({ field: fieldKey, message: `${field.label} không đúng định dạng email` });\r\n      }\r\n      break;\r\n\r\n    case 'phone':\r\n      if (typeof value === 'string') {\r\n        const cleaned = value.replace(/\\s/g, '');\r\n        if (!/^0\\d{9,10}$/.test(cleaned)) {\r\n          errors.push({ field: fieldKey, message: `${field.label} không đúng định dạng SĐT` });\r\n        }\r\n      }\r\n      break;\r\n\r\n    case 'number':\r\n      if (typeof value !== 'number' && isNaN(Number(value))) {\r\n        errors.push({ field: fieldKey, message: `${field.label} phải là số` });\r\n      }\r\n      break;\r\n\r\n    case 'date':\r\n      if (typeof value === 'string') {\r\n        const date = new Date(value);\r\n        if (isNaN(date.getTime())) {\r\n          errors.push({ field: fieldKey, message: `${field.label} không đúng định dạng ngày` });\r\n        }\r\n      }\r\n      break;\r\n\r\n    case 'enum':\r\n      if (field.enumValues && !field.enumValues.includes(String(value))) {\r\n        errors.push({\r\n          field: fieldKey,\r\n          message: `${field.label} phải là một trong: ${field.enumValues.join(', ')}`,\r\n        });\r\n      }\r\n      break;\r\n\r\n    case 'boolean':\r\n      const boolValues = ['true', 'false', '1', '0', 'yes', 'no', 'có', 'không'];\r\n      if (typeof value === 'string' && !boolValues.includes(value.toLowerCase())) {\r\n        errors.push({ field: fieldKey, message: `${field.label} phải là Có/Không` });\r\n      }\r\n      break;\r\n  }\r\n\r\n  // Custom validator\r\n  if (field.validator) {\r\n    const customError = field.validator(value, row);\r\n    if (customError && customError !== true) {\r\n      errors.push({ field: fieldKey, message: customError as string });\r\n    }\r\n  }\r\n\r\n  return errors;\r\n}\r\n\r\n// ============================================\r\n// DATA TRANSFORMATION\r\n// ============================================\r\n\r\n/**\r\n * Set nested value in object using dot notation key\r\n * e.g., setNestedValue(obj, 'permanentAddress.street', '123 ABC')\r\n */\r\nfunction setNestedValue(obj: Record<string, unknown>, path: string, value: unknown): void {\r\n  const keys = path.split('.');\r\n  let current = obj;\r\n  \r\n  for (let i = 0; i < keys.length - 1; i++) {\r\n    const key = keys[i];\r\n    if (current[key] === undefined) {\r\n      current[key] = {};\r\n    }\r\n    current = current[key] as Record<string, unknown>;\r\n  }\r\n  \r\n  current[keys[keys.length - 1]] = value;\r\n}\r\n\r\n/**\r\n * Get nested value from object using dot notation key\r\n * e.g., getNestedValue(obj, 'permanentAddress.street')\r\n */\r\nfunction getNestedValue(obj: unknown, path: string): unknown {\r\n  if (!obj || typeof obj !== 'object') return undefined;\r\n  \r\n  const keys = path.split('.');\r\n  let current = obj as Record<string, unknown>;\r\n  \r\n  for (const key of keys) {\r\n    if (current === undefined || current === null) return undefined;\r\n    current = current[key] as Record<string, unknown>;\r\n  }\r\n  \r\n  return current;\r\n}\r\n\r\n/**\r\n * Transform dữ liệu từ Excel sang App format\r\n * Hỗ trợ nested keys như 'permanentAddress.street'\r\n */\r\nexport function transformImportRow<T>(\r\n  row: Record<string, unknown>,\r\n  fields: FieldConfig<T>[]\r\n): Partial<T> {\r\n  const result: Record<string, unknown> = {};\r\n\r\n  for (const field of fields) {\r\n    const key = field.key as string;\r\n    let value = row[field.label] ?? row[key]; // Try label first, then key\r\n\r\n    // Apply import transform\r\n    if (field.importTransform && value !== undefined) {\r\n      value = field.importTransform(value);\r\n    } else {\r\n      // Default transforms\r\n      switch (field.type) {\r\n        case 'number':\r\n          value = value !== undefined && value !== '' ? Number(value) || 0 : undefined;\r\n          break;\r\n        case 'boolean':\r\n          if (typeof value === 'string') {\r\n            value = ['true', '1', 'yes', 'có'].includes(value.toLowerCase());\r\n          }\r\n          break;\r\n        case 'date':\r\n          // Excel serial date → ISO string\r\n          if (typeof value === 'number') {\r\n            const date = new Date((value - 25569) * 86400 * 1000);\r\n            value = date.toISOString().split('T')[0];\r\n          }\r\n          break;\r\n      }\r\n    }\r\n\r\n    // Apply default value if empty\r\n    if ((value === undefined || value === null || value === '') && field.defaultValue !== undefined) {\r\n      value = field.defaultValue;\r\n    }\r\n\r\n    if (value !== undefined && value !== '') {\r\n      // Support nested keys like 'permanentAddress.street'\r\n      if (key.includes('.')) {\r\n        setNestedValue(result, key, value);\r\n      } else {\r\n        result[key] = value;\r\n      }\r\n    }\r\n  }\r\n\r\n  return result as Partial<T>;\r\n}\r\n\r\n/**\r\n * Transform dữ liệu từ App sang Excel format\r\n * Hỗ trợ nested keys như 'permanentAddress.street'\r\n */\r\nexport function transformExportRow<T>(\r\n  row: T,\r\n  fields: FieldConfig<T>[],\r\n  selectedColumns?: string[]\r\n): Record<string, unknown> {\r\n  const result: Record<string, unknown> = {};\r\n\r\n  for (const field of fields) {\r\n    // Skip if not selected\r\n    if (selectedColumns && !selectedColumns.includes(field.key as string)) {\r\n      continue;\r\n    }\r\n\r\n    // Skip if not exportable\r\n    if (field.exportable === false) {\r\n      continue;\r\n    }\r\n\r\n    const key = field.key as string;\r\n    // Support nested keys like 'permanentAddress.street'\r\n    let value = key.includes('.') \r\n      ? getNestedValue(row, key) \r\n      : row[key as keyof T];\r\n\r\n    // Apply export transform\r\n    if (field.exportTransform && value !== undefined) {\r\n      value = field.exportTransform(value) as T[keyof T];\r\n    } else if (field.transform && value !== undefined) {\r\n      // Also use 'transform' for display purposes\r\n      value = field.transform(value) as T[keyof T];\r\n    } else {\r\n      // Default transforms\r\n      switch (field.type) {\r\n        case 'date':\r\n          if (value) {\r\n            value = formatDateForDisplay(value as string) as T[keyof T];\r\n          }\r\n          break;\r\n        case 'boolean':\r\n          value = (value ? 'Có' : 'Không') as T[keyof T];\r\n          break;\r\n      }\r\n    }\r\n\r\n    result[field.label] = value;\r\n  }\r\n\r\n  return result;\r\n}\r\n\r\n// ============================================\r\n// UNIQUE CHECK\r\n// ============================================\r\n\r\n/**\r\n * Check unique fields trong existing data\r\n */\r\nexport function checkUniqueFields<T>(\r\n  row: Partial<T>,\r\n  uniqueFields: (keyof T)[],\r\n  existingData: T[],\r\n  currentBusinessId?: unknown\r\n): Array<{ field: string; message: string }> {\r\n  const errors: Array<{ field: string; message: string }> = [];\r\n\r\n  for (const field of uniqueFields) {\r\n    const value = row[field];\r\n    if (!value) continue;\r\n\r\n    const duplicate = existingData.find((e) => {\r\n      // Skip if same record (updating)\r\n      if (currentBusinessId && e[field as keyof T] === currentBusinessId) {\r\n        return false;\r\n      }\r\n      return e[field] === value;\r\n    });\r\n\r\n    if (duplicate) {\r\n      errors.push({\r\n        field: field as string,\r\n        message: `${field as string} đã được sử dụng`,\r\n      });\r\n    }\r\n  }\r\n\r\n  return errors;\r\n}\r\n\r\n// ============================================\r\n// FILE HELPERS\r\n// ============================================\r\n\r\n/**\r\n * Generate export filename\r\n */\r\nexport function generateExportFileName(\r\n  entityDisplayName: string,\r\n  scope: string\r\n): string {\r\n  const date = new Date().toISOString().split('T')[0];\r\n  const scopeLabel = scope === 'all' ? 'TatCa' : scope === 'current-page' ? 'TrangHienTai' : 'DaLoc';\r\n  return `${entityDisplayName.replace(/\\s+/g, '_')}_${scopeLabel}_${date}.xlsx`;\r\n}\r\n\r\n/**\r\n * Format file size\r\n */\r\nexport function formatFileSize(bytes: number): string {\r\n  if (bytes === 0) return '0 B';\r\n  const k = 1024;\r\n  const sizes = ['B', 'KB', 'MB', 'GB'];\r\n  const i = Math.floor(Math.log(bytes) / Math.log(k));\r\n  return `${parseFloat((bytes / Math.pow(k, i)).toFixed(1))} ${sizes[i]}`;\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 815, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/lib/import-export/attendance-parser.ts"],"sourcesContent":["/**\r\n * Attendance Parser\r\n * \r\n * Parser riêng cho file từ máy chấm công\r\n * File có format đặc biệt: header phức tạp, merged cells, etc.\r\n * \r\n * Cấu trúc file t11.xls:\r\n * - Sheet \"Bảng tổng hợp chấm công\": Tổng hợp theo tháng (DÙNG CHÍNH)\r\n * - Row 0: Tiêu đề\r\n * - Row 1: Ngày thống kê (VD: \"Ngày thống kê:2025-11-01~2025-11-30\")\r\n * - Row 2-3: Headers\r\n * - Row 4+: Dữ liệu nhân viên\r\n */\r\n\r\nimport * as XLSX from 'xlsx';\r\nimport type { AttendanceImportRow } from './types';\r\n\r\n// ============================================\r\n// TYPES\r\n// ============================================\r\n\r\nexport interface AttendanceParseResult {\r\n  success: boolean;\r\n  data: AttendanceImportRow[];\r\n  month: number;\r\n  year: number;\r\n  dateRange: { from: string; to: string };\r\n  errors: Array<{ row: number; message: string }>;\r\n}\r\n\r\n// ============================================\r\n// PARSER\r\n// ============================================\r\n\r\n/**\r\n * Parse file chấm công từ máy CC\r\n */\r\nexport function parseAttendanceFile(file: ArrayBuffer): AttendanceParseResult {\r\n  try {\r\n    const workbook = XLSX.read(file, { type: 'array' });\r\n    \r\n    // Tìm sheet \"Bảng tổng hợp chấm công\"\r\n    const sheetName = 'Bảng tổng hợp chấm công';\r\n    const sheet = workbook.Sheets[sheetName];\r\n    \r\n    if (!sheet) {\r\n      return {\r\n        success: false,\r\n        data: [],\r\n        month: 0,\r\n        year: 0,\r\n        dateRange: { from: '', to: '' },\r\n        errors: [{ row: 0, message: `Không tìm thấy sheet \"${sheetName}\"` }],\r\n      };\r\n    }\r\n    \r\n    // Convert to array\r\n    const rawData = XLSX.utils.sheet_to_json<unknown[]>(sheet, { header: 1 });\r\n    \r\n    // Parse date range từ row 1\r\n    const dateRangeRow = rawData[1] as string[];\r\n    const dateRange = parseDateRange(dateRangeRow?.[0] || '');\r\n    \r\n    // Parse data từ row 4 trở đi\r\n    const data: AttendanceImportRow[] = [];\r\n    const errors: Array<{ row: number; message: string }> = [];\r\n    \r\n    for (let i = 4; i < rawData.length; i++) {\r\n      const row = rawData[i] as unknown[];\r\n      if (!row || row.length === 0) continue;\r\n      \r\n      // Skip if no employee ID\r\n      const machineId = row[0];\r\n      if (machineId === undefined || machineId === null || machineId === '') continue;\r\n      \r\n      try {\r\n        const parsed = parseAttendanceRow(row, i + 1); // Excel row = index + 1\r\n        data.push(parsed);\r\n      } catch (err) {\r\n        errors.push({\r\n          row: i + 1,\r\n          message: err instanceof Error ? err.message : 'Lỗi không xác định',\r\n        });\r\n      }\r\n    }\r\n    \r\n    return {\r\n      success: errors.length === 0,\r\n      data,\r\n      month: dateRange.month,\r\n      year: dateRange.year,\r\n      dateRange: { from: dateRange.from, to: dateRange.to },\r\n      errors,\r\n    };\r\n  } catch (err) {\r\n    return {\r\n      success: false,\r\n      data: [],\r\n      month: 0,\r\n      year: 0,\r\n      dateRange: { from: '', to: '' },\r\n      errors: [{ row: 0, message: `Lỗi đọc file: ${err instanceof Error ? err.message : 'Unknown'}` }],\r\n    };\r\n  }\r\n}\r\n\r\n/**\r\n * Parse date range từ string \"Ngày thống kê:2025-11-01~2025-11-30\"\r\n */\r\nfunction parseDateRange(text: string): { from: string; to: string; month: number; year: number } {\r\n  const match = text.match(/(\\d{4}-\\d{2}-\\d{2})~(\\d{4}-\\d{2}-\\d{2})/);\r\n  \r\n  if (match) {\r\n    const from = match[1];\r\n    const to = match[2];\r\n    const [year, month] = from.split('-').map(Number);\r\n    return { from, to, month, year };\r\n  }\r\n  \r\n  // Default to current month\r\n  const now = new Date();\r\n  return {\r\n    from: '',\r\n    to: '',\r\n    month: now.getMonth() + 1,\r\n    year: now.getFullYear(),\r\n  };\r\n}\r\n\r\n/**\r\n * Parse một dòng dữ liệu nhân viên\r\n * \r\n * Cột trong file:\r\n * A (0): Mã NV (máy)\r\n * B (1): Họ tên\r\n * C (2): Phòng ban\r\n * D (3): TG làm việc chuẩn\r\n * E (4): TG làm việc thực tế\r\n * F (5): Đến muộn (lần)\r\n * G (6): Đến muộn (phút)\r\n * H (7): Về sớm (lần)\r\n * I (8): Về sớm (phút)\r\n * J (9): Tăng ca bình thường\r\n * K (10): Tăng ca đặc biệt\r\n * L (11): Số ngày (chuẩn/thực)\r\n * M (12): Công tác\r\n * N (13): Nghỉ không phép\r\n * O (14): Nghỉ phép\r\n */\r\nfunction parseAttendanceRow(row: unknown[], excelRow: number): AttendanceImportRow {\r\n  const getNumber = (value: unknown): number => {\r\n    if (value === undefined || value === null || value === '') return 0;\r\n    const num = Number(value);\r\n    return isNaN(num) ? 0 : num;\r\n  };\r\n  \r\n  const getString = (value: unknown): string => {\r\n    if (value === undefined || value === null) return '';\r\n    return String(value).trim();\r\n  };\r\n  \r\n  return {\r\n    machineEmployeeId: getNumber(row[0]),\r\n    employeeName: getString(row[1]),\r\n    department: getString(row[2]),\r\n    standardHours: getNumber(row[3]),\r\n    actualHours: getNumber(row[4]),\r\n    lateCount: getNumber(row[5]),\r\n    lateMinutes: getNumber(row[6]),\r\n    earlyLeaveCount: getNumber(row[7]),\r\n    earlyLeaveMinutes: getNumber(row[8]),\r\n    overtimeNormal: getNumber(row[9]),\r\n    overtimeSpecial: getNumber(row[10]),\r\n    workDays: getString(row[11]),\r\n    businessTrip: getNumber(row[12]),\r\n    absentWithoutLeave: getNumber(row[13]),\r\n    paidLeave: getNumber(row[14]),\r\n  };\r\n}\r\n\r\n// ============================================\r\n// UTILITIES\r\n// ============================================\r\n\r\n/**\r\n * Parse workDays string \"20/19\" → { standard: 20, actual: 19 }\r\n */\r\nexport function parseWorkDays(workDays: string): { standard: number; actual: number } {\r\n  const cleaned = workDays.replace(/\\s/g, '');\r\n  const match = cleaned.match(/(\\d+)\\/(\\d+)/);\r\n  \r\n  if (match) {\r\n    return {\r\n      standard: parseInt(match[1], 10),\r\n      actual: parseInt(match[2], 10),\r\n    };\r\n  }\r\n  \r\n  return { standard: 0, actual: 0 };\r\n}\r\n\r\n/**\r\n * Get available sheets in workbook\r\n */\r\nexport function getAvailableSheets(file: ArrayBuffer): string[] {\r\n  const workbook = XLSX.read(file, { type: 'array' });\r\n  return workbook.SheetNames;\r\n}\r\n\r\n/**\r\n * Preview first N rows of a sheet\r\n */\r\nexport function previewSheet(\r\n  file: ArrayBuffer,\r\n  sheetName: string,\r\n  maxRows = 10\r\n): unknown[][] {\r\n  const workbook = XLSX.read(file, { type: 'array' });\r\n  const sheet = workbook.Sheets[sheetName];\r\n  \r\n  if (!sheet) return [];\r\n  \r\n  const data = XLSX.utils.sheet_to_json<unknown[]>(sheet, { header: 1 });\r\n  return data.slice(0, maxRows);\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1027, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/lib/id-utils.ts"],"sourcesContent":["/**\r\n * ID Utilities\r\n * Helpers for generating and validating IDs (systemId & business id)\r\n */\r\n\r\nimport { getPrefix, type EntityType } from './smart-prefix';\r\nimport { ID_CONFIG } from './id-config';\r\n\r\n// Re-export EntityType for convenience\r\nexport type { EntityType } from './smart-prefix';\r\n\r\n/**\r\n * Generate SystemId (6 digits, immutable, internal use only)\r\n * Format: SYSTEMID_PREFIX + 6 digits (e.g., \"EMP000001\", \"CUSTOMER000001\", \"ORDER000001\")\r\n * Uses systemIdPrefix from ID_CONFIG (English full words)\r\n */\r\nexport function generateSystemId(entityType: EntityType, counter: number): string {\r\n  const config = ID_CONFIG[entityType];\r\n  if (!config) {\r\n    throw new Error(`No configuration found for entity type: ${entityType}`);\r\n  }\r\n  const prefix = config.systemIdPrefix;\r\n  const digitCount = config.digitCount || 6;\r\n  return `${prefix}${String(counter).padStart(digitCount, '0')}`;\r\n}\r\n\r\n/**\r\n * Generate Business ID (6 digits, user-facing, editable)\r\n * Format: PREFIX + 6 digits (e.g., \"NV000001\", \"KH000001\", \"CTV000001\")\r\n * All entities use same 6-digit format for consistency\r\n * \r\n * @param entityType - Entity type from smart-prefix\r\n * @param counter - Current counter value\r\n * @param customId - Optional custom ID from user input\r\n * @returns Generated ID or validated custom ID\r\n */\r\nexport function generateBusinessId(\r\n  entityType: EntityType, \r\n  counter: number,\r\n  customId?: string\r\n): string {\r\n  // If user provided custom ID, validate and return it\r\n  if (customId && customId.trim()) {\r\n    const sanitized = sanitizeBusinessId(customId);\r\n    if (!sanitized) {\r\n      throw new Error('Mã không hợp lệ! Chỉ được phép sử dụng chữ cái và số.');\r\n    }\r\n    return sanitized;\r\n  }\r\n  \r\n  // Otherwise, auto-generate\r\n  const prefix = getPrefix(entityType);\r\n  return `${prefix}${String(counter).padStart(6, '0')}`;\r\n}\r\n\r\n/**\r\n * Sanitize business ID\r\n * - Remove special characters (keep only letters and numbers)\r\n * - Convert to uppercase\r\n * - Trim whitespace\r\n * \r\n * @param id - Raw user input\r\n * @returns Sanitized ID or null if invalid\r\n */\r\nexport function sanitizeBusinessId(id: string): string | null {\r\n  if (!id || typeof id !== 'string') return null;\r\n  \r\n  // Remove all special characters, keep only alphanumeric\r\n  const cleaned = id.trim().replace(/[^a-zA-Z0-9]/g, '');\r\n  \r\n  if (!cleaned) return null;\r\n  \r\n  // Convert to uppercase for consistency\r\n  return cleaned.toUpperCase();\r\n}\r\n\r\n/**\r\n * Validate business ID uniqueness (case-insensitive)\r\n * \r\n * @param id - ID to check\r\n * @param existingIds - Array of existing IDs in the system\r\n * @param currentId - Current ID (for edit mode, to exclude self)\r\n * @returns true if unique, false if duplicate\r\n */\r\nexport function isBusinessIdUnique(\r\n  id: string,\r\n  existingIds: string[],\r\n  currentId?: string\r\n): boolean {\r\n  if (!id) return false;\r\n  \r\n  const normalizedId = id.toUpperCase();\r\n  const normalizedCurrentId = currentId?.toUpperCase();\r\n  \r\n  return !existingIds.some(existingId => {\r\n    // ✅ Filter out empty/undefined IDs\r\n    if (!existingId || existingId.trim() === '') return false;\r\n    \r\n    const normalizedExisting = existingId.toUpperCase();\r\n    // Skip self-comparison in edit mode\r\n    if (normalizedCurrentId && normalizedExisting === normalizedCurrentId) {\r\n      return false;\r\n    }\r\n    return normalizedExisting === normalizedId;\r\n  });\r\n}\r\n\r\n/**\r\n * Extract counter from system ID\r\n * Used to initialize counter when loading from localStorage\r\n * Supports both 6, 7 and 8 digits\r\n * \r\n * @param systemId - System ID to parse (e.g., \"EMP000001\", \"CUSTOMER000001\", \"WARRANTY0000001\")\r\n * @param prefix - Expected systemIdPrefix (e.g., \"EMP\", \"CUSTOMER\", \"WARRANTY\")\r\n * @returns Counter value or 0 if invalid\r\n */\r\nexport function extractCounterFromSystemId(systemId: string, prefix: string): number {\r\n  if (!systemId || typeof systemId !== 'string') return 0;\r\n  \r\n  // Try different digit counts (most entities use 6 digits, some use 7-8)\r\n  const regex8 = new RegExp(`^${prefix}(\\\\d{8})$`);\r\n  const regex7 = new RegExp(`^${prefix}(\\\\d{7})$`);\r\n  const regex6 = new RegExp(`^${prefix}(\\\\d{6})$`);\r\n  \r\n  const match8 = systemId.match(regex8);\r\n  if (match8) return parseInt(match8[1], 10);\r\n  \r\n  const match7 = systemId.match(regex7);\r\n  if (match7) return parseInt(match7[1], 10);\r\n  \r\n  const match6 = systemId.match(regex6);\r\n  if (match6) return parseInt(match6[1], 10);\r\n  \r\n  return 0;\r\n}\r\n\r\n/**\r\n * Extract counter from business ID\r\n * Used to initialize counter when loading from localStorage\r\n * \r\n * @param businessId - Business ID to parse (e.g., \"NV000001\")\r\n * @param prefix - Expected prefix (e.g., \"NV\")\r\n * @returns Counter value or 0 if invalid\r\n */\r\nexport function extractCounterFromBusinessId(businessId: string, prefix: string): number {\r\n  if (!businessId || typeof businessId !== 'string') return 0;\r\n  const regex = new RegExp(`^${prefix}(\\\\d+)$`);\r\n  const match = businessId.match(regex);\r\n  return match ? parseInt(match[1], 10) : 0;\r\n}\r\n\r\n/**\r\n * Get max counter from array of items (for systemId)\r\n * \r\n * @param items - Array of items with systemId\r\n * @param prefix - Prefix to match\r\n * @returns Maximum counter value\r\n */\r\nexport function getMaxSystemIdCounter<T extends { systemId: string }>(\r\n  items: T[],\r\n  prefix: string\r\n): number {\r\n  if (!items || !Array.isArray(items)) return 0;\r\n  \r\n  let maxCounter = 0;\r\n  \r\n  items.forEach(item => {\r\n    if (!item || !item.systemId) return;\r\n    const counter = extractCounterFromSystemId(item.systemId, prefix);\r\n    if (counter > maxCounter) {\r\n      maxCounter = counter;\r\n    }\r\n  });\r\n  \r\n  return maxCounter;\r\n}\r\n\r\n/**\r\n * Get max counter from array of items (for business id)\r\n * Only counts auto-generated IDs (PREFIX + digits)\r\n * \r\n * @param items - Array of items with id\r\n * @param prefix - Prefix to match\r\n * @returns Maximum counter value\r\n */\r\nexport function getMaxBusinessIdCounter<T extends { id: string }>(\r\n  items: T[],\r\n  prefix: string\r\n): number {\r\n  if (!items || !Array.isArray(items)) return 0;\r\n  \r\n  let maxCounter = 0;\r\n  \r\n  items.forEach(item => {\r\n    if (!item || !item.id) return;\r\n    const counter = extractCounterFromBusinessId(item.id, prefix);\r\n    if (counter > maxCounter) {\r\n      maxCounter = counter;\r\n    }\r\n  });\r\n  \r\n  return maxCounter;\r\n}\r\n\r\n/**\r\n * Format ID for display\r\n * Adds spacing for readability\r\n * \r\n * @param id - ID to format\r\n * @returns Formatted ID (e.g., \"NV-000001\", \"KH-000123\")\r\n */\r\nexport function formatIdForDisplay(id: string): string {\r\n  // Match pattern: PREFIX followed by numbers\r\n  const match = id.match(/^([A-Z]+)(\\d+)$/);\r\n  if (!match) return id;\r\n  \r\n  const [, prefix, numbers] = match;\r\n  return `${prefix}-${numbers}`;\r\n}\r\n\r\n/**\r\n * Validate ID format\r\n * Check if ID follows valid pattern (letters + numbers only)\r\n * \r\n * @param id - ID to validate\r\n * @returns true if valid format\r\n */\r\nexport function isValidIdFormat(id: string): boolean {\r\n  if (!id || typeof id !== 'string') return false;\r\n  \r\n  // Only alphanumeric characters allowed\r\n  const regex = /^[A-Z0-9]+$/i;\r\n  return regex.test(id);\r\n}\r\n\r\n/**\r\n * Generate suggested IDs based on entity type\r\n * Useful for autocomplete or placeholder text\r\n * \r\n * @param entityType - Entity type\r\n * @param counter - Current counter\r\n * @param count - Number of suggestions\r\n * @returns Array of suggested IDs\r\n */\r\nexport function generateSuggestedIds(\r\n  entityType: EntityType,\r\n  counter: number,\r\n  count: number = 3\r\n): string[] {\r\n  const suggestions: string[] = [];\r\n  const prefix = getPrefix(entityType);\r\n  \r\n  for (let i = 0; i < count; i++) {\r\n    suggestions.push(`${prefix}${String(counter + i + 1).padStart(6, '0')}`);\r\n  }\r\n  \r\n  return suggestions;\r\n}\r\n\r\n/**\r\n * ✨ Find next available business ID\r\n * Checks existing IDs and increments counter until finding a unique ID\r\n * \r\n * @param prefix - ID prefix (e.g., 'PT', 'PC', 'NV')\r\n * @param existingIds - Array of existing business IDs\r\n * @param startCounter - Starting counter value\r\n * @param digitCount - Number of digits (default: 6)\r\n * @returns Object with nextId and updatedCounter\r\n */\r\nexport function findNextAvailableBusinessId(\r\n  prefix: string,\r\n  existingIds: string[],\r\n  startCounter: number,\r\n  digitCount: number = 6\r\n): { nextId: string; updatedCounter: number } {\r\n  let counter = startCounter;\r\n  let nextId: string;\r\n  \r\n  // Keep incrementing until we find a unique ID\r\n  do {\r\n    counter++;\r\n    nextId = `${prefix}${String(counter).padStart(digitCount, '0')}`;\r\n  } while (existingIds.some(id => id === nextId));\r\n  \r\n  return {\r\n    nextId,\r\n    updatedCounter: counter\r\n  };\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1187, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/lib/store-factory.ts"],"sourcesContent":["import { create } from 'zustand';\r\n// persist, createJSONStorage removed - database is now source of truth\r\nimport { \r\n  generateSystemId, \r\n  generateBusinessId, \r\n  isBusinessIdUnique,\r\n  getMaxSystemIdCounter,\r\n  getMaxBusinessIdCounter,\r\n  findNextAvailableBusinessId,\r\n  type EntityType \r\n} from './id-utils';\r\nimport { getPrefix } from './smart-prefix';\r\nimport { ID_CONFIG, type SystemId, type BusinessId, createSystemId, createBusinessId as brandBusinessId } from './id-config';\r\n\r\nconst SYSTEM_FALLBACK_ID: SystemId = createSystemId('SYS000000');\r\n\r\nconst asSystemIdFallback = (): SystemId => SYSTEM_FALLBACK_ID;\r\n\r\n// ✅ API Sync helper for store-factory\r\nasync function syncToAPI<T>(\r\n  apiEndpoint: string,\r\n  action: 'create' | 'update' | 'delete' | 'restore',\r\n  data: T | { systemId: SystemId },\r\n  systemId?: SystemId\r\n): Promise<boolean> {\r\n  try {\r\n    const endpoint = action === 'create' \r\n      ? apiEndpoint \r\n      : `${apiEndpoint}/${systemId || (data as any).systemId}`;\r\n    \r\n    const method = action === 'create' ? 'POST' \r\n      : action === 'update' ? 'PATCH' \r\n      : action === 'delete' ? 'DELETE'\r\n      : 'PATCH'; // restore uses PATCH\r\n    \r\n    const response = await fetch(endpoint, {\r\n      method,\r\n      headers: { 'Content-Type': 'application/json' },\r\n      credentials: 'include',\r\n      body: action !== 'delete' ? JSON.stringify(data) : undefined,\r\n    });\r\n    \r\n    if (!response.ok) {\r\n      console.warn(`[Store Factory API] ${action} failed for ${apiEndpoint}:`, response.status);\r\n    }\r\n    return response.ok;\r\n  } catch (error) {\r\n    console.error(`[Store Factory API] ${action} error for ${apiEndpoint}:`, error);\r\n    return false;\r\n  }\r\n}\r\n\r\n// Item with SystemId (branded type)\r\nexport type ItemWithSystemId = { systemId: SystemId; [key: string]: any };\r\n\r\n// ✅ Counter state for ID generation\r\nexport type CounterState = {\r\n  systemId: number;\r\n  businessId: number;\r\n};\r\n\r\nexport type CrudState<T extends ItemWithSystemId> = {\r\n  data: T[];\r\n  _counters: CounterState; // ✅ Persisted counters\r\n  _initialized: boolean; // ✅ Track if loaded from API\r\n  add: (item: Omit<T, 'systemId'>) => T;\r\n  addMultiple: (items: Omit<T, 'systemId'>[]) => void;\r\n  update: (systemId: SystemId, item: Partial<T>) => void; // ✅ Accept partial updates\r\n  remove: (systemId: SystemId) => void; // ✅ Branded type\r\n  hardDelete: (systemId: SystemId) => void; // ✅ Branded type\r\n  restore: (systemId: SystemId) => void; // ✅ Branded type\r\n  findById: (systemId: SystemId | string) => T | undefined; // ✅ Branded type\r\n  getActive: () => T[];\r\n  getDeleted: () => T[];\r\n  loadFromAPI: () => Promise<void>; // ✅ Load data from database\r\n};\r\n\r\nexport const createCrudStore = <T extends ItemWithSystemId>(\r\n  _initialData: T[], // @deprecated - Kept for backward compatibility but NO LONGER USED\r\n  entityType: EntityType, // Changed from idPrefix to entityType\r\n  options?: {\r\n    businessIdField?: keyof T; // Field name for business ID (default: 'id')\r\n    persistKey?: string; // @deprecated - No longer used, kept for backward compatibility\r\n    getCurrentUser?: () => string | undefined; // Function to get current user systemId\r\n    apiEndpoint?: string; // ✅ API endpoint for database sync (e.g., '/api/employees')\r\n  }\r\n) => {\r\n  const businessPrefix = getPrefix(entityType); // Vietnamese prefix for Business ID (NV, KH, DH)\r\n  const config = ID_CONFIG[entityType];\r\n  const systemIdPrefix = config?.systemIdPrefix || entityType.toUpperCase(); // English prefix for SystemId (EMP, CUSTOMER, ORDER)\r\n  \r\n  const businessIdField = options?.businessIdField ?? 'id';\r\n  // const persistKey = options?.persistKey; // @deprecated - No longer used\r\n  const getCurrentUser = options?.getCurrentUser;\r\n  const apiEndpoint = options?.apiEndpoint;\r\n\r\n  // ✅ CHANGED: Start with empty array - database is source of truth\r\n  // Mock data files (data.ts) are NO LONGER USED for runtime\r\n  const normalizedInitialData: T[] = [];\r\n\r\n  const storeConfig = (set: any, get: any) => ({\r\n    data: normalizedInitialData, // ✅ Start empty - data loaded via React Query\r\n    // ✅ Counters start at 0 - will be initialized from API via loadFromAPI()\r\n    _counters: {\r\n      systemId: 0,\r\n      businessId: 0\r\n    },\r\n    _initialized: false, // ✅ Track API initialization\r\n    add: (item: Omit<T, 'systemId'>): T => {\r\n        // ✅ Get counters from state (persisted)\r\n        const currentCounters = get()._counters;\r\n        const newSystemIdCounter = currentCounters.systemId + 1;\r\n        const newSystemId = createSystemId(generateSystemId(entityType, newSystemIdCounter));\r\n        \r\n        // Generate or validate Business ID (if field exists)\r\n        let finalItem = { ...item } as any;\r\n        let newBusinessIdCounter = currentCounters.businessId;\r\n        \r\n        if (businessIdField in item) {\r\n          const customId = (item as any)[businessIdField];\r\n          const existingIds = get().data.map((d: any) => d[businessIdField]);\r\n          \r\n          // ✅ If customId provided, validate uniqueness\r\n          if (customId && customId.trim()) {\r\n            if (!isBusinessIdUnique(customId, existingIds)) {\r\n              throw new Error(`Mã \"${customId}\" đã tồn tại! Vui lòng sử dụng mã khác.`);\r\n            }\r\n            finalItem[businessIdField] = customId.trim().toUpperCase();\r\n          } else {\r\n            // ✅ Auto-generate with findNextAvailableBusinessId\r\n            const digitCount = 6; // All entities use 6 digits\r\n            const result = findNextAvailableBusinessId(businessPrefix, existingIds, newBusinessIdCounter, digitCount);\r\n            finalItem[businessIdField] = result.nextId;\r\n            newBusinessIdCounter = result.updatedCounter;\r\n          }\r\n        }\r\n        \r\n        const now = new Date().toISOString();\r\n        const currentUser = getCurrentUser?.();\r\n        const newItem = { \r\n          ...finalItem, \r\n          systemId: newSystemId, // ✅ Branded SystemId\r\n          createdAt: finalItem.createdAt || now,\r\n          updatedAt: now,\r\n          createdBy: finalItem.createdBy || currentUser,\r\n          updatedBy: currentUser,\r\n        } as unknown as T;\r\n        \r\n        // ✅ Update both data and counters atomically\r\n        set((state: any) => ({ \r\n          data: [...state.data, newItem],\r\n          _counters: {\r\n            systemId: newSystemIdCounter,\r\n            businessId: newBusinessIdCounter\r\n          }\r\n        }));\r\n        \r\n        // ✅ Sync to API in background\r\n        if (apiEndpoint) {\r\n          syncToAPI(apiEndpoint, 'create', newItem).catch(console.error);\r\n        }\r\n        \r\n        return newItem;\r\n    },\r\n    addMultiple: (items: Omit<T, 'systemId'>[]) => \r\n        set((state: any) => {\r\n            const now = new Date().toISOString();\r\n            const currentUser = getCurrentUser?.();\r\n            const newItems: T[] = [];\r\n            const digitCount = 6; // All entities use 6 digits\r\n            \r\n            // ✅ Start from current counters\r\n            let currentSystemIdCounter = state._counters.systemId;\r\n            let currentBusinessIdCounter = state._counters.businessId;\r\n            \r\n            items.forEach(item => {\r\n                // ✅ Generate SystemId from current counter\r\n                currentSystemIdCounter++;\r\n                const newSystemId = createSystemId(generateSystemId(entityType, currentSystemIdCounter));\r\n                \r\n                // Generate or validate Business ID (if field exists)\r\n                let finalItem = { ...item } as any;\r\n                if (businessIdField in item) {\r\n                  const customId = (item as any)[businessIdField];\r\n                  \r\n                  // Collect existing IDs (from state + already added in this batch)\r\n                  const existingIds = [\r\n                    ...state.data.map((d: any) => d[businessIdField]),\r\n                    ...newItems.map((d: any) => d[businessIdField])\r\n                  ];\r\n                  \r\n                  // ✅ If customId provided, validate uniqueness\r\n                  if (customId && customId.trim()) {\r\n                    if (!isBusinessIdUnique(customId, existingIds)) {\r\n                      throw new Error(`Mã \"${customId}\" đã tồn tại! Vui lòng sử dụng mã khác.`);\r\n                    }\r\n                    finalItem[businessIdField] = customId.trim().toUpperCase();\r\n                  } else {\r\n                    // ✅ Auto-generate with findNextAvailableBusinessId\r\n                    const result = findNextAvailableBusinessId(businessPrefix, existingIds, currentBusinessIdCounter, digitCount);\r\n                    finalItem[businessIdField] = result.nextId;\r\n                    currentBusinessIdCounter = result.updatedCounter;\r\n                  }\r\n                }\r\n                \r\n                newItems.push({ \r\n                  ...finalItem, \r\n                  systemId: newSystemId,\r\n                  createdAt: now,\r\n                  updatedAt: now,\r\n                  createdBy: currentUser,\r\n                  updatedBy: currentUser,\r\n                } as unknown as T);\r\n            });\r\n            \r\n            // ✅ Update both data and counters\r\n            const result = { \r\n              data: [...state.data, ...newItems],\r\n              _counters: {\r\n                systemId: currentSystemIdCounter,\r\n                businessId: currentBusinessIdCounter\r\n              }\r\n            };\r\n            \r\n            // ✅ Sync to API in background (batch)\r\n            if (apiEndpoint) {\r\n              newItems.forEach(item => {\r\n                syncToAPI(apiEndpoint, 'create', item).catch(console.error);\r\n              });\r\n            }\r\n            \r\n            return result;\r\n        }),\r\n    update: (systemId: SystemId, updatedItem: Partial<T>) => {\r\n      // Validate unique business ID (case-insensitive, skip self)\r\n      if (businessIdField in updatedItem) {\r\n        const businessId = (updatedItem as any)[businessIdField];\r\n        const existingIds = get().data\r\n          .filter((d: any) => d.systemId !== systemId)\r\n          .map((d: any) => d[businessIdField]);\r\n        \r\n        if (businessId && !isBusinessIdUnique(businessId, existingIds)) {\r\n          throw new Error(`Mã \"${businessId}\" đã tồn tại! Vui lòng sử dụng mã khác.`);\r\n        }\r\n      }\r\n\r\n      const now = new Date().toISOString();\r\n      const currentUser = getCurrentUser?.();\r\n      set((state: any) => ({\r\n        data: state.data.map((item: T) =>\r\n          item.systemId === systemId \r\n            ? { ...item, ...updatedItem, updatedAt: now, updatedBy: currentUser } as T\r\n            : item\r\n        ),\r\n      }));\r\n      \r\n      // ✅ Sync to API in background\r\n      if (apiEndpoint) {\r\n        const fullItem = get().data.find((item: T) => item.systemId === systemId);\r\n        if (fullItem) {\r\n          syncToAPI(apiEndpoint, 'update', fullItem, systemId).catch(console.error);\r\n        }\r\n      }\r\n    },\r\n    remove: (systemId: SystemId) => {\r\n      // Soft delete - mark as deleted\r\n      const now = new Date().toISOString();\r\n      set((state: any) => ({\r\n        data: state.data.map((item: T) =>\r\n          item.systemId === systemId\r\n            ? { ...item, isDeleted: true, deletedAt: now } as T\r\n            : item\r\n        ),\r\n      }));\r\n      \r\n      // ✅ Sync to API in background\r\n      if (apiEndpoint) {\r\n        const item = get().data.find((item: T) => item.systemId === systemId);\r\n        if (item) {\r\n          syncToAPI(apiEndpoint, 'update', { ...item, isDeleted: true, deletedAt: now }, systemId).catch(console.error);\r\n        }\r\n      }\r\n    },\r\n    hardDelete: (systemId: SystemId) => {\r\n      // Permanent delete - remove from array\r\n      set((state: any) => ({\r\n        data: state.data.filter((item: T) => item.systemId !== systemId),\r\n      }));\r\n      \r\n      // ✅ Sync to API in background\r\n      if (apiEndpoint) {\r\n        syncToAPI(apiEndpoint, 'delete', { systemId }, systemId).catch(console.error);\r\n      }\r\n    },\r\n    restore: (systemId: SystemId) => {\r\n      // Restore soft-deleted item\r\n      set((state: any) => ({\r\n        data: state.data.map((item: T) =>\r\n          item.systemId === systemId\r\n            ? { ...item, isDeleted: false, deletedAt: null } as T\r\n            : item\r\n        ),\r\n      }));\r\n      \r\n      // ✅ Sync to API in background\r\n      if (apiEndpoint) {\r\n        const item = get().data.find((item: T) => item.systemId === systemId);\r\n        if (item) {\r\n          syncToAPI(apiEndpoint, 'restore', { ...item, isDeleted: false, deletedAt: null }, systemId).catch(console.error);\r\n        }\r\n      }\r\n    },\r\n    getActive: () => get().data.filter((item: any) => !item.isDeleted),\r\n    getDeleted: () => get().data.filter((item: any) => item.isDeleted),\r\n    findById: (id: SystemId | string) => get().data.find((item: T) => item.systemId === id || (item as any).id === id),\r\n    \r\n    // ✅ Load data from database API - OPTIMIZED: No more limit=10000!\r\n    // This is now only used for counter initialization, NOT for loading all data\r\n    // Use React Query hooks for data fetching with proper pagination\r\n    loadFromAPI: async () => {\r\n      if (!apiEndpoint) return;\r\n      if (get()._initialized) return;\r\n      \r\n      try {\r\n        // Only fetch minimal data needed to initialize counters\r\n        // Actual data loading should be done via React Query hooks\r\n        const response = await fetch(`${apiEndpoint}?limit=1&sortBy=systemId&sortOrder=desc`, {\r\n          credentials: 'include',\r\n        });\r\n        if (response.ok) {\r\n          const json = await response.json();\r\n          const pagination = json.pagination || {};\r\n          const lastItem = json.data?.[0];\r\n          \r\n          // Initialize counters from the latest item (highest IDs)\r\n          const newCounters = {\r\n            systemId: lastItem ? getMaxSystemIdCounter([lastItem], systemIdPrefix) : 0,\r\n            businessId: (lastItem && options?.businessIdField)\r\n              ? getMaxBusinessIdCounter([lastItem] as any[], businessPrefix)\r\n              : 0\r\n          };\r\n          \r\n          set({ \r\n            data: [], // Don't store data in Zustand anymore - use React Query\r\n            _counters: newCounters,\r\n            _initialized: true \r\n          });\r\n          \r\n          console.log(`[Store Factory] ${apiEndpoint} initialized. Total records: ${pagination.total || 'unknown'}`);\r\n        }\r\n      } catch (error) {\r\n        console.error(`[Store Factory] loadFromAPI error for ${apiEndpoint}:`, error);\r\n        // Still mark as initialized to prevent infinite retry\r\n        set({ _initialized: true });\r\n      }\r\n    },\r\n  });\r\n\r\n  // ✅ SIMPLIFIED: No localStorage persistence, database is source of truth\r\n  // Data is loaded via ApiSyncProvider on app init\r\n  return create<CrudState<T>>(storeConfig);\r\n};\r\n"],"names":[],"mappings":";;;;AAAA;AACA,uEAAuE;AACvE;AASA;AACA;;;;;AAEA,MAAM,qBAA+B,IAAA,qIAAc,EAAC;AAEpD,MAAM,qBAAqB,IAAgB;AAE3C,sCAAsC;AACtC,eAAe,UACb,WAAmB,EACnB,MAAkD,EAClD,IAAgC,EAChC,QAAmB;IAEnB,IAAI;QACF,MAAM,WAAW,WAAW,WACxB,cACA,GAAG,YAAY,CAAC,EAAE,YAAY,AAAC,KAAa,QAAQ,EAAE;QAE1D,MAAM,SAAS,WAAW,WAAW,SACjC,WAAW,WAAW,UACtB,WAAW,WAAW,WACtB,SAAS,qBAAqB;QAElC,MAAM,WAAW,MAAM,MAAM,UAAU;YACrC;YACA,SAAS;gBAAE,gBAAgB;YAAmB;YAC9C,aAAa;YACb,MAAM,WAAW,WAAW,KAAK,SAAS,CAAC,QAAQ;QACrD;QAEA,IAAI,CAAC,SAAS,EAAE,EAAE;YAChB,QAAQ,IAAI,CAAC,CAAC,oBAAoB,EAAE,OAAO,YAAY,EAAE,YAAY,CAAC,CAAC,EAAE,SAAS,MAAM;QAC1F;QACA,OAAO,SAAS,EAAE;IACpB,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,CAAC,oBAAoB,EAAE,OAAO,WAAW,EAAE,YAAY,CAAC,CAAC,EAAE;QACzE,OAAO;IACT;AACF;AA2BO,MAAM,kBAAkB,CAC7B,cACA,YACA;IAOA,MAAM,iBAAiB,IAAA,mIAAS,EAAC,aAAa,iDAAiD;IAC/F,MAAM,SAAS,gIAAS,CAAC,WAAW;IACpC,MAAM,iBAAiB,QAAQ,kBAAkB,WAAW,WAAW,IAAI,qDAAqD;IAEhI,MAAM,kBAAkB,SAAS,mBAAmB;IACpD,0EAA0E;IAC1E,MAAM,iBAAiB,SAAS;IAChC,MAAM,cAAc,SAAS;IAE7B,kEAAkE;IAClE,2DAA2D;IAC3D,MAAM,wBAA6B,EAAE;IAErC,MAAM,cAAc,CAAC,KAAU,MAAa,CAAC;YAC3C,MAAM;YACN,yEAAyE;YACzE,WAAW;gBACT,UAAU;gBACV,YAAY;YACd;YACA,cAAc;YACd,KAAK,CAAC;gBACF,wCAAwC;gBACxC,MAAM,kBAAkB,MAAM,SAAS;gBACvC,MAAM,qBAAqB,gBAAgB,QAAQ,GAAG;gBACtD,MAAM,cAAc,IAAA,qIAAc,EAAC,IAAA,sIAAgB,EAAC,YAAY;gBAEhE,qDAAqD;gBACrD,IAAI,YAAY;oBAAE,GAAG,IAAI;gBAAC;gBAC1B,IAAI,uBAAuB,gBAAgB,UAAU;gBAErD,IAAI,mBAAmB,MAAM;oBAC3B,MAAM,WAAW,AAAC,IAAY,CAAC,gBAAgB;oBAC/C,MAAM,cAAc,MAAM,IAAI,CAAC,GAAG,CAAC,CAAC,IAAW,CAAC,CAAC,gBAAgB;oBAEjE,8CAA8C;oBAC9C,IAAI,YAAY,SAAS,IAAI,IAAI;wBAC/B,IAAI,CAAC,IAAA,wIAAkB,EAAC,UAAU,cAAc;4BAC9C,MAAM,IAAI,MAAM,CAAC,IAAI,EAAE,SAAS,uCAAuC,CAAC;wBAC1E;wBACA,SAAS,CAAC,gBAAgB,GAAG,SAAS,IAAI,GAAG,WAAW;oBAC1D,OAAO;wBACL,mDAAmD;wBACnD,MAAM,aAAa,GAAG,4BAA4B;wBAClD,MAAM,SAAS,IAAA,iJAA2B,EAAC,gBAAgB,aAAa,sBAAsB;wBAC9F,SAAS,CAAC,gBAAgB,GAAG,OAAO,MAAM;wBAC1C,uBAAuB,OAAO,cAAc;oBAC9C;gBACF;gBAEA,MAAM,MAAM,IAAI,OAAO,WAAW;gBAClC,MAAM,cAAc;gBACpB,MAAM,UAAU;oBACd,GAAG,SAAS;oBACZ,UAAU;oBACV,WAAW,UAAU,SAAS,IAAI;oBAClC,WAAW;oBACX,WAAW,UAAU,SAAS,IAAI;oBAClC,WAAW;gBACb;gBAEA,6CAA6C;gBAC7C,IAAI,CAAC,QAAe,CAAC;wBACnB,MAAM;+BAAI,MAAM,IAAI;4BAAE;yBAAQ;wBAC9B,WAAW;4BACT,UAAU;4BACV,YAAY;wBACd;oBACF,CAAC;gBAED,8BAA8B;gBAC9B,IAAI,aAAa;oBACf,UAAU,aAAa,UAAU,SAAS,KAAK,CAAC,QAAQ,KAAK;gBAC/D;gBAEA,OAAO;YACX;YACA,aAAa,CAAC,QACV,IAAI,CAAC;oBACD,MAAM,MAAM,IAAI,OAAO,WAAW;oBAClC,MAAM,cAAc;oBACpB,MAAM,WAAgB,EAAE;oBACxB,MAAM,aAAa,GAAG,4BAA4B;oBAElD,gCAAgC;oBAChC,IAAI,yBAAyB,MAAM,SAAS,CAAC,QAAQ;oBACrD,IAAI,2BAA2B,MAAM,SAAS,CAAC,UAAU;oBAEzD,MAAM,OAAO,CAAC,CAAA;wBACV,2CAA2C;wBAC3C;wBACA,MAAM,cAAc,IAAA,qIAAc,EAAC,IAAA,sIAAgB,EAAC,YAAY;wBAEhE,qDAAqD;wBACrD,IAAI,YAAY;4BAAE,GAAG,IAAI;wBAAC;wBAC1B,IAAI,mBAAmB,MAAM;4BAC3B,MAAM,WAAW,AAAC,IAAY,CAAC,gBAAgB;4BAE/C,kEAAkE;4BAClE,MAAM,cAAc;mCACf,MAAM,IAAI,CAAC,GAAG,CAAC,CAAC,IAAW,CAAC,CAAC,gBAAgB;mCAC7C,SAAS,GAAG,CAAC,CAAC,IAAW,CAAC,CAAC,gBAAgB;6BAC/C;4BAED,8CAA8C;4BAC9C,IAAI,YAAY,SAAS,IAAI,IAAI;gCAC/B,IAAI,CAAC,IAAA,wIAAkB,EAAC,UAAU,cAAc;oCAC9C,MAAM,IAAI,MAAM,CAAC,IAAI,EAAE,SAAS,uCAAuC,CAAC;gCAC1E;gCACA,SAAS,CAAC,gBAAgB,GAAG,SAAS,IAAI,GAAG,WAAW;4BAC1D,OAAO;gCACL,mDAAmD;gCACnD,MAAM,SAAS,IAAA,iJAA2B,EAAC,gBAAgB,aAAa,0BAA0B;gCAClG,SAAS,CAAC,gBAAgB,GAAG,OAAO,MAAM;gCAC1C,2BAA2B,OAAO,cAAc;4BAClD;wBACF;wBAEA,SAAS,IAAI,CAAC;4BACZ,GAAG,SAAS;4BACZ,UAAU;4BACV,WAAW;4BACX,WAAW;4BACX,WAAW;4BACX,WAAW;wBACb;oBACJ;oBAEA,kCAAkC;oBAClC,MAAM,SAAS;wBACb,MAAM;+BAAI,MAAM,IAAI;+BAAK;yBAAS;wBAClC,WAAW;4BACT,UAAU;4BACV,YAAY;wBACd;oBACF;oBAEA,sCAAsC;oBACtC,IAAI,aAAa;wBACf,SAAS,OAAO,CAAC,CAAA;4BACf,UAAU,aAAa,UAAU,MAAM,KAAK,CAAC,QAAQ,KAAK;wBAC5D;oBACF;oBAEA,OAAO;gBACX;YACJ,QAAQ,CAAC,UAAoB;gBAC3B,4DAA4D;gBAC5D,IAAI,mBAAmB,aAAa;oBAClC,MAAM,aAAa,AAAC,WAAmB,CAAC,gBAAgB;oBACxD,MAAM,cAAc,MAAM,IAAI,CAC3B,MAAM,CAAC,CAAC,IAAW,EAAE,QAAQ,KAAK,UAClC,GAAG,CAAC,CAAC,IAAW,CAAC,CAAC,gBAAgB;oBAErC,IAAI,cAAc,CAAC,IAAA,wIAAkB,EAAC,YAAY,cAAc;wBAC9D,MAAM,IAAI,MAAM,CAAC,IAAI,EAAE,WAAW,uCAAuC,CAAC;oBAC5E;gBACF;gBAEA,MAAM,MAAM,IAAI,OAAO,WAAW;gBAClC,MAAM,cAAc;gBACpB,IAAI,CAAC,QAAe,CAAC;wBACnB,MAAM,MAAM,IAAI,CAAC,GAAG,CAAC,CAAC,OACpB,KAAK,QAAQ,KAAK,WACd;gCAAE,GAAG,IAAI;gCAAE,GAAG,WAAW;gCAAE,WAAW;gCAAK,WAAW;4BAAY,IAClE;oBAER,CAAC;gBAED,8BAA8B;gBAC9B,IAAI,aAAa;oBACf,MAAM,WAAW,MAAM,IAAI,CAAC,IAAI,CAAC,CAAC,OAAY,KAAK,QAAQ,KAAK;oBAChE,IAAI,UAAU;wBACZ,UAAU,aAAa,UAAU,UAAU,UAAU,KAAK,CAAC,QAAQ,KAAK;oBAC1E;gBACF;YACF;YACA,QAAQ,CAAC;gBACP,gCAAgC;gBAChC,MAAM,MAAM,IAAI,OAAO,WAAW;gBAClC,IAAI,CAAC,QAAe,CAAC;wBACnB,MAAM,MAAM,IAAI,CAAC,GAAG,CAAC,CAAC,OACpB,KAAK,QAAQ,KAAK,WACd;gCAAE,GAAG,IAAI;gCAAE,WAAW;gCAAM,WAAW;4BAAI,IAC3C;oBAER,CAAC;gBAED,8BAA8B;gBAC9B,IAAI,aAAa;oBACf,MAAM,OAAO,MAAM,IAAI,CAAC,IAAI,CAAC,CAAC,OAAY,KAAK,QAAQ,KAAK;oBAC5D,IAAI,MAAM;wBACR,UAAU,aAAa,UAAU;4BAAE,GAAG,IAAI;4BAAE,WAAW;4BAAM,WAAW;wBAAI,GAAG,UAAU,KAAK,CAAC,QAAQ,KAAK;oBAC9G;gBACF;YACF;YACA,YAAY,CAAC;gBACX,uCAAuC;gBACvC,IAAI,CAAC,QAAe,CAAC;wBACnB,MAAM,MAAM,IAAI,CAAC,MAAM,CAAC,CAAC,OAAY,KAAK,QAAQ,KAAK;oBACzD,CAAC;gBAED,8BAA8B;gBAC9B,IAAI,aAAa;oBACf,UAAU,aAAa,UAAU;wBAAE;oBAAS,GAAG,UAAU,KAAK,CAAC,QAAQ,KAAK;gBAC9E;YACF;YACA,SAAS,CAAC;gBACR,4BAA4B;gBAC5B,IAAI,CAAC,QAAe,CAAC;wBACnB,MAAM,MAAM,IAAI,CAAC,GAAG,CAAC,CAAC,OACpB,KAAK,QAAQ,KAAK,WACd;gCAAE,GAAG,IAAI;gCAAE,WAAW;gCAAO,WAAW;4BAAK,IAC7C;oBAER,CAAC;gBAED,8BAA8B;gBAC9B,IAAI,aAAa;oBACf,MAAM,OAAO,MAAM,IAAI,CAAC,IAAI,CAAC,CAAC,OAAY,KAAK,QAAQ,KAAK;oBAC5D,IAAI,MAAM;wBACR,UAAU,aAAa,WAAW;4BAAE,GAAG,IAAI;4BAAE,WAAW;4BAAO,WAAW;wBAAK,GAAG,UAAU,KAAK,CAAC,QAAQ,KAAK;oBACjH;gBACF;YACF;YACA,WAAW,IAAM,MAAM,IAAI,CAAC,MAAM,CAAC,CAAC,OAAc,CAAC,KAAK,SAAS;YACjE,YAAY,IAAM,MAAM,IAAI,CAAC,MAAM,CAAC,CAAC,OAAc,KAAK,SAAS;YACjE,UAAU,CAAC,KAA0B,MAAM,IAAI,CAAC,IAAI,CAAC,CAAC,OAAY,KAAK,QAAQ,KAAK,MAAM,AAAC,KAAa,EAAE,KAAK;YAE/G,kEAAkE;YAClE,6EAA6E;YAC7E,iEAAiE;YACjE,aAAa;gBACX,IAAI,CAAC,aAAa;gBAClB,IAAI,MAAM,YAAY,EAAE;gBAExB,IAAI;oBACF,wDAAwD;oBACxD,2DAA2D;oBAC3D,MAAM,WAAW,MAAM,MAAM,GAAG,YAAY,uCAAuC,CAAC,EAAE;wBACpF,aAAa;oBACf;oBACA,IAAI,SAAS,EAAE,EAAE;wBACf,MAAM,OAAO,MAAM,SAAS,IAAI;wBAChC,MAAM,aAAa,KAAK,UAAU,IAAI,CAAC;wBACvC,MAAM,WAAW,KAAK,IAAI,EAAE,CAAC,EAAE;wBAE/B,yDAAyD;wBACzD,MAAM,cAAc;4BAClB,UAAU,WAAW,IAAA,2IAAqB,EAAC;gCAAC;6BAAS,EAAE,kBAAkB;4BACzE,YAAY,AAAC,YAAY,SAAS,kBAC9B,IAAA,6IAAuB,EAAC;gCAAC;6BAAS,EAAW,kBAC7C;wBACN;wBAEA,IAAI;4BACF,MAAM,EAAE;4BACR,WAAW;4BACX,cAAc;wBAChB;wBAEA,QAAQ,GAAG,CAAC,CAAC,gBAAgB,EAAE,YAAY,6BAA6B,EAAE,WAAW,KAAK,IAAI,WAAW;oBAC3G;gBACF,EAAE,OAAO,OAAO;oBACd,QAAQ,KAAK,CAAC,CAAC,sCAAsC,EAAE,YAAY,CAAC,CAAC,EAAE;oBACvE,sDAAsD;oBACtD,IAAI;wBAAE,cAAc;oBAAK;gBAC3B;YACF;QACF,CAAC;IAED,yEAAyE;IACzE,iDAAiD;IACjD,OAAO,IAAA,kJAAM,EAAe;AAC9B"}},
    {"offset": {"line": 1495, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/lib/seed-audit.ts"],"sourcesContent":["import { asSystemId, type SystemId } from './id-types';\r\n\r\nexport const DEFAULT_SEED_AUTHOR = asSystemId('EMP000001');\r\n\r\ntype SeedAuditInput = {\r\n  createdAt: string;\r\n  createdBy?: SystemId;\r\n  updatedAt?: string;\r\n  updatedBy?: SystemId;\r\n};\r\n\r\nexport const buildSeedAuditFields = ({\r\n  createdAt,\r\n  createdBy = DEFAULT_SEED_AUTHOR,\r\n  updatedAt,\r\n  updatedBy,\r\n}: SeedAuditInput) => ({\r\n  createdAt,\r\n  updatedAt: updatedAt ?? createdAt,\r\n  createdBy,\r\n  updatedBy: updatedBy ?? createdBy,\r\n});\r\n"],"names":[],"mappings":";;;;;;AAAA;;AAEO,MAAM,sBAAsB,IAAA,gIAAU,EAAC;AASvC,MAAM,uBAAuB,CAAC,EACnC,SAAS,EACT,YAAY,mBAAmB,EAC/B,SAAS,EACT,SAAS,EACM,GAAK,CAAC;QACrB;QACA,WAAW,aAAa;QACxB;QACA,WAAW,aAAa;IAC1B,CAAC"}},
    {"offset": {"line": 1514, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/lib/import-export/address-lookup.ts"],"sourcesContent":["/**\r\n * Address Lookup Helper for Import\r\n * \r\n * Chuyển đổi tên địa chỉ thành ID để form edit có thể populate đúng dropdown\r\n * \r\n * LƯU Ý QUAN TRỌNG:\r\n * - Dữ liệu 2-level: 34 tỉnh mới (provinces-data) + wards-2level-data\r\n * - Dữ liệu 3-level: 63 tỉnh cũ (wards-3level-data có provinceName riêng)\r\n * - Cần lookup từ WARD trước để lấy đúng provinceId/districtId từ ward data\r\n */\r\n\r\nimport { useProvinceStore } from '@/features/settings/provinces/store';\r\nimport type { EmployeeAddress, AddressInputLevel } from '@/features/employees/types';\r\n\r\n// Common aliases for provinces\r\n// KEY = name in provinces-data (TP HCM, Hà Nội, etc.)\r\n// VALUES = all possible variants including 3-level names\r\nconst PROVINCE_ALIASES: Record<string, string[]> = {\r\n  'TP HCM': [\r\n    'tp hcm', 'tphcm', 'hcm', 'sai gon', 'saigon',\r\n    'thanh pho ho chi minh', 'tp ho chi minh', 'ho chi minh',\r\n    'thành phố hồ chí minh', // with diacritics for exact match\r\n  ],\r\n  'Hà Nội': [\r\n    'ha noi', 'hanoi', 'hn',\r\n    'thanh pho ha noi', 'tp ha noi',\r\n    'thành phố hà nội',\r\n  ],\r\n  'Đà Nẵng': [\r\n    'da nang', 'danang',\r\n    'thanh pho da nang', 'tp da nang',\r\n    'thành phố đà nẵng',\r\n  ],\r\n  'Hải Phòng': [\r\n    'hai phong', 'haiphong', 'hp',\r\n    'thanh pho hai phong', 'tp hai phong',\r\n    'thành phố hải phòng',\r\n  ],\r\n  'Cần Thơ': [\r\n    'can tho', 'cantho',\r\n    'thanh pho can tho', 'tp can tho',\r\n    'thành phố cần thơ',\r\n  ],\r\n};\r\n\r\n/**\r\n * Normalize tên để so sánh (bỏ dấu, lowercase)\r\n */\r\nfunction normalizeText(text: string): string {\r\n  return text\r\n    .toLowerCase()\r\n    .normalize('NFD')\r\n    .replace(/[\\u0300-\\u036f]/g, '')\r\n    .replace(/đ/g, 'd')\r\n    .replace(/Đ/g, 'D')\r\n    .trim();\r\n}\r\n\r\n/**\r\n * So sánh 2 string đã normalize\r\n */\r\nfunction matchText(a: string, b: string): boolean {\r\n  return normalizeText(a) === normalizeText(b);\r\n}\r\n\r\n/**\r\n * Tìm tỉnh/thành phố theo tên\r\n */\r\nexport function findProvinceByName(provinceName: string): { id: string; name: string } | null {\r\n  if (!provinceName) return null;\r\n  \r\n  const store = useProvinceStore.getState();\r\n  const provinces = store.data;\r\n  \r\n  // Exact match first\r\n  let found = provinces.find(p => p.name === provinceName);\r\n  if (found) return { id: found.id, name: found.name };\r\n  \r\n  // Normalized match\r\n  found = provinces.find(p => matchText(p.name, provinceName));\r\n  if (found) return { id: found.id, name: found.name };\r\n  \r\n  // Try alias match\r\n  const normalizedInput = normalizeText(provinceName);\r\n  for (const [standardName, aliases] of Object.entries(PROVINCE_ALIASES)) {\r\n    if (aliases.some(alias => alias === normalizedInput || normalizedInput.includes(alias) || alias.includes(normalizedInput))) {\r\n      found = provinces.find(p => p.name === standardName);\r\n      if (found) return { id: found.id, name: found.name };\r\n    }\r\n  }\r\n  \r\n  // Partial match (contains) - last resort\r\n  found = provinces.find(p => \r\n    normalizeText(p.name).includes(normalizedInput) || \r\n    normalizedInput.includes(normalizeText(p.name))\r\n  );\r\n  \r\n  return found ? { id: found.id, name: found.name } : null;\r\n}\r\n\r\n/**\r\n * Remove common prefixes from district/ward names for better matching\r\n */\r\nfunction removeCommonPrefixes(text: string): string {\r\n  const prefixes = [\r\n    'quan ', 'huyen ', 'thi xa ', 'thanh pho ', 'tp ',\r\n    'phuong ', 'xa ', 'thi tran ', 'tt ',\r\n  ];\r\n  const normalized = normalizeText(text);\r\n  for (const prefix of prefixes) {\r\n    if (normalized.startsWith(prefix)) {\r\n      return normalized.slice(prefix.length);\r\n    }\r\n  }\r\n  return normalized;\r\n}\r\n\r\n/**\r\n * Tìm quận/huyện theo tên và provinceId\r\n */\r\nexport function findDistrictByName(\r\n  districtName: string, \r\n  provinceId: string\r\n): { id: number; name: string } | null {\r\n  if (!districtName || !provinceId) return null;\r\n  \r\n  const store = useProvinceStore.getState();\r\n  const districts = store.districts.filter(d => d.provinceId === provinceId);\r\n  \r\n  // Exact match first\r\n  let found = districts.find(d => d.name === districtName);\r\n  if (found) return { id: found.id, name: found.name };\r\n  \r\n  // Normalized match\r\n  found = districts.find(d => matchText(d.name, districtName));\r\n  if (found) return { id: found.id, name: found.name };\r\n  \r\n  // Try matching without prefixes\r\n  const inputWithoutPrefix = removeCommonPrefixes(districtName);\r\n  found = districts.find(d => {\r\n    const dbWithoutPrefix = removeCommonPrefixes(d.name);\r\n    return dbWithoutPrefix === inputWithoutPrefix;\r\n  });\r\n  if (found) return { id: found.id, name: found.name };\r\n  \r\n  // Partial match - last resort\r\n  const normalizedInput = normalizeText(districtName);\r\n  found = districts.find(d => \r\n    normalizeText(d.name).includes(normalizedInput) || \r\n    normalizedInput.includes(normalizeText(d.name))\r\n  );\r\n  \r\n  return found ? { id: found.id, name: found.name } : null;\r\n}\r\n\r\n/**\r\n * Tìm phường/xã theo tên, districtId và inputLevel\r\n */\r\nexport function findWardByName(\r\n  wardName: string,\r\n  provinceId: string,\r\n  districtId: number | null,\r\n  inputLevel: AddressInputLevel\r\n): { id: string; name: string; districtId?: number; districtName?: string } | null {\r\n  if (!wardName || !provinceId) return null;\r\n  \r\n  const store = useProvinceStore.getState();\r\n  \r\n  let wards = store.wards.filter(w => w.provinceId === provinceId);\r\n  \r\n  // Filter by level\r\n  if (inputLevel === '3-level' && districtId) {\r\n    wards = wards.filter(w => w.level === '3-level' && w.districtId === districtId);\r\n  } else if (inputLevel === '2-level') {\r\n    wards = wards.filter(w => w.level === '2-level');\r\n  }\r\n  \r\n  // Exact match first\r\n  let found = wards.find(w => w.name === wardName);\r\n  if (found) {\r\n    return { \r\n      id: found.id, \r\n      name: found.name,\r\n      districtId: found.districtId,\r\n      districtName: found.districtName,\r\n    };\r\n  }\r\n  \r\n  // Normalized match\r\n  found = wards.find(w => matchText(w.name, wardName));\r\n  if (found) {\r\n    return { \r\n      id: found.id, \r\n      name: found.name,\r\n      districtId: found.districtId,\r\n      districtName: found.districtName,\r\n    };\r\n  }\r\n  \r\n  // Try matching without prefixes\r\n  const inputWithoutPrefix = removeCommonPrefixes(wardName);\r\n  found = wards.find(w => {\r\n    const dbWithoutPrefix = removeCommonPrefixes(w.name);\r\n    return dbWithoutPrefix === inputWithoutPrefix;\r\n  });\r\n  if (found) {\r\n    return { \r\n      id: found.id, \r\n      name: found.name,\r\n      districtId: found.districtId,\r\n      districtName: found.districtName,\r\n    };\r\n  }\r\n  \r\n  // Partial match - last resort\r\n  const normalizedInput = normalizeText(wardName);\r\n  found = wards.find(w => \r\n    normalizeText(w.name).includes(normalizedInput) || \r\n    normalizedInput.includes(normalizeText(w.name))\r\n  );\r\n  \r\n  return found ? { \r\n    id: found.id, \r\n    name: found.name,\r\n    districtId: found.districtId,\r\n    districtName: found.districtName,\r\n  } : null;\r\n}\r\n\r\n/**\r\n * Lookup đầy đủ địa chỉ từ text sang EmployeeAddress với IDs\r\n * \r\n * STRATEGY MỚI: Lookup từ WARD trước để lấy đúng provinceId/districtId\r\n * vì ward data có đủ thông tin về province và district\r\n * \r\n * @param address - Partial address với text names\r\n * @returns EmployeeAddress hoàn chỉnh với IDs\r\n */\r\nexport function lookupAddressIds(address: Partial<EmployeeAddress> | null | undefined): EmployeeAddress | null {\r\n  if (!address) return null;\r\n  if (!address.street && !address.province && !address.ward) return null;\r\n  \r\n  const inputLevel = address.inputLevel || '3-level';\r\n  const store = useProvinceStore.getState();\r\n  \r\n  console.log('[lookupAddressIds] Input address:', address);\r\n  console.log('[lookupAddressIds] inputLevel:', inputLevel);\r\n  \r\n  let provinceId = address.provinceId || '';\r\n  let provinceName = address.province || '';\r\n  let districtId = address.districtId || 0;\r\n  let districtName = address.district || '';\r\n  let wardId = address.wardId || '';\r\n  let wardName = address.ward || '';\r\n  \r\n  // === STRATEGY: Lookup từ ward trước (có đầy đủ thông tin) ===\r\n  if (address.ward) {\r\n    const allWards = store.wards;\r\n    const normalizedWardInput = normalizeText(address.ward);\r\n    const wardWithoutPrefix = removeCommonPrefixes(address.ward);\r\n    \r\n    // Filter wards by level\r\n    const wardsOfLevel = allWards.filter(w => \r\n      inputLevel === '2-level' ? w.level === '2-level' : w.level === '3-level'\r\n    );\r\n    \r\n    // Try to find ward matching name AND province/district context\r\n    let foundWard = wardsOfLevel.find(w => {\r\n      const nameMatch = w.name === address.ward || \r\n                       matchText(w.name, address.ward!) ||\r\n                       removeCommonPrefixes(w.name) === wardWithoutPrefix;\r\n      if (!nameMatch) return false;\r\n      \r\n      // If province name provided, check if it matches ward's province\r\n      if (address.province) {\r\n        const normalizedProvince = normalizeText(address.province);\r\n        const wardProvince = normalizeText(w.provinceName || '');\r\n        // Check various matching patterns\r\n        if (!wardProvince.includes(normalizedProvince) && \r\n            !normalizedProvince.includes(wardProvince) &&\r\n            !matchProvinceAlias(address.province, w.provinceName || '')) {\r\n          return false;\r\n        }\r\n      }\r\n      \r\n      // If district name provided (3-level), check if it matches\r\n      if (inputLevel === '3-level' && address.district && w.districtName) {\r\n        const normalizedDistrict = normalizeText(address.district);\r\n        const wardDistrict = normalizeText(w.districtName);\r\n        const districtWithoutPrefix = removeCommonPrefixes(address.district);\r\n        const wardDistrictWithoutPrefix = removeCommonPrefixes(w.districtName);\r\n        \r\n        if (!wardDistrict.includes(normalizedDistrict) && \r\n            !normalizedDistrict.includes(wardDistrict) &&\r\n            wardDistrictWithoutPrefix !== districtWithoutPrefix) {\r\n          return false;\r\n        }\r\n      }\r\n      \r\n      return true;\r\n    });\r\n    \r\n    // If not found with context, try just by ward name\r\n    if (!foundWard) {\r\n      foundWard = wardsOfLevel.find(w => \r\n        w.name === address.ward || \r\n        matchText(w.name, address.ward!) ||\r\n        removeCommonPrefixes(w.name) === wardWithoutPrefix\r\n      );\r\n    }\r\n    \r\n    if (foundWard) {\r\n      console.log('[lookupAddressIds] Found ward:', foundWard);\r\n      wardId = foundWard.id;\r\n      wardName = foundWard.name;\r\n      \r\n      // IMPORTANT: Get provinceId from provinces-data (not from ward's provinceId)\r\n      // because ward data might have different provinceId (e.g. \"00\" vs \"24\" for HCM)\r\n      const provinceFromData = findProvinceByName(foundWard.provinceName || address.province || '');\r\n      if (provinceFromData) {\r\n        provinceId = provinceFromData.id;\r\n        provinceName = provinceFromData.name;\r\n      } else {\r\n        // Fallback to ward's data if not found in provinces-data\r\n        provinceId = foundWard.provinceId;\r\n        provinceName = foundWard.provinceName || address.province || '';\r\n      }\r\n      \r\n      if (foundWard.districtId) {\r\n        districtId = foundWard.districtId;\r\n        districtName = foundWard.districtName || address.district || '';\r\n      }\r\n    } else {\r\n      console.log('[lookupAddressIds] Ward NOT FOUND for:', address.ward);\r\n    }\r\n  }\r\n  \r\n  // === Fallback: If no ward found, try province lookup ===\r\n  if (!wardId && address.province) {\r\n    const province = findProvinceByName(address.province);\r\n    if (province) {\r\n      provinceId = province.id;\r\n      provinceName = province.name;\r\n    }\r\n    \r\n    // Try district lookup if province found\r\n    if (provinceId && address.district && inputLevel === '3-level') {\r\n      const district = findDistrictByName(address.district, provinceId);\r\n      if (district) {\r\n        districtId = district.id;\r\n        districtName = district.name;\r\n      }\r\n    }\r\n  }\r\n  \r\n  console.log('[lookupAddressIds] Result:', { provinceId, provinceName, districtId, districtName, wardId, wardName });\r\n  \r\n  return {\r\n    street: address.street || '',\r\n    province: provinceName,\r\n    provinceId: provinceId,\r\n    district: districtName,\r\n    districtId: districtId,\r\n    ward: wardName,\r\n    wardId: wardId,\r\n    inputLevel: inputLevel,\r\n  } as EmployeeAddress;\r\n}\r\n\r\n/**\r\n * Check if province names match (including aliases)\r\n */\r\nfunction matchProvinceAlias(input: string, dbName: string): boolean {\r\n  const normalizedInput = normalizeText(input);\r\n  const normalizedDb = normalizeText(dbName);\r\n  \r\n  // Direct match\r\n  if (normalizedInput === normalizedDb) return true;\r\n  \r\n  // Check aliases\r\n  for (const [standardName, aliases] of Object.entries(PROVINCE_ALIASES)) {\r\n    const normalizedStandard = normalizeText(standardName);\r\n    const inputIsAlias = aliases.some(a => a === normalizedInput || normalizedInput.includes(a));\r\n    const dbIsStandard = normalizedDb === normalizedStandard || normalizedDb.includes(normalizedStandard);\r\n    const dbIsAlias = aliases.some(a => normalizedDb.includes(a));\r\n    \r\n    if (inputIsAlias && (dbIsStandard || dbIsAlias)) return true;\r\n    if (dbIsAlias && normalizedInput === normalizedStandard) return true;\r\n  }\r\n  \r\n  return false;\r\n}\r\n\r\n/**\r\n * Post-process imported employee data để lookup address IDs\r\n * Gọi hàm này sau khi transform import row\r\n */\r\nexport function enrichEmployeeAddresses<T extends { \r\n  permanentAddress?: EmployeeAddress | null;\r\n  temporaryAddress?: EmployeeAddress | null;\r\n}>(data: Partial<T>): Partial<T> {\r\n  const result = { ...data };\r\n  \r\n  console.log('[Address Lookup] Input:', {\r\n    permanentAddress: data.permanentAddress,\r\n    temporaryAddress: data.temporaryAddress,\r\n  });\r\n  \r\n  if (data.permanentAddress) {\r\n    const enriched = lookupAddressIds(data.permanentAddress);\r\n    console.log('[Address Lookup] permanentAddress enriched:', enriched);\r\n    if (enriched) {\r\n      result.permanentAddress = enriched;\r\n    }\r\n  }\r\n  \r\n  if (data.temporaryAddress) {\r\n    const enriched = lookupAddressIds(data.temporaryAddress);\r\n    console.log('[Address Lookup] temporaryAddress enriched:', enriched);\r\n    if (enriched) {\r\n      result.temporaryAddress = enriched;\r\n    }\r\n  }\r\n  \r\n  return result;\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1890, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/lib/import-export/configs/employee.config.ts"],"sourcesContent":["import type { Employee } from '@/features/employees/types';\r\nimport type { ImportExportConfig, FieldConfig } from '../types';\r\nimport { enrichEmployeeAddresses } from '../address-lookup';\r\n\r\n/**\r\n * Parse địa chỉ từ template mới\r\n * Cấu trúc địa chỉ nhân viên (hệ thống 2 cấp):\r\n * - Địa chỉ thường trú: Tỉnh/TP thường trú, Phường/Xã thường trú, Số nhà đường thường trú\r\n * - Địa chỉ tạm trú: Tỉnh/TP tạm trú, Phường/Xã tạm trú, Số nhà đường tạm trú\r\n */\r\n\r\ntype AddressType = 'permanent' | 'temporary';\r\n\r\ninterface ParsedAddress {\r\n  type: AddressType;\r\n  province: string;\r\n  ward: string;\r\n  street: string;\r\n}\r\n\r\nfunction parseEmployeeAddresses(rawRow: Record<string, unknown>): ParsedAddress[] {\r\n  const addresses: ParsedAddress[] = [];\r\n  \r\n  // Địa chỉ thường trú\r\n  const permanentProvince = rawRow['Tỉnh/TP thường trú'];\r\n  const permanentWard = rawRow['Phường/Xã thường trú'];\r\n  const permanentStreet = rawRow['Số nhà, đường thường trú'];\r\n  \r\n  if (permanentProvince || permanentWard || permanentStreet) {\r\n    addresses.push({\r\n      type: 'permanent',\r\n      province: String(permanentProvince || ''),\r\n      ward: String(permanentWard || ''),\r\n      street: String(permanentStreet || ''),\r\n    });\r\n  }\r\n  \r\n  // Địa chỉ tạm trú\r\n  const temporaryProvince = rawRow['Tỉnh/TP tạm trú'];\r\n  const temporaryWard = rawRow['Phường/Xã tạm trú'];\r\n  const temporaryStreet = rawRow['Số nhà, đường tạm trú'];\r\n  \r\n  if (temporaryProvince || temporaryWard || temporaryStreet) {\r\n    addresses.push({\r\n      type: 'temporary',\r\n      province: String(temporaryProvince || ''),\r\n      ward: String(temporaryWard || ''),\r\n      street: String(temporaryStreet || ''),\r\n    });\r\n  }\r\n  \r\n  return addresses;\r\n}\r\n\r\n/**\r\n * Normalize raw row từ template\r\n * Convert địa chỉ thường trú/tạm trú thành permanentAddress/temporaryAddress\r\n */\r\nfunction normalizeEmployeeRawRow(rawRow: Record<string, unknown>): Record<string, unknown> {\r\n  const result = { ...rawRow };\r\n  \r\n  const parsedAddresses = parseEmployeeAddresses(rawRow);\r\n  \r\n  for (const addr of parsedAddresses) {\r\n    if (addr.type === 'permanent') {\r\n      // Địa chỉ thường trú -> permanentAddress\r\n      result['__permanentAddress__'] = {\r\n        province: addr.province,\r\n        ward: addr.ward,\r\n        street: addr.street,\r\n        inputLevel: '2-level' as const,\r\n      };\r\n    } else if (addr.type === 'temporary') {\r\n      // Địa chỉ tạm trú -> temporaryAddress\r\n      result['__temporaryAddress__'] = {\r\n        province: addr.province,\r\n        ward: addr.ward,\r\n        street: addr.street,\r\n        inputLevel: '2-level' as const,\r\n      };\r\n    }\r\n  }\r\n  \r\n  return result;\r\n}\r\n\r\n// Field definitions cho Employee - ĐẦY ĐỦ tất cả fields\r\n// CHỈ BẮT BUỘC: id (Mã nhân viên) và fullName (Họ và tên)\r\nconst employeeFields: FieldConfig<Employee>[] = [\r\n  // ===== THÔNG TIN CƠ BẢN =====\r\n  {\r\n    key: 'id',\r\n    label: 'Mã nhân viên (*)',\r\n    required: true,\r\n    type: 'string',\r\n    exportGroup: 'Thông tin cơ bản',\r\n    example: 'NV001',\r\n  },\r\n  {\r\n    key: 'fullName',\r\n    label: 'Họ và tên (*)',\r\n    required: true,\r\n    type: 'string',\r\n    exportGroup: 'Thông tin cơ bản',\r\n    example: 'Nguyễn Văn A',\r\n  },\r\n  {\r\n    key: 'gender',\r\n    label: 'Giới tính',\r\n    required: false,\r\n    type: 'string',\r\n    exportGroup: 'Thông tin cơ bản',\r\n    example: 'male',\r\n  },\r\n  {\r\n    key: 'dateOfBirth',\r\n    label: 'Ngày sinh',\r\n    required: false,\r\n    type: 'date',\r\n    exportGroup: 'Thông tin cơ bản',\r\n    example: '1990-01-15',\r\n  },\r\n  {\r\n    key: 'placeOfBirth',\r\n    label: 'Nơi sinh',\r\n    required: false,\r\n    type: 'string',\r\n    exportGroup: 'Thông tin cơ bản',\r\n    example: 'Hà Nội',\r\n  },\r\n  {\r\n    key: 'nationality',\r\n    label: 'Quốc tịch',\r\n    required: false,\r\n    type: 'string',\r\n    exportGroup: 'Thông tin cơ bản',\r\n    example: 'Việt Nam',\r\n  },\r\n  {\r\n    key: 'religion',\r\n    label: 'Tôn giáo',\r\n    required: false,\r\n    type: 'string',\r\n    exportGroup: 'Thông tin cơ bản',\r\n    example: 'Không',\r\n  },\r\n  {\r\n    key: 'maritalStatus',\r\n    label: 'Tình trạng hôn nhân',\r\n    required: false,\r\n    type: 'string',\r\n    exportGroup: 'Thông tin cơ bản',\r\n    example: 'single',\r\n  },\r\n  {\r\n    key: 'avatar',\r\n    label: 'Ảnh đại diện',\r\n    required: false,\r\n    type: 'string',\r\n    exportGroup: 'Thông tin cơ bản',\r\n    hidden: true,\r\n  },\r\n\r\n  // ===== THÔNG TIN ĐĂNG NHẬP =====\r\n  {\r\n    key: 'workEmail',\r\n    label: 'Email công ty',\r\n    required: false,\r\n    type: 'string',\r\n    exportGroup: 'Thông tin đăng nhập',\r\n    example: 'nguyenvana@company.com',\r\n    validator: (value: unknown) => {\r\n      if (!value) return true;\r\n      const emailRegex = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;\r\n      return emailRegex.test(String(value)) || 'Email không hợp lệ';\r\n    },\r\n  },\r\n  {\r\n    key: 'password',\r\n    label: 'Mật khẩu',\r\n    required: false,\r\n    type: 'string',\r\n    exportGroup: 'Thông tin đăng nhập',\r\n    example: '********',\r\n    hidden: true, // Không export mật khẩu\r\n  },\r\n  {\r\n    key: 'role',\r\n    label: 'Vai trò hệ thống (*Mặc định: employee)',\r\n    required: false,\r\n    type: 'string',\r\n    exportGroup: 'Thông tin đăng nhập',\r\n    example: 'employee',\r\n    defaultValue: 'employee',\r\n  },\r\n\r\n  // ===== GIẤY TỜ TÙY THÂN =====\r\n  {\r\n    key: 'nationalId',\r\n    label: 'CMND/CCCD',\r\n    required: false,\r\n    type: 'string',\r\n    exportGroup: 'Giấy tờ tùy thân',\r\n    example: '012345678901',\r\n  },\r\n  {\r\n    key: 'nationalIdIssueDate',\r\n    label: 'Ngày cấp CMND/CCCD',\r\n    required: false,\r\n    type: 'date',\r\n    exportGroup: 'Giấy tờ tùy thân',\r\n    example: '2020-01-15',\r\n  },\r\n  {\r\n    key: 'nationalIdIssuePlace',\r\n    label: 'Nơi cấp CMND/CCCD',\r\n    required: false,\r\n    type: 'string',\r\n    exportGroup: 'Giấy tờ tùy thân',\r\n    example: 'CA TP Hà Nội',\r\n  },\r\n  {\r\n    key: 'personalTaxId',\r\n    label: 'Mã số thuế cá nhân',\r\n    required: false,\r\n    type: 'string',\r\n    exportGroup: 'Giấy tờ tùy thân',\r\n    example: '0123456789',\r\n  },\r\n  {\r\n    key: 'socialInsuranceNumber',\r\n    label: 'Số sổ BHXH',\r\n    required: false,\r\n    type: 'string',\r\n    exportGroup: 'Giấy tờ tùy thân',\r\n    example: '1234567890',\r\n  },\r\n\r\n  // ===== LIÊN HỆ =====\r\n  {\r\n    key: 'personalEmail',\r\n    label: 'Email cá nhân',\r\n    required: false,\r\n    type: 'string',\r\n    exportGroup: 'Liên hệ',\r\n    example: 'nguyenvana@gmail.com',\r\n    validator: (value: unknown) => {\r\n      if (!value) return true;\r\n      const emailRegex = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;\r\n      return emailRegex.test(String(value)) || 'Email không hợp lệ';\r\n    },\r\n  },\r\n  {\r\n    key: 'phone',\r\n    label: 'Số điện thoại',\r\n    required: false,\r\n    type: 'string',\r\n    exportGroup: 'Liên hệ',\r\n    example: '0901234567',\r\n  },\r\n  \r\n  // ===== ĐỊA CHỈ THƯỜNG TRÚ (hệ thống 2 cấp) =====\r\n  {\r\n    key: 'permanentAddress.province',\r\n    label: 'Tỉnh/TP thường trú',\r\n    required: false,\r\n    type: 'string',\r\n    exportGroup: 'Địa chỉ thường trú',\r\n    example: 'Hà Nội',\r\n  },\r\n  {\r\n    key: 'permanentAddress.ward',\r\n    label: 'Phường/Xã thường trú',\r\n    required: false,\r\n    type: 'string',\r\n    exportGroup: 'Địa chỉ thường trú',\r\n    example: 'Phường Điện Biên',\r\n  },\r\n  {\r\n    key: 'permanentAddress.street',\r\n    label: 'Số nhà, đường thường trú',\r\n    required: false,\r\n    type: 'string',\r\n    exportGroup: 'Địa chỉ thường trú',\r\n    example: '123 Đường ABC',\r\n  },\r\n\r\n  // ===== ĐỊA CHỈ TẠM TRÚ (hệ thống 2 cấp) =====\r\n  {\r\n    key: 'temporaryAddress.province',\r\n    label: 'Tỉnh/TP tạm trú',\r\n    required: false,\r\n    type: 'string',\r\n    exportGroup: 'Địa chỉ tạm trú',\r\n    example: 'Hà Nội',\r\n  },\r\n  {\r\n    key: 'temporaryAddress.ward',\r\n    label: 'Phường/Xã tạm trú',\r\n    required: false,\r\n    type: 'string',\r\n    exportGroup: 'Địa chỉ tạm trú',\r\n    example: 'Phường Cống Vị',\r\n  },\r\n  {\r\n    key: 'temporaryAddress.street',\r\n    label: 'Số nhà, đường tạm trú',\r\n    required: false,\r\n    type: 'string',\r\n    exportGroup: 'Địa chỉ tạm trú',\r\n    example: '456 Đường XYZ',\r\n  },\r\n\r\n  // ===== LIÊN HỆ KHẨN CẤP =====\r\n  {\r\n    key: 'emergencyContactName',\r\n    label: 'Người liên hệ khẩn cấp',\r\n    required: false,\r\n    type: 'string',\r\n    exportGroup: 'Liên hệ khẩn cấp',\r\n    example: 'Nguyễn Văn B',\r\n  },\r\n  {\r\n    key: 'emergencyContactPhone',\r\n    label: 'SĐT khẩn cấp',\r\n    required: false,\r\n    type: 'string',\r\n    exportGroup: 'Liên hệ khẩn cấp',\r\n    example: '0908765432',\r\n  },\r\n\r\n  // ===== CÔNG VIỆC =====\r\n  {\r\n    key: 'departmentId',\r\n    label: 'Mã phòng ban',\r\n    required: false,\r\n    type: 'string',\r\n    exportGroup: 'Công việc',\r\n    example: 'PB001',\r\n  },\r\n  {\r\n    key: 'departmentName',\r\n    label: 'Tên phòng ban',\r\n    required: false,\r\n    type: 'string',\r\n    exportGroup: 'Công việc',\r\n    example: 'Phòng Kinh doanh',\r\n  },\r\n  {\r\n    key: 'department',\r\n    label: 'Bộ phận',\r\n    required: false,\r\n    type: 'string',\r\n    exportGroup: 'Công việc',\r\n    example: 'Kinh doanh',\r\n  },\r\n  {\r\n    key: 'positionId',\r\n    label: 'Mã chức vụ',\r\n    required: false,\r\n    type: 'string',\r\n    exportGroup: 'Công việc',\r\n    example: 'CV001',\r\n  },\r\n  {\r\n    key: 'positionName',\r\n    label: 'Tên chức vụ',\r\n    required: false,\r\n    type: 'string',\r\n    exportGroup: 'Công việc',\r\n    example: 'Trưởng phòng',\r\n  },\r\n  {\r\n    key: 'jobTitle',\r\n    label: 'Chức danh',\r\n    required: false,\r\n    type: 'string',\r\n    exportGroup: 'Công việc',\r\n    example: 'Nhân viên kinh doanh',\r\n  },\r\n  {\r\n    key: 'employeeType',\r\n    label: 'Loại nhân viên',\r\n    required: false,\r\n    type: 'string',\r\n    exportGroup: 'Công việc',\r\n    example: 'Chính thức',\r\n  },\r\n  {\r\n    key: 'employmentStatus',\r\n    label: 'Trạng thái làm việc (*Mặc định: Đang làm việc)',\r\n    required: false,\r\n    type: 'string',\r\n    exportGroup: 'Công việc',\r\n    example: 'Đang làm việc',\r\n    defaultValue: 'Đang làm việc',\r\n  },\r\n  {\r\n    key: 'status',\r\n    label: 'Trạng thái (*Mặc định: active)',\r\n    required: false,\r\n    type: 'string',\r\n    exportGroup: 'Công việc',\r\n    example: 'active',\r\n    defaultValue: 'active',\r\n  },\r\n  {\r\n    key: 'hireDate',\r\n    label: 'Ngày tuyển dụng',\r\n    required: false,\r\n    type: 'date',\r\n    exportGroup: 'Công việc',\r\n    example: '2023-01-01',\r\n  },\r\n  {\r\n    key: 'startDate',\r\n    label: 'Ngày bắt đầu làm việc',\r\n    required: false,\r\n    type: 'date',\r\n    exportGroup: 'Công việc',\r\n    example: '2023-01-15',\r\n  },\r\n  {\r\n    key: 'endDate',\r\n    label: 'Ngày kết thúc',\r\n    required: false,\r\n    type: 'date',\r\n    exportGroup: 'Công việc',\r\n    example: '',\r\n  },\r\n  {\r\n    key: 'terminationDate',\r\n    label: 'Ngày nghỉ việc',\r\n    required: false,\r\n    type: 'date',\r\n    exportGroup: 'Công việc',\r\n    example: '',\r\n  },\r\n  {\r\n    key: 'reasonForLeaving',\r\n    label: 'Lý do nghỉ việc',\r\n    required: false,\r\n    type: 'string',\r\n    exportGroup: 'Công việc',\r\n    example: '',\r\n  },\r\n  {\r\n    key: 'branchSystemId',\r\n    label: 'Mã chi nhánh',\r\n    required: false,\r\n    type: 'string',\r\n    exportGroup: 'Công việc',\r\n    example: 'CN001',\r\n  },\r\n\r\n  // ===== THỬ VIỆC & HỢP ĐỒNG =====\r\n  {\r\n    key: 'probationEndDate',\r\n    label: 'Ngày kết thúc thử việc',\r\n    required: false,\r\n    type: 'date',\r\n    exportGroup: 'Thử việc & Hợp đồng',\r\n    example: '2023-03-31',\r\n  },\r\n  {\r\n    key: 'contractNumber',\r\n    label: 'Số hợp đồng',\r\n    required: false,\r\n    type: 'string',\r\n    exportGroup: 'Thử việc & Hợp đồng',\r\n    example: 'HD-2023-001',\r\n  },\r\n  {\r\n    key: 'contractType',\r\n    label: 'Loại hợp đồng',\r\n    required: false,\r\n    type: 'string',\r\n    exportGroup: 'Thử việc & Hợp đồng',\r\n    example: 'definite',\r\n  },\r\n  {\r\n    key: 'contractStartDate',\r\n    label: 'Ngày bắt đầu HĐ',\r\n    required: false,\r\n    type: 'date',\r\n    exportGroup: 'Thử việc & Hợp đồng',\r\n    example: '2023-04-01',\r\n  },\r\n  {\r\n    key: 'contractEndDate',\r\n    label: 'Ngày kết thúc HĐ',\r\n    required: false,\r\n    type: 'date',\r\n    exportGroup: 'Thử việc & Hợp đồng',\r\n    example: '2024-03-31',\r\n  },\r\n\r\n  // ===== THỜI GIAN LÀM VIỆC =====\r\n  {\r\n    key: 'workingHoursPerDay',\r\n    label: 'Số giờ/ngày (*Mặc định: 8)',\r\n    required: false,\r\n    type: 'number',\r\n    exportGroup: 'Thời gian làm việc',\r\n    example: '8',\r\n    defaultValue: 8,\r\n  },\r\n  {\r\n    key: 'workingDaysPerWeek',\r\n    label: 'Số ngày/tuần (*Mặc định: 5)',\r\n    required: false,\r\n    type: 'number',\r\n    exportGroup: 'Thời gian làm việc',\r\n    example: '5',\r\n    defaultValue: 5,\r\n  },\r\n  {\r\n    key: 'shiftType',\r\n    label: 'Ca làm việc',\r\n    required: false,\r\n    type: 'string',\r\n    exportGroup: 'Thời gian làm việc',\r\n    example: 'day',\r\n  },\r\n\r\n  // ===== LƯƠNG & THU NHẬP =====\r\n  {\r\n    key: 'baseSalary',\r\n    label: 'Lương cơ bản',\r\n    required: false,\r\n    type: 'number',\r\n    exportGroup: 'Lương & Thu nhập',\r\n    example: '15000000',\r\n  },\r\n  {\r\n    key: 'socialInsuranceSalary',\r\n    label: 'Lương đóng BHXH',\r\n    required: false,\r\n    type: 'number',\r\n    exportGroup: 'Lương & Thu nhập',\r\n    example: '10000000',\r\n  },\r\n  {\r\n    key: 'positionAllowance',\r\n    label: 'Phụ cấp chức vụ',\r\n    required: false,\r\n    type: 'number',\r\n    exportGroup: 'Lương & Thu nhập',\r\n    example: '2000000',\r\n  },\r\n  {\r\n    key: 'mealAllowance',\r\n    label: 'Phụ cấp ăn trưa',\r\n    required: false,\r\n    type: 'number',\r\n    exportGroup: 'Lương & Thu nhập',\r\n    example: '730000',\r\n  },\r\n  {\r\n    key: 'otherAllowances',\r\n    label: 'Phụ cấp khác',\r\n    required: false,\r\n    type: 'number',\r\n    exportGroup: 'Lương & Thu nhập',\r\n    example: '500000',\r\n  },\r\n  {\r\n    key: 'numberOfDependents',\r\n    label: 'Số người phụ thuộc',\r\n    required: false,\r\n    type: 'number',\r\n    exportGroup: 'Lương & Thu nhập',\r\n    example: '1',\r\n  },\r\n\r\n  // ===== NGÂN HÀNG =====\r\n  {\r\n    key: 'bankAccountNumber',\r\n    label: 'Số tài khoản',\r\n    required: false,\r\n    type: 'string',\r\n    exportGroup: 'Ngân hàng',\r\n    example: '1234567890123',\r\n  },\r\n  {\r\n    key: 'bankName',\r\n    label: 'Ngân hàng',\r\n    required: false,\r\n    type: 'string',\r\n    exportGroup: 'Ngân hàng',\r\n    example: 'Vietcombank',\r\n  },\r\n  {\r\n    key: 'bankBranch',\r\n    label: 'Chi nhánh',\r\n    required: false,\r\n    type: 'string',\r\n    exportGroup: 'Ngân hàng',\r\n    example: 'CN Hà Nội',\r\n  },\r\n\r\n  // ===== NGHỈ PHÉP =====\r\n  {\r\n    key: 'annualLeaveBalance',\r\n    label: 'Số ngày phép còn',\r\n    required: false,\r\n    type: 'number',\r\n    exportGroup: 'Nghỉ phép',\r\n    example: '12',\r\n  },\r\n  {\r\n    key: 'leaveTaken',\r\n    label: 'Số ngày đã nghỉ (*Mặc định: 0)',\r\n    required: false,\r\n    type: 'number',\r\n    exportGroup: 'Nghỉ phép',\r\n    example: '3',\r\n    defaultValue: 0,\r\n  },\r\n  {\r\n    key: 'paidLeaveTaken',\r\n    label: 'Nghỉ phép có lương',\r\n    required: false,\r\n    type: 'number',\r\n    exportGroup: 'Nghỉ phép',\r\n    example: '2',\r\n  },\r\n  {\r\n    key: 'unpaidLeaveTaken',\r\n    label: 'Nghỉ phép không lương',\r\n    required: false,\r\n    type: 'number',\r\n    exportGroup: 'Nghỉ phép',\r\n    example: '1',\r\n  },\r\n  {\r\n    key: 'annualLeaveTaken',\r\n    label: 'Nghỉ phép năm đã dùng',\r\n    required: false,\r\n    type: 'number',\r\n    exportGroup: 'Nghỉ phép',\r\n    example: '5',\r\n  },\r\n\r\n  // ===== ĐÁNH GIÁ =====\r\n  {\r\n    key: 'performanceRating',\r\n    label: 'Đánh giá hiệu suất',\r\n    required: false,\r\n    type: 'number',\r\n    exportGroup: 'Đánh giá',\r\n    example: '4',\r\n  },\r\n  {\r\n    key: 'lastReviewDate',\r\n    label: 'Ngày đánh giá gần nhất',\r\n    required: false,\r\n    type: 'date',\r\n    exportGroup: 'Đánh giá',\r\n    example: '2023-12-15',\r\n  },\r\n  {\r\n    key: 'nextReviewDate',\r\n    label: 'Ngày đánh giá tiếp theo',\r\n    required: false,\r\n    type: 'date',\r\n    exportGroup: 'Đánh giá',\r\n    example: '2024-06-15',\r\n  },\r\n\r\n  // ===== KỸ NĂNG & CHỨNG CHỈ =====\r\n  {\r\n    key: 'skills',\r\n    label: 'Kỹ năng',\r\n    required: false,\r\n    type: 'string',\r\n    exportGroup: 'Kỹ năng & Chứng chỉ',\r\n    example: 'Excel, PowerPoint, Quản lý dự án',\r\n    transform: (value) => {\r\n      if (Array.isArray(value)) return value.join(', ');\r\n      return value;\r\n    },\r\n    reverseTransform: (value) => {\r\n      if (typeof value === 'string') {\r\n        return value.split(',').map(s => s.trim()).filter(Boolean);\r\n      }\r\n      return value;\r\n    },\r\n  },\r\n  {\r\n    key: 'certifications',\r\n    label: 'Chứng chỉ',\r\n    required: false,\r\n    type: 'string',\r\n    exportGroup: 'Kỹ năng & Chứng chỉ',\r\n    example: 'PMP, IELTS 7.0',\r\n    transform: (value) => {\r\n      if (Array.isArray(value)) return value.join(', ');\r\n      return value;\r\n    },\r\n    reverseTransform: (value) => {\r\n      if (typeof value === 'string') {\r\n        return value.split(',').map(s => s.trim()).filter(Boolean);\r\n      }\r\n      return value;\r\n    },\r\n  },\r\n\r\n  // ===== SƠ ĐỒ TỔ CHỨC =====\r\n  {\r\n    key: 'managerId',\r\n    label: 'Mã quản lý trực tiếp',\r\n    required: false,\r\n    type: 'string',\r\n    exportGroup: 'Sơ đồ tổ chức',\r\n    example: 'NV000',\r\n  },\r\n\r\n  // ===== HỌC VẤN =====\r\n  {\r\n    key: 'educationLevel',\r\n    label: 'Trình độ học vấn',\r\n    required: false,\r\n    type: 'string',\r\n    exportGroup: 'Học vấn',\r\n    example: 'Đại học',\r\n  },\r\n  {\r\n    key: 'major',\r\n    label: 'Chuyên ngành',\r\n    required: false,\r\n    type: 'string',\r\n    exportGroup: 'Học vấn',\r\n    example: 'Quản trị kinh doanh',\r\n  },\r\n  {\r\n    key: 'graduationYear',\r\n    label: 'Năm tốt nghiệp',\r\n    required: false,\r\n    type: 'number',\r\n    exportGroup: 'Học vấn',\r\n    example: '2018',\r\n  },\r\n  {\r\n    key: 'school',\r\n    label: 'Trường',\r\n    required: false,\r\n    type: 'string',\r\n    exportGroup: 'Học vấn',\r\n    example: 'Đại học Kinh tế Quốc dân',\r\n  },\r\n\r\n  // ===== GHI CHÚ =====\r\n  {\r\n    key: 'notes',\r\n    label: 'Ghi chú',\r\n    required: false,\r\n    type: 'string',\r\n    exportGroup: 'Khác',\r\n    example: '',\r\n  },\r\n\r\n  // ===== DỮ LIỆU HỆ THỐNG (hidden, không import) =====\r\n  {\r\n    key: 'systemId',\r\n    label: 'System ID',\r\n    required: false,\r\n    type: 'string',\r\n    exportGroup: 'Hệ thống',\r\n    hidden: true, // Không hiển thị khi import\r\n  },\r\n  {\r\n    key: 'avatarUrl',\r\n    label: 'URL ảnh đại diện',\r\n    required: false,\r\n    type: 'string',\r\n    exportGroup: 'Hệ thống',\r\n    hidden: true,\r\n  },\r\n  {\r\n    key: 'createdAt',\r\n    label: 'Ngày tạo',\r\n    required: false,\r\n    type: 'date',\r\n    exportGroup: 'Hệ thống',\r\n    hidden: true,\r\n  },\r\n  {\r\n    key: 'updatedAt',\r\n    label: 'Ngày cập nhật',\r\n    required: false,\r\n    type: 'date',\r\n    exportGroup: 'Hệ thống',\r\n    hidden: true,\r\n  },\r\n];\r\n\r\n/**\r\n * Post-transform để xử lý địa chỉ thường trú và tạm trú\r\n * Được tạo bởi normalizeEmployeeRawRow từ các cột:\r\n * - __permanentAddress__: Địa chỉ thường trú\r\n * - __temporaryAddress__: Địa chỉ tạm trú\r\n */\r\nfunction processEmployeeAddresses(row: Partial<Employee>): Partial<Employee> {\r\n  const result = { ...row };\r\n  const rawData = row as Record<string, unknown>;\r\n  \r\n  // Xử lý địa chỉ thường trú\r\n  const permanentRaw = rawData['__permanentAddress__'] as {\r\n    province?: string;\r\n    ward?: string;\r\n    street?: string;\r\n    inputLevel?: '2-level' | '3-level';\r\n  } | undefined;\r\n  \r\n  if (permanentRaw && (permanentRaw.province || permanentRaw.ward || permanentRaw.street)) {\r\n    // Enrich with IDs using address lookup\r\n    const enriched = enrichEmployeeAddresses({\r\n      permanentAddress: {\r\n        province: permanentRaw.province || '',\r\n        ward: permanentRaw.ward || '',\r\n        street: permanentRaw.street || '',\r\n        inputLevel: permanentRaw.inputLevel || '2-level',\r\n      } as Employee['permanentAddress'],\r\n    });\r\n    \r\n    if (enriched.permanentAddress) {\r\n      result.permanentAddress = enriched.permanentAddress;\r\n    }\r\n    \r\n    // Remove temporary field\r\n    delete (result as Record<string, unknown>)['__permanentAddress__'];\r\n  }\r\n  \r\n  // Xử lý địa chỉ tạm trú\r\n  const temporaryRaw = rawData['__temporaryAddress__'] as {\r\n    province?: string;\r\n    ward?: string;\r\n    street?: string;\r\n    inputLevel?: '2-level' | '3-level';\r\n  } | undefined;\r\n  \r\n  if (temporaryRaw && (temporaryRaw.province || temporaryRaw.ward || temporaryRaw.street)) {\r\n    // Enrich with IDs using address lookup\r\n    const enriched = enrichEmployeeAddresses({\r\n      temporaryAddress: {\r\n        province: temporaryRaw.province || '',\r\n        ward: temporaryRaw.ward || '',\r\n        street: temporaryRaw.street || '',\r\n        inputLevel: temporaryRaw.inputLevel || '2-level',\r\n      } as Employee['temporaryAddress'],\r\n    });\r\n    \r\n    if (enriched.temporaryAddress) {\r\n      result.temporaryAddress = enriched.temporaryAddress;\r\n    }\r\n    \r\n    // Remove temporary field\r\n    delete (result as Record<string, unknown>)['__temporaryAddress__'];\r\n  }\r\n  \r\n  return result;\r\n}\r\n\r\nexport const employeeConfig: ImportExportConfig<Employee> = {\r\n  entityType: 'employees',\r\n  entityDisplayName: 'Nhân viên',\r\n  fields: employeeFields,\r\n  upsertKey: 'id', // Dùng mã nhân viên để đối chiếu khi UPDATE\r\n  templateFileName: 'mau-import-nhan-vien.xlsx',\r\n  \r\n  // Pre-transform: Normalize raw row từ template mới (merge 2-level/3-level columns)\r\n  preTransformRawRow: normalizeEmployeeRawRow,\r\n  \r\n  // Post-transform: Process addresses and lookup IDs\r\n  postTransformRow: processEmployeeAddresses,\r\n};\r\n\r\n// Re-export with old names for backward compatibility\r\nexport const employeeImportExportConfig = employeeConfig;\r\nexport { employeeFields };\r\n\r\nexport default employeeConfig;\r\n"],"names":[],"mappings":";;;;;;;;;;AAEA;;AAkBA,SAAS,uBAAuB,MAA+B;IAC7D,MAAM,YAA6B,EAAE;IAErC,qBAAqB;IACrB,MAAM,oBAAoB,MAAM,CAAC,qBAAqB;IACtD,MAAM,gBAAgB,MAAM,CAAC,uBAAuB;IACpD,MAAM,kBAAkB,MAAM,CAAC,2BAA2B;IAE1D,IAAI,qBAAqB,iBAAiB,iBAAiB;QACzD,UAAU,IAAI,CAAC;YACb,MAAM;YACN,UAAU,OAAO,qBAAqB;YACtC,MAAM,OAAO,iBAAiB;YAC9B,QAAQ,OAAO,mBAAmB;QACpC;IACF;IAEA,kBAAkB;IAClB,MAAM,oBAAoB,MAAM,CAAC,kBAAkB;IACnD,MAAM,gBAAgB,MAAM,CAAC,oBAAoB;IACjD,MAAM,kBAAkB,MAAM,CAAC,wBAAwB;IAEvD,IAAI,qBAAqB,iBAAiB,iBAAiB;QACzD,UAAU,IAAI,CAAC;YACb,MAAM;YACN,UAAU,OAAO,qBAAqB;YACtC,MAAM,OAAO,iBAAiB;YAC9B,QAAQ,OAAO,mBAAmB;QACpC;IACF;IAEA,OAAO;AACT;AAEA;;;CAGC,GACD,SAAS,wBAAwB,MAA+B;IAC9D,MAAM,SAAS;QAAE,GAAG,MAAM;IAAC;IAE3B,MAAM,kBAAkB,uBAAuB;IAE/C,KAAK,MAAM,QAAQ,gBAAiB;QAClC,IAAI,KAAK,IAAI,KAAK,aAAa;YAC7B,yCAAyC;YACzC,MAAM,CAAC,uBAAuB,GAAG;gBAC/B,UAAU,KAAK,QAAQ;gBACvB,MAAM,KAAK,IAAI;gBACf,QAAQ,KAAK,MAAM;gBACnB,YAAY;YACd;QACF,OAAO,IAAI,KAAK,IAAI,KAAK,aAAa;YACpC,sCAAsC;YACtC,MAAM,CAAC,uBAAuB,GAAG;gBAC/B,UAAU,KAAK,QAAQ;gBACvB,MAAM,KAAK,IAAI;gBACf,QAAQ,KAAK,MAAM;gBACnB,YAAY;YACd;QACF;IACF;IAEA,OAAO;AACT;AAEA,wDAAwD;AACxD,0DAA0D;AAC1D,MAAM,iBAA0C;IAC9C,+BAA+B;IAC/B;QACE,KAAK;QACL,OAAO;QACP,UAAU;QACV,MAAM;QACN,aAAa;QACb,SAAS;IACX;IACA;QACE,KAAK;QACL,OAAO;QACP,UAAU;QACV,MAAM;QACN,aAAa;QACb,SAAS;IACX;IACA;QACE,KAAK;QACL,OAAO;QACP,UAAU;QACV,MAAM;QACN,aAAa;QACb,SAAS;IACX;IACA;QACE,KAAK;QACL,OAAO;QACP,UAAU;QACV,MAAM;QACN,aAAa;QACb,SAAS;IACX;IACA;QACE,KAAK;QACL,OAAO;QACP,UAAU;QACV,MAAM;QACN,aAAa;QACb,SAAS;IACX;IACA;QACE,KAAK;QACL,OAAO;QACP,UAAU;QACV,MAAM;QACN,aAAa;QACb,SAAS;IACX;IACA;QACE,KAAK;QACL,OAAO;QACP,UAAU;QACV,MAAM;QACN,aAAa;QACb,SAAS;IACX;IACA;QACE,KAAK;QACL,OAAO;QACP,UAAU;QACV,MAAM;QACN,aAAa;QACb,SAAS;IACX;IACA;QACE,KAAK;QACL,OAAO;QACP,UAAU;QACV,MAAM;QACN,aAAa;QACb,QAAQ;IACV;IAEA,kCAAkC;IAClC;QACE,KAAK;QACL,OAAO;QACP,UAAU;QACV,MAAM;QACN,aAAa;QACb,SAAS;QACT,WAAW,CAAC;YACV,IAAI,CAAC,OAAO,OAAO;YACnB,MAAM,aAAa;YACnB,OAAO,WAAW,IAAI,CAAC,OAAO,WAAW;QAC3C;IACF;IACA;QACE,KAAK;QACL,OAAO;QACP,UAAU;QACV,MAAM;QACN,aAAa;QACb,SAAS;QACT,QAAQ;IACV;IACA;QACE,KAAK;QACL,OAAO;QACP,UAAU;QACV,MAAM;QACN,aAAa;QACb,SAAS;QACT,cAAc;IAChB;IAEA,+BAA+B;IAC/B;QACE,KAAK;QACL,OAAO;QACP,UAAU;QACV,MAAM;QACN,aAAa;QACb,SAAS;IACX;IACA;QACE,KAAK;QACL,OAAO;QACP,UAAU;QACV,MAAM;QACN,aAAa;QACb,SAAS;IACX;IACA;QACE,KAAK;QACL,OAAO;QACP,UAAU;QACV,MAAM;QACN,aAAa;QACb,SAAS;IACX;IACA;QACE,KAAK;QACL,OAAO;QACP,UAAU;QACV,MAAM;QACN,aAAa;QACb,SAAS;IACX;IACA;QACE,KAAK;QACL,OAAO;QACP,UAAU;QACV,MAAM;QACN,aAAa;QACb,SAAS;IACX;IAEA,sBAAsB;IACtB;QACE,KAAK;QACL,OAAO;QACP,UAAU;QACV,MAAM;QACN,aAAa;QACb,SAAS;QACT,WAAW,CAAC;YACV,IAAI,CAAC,OAAO,OAAO;YACnB,MAAM,aAAa;YACnB,OAAO,WAAW,IAAI,CAAC,OAAO,WAAW;QAC3C;IACF;IACA;QACE,KAAK;QACL,OAAO;QACP,UAAU;QACV,MAAM;QACN,aAAa;QACb,SAAS;IACX;IAEA,kDAAkD;IAClD;QACE,KAAK;QACL,OAAO;QACP,UAAU;QACV,MAAM;QACN,aAAa;QACb,SAAS;IACX;IACA;QACE,KAAK;QACL,OAAO;QACP,UAAU;QACV,MAAM;QACN,aAAa;QACb,SAAS;IACX;IACA;QACE,KAAK;QACL,OAAO;QACP,UAAU;QACV,MAAM;QACN,aAAa;QACb,SAAS;IACX;IAEA,+CAA+C;IAC/C;QACE,KAAK;QACL,OAAO;QACP,UAAU;QACV,MAAM;QACN,aAAa;QACb,SAAS;IACX;IACA;QACE,KAAK;QACL,OAAO;QACP,UAAU;QACV,MAAM;QACN,aAAa;QACb,SAAS;IACX;IACA;QACE,KAAK;QACL,OAAO;QACP,UAAU;QACV,MAAM;QACN,aAAa;QACb,SAAS;IACX;IAEA,+BAA+B;IAC/B;QACE,KAAK;QACL,OAAO;QACP,UAAU;QACV,MAAM;QACN,aAAa;QACb,SAAS;IACX;IACA;QACE,KAAK;QACL,OAAO;QACP,UAAU;QACV,MAAM;QACN,aAAa;QACb,SAAS;IACX;IAEA,wBAAwB;IACxB;QACE,KAAK;QACL,OAAO;QACP,UAAU;QACV,MAAM;QACN,aAAa;QACb,SAAS;IACX;IACA;QACE,KAAK;QACL,OAAO;QACP,UAAU;QACV,MAAM;QACN,aAAa;QACb,SAAS;IACX;IACA;QACE,KAAK;QACL,OAAO;QACP,UAAU;QACV,MAAM;QACN,aAAa;QACb,SAAS;IACX;IACA;QACE,KAAK;QACL,OAAO;QACP,UAAU;QACV,MAAM;QACN,aAAa;QACb,SAAS;IACX;IACA;QACE,KAAK;QACL,OAAO;QACP,UAAU;QACV,MAAM;QACN,aAAa;QACb,SAAS;IACX;IACA;QACE,KAAK;QACL,OAAO;QACP,UAAU;QACV,MAAM;QACN,aAAa;QACb,SAAS;IACX;IACA;QACE,KAAK;QACL,OAAO;QACP,UAAU;QACV,MAAM;QACN,aAAa;QACb,SAAS;IACX;IACA;QACE,KAAK;QACL,OAAO;QACP,UAAU;QACV,MAAM;QACN,aAAa;QACb,SAAS;QACT,cAAc;IAChB;IACA;QACE,KAAK;QACL,OAAO;QACP,UAAU;QACV,MAAM;QACN,aAAa;QACb,SAAS;QACT,cAAc;IAChB;IACA;QACE,KAAK;QACL,OAAO;QACP,UAAU;QACV,MAAM;QACN,aAAa;QACb,SAAS;IACX;IACA;QACE,KAAK;QACL,OAAO;QACP,UAAU;QACV,MAAM;QACN,aAAa;QACb,SAAS;IACX;IACA;QACE,KAAK;QACL,OAAO;QACP,UAAU;QACV,MAAM;QACN,aAAa;QACb,SAAS;IACX;IACA;QACE,KAAK;QACL,OAAO;QACP,UAAU;QACV,MAAM;QACN,aAAa;QACb,SAAS;IACX;IACA;QACE,KAAK;QACL,OAAO;QACP,UAAU;QACV,MAAM;QACN,aAAa;QACb,SAAS;IACX;IACA;QACE,KAAK;QACL,OAAO;QACP,UAAU;QACV,MAAM;QACN,aAAa;QACb,SAAS;IACX;IAEA,kCAAkC;IAClC;QACE,KAAK;QACL,OAAO;QACP,UAAU;QACV,MAAM;QACN,aAAa;QACb,SAAS;IACX;IACA;QACE,KAAK;QACL,OAAO;QACP,UAAU;QACV,MAAM;QACN,aAAa;QACb,SAAS;IACX;IACA;QACE,KAAK;QACL,OAAO;QACP,UAAU;QACV,MAAM;QACN,aAAa;QACb,SAAS;IACX;IACA;QACE,KAAK;QACL,OAAO;QACP,UAAU;QACV,MAAM;QACN,aAAa;QACb,SAAS;IACX;IACA;QACE,KAAK;QACL,OAAO;QACP,UAAU;QACV,MAAM;QACN,aAAa;QACb,SAAS;IACX;IAEA,iCAAiC;IACjC;QACE,KAAK;QACL,OAAO;QACP,UAAU;QACV,MAAM;QACN,aAAa;QACb,SAAS;QACT,cAAc;IAChB;IACA;QACE,KAAK;QACL,OAAO;QACP,UAAU;QACV,MAAM;QACN,aAAa;QACb,SAAS;QACT,cAAc;IAChB;IACA;QACE,KAAK;QACL,OAAO;QACP,UAAU;QACV,MAAM;QACN,aAAa;QACb,SAAS;IACX;IAEA,+BAA+B;IAC/B;QACE,KAAK;QACL,OAAO;QACP,UAAU;QACV,MAAM;QACN,aAAa;QACb,SAAS;IACX;IACA;QACE,KAAK;QACL,OAAO;QACP,UAAU;QACV,MAAM;QACN,aAAa;QACb,SAAS;IACX;IACA;QACE,KAAK;QACL,OAAO;QACP,UAAU;QACV,MAAM;QACN,aAAa;QACb,SAAS;IACX;IACA;QACE,KAAK;QACL,OAAO;QACP,UAAU;QACV,MAAM;QACN,aAAa;QACb,SAAS;IACX;IACA;QACE,KAAK;QACL,OAAO;QACP,UAAU;QACV,MAAM;QACN,aAAa;QACb,SAAS;IACX;IACA;QACE,KAAK;QACL,OAAO;QACP,UAAU;QACV,MAAM;QACN,aAAa;QACb,SAAS;IACX;IAEA,wBAAwB;IACxB;QACE,KAAK;QACL,OAAO;QACP,UAAU;QACV,MAAM;QACN,aAAa;QACb,SAAS;IACX;IACA;QACE,KAAK;QACL,OAAO;QACP,UAAU;QACV,MAAM;QACN,aAAa;QACb,SAAS;IACX;IACA;QACE,KAAK;QACL,OAAO;QACP,UAAU;QACV,MAAM;QACN,aAAa;QACb,SAAS;IACX;IAEA,wBAAwB;IACxB;QACE,KAAK;QACL,OAAO;QACP,UAAU;QACV,MAAM;QACN,aAAa;QACb,SAAS;IACX;IACA;QACE,KAAK;QACL,OAAO;QACP,UAAU;QACV,MAAM;QACN,aAAa;QACb,SAAS;QACT,cAAc;IAChB;IACA;QACE,KAAK;QACL,OAAO;QACP,UAAU;QACV,MAAM;QACN,aAAa;QACb,SAAS;IACX;IACA;QACE,KAAK;QACL,OAAO;QACP,UAAU;QACV,MAAM;QACN,aAAa;QACb,SAAS;IACX;IACA;QACE,KAAK;QACL,OAAO;QACP,UAAU;QACV,MAAM;QAC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"}},
    {"offset": {"line": 2717, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/lib/import-export/configs/attendance.config.ts"],"sourcesContent":["/**\r\n * Attendance Import/Export Config\r\n * \r\n * Cấu hình import chấm công từ máy CC\r\n * \r\n * ⚠️ LƯU Ý: File từ máy CC có format đặc biệt\r\n * - Sheet \"Bảng tổng hợp chấm công\"\r\n * - Header phức tạp (2 dòng, merged cells)\r\n * - Mã NV máy CC khác mã NV hệ thống → cần mapping\r\n */\r\n\r\nimport type { ImportExportConfig, FieldConfig, AttendanceImportRow } from '../types';\r\n\r\n// ============================================\r\n// FIELD DEFINITIONS\r\n// ============================================\r\n\r\nconst attendanceFields: FieldConfig<AttendanceImportRow>[] = [\r\n  {\r\n    key: 'machineEmployeeId',\r\n    label: 'Mã NV (máy) (*)',\r\n    required: true,\r\n    type: 'number',\r\n    example: '1',\r\n    exportGroup: 'Thông tin NV',\r\n    defaultSelected: true,\r\n  },\r\n  {\r\n    key: 'employeeName',\r\n    label: 'Họ tên (*)',\r\n    required: true,\r\n    type: 'string',\r\n    example: 'nguyen van a',\r\n    exportGroup: 'Thông tin NV',\r\n    defaultSelected: true,\r\n  },\r\n  {\r\n    key: 'department',\r\n    label: 'Phòng ban',\r\n    type: 'string',\r\n    example: 'CÔNG TY',\r\n    exportGroup: 'Thông tin NV',\r\n  },\r\n  {\r\n    key: 'standardHours',\r\n    label: 'Giờ chuẩn',\r\n    type: 'number',\r\n    example: '160',\r\n    exportGroup: 'Thời gian',\r\n    defaultSelected: true,\r\n  },\r\n  {\r\n    key: 'actualHours',\r\n    label: 'Giờ thực tế',\r\n    type: 'number',\r\n    example: '145.28',\r\n    exportGroup: 'Thời gian',\r\n    defaultSelected: true,\r\n  },\r\n  {\r\n    key: 'lateCount',\r\n    label: 'Đến muộn (lần)',\r\n    type: 'number',\r\n    example: '3',\r\n    exportGroup: 'Đến muộn/Về sớm',\r\n    defaultSelected: true,\r\n  },\r\n  {\r\n    key: 'lateMinutes',\r\n    label: 'Đến muộn (phút)',\r\n    type: 'number',\r\n    example: '97',\r\n    exportGroup: 'Đến muộn/Về sớm',\r\n    defaultSelected: true,\r\n  },\r\n  {\r\n    key: 'earlyLeaveCount',\r\n    label: 'Về sớm (lần)',\r\n    type: 'number',\r\n    example: '2',\r\n    exportGroup: 'Đến muộn/Về sớm',\r\n  },\r\n  {\r\n    key: 'earlyLeaveMinutes',\r\n    label: 'Về sớm (phút)',\r\n    type: 'number',\r\n    example: '36',\r\n    exportGroup: 'Đến muộn/Về sớm',\r\n  },\r\n  {\r\n    key: 'overtimeNormal',\r\n    label: 'Tăng ca thường (giờ)',\r\n    type: 'number',\r\n    example: '6.55',\r\n    exportGroup: 'Tăng ca',\r\n    defaultSelected: true,\r\n  },\r\n  {\r\n    key: 'overtimeSpecial',\r\n    label: 'Tăng ca đặc biệt (giờ)',\r\n    type: 'number',\r\n    example: '43.5',\r\n    exportGroup: 'Tăng ca',\r\n  },\r\n  {\r\n    key: 'workDays',\r\n    label: 'Ngày công (chuẩn/thực)',\r\n    type: 'string',\r\n    example: '20/19',\r\n    exportGroup: 'Ngày công',\r\n    defaultSelected: true,\r\n  },\r\n  {\r\n    key: 'businessTrip',\r\n    label: 'Công tác (ngày)',\r\n    type: 'number',\r\n    example: '2',\r\n    exportGroup: 'Nghỉ phép',\r\n  },\r\n  {\r\n    key: 'absentWithoutLeave',\r\n    label: 'Nghỉ không phép (ngày)',\r\n    type: 'number',\r\n    example: '1',\r\n    exportGroup: 'Nghỉ phép',\r\n    defaultSelected: true,\r\n  },\r\n  {\r\n    key: 'paidLeave',\r\n    label: 'Nghỉ phép (ngày)',\r\n    type: 'number',\r\n    example: '0',\r\n    exportGroup: 'Nghỉ phép',\r\n  },\r\n];\r\n\r\n// ============================================\r\n// CONFIG\r\n// ============================================\r\n\r\nexport const attendanceImportExportConfig: ImportExportConfig<AttendanceImportRow> = {\r\n  entityType: 'attendance',\r\n  entityDisplayName: 'Chấm công (từ máy CC)',\r\n\r\n  // Template - dùng file gốc từ máy CC\r\n  templateFileName: 'Mau_ChamCong_MayCC.xls',\r\n  templateDownloadUrl: '/templates/Mau_ChamCong_MayCC.xls',\r\n  \r\n  // ⚠️ SPECIAL: Custom parser\r\n  customParser: true,\r\n  sourceSheetName: 'Bảng tổng hợp chấm công',\r\n  headerRowIndex: 2,        // 0-indexed (row 3 trong Excel)\r\n  dataStartRowIndex: 4,     // 0-indexed (row 5 trong Excel)\r\n\r\n  // Fields\r\n  fields: attendanceFields,\r\n\r\n  // ⚠️ KHÔNG dùng upsertKey thông thường\r\n  // Vì máy CC dùng mã 1,2,3... không phải NV000001\r\n  upsertKey: undefined,\r\n  \r\n  // Thay vào đó: Composite key cho upsert\r\n  compositeKey: ['employeeSystemId', 'month', 'year'],\r\n\r\n  // Employee mapping\r\n  requireEmployeeMapping: true,\r\n  mappingField: 'employeeName',\r\n\r\n  // Upsert config\r\n  allowUpdate: true,        // Cho phép update nếu tháng đã có\r\n  allowInsert: true,        // Cho phép thêm mới\r\n\r\n  // Preview config\r\n  requirePreview: true,\r\n  stopOnFirstError: false,\r\n  maxErrorsAllowed: 0,\r\n\r\n  maxRows: 100,             // Thường mỗi tháng < 100 NV\r\n\r\n  // Validation\r\n  validateRow: (row, _index, _existingData) => {\r\n    const errors: Array<{ field?: string; message: string }> = [];\r\n\r\n    // Check tên không rỗng\r\n    if (!row.employeeName || row.employeeName.trim() === '') {\r\n      errors.push({ field: 'employeeName', message: 'Họ tên không được trống' });\r\n    }\r\n\r\n    // Check giờ thực tế không âm\r\n    if (row.actualHours < 0) {\r\n      errors.push({ field: 'actualHours', message: 'Giờ thực tế không được âm' });\r\n    }\r\n\r\n    // Check giờ thực tế không vượt quá chuẩn + tăng ca quá nhiều\r\n    const maxHours = row.standardHours + 100; // Tối đa 100 giờ tăng ca/tháng\r\n    if (row.actualHours > maxHours) {\r\n      errors.push({ \r\n        field: 'actualHours', \r\n        message: `Giờ thực tế (${row.actualHours}h) vượt quá giới hạn (${maxHours}h)` \r\n      });\r\n    }\r\n\r\n    // Check số phút đến muộn hợp lý\r\n    if (row.lateMinutes > 0 && row.lateCount === 0) {\r\n      errors.push({ \r\n        field: 'lateCount', \r\n        message: 'Có phút đến muộn nhưng số lần = 0' \r\n      });\r\n    }\r\n\r\n    return errors;\r\n  },\r\n\r\n  // After import hook\r\n  afterImport: (results) => {\r\n    console.log(`Import chấm công hoàn tất:\r\n      - Thêm mới: ${results.inserted.length}\r\n      - Cập nhật: ${results.updated.length}\r\n      - Lỗi: ${results.failed.length}\r\n      - Bỏ qua: ${results.skipped.length}`);\r\n  },\r\n};\r\n\r\n// Export fields cho re-use\r\nexport { attendanceFields };\r\n"],"names":[],"mappings":"AAAA;;;;;;;;;CASC;;;;;;AAID,+CAA+C;AAC/C,oBAAoB;AACpB,+CAA+C;AAE/C,MAAM,mBAAuD;IAC3D;QACE,KAAK;QACL,OAAO;QACP,UAAU;QACV,MAAM;QACN,SAAS;QACT,aAAa;QACb,iBAAiB;IACnB;IACA;QACE,KAAK;QACL,OAAO;QACP,UAAU;QACV,MAAM;QACN,SAAS;QACT,aAAa;QACb,iBAAiB;IACnB;IACA;QACE,KAAK;QACL,OAAO;QACP,MAAM;QACN,SAAS;QACT,aAAa;IACf;IACA;QACE,KAAK;QACL,OAAO;QACP,MAAM;QACN,SAAS;QACT,aAAa;QACb,iBAAiB;IACnB;IACA;QACE,KAAK;QACL,OAAO;QACP,MAAM;QACN,SAAS;QACT,aAAa;QACb,iBAAiB;IACnB;IACA;QACE,KAAK;QACL,OAAO;QACP,MAAM;QACN,SAAS;QACT,aAAa;QACb,iBAAiB;IACnB;IACA;QACE,KAAK;QACL,OAAO;QACP,MAAM;QACN,SAAS;QACT,aAAa;QACb,iBAAiB;IACnB;IACA;QACE,KAAK;QACL,OAAO;QACP,MAAM;QACN,SAAS;QACT,aAAa;IACf;IACA;QACE,KAAK;QACL,OAAO;QACP,MAAM;QACN,SAAS;QACT,aAAa;IACf;IACA;QACE,KAAK;QACL,OAAO;QACP,MAAM;QACN,SAAS;QACT,aAAa;QACb,iBAAiB;IACnB;IACA;QACE,KAAK;QACL,OAAO;QACP,MAAM;QACN,SAAS;QACT,aAAa;IACf;IACA;QACE,KAAK;QACL,OAAO;QACP,MAAM;QACN,SAAS;QACT,aAAa;QACb,iBAAiB;IACnB;IACA;QACE,KAAK;QACL,OAAO;QACP,MAAM;QACN,SAAS;QACT,aAAa;IACf;IACA;QACE,KAAK;QACL,OAAO;QACP,MAAM;QACN,SAAS;QACT,aAAa;QACb,iBAAiB;IACnB;IACA;QACE,KAAK;QACL,OAAO;QACP,MAAM;QACN,SAAS;QACT,aAAa;IACf;CACD;AAMM,MAAM,+BAAwE;IACnF,YAAY;IACZ,mBAAmB;IAEnB,qCAAqC;IACrC,kBAAkB;IAClB,qBAAqB;IAErB,4BAA4B;IAC5B,cAAc;IACd,iBAAiB;IACjB,gBAAgB;IAChB,mBAAmB;IAEnB,SAAS;IACT,QAAQ;IAER,uCAAuC;IACvC,iDAAiD;IACjD,WAAW;IAEX,wCAAwC;IACxC,cAAc;QAAC;QAAoB;QAAS;KAAO;IAEnD,mBAAmB;IACnB,wBAAwB;IACxB,cAAc;IAEd,gBAAgB;IAChB,aAAa;IACb,aAAa;IAEb,iBAAiB;IACjB,gBAAgB;IAChB,kBAAkB;IAClB,kBAAkB;IAElB,SAAS;IAET,aAAa;IACb,aAAa,CAAC,KAAK,QAAQ;QACzB,MAAM,SAAqD,EAAE;QAE7D,uBAAuB;QACvB,IAAI,CAAC,IAAI,YAAY,IAAI,IAAI,YAAY,CAAC,IAAI,OAAO,IAAI;YACvD,OAAO,IAAI,CAAC;gBAAE,OAAO;gBAAgB,SAAS;YAA0B;QAC1E;QAEA,6BAA6B;QAC7B,IAAI,IAAI,WAAW,GAAG,GAAG;YACvB,OAAO,IAAI,CAAC;gBAAE,OAAO;gBAAe,SAAS;YAA4B;QAC3E;QAEA,6DAA6D;QAC7D,MAAM,WAAW,IAAI,aAAa,GAAG,KAAK,+BAA+B;QACzE,IAAI,IAAI,WAAW,GAAG,UAAU;YAC9B,OAAO,IAAI,CAAC;gBACV,OAAO;gBACP,SAAS,CAAC,aAAa,EAAE,IAAI,WAAW,CAAC,sBAAsB,EAAE,SAAS,EAAE,CAAC;YAC/E;QACF;QAEA,gCAAgC;QAChC,IAAI,IAAI,WAAW,GAAG,KAAK,IAAI,SAAS,KAAK,GAAG;YAC9C,OAAO,IAAI,CAAC;gBACV,OAAO;gBACP,SAAS;YACX;QACF;QAEA,OAAO;IACT;IAEA,oBAAoB;IACpB,aAAa,CAAC;QACZ,QAAQ,GAAG,CAAC,CAAC;kBACC,EAAE,QAAQ,QAAQ,CAAC,MAAM,CAAC;kBAC1B,EAAE,QAAQ,OAAO,CAAC,MAAM,CAAC;aAC9B,EAAE,QAAQ,MAAM,CAAC,MAAM,CAAC;gBACrB,EAAE,QAAQ,OAAO,CAAC,MAAM,EAAE;IACxC;AACF"}},
    {"offset": {"line": 2934, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/lib/import-export/configs/customer.config.ts"],"sourcesContent":["import type { Customer } from '@/features/customers/types';\r\nimport type { ImportExportConfig, FieldConfig } from '../types';\r\n\r\n/**\r\n * Customer Import/Export Configuration\r\n * Theo chuẩn ImportExportConfig để dùng với GenericImportDialogV2 và GenericExportDialogV2\r\n */\r\n\r\n// ===== FIELD DEFINITIONS =====\r\nexport const customerFields: FieldConfig<Customer>[] = [\r\n  // ===== THÔNG TIN CƠ BẢN =====\r\n  {\r\n    key: 'id',\r\n    label: 'Mã khách hàng',\r\n    required: false, // Tự generate nếu để trống\r\n    type: 'string',\r\n    exportGroup: 'Thông tin cơ bản',\r\n    example: 'KH000001',\r\n  },\r\n  {\r\n    key: 'name',\r\n    label: 'Tên khách hàng (*)',\r\n    required: true,\r\n    type: 'string',\r\n    exportGroup: 'Thông tin cơ bản',\r\n    example: 'Công ty TNHH ABC',\r\n  },\r\n  {\r\n    key: 'status',\r\n    label: 'Trạng thái',\r\n    required: false,\r\n    type: 'enum',\r\n    enumValues: ['Đang giao dịch', 'Ngừng Giao Dịch'],\r\n    enumLabels: {\r\n      'Đang giao dịch': 'Đang giao dịch',\r\n      'Ngừng Giao Dịch': 'Ngừng giao dịch',\r\n    },\r\n    exportGroup: 'Thông tin cơ bản',\r\n    example: 'Đang giao dịch',\r\n    defaultValue: 'Đang giao dịch',\r\n  },\r\n  {\r\n    key: 'phone',\r\n    label: 'Số điện thoại',\r\n    required: false,\r\n    type: 'phone',\r\n    exportGroup: 'Thông tin cơ bản',\r\n    example: '0901234567',\r\n    validator: (value: unknown) => {\r\n      if (!value) return null;\r\n      const phone = String(value).replace(/\\s/g, '');\r\n      if (!/^0\\d{9,10}$/.test(phone)) {\r\n        return '[Warning] Số điện thoại không đúng định dạng';\r\n      }\r\n      return null;\r\n    },\r\n  },\r\n  {\r\n    key: 'email',\r\n    label: 'Email',\r\n    required: false,\r\n    type: 'email',\r\n    exportGroup: 'Thông tin cơ bản',\r\n    example: 'contact@abc.com',\r\n    validator: (value: unknown) => {\r\n      if (!value) return null;\r\n      const emailRegex = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;\r\n      if (!emailRegex.test(String(value))) {\r\n        return 'Email không hợp lệ';\r\n      }\r\n      return null;\r\n    },\r\n  },\r\n  {\r\n    key: 'type',\r\n    label: 'Loại khách hàng',\r\n    required: false,\r\n    type: 'string',\r\n    exportGroup: 'Thông tin cơ bản',\r\n    example: 'Doanh nghiệp',\r\n  },\r\n  {\r\n    key: 'customerGroup',\r\n    label: 'Nhóm khách hàng',\r\n    required: false,\r\n    type: 'string',\r\n    exportGroup: 'Thông tin cơ bản',\r\n    example: 'Khách sỉ',\r\n  },\r\n  {\r\n    key: 'lifecycleStage',\r\n    label: 'Giai đoạn vòng đời',\r\n    required: false,\r\n    type: 'string',\r\n    exportGroup: 'Thông tin cơ bản',\r\n    example: 'Khách mới',\r\n  },\r\n  {\r\n    key: 'source',\r\n    label: 'Nguồn khách hàng',\r\n    required: false,\r\n    type: 'string',\r\n    exportGroup: 'Thông tin cơ bản',\r\n    example: 'Facebook',\r\n  },\r\n  {\r\n    key: 'notes',\r\n    label: 'Ghi chú',\r\n    required: false,\r\n    type: 'string',\r\n    exportGroup: 'Thông tin cơ bản',\r\n    example: 'Khách hàng tiềm năng',\r\n  },\r\n\r\n  // ===== THÔNG TIN DOANH NGHIỆP =====\r\n  {\r\n    key: 'company',\r\n    label: 'Tên công ty / HKD',\r\n    required: false,\r\n    type: 'string',\r\n    exportGroup: 'Thông tin doanh nghiệp',\r\n    example: 'Công ty TNHH ABC',\r\n  },\r\n  {\r\n    key: 'taxCode',\r\n    label: 'Mã số thuế',\r\n    required: false,\r\n    type: 'string',\r\n    exportGroup: 'Thông tin doanh nghiệp',\r\n    example: '0123456789',\r\n    validator: (value: unknown) => {\r\n      if (!value) return null;\r\n      const taxCode = String(value);\r\n      if (!/^\\d{10}(\\d{3})?$/.test(taxCode)) {\r\n        return '[Warning] Mã số thuế phải có 10 hoặc 13 số';\r\n      }\r\n      return null;\r\n    },\r\n  },\r\n  {\r\n    key: 'representative',\r\n    label: 'Người đại diện',\r\n    required: false,\r\n    type: 'string',\r\n    exportGroup: 'Thông tin doanh nghiệp',\r\n    example: 'Nguyễn Văn A',\r\n  },\r\n  {\r\n    key: 'position',\r\n    label: 'Chức vụ',\r\n    required: false,\r\n    type: 'string',\r\n    exportGroup: 'Thông tin doanh nghiệp',\r\n    example: 'Giám đốc',\r\n  },\r\n  {\r\n    key: 'bankName',\r\n    label: 'Ngân hàng',\r\n    required: false,\r\n    type: 'string',\r\n    exportGroup: 'Thông tin doanh nghiệp',\r\n    example: 'Vietcombank',\r\n  },\r\n  {\r\n    key: 'bankAccount',\r\n    label: 'Số tài khoản',\r\n    required: false,\r\n    type: 'string',\r\n    exportGroup: 'Thông tin doanh nghiệp',\r\n    example: '0123456789',\r\n  },\r\n\r\n  // ===== THANH TOÁN & GIÁ =====\r\n  {\r\n    key: 'paymentTerms',\r\n    label: 'Hạn thanh toán',\r\n    required: false,\r\n    type: 'string',\r\n    exportGroup: 'Thanh toán & Giá',\r\n    example: 'NET15',\r\n  },\r\n  {\r\n    key: 'creditRating',\r\n    label: 'Xếp hạng tín dụng',\r\n    required: false,\r\n    type: 'string',\r\n    exportGroup: 'Thanh toán & Giá',\r\n    example: 'AAA',\r\n  },\r\n  {\r\n    key: 'currentDebt',\r\n    label: 'Công nợ hiện tại',\r\n    required: false,\r\n    type: 'number',\r\n    exportGroup: 'Thanh toán & Giá',\r\n    example: '0',\r\n    importTransform: (value: unknown) => {\r\n      if (!value) return 0;\r\n      const num = Number(String(value).replace(/[,.\\s]/g, ''));\r\n      return isNaN(num) ? 0 : num;\r\n    },\r\n    exportTransform: (value: unknown) => {\r\n      if (!value) return '0';\r\n      return Number(value).toLocaleString('vi-VN');\r\n    },\r\n  },\r\n  {\r\n    key: 'maxDebt',\r\n    label: 'Hạn mức công nợ',\r\n    required: false,\r\n    type: 'number',\r\n    exportGroup: 'Thanh toán & Giá',\r\n    example: '50000000',\r\n    importTransform: (value: unknown) => {\r\n      if (!value) return undefined;\r\n      const num = Number(String(value).replace(/[,.\\s]/g, ''));\r\n      return isNaN(num) ? undefined : num;\r\n    },\r\n    exportTransform: (value: unknown) => {\r\n      if (!value) return '';\r\n      return Number(value).toLocaleString('vi-VN');\r\n    },\r\n  },\r\n  {\r\n    key: 'allowCredit',\r\n    label: 'Cho phép công nợ',\r\n    required: false,\r\n    type: 'boolean',\r\n    exportGroup: 'Thanh toán & Giá',\r\n    example: 'Có',\r\n    importTransform: (value: unknown) => {\r\n      if (!value) return undefined;\r\n      const str = String(value).toLowerCase();\r\n      return str === 'có' || str === 'yes' || str === 'true' || str === '1';\r\n    },\r\n    exportTransform: (value: unknown) => value ? 'Có' : 'Không',\r\n  },\r\n  {\r\n    key: 'pricingLevel',\r\n    label: 'Bảng giá áp dụng',\r\n    required: false,\r\n    type: 'enum',\r\n    enumValues: ['Retail', 'Wholesale', 'VIP', 'Partner'],\r\n    enumLabels: {\r\n      'Retail': 'Bán lẻ',\r\n      'Wholesale': 'Bán sỉ',\r\n      'VIP': 'VIP',\r\n      'Partner': 'Đối tác',\r\n    },\r\n    exportGroup: 'Thanh toán & Giá',\r\n    example: 'Retail',\r\n  },\r\n  {\r\n    key: 'defaultDiscount',\r\n    label: 'Chiết khấu mặc định (%)',\r\n    required: false,\r\n    type: 'number',\r\n    exportGroup: 'Thanh toán & Giá',\r\n    example: '5',\r\n    validator: (value: unknown) => {\r\n      if (!value) return null;\r\n      const num = Number(value);\r\n      if (num < 0 || num > 100) {\r\n        return 'Chiết khấu phải từ 0 đến 100%';\r\n      }\r\n      return null;\r\n    },\r\n  },\r\n\r\n  // ===== PHÂN LOẠI & QUẢN LÝ =====\r\n  {\r\n    key: 'accountManagerName',\r\n    label: 'Nhân viên phụ trách',\r\n    required: false,\r\n    type: 'string',\r\n    exportGroup: 'Phân loại & Quản lý',\r\n    example: 'Nguyễn Văn B',\r\n  },\r\n  {\r\n    key: 'campaign',\r\n    label: 'Chiến dịch',\r\n    required: false,\r\n    type: 'string',\r\n    exportGroup: 'Phân loại & Quản lý',\r\n    example: 'Summer Sale 2024',\r\n  },\r\n  {\r\n    key: 'tags',\r\n    label: 'Thẻ (Tags)',\r\n    required: false,\r\n    type: 'string',\r\n    exportGroup: 'Phân loại & Quản lý',\r\n    example: 'VIP, Ưu tiên',\r\n    importTransform: (value: unknown) => {\r\n      if (!value) return undefined;\r\n      return String(value).split(',').map(s => s.trim()).filter(Boolean);\r\n    },\r\n    exportTransform: (value: unknown) => {\r\n      if (!value || !Array.isArray(value)) return '';\r\n      return value.join(', ');\r\n    },\r\n  },\r\n\r\n  // ===== SOCIAL MEDIA =====\r\n  {\r\n    key: 'zaloPhone',\r\n    label: 'Zalo',\r\n    required: false,\r\n    type: 'phone',\r\n    exportGroup: 'Social Media',\r\n    example: '0901234567',\r\n  },\r\n\r\n  // ===== HỆ THỐNG (hidden) =====\r\n  {\r\n    key: 'systemId',\r\n    label: 'System ID',\r\n    required: false,\r\n    type: 'string',\r\n    exportGroup: 'Hệ thống',\r\n    hidden: true,\r\n  },\r\n  {\r\n    key: 'createdAt',\r\n    label: 'Ngày tạo',\r\n    required: false,\r\n    type: 'date',\r\n    exportGroup: 'Hệ thống',\r\n    hidden: true,\r\n  },\r\n  {\r\n    key: 'updatedAt',\r\n    label: 'Ngày cập nhật',\r\n    required: false,\r\n    type: 'date',\r\n    exportGroup: 'Hệ thống',\r\n    hidden: true,\r\n  },\r\n];\r\n\r\n// ===== MAIN CONFIG =====\r\nexport const customerImportExportConfig: ImportExportConfig<Customer> = {\r\n  entityType: 'customers',\r\n  entityDisplayName: 'Khách hàng',\r\n  fields: customerFields,\r\n  upsertKey: 'id', // Dùng mã khách hàng để đối chiếu khi UPDATE\r\n  templateFileName: 'mau-import-khach-hang.xlsx',\r\n  requireBranch: false, // Khách hàng không bắt buộc chi nhánh\r\n  \r\n  // Pre-transform raw row (normalize column names)\r\n  preTransformRawRow: (rawRow: Record<string, unknown>) => {\r\n    const normalized: Record<string, unknown> = {};\r\n    \r\n    // Map từ label tiếng Việt sang key\r\n    const labelToKey: Record<string, string> = {};\r\n    customerFields.forEach(field => {\r\n      labelToKey[field.label.toLowerCase()] = field.key as string;\r\n      // Also map without (*) marker\r\n      const labelWithoutStar = field.label.replace(/\\s*\\(\\*\\)\\s*$/, '').toLowerCase();\r\n      labelToKey[labelWithoutStar] = field.key as string;\r\n    });\r\n    \r\n    Object.entries(rawRow).forEach(([key, value]) => {\r\n      // Normalize Excel header: strip (*) marker and lowercase\r\n      const normalizedExcelHeader = key.replace(/\\s*\\(\\*\\)\\s*$/, '').toLowerCase();\r\n      const normalizedKey = labelToKey[normalizedExcelHeader] || labelToKey[key.toLowerCase()] || key;\r\n      normalized[normalizedKey] = value;\r\n    });\r\n    \r\n    return normalized;\r\n  },\r\n  \r\n  // Post-transform row (set defaults, enrich data)\r\n  postTransformRow: (row: Partial<Customer>) => {\r\n    return {\r\n      ...row,\r\n      status: row.status || 'Đang giao dịch',\r\n      pricingLevel: row.pricingLevel || 'Retail',\r\n      currentDebt: row.currentDebt ?? 0,\r\n      defaultDiscount: row.defaultDiscount ?? 0,\r\n      tags: row.tags || [],\r\n    };\r\n  },\r\n  \r\n  // Validate row level (check duplicate taxCode)\r\n  // Skip duplicate check in upsert/update mode since we're updating existing records\r\n  validateRow: (row, _index, existingData, mode) => {\r\n    const errors: Array<{ field?: string; message: string }> = [];\r\n    \r\n    // Check unique taxCode - only in insert-only mode\r\n    // In upsert/update mode, duplicate is expected and allowed\r\n    if (row.taxCode && mode === 'insert-only') {\r\n      const duplicate = existingData.find(\r\n        c => c.taxCode === row.taxCode && c.id !== row.id\r\n      );\r\n      if (duplicate) {\r\n        errors.push({\r\n          field: 'taxCode',\r\n          message: `Mã số thuế đã được sử dụng bởi ${duplicate.name} (${duplicate.id})`,\r\n        });\r\n      }\r\n    }\r\n    \r\n    return errors;\r\n  },\r\n};\r\n\r\n// Re-export cho backward compatibility\r\nexport default customerImportExportConfig;\r\n"],"names":[],"mappings":";;;;;;;;AASO,MAAM,iBAA0C;IACrD,+BAA+B;IAC/B;QACE,KAAK;QACL,OAAO;QACP,UAAU;QACV,MAAM;QACN,aAAa;QACb,SAAS;IACX;IACA;QACE,KAAK;QACL,OAAO;QACP,UAAU;QACV,MAAM;QACN,aAAa;QACb,SAAS;IACX;IACA;QACE,KAAK;QACL,OAAO;QACP,UAAU;QACV,MAAM;QACN,YAAY;YAAC;YAAkB;SAAkB;QACjD,YAAY;YACV,kBAAkB;YAClB,mBAAmB;QACrB;QACA,aAAa;QACb,SAAS;QACT,cAAc;IAChB;IACA;QACE,KAAK;QACL,OAAO;QACP,UAAU;QACV,MAAM;QACN,aAAa;QACb,SAAS;QACT,WAAW,CAAC;YACV,IAAI,CAAC,OAAO,OAAO;YACnB,MAAM,QAAQ,OAAO,OAAO,OAAO,CAAC,OAAO;YAC3C,IAAI,CAAC,cAAc,IAAI,CAAC,QAAQ;gBAC9B,OAAO;YACT;YACA,OAAO;QACT;IACF;IACA;QACE,KAAK;QACL,OAAO;QACP,UAAU;QACV,MAAM;QACN,aAAa;QACb,SAAS;QACT,WAAW,CAAC;YACV,IAAI,CAAC,OAAO,OAAO;YACnB,MAAM,aAAa;YACnB,IAAI,CAAC,WAAW,IAAI,CAAC,OAAO,SAAS;gBACnC,OAAO;YACT;YACA,OAAO;QACT;IACF;IACA;QACE,KAAK;QACL,OAAO;QACP,UAAU;QACV,MAAM;QACN,aAAa;QACb,SAAS;IACX;IACA;QACE,KAAK;QACL,OAAO;QACP,UAAU;QACV,MAAM;QACN,aAAa;QACb,SAAS;IACX;IACA;QACE,KAAK;QACL,OAAO;QACP,UAAU;QACV,MAAM;QACN,aAAa;QACb,SAAS;IACX;IACA;QACE,KAAK;QACL,OAAO;QACP,UAAU;QACV,MAAM;QACN,aAAa;QACb,SAAS;IACX;IACA;QACE,KAAK;QACL,OAAO;QACP,UAAU;QACV,MAAM;QACN,aAAa;QACb,SAAS;IACX;IAEA,qCAAqC;IACrC;QACE,KAAK;QACL,OAAO;QACP,UAAU;QACV,MAAM;QACN,aAAa;QACb,SAAS;IACX;IACA;QACE,KAAK;QACL,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"}},
    {"offset": {"line": 3335, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/lib/import-export/configs/product.config.ts"],"sourcesContent":["import type { Product, ProductType as ProductTypeEnum } from '@/features/products/types';\r\nimport type { ImportExportConfig, FieldConfig } from '../types';\r\nimport { usePricingPolicyStore } from '@/features/settings/pricing/store';\r\nimport { useProductTypeStore } from '@/features/settings/inventory/product-type-store';\r\nimport { asSystemId } from '@/lib/id-types';\r\n\r\n/**\r\n * Product Import/Export Configuration\r\n * Theo chuẩn ImportExportConfig để dùng với GenericImportDialogV2 và GenericExportDialogV2\r\n */\r\n\r\n// Helper: Get all pricing policies\r\nconst getAllPricingPolicies = () => {\r\n  return usePricingPolicyStore.getState().data;\r\n};\r\n\r\n// ===== PRODUCT TYPE HELPERS =====\r\n// Helper: Get all active product types from settings\r\nconst getAllProductTypes = () => {\r\n  return useProductTypeStore.getState().getActive();\r\n};\r\n\r\n// Helper: Get ProductType systemId from name (tên loại sản phẩm)\r\nconst getProductTypeSystemIdByName = (name: string): string | null => {\r\n  if (!name) return null;\r\n  const productTypes = getAllProductTypes();\r\n  const normalizedName = name.toLowerCase().trim();\r\n  \r\n  // Tìm theo tên chính xác (case-insensitive)\r\n  const productType = productTypes.find(pt => \r\n    pt.name.toLowerCase() === normalizedName ||\r\n    pt.id.toLowerCase() === normalizedName\r\n  );\r\n  \r\n  return productType?.systemId || null;\r\n};\r\n\r\n// Helper: Get ProductType name from systemId\r\nconst getProductTypeNameById = (systemId: string): string => {\r\n  if (!systemId) return '';\r\n  const productTypes = getAllProductTypes();\r\n  const productType = productTypes.find(pt => pt.systemId === systemId);\r\n  return productType?.name || '';\r\n};\r\n\r\n// Helper: Get default ProductType systemId\r\nconst getDefaultProductTypeSystemId = (): string | null => {\r\n  const productTypes = getAllProductTypes();\r\n  const defaultType = productTypes.find(pt => pt.isDefault);\r\n  return defaultType?.systemId || productTypes[0]?.systemId || null;\r\n};\r\n\r\n// Helper: Map enum type ('physical', 'service', 'digital') to ProductType systemId\r\n// Fallback khi user import bằng type cũ\r\nconst getProductTypeSystemIdByEnumType = (enumType: ProductTypeEnum | string): string | null => {\r\n  if (!enumType) return getDefaultProductTypeSystemId();\r\n  \r\n  const productTypes = getAllProductTypes();\r\n  const normalizedType = String(enumType).toLowerCase().trim();\r\n  \r\n  // Map từ enum type sang tên tiếng Việt để tìm ProductType\r\n  const typeNameMapping: Record<string, string[]> = {\r\n    'physical': ['hàng hóa', 'hang hoa', 'physical', 'hàng hoá'],\r\n    'service': ['dịch vụ', 'dich vu', 'service'],\r\n    'digital': ['digital', 'sản phẩm số', 'san pham so', 'kỹ thuật số', 'ky thuat so'],\r\n    'combo': ['combo', 'bộ sản phẩm', 'bo san pham'],\r\n  };\r\n  \r\n  for (const [_enumKey, names] of Object.entries(typeNameMapping)) {\r\n    if (names.includes(normalizedType)) {\r\n      // Tìm ProductType có tên match với một trong các aliases\r\n      const productType = productTypes.find(pt => \r\n        names.some(name => pt.name.toLowerCase().includes(name) || name.includes(pt.name.toLowerCase()))\r\n      );\r\n      if (productType) return productType.systemId;\r\n    }\r\n  }\r\n  \r\n  // Fallback: tìm trực tiếp theo tên\r\n  const productType = productTypes.find(pt => \r\n    pt.name.toLowerCase().includes(normalizedType) ||\r\n    normalizedType.includes(pt.name.toLowerCase())\r\n  );\r\n  \r\n  return productType?.systemId || getDefaultProductTypeSystemId();\r\n};\r\n\r\n// ===== PRICING POLICY HELPERS =====\r\n// Helper: Get pricing policy systemId from code (id) OR name\r\n// Hỗ trợ nhiều format cột giá trong Excel:\r\n// - \"Giá: Giá bán lẻ\" hoặc \"Giá: BANLE\" (có prefix \"Giá:\")\r\n// - \"Giá bán lẻ\" hoặc \"BANLE\" (không có prefix)\r\nconst getPricingPolicySystemId = (columnName: string): string | null => {\r\n  const policies = getAllPricingPolicies();\r\n  \r\n  // Normalize: bỏ prefix \"Giá:\" hoặc \"Gia:\" nếu có\r\n  let normalizedName = columnName.trim();\r\n  const pricePrefix = /^(giá|gia)\\s*:\\s*/i;\r\n  if (pricePrefix.test(normalizedName)) {\r\n    normalizedName = normalizedName.replace(pricePrefix, '').trim();\r\n  }\r\n  \r\n  const upperName = normalizedName.toUpperCase();\r\n  \r\n  // Tìm theo id (mã bảng giá) trước\r\n  const policyById = policies.find(p => p.id.toUpperCase() === upperName);\r\n  if (policyById) return policyById.systemId;\r\n  \r\n  // Tìm theo name (tên bảng giá)\r\n  const policyByName = policies.find(p => p.name.toUpperCase() === upperName);\r\n  if (policyByName) return policyByName.systemId;\r\n  \r\n  // Tìm theo name chứa (partial match)\r\n  const policyByPartialName = policies.find(p => \r\n    p.name.toUpperCase().includes(upperName) || \r\n    upperName.includes(p.name.toUpperCase())\r\n  );\r\n  if (policyByPartialName) return policyByPartialName.systemId;\r\n  \r\n  return null;\r\n};\r\n\r\n// Helper: Get pricing policy code (id) from systemId  \r\nconst getPricingPolicyCode = (systemId: string): string => {\r\n  const policies = getAllPricingPolicies();\r\n  const policy = policies.find(p => p.systemId === systemId);\r\n  return policy?.id || systemId;\r\n};\r\n\r\n// Helper: Get pricing policy name from systemId  \r\nconst getPricingPolicyName = (systemId: string): string => {\r\n  const policies = getAllPricingPolicies();\r\n  const policy = policies.find(p => p.systemId === systemId);\r\n  return policy?.name || systemId;\r\n};\r\n\r\n// Helper: Check if a column name matches a pricing policy (by id or name)\r\nconst isPricingPolicyColumn = (columnName: string): boolean => {\r\n  return getPricingPolicySystemId(columnName) !== null;\r\n};\r\n\r\n// ===== FIELD DEFINITIONS =====\r\nexport const productFields: FieldConfig<Product>[] = [\r\n  // ===== THÔNG TIN CƠ BẢN =====\r\n  {\r\n    key: 'id',\r\n    label: 'Mã sản phẩm',\r\n    required: false, // Tự generate nếu để trống\r\n    type: 'string',\r\n    exportGroup: 'Thông tin cơ bản',\r\n    example: 'SP000001',\r\n  },\r\n  {\r\n    key: 'name',\r\n    label: 'Tên sản phẩm (*)',\r\n    required: true,\r\n    type: 'string',\r\n    exportGroup: 'Thông tin cơ bản',\r\n    example: 'Áo sơ mi nam',\r\n  },\r\n  {\r\n    key: 'sku',\r\n    label: 'SKU',\r\n    required: false,\r\n    type: 'string',\r\n    exportGroup: 'Thông tin cơ bản',\r\n    example: 'ASM-001',\r\n  },\r\n  {\r\n    key: 'barcode',\r\n    label: 'Mã vạch',\r\n    required: false,\r\n    type: 'string',\r\n    exportGroup: 'Thông tin cơ bản',\r\n    example: '8934567890123',\r\n  },\r\n  {\r\n    key: 'type',\r\n    label: 'Loại SP (Hệ thống)',\r\n    required: false,\r\n    type: 'enum',\r\n    enumValues: ['physical', 'service', 'digital'], // Không cho phép import combo\r\n    enumLabels: {\r\n      'physical': 'Hàng hóa',\r\n      'service': 'Dịch vụ',\r\n      'digital': 'Sản phẩm số',\r\n    },\r\n    exportGroup: 'Thông tin cơ bản',\r\n    example: 'Hàng hóa',\r\n    defaultValue: 'physical',\r\n    hidden: true, // Ẩn field cũ, khuyến khích dùng \"Loại sản phẩm\" mới (productTypeSystemId)\r\n    importTransform: (value: unknown) => {\r\n      if (!value) return 'physical';\r\n      const str = String(value).toLowerCase().trim();\r\n      // Map tiếng Việt sang English\r\n      if (str === 'hàng hóa' || str === 'hang hoa' || str === 'physical' || str === 'hàng hoá') return 'physical';\r\n      if (str === 'dịch vụ' || str === 'dich vu' || str === 'service') return 'service';\r\n      if (str === 'sản phẩm số' || str === 'san pham so' || str === 'kỹ thuật số' || str === 'digital' || str === 'ky thuat so') return 'digital';\r\n      if (str === 'combo' || str === 'bộ sản phẩm' || str === 'bo san pham') return 'combo';\r\n      return 'physical';\r\n    },\r\n    validator: (value: unknown) => {\r\n      if (value === 'combo') {\r\n        return 'Không hỗ trợ import sản phẩm Combo. Vui lòng tạo Combo trực tiếp trong hệ thống.';\r\n      }\r\n      return null;\r\n    },\r\n  },\r\n  // NEW: Loại sản phẩm từ Settings (ProductType) - Khuyến khích dùng thay cho field \"type\" cũ\r\n  {\r\n    key: 'productTypeSystemId',\r\n    label: 'Loại sản phẩm',\r\n    required: false,\r\n    type: 'string',\r\n    exportGroup: 'Thông tin cơ bản',\r\n    example: 'Hàng hóa', // User nhập tên loại SP, hệ thống tự map sang systemId\r\n    importTransform: (value: unknown) => {\r\n      if (!value) return undefined;\r\n      const str = String(value).trim();\r\n      if (!str) return undefined;\r\n      \r\n      // Trước tiên thử tìm theo tên/id trong ProductType settings\r\n      const systemId = getProductTypeSystemIdByName(str);\r\n      if (systemId) return systemId;\r\n      \r\n      // Fallback: map từ enum type cũ\r\n      const enumSystemId = getProductTypeSystemIdByEnumType(str);\r\n      return enumSystemId || undefined;\r\n    },\r\n    exportTransform: (value: unknown) => {\r\n      // Export ra tên loại SP thay vì systemId\r\n      return getProductTypeNameById(value as string);\r\n    },\r\n    validator: (value: unknown) => {\r\n      if (!value) return null; // Optional field\r\n      const str = String(value).trim();\r\n      if (!str) return null;\r\n      \r\n      // Validate: tên loại SP phải tồn tại trong settings\r\n      const systemId = getProductTypeSystemIdByName(str);\r\n      if (!systemId) {\r\n        // Fallback check enum type\r\n        const enumSystemId = getProductTypeSystemIdByEnumType(str);\r\n        if (!enumSystemId) {\r\n          return `Loại sản phẩm \"${str}\" không tồn tại trong hệ thống. Vui lòng kiểm tra danh sách loại SP trong Cài đặt > Kho hàng.`;\r\n        }\r\n      }\r\n      return null;\r\n    },\r\n  },\r\n  {\r\n    key: 'status',\r\n    label: 'Trạng thái',\r\n    required: false,\r\n    type: 'enum',\r\n    enumValues: ['active', 'inactive', 'discontinued'],\r\n    enumLabels: {\r\n      'active': 'Đang kinh doanh',\r\n      'inactive': 'Ngừng kinh doanh',\r\n      'discontinued': 'Ngừng nhập',\r\n    },\r\n    exportGroup: 'Thông tin cơ bản',\r\n    example: 'Đang kinh doanh',\r\n    defaultValue: 'active',\r\n    importTransform: (value: unknown) => {\r\n      if (!value) return 'active';\r\n      const str = String(value).toLowerCase().trim();\r\n      // Map tiếng Việt sang English\r\n      if (str === 'đang kinh doanh' || str === 'dang kinh doanh' || str === 'active') return 'active';\r\n      if (str === 'ngừng kinh doanh' || str === 'ngung kinh doanh' || str === 'inactive') return 'inactive';\r\n      if (str === 'ngừng nhập' || str === 'ngung nhap' || str === 'discontinued') return 'discontinued';\r\n      return 'active';\r\n    },\r\n  },\r\n  {\r\n    key: 'unit',\r\n    label: 'Đơn vị tính',\r\n    required: false,\r\n    type: 'string',\r\n    exportGroup: 'Thông tin cơ bản',\r\n    example: 'Cái',\r\n    defaultValue: 'Cái',\r\n  },\r\n  {\r\n    key: 'categories',\r\n    label: 'Danh mục',\r\n    required: false,\r\n    type: 'string',\r\n    exportGroup: 'Thông tin cơ bản',\r\n    example: 'Thời trang > Áo nam; Sale > Hot deal', // Nhiều danh mục phân cách bằng ;\r\n    importTransform: (value: unknown) => {\r\n      if (!value) return undefined;\r\n      const str = String(value).trim();\r\n      if (!str) return undefined;\r\n      // Split by semicolon to get multiple categories, each category can have multi-level with >\r\n      return str.split(';').map(s => s.trim()).filter(Boolean);\r\n    },\r\n    exportTransform: (value: unknown) => {\r\n      const categories = value as string[] | undefined;\r\n      return categories?.join('; ') || '';\r\n    },\r\n  },\r\n  // Legacy single category field (backward compatibility)\r\n  {\r\n    key: 'category',\r\n    label: 'Danh mục (cũ)',\r\n    required: false,\r\n    type: 'string',\r\n    exportGroup: 'Thông tin cơ bản',\r\n    hidden: true, // Ẩn trong import, chỉ dùng cho backward compatibility\r\n    example: 'Thời trang > Áo nam > Áo sơ mi',\r\n  },\r\n  {\r\n    key: 'description',\r\n    label: 'Mô tả',\r\n    required: false,\r\n    type: 'string',\r\n    exportGroup: 'Thông tin cơ bản',\r\n    example: 'Áo sơ mi nam cao cấp',\r\n  },\r\n  {\r\n    key: 'shortDescription',\r\n    label: 'Mô tả ngắn',\r\n    required: false,\r\n    type: 'string',\r\n    exportGroup: 'Thông tin cơ bản',\r\n    example: 'Áo sơ mi nam',\r\n  },\r\n\r\n  // ===== HÌNH ẢNH =====\r\n  // NOTE: Hình ảnh được upload lên server trước, sau đó import đường dẫn\r\n  // Format: /products/{ma_sp}/{ten_file}.jpg hoặc URL đầy đủ\r\n  {\r\n    key: 'thumbnailImage',\r\n    label: 'Ảnh đại diện',\r\n    required: false,\r\n    type: 'string',\r\n    exportGroup: 'Hình ảnh',\r\n    example: '/products/SP001/main.jpg',\r\n    validator: (value: unknown) => {\r\n      if (!value) return null; // Optional\r\n      const str = String(value).trim();\r\n      // Cho phép: /path/to/file.ext hoặc http(s)://...\r\n      if (!str.startsWith('/') && !str.startsWith('http')) {\r\n        return 'Đường dẫn ảnh phải bắt đầu bằng / hoặc http(s)://';\r\n      }\r\n      // Check extension\r\n      const validExts = ['.jpg', '.jpeg', '.png', '.gif', '.webp', '.svg'];\r\n      const hasValidExt = validExts.some(ext => str.toLowerCase().endsWith(ext));\r\n      if (!hasValidExt && !str.includes('?')) { // Ignore if has query params\r\n        return 'Định dạng ảnh không hợp lệ (jpg, png, gif, webp, svg)';\r\n      }\r\n      return null;\r\n    },\r\n  },\r\n  {\r\n    key: 'galleryImages',\r\n    label: 'Ảnh bộ sưu tập',\r\n    required: false,\r\n    type: 'string',\r\n    exportGroup: 'Hình ảnh',\r\n    example: '/products/SP001/1.jpg, /products/SP001/2.jpg',\r\n    importTransform: (value: unknown) => {\r\n      if (!value) return undefined;\r\n      const str = String(value).trim();\r\n      if (!str) return undefined;\r\n      return str.split(/[,;|]/).map(s => s.trim()).filter(Boolean);\r\n    },\r\n    exportTransform: (value: unknown) => {\r\n      const images = value as string[] | undefined;\r\n      return images?.join(', ') || '';\r\n    },\r\n    validator: (value: unknown) => {\r\n      if (!value) return null;\r\n      const str = String(value).trim();\r\n      if (!str) return null;\r\n      const paths = str.split(/[,;|]/).map(s => s.trim()).filter(Boolean);\r\n      const validExts = ['.jpg', '.jpeg', '.png', '.gif', '.webp', '.svg'];\r\n      for (const path of paths) {\r\n        if (!path.startsWith('/') && !path.startsWith('http')) {\r\n          return `Đường dẫn \"${path}\" phải bắt đầu bằng / hoặc http(s)://`;\r\n        }\r\n        const hasValidExt = validExts.some(ext => path.toLowerCase().endsWith(ext));\r\n        if (!hasValidExt && !path.includes('?')) {\r\n          return `Đường dẫn \"${path}\" có định dạng ảnh không hợp lệ`;\r\n        }\r\n      }\r\n      return null;\r\n    },\r\n  },\r\n\r\n  // ===== VIDEO LINKS =====\r\n  {\r\n    key: 'videoLinks',\r\n    label: 'Video link',\r\n    required: false,\r\n    type: 'string',\r\n    exportGroup: 'Media',\r\n    example: 'https://youtube.com/watch?v=xxx; https://drive.google.com/file/xxx',\r\n    importTransform: (value: unknown) => {\r\n      if (!value) return undefined;\r\n      const str = String(value).trim();\r\n      if (!str) return undefined;\r\n      return str.split(/[,;|]/).map(s => s.trim()).filter(Boolean);\r\n    },\r\n    exportTransform: (value: unknown) => {\r\n      const links = value as string[] | undefined;\r\n      return links?.join('; ') || '';\r\n    },\r\n    validator: (value: unknown) => {\r\n      if (!value) return null;\r\n      const str = String(value).trim();\r\n      if (!str) return null;\r\n      const links = str.split(/[,;|]/).map(s => s.trim()).filter(Boolean);\r\n      for (const link of links) {\r\n        if (!link.startsWith('http')) {\r\n          return `Link \"${link}\" phải bắt đầu bằng http:// hoặc https://`;\r\n        }\r\n        // Kiểm tra domain hợp lệ (YouTube, TikTok, Drive, Vimeo, etc.)\r\n        const validDomains = ['youtube.com', 'youtu.be', 'tiktok.com', 'drive.google.com', 'vimeo.com', 'facebook.com', 'fb.watch'];\r\n        const isValidDomain = validDomains.some(domain => link.includes(domain));\r\n        if (!isValidDomain) {\r\n          // Cho phép các domain khác nhưng cảnh báo\r\n          console.warn(`Link \"${link}\" không thuộc các nền tảng video phổ biến`);\r\n        }\r\n      }\r\n      return null;\r\n    },\r\n  },\r\n\r\n  // ===== GIÁ =====\r\n  {\r\n    key: 'costPrice',\r\n    label: 'Giá vốn',\r\n    required: false,\r\n    type: 'number',\r\n    exportGroup: 'Giá',\r\n    example: '150000',\r\n    importTransform: (value: unknown) => {\r\n      if (!value) return 0;\r\n      const num = Number(String(value).replace(/[,.\\s]/g, ''));\r\n      return isNaN(num) ? 0 : num;\r\n    },\r\n  },\r\n  {\r\n    key: 'sellingPrice',\r\n    label: 'Giá bán',\r\n    required: false,\r\n    type: 'number',\r\n    exportGroup: 'Giá',\r\n    example: '250000',\r\n    importTransform: (value: unknown) => {\r\n      if (!value) return 0;\r\n      const num = Number(String(value).replace(/[,.\\s]/g, ''));\r\n      return isNaN(num) ? 0 : num;\r\n    },\r\n  },\r\n  {\r\n    key: 'minPrice',\r\n    label: 'Giá tối thiểu',\r\n    required: false,\r\n    type: 'number',\r\n    exportGroup: 'Giá',\r\n    example: '200000',\r\n    importTransform: (value: unknown) => {\r\n      if (!value) return undefined;\r\n      const num = Number(String(value).replace(/[,.\\s]/g, ''));\r\n      return isNaN(num) ? undefined : num;\r\n    },\r\n  },\r\n  {\r\n    key: 'taxRate',\r\n    label: 'Thuế suất (%)',\r\n    required: false,\r\n    type: 'number',\r\n    exportGroup: 'Giá',\r\n    example: '10',\r\n    importTransform: (value: unknown) => {\r\n      if (!value) return undefined;\r\n      const num = Number(String(value).replace(/[%\\s]/g, ''));\r\n      return isNaN(num) ? undefined : num;\r\n    },\r\n  },\r\n  // NOTE: Giá theo bảng giá (prices) được xử lý động trong preTransformRawRow\r\n  // User tạo cột với tên = mã bảng giá (VD: PL_10, BANLE, VIP...)\r\n  // Hệ thống tự detect và gom vào field prices\r\n\r\n  // ===== TỒN KHO =====\r\n  // NOTE: initialStock chỉ áp dụng khi TẠO MỚI sản phẩm (mode insert-only)\r\n  // Tồn kho sau đó được quản lý qua phiếu nhập/xuất/kiểm kê\r\n  {\r\n    key: 'initialStock',\r\n    label: 'Tồn kho ban đầu',\r\n    required: false,\r\n    type: 'number',\r\n    exportGroup: 'Tồn kho',\r\n    example: '100',\r\n    importTransform: (value: unknown) => {\r\n      if (!value) return undefined;\r\n      const num = Number(String(value).replace(/[,.\\s]/g, ''));\r\n      return isNaN(num) || num < 0 ? undefined : num;\r\n    },\r\n    // NOTE: Field này chỉ dùng khi import tạo mới\r\n    // Không export vì tồn kho thực tế nằm trong inventoryByBranch\r\n  },\r\n  {\r\n    key: 'isStockTracked',\r\n    label: 'Theo dõi tồn kho',\r\n    required: false,\r\n    type: 'boolean',\r\n    exportGroup: 'Tồn kho',\r\n    example: 'Có',\r\n    defaultValue: true,\r\n    importTransform: (value: unknown) => {\r\n      if (!value) return true;\r\n      const str = String(value).toLowerCase();\r\n      return str === 'có' || str === 'yes' || str === 'true' || str === '1';\r\n    },\r\n  },\r\n  {\r\n    key: 'reorderLevel',\r\n    label: 'Mức đặt hàng lại',\r\n    required: false,\r\n    type: 'number',\r\n    exportGroup: 'Tồn kho',\r\n    example: '10',\r\n    importTransform: (value: unknown) => {\r\n      if (!value) return undefined;\r\n      const num = Number(String(value).replace(/[,.\\s]/g, ''));\r\n      return isNaN(num) ? undefined : num;\r\n    },\r\n  },\r\n  {\r\n    key: 'safetyStock',\r\n    label: 'Tồn kho an toàn',\r\n    required: false,\r\n    type: 'number',\r\n    exportGroup: 'Tồn kho',\r\n    example: '5',\r\n    importTransform: (value: unknown) => {\r\n      if (!value) return undefined;\r\n      const num = Number(String(value).replace(/[,.\\s]/g, ''));\r\n      return isNaN(num) ? undefined : num;\r\n    },\r\n  },\r\n  {\r\n    key: 'maxStock',\r\n    label: 'Tồn kho tối đa',\r\n    required: false,\r\n    type: 'number',\r\n    exportGroup: 'Tồn kho',\r\n    example: '100',\r\n    importTransform: (value: unknown) => {\r\n      if (!value) return undefined;\r\n      const num = Number(String(value).replace(/[,.\\s]/g, ''));\r\n      return isNaN(num) ? undefined : num;\r\n    },\r\n  },\r\n\r\n  // ===== VẬT LÝ =====\r\n  {\r\n    key: 'weight',\r\n    label: 'Trọng lượng',\r\n    required: false,\r\n    type: 'number',\r\n    exportGroup: 'Vật lý',\r\n    example: '200',\r\n    importTransform: (value: unknown) => {\r\n      if (!value) return undefined;\r\n      const num = Number(String(value).replace(/[,.\\s]/g, ''));\r\n      return isNaN(num) ? undefined : num;\r\n    },\r\n  },\r\n  {\r\n    key: 'weightUnit',\r\n    label: 'Đơn vị trọng lượng',\r\n    required: false,\r\n    type: 'enum',\r\n    enumValues: ['g', 'kg'],\r\n    exportGroup: 'Vật lý',\r\n    example: 'g',\r\n    defaultValue: 'g',\r\n  },\r\n\r\n  // ===== BẢO HÀNH =====\r\n  {\r\n    key: 'warrantyPeriodMonths',\r\n    label: 'Bảo hành (tháng)',\r\n    required: false,\r\n    type: 'number',\r\n    exportGroup: 'Bảo hành',\r\n    example: '12',\r\n    importTransform: (value: unknown) => {\r\n      if (!value) return undefined;\r\n      const num = Number(String(value).replace(/[,.\\s]/g, ''));\r\n      return isNaN(num) ? undefined : num;\r\n    },\r\n  },\r\n\r\n  // ===== KÍCH THƯỚC =====\r\n  {\r\n    key: 'dimensions',\r\n    label: 'Kích thước (DxRxC cm)',\r\n    required: false,\r\n    type: 'string',\r\n    exportGroup: 'Vật lý',\r\n    example: '30x20x10',\r\n    importTransform: (value: unknown) => {\r\n      if (!value) return undefined;\r\n      const str = String(value).trim();\r\n      const match = str.match(/^(\\d+(?:\\.\\d+)?)\\s*[xX×]\\s*(\\d+(?:\\.\\d+)?)\\s*[xX×]\\s*(\\d+(?:\\.\\d+)?)$/);\r\n      if (match) {\r\n        return {\r\n          length: parseFloat(match[1]),\r\n          width: parseFloat(match[2]),\r\n          height: parseFloat(match[3]),\r\n        };\r\n      }\r\n      return undefined;\r\n    },\r\n    exportTransform: (value: unknown) => {\r\n      const dims = value as { length?: number; width?: number; height?: number } | undefined;\r\n      if (dims && typeof dims === 'object' && 'length' in dims) {\r\n        return `${dims.length || 0}x${dims.width || 0}x${dims.height || 0}`;\r\n      }\r\n      return '';\r\n    },\r\n  },\r\n\r\n  // ===== THÔNG TIN MỞ RỘNG =====\r\n  {\r\n    key: 'ktitle',\r\n    label: 'Tiêu đề SEO',\r\n    required: false,\r\n    type: 'string',\r\n    exportGroup: 'Mô tả',\r\n    example: 'Áo sơ mi nam cao cấp | Thời trang ABC',\r\n  },\r\n  {\r\n    key: 'seoDescription',\r\n    label: 'Mô tả SEO',\r\n    required: false,\r\n    type: 'string',\r\n    exportGroup: 'Mô tả',\r\n    example: 'Áo sơ mi nam chất liệu cotton cao cấp...',\r\n  },\r\n  {\r\n    key: 'subCategories',\r\n    label: 'Danh mục phụ',\r\n    required: false,\r\n    type: 'string',\r\n    exportGroup: 'Phân loại',\r\n    example: 'Slim fit > Form ôm; Cotton > Cao cấp', // Nhiều danh mục phụ phân cách bằng ;\r\n    importTransform: (value: unknown) => {\r\n      if (!value) return undefined;\r\n      const str = String(value).trim();\r\n      if (!str) return undefined;\r\n      // Split by semicolon to get multiple sub-categories\r\n      return str.split(';').map(s => s.trim()).filter(Boolean);\r\n    },\r\n    exportTransform: (value: unknown) => {\r\n      const subCategories = value as string[] | undefined;\r\n      return subCategories?.join('; ') || '';\r\n    },\r\n  },\r\n  // Legacy single subCategory field (backward compatibility)\r\n  {\r\n    key: 'subCategory',\r\n    label: 'Danh mục phụ (cũ)',\r\n    required: false,\r\n    type: 'string',\r\n    exportGroup: 'Phân loại',\r\n    hidden: true,\r\n    example: 'Áo sơ mi > Dài tay > Slim fit',\r\n  },\r\n  {\r\n    key: 'tags',\r\n    label: 'Tags',\r\n    required: false,\r\n    type: 'string',\r\n    exportGroup: 'Phân loại',\r\n    example: 'nam,công sở,cotton',\r\n    importTransform: (value: unknown) => {\r\n      if (!value) return undefined;\r\n      const str = String(value).trim();\r\n      return str.split(/[,;]/).map(s => s.trim()).filter(Boolean);\r\n    },\r\n    exportTransform: (value: unknown) => {\r\n      const tags = value as string[] | undefined;\r\n      return tags?.join(', ') || '';\r\n    },\r\n  },\r\n  {\r\n    key: 'pkgxId',\r\n    label: 'ID PKGX',\r\n    required: false,\r\n    type: 'number',\r\n    exportGroup: 'Thông tin cơ bản',\r\n    example: '12345',\r\n    importTransform: (value: unknown) => {\r\n      if (!value) return undefined;\r\n      const num = Number(String(value).replace(/[,.\\s]/g, ''));\r\n      return isNaN(num) || num <= 0 ? undefined : num;\r\n    },\r\n  },\r\n  {\r\n    key: 'trendtechId',\r\n    label: 'ID Trendtech',\r\n    required: false,\r\n    type: 'number',\r\n    exportGroup: 'Thông tin cơ bản',\r\n    example: '67890',\r\n    importTransform: (value: unknown) => {\r\n      if (!value) return undefined;\r\n      const num = Number(String(value).replace(/[,.\\s]/g, ''));\r\n      return isNaN(num) || num <= 0 ? undefined : num;\r\n    },\r\n  },\r\n  {\r\n    key: 'warehouseLocation',\r\n    label: 'Vị trí kho',\r\n    required: false,\r\n    type: 'string',\r\n    exportGroup: 'Tồn kho',\r\n    example: 'A1-01',\r\n  },\r\n\r\n  // ===== GIÁ BỔ SUNG =====\r\n  {\r\n    key: 'lastPurchasePrice',\r\n    label: 'Giá nhập gần nhất',\r\n    required: false,\r\n    type: 'number',\r\n    exportGroup: 'Giá',\r\n    example: '140000',\r\n    importTransform: (value: unknown) => {\r\n      if (!value) return undefined;\r\n      const num = Number(String(value).replace(/[,.\\s]/g, ''));\r\n      return isNaN(num) ? undefined : num;\r\n    },\r\n  },\r\n\r\n  // ===== THÔNG TIN TEM =====\r\n  {\r\n    key: 'nameVat',\r\n    label: 'Tên VAT',\r\n    required: false,\r\n    type: 'string',\r\n    exportGroup: 'Tem phụ',\r\n    example: 'Áo sơ mi nam cotton',\r\n  },\r\n  {\r\n    key: 'origin',\r\n    label: 'Xuất xứ',\r\n    required: false,\r\n    type: 'string',\r\n    exportGroup: 'Tem phụ',\r\n    example: 'Việt Nam',\r\n  },\r\n  {\r\n    key: 'usageGuide',\r\n    label: 'Hướng dẫn sử dụng',\r\n    required: false,\r\n    type: 'string',\r\n    exportGroup: 'Tem phụ',\r\n    example: 'Giặt máy ở nhiệt độ thấp',\r\n  },\r\n  {\r\n    key: 'importerName',\r\n    label: 'Đơn vị nhập khẩu',\r\n    required: false,\r\n    type: 'string',\r\n    exportGroup: 'Tem phụ',\r\n    example: 'Công ty TNHH ABC',\r\n  },\r\n  {\r\n    key: 'importerAddress',\r\n    label: 'Địa chỉ nhập khẩu',\r\n    required: false,\r\n    type: 'string',\r\n    exportGroup: 'Tem phụ',\r\n    example: '123 Nguyễn Văn A, Q.1, TP.HCM',\r\n  },\r\n\r\n  // ===== E-COMMERCE (bán hàng website) =====\r\n  // Slug chung (legacy - không khuyến khích dùng nữa)\r\n  {\r\n    key: 'slug',\r\n    label: 'Slug (URL)',\r\n    required: false,\r\n    type: 'string',\r\n    exportGroup: 'E-commerce',\r\n    hidden: true, // Ẩn field cũ, dùng pkgxSlug/trendtechSlug thay thế\r\n    example: 'ao-so-mi-nam-trang-oxford',\r\n    importTransform: (value: unknown) => {\r\n      if (!value) return undefined;\r\n      // Convert to URL-friendly slug\r\n      return String(value).trim()\r\n        .toLowerCase()\r\n        .normalize('NFD')\r\n        .replace(/[\\u0300-\\u036f]/g, '') // Remove diacritics\r\n        .replace(/đ/g, 'd')\r\n        .replace(/[^a-z0-9]+/g, '-')\r\n        .replace(/^-+|-+$/g, '');\r\n    },\r\n  },\r\n  // Slug riêng cho PKGX website\r\n  {\r\n    key: 'pkgxSlug',\r\n    label: 'Slug PKGX',\r\n    required: false,\r\n    type: 'string',\r\n    exportGroup: 'E-commerce PKGX',\r\n    example: 'ao-so-mi-nam-trang-oxford',\r\n    importTransform: (value: unknown) => {\r\n      if (!value) return undefined;\r\n      // Convert to URL-friendly slug\r\n      return String(value).trim()\r\n        .toLowerCase()\r\n        .normalize('NFD')\r\n        .replace(/[\\u0300-\\u036f]/g, '') // Remove diacritics\r\n        .replace(/đ/g, 'd')\r\n        .replace(/[^a-z0-9]+/g, '-')\r\n        .replace(/^-+|-+$/g, '');\r\n    },\r\n  },\r\n  // Slug riêng cho Trendtech website\r\n  {\r\n    key: 'trendtechSlug',\r\n    label: 'Slug Trendtech',\r\n    required: false,\r\n    type: 'string',\r\n    exportGroup: 'E-commerce Trendtech',\r\n    example: 'ao-so-mi-nam-trang-oxford',\r\n    importTransform: (value: unknown) => {\r\n      if (!value) return undefined;\r\n      // Convert to URL-friendly slug\r\n      return String(value).trim()\r\n        .toLowerCase()\r\n        .normalize('NFD')\r\n        .replace(/[\\u0300-\\u036f]/g, '') // Remove diacritics\r\n        .replace(/đ/g, 'd')\r\n        .replace(/[^a-z0-9]+/g, '-')\r\n        .replace(/^-+|-+$/g, '');\r\n    },\r\n  },\r\n  {\r\n    key: 'isPublished',\r\n    label: 'Đăng web',\r\n    required: false,\r\n    type: 'boolean',\r\n    exportGroup: 'E-commerce',\r\n    example: 'Có',\r\n    defaultValue: false,\r\n    importTransform: (value: unknown) => {\r\n      if (value === undefined || value === null || value === '') return false;\r\n      const str = String(value).toLowerCase().trim();\r\n      return str === 'có' || str === 'yes' || str === '1' || str === 'true' || str === 'x';\r\n    },\r\n    exportTransform: (value: unknown) => (value ? 'Có' : 'Không'),\r\n  },\r\n  {\r\n    key: 'isFeatured',\r\n    label: 'Nổi bật',\r\n    required: false,\r\n    type: 'boolean',\r\n    exportGroup: 'E-commerce',\r\n    example: 'Có',\r\n    defaultValue: false,\r\n    importTransform: (value: unknown) => {\r\n      if (value === undefined || value === null || value === '') return false;\r\n      const str = String(value).toLowerCase().trim();\r\n      return str === 'có' || str === 'yes' || str === '1' || str === 'true' || str === 'x';\r\n    },\r\n    exportTransform: (value: unknown) => (value ? 'Có' : 'Không'),\r\n  },\r\n  {\r\n    key: 'isNewArrival',\r\n    label: 'Mới về',\r\n    required: false,\r\n    type: 'boolean',\r\n    exportGroup: 'E-commerce',\r\n    example: 'Có',\r\n    defaultValue: false,\r\n    importTransform: (value: unknown) => {\r\n      if (value === undefined || value === null || value === '') return false;\r\n      const str = String(value).toLowerCase().trim();\r\n      return str === 'có' || str === 'yes' || str === '1' || str === 'true' || str === 'x';\r\n    },\r\n    exportTransform: (value: unknown) => (value ? 'Có' : 'Không'),\r\n  },\r\n  {\r\n    key: 'isBestSeller',\r\n    label: 'Bán chạy',\r\n    required: false,\r\n    type: 'boolean',\r\n    exportGroup: 'E-commerce',\r\n    example: 'Có',\r\n    defaultValue: false,\r\n    importTransform: (value: unknown) => {\r\n      if (value === undefined || value === null || value === '') return false;\r\n      const str = String(value).toLowerCase().trim();\r\n      return str === 'có' || str === 'yes' || str === '1' || str === 'true' || str === 'x';\r\n    },\r\n    exportTransform: (value: unknown) => (value ? 'Có' : 'Không'),\r\n  },\r\n  {\r\n    key: 'isOnSale',\r\n    label: 'Đang giảm giá',\r\n    required: false,\r\n    type: 'boolean',\r\n    exportGroup: 'E-commerce',\r\n    example: 'Có',\r\n    defaultValue: false,\r\n    importTransform: (value: unknown) => {\r\n      if (value === undefined || value === null || value === '') return false;\r\n      const str = String(value).toLowerCase().trim();\r\n      return str === 'có' || str === 'yes' || str === '1' || str === 'true' || str === 'x';\r\n    },\r\n    exportTransform: (value: unknown) => (value ? 'Có' : 'Không'),\r\n  },\r\n  {\r\n    key: 'sortOrder',\r\n    label: 'Thứ tự hiển thị',\r\n    required: false,\r\n    type: 'number',\r\n    exportGroup: 'E-commerce',\r\n    example: '1',\r\n    importTransform: (value: unknown) => {\r\n      if (!value) return undefined;\r\n      const num = Number(String(value).replace(/[,.\\s]/g, ''));\r\n      return isNaN(num) ? undefined : num;\r\n    },\r\n  },\r\n  {\r\n    key: 'publishedAt',\r\n    label: 'Ngày đăng web',\r\n    required: false,\r\n    type: 'date',\r\n    exportGroup: 'E-commerce',\r\n    example: '2024-01-15',\r\n  },\r\n\r\n  // ===== PHÂN TÍCH BÁN HÀNG =====\r\n  {\r\n    key: 'totalSold',\r\n    label: 'Tổng đã bán',\r\n    required: false,\r\n    type: 'number',\r\n    exportGroup: 'Phân tích',\r\n    hidden: true, // Chỉ export, không import\r\n    importTransform: (value: unknown) => {\r\n      if (!value) return undefined;\r\n      const num = Number(String(value).replace(/[,.\\s]/g, ''));\r\n      return isNaN(num) ? undefined : num;\r\n    },\r\n  },\r\n  {\r\n    key: 'totalRevenue',\r\n    label: 'Tổng doanh thu',\r\n    required: false,\r\n    type: 'number',\r\n    exportGroup: 'Phân tích',\r\n    hidden: true, // Chỉ export, không import\r\n    importTransform: (value: unknown) => {\r\n      if (!value) return undefined;\r\n      const num = Number(String(value).replace(/[,.\\s]/g, ''));\r\n      return isNaN(num) ? undefined : num;\r\n    },\r\n  },\r\n  {\r\n    key: 'lastSoldDate',\r\n    label: 'Ngày bán gần nhất',\r\n    required: false,\r\n    type: 'date',\r\n    exportGroup: 'Phân tích',\r\n    hidden: true,\r\n  },\r\n  {\r\n    key: 'viewCount',\r\n    label: 'Lượt xem',\r\n    required: false,\r\n    type: 'number',\r\n    exportGroup: 'Phân tích',\r\n    hidden: true,\r\n    importTransform: (value: unknown) => {\r\n      if (!value) return undefined;\r\n      const num = Number(String(value).replace(/[,.\\s]/g, ''));\r\n      return isNaN(num) ? undefined : num;\r\n    },\r\n  },\r\n\r\n  // ===== VÒNG ĐỜI SẢN PHẨM =====\r\n  {\r\n    key: 'launchedDate',\r\n    label: 'Ngày ra mắt',\r\n    required: false,\r\n    type: 'date',\r\n    exportGroup: 'Vòng đời',\r\n    example: '2024-01-15',\r\n  },\r\n  {\r\n    key: 'lastPurchaseDate',\r\n    label: 'Ngày nhập gần nhất',\r\n    required: false,\r\n    type: 'date',\r\n    exportGroup: 'Vòng đời',\r\n    hidden: true,\r\n  },\r\n  {\r\n    key: 'discontinuedDate',\r\n    label: 'Ngày ngừng kinh doanh',\r\n    required: false,\r\n    type: 'date',\r\n    exportGroup: 'Vòng đời',\r\n    example: '2025-12-31',\r\n  },\r\n\r\n  // ===== HỆ THỐNG (hidden) =====\r\n  {\r\n    key: 'systemId',\r\n    label: 'System ID',\r\n    required: false,\r\n    type: 'string',\r\n    exportGroup: 'Hệ thống',\r\n    hidden: true,\r\n  },\r\n  {\r\n    key: 'createdAt',\r\n    label: 'Ngày tạo',\r\n    required: false,\r\n    type: 'date',\r\n    exportGroup: 'Hệ thống',\r\n    hidden: true,\r\n  },\r\n  {\r\n    key: 'updatedAt',\r\n    label: 'Ngày cập nhật',\r\n    required: false,\r\n    type: 'date',\r\n    exportGroup: 'Hệ thống',\r\n    hidden: true,\r\n  },\r\n];\r\n\r\n// ===== MAIN CONFIG =====\r\nexport const productImportExportConfig: ImportExportConfig<Product> = {\r\n  entityType: 'products',\r\n  entityDisplayName: 'Sản phẩm',\r\n  fields: productFields,\r\n  upsertKey: 'id', // Dùng mã sản phẩm để đối chiếu khi UPDATE\r\n  templateFileName: 'mau-import-san-pham.xlsx',\r\n  requireBranch: true, // Bắt buộc chi nhánh để xử lý tồn kho ban đầu\r\n  \r\n  // Pre-transform raw row (normalize column names + detect pricing columns)\r\n  preTransformRawRow: (rawRow: Record<string, unknown>) => {\r\n    const normalized: Record<string, unknown> = {};\r\n    const prices: Record<string, number> = {};\r\n    \r\n    // Map từ label tiếng Việt sang key\r\n    const labelToKey: Record<string, string> = {};\r\n    productFields.forEach(field => {\r\n      labelToKey[field.label.toLowerCase()] = field.key as string;\r\n      // Also map without (*) marker\r\n      const labelWithoutStar = field.label.replace(/\\s*\\(\\*\\)\\s*$/, '').toLowerCase();\r\n      labelToKey[labelWithoutStar] = field.key as string;\r\n    });\r\n    \r\n    Object.entries(rawRow).forEach(([key, value]) => {\r\n      // Normalize Excel header: strip (*) marker and lowercase\r\n      const normalizedExcelHeader = key.replace(/\\s*\\(\\*\\)\\s*$/, '').toLowerCase();\r\n      \r\n      // Check if this column is a pricing policy code (e.g., PL_10, BANLE, VIP)\r\n      const policySystemId = getPricingPolicySystemId(key);\r\n      if (policySystemId && value !== undefined && value !== null && value !== '') {\r\n        // This is a pricing column - parse price value\r\n        const priceValue = Number(String(value).replace(/[,.\\s]/g, ''));\r\n        if (!isNaN(priceValue) && priceValue > 0) {\r\n          prices[policySystemId] = priceValue;\r\n        }\r\n      } else {\r\n        // Normal field - map to key\r\n        const normalizedKey = labelToKey[normalizedExcelHeader] || labelToKey[key.toLowerCase()] || key;\r\n        normalized[normalizedKey] = value;\r\n      }\r\n    });\r\n    \r\n    // Add prices if any pricing columns were found\r\n    if (Object.keys(prices).length > 0) {\r\n      normalized.prices = prices;\r\n    }\r\n    \r\n    return normalized;\r\n  },\r\n  \r\n  // Post-transform row (set defaults, enrich data)\r\n  // NOTE: branchSystemId được truyền từ import dialog để xử lý tồn kho ban đầu\r\n  postTransformRow: (row: Partial<Product & { initialStock?: number }>, _index?: number, branchSystemId?: string) => {\r\n    // Xử lý tồn kho ban đầu - chỉ áp dụng khi có initialStock và branchSystemId\r\n    let inventoryByBranch = row.inventoryByBranch || {};\r\n    const initialStock = (row as { initialStock?: number }).initialStock;\r\n    \r\n    if (initialStock !== undefined && initialStock > 0 && branchSystemId) {\r\n      inventoryByBranch = {\r\n        ...inventoryByBranch,\r\n        [branchSystemId]: initialStock,\r\n      };\r\n    }\r\n    \r\n    // Remove initialStock from final data (không lưu vào Product)\r\n    const { initialStock: _removed, ...cleanRow } = row as Partial<Product> & { initialStock?: number };\r\n    \r\n    // Auto-set productTypeSystemId nếu chưa có\r\n    // Ưu tiên: productTypeSystemId > type enum mapping > default\r\n    let productTypeSystemIdStr = cleanRow.productTypeSystemId as string | undefined;\r\n    if (!productTypeSystemIdStr && cleanRow.type) {\r\n      // Map từ type enum sang productTypeSystemId\r\n      productTypeSystemIdStr = getProductTypeSystemIdByEnumType(cleanRow.type) || undefined;\r\n    }\r\n    if (!productTypeSystemIdStr) {\r\n      // Fallback: lấy default ProductType\r\n      productTypeSystemIdStr = getDefaultProductTypeSystemId() || undefined;\r\n    }\r\n    \r\n    // Cast to SystemId if we have a value\r\n    const productTypeSystemId = productTypeSystemIdStr ? asSystemId(productTypeSystemIdStr) : undefined;\r\n    \r\n    return {\r\n      ...cleanRow,\r\n      type: cleanRow.type || 'physical',\r\n      productTypeSystemId, // Luôn set productTypeSystemId\r\n      status: cleanRow.status || 'active',\r\n      unit: cleanRow.unit || 'Cái',\r\n      costPrice: cleanRow.costPrice ?? 0,\r\n      sellingPrice: cleanRow.sellingPrice ?? 0,\r\n      isStockTracked: cleanRow.isStockTracked ?? true,\r\n      prices: cleanRow.prices || {},\r\n      inventoryByBranch,\r\n      committedByBranch: cleanRow.committedByBranch || {},\r\n      inTransitByBranch: cleanRow.inTransitByBranch || {},\r\n    };\r\n  },\r\n  \r\n  // Validate row level (check duplicate SKU/barcode + warnings)\r\n  validateRow: (row, _index, existingData, mode) => {\r\n    const errors: Array<{ field?: string; message: string; type?: 'error' | 'warning' }> = [];\r\n    const rowWithInitialStock = row as Partial<Product> & { initialStock?: number };\r\n    \r\n    // Check unique SKU - only in insert-only mode\r\n    if (row.sku && mode === 'insert-only') {\r\n      const duplicate = existingData.find(\r\n        p => p.sku === row.sku && p.id !== row.id\r\n      );\r\n      if (duplicate) {\r\n        errors.push({\r\n          field: 'sku',\r\n          message: `SKU đã được sử dụng bởi ${duplicate.name} (${duplicate.id})`,\r\n        });\r\n      }\r\n    }\r\n    \r\n    // Check unique barcode - only in insert-only mode\r\n    if (row.barcode && mode === 'insert-only') {\r\n      const duplicate = existingData.find(\r\n        p => p.barcode === row.barcode && p.id !== row.id\r\n      );\r\n      if (duplicate) {\r\n        errors.push({\r\n          field: 'barcode',\r\n          message: `Mã vạch đã được sử dụng bởi ${duplicate.name} (${duplicate.id})`,\r\n        });\r\n      }\r\n    }\r\n    \r\n    // Cảnh báo: initialStock chỉ có tác dụng khi tạo mới\r\n    if (rowWithInitialStock.initialStock !== undefined && rowWithInitialStock.initialStock > 0) {\r\n      if (mode === 'update-only') {\r\n        errors.push({\r\n          field: 'initialStock',\r\n          message: 'Tồn kho ban đầu sẽ bị BỎ QUA vì đang ở chế độ Cập nhật',\r\n          type: 'warning',\r\n        });\r\n      } else if (mode === 'upsert') {\r\n        // Check if product exists\r\n        const exists = existingData.find(p => p.id === row.id);\r\n        if (exists) {\r\n          errors.push({\r\n            field: 'initialStock',\r\n            message: `SP đã tồn tại - tồn kho ban đầu sẽ BỎ QUA (giữ nguyên tồn kho hiện tại)`,\r\n            type: 'warning',\r\n          });\r\n        }\r\n      }\r\n    }\r\n    \r\n    // Cảnh báo giá bán < giá vốn\r\n    if (row.costPrice && row.sellingPrice && row.costPrice > row.sellingPrice) {\r\n      errors.push({\r\n        field: 'sellingPrice',\r\n        message: `Giá bán (${row.sellingPrice?.toLocaleString()}) thấp hơn giá vốn (${row.costPrice?.toLocaleString()})`,\r\n        type: 'warning',\r\n      });\r\n    }\r\n    \r\n    return errors;\r\n  },\r\n};\r\n\r\n// Re-export cho backward compatibility\r\nexport default productImportExportConfig;\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 4512, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/lib/import-export/configs/brand.config.ts"],"sourcesContent":["import type { Brand } from '@/features/settings/inventory/types';\r\nimport type { ImportExportConfig, FieldConfig } from '../types';\r\n\r\n/**\r\n * Brand Import/Export Configuration\r\n * Theo chuẩn ImportExportConfig để dùng với GenericImportDialogV2 và GenericExportDialogV2\r\n */\r\n\r\n// Field definitions for Brand import/export\r\nexport const brandFields: FieldConfig<Brand>[] = [\r\n  // === Basic Info ===\r\n  {\r\n    key: 'id',\r\n    label: 'Mã thương hiệu (*)',\r\n    type: 'string',\r\n    required: true,\r\n    exportGroup: 'Thông tin cơ bản',\r\n    exportable: true,\r\n    example: 'BRAND001',\r\n    validator: (value) => {\r\n      if (!value || String(value).trim() === '') {\r\n        return 'Mã thương hiệu là bắt buộc';\r\n      }\r\n      return null;\r\n    }\r\n  },\r\n  {\r\n    key: 'name',\r\n    label: 'Tên thương hiệu (*)',\r\n    type: 'string',\r\n    required: true,\r\n    exportGroup: 'Thông tin cơ bản',\r\n    exportable: true,\r\n    example: 'Apple',\r\n    validator: (value) => {\r\n      if (!value || String(value).trim() === '') {\r\n        return 'Tên thương hiệu là bắt buộc';\r\n      }\r\n      return null;\r\n    }\r\n  },\r\n  {\r\n    key: 'description',\r\n    label: 'Mô tả',\r\n    type: 'string',\r\n    required: false,\r\n    exportGroup: 'Thông tin cơ bản',\r\n    exportable: true,\r\n    example: 'Thương hiệu công nghệ hàng đầu thế giới',\r\n  },\r\n  {\r\n    key: 'website',\r\n    label: 'Website',\r\n    type: 'string',\r\n    required: false,\r\n    exportGroup: 'Thông tin cơ bản',\r\n    exportable: true,\r\n    example: 'https://www.apple.com',\r\n    validator: (value) => {\r\n      if (value && typeof value === 'string') {\r\n        const trimmed = value.trim();\r\n        if (trimmed && !trimmed.match(/^https?:\\/\\/.+/i)) {\r\n          return 'Website phải bắt đầu bằng http:// hoặc https://';\r\n        }\r\n      }\r\n      return null;\r\n    }\r\n  },\r\n  {\r\n    key: 'logo',\r\n    label: 'Logo URL',\r\n    type: 'string',\r\n    required: false,\r\n    exportGroup: 'Thông tin cơ bản',\r\n    exportable: true,\r\n    example: 'https://example.com/logo.png',\r\n  },\r\n  \r\n  // === SEO Fields ===\r\n  {\r\n    key: 'seoTitle',\r\n    label: 'SEO Title',\r\n    type: 'string',\r\n    required: false,\r\n    exportGroup: 'SEO & Mô tả',\r\n    exportable: true,\r\n    example: 'Apple - Thương hiệu công nghệ cao cấp',\r\n  },\r\n  {\r\n    key: 'metaDescription',\r\n    label: 'Meta Description',\r\n    type: 'string',\r\n    required: false,\r\n    exportGroup: 'SEO & Mô tả',\r\n    exportable: true,\r\n    example: 'Apple Inc. là tập đoàn công nghệ đa quốc gia...',\r\n  },\r\n  {\r\n    key: 'seoKeywords',\r\n    label: 'SEO Keywords',\r\n    type: 'string',\r\n    required: false,\r\n    exportGroup: 'SEO & Mô tả',\r\n    exportable: true,\r\n    example: 'apple, iphone, macbook, công nghệ',\r\n  },\r\n  {\r\n    key: 'shortDescription',\r\n    label: 'Mô tả ngắn',\r\n    type: 'string',\r\n    required: false,\r\n    exportGroup: 'SEO & Mô tả',\r\n    exportable: true,\r\n    example: 'Thương hiệu công nghệ hàng đầu từ Mỹ',\r\n  },\r\n  {\r\n    key: 'longDescription',\r\n    label: 'Mô tả chi tiết',\r\n    type: 'string',\r\n    required: false,\r\n    exportGroup: 'SEO & Mô tả',\r\n    exportable: true,\r\n    example: '<p>Apple Inc. được thành lập năm 1976...</p>',\r\n  },\r\n  \r\n  // === Settings ===\r\n  {\r\n    key: 'isActive',\r\n    label: 'Trạng thái',\r\n    type: 'boolean',\r\n    required: false,\r\n    exportGroup: 'Cài đặt',\r\n    exportable: true,\r\n    example: 'Hoạt động',\r\n    importTransform: (value) => {\r\n      if (typeof value === 'boolean') return value;\r\n      if (typeof value === 'number') return value === 1;\r\n      const strValue = String(value).toLowerCase().trim();\r\n      return strValue === 'true' || strValue === '1' || strValue === 'hoạt động' || strValue === 'hoat dong' || strValue === 'có' || strValue === 'co' || strValue === 'yes' || strValue === 'active';\r\n    },\r\n    exportTransform: (value) => value ? 'Hoạt động' : 'Ngừng'\r\n  },\r\n];\r\n\r\n// Group labels for UI organization\r\nexport const brandFieldGroups = {\r\n  'Thông tin cơ bản': 'Thông tin cơ bản',\r\n  'SEO & Mô tả': 'SEO & Mô tả',\r\n  'Cài đặt': 'Cài đặt',\r\n} as const;\r\n\r\n// Full config object\r\nexport const brandImportExportConfig: ImportExportConfig<Brand> = {\r\n  entityType: 'brands',\r\n  entityDisplayName: 'Thương hiệu',\r\n  fields: brandFields,\r\n  \r\n  // Template file\r\n  templateFileName: 'Mau_Nhap_Thuong_Hieu.xlsx',\r\n  sheetName: 'Thương hiệu',\r\n  \r\n  // Upsert config - dùng id làm key\r\n  upsertKey: 'id',\r\n  allowUpdate: true,\r\n  allowInsert: true,\r\n  \r\n  // Max rows\r\n  maxRows: 500,\r\n  \r\n  // Row-level transform after all field transforms\r\n  postTransformRow: (row: Partial<Brand>) => {\r\n    // Ensure isActive defaults to true for new brands\r\n    if (row.isActive === undefined) {\r\n      row.isActive = true;\r\n    }\r\n    return row;\r\n  },\r\n  \r\n  // Validate entire row\r\n  validateRow: (row: Brand, _index: number, _existingData: Brand[], _mode) => {\r\n    const errors: Array<{ field?: string; message: string }> = [];\r\n    \r\n    if (!row.id || String(row.id).trim() === '') {\r\n      errors.push({ field: 'id', message: 'Mã thương hiệu là bắt buộc' });\r\n    }\r\n    \r\n    if (!row.name || String(row.name).trim() === '') {\r\n      errors.push({ field: 'name', message: 'Tên thương hiệu là bắt buộc' });\r\n    }\r\n    \r\n    return errors;\r\n  }\r\n};\r\n"],"names":[],"mappings":";;;;;;;;AASO,MAAM,cAAoC;IAC/C,qBAAqB;IACrB;QACE,KAAK;QACL,OAAO;QACP,MAAM;QACN,UAAU;QACV,aAAa;QACb,YAAY;QACZ,SAAS;QACT,WAAW,CAAC;YACV,IAAI,CAAC,SAAS,OAAO,OAAO,IAAI,OAAO,IAAI;gBACzC,OAAO;YACT;YACA,OAAO;QACT;IACF;IACA;QACE,KAAK;QACL,OAAO;QACP,MAAM;QACN,UAAU;QACV,aAAa;QACb,YAAY;QACZ,SAAS;QACT,WAAW,CAAC;YACV,IAAI,CAAC,SAAS,OAAO,OAAO,IAAI,OAAO,IAAI;gBACzC,OAAO;YACT;YACA,OAAO;QACT;IACF;IACA;QACE,KAAK;QACL,OAAO;QACP,MAAM;QACN,UAAU;QACV,aAAa;QACb,YAAY;QACZ,SAAS;IACX;IACA;QACE,KAAK;QACL,OAAO;QACP,MAAM;QACN,UAAU;QACV,aAAa;QACb,YAAY;QACZ,SAAS;QACT,WAAW,CAAC;YACV,IAAI,SAAS,OAAO,UAAU,UAAU;gBACtC,MAAM,UAAU,MAAM,IAAI;gBAC1B,IAAI,WAAW,CAAC,QAAQ,KAAK,CAAC,oBAAoB;oBAChD,OAAO;gBACT;YACF;YACA,OAAO;QACT;IACF;IACA;QACE,KAAK;QACL,OAAO;QACP,MAAM;QACN,UAAU;QACV,aAAa;QACb,YAAY;QACZ,SAAS;IACX;IAEA,qBAAqB;IACrB;QACE,KAAK;QACL,OAAO;QACP,MAAM;QACN,UAAU;QACV,aAAa;QACb,YAAY;QACZ,SAAS;IACX;IACA;QACE,KAAK;QACL,OAAO;QACP,MAAM;QACN,UAAU;QACV,aAAa;QACb,YAAY;QACZ,SAAS;IACX;IACA;QACE,KAAK;QACL,OAAO;QACP,MAAM;QACN,UAAU;QACV,aAAa;QACb,YAAY;QACZ,SAAS;IACX;IACA;QACE,KAAK;QACL,OAAO;QACP,MAAM;QACN,UAAU;QACV,aAAa;QACb,YAAY;QACZ,SAAS;IACX;IACA;QACE,KAAK;QACL,OAAO;QACP,MAAM;QACN,UAAU;QACV,aAAa;QACb,YAAY;QACZ,SAAS;IACX;IAEA,mBAAmB;IACnB;QACE,KAAK;QACL,OAAO;QACP,MAAM;QACN,UAAU;QACV,aAAa;QACb,YAAY;QACZ,SAAS;QACT,iBAAiB,CAAC;YAChB,IAAI,OAAO,UAAU,WAAW,OAAO;YACvC,IAAI,OAAO,UAAU,UAAU,OAAO,UAAU;YAChD,MAAM,WAAW,OAAO,OAAO,WAAW,GAAG,IAAI;YACjD,OAAO,aAAa,UAAU,aAAa,OAAO,aAAa,eAAe,aAAa,eAAe,aAAa,QAAQ,aAAa,QAAQ,aAAa,SAAS,aAAa;QACzL;QACA,iBAAiB,CAAC,QAAU,QAAQ,cAAc;IACpD;CACD;AAGM,MAAM,mBAAmB;IAC9B,oBAAoB;IACpB,eAAe;IACf,WAAW;AACb;AAGO,MAAM,0BAAqD;IAChE,YAAY;IACZ,mBAAmB;IACnB,QAAQ;IAER,gBAAgB;IAChB,kBAAkB;IAClB,WAAW;IAEX,kCAAkC;IAClC,WAAW;IACX,aAAa;IACb,aAAa;IAEb,WAAW;IACX,SAAS;IAET,iDAAiD;IACjD,kBAAkB,CAAC;QACjB,kDAAkD;QAClD,IAAI,IAAI,QAAQ,KAAK,WAAW;YAC9B,IAAI,QAAQ,GAAG;QACjB;QACA,OAAO;IACT;IAEA,sBAAsB;IACtB,aAAa,CAAC,KAAY,QAAgB,eAAwB;QAChE,MAAM,SAAqD,EAAE;QAE7D,IAAI,CAAC,IAAI,EAAE,IAAI,OAAO,IAAI,EAAE,EAAE,IAAI,OAAO,IAAI;YAC3C,OAAO,IAAI,CAAC;gBAAE,OAAO;gBAAM,SAAS;YAA6B;QACnE;QAEA,IAAI,CAAC,IAAI,IAAI,IAAI,OAAO,IAAI,IAAI,EAAE,IAAI,OAAO,IAAI;YAC/C,OAAO,IAAI,CAAC;gBAAE,OAAO;gBAAQ,SAAS;YAA8B;QACtE;QAEA,OAAO;IACT;AACF"}},
    {"offset": {"line": 4700, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/lib/import-export/configs/category.config.ts"],"sourcesContent":["import type { ProductCategory } from '@/features/settings/inventory/types';\r\nimport type { ImportExportConfig, FieldConfig } from '../types';\r\nimport { useProductCategoryStore } from '@/features/settings/inventory/product-category-store';\r\n\r\n/**\r\n * Product Category Import/Export Configuration\r\n * Theo chuẩn ImportExportConfig để dùng với GenericImportDialogV2 và GenericExportDialogV2\r\n */\r\n\r\n// ===== CATEGORY HELPERS =====\r\n// Helper: Get all categories for parent lookup\r\nconst getAllCategories = () => {\r\n  return useProductCategoryStore.getState().data.filter(c => !c.isDeleted);\r\n};\r\n\r\n// Helper: Get parent category systemId from name or path\r\nconst getParentCategorySystemId = (value: string): string | null => {\r\n  if (!value || String(value).trim() === '') return null;\r\n  \r\n  const categories = getAllCategories();\r\n  const normalizedValue = String(value).trim().toLowerCase();\r\n  \r\n  // Try exact match by name first\r\n  const byName = categories.find(c => \r\n    c.name.toLowerCase() === normalizedValue ||\r\n    c.id.toLowerCase() === normalizedValue\r\n  );\r\n  if (byName) return byName.systemId;\r\n  \r\n  // Try match by path (e.g., \"Điện tử > Máy tính\")\r\n  const byPath = categories.find(c => \r\n    c.path?.toLowerCase() === normalizedValue\r\n  );\r\n  if (byPath) return byPath.systemId;\r\n  \r\n  return null;\r\n};\r\n\r\n// Helper: Get parent category display name from systemId\r\nconst getParentCategoryName = (systemId: string | undefined): string => {\r\n  if (!systemId) return '';\r\n  const categories = getAllCategories();\r\n  const parent = categories.find(c => c.systemId === systemId);\r\n  return parent?.name || '';\r\n};\r\n\r\n// Field definitions for ProductCategory import/export\r\nexport const categoryFields: FieldConfig<ProductCategory>[] = [\r\n  // === Basic Info ===\r\n  {\r\n    key: 'id',\r\n    label: 'Mã danh mục (*)',\r\n    type: 'string',\r\n    required: true,\r\n    exportGroup: 'Thông tin cơ bản',\r\n    exportable: true,\r\n    example: 'CAT001',\r\n    validator: (value) => {\r\n      if (!value || String(value).trim() === '') {\r\n        return 'Mã danh mục là bắt buộc';\r\n      }\r\n      return null;\r\n    }\r\n  },\r\n  {\r\n    key: 'name',\r\n    label: 'Tên danh mục (*)',\r\n    type: 'string',\r\n    required: true,\r\n    exportGroup: 'Thông tin cơ bản',\r\n    exportable: true,\r\n    example: 'Điện thoại',\r\n    validator: (value) => {\r\n      if (!value || String(value).trim() === '') {\r\n        return 'Tên danh mục là bắt buộc';\r\n      }\r\n      return null;\r\n    }\r\n  },\r\n  {\r\n    key: 'slug',\r\n    label: 'Slug',\r\n    type: 'string',\r\n    required: false,\r\n    exportGroup: 'Thông tin cơ bản',\r\n    exportable: true,\r\n    example: 'dien-thoai',\r\n  },\r\n  \r\n  // === Hierarchy ===\r\n  {\r\n    key: 'parentId',\r\n    label: 'Danh mục cha',\r\n    type: 'string',\r\n    required: false,\r\n    exportGroup: 'Phân cấp',\r\n    exportable: true,\r\n    example: 'Điện tử',\r\n    importTransform: (value) => {\r\n      if (!value) return undefined;\r\n      const systemId = getParentCategorySystemId(String(value));\r\n      return systemId || undefined;\r\n    },\r\n    exportTransform: (value) => {\r\n      // Value is the parentId systemId\r\n      return getParentCategoryName(value as string);\r\n    }\r\n  },\r\n  {\r\n    key: 'path',\r\n    label: 'Đường dẫn',\r\n    type: 'string',\r\n    required: false,\r\n    exportGroup: 'Phân cấp',\r\n    exportable: true,\r\n    hidden: true, // Don't show in import (auto-generated)\r\n    example: 'Điện tử > Điện thoại',\r\n  },\r\n  {\r\n    key: 'level',\r\n    label: 'Cấp độ',\r\n    type: 'number',\r\n    required: false,\r\n    exportGroup: 'Phân cấp',\r\n    exportable: true,\r\n    hidden: true, // Don't show in import (auto-calculated)\r\n    example: '1',\r\n  },\r\n  \r\n  // === Display ===\r\n  {\r\n    key: 'color',\r\n    label: 'Màu sắc',\r\n    type: 'string',\r\n    required: false,\r\n    exportGroup: 'Hiển thị',\r\n    exportable: true,\r\n    example: '#3b82f6',\r\n  },\r\n  {\r\n    key: 'icon',\r\n    label: 'Icon',\r\n    type: 'string',\r\n    required: false,\r\n    exportGroup: 'Hiển thị',\r\n    exportable: true,\r\n    example: '📱',\r\n  },\r\n  {\r\n    key: 'thumbnailImage',\r\n    label: 'Ảnh đại diện',\r\n    type: 'string',\r\n    required: false,\r\n    exportGroup: 'Hiển thị',\r\n    exportable: true,\r\n    example: 'https://example.com/category.jpg',\r\n  },\r\n  {\r\n    key: 'sortOrder',\r\n    label: 'Thứ tự',\r\n    type: 'number',\r\n    required: false,\r\n    exportGroup: 'Hiển thị',\r\n    exportable: true,\r\n    example: '1',\r\n    importTransform: (value) => {\r\n      if (value === undefined || value === null || value === '') return 0;\r\n      const num = Number(value);\r\n      return isNaN(num) ? 0 : num;\r\n    }\r\n  },\r\n  \r\n  // === SEO Fields ===\r\n  {\r\n    key: 'seoTitle',\r\n    label: 'SEO Title',\r\n    type: 'string',\r\n    required: false,\r\n    exportGroup: 'SEO & Mô tả',\r\n    exportable: true,\r\n    example: 'Điện thoại chính hãng - Giá tốt nhất',\r\n  },\r\n  {\r\n    key: 'metaDescription',\r\n    label: 'Meta Description',\r\n    type: 'string',\r\n    required: false,\r\n    exportGroup: 'SEO & Mô tả',\r\n    exportable: true,\r\n    example: 'Mua điện thoại chính hãng giá tốt nhất...',\r\n  },\r\n  {\r\n    key: 'seoKeywords',\r\n    label: 'SEO Keywords',\r\n    type: 'string',\r\n    required: false,\r\n    exportGroup: 'SEO & Mô tả',\r\n    exportable: true,\r\n    example: 'điện thoại, smartphone, iphone, samsung',\r\n  },\r\n  {\r\n    key: 'shortDescription',\r\n    label: 'Mô tả ngắn',\r\n    type: 'string',\r\n    required: false,\r\n    exportGroup: 'SEO & Mô tả',\r\n    exportable: true,\r\n    example: 'Danh mục điện thoại di động các hãng',\r\n  },\r\n  {\r\n    key: 'longDescription',\r\n    label: 'Mô tả chi tiết',\r\n    type: 'string',\r\n    required: false,\r\n    exportGroup: 'SEO & Mô tả',\r\n    exportable: true,\r\n    example: '<p>Điện thoại di động từ các thương hiệu...</p>',\r\n  },\r\n  \r\n  // === Settings ===\r\n  {\r\n    key: 'isActive',\r\n    label: 'Trạng thái',\r\n    type: 'boolean',\r\n    required: false,\r\n    exportGroup: 'Cài đặt',\r\n    exportable: true,\r\n    example: 'Hoạt động',\r\n    importTransform: (value) => {\r\n      if (typeof value === 'boolean') return value;\r\n      if (typeof value === 'number') return value === 1;\r\n      const strValue = String(value).toLowerCase().trim();\r\n      return strValue === 'true' || strValue === '1' || strValue === 'hoạt động' || strValue === 'hoat dong' || strValue === 'có' || strValue === 'co' || strValue === 'yes' || strValue === 'active';\r\n    },\r\n    exportTransform: (value) => value ? 'Hoạt động' : 'Ngừng'\r\n  },\r\n];\r\n\r\n// Group labels for UI organization\r\nexport const categoryFieldGroups = {\r\n  'Thông tin cơ bản': 'Thông tin cơ bản',\r\n  'Phân cấp': 'Phân cấp',\r\n  'Hiển thị': 'Hiển thị',\r\n  'SEO & Mô tả': 'SEO & Mô tả',\r\n  'Cài đặt': 'Cài đặt',\r\n} as const;\r\n\r\n// Full config object\r\nexport const categoryImportExportConfig: ImportExportConfig<ProductCategory> = {\r\n  entityType: 'categories',\r\n  entityDisplayName: 'Danh mục sản phẩm',\r\n  fields: categoryFields,\r\n  \r\n  // Template file\r\n  templateFileName: 'Mau_Nhap_Danh_Muc.xlsx',\r\n  sheetName: 'Danh mục',\r\n  \r\n  // Upsert config - dùng id làm key\r\n  upsertKey: 'id',\r\n  allowUpdate: true,\r\n  allowInsert: true,\r\n  \r\n  // Max rows\r\n  maxRows: 500,\r\n  \r\n  // Row-level transform after all field transforms\r\n  postTransformRow: (row: Partial<ProductCategory>) => {\r\n    // Ensure isActive defaults to true for new categories\r\n    if (row.isActive === undefined) {\r\n      row.isActive = true;\r\n    }\r\n    \r\n    // Default sortOrder to 0\r\n    if (row.sortOrder === undefined) {\r\n      row.sortOrder = 0;\r\n    }\r\n    \r\n    // Generate slug from name if not provided\r\n    if (!row.slug && row.name) {\r\n      row.slug = String(row.name)\r\n        .toLowerCase()\r\n        .normalize('NFD')\r\n        .replace(/[\\u0300-\\u036f]/g, '') // Remove diacritics\r\n        .replace(/đ/g, 'd')\r\n        .replace(/Đ/g, 'D')\r\n        .replace(/[^a-z0-9\\s-]/g, '')\r\n        .replace(/\\s+/g, '-')\r\n        .replace(/-+/g, '-')\r\n        .trim();\r\n    }\r\n    \r\n    return row;\r\n  },\r\n  \r\n  // Validate entire row\r\n  validateRow: (row: ProductCategory, _index: number, _existingData: ProductCategory[], _mode) => {\r\n    const errors: Array<{ field?: string; message: string }> = [];\r\n    \r\n    if (!row.id || String(row.id).trim() === '') {\r\n      errors.push({ field: 'id', message: 'Mã danh mục là bắt buộc' });\r\n    }\r\n    \r\n    if (!row.name || String(row.name).trim() === '') {\r\n      errors.push({ field: 'name', message: 'Tên danh mục là bắt buộc' });\r\n    }\r\n    \r\n    return errors;\r\n  }\r\n};\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 4983, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/lib/activity-history-helper.ts"],"sourcesContent":["/**\r\n * Activity History Helper\r\n * \r\n * Helper để tạo các entry lịch sử hoạt động một cách nhất quán\r\n * Dùng chung cho tất cả các modules trong hệ thống\r\n * \r\n * NOTE: Đã remove import useEmployeeStore để tránh circular dependency\r\n * và cải thiện compile time\r\n */\r\n\r\nimport type { HistoryEntry } from '../components/ActivityHistory';\r\nimport { getCurrentUserInfo as getAuthUserInfo } from '../contexts/auth-context';\r\nimport type { SystemId } from './id-types';\r\n\r\n// Re-export HistoryEntry type for convenience\r\nexport type { HistoryEntry } from '../components/ActivityHistory';\r\n\r\n/**\r\n * Lấy thông tin người dùng hiện tại từ auth context\r\n * NOTE: Avatar lookup từ employee store đã bị remove để tránh circular dependency\r\n */\r\nexport function getCurrentUserInfo(): { systemId: string; name: string; avatar?: string } {\r\n  const authInfo = getAuthUserInfo();\r\n  \r\n  return {\r\n    systemId: authInfo.systemId || 'SYSTEM',\r\n    name: authInfo.name || 'Hệ thống',\r\n    avatar: undefined, // Avatar will be fetched by component if needed\r\n  };\r\n}\r\n\r\n/**\r\n * Lấy thông tin nhân viên từ systemId\r\n * NOTE: This function now requires employee data to be passed in\r\n * to avoid circular dependency with employee store\r\n */\r\nexport function getEmployeeInfoFromData(\r\n  employeeSystemId: SystemId | string,\r\n  employees: Array<{ systemId: string; fullName: string; avatarUrl?: string }>\r\n): { systemId: string; name: string; avatar?: string } {\r\n  const employee = employees.find(e => e.systemId === employeeSystemId);\r\n  \r\n  if (employee) {\r\n    return {\r\n      systemId: employee.systemId,\r\n      name: employee.fullName,\r\n      avatar: employee.avatarUrl,\r\n    };\r\n  }\r\n  \r\n  // Fallback to system\r\n  return {\r\n    systemId: String(employeeSystemId) || 'SYSTEM',\r\n    name: 'Hệ thống',\r\n  };\r\n}\r\n\r\n/**\r\n * @deprecated Use getEmployeeInfoFromData instead\r\n */\r\nexport function getEmployeeInfo(employeeSystemId: SystemId | string): { systemId: string; name: string; avatar?: string } {\r\n  // Return minimal info without employee store lookup\r\n  return {\r\n    systemId: String(employeeSystemId) || 'SYSTEM',\r\n    name: 'Hệ thống',\r\n  };\r\n}\r\n\r\n/**\r\n * Tạo một history entry mới\r\n */\r\nexport function createHistoryEntry(\r\n  action: HistoryEntry['action'],\r\n  userOrDescription: { systemId: string; name: string; avatar?: string } | string,\r\n  descriptionOrMetadata?: string | HistoryEntry['metadata'],\r\n  metadata?: HistoryEntry['metadata']\r\n): HistoryEntry {\r\n  const hasUserObject = typeof userOrDescription === 'object' && userOrDescription !== null;\r\n  const user = hasUserObject ? userOrDescription : getCurrentUserInfo();\r\n  const description = (hasUserObject ? descriptionOrMetadata : userOrDescription) as string | undefined;\r\n  const meta = (hasUserObject ? metadata : descriptionOrMetadata) as HistoryEntry['metadata'] | undefined;\r\n\r\n  return {\r\n    id: `history-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,\r\n    action,\r\n    timestamp: new Date(),\r\n    user: {\r\n      systemId: user.systemId,\r\n      name: user.name,\r\n      avatar: user.avatar,\r\n    },\r\n    description: description ?? '',\r\n    metadata: meta,\r\n  };\r\n}\r\n\r\n/**\r\n * Tạo history entry cho action \"created\"\r\n */\r\nexport function createCreatedEntry(\r\n  user: { systemId: string; name: string; avatar?: string },\r\n  description: string\r\n): HistoryEntry {\r\n  return createHistoryEntry('created', user, description);\r\n}\r\n\r\n/**\r\n * Tạo history entry cho action \"updated\"\r\n */\r\nexport function createUpdatedEntry(\r\n  user: { systemId: string; name: string; avatar?: string },\r\n  description: string\r\n): HistoryEntry {\r\n  return createHistoryEntry('updated', user, description);\r\n}\r\n\r\n/**\r\n * Tạo history entry cho action \"status_changed\"\r\n */\r\nexport function createStatusChangedEntry(\r\n  user: { systemId: string; name: string; avatar?: string },\r\n  oldStatus: string,\r\n  newStatus: string,\r\n  description: string\r\n): HistoryEntry {\r\n  return createHistoryEntry(\r\n    'status_changed',\r\n    user,\r\n    description,\r\n    { field: 'status', oldValue: oldStatus, newValue: newStatus }\r\n  );\r\n}\r\n\r\n/**\r\n * Tạo history entry cho action \"deleted\"\r\n */\r\nexport function createDeletedEntry(\r\n  user: { systemId: string; name: string; avatar?: string },\r\n  description: string\r\n): HistoryEntry {\r\n  return createHistoryEntry('deleted', user, description);\r\n}\r\n\r\n/**\r\n * Tạo history entry cho action \"assigned\"\r\n */\r\nexport function createAssignedEntry(\r\n  user: { systemId: string; name: string; avatar?: string },\r\n  description: string\r\n): HistoryEntry {\r\n  return createHistoryEntry('assigned', user, description);\r\n}\r\n\r\n/**\r\n * Tạo history entry cho action \"payment_made\"\r\n */\r\nexport function createPaymentEntry(\r\n  user: { systemId: string; name: string; avatar?: string },\r\n  description: string\r\n): HistoryEntry {\r\n  return createHistoryEntry('payment_made', user, description);\r\n}\r\n\r\n/**\r\n * Tạo history entry cho action \"comment_added\"\r\n */\r\nexport function createCommentEntry(\r\n  user: { systemId: string; name: string; avatar?: string },\r\n  description: string\r\n): HistoryEntry {\r\n  return createHistoryEntry('comment_added', user, description);\r\n}\r\n\r\n/**\r\n * Tạo history entry cho action \"cancelled\"\r\n */\r\nexport function createCancelledEntry(\r\n  user: { systemId: string; name: string; avatar?: string },\r\n  description: string\r\n): HistoryEntry {\r\n  return createHistoryEntry('cancelled', user, description);\r\n}\r\n\r\n/**\r\n * Tạo history entry cho action \"verified\"\r\n */\r\nexport function createVerifiedEntry(\r\n  user: { systemId: string; name: string; avatar?: string },\r\n  description: string\r\n): HistoryEntry {\r\n  return createHistoryEntry('verified', user, description);\r\n}\r\n\r\n/**\r\n * Tạo history entry cho action \"ended\"\r\n */\r\nexport function createEndedEntry(\r\n  user: { systemId: string; name: string; avatar?: string },\r\n  description: string\r\n): HistoryEntry {\r\n  return createHistoryEntry('ended', user, description);\r\n}\r\n\r\n/**\r\n * Tạo history entry cho action \"reopened\"\r\n */\r\nexport function createReopenedEntry(\r\n  user: { systemId: string; name: string; avatar?: string },\r\n  description: string\r\n): HistoryEntry {\r\n  return createHistoryEntry('reopened', user, description);\r\n}\r\n\r\n/**\r\n * Tạo history entry cho product actions\r\n */\r\nexport function createProductEntry(\r\n  user: { systemId: string; name: string; avatar?: string },\r\n  action: 'product_added' | 'product_updated' | 'product_removed',\r\n  description: string\r\n): HistoryEntry {\r\n  return createHistoryEntry(action, user, description);\r\n}\r\n\r\n/**\r\n * Helper để append history entry vào existing array\r\n */\r\nexport function appendHistoryEntry(\r\n  existingHistory: HistoryEntry[] | undefined,\r\n  ...newEntries: HistoryEntry[]\r\n): HistoryEntry[] {\r\n  return [...(existingHistory || []), ...newEntries];\r\n}\r\n\r\n/**\r\n * Helper để tạo nhiều history entries cùng lúc\r\n */\r\nexport function createBulkUpdateEntries(\r\n  user: { systemId: string; name: string; avatar?: string },\r\n  changes: Array<{ field: string; description: string }>\r\n): HistoryEntry[] {\r\n  return changes.map(change => createHistoryEntry('updated', user, change.description));\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 5132, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/lib/import-export/configs/order.config.ts"],"sourcesContent":["/**\r\n * Order Import/Export Configuration\r\n * \r\n * Import đơn hàng với các đặc điểm:\r\n * - Multi-line: Mỗi sản phẩm 1 dòng, các dòng cùng Mã đơn sẽ được gộp thành 1 Order\r\n * - Lookup khách hàng theo Mã KH (id field)\r\n * - Lookup sản phẩm theo SKU\r\n * - Trạng thái mặc định: \"Đặt hàng\"\r\n * - Lấy địa chỉ giao hàng từ khách hàng\r\n * - Không import phí ship, chiết khấu\r\n */\r\n\r\nimport type { Order, LineItem, OrderAddress } from '@/features/orders/types';\r\nimport type { ImportExportConfig, FieldConfig } from '../types';\r\nimport { useCustomerStore } from '@/features/customers/store';\r\nimport { useProductStore } from '@/features/products/store';\r\nimport { useBranchStore } from '@/features/settings/branches/store';\r\nimport { useEmployeeStore } from '@/features/employees/store';\r\nimport { asSystemId, asBusinessId, type SystemId, type BusinessId } from '@/lib/id-types';\r\nimport type { Customer } from '@/features/customers/types';\r\n\r\n// ============================================\r\n// HELPER FUNCTIONS\r\n// ============================================\r\n\r\n/**\r\n * Lookup khách hàng theo Mã KH (id field)\r\n */\r\nconst findCustomerById = (customerId: string): Customer | undefined => {\r\n  if (!customerId) return undefined;\r\n  const customers = useCustomerStore.getState().data;\r\n  const normalizedId = String(customerId).trim().toUpperCase();\r\n  \r\n  return customers.find(c => \r\n    c.id.toUpperCase() === normalizedId ||\r\n    c.systemId.toUpperCase() === normalizedId\r\n  );\r\n};\r\n\r\n/**\r\n * Lookup sản phẩm theo SKU\r\n */\r\nconst findProductBySku = (sku: string) => {\r\n  if (!sku) return undefined;\r\n  const products = useProductStore.getState().data;\r\n  const normalizedSku = String(sku).trim().toUpperCase();\r\n  \r\n  return products.find(p => \r\n    p.id.toUpperCase() === normalizedSku ||\r\n    p.sku?.toUpperCase() === normalizedSku ||\r\n    p.systemId.toUpperCase() === normalizedSku\r\n  );\r\n};\r\n\r\n/**\r\n * Lookup chi nhánh theo tên hoặc mã\r\n */\r\nconst findBranch = (branchIdOrName: string) => {\r\n  if (!branchIdOrName) return undefined;\r\n  const branches = useBranchStore.getState().data;\r\n  const normalized = String(branchIdOrName).trim().toLowerCase();\r\n  \r\n  return branches.find(b => \r\n    b.id.toLowerCase() === normalized ||\r\n    b.name.toLowerCase() === normalized ||\r\n    b.systemId.toLowerCase() === normalized\r\n  );\r\n};\r\n\r\n/**\r\n * Lookup nhân viên theo tên hoặc mã\r\n */\r\nconst findEmployee = (employeeIdOrName: string) => {\r\n  if (!employeeIdOrName) return undefined;\r\n  const employees = useEmployeeStore.getState().data;\r\n  const normalized = String(employeeIdOrName).trim().toLowerCase();\r\n  \r\n  return employees.find(e => \r\n    e.id.toLowerCase() === normalized ||\r\n    e.fullName.toLowerCase() === normalized ||\r\n    e.systemId.toLowerCase() === normalized\r\n  );\r\n};\r\n\r\n/**\r\n * Get default branch\r\n */\r\nconst getDefaultBranch = () => {\r\n  const branches = useBranchStore.getState().data;\r\n  return branches.find(b => b.isDefault) || branches[0];\r\n};\r\n\r\n/**\r\n * Get default shipping address from customer\r\n */\r\nconst getCustomerShippingAddress = (customer: Customer): OrderAddress | undefined => {\r\n  if (!customer) return undefined;\r\n  \r\n  // Tìm địa chỉ mặc định hoặc địa chỉ đầu tiên\r\n  const defaultAddr = customer.addresses?.find(a => a.isDefault || a.isDefaultShipping) || customer.addresses?.[0];\r\n  \r\n  if (defaultAddr) {\r\n    const formattedAddress = [defaultAddr.street, defaultAddr.ward, defaultAddr.district, defaultAddr.province]\r\n      .filter(Boolean)\r\n      .join(', ');\r\n    return {\r\n      street: defaultAddr.street,\r\n      ward: defaultAddr.ward,\r\n      district: defaultAddr.district,\r\n      province: defaultAddr.province,\r\n      contactName: customer.name,\r\n      phone: customer.phone,\r\n      formattedAddress,\r\n    };\r\n  }\r\n  \r\n  return undefined;\r\n};\r\n\r\n// ============================================\r\n// INTERMEDIATE TYPE FOR IMPORT\r\n// ============================================\r\n\r\n/**\r\n * Type cho row nhập từ Excel (flat structure - 1 dòng = 1 sản phẩm)\r\n * \r\n * FORMAT EXCEL MẪU:\r\n * ┌──────────┬────────┬───────────┬────────────┬────────┬──────────┬─────────┐\r\n * │ Mã đơn(*) │ Mã KH(*) │ Chi nhánh │ Nhân viên  │ SKU(*) │ Số lượng │ Đơn giá │\r\n * ├──────────┼────────┼───────────┼────────────┼────────┼──────────┼─────────┤\r\n * │ DH001    │ KH001  │ CN-A      │ Nguyễn A   │ SP001  │ 2        │ 100000  │ ← Đơn 1, SP 1\r\n * │          │        │           │            │ SP002  │ 1        │ 200000  │ ← Đơn 1, SP 2 (kế thừa mã đơn + KH)\r\n * │ DH002    │ KH002  │ CN-B      │ Trần B     │ SP003  │ 3        │ 150000  │ ← Đơn 2, SP 1\r\n * │          │        │           │            │ SP004  │ 1        │ 300000  │ ← Đơn 2, SP 2\r\n * └──────────┴────────┴───────────┴────────────┴────────┴──────────┴─────────┘\r\n * \r\n * LOGIC:\r\n * - Mã đơn (*): BẮT BUỘC điền ở dòng đầu của mỗi đơn hàng\r\n * - Mã KH (*): BẮT BUỘC điền ở dòng đầu của mỗi đơn hàng  \r\n * - Các dòng SP sau: để trống Mã đơn + Mã KH → tự kế thừa từ dòng trên\r\n * - Chi nhánh, Nhân viên: Tùy chọn, để trống sẽ dùng mặc định\r\n */\r\nexport interface OrderImportRow {\r\n  orderId: string;              // Mã đơn hàng (DH001) - có thể để trống nếu muốn auto-gen\r\n  customerId: string;           // Mã khách hàng - chỉ cần điền ở dòng đầu mỗi đơn\r\n  branchName?: string;          // Chi nhánh (tên hoặc mã)\r\n  salespersonName?: string;     // Nhân viên bán (tên hoặc mã)\r\n  productSku: string;           // SKU sản phẩm\r\n  quantity: number;             // Số lượng\r\n  unitPrice?: number;           // Đơn giá (nếu không có thì lấy từ SP)\r\n  lineNote?: string;            // Ghi chú dòng sản phẩm\r\n  orderNote?: string;           // Ghi chú đơn hàng\r\n  orderDate?: string;           // Ngày đặt hàng\r\n  source?: string;              // Nguồn đơn\r\n  tags?: string;                // Tags (comma separated)\r\n}\r\n\r\n// ============================================\r\n// FIELD CONFIGURATION\r\n// ============================================\r\n\r\nexport const orderFields: FieldConfig<OrderImportRow>[] = [\r\n  // ===== Thông tin đơn hàng =====\r\n  {\r\n    key: 'orderId',\r\n    label: 'Mã đơn hàng (*)',\r\n    type: 'string',\r\n    required: true,  // Bắt buộc điền ở dòng đầu, các dòng SP sau có thể để trống\r\n    example: 'DH001',\r\n    group: 'Đơn hàng',\r\n    defaultSelected: true,\r\n    // preProcessRows sẽ fill-down cho các dòng SP sau\r\n  },\r\n  {\r\n    key: 'customerId',\r\n    label: 'Mã khách hàng (*)',\r\n    type: 'string',\r\n    required: true,  // Bắt buộc điền ở dòng đầu, các dòng SP sau có thể để trống\r\n    example: 'KH001',\r\n    group: 'Đơn hàng',\r\n    defaultSelected: true,\r\n    // preProcessRows sẽ fill-down cho các dòng SP sau\r\n  },\r\n  {\r\n    key: 'branchName',\r\n    label: 'Chi nhánh',\r\n    type: 'string',\r\n    required: false,\r\n    example: 'Chi nhánh Hà Nội',\r\n    group: 'Đơn hàng',\r\n    defaultSelected: true,\r\n    validator: (value) => {\r\n      if (value && String(value).trim() !== '') {\r\n        const branch = findBranch(String(value));\r\n        if (!branch) {\r\n          return `Không tìm thấy chi nhánh \"${value}\"`;\r\n        }\r\n      }\r\n      return true;\r\n    },\r\n  },\r\n  {\r\n    key: 'salespersonName',\r\n    label: 'Nhân viên bán hàng',\r\n    type: 'string',\r\n    required: false,\r\n    example: 'Nguyễn Văn A',\r\n    group: 'Đơn hàng',\r\n    defaultSelected: true,\r\n    validator: (value) => {\r\n      if (value && String(value).trim() !== '') {\r\n        const employee = findEmployee(String(value));\r\n        if (!employee) {\r\n          return `Không tìm thấy nhân viên \"${value}\"`;\r\n        }\r\n      }\r\n      return true;\r\n    },\r\n  },\r\n  {\r\n    key: 'orderDate',\r\n    label: 'Ngày đặt hàng',\r\n    type: 'date',\r\n    required: false,\r\n    example: '19/12/2024',\r\n    group: 'Đơn hàng',\r\n    defaultSelected: true,\r\n  },\r\n  {\r\n    key: 'source',\r\n    label: 'Nguồn đơn',\r\n    type: 'string',\r\n    required: false,\r\n    example: 'Website',\r\n    group: 'Đơn hàng',\r\n    defaultSelected: false,\r\n  },\r\n  {\r\n    key: 'tags',\r\n    label: 'Tags',\r\n    type: 'string',\r\n    required: false,\r\n    example: 'VIP, Gấp',\r\n    group: 'Đơn hàng',\r\n    defaultSelected: false,\r\n  },\r\n  {\r\n    key: 'orderNote',\r\n    label: 'Ghi chú đơn hàng',\r\n    type: 'string',\r\n    required: false,\r\n    example: 'Giao buổi sáng',\r\n    group: 'Đơn hàng',\r\n    defaultSelected: true,\r\n  },\r\n\r\n  // ===== Thông tin sản phẩm =====\r\n  {\r\n    key: 'productSku',\r\n    label: 'SKU sản phẩm (*)',\r\n    type: 'string',\r\n    required: true,\r\n    example: 'SP001',\r\n    group: 'Sản phẩm',\r\n    defaultSelected: true,\r\n    validator: (value) => {\r\n      if (!value || String(value).trim() === '') {\r\n        return 'SKU sản phẩm không được để trống';\r\n      }\r\n      const product = findProductBySku(String(value));\r\n      if (!product) {\r\n        return `Không tìm thấy sản phẩm với SKU \"${value}\"`;\r\n      }\r\n      return true;\r\n    },\r\n  },\r\n  {\r\n    key: 'quantity',\r\n    label: 'Số lượng (*)',\r\n    type: 'number',\r\n    required: true,\r\n    example: '2',\r\n    group: 'Sản phẩm',\r\n    defaultSelected: true,\r\n    validator: (value) => {\r\n      const qty = Number(value);\r\n      if (isNaN(qty) || qty <= 0) {\r\n        return 'Số lượng phải là số dương';\r\n      }\r\n      return true;\r\n    },\r\n    importTransform: (value) => {\r\n      const num = Number(value);\r\n      return isNaN(num) ? 1 : Math.max(1, Math.floor(num));\r\n    },\r\n  },\r\n  {\r\n    key: 'unitPrice',\r\n    label: 'Đơn giá',\r\n    type: 'number',\r\n    required: false,\r\n    example: '150000',\r\n    group: 'Sản phẩm',\r\n    defaultSelected: true,\r\n    importTransform: (value) => {\r\n      if (value === undefined || value === null || value === '') return undefined;\r\n      const num = Number(value);\r\n      return isNaN(num) ? undefined : Math.max(0, num);\r\n    },\r\n  },\r\n  {\r\n    key: 'lineNote',\r\n    label: 'Ghi chú SP',\r\n    type: 'string',\r\n    required: false,\r\n    example: 'Màu đỏ',\r\n    group: 'Sản phẩm',\r\n    defaultSelected: false,\r\n  },\r\n];\r\n\r\n// ============================================\r\n// FIELD GROUPS FOR EXPORT\r\n// ============================================\r\n\r\nexport const orderFieldGroups = [\r\n  {\r\n    id: 'order-info',\r\n    label: 'Thông tin đơn hàng',\r\n    columns: [\r\n      { key: 'id', label: 'Mã đơn hàng', defaultSelected: true },\r\n      { key: 'orderDate', label: 'Ngày đặt', defaultSelected: true },\r\n      { key: 'status', label: 'Trạng thái', defaultSelected: true },\r\n      { key: 'source', label: 'Nguồn đơn', defaultSelected: false },\r\n      { key: 'tags', label: 'Tags', defaultSelected: false },\r\n      { key: 'notes', label: 'Ghi chú', defaultSelected: false },\r\n    ],\r\n  },\r\n  {\r\n    id: 'customer-info',\r\n    label: 'Thông tin khách hàng',\r\n    columns: [\r\n      { key: 'customerId', label: 'Mã KH', defaultSelected: true },\r\n      { key: 'customerName', label: 'Tên khách hàng', defaultSelected: true },\r\n      { key: 'customerPhone', label: 'SĐT khách', defaultSelected: true },\r\n      { key: 'shippingAddress', label: 'Địa chỉ giao', defaultSelected: true },\r\n    ],\r\n  },\r\n  {\r\n    id: 'product-info',\r\n    label: 'Thông tin sản phẩm',\r\n    columns: [\r\n      { key: 'productSku', label: 'SKU', defaultSelected: true },\r\n      { key: 'productName', label: 'Tên sản phẩm', defaultSelected: true },\r\n      { key: 'quantity', label: 'Số lượng', defaultSelected: true },\r\n      { key: 'unitPrice', label: 'Đơn giá', defaultSelected: true },\r\n      { key: 'lineTotal', label: 'Thành tiền', defaultSelected: true },\r\n      { key: 'lineNote', label: 'Ghi chú SP', defaultSelected: false },\r\n    ],\r\n  },\r\n  {\r\n    id: 'payment-info',\r\n    label: 'Thanh toán',\r\n    columns: [\r\n      { key: 'subtotal', label: 'Tạm tính', defaultSelected: true },\r\n      { key: 'shippingFee', label: 'Phí ship', defaultSelected: false },\r\n      { key: 'orderDiscount', label: 'Chiết khấu', defaultSelected: false },\r\n      { key: 'grandTotal', label: 'Tổng tiền', defaultSelected: true },\r\n      { key: 'paidAmount', label: 'Đã thanh toán', defaultSelected: true },\r\n      { key: 'paymentStatus', label: 'Trạng thái TT', defaultSelected: true },\r\n    ],\r\n  },\r\n  {\r\n    id: 'delivery-info',\r\n    label: 'Vận chuyển',\r\n    columns: [\r\n      { key: 'deliveryMethod', label: 'Phương thức giao', defaultSelected: true },\r\n      { key: 'deliveryStatus', label: 'Trạng thái giao', defaultSelected: true },\r\n      { key: 'trackingCode', label: 'Mã vận đơn', defaultSelected: false },\r\n      { key: 'carrier', label: 'ĐVVC', defaultSelected: false },\r\n    ],\r\n  },\r\n  {\r\n    id: 'branch-staff',\r\n    label: 'Chi nhánh & Nhân viên',\r\n    columns: [\r\n      { key: 'branchName', label: 'Chi nhánh', defaultSelected: true },\r\n      { key: 'salesperson', label: 'Nhân viên bán', defaultSelected: true },\r\n    ],\r\n  },\r\n];\r\n\r\n// ============================================\r\n// MAIN CONFIG\r\n// ============================================\r\n\r\nexport const orderImportExportConfig: ImportExportConfig<Order> = {\r\n  entityType: 'orders',\r\n  entityDisplayName: 'Đơn hàng',\r\n  \r\n  fields: orderFields as unknown as FieldConfig<Order>[],\r\n  \r\n  templateFileName: 'Mau_Nhap_Don_Hang.xlsx',\r\n  sheetName: 'Đơn hàng',\r\n  \r\n  // Import settings\r\n  upsertKey: 'id',\r\n  allowUpdate: false,  // Chỉ cho phép thêm mới, không update đơn hàng qua import\r\n  allowInsert: true,\r\n  \r\n  requirePreview: true,\r\n  maxRows: 1000,\r\n  maxErrorsAllowed: 0,  // Không cho phép lỗi\r\n  \r\n  // Pre-process: Fill empty orderId/customerId from previous row\r\n  // User must fill orderId + customerId on first row of each order\r\n  // Subsequent product rows can leave them empty → will inherit from previous row\r\n  preProcessRows: (rows: unknown[]) => {\r\n    const importRows = rows as OrderImportRow[];\r\n    let currentOrderId = '';\r\n    let currentCustomerId = '';\r\n    \r\n    for (const row of importRows) {\r\n      // If orderId is provided, use it and update current\r\n      if (row.orderId?.trim()) {\r\n        currentOrderId = row.orderId.trim();\r\n        // Also update customerId if provided on the same row\r\n        if (row.customerId?.trim()) {\r\n          currentCustomerId = row.customerId.trim();\r\n        }\r\n      } else if (currentOrderId) {\r\n        // Fill from previous row's orderId (for subsequent product lines)\r\n        row.orderId = currentOrderId;\r\n      }\r\n      // Note: if orderId is empty and no previous orderId → validation will catch it\r\n      \r\n      // Fill customerId if empty (inherit from previous row)\r\n      if (!row.customerId?.trim() && currentCustomerId) {\r\n        row.customerId = currentCustomerId;\r\n      } else if (row.customerId?.trim()) {\r\n        currentCustomerId = row.customerId.trim();\r\n      }\r\n    }\r\n    \r\n    return importRows;\r\n  },\r\n  \r\n  // Validate row (after pre-processing)\r\n  validateRow: (row, _index, existingData, mode) => {\r\n    const errors: Array<{ field?: string; message: string }> = [];\r\n    const importRow = row as unknown as OrderImportRow;\r\n    \r\n    // Check required fields - orderId must be filled on first row of each order\r\n    if (!importRow.orderId) {\r\n      errors.push({ field: 'orderId', message: 'Mã đơn hàng không được để trống (bắt buộc điền ở dòng đầu của mỗi đơn)' });\r\n    }\r\n    if (!importRow.customerId) {\r\n      errors.push({ field: 'customerId', message: 'Mã khách hàng không được để trống (điền ở dòng đầu của mỗi đơn)' });\r\n    }\r\n    if (!importRow.productSku) {\r\n      errors.push({ field: 'productSku', message: 'SKU sản phẩm không được để trống' });\r\n    }\r\n    \r\n    // Validate customer\r\n    if (importRow.customerId) {\r\n      const customer = findCustomerById(importRow.customerId);\r\n      if (!customer) {\r\n        errors.push({ field: 'customerId', message: `Không tìm thấy khách hàng \"${importRow.customerId}\"` });\r\n      }\r\n    }\r\n    \r\n    // Validate product\r\n    if (importRow.productSku) {\r\n      const product = findProductBySku(importRow.productSku);\r\n      if (!product) {\r\n        errors.push({ field: 'productSku', message: `Không tìm thấy sản phẩm \"${importRow.productSku}\"` });\r\n      }\r\n    }\r\n    \r\n    // Validate branch if provided\r\n    if (importRow.branchName) {\r\n      const branch = findBranch(importRow.branchName);\r\n      if (!branch) {\r\n        errors.push({ field: 'branchName', message: `Không tìm thấy chi nhánh \"${importRow.branchName}\"` });\r\n      }\r\n    }\r\n    \r\n    // Validate salesperson if provided\r\n    if (importRow.salespersonName) {\r\n      const employee = findEmployee(importRow.salespersonName);\r\n      if (!employee) {\r\n        errors.push({ field: 'salespersonName', message: `Không tìm thấy nhân viên \"${importRow.salespersonName}\"` });\r\n      }\r\n    }\r\n    \r\n    // Validate quantity\r\n    if (importRow.quantity !== undefined) {\r\n      const qty = Number(importRow.quantity);\r\n      if (isNaN(qty) || qty <= 0) {\r\n        errors.push({ field: 'quantity', message: 'Số lượng phải là số dương' });\r\n      }\r\n    }\r\n    \r\n    // Check duplicate order ID in existing data (only in insert-only mode)\r\n    if (mode === 'insert-only' && importRow.orderId) {\r\n      const duplicate = existingData.find(o => \r\n        o.id.toUpperCase() === importRow.orderId.toUpperCase()\r\n      );\r\n      if (duplicate) {\r\n        errors.push({ field: 'orderId', message: `Mã đơn hàng \"${importRow.orderId}\" đã tồn tại` });\r\n      }\r\n    }\r\n    \r\n    return errors;\r\n  },\r\n  \r\n  // Transform: Group rows by orderId and build Order objects\r\n  // This is handled in postTransformRow and beforeImport\r\n  beforeImport: async (data: Order[]) => {\r\n    // data here is actually OrderImportRow[] after field transforms\r\n    const importRows = data as unknown as OrderImportRow[];\r\n    \r\n    // Group rows by orderId\r\n    const orderMap = new Map<string, {\r\n      rows: OrderImportRow[];\r\n      customer?: Customer;\r\n      branch?: ReturnType<typeof findBranch>;\r\n      employee?: ReturnType<typeof findEmployee>;\r\n    }>();\r\n    \r\n    for (const row of importRows) {\r\n      const orderId = row.orderId?.trim().toUpperCase();\r\n      if (!orderId) continue;\r\n      \r\n      if (!orderMap.has(orderId)) {\r\n        const customer = findCustomerById(row.customerId);\r\n        const branch = row.branchName ? findBranch(row.branchName) : getDefaultBranch();\r\n        const employee = row.salespersonName ? findEmployee(row.salespersonName) : undefined;\r\n        \r\n        orderMap.set(orderId, {\r\n          rows: [],\r\n          customer,\r\n          branch,\r\n          employee,\r\n        });\r\n      }\r\n      orderMap.get(orderId)!.rows.push(row);\r\n    }\r\n    \r\n    // Build Order objects\r\n    const orders: Order[] = [];\r\n    const now = new Date().toISOString();\r\n    \r\n    for (const [orderId, { rows, customer, branch, employee }] of orderMap.entries()) {\r\n      if (!customer || rows.length === 0) continue;\r\n      \r\n      // Build line items\r\n      const lineItems: LineItem[] = [];\r\n      for (const row of rows) {\r\n        const product = findProductBySku(row.productSku);\r\n        if (!product) continue;\r\n        \r\n        const quantity = Math.max(1, Math.floor(Number(row.quantity) || 1));\r\n        const unitPrice = row.unitPrice ?? product.sellingPrice ?? product.costPrice ?? 0;\r\n        \r\n        lineItems.push({\r\n          productSystemId: product.systemId,\r\n          productId: product.id,\r\n          productName: product.name,\r\n          quantity,\r\n          unitPrice,\r\n          discount: 0,\r\n          discountType: 'fixed',\r\n          note: row.lineNote,\r\n        });\r\n      }\r\n      \r\n      if (lineItems.length === 0) continue;\r\n      \r\n      // Calculate totals\r\n      const subtotal = lineItems.reduce((sum, item) => {\r\n        return sum + (item.unitPrice * item.quantity);\r\n      }, 0);\r\n      \r\n      // Get first row for order-level data\r\n      const firstRow = rows[0];\r\n      \r\n      // Parse order date\r\n      let orderDate = now;\r\n      if (firstRow.orderDate) {\r\n        const parsed = new Date(firstRow.orderDate);\r\n        if (!isNaN(parsed.getTime())) {\r\n          orderDate = parsed.toISOString();\r\n        }\r\n      }\r\n      \r\n      // Build shipping address from customer\r\n      const shippingAddress = getCustomerShippingAddress(customer);\r\n      \r\n      // Parse tags\r\n      const tags = firstRow.tags \r\n        ? firstRow.tags.split(',').map(t => t.trim()).filter(Boolean)\r\n        : undefined;\r\n      \r\n      const order: Order = {\r\n        systemId: asSystemId(''), // Will be assigned by store\r\n        id: asBusinessId(orderId),\r\n        customerSystemId: customer.systemId,\r\n        customerName: customer.name,\r\n        branchSystemId: branch?.systemId || asSystemId(''),\r\n        branchName: branch?.name || '',\r\n        salespersonSystemId: employee?.systemId || asSystemId(''),\r\n        salesperson: employee?.fullName || '',\r\n        orderDate,\r\n        \r\n        // Statuses - all new orders start with \"Đặt hàng\"\r\n        status: 'Đặt hàng',\r\n        paymentStatus: 'Chưa thanh toán',\r\n        deliveryStatus: 'Chờ đóng gói',\r\n        printStatus: 'Chưa in',\r\n        stockOutStatus: 'Chưa xuất kho',\r\n        returnStatus: 'Chưa trả hàng',\r\n        deliveryMethod: 'Dịch vụ giao hàng',\r\n        \r\n        // Address\r\n        shippingAddress,\r\n        \r\n        // Line items\r\n        lineItems,\r\n        \r\n        // Totals (no discount, no shipping fee from import)\r\n        subtotal,\r\n        shippingFee: 0,\r\n        tax: 0,\r\n        grandTotal: subtotal,\r\n        paidAmount: 0,\r\n        codAmount: 0,\r\n        \r\n        // Arrays\r\n        payments: [],\r\n        packagings: [],\r\n        \r\n        // Optional fields\r\n        notes: firstRow.orderNote,\r\n        source: firstRow.source,\r\n        tags,\r\n        \r\n        // Timestamps\r\n        createdAt: now,\r\n        updatedAt: now,\r\n      };\r\n      \r\n      orders.push(order);\r\n    }\r\n    \r\n    return orders;\r\n  },\r\n};\r\n\r\n// ============================================\r\n// EXPORT HELPERS\r\n// ============================================\r\n\r\n/**\r\n * Flatten orders to rows for export (1 row per line item)\r\n */\r\nexport function flattenOrdersForExport(orders: Order[]): Array<Record<string, unknown>> {\r\n  const rows: Array<Record<string, unknown>> = [];\r\n  \r\n  for (const order of orders) {\r\n    // Get customer info\r\n    const customer = useCustomerStore.getState().findById(order.customerSystemId);\r\n    \r\n    // Get latest packaging for tracking info\r\n    const latestPackaging = order.packagings?.[order.packagings.length - 1];\r\n    \r\n    for (const item of order.lineItems) {\r\n      rows.push({\r\n        // Order info\r\n        id: order.id,\r\n        orderDate: order.orderDate,\r\n        status: order.status,\r\n        source: order.source || '',\r\n        tags: order.tags?.join(', ') || '',\r\n        notes: order.notes || '',\r\n        \r\n        // Customer info\r\n        customerId: customer?.id || '',\r\n        customerName: order.customerName,\r\n        customerPhone: customer?.phone || '',\r\n        shippingAddress: typeof order.shippingAddress === 'string' \r\n          ? order.shippingAddress \r\n          : (order.shippingAddress as OrderAddress)?.formattedAddress || '',\r\n        \r\n        // Product info\r\n        productSku: item.productId,\r\n        productName: item.productName,\r\n        quantity: item.quantity,\r\n        unitPrice: item.unitPrice,\r\n        lineTotal: item.unitPrice * item.quantity,\r\n        lineNote: item.note || '',\r\n        \r\n        // Payment info\r\n        subtotal: order.subtotal,\r\n        shippingFee: order.shippingFee,\r\n        orderDiscount: order.orderDiscount || 0,\r\n        grandTotal: order.grandTotal,\r\n        paidAmount: order.paidAmount,\r\n        paymentStatus: order.paymentStatus,\r\n        \r\n        // Delivery info\r\n        deliveryMethod: order.deliveryMethod,\r\n        deliveryStatus: order.deliveryStatus,\r\n        trackingCode: latestPackaging?.trackingCode || '',\r\n        carrier: latestPackaging?.carrier || '',\r\n        \r\n        // Branch & Staff\r\n        branchName: order.branchName,\r\n        salesperson: order.salesperson,\r\n      });\r\n    }\r\n  }\r\n  \r\n  return rows;\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 5851, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/lib/import-export/configs/index.ts"],"sourcesContent":["/**\r\n * Import/Export Configs - Index\r\n * \r\n * Re-export tất cả configs\r\n */\r\n\r\nexport { employeeImportExportConfig, employeeFields } from './employee.config';\r\nexport { attendanceImportExportConfig, attendanceFields } from './attendance.config';\r\nexport { customerImportExportConfig, customerFields } from './customer.config';\r\nexport { productImportExportConfig, productFields } from './product.config';\r\nexport { brandImportExportConfig, brandFields, brandFieldGroups } from './brand.config';\r\nexport { categoryImportExportConfig, categoryFields, categoryFieldGroups } from './category.config';\r\nexport { orderImportExportConfig, orderFields, orderFieldGroups, flattenOrdersForExport } from './order.config';\r\n\r\n// Types re-export for convenience\r\nexport type { ImportExportConfig, FieldConfig } from '../types';\r\n"],"names":[],"mappings":";AAAA;;;;CAIC,GAED;AACA;AACA;AACA;AACA;AACA;AACA"}},
    {"offset": {"line": 5874, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/lib/import-export/index.ts"],"sourcesContent":["/**\r\n * Import/Export System - Main Exports\r\n */\r\n\r\n// Types\r\nexport type {\r\n  ImportLogEntry,\r\n  ExportLogEntry,\r\n  FieldConfig,\r\n  ImportExportConfig,\r\n  ImportResult,\r\n  ExportResult,\r\n  ImportPreviewRow,\r\n  ImportPreviewResult,\r\n  ImportPreviewStatus,\r\n  EmployeeMappingEntry,\r\n  AttendanceImportRow,\r\n  AttendanceSummary,\r\n} from './types';\r\n\r\n// Store\r\nexport {\r\n  useImportExportStore,\r\n  selectImportLogs,\r\n  selectExportLogs,\r\n  selectImportLogsByEntity,\r\n  selectExportLogsByEntity,\r\n} from './import-export-store';\r\n\r\n// Employee Mapping Store\r\nexport {\r\n  useEmployeeMappingStore,\r\n  saveMappingsFromAutoMap,\r\n} from './employee-mapping-store';\r\n\r\n// Utils\r\nexport {\r\n  previewImportData,\r\n  validateField,\r\n  transformImportRow,\r\n  transformExportRow,\r\n  checkUniqueFields,\r\n  generateExportFileName,\r\n  formatFileSize,\r\n} from './utils';\r\n\r\n// Attendance Parser\r\nexport {\r\n  parseAttendanceFile,\r\n  parseWorkDays,\r\n  getAvailableSheets,\r\n  previewSheet,\r\n} from './attendance-parser';\r\nexport type { AttendanceParseResult } from './attendance-parser';\r\n\r\n// Configs\r\nexport {\r\n  employeeImportExportConfig,\r\n  employeeFields,\r\n  attendanceImportExportConfig,\r\n  attendanceFields,\r\n} from './configs';\r\n"],"names":[],"mappings":"AAAA;;CAEC,GAED,QAAQ;;AAgBR,QAAQ;AACR;AAQA,yBAAyB;AACzB;AAKA,QAAQ;AACR;AAUA,oBAAoB;AACpB;AAQA,UAAU;AACV"}},
    {"offset": {"line": 5897, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/lib/api-config.ts"],"sourcesContent":["/**\r\n * API Configuration Utilities\r\n * \r\n * Centralized configuration for API endpoints.\r\n * All API URLs should use these utilities instead of hardcoding.\r\n */\r\n\r\n/**\r\n * Get the API base URL from environment variables\r\n * Falls back to localhost:3001 for development\r\n */\r\nexport function getApiBaseUrl(): string {\r\n  // Use relative path to leverage Vite proxy in development\r\n  // This avoids CORS issues when frontend (5173) talks to backend (3001)\r\n  if ((import.meta as any).env?.DEV) {\r\n    return '/api';\r\n  }\r\n  return (import.meta as any).env?.VITE_API_BASE_URL || 'http://localhost:3001/api';\r\n}\r\n\r\n/**\r\n * Get the base URL without /api suffix\r\n * Falls back to localhost:3001 for development\r\n */\r\nexport function getBaseUrl(): string {\r\n  const apiUrl = getApiBaseUrl();\r\n  return apiUrl.replace('/api', '');\r\n}\r\n\r\n/**\r\n * Build a full file URL from a relative path\r\n * @param relativePath - Relative file path (e.g., \"/uploads/documents/file.pdf\")\r\n * @returns Full URL to the file\r\n */\r\nexport function getFileUrl(relativePath: string): string {\r\n  if (!relativePath) return '';\r\n  \r\n  // If already a full URL, return as is\r\n  if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {\r\n    return relativePath;\r\n  }\r\n  \r\n  // Build full URL\r\n  const baseUrl = getBaseUrl();\r\n  return `${baseUrl}${relativePath}`;\r\n}\r\n\r\n/**\r\n * Build an API endpoint URL\r\n * @param endpoint - API endpoint path (e.g., \"/employees/documents\")\r\n * @returns Full API URL\r\n */\r\nexport function getApiUrl(endpoint: string): string {\r\n  const apiBaseUrl = getApiBaseUrl();\r\n  return `${apiBaseUrl}${endpoint}`;\r\n}\r\n"],"names":[],"mappings":"AAAA;;;;;CAKC,GAED;;;CAGC;;;;;;;;;;;;;;;AACM,SAAS;IACd,0DAA0D;IAC1D,uEAAuE;IACvE,IAAI,8BAAqB,GAAG,EAAE,KAAK;QACjC,OAAO;IACT;IACA,OAAO,8BAAqB,GAAG,EAAE,qBAAqB;AACxD;AAMO,SAAS;IACd,MAAM,SAAS;IACf,OAAO,OAAO,OAAO,CAAC,QAAQ;AAChC;AAOO,SAAS,WAAW,YAAoB;IAC7C,IAAI,CAAC,cAAc,OAAO;IAE1B,sCAAsC;IACtC,IAAI,aAAa,UAAU,CAAC,cAAc,aAAa,UAAU,CAAC,aAAa;QAC7E,OAAO;IACT;IAEA,iBAAiB;IACjB,MAAM,UAAU;IAChB,OAAO,GAAG,UAAU,cAAc;AACpC;AAOO,SAAS,UAAU,QAAgB;IACxC,MAAM,aAAa;IACnB,OAAO,GAAG,aAAa,UAAU;AACnC"}},
    {"offset": {"line": 5950, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/lib/file-upload-api.ts"],"sourcesContent":["// API client để giao tiếp với server - Staging System\r\nimport { getApiBaseUrl } from './api-config';\r\n\r\nconst API_BASE_URL = getApiBaseUrl();\r\n\r\nexport type StagingFile = {\r\n  id: string;\r\n  sessionId: string;\r\n  name: string; // Display name (smart filename với metadata)\r\n  originalName: string; // Tên file gốc\r\n  slug: string; // URL-safe slug\r\n  filename: string; // Tên file hệ thống (UUID) - cần cho preview URL\r\n  size: number;\r\n  type: string;\r\n  url: string;\r\n  status: 'staging' | 'permanent'; // ✅ Support both staging and permanent files\r\n  uploadedAt: string;\r\n  metadata: string; // Smart filename metadata\r\n};\r\n\r\nexport type ServerFile = {\r\n  id: string;\r\n  employeeId: string;\r\n  documentType: string;\r\n  documentName: string;\r\n  name: string; // Display name\r\n  originalName: string; // Tên file gốc\r\n  slug: string; // URL-safe slug\r\n  filename: string; // Tên file hệ thống\r\n  size: number;\r\n  type: string;\r\n  url: string;\r\n  uploadedAt: string;\r\n  confirmedAt?: string;\r\n  metadata: string; // Smart filename metadata\r\n};\r\n\r\nexport type UploadedAsset = {\r\n  id: string;\r\n  name: string;\r\n  size: number;\r\n  type: string;\r\n  url: string;\r\n  uploadedAt: string;\r\n};\r\n\r\nexport type UploadedFile = {\r\n  id: string;\r\n  name: string;\r\n  filename?: string;\r\n  type: string;\r\n  size: number;\r\n  url: string;\r\n  uploadedAt?: string;\r\n  metadata?: Record<string, unknown>;\r\n};\r\n\r\nexport class FileUploadAPI {\r\n  // Upload files vào staging (tạm thời)\r\n  static async uploadToStaging(files: File[], sessionId?: string): Promise<{\r\n    files: StagingFile[];\r\n    sessionId: string;\r\n  }> {\r\n    const formData = new FormData();\r\n    \r\n    files.forEach(file => {\r\n      formData.append('files', file);\r\n    });\r\n\r\n    // CRITICAL FIX: sessionId in FormData doesn't work with multer\r\n    // Send via query params instead\r\n    const url = sessionId \r\n      ? `${API_BASE_URL}/staging/upload?sessionId=${encodeURIComponent(sessionId)}`\r\n      : `${API_BASE_URL}/staging/upload`;\r\n\r\n    console.log('📤 Uploading to:', url);\r\n    console.log('📦 Files:', files.map(f => `${f.name} (${(f.size / 1024).toFixed(1)}KB)`));\r\n\r\n    let response;\r\n    try {\r\n      response = await fetch(url, {\r\n        method: 'POST',\r\n        body: formData,\r\n      });\r\n    } catch (fetchError) {\r\n      console.error('❌ Network fetch failed:', fetchError);\r\n      throw new Error(`Không thể kết nối đến server (${API_BASE_URL}). Vui lòng kiểm tra server có đang chạy.`);\r\n    }\r\n\r\n    if (!response.ok) {\r\n      const errorText = await response.text();\r\n      console.error('❌ Server error:', response.status, errorText);\r\n      throw new Error(`Server error (${response.status}): ${errorText}`);\r\n    }\r\n\r\n    const result = await response.json();\r\n    \r\n    if (!result.success) {\r\n      throw new Error(result.message || 'Staging upload failed');\r\n    }\r\n\r\n    return {\r\n      files: result.files,\r\n      sessionId: result.sessionId\r\n    };\r\n  }\r\n\r\n  // Confirm staging files → permanent với smart filename\r\n  // NOTE: entitySystemId MUST be immutable (systemId) to avoid broken references\r\n  static async confirmStagingFiles(\r\n    sessionId: string,\r\n    entitySystemId: string,\r\n    documentType: string,\r\n    documentName: string,\r\n    metadata?: Record<string, any>\r\n  ): Promise<ServerFile[]> {\r\n    const response = await fetch(\r\n      `${API_BASE_URL}/staging/confirm/${sessionId}/${entitySystemId}/${documentType}/${encodeURIComponent(documentName)}`,\r\n      { \r\n        method: 'POST',\r\n        headers: {\r\n          'Content-Type': 'application/json'\r\n        },\r\n        body: JSON.stringify({ metadata })\r\n      }\r\n    );\r\n\r\n    const result = await response.json();\r\n    \r\n    if (!result.success) {\r\n      throw new Error(result.message || 'Confirm failed');\r\n    }\r\n\r\n    return result.files;\r\n  }\r\n\r\n  // Lấy staging files theo session\r\n  static async getStagingFiles(sessionId: string): Promise<StagingFile[]> {\r\n    const response = await fetch(`${API_BASE_URL}/staging/files/${sessionId}`);\r\n    const result = await response.json();\r\n    \r\n    if (!result.success) {\r\n      throw new Error(result.message || 'Failed to fetch staging files');\r\n    }\r\n\r\n    return result.files;\r\n  }\r\n\r\n  // Xóa staging files (cancel)\r\n  static async deleteStagingFiles(sessionId: string): Promise<void> {\r\n    const response = await fetch(`${API_BASE_URL}/staging/${sessionId}`, {\r\n      method: 'DELETE',\r\n    });\r\n\r\n    const result = await response.json();\r\n    \r\n    if (!result.success) {\r\n      throw new Error(result.message || 'Delete staging failed');\r\n    }\r\n  }\r\n\r\n  // Upload files lên server (legacy - direct permanent)\r\n  // NOTE: employeeId MUST be the systemId (immutable), NOT the business ID\r\n  static async uploadFiles(\r\n    employeeId: string, // ⚠️ MUST use systemId (e.g., \"NV00000001\"), NOT business ID\r\n    documentType: string,\r\n    documentName: string,\r\n    files: File[]\r\n  ): Promise<ServerFile[]> {\r\n    const formData = new FormData();\r\n    \r\n    files.forEach(file => {\r\n      formData.append('files', file);\r\n    });\r\n\r\n    const response = await fetch(\r\n      `${API_BASE_URL}/upload/${employeeId}/${documentType}/${encodeURIComponent(documentName)}`,\r\n      {\r\n        method: 'POST',\r\n        body: formData,\r\n      }\r\n    );\r\n\r\n    const result = await response.json();\r\n    \r\n    if (!result.success) {\r\n      throw new Error(result.message || 'Upload failed');\r\n    }\r\n\r\n    return result.files;\r\n  }\r\n\r\n  // Lấy danh sách file permanent\r\n  // NOTE: employeeId MUST be the systemId (immutable), NOT the business ID\r\n  static async getFiles(\r\n    employeeId: string, // ⚠️ MUST use systemId (e.g., \"NV00000001\"), NOT business ID\r\n    documentType?: string\r\n  ): Promise<ServerFile[]> {\r\n    try {\r\n      const url = documentType \r\n        ? `${API_BASE_URL}/files/${employeeId}/${documentType}`\r\n        : `${API_BASE_URL}/files/${employeeId}`;\r\n\r\n      const response = await fetch(url);\r\n      \r\n      // Check if response is ok\r\n      if (!response.ok) {\r\n        return []; // Return empty array instead of throwing\r\n      }\r\n      \r\n      const result = await response.json();\r\n      \r\n      if (!result.success) {\r\n        return []; // Return empty array instead of throwing\r\n      }\r\n\r\n      return result.files || [];\r\n    } catch (error) {\r\n      return []; // Return empty array on network error\r\n    }\r\n  }\r\n\r\n  // Xóa file permanent\r\n  static async deleteFile(fileId: string): Promise<void> {\r\n    const response = await fetch(`${API_BASE_URL}/files/${fileId}`, {\r\n      method: 'DELETE',\r\n    });\r\n\r\n    const result = await response.json();\r\n    \r\n    if (!result.success) {\r\n      throw new Error(result.message || 'Delete failed');\r\n    }\r\n  }\r\n\r\n  // Lấy URL file để hiển thị (bao gồm staging và permanent)\r\n  static getFileUrl(file: StagingFile | ServerFile): string {\r\n    // ✅ Return relative path to use Vite proxy - avoid CORS\r\n    // Server already returns relative path like /api/staging/files/...\r\n    return file.url;\r\n  }\r\n\r\n  // Thống kê storage (chỉ permanent files)\r\n  static async getStorageInfo(): Promise<{\r\n    totalFiles: number;\r\n    totalSize: number;\r\n    totalSizeMB: number;\r\n  }> {\r\n    const response = await fetch(`${API_BASE_URL}/storage/info`);\r\n    const result = await response.json();\r\n    \r\n    if (!result.success) {\r\n      throw new Error('Failed to get storage info');\r\n    }\r\n\r\n    return result.stats;\r\n  }\r\n\r\n  // Helper: Generate session ID cho staging\r\n  static generateSessionId(): string {\r\n    return `session_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\r\n  }\r\n\r\n  static async getProductFiles(productId: string): Promise<ServerFile[]> {\r\n    return this.getFiles(productId, 'products');\r\n  }\r\n\r\n  // Get customer files (images)\r\n  static async getCustomerFiles(customerId: string): Promise<ServerFile[]> {\r\n    try {\r\n      const response = await fetch(`${API_BASE_URL}/files/customers/${customerId}`);\r\n      \r\n      if (!response.ok) {\r\n        return [];\r\n      }\r\n      \r\n      const result = await response.json();\r\n      \r\n      if (!result.success) {\r\n        return [];\r\n      }\r\n\r\n      return result.files || [];\r\n    } catch (error) {\r\n      console.error('Failed to get customer files:', error);\r\n      return [];\r\n    }\r\n  }\r\n\r\n  // Get customer contract files\r\n  static async getCustomerContractFiles(customerId: string): Promise<ServerFile[]> {\r\n    try {\r\n      const response = await fetch(`${API_BASE_URL}/files/customers/${customerId}/contracts`);\r\n      \r\n      if (!response.ok) {\r\n        return [];\r\n      }\r\n      \r\n      const result = await response.json();\r\n      \r\n      if (!result.success) {\r\n        return [];\r\n      }\r\n\r\n      return result.files || [];\r\n    } catch (error) {\r\n      console.error('Failed to get customer contract files:', error);\r\n      return [];\r\n    }\r\n  }\r\n\r\n  // Confirm customer contract files from staging to permanent\r\n  static async confirmCustomerContractFiles(\r\n    sessionId: string,\r\n    customerId: string,\r\n    customerData?: Record<string, any>\r\n  ): Promise<ServerFile[]> {\r\n    const response = await fetch(\r\n      `${API_BASE_URL}/staging/confirm/${sessionId}/customers/${customerId}/contracts`,\r\n      { \r\n        method: 'POST',\r\n        headers: {\r\n          'Content-Type': 'application/json'\r\n        },\r\n        body: JSON.stringify({ customerData })\r\n      }\r\n    );\r\n\r\n    const result = await response.json();\r\n    \r\n    if (!result.success) {\r\n      throw new Error(result.message || 'Confirm customer contract files failed');\r\n    }\r\n\r\n    return result.files;\r\n  }\r\n\r\n  // Confirm customer images from staging to permanent\r\n  static async confirmCustomerImages(\r\n    sessionId: string,\r\n    customerId: string,\r\n    customerData?: {\r\n      name?: string;\r\n      [key: string]: any;\r\n    }\r\n  ): Promise<ServerFile[]> {\r\n    const response = await fetch(\r\n      `${API_BASE_URL}/staging/confirm/${sessionId}/customers/${customerId}`,\r\n      { \r\n        method: 'POST',\r\n        headers: {\r\n          'Content-Type': 'application/json'\r\n        },\r\n        body: JSON.stringify({ customerData })\r\n      }\r\n    );\r\n\r\n    const result = await response.json();\r\n    \r\n    if (!result.success) {\r\n      throw new Error(result.message || 'Confirm customer images failed');\r\n    }\r\n\r\n    return result.files;\r\n  }\r\n\r\n  // Confirm warranty images from staging to permanent\r\n  static async confirmWarrantyImages(\r\n    sessionId: string,\r\n    warrantyId: string,\r\n    imageType: 'received' | 'processed',\r\n    warrantyData?: {\r\n      customerName?: string;\r\n      [key: string]: any;\r\n    }\r\n  ): Promise<ServerFile[]> {\r\n    const response = await fetch(\r\n      `${API_BASE_URL}/staging/confirm/${sessionId}/warranty/${warrantyId}/${imageType}`,\r\n      { \r\n        method: 'POST',\r\n        headers: {\r\n          'Content-Type': 'application/json'\r\n        },\r\n        body: JSON.stringify({ warrantyData })\r\n      }\r\n    );\r\n\r\n    const result = await response.json();\r\n    \r\n    if (!result.success) {\r\n      throw new Error(result.message || 'Confirm warranty images failed');\r\n    }\r\n\r\n    return result.files;\r\n  }\r\n\r\n  // Delete staging session (cleanup on cancel)\r\n  static async deleteStagingSession(sessionId: string): Promise<void> {\r\n    const response = await fetch(\r\n      `${API_BASE_URL}/staging/${sessionId}`,\r\n      { method: 'DELETE' }\r\n    );\r\n\r\n    const result = await response.json();\r\n    \r\n    if (!result.success) {\r\n      throw new Error(result.message || 'Delete staging session failed');\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Upload ảnh từ TipTap Editor vào STAGING\r\n   * Ảnh sẽ được move sang permanent khi entity được save\r\n   * \r\n   * @param file - File ảnh cần upload\r\n   * @param sessionId - Session ID để group các ảnh cùng editor\r\n   * @returns StagingFile với URL tạm thời\r\n   */\r\n  static async uploadEditorImageToStaging(file: File, sessionId?: string): Promise<{\r\n    file: StagingFile;\r\n    sessionId: string;\r\n  }> {\r\n    const result = await FileUploadAPI.uploadToStaging([file], sessionId);\r\n    return {\r\n      file: result.files[0],\r\n      sessionId: result.sessionId,\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Confirm ảnh editor từ staging sang permanent\r\n   * Đồng thời replace staging URLs trong HTML content bằng permanent URLs\r\n   * \r\n   * @param sessionId - Editor staging session\r\n   * @param entityId - ID của entity (category, product, etc.)\r\n   * @param entityType - Loại entity ('categories', 'products', etc.)\r\n   * @param htmlContent - Nội dung HTML cần update URLs\r\n   * @returns Updated HTML với permanent URLs\r\n   */\r\n  static async confirmEditorImages(\r\n    sessionId: string,\r\n    entityId: string,\r\n    entityType: string,\r\n    htmlContent: string\r\n  ): Promise<{ html: string; files: ServerFile[] }> {\r\n    // Confirm staging files\r\n    const confirmedFiles = await FileUploadAPI.confirmStagingFiles(\r\n      sessionId,\r\n      entityId,\r\n      entityType,\r\n      'editor-images',\r\n      { source: 'tiptap-editor' }\r\n    );\r\n\r\n    // Replace staging URLs with permanent URLs in HTML\r\n    let updatedHtml = htmlContent;\r\n    for (const file of confirmedFiles) {\r\n      // Staging URL pattern: /api/staging/preview/{sessionId}/{filename}\r\n      // Find and replace with permanent URL\r\n      const stagingPattern = new RegExp(\r\n        `/api/staging/preview/[^/]+/${file.filename.replace(/[.*+?^${}()|[\\]\\\\]/g, '\\\\$&')}`,\r\n        'g'\r\n      );\r\n      updatedHtml = updatedHtml.replace(stagingPattern, file.url);\r\n    }\r\n\r\n    return {\r\n      html: updatedHtml,\r\n      files: confirmedFiles,\r\n    };\r\n  }\r\n\r\n  static async uploadCommentImage(file: File): Promise<UploadedAsset> {\r\n    const formData = new FormData();\r\n    formData.append('image', file);\r\n\r\n    const response = await fetch(`${API_BASE_URL}/comments/upload-image`, {\r\n      method: 'POST',\r\n      body: formData,\r\n    });\r\n\r\n    const result = await response.json();\r\n    if (!response.ok || !result.success) {\r\n      throw new Error(result.message || 'Upload ảnh bình luận thất bại');\r\n    }\r\n\r\n    return FileUploadAPI.mapDirectUpload(result.file, file.name);\r\n  }\r\n\r\n  static async uploadPrintTemplateImage(file: File): Promise<UploadedAsset> {\r\n    const formData = new FormData();\r\n    formData.append('image', file);\r\n\r\n    const response = await fetch(`${API_BASE_URL}/print-templates/upload-image`, {\r\n      method: 'POST',\r\n      body: formData,\r\n    });\r\n\r\n    const result = await response.json();\r\n    if (!response.ok || !result.success) {\r\n      throw new Error(result.message || 'Upload ảnh mẫu in thất bại');\r\n    }\r\n\r\n    return FileUploadAPI.mapDirectUpload(result.file, file.name);\r\n  }\r\n\r\n  static async uploadComplaintCommentImage(complaintId: string, file: File): Promise<UploadedAsset> {\r\n    const formData = new FormData();\r\n    formData.append('image', file);\r\n\r\n    const response = await fetch(`${API_BASE_URL}/complaints/${complaintId}/comments/upload`, {\r\n      method: 'POST',\r\n      body: formData,\r\n    });\r\n\r\n    const result = await response.json();\r\n    if (!response.ok || !result.success) {\r\n      throw new Error(result.message || 'Upload ảnh khiếu nại thất bại');\r\n    }\r\n\r\n    return FileUploadAPI.mapDirectUpload(result.file, file.name);\r\n  }\r\n\r\n  static async uploadTaskEvidence(taskId: string, files: File[]): Promise<UploadedAsset[]> {\r\n    if (files.length === 0) {\r\n      return [];\r\n    }\r\n\r\n    const formData = new FormData();\r\n    files.forEach((file) => formData.append('files', file));\r\n\r\n    const response = await fetch(`${API_BASE_URL}/tasks/${taskId}/evidence`, {\r\n      method: 'POST',\r\n      body: formData,\r\n    });\r\n\r\n    const result = await response.json();\r\n    if (!response.ok || !result.success) {\r\n      throw new Error(result.message || 'Upload bằng chứng công việc thất bại');\r\n    }\r\n\r\n    return (result.files || []).map((file: any, index: number) =>\r\n      FileUploadAPI.mapDirectUpload(file, files[index]?.name || `evidence-${index}`)\r\n    );\r\n  }\r\n\r\n  private static mapDirectUpload(file: any, fallbackName: string): UploadedAsset {\r\n    return {\r\n      id: file.id,\r\n      name: file.originalName || file.name || fallbackName,\r\n      size: file.size || file.filesize || 0,\r\n      type: file.mimetype || file.type || 'application/octet-stream',\r\n      url: file.url,\r\n      uploadedAt: file.uploadedAt || new Date().toISOString(),\r\n    };\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 6307, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/lib/import-export/configs/supplier.config.ts"],"sourcesContent":["/**\r\n * Supplier Import/Export Configuration\r\n * \r\n * Nhập/Xuất danh sách nhà cung cấp\r\n */\r\n\r\nimport type { Supplier, SupplierStatus } from '@/features/suppliers/types';\r\nimport type { ImportExportConfig, FieldConfig } from '../types';\r\nimport { asBusinessId, asSystemId } from '@/lib/id-types';\r\n\r\n// ============================================\r\n// FIELD CONFIGURATION\r\n// ============================================\r\n\r\nexport const supplierFields: FieldConfig<Supplier>[] = [\r\n  // Thông tin cơ bản\r\n  {\r\n    key: 'id',\r\n    label: 'Mã NCC (*)',\r\n    type: 'string',\r\n    required: true,\r\n    example: 'NCC001',\r\n    group: 'Thông tin cơ bản',\r\n    defaultSelected: true,\r\n  },\r\n  {\r\n    key: 'name',\r\n    label: 'Tên nhà cung cấp (*)',\r\n    type: 'string',\r\n    required: true,\r\n    example: 'Công ty ABC',\r\n    group: 'Thông tin cơ bản',\r\n    defaultSelected: true,\r\n  },\r\n  {\r\n    key: 'taxCode',\r\n    label: 'Mã số thuế',\r\n    type: 'string',\r\n    required: false,\r\n    example: '0123456789',\r\n    group: 'Thông tin cơ bản',\r\n    defaultSelected: true,\r\n  },\r\n  {\r\n    key: 'status',\r\n    label: 'Trạng thái',\r\n    type: 'string',\r\n    required: false,\r\n    example: 'Đang Giao Dịch',\r\n    group: 'Thông tin cơ bản',\r\n    defaultSelected: true,\r\n  },\r\n  \r\n  // Liên hệ\r\n  {\r\n    key: 'phone',\r\n    label: 'Số điện thoại (*)',\r\n    type: 'string',\r\n    required: true,\r\n    example: '0901234567',\r\n    group: 'Liên hệ',\r\n    defaultSelected: true,\r\n  },\r\n  {\r\n    key: 'email',\r\n    label: 'Email (*)',\r\n    type: 'string',\r\n    required: true,\r\n    example: 'contact@abc.com',\r\n    group: 'Liên hệ',\r\n    defaultSelected: true,\r\n  },\r\n  {\r\n    key: 'address',\r\n    label: 'Địa chỉ (*)',\r\n    type: 'string',\r\n    required: true,\r\n    example: '123 Nguyễn Huệ, Q1, TP.HCM',\r\n    group: 'Liên hệ',\r\n    defaultSelected: true,\r\n  },\r\n  {\r\n    key: 'website',\r\n    label: 'Website',\r\n    type: 'string',\r\n    required: false,\r\n    example: 'https://abc.com',\r\n    group: 'Liên hệ',\r\n  },\r\n  {\r\n    key: 'contactPerson',\r\n    label: 'Người liên hệ',\r\n    type: 'string',\r\n    required: false,\r\n    example: 'Nguyễn Văn A',\r\n    group: 'Liên hệ',\r\n  },\r\n  \r\n  // Ngân hàng\r\n  {\r\n    key: 'bankAccount',\r\n    label: 'Số tài khoản',\r\n    type: 'string',\r\n    required: false,\r\n    example: '123456789012',\r\n    group: 'Ngân hàng',\r\n  },\r\n  {\r\n    key: 'bankName',\r\n    label: 'Tên ngân hàng',\r\n    type: 'string',\r\n    required: false,\r\n    example: 'Vietcombank',\r\n    group: 'Ngân hàng',\r\n  },\r\n  \r\n  // Khác\r\n  {\r\n    key: 'accountManager',\r\n    label: 'Nhân viên phụ trách',\r\n    type: 'string',\r\n    required: false,\r\n    example: 'Trần Văn B',\r\n    group: 'Khác',\r\n  },\r\n  {\r\n    key: 'currentDebt',\r\n    label: 'Công nợ hiện tại',\r\n    type: 'number',\r\n    required: false,\r\n    example: '0',\r\n    group: 'Khác',\r\n  },\r\n  {\r\n    key: 'notes',\r\n    label: 'Ghi chú',\r\n    type: 'string',\r\n    required: false,\r\n    example: 'NCC uy tín',\r\n    group: 'Khác',\r\n  },\r\n];\r\n\r\n// ============================================\r\n// MAIN CONFIG\r\n// ============================================\r\n\r\nexport const supplierImportExportConfig: ImportExportConfig<Supplier> = {\r\n  entityType: 'suppliers',\r\n  entityDisplayName: 'Nhà cung cấp',\r\n  \r\n  fields: supplierFields,\r\n  \r\n  templateFileName: 'Mau_Nha_Cung_Cap.xlsx',\r\n  sheetName: 'NhaCungCap',\r\n  \r\n  // Import settings\r\n  upsertKey: 'id',\r\n  allowUpdate: true,\r\n  allowInsert: true,\r\n  \r\n  requirePreview: true,\r\n  maxRows: 1000,\r\n  maxErrorsAllowed: 0,\r\n  \r\n  // Validate each row\r\n  validateRow: (row, _index, existingData, mode) => {\r\n    const errors: Array<{ field?: string; message: string }> = [];\r\n    const supplier = row as Partial<Supplier>;\r\n    \r\n    // Mã NCC bắt buộc\r\n    if (!supplier.id?.toString().trim()) {\r\n      errors.push({ field: 'id', message: 'Mã NCC không được để trống' });\r\n    }\r\n    \r\n    // Tên NCC bắt buộc\r\n    if (!supplier.name?.trim()) {\r\n      errors.push({ field: 'name', message: 'Tên NCC không được để trống' });\r\n    }\r\n    \r\n    // SĐT bắt buộc\r\n    if (!supplier.phone?.trim()) {\r\n      errors.push({ field: 'phone', message: 'Số điện thoại không được để trống' });\r\n    }\r\n    \r\n    // Email bắt buộc\r\n    if (!supplier.email?.trim()) {\r\n      errors.push({ field: 'email', message: 'Email không được để trống' });\r\n    }\r\n    \r\n    // Địa chỉ bắt buộc\r\n    if (!supplier.address?.trim()) {\r\n      errors.push({ field: 'address', message: 'Địa chỉ không được để trống' });\r\n    }\r\n    \r\n    // Validate email format\r\n    if (supplier.email && !/^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/.test(supplier.email)) {\r\n      errors.push({ field: 'email', message: 'Email không hợp lệ' });\r\n    }\r\n    \r\n    // Check duplicate id\r\n    if (mode === 'insert-only' && supplier.id) {\r\n      const duplicate = existingData.find(s => \r\n        s.id.toString().toUpperCase() === supplier.id!.toString().toUpperCase()\r\n      );\r\n      if (duplicate) {\r\n        errors.push({ field: 'id', message: `Mã NCC \"${supplier.id}\" đã tồn tại` });\r\n      }\r\n    }\r\n    \r\n    // Validate status\r\n    const validStatuses: SupplierStatus[] = ['Đang Giao Dịch', 'Ngừng Giao Dịch'];\r\n    if (supplier.status && !validStatuses.includes(supplier.status as SupplierStatus)) {\r\n      errors.push({ field: 'status', message: `Trạng thái không hợp lệ. Chọn: ${validStatuses.join(', ')}` });\r\n    }\r\n    \r\n    return errors;\r\n  },\r\n  \r\n  // Transform row to Supplier object\r\n  postTransformRow: (row) => {\r\n    const now = new Date().toISOString();\r\n    \r\n    return {\r\n      systemId: asSystemId(''), // Will be generated\r\n      id: asBusinessId(String(row.id || '').trim()),\r\n      name: String(row.name || '').trim(),\r\n      taxCode: String(row.taxCode || '').trim(),\r\n      phone: String(row.phone || '').trim(),\r\n      email: String(row.email || '').trim(),\r\n      address: String(row.address || '').trim(),\r\n      website: row.website ? String(row.website).trim() : undefined,\r\n      contactPerson: row.contactPerson ? String(row.contactPerson).trim() : undefined,\r\n      bankAccount: row.bankAccount ? String(row.bankAccount).trim() : undefined,\r\n      bankName: row.bankName ? String(row.bankName).trim() : undefined,\r\n      accountManager: String(row.accountManager || '').trim(),\r\n      status: (row.status as SupplierStatus) || 'Đang Giao Dịch',\r\n      currentDebt: Number(row.currentDebt) || 0,\r\n      notes: row.notes ? String(row.notes).trim() : undefined,\r\n      createdAt: now,\r\n      updatedAt: now,\r\n    } as Supplier;\r\n  },\r\n};\r\n"],"names":[],"mappings":"AAAA;;;;CAIC;;;;;;AAID;;AAMO,MAAM,iBAA0C;IACrD,mBAAmB;IACnB;QACE,KAAK;QACL,OAAO;QACP,MAAM;QACN,UAAU;QACV,SAAS;QACT,OAAO;QACP,iBAAiB;IACnB;IACA;QACE,KAAK;QACL,OAAO;QACP,MAAM;QACN,UAAU;QACV,SAAS;QACT,OAAO;QACP,iBAAiB;IACnB;IACA;QACE,KAAK;QACL,OAAO;QACP,MAAM;QACN,UAAU;QACV,SAAS;QACT,OAAO;QACP,iBAAiB;IACnB;IACA;QACE,KAAK;QACL,OAAO;QACP,MAAM;QACN,UAAU;QACV,SAAS;QACT,OAAO;QACP,iBAAiB;IACnB;IAEA,UAAU;IACV;QACE,KAAK;QACL,OAAO;QACP,MAAM;QACN,UAAU;QACV,SAAS;QACT,OAAO;QACP,iBAAiB;IACnB;IACA;QACE,KAAK;QACL,OAAO;QACP,MAAM;QACN,UAAU;QACV,SAAS;QACT,OAAO;QACP,iBAAiB;IACnB;IACA;QACE,KAAK;QACL,OAAO;QACP,MAAM;QACN,UAAU;QACV,SAAS;QACT,OAAO;QACP,iBAAiB;IACnB;IACA;QACE,KAAK;QACL,OAAO;QACP,MAAM;QACN,UAAU;QACV,SAAS;QACT,OAAO;IACT;IACA;QACE,KAAK;QACL,OAAO;QACP,MAAM;QACN,UAAU;QACV,SAAS;QACT,OAAO;IACT;IAEA,YAAY;IACZ;QACE,KAAK;QACL,OAAO;QACP,MAAM;QACN,UAAU;QACV,SAAS;QACT,OAAO;IACT;IACA;QACE,KAAK;QACL,OAAO;QACP,MAAM;QACN,UAAU;QACV,SAAS;QACT,OAAO;IACT;IAEA,OAAO;IACP;QACE,KAAK;QACL,OAAO;QACP,MAAM;QACN,UAAU;QACV,SAAS;QACT,OAAO;IACT;IACA;QACE,KAAK;QACL,OAAO;QACP,MAAM;QACN,UAAU;QACV,SAAS;QACT,OAAO;IACT;IACA;QACE,KAAK;QACL,OAAO;QACP,MAAM;QACN,UAAU;QACV,SAAS;QACT,OAAO;IACT;CACD;AAMM,MAAM,6BAA2D;IACtE,YAAY;IACZ,mBAAmB;IAEnB,QAAQ;IAER,kBAAkB;IAClB,WAAW;IAEX,kBAAkB;IAClB,WAAW;IACX,aAAa;IACb,aAAa;IAEb,gBAAgB;IAChB,SAAS;IACT,kBAAkB;IAElB,oBAAoB;IACpB,aAAa,CAAC,KAAK,QAAQ,cAAc;QACvC,MAAM,SAAqD,EAAE;QAC7D,MAAM,WAAW;QAEjB,kBAAkB;QAClB,IAAI,CAAC,SAAS,EAAE,EAAE,WAAW,QAAQ;YACnC,OAAO,IAAI,CAAC;gBAAE,OAAO;gBAAM,SAAS;YAA6B;QACnE;QAEA,mBAAmB;QACnB,IAAI,CAAC,SAAS,IAAI,EAAE,QAAQ;YAC1B,OAAO,IAAI,CAAC;gBAAE,OAAO;gBAAQ,SAAS;YAA8B;QACtE;QAEA,eAAe;QACf,IAAI,CAAC,SAAS,KAAK,EAAE,QAAQ;YAC3B,OAAO,IAAI,CAAC;gBAAE,OAAO;gBAAS,SAAS;YAAoC;QAC7E;QAEA,iBAAiB;QACjB,IAAI,CAAC,SAAS,KAAK,EAAE,QAAQ;YAC3B,OAAO,IAAI,CAAC;gBAAE,OAAO;gBAAS,SAAS;YAA4B;QACrE;QAEA,mBAAmB;QACnB,IAAI,CAAC,SAAS,OAAO,EAAE,QAAQ;YAC7B,OAAO,IAAI,CAAC;gBAAE,OAAO;gBAAW,SAAS;YAA8B;QACzE;QAEA,wBAAwB;QACxB,IAAI,SAAS,KAAK,IAAI,CAAC,6BAA6B,IAAI,CAAC,SAAS,KAAK,GAAG;YACxE,OAAO,IAAI,CAAC;gBAAE,OAAO;gBAAS,SAAS;YAAqB;QAC9D;QAEA,qBAAqB;QACrB,IAAI,SAAS,iBAAiB,SAAS,EAAE,EAAE;YACzC,MAAM,YAAY,aAAa,IAAI,CAAC,CAAA,IAClC,EAAE,EAAE,CAAC,QAAQ,GAAG,WAAW,OAAO,SAAS,EAAE,CAAE,QAAQ,GAAG,WAAW;YAEvE,IAAI,WAAW;gBACb,OAAO,IAAI,CAAC;oBAAE,OAAO;oBAAM,SAAS,CAAC,QAAQ,EAAE,SAAS,EAAE,CAAC,YAAY,CAAC;gBAAC;YAC3E;QACF;QAEA,kBAAkB;QAClB,MAAM,gBAAkC;YAAC;YAAkB;SAAkB;QAC7E,IAAI,SAAS,MAAM,IAAI,CAAC,cAAc,QAAQ,CAAC,SAAS,MAAM,GAAqB;YACjF,OAAO,IAAI,CAAC;gBAAE,OAAO;gBAAU,SAAS,CAAC,+BAA+B,EAAE,cAAc,IAAI,CAAC,OAAO;YAAC;QACvG;QAEA,OAAO;IACT;IAEA,mCAAmC;IACnC,kBAAkB,CAAC;QACjB,MAAM,MAAM,IAAI,OAAO,WAAW;QAElC,OAAO;YACL,UAAU,IAAA,gIAAU,EAAC;YACrB,IAAI,IAAA,kIAAY,EAAC,OAAO,IAAI,EAAE,IAAI,IAAI,IAAI;YAC1C,MAAM,OAAO,IAAI,IAAI,IAAI,IAAI,IAAI;YACjC,SAAS,OAAO,IAAI,OAAO,IAAI,IAAI,IAAI;YACvC,OAAO,OAAO,IAAI,KAAK,IAAI,IAAI,IAAI;YACnC,OAAO,OAAO,IAAI,KAAK,IAAI,IAAI,IAAI;YACnC,SAAS,OAAO,IAAI,OAAO,IAAI,IAAI,IAAI;YACvC,SAAS,IAAI,OAAO,GAAG,OAAO,IAAI,OAAO,EAAE,IAAI,KAAK;YACpD,eAAe,IAAI,aAAa,GAAG,OAAO,IAAI,aAAa,EAAE,IAAI,KAAK;YACtE,aAAa,IAAI,WAAW,GAAG,OAAO,IAAI,WAAW,EAAE,IAAI,KAAK;YAChE,UAAU,IAAI,QAAQ,GAAG,OAAO,IAAI,QAAQ,EAAE,IAAI,KAAK;YACvD,gBAAgB,OAAO,IAAI,cAAc,IAAI,IAAI,IAAI;YACrD,QAAQ,AAAC,IAAI,MAAM,IAAuB;YAC1C,aAAa,OAAO,IAAI,WAAW,KAAK;YACxC,OAAO,IAAI,KAAK,GAAG,OAAO,IAAI,KAAK,EAAE,IAAI,KAAK;YAC9C,WAAW;YACX,WAAW;QACb;IACF;AACF"}}]
}