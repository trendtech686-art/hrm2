{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/lib/id-types.ts"],"sourcesContent":["/**\r\n * Type-safe ID System\r\n * \r\n * Prevents mixing systemId with business ID at compile time\r\n */\r\n\r\n// Branded types for type safety\r\nexport type SystemId = string & { readonly __brand: 'SystemId' };\r\nexport type BusinessId = string & { readonly __brand: 'BusinessId' };\r\n\r\n/**\r\n * Create a SystemId from a string\r\n * Use this when you know for sure it's a systemId\r\n */\r\nexport function asSystemId(id: string): SystemId {\r\n  return id as SystemId;\r\n}\r\n\r\n/**\r\n * Create a BusinessId from a string\r\n * Use this when you know for sure it's a business ID\r\n */\r\nexport function asBusinessId(id: string): BusinessId {\r\n  return id as BusinessId;\r\n}\r\n\r\n/**\r\n * Check if a string is a valid systemId format\r\n */\r\nexport function isSystemIdFormat(id: string): boolean {\r\n  // SystemId: 8 digits + prefix (e.g., NV00000001, VOUCHER00000123)\r\n  return /^[A-Z]+\\d{8}$/.test(id);\r\n}\r\n\r\n/**\r\n * Check if a string is a valid business ID format\r\n */\r\nexport function isBusinessIdFormat(id: string): boolean {\r\n  // Business ID: shorter, variable length (e.g., NV001, PT000001)\r\n  return /^[A-Z]+\\d{3,6}$/.test(id);\r\n}\r\n\r\n/**\r\n * Safely convert unknown ID to proper type\r\n */\r\nexport function parseId(id: string): { type: 'system' | 'business'; value: SystemId | BusinessId } {\r\n  if (isSystemIdFormat(id)) {\r\n    return { type: 'system', value: asSystemId(id) };\r\n  }\r\n  if (isBusinessIdFormat(id)) {\r\n    return { type: 'business', value: asBusinessId(id) };\r\n  }\r\n  throw new Error(`Invalid ID format: ${id}`);\r\n}\r\n\r\n/**\r\n * ID Pair - Always keep systemId and businessId together\r\n */\r\nexport interface IDPair {\r\n  systemId: SystemId;\r\n  businessId: BusinessId;\r\n}\r\n\r\n/**\r\n * Entity with dual IDs\r\n */\r\nexport interface DualIDEntity {\r\n  systemId: SystemId;\r\n  id: BusinessId;\r\n}\r\n\r\n/**\r\n * Store methods with type-safe IDs\r\n */\r\nexport interface TypeSafeStore<T extends DualIDEntity> {\r\n  /** Find by systemId (for queries, relationships) */\r\n  findBySystemId(systemId: SystemId): T | null;\r\n  \r\n  /** Find by business ID (for user input, display) */\r\n  findByBusinessId(businessId: BusinessId): T | null;\r\n  \r\n  /** Update by systemId (always use systemId for updates) */\r\n  updateBySystemId(systemId: SystemId, updates: Partial<T>): void;\r\n  \r\n  /** Delete by systemId (always use systemId for deletes) */\r\n  deleteBySystemId(systemId: SystemId): void;\r\n}\r\n\r\n/**\r\n * Route params with type-safe IDs\r\n */\r\nexport interface RouteParams {\r\n  systemId?: SystemId;\r\n  id?: BusinessId;\r\n}\r\n\r\n/**\r\n * Link builder - always uses systemId\r\n */\r\nexport function buildEntityLink(path: string, entity: DualIDEntity): string {\r\n  return path.replace(':systemId', entity.systemId);\r\n}\r\n\r\n/**\r\n * Display ID - always uses business ID\r\n */\r\nexport function getDisplayId(entity: DualIDEntity): string {\r\n  return entity.id;\r\n}\r\n\r\n/**\r\n * Runtime guard: ensures a string is valid SystemId format and casts it\r\n * Logs warning if format is invalid\r\n */\r\nexport function ensureSystemId(id: string, context?: string): SystemId {\r\n  if (!isSystemIdFormat(id)) {\r\n    console.warn(`[ensureSystemId] Invalid SystemId format: \"${id}\"${context ? ` in ${context}` : ''}`);\r\n  }\r\n  return asSystemId(id);\r\n}\r\n\r\n/**\r\n * Runtime guard: ensures a string is valid BusinessId format and casts it\r\n * Logs warning if format is invalid\r\n */\r\nexport function ensureBusinessId(id: string, context?: string): BusinessId {\r\n  if (!isBusinessIdFormat(id)) {\r\n    console.warn(`[ensureBusinessId] Invalid BusinessId format: \"${id}\"${context ? ` in ${context}` : ''}`);\r\n  }\r\n  return asBusinessId(id);\r\n}\r\n"],"names":[],"mappings":"AAAA;;;;CAIC,GAED,gCAAgC;;;;;;;;;;;;;;;;;;;;;AAQzB,SAAS,WAAW,EAAU;IACnC,OAAO;AACT;AAMO,SAAS,aAAa,EAAU;IACrC,OAAO;AACT;AAKO,SAAS,iBAAiB,EAAU;IACzC,kEAAkE;IAClE,OAAO,gBAAgB,IAAI,CAAC;AAC9B;AAKO,SAAS,mBAAmB,EAAU;IAC3C,gEAAgE;IAChE,OAAO,kBAAkB,IAAI,CAAC;AAChC;AAKO,SAAS,QAAQ,EAAU;IAChC,IAAI,iBAAiB,KAAK;QACxB,OAAO;YAAE,MAAM;YAAU,OAAO,WAAW;QAAI;IACjD;IACA,IAAI,mBAAmB,KAAK;QAC1B,OAAO;YAAE,MAAM;YAAY,OAAO,aAAa;QAAI;IACrD;IACA,MAAM,IAAI,MAAM,CAAC,mBAAmB,EAAE,IAAI;AAC5C;AA8CO,SAAS,gBAAgB,IAAY,EAAE,MAAoB;IAChE,OAAO,KAAK,OAAO,CAAC,aAAa,OAAO,QAAQ;AAClD;AAKO,SAAS,aAAa,MAAoB;IAC/C,OAAO,OAAO,EAAE;AAClB;AAMO,SAAS,eAAe,EAAU,EAAE,OAAgB;IACzD,IAAI,CAAC,iBAAiB,KAAK;QACzB,QAAQ,IAAI,CAAC,CAAC,2CAA2C,EAAE,GAAG,CAAC,EAAE,UAAU,CAAC,IAAI,EAAE,SAAS,GAAG,IAAI;IACpG;IACA,OAAO,WAAW;AACpB;AAMO,SAAS,iBAAiB,EAAU,EAAE,OAAgB;IAC3D,IAAI,CAAC,mBAAmB,KAAK;QAC3B,QAAQ,IAAI,CAAC,CAAC,+CAA+C,EAAE,GAAG,CAAC,EAAE,UAAU,CAAC,IAAI,EAAE,SAAS,GAAG,IAAI;IACxG;IACA,OAAO,aAAa;AACtB"}},
    {"offset": {"line": 80, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/lib/warranty-settings-sync.ts"],"sourcesContent":["/**\r\n * Warranty Settings Sync Utilities\r\n * Provides sync functions for warranty SLA, notifications, tracking settings\r\n * Uses in-memory cache with database as source of truth\r\n * \r\n * NOTE: localStorage has been removed - all data comes from API/database\r\n */\r\n\r\n// Default values - mutable for use as initial state\r\nconst DEFAULTS = {\r\n  sla: {\r\n    response: 2 * 60,      // 2 hours\r\n    processing: 24 * 60,   // 24 hours\r\n    return: 48 * 60,       // 48 hours\r\n  },\r\n  notifications: {\r\n    emailOnCreate: true,\r\n    emailOnAssign: true,\r\n    emailOnProcessing: false,\r\n    emailOnProcessed: true,\r\n    emailOnReturned: true,\r\n    emailOnOverdue: true,\r\n    smsOnOverdue: false,\r\n    inAppNotifications: true,\r\n    reminderNotifications: true,\r\n  },\r\n  tracking: {\r\n    enabled: false,\r\n    allowCustomerComments: false,\r\n    showEmployeeName: true,\r\n    showTimeline: true,\r\n  },\r\n  templates: [] as ReminderTemplate[],\r\n}\r\n\r\n// In-memory cache for sync functions\r\nlet slaCache: WarrantySLATargets | null = null\r\nlet notificationsCache: WarrantyNotificationSettings | null = null\r\nlet trackingCache: WarrantyTrackingSettings | null = null\r\nlet templatesCache: ReminderTemplate[] | null = null\r\n\r\ntype SettingType = 'sla-targets' | 'notifications' | 'tracking' | 'reminder-templates'\r\n\r\n// Generic fetch function\r\nasync function fetchWarrantySetting<T>(type: SettingType): Promise<T> {\r\n  try {\r\n    const response = await fetch(`/api/warranty-settings?type=${type}`)\r\n    if (!response.ok) throw new Error('Failed to fetch')\r\n    return await response.json()\r\n  } catch (error) {\r\n    console.error(`[WarrantySettings] Failed to fetch ${type}:`, error)\r\n    throw error\r\n  }\r\n}\r\n\r\n// Generic save function\r\nasync function saveWarrantySetting<T>(type: SettingType, data: T): Promise<void> {\r\n  try {\r\n    const response = await fetch('/api/warranty-settings', {\r\n      method: 'POST',\r\n      headers: { 'Content-Type': 'application/json' },\r\n      body: JSON.stringify({ type, data }),\r\n    })\r\n    if (!response.ok) throw new Error('Failed to save')\r\n  } catch (error) {\r\n    console.error(`[WarrantySettings] Failed to save ${type}:`, error)\r\n    throw error\r\n  }\r\n}\r\n\r\n// ============= SLA TARGETS =============\r\n\r\nexport interface WarrantySLATargets {\r\n  response: number\r\n  processing: number\r\n  return: number\r\n}\r\n\r\n/**\r\n * Load SLA targets from database\r\n */\r\nexport async function loadWarrantySLATargetsAsync(): Promise<WarrantySLATargets> {\r\n  try {\r\n    const data = await fetchWarrantySetting<WarrantySLATargets>('sla-targets')\r\n    slaCache = data\r\n    return data\r\n  } catch {\r\n    // Return cache or defaults if API fails\r\n    return slaCache ?? DEFAULTS.sla\r\n  }\r\n}\r\n\r\n/**\r\n * Get SLA targets synchronously (from cache only)\r\n */\r\nexport function getWarrantySLATargetsSync(): WarrantySLATargets {\r\n  return slaCache ?? DEFAULTS.sla\r\n}\r\n\r\n/**\r\n * Save SLA targets to database\r\n */\r\nexport async function saveWarrantySLATargetsAsync(targets: WarrantySLATargets): Promise<void> {\r\n  await saveWarrantySetting('sla-targets', targets)\r\n  slaCache = targets\r\n}\r\n\r\n// ============= NOTIFICATION SETTINGS =============\r\n\r\nexport interface WarrantyNotificationSettings {\r\n  emailOnCreate: boolean\r\n  emailOnAssign: boolean\r\n  emailOnProcessing: boolean\r\n  emailOnProcessed: boolean\r\n  emailOnReturned: boolean\r\n  emailOnOverdue: boolean\r\n  smsOnOverdue: boolean\r\n  inAppNotifications: boolean\r\n  reminderNotifications: boolean\r\n}\r\n\r\n/**\r\n * Load notification settings from database\r\n */\r\nexport async function loadWarrantyNotificationsAsync(): Promise<WarrantyNotificationSettings> {\r\n  try {\r\n    const data = await fetchWarrantySetting<WarrantyNotificationSettings>('notifications')\r\n    notificationsCache = data\r\n    return data\r\n  } catch {\r\n    // Return cache or defaults if API fails\r\n    return notificationsCache ?? DEFAULTS.notifications\r\n  }\r\n}\r\n\r\n/**\r\n * Get notification settings synchronously (from cache only)\r\n */\r\nexport function getWarrantyNotificationsSync(): WarrantyNotificationSettings {\r\n  return notificationsCache ?? DEFAULTS.notifications as WarrantyNotificationSettings\r\n}\r\n\r\n/**\r\n * Save notification settings\r\n */\r\nexport async function saveWarrantyNotificationsAsync(settings: WarrantyNotificationSettings): Promise<void> {\r\n  await saveWarrantySetting('notifications', settings)\r\n  notificationsCache = settings\r\n}\r\n\r\n// ============= TRACKING SETTINGS =============\r\n\r\nexport interface WarrantyTrackingSettings {\r\n  enabled: boolean\r\n  allowCustomerComments: boolean\r\n  showEmployeeName: boolean\r\n  showTimeline: boolean\r\n}\r\n\r\n/**\r\n * Load tracking settings from database\r\n */\r\nexport async function loadWarrantyTrackingAsync(): Promise<WarrantyTrackingSettings> {\r\n  try {\r\n    const data = await fetchWarrantySetting<WarrantyTrackingSettings>('tracking')\r\n    trackingCache = data\r\n    return data\r\n  } catch {\r\n    // Return cache or defaults if API fails\r\n    return trackingCache ?? DEFAULTS.tracking\r\n  }\r\n}\r\n\r\n/**\r\n * Get tracking settings synchronously (from cache only)\r\n */\r\nexport function getWarrantyTrackingSync(): WarrantyTrackingSettings {\r\n  return trackingCache ?? DEFAULTS.tracking as WarrantyTrackingSettings\r\n}\r\n\r\n/**\r\n * Save tracking settings\r\n */\r\nexport async function saveWarrantyTrackingAsync(settings: WarrantyTrackingSettings): Promise<void> {\r\n  await saveWarrantySetting('tracking', settings)\r\n  trackingCache = settings\r\n}\r\n\r\n// ============= REMINDER TEMPLATES =============\r\n\r\nexport interface ReminderTemplate {\r\n  id: string\r\n  name: string\r\n  message: string\r\n  isDefault?: boolean\r\n}\r\n\r\n/**\r\n * Load reminder templates from database\r\n */\r\nexport async function loadWarrantyTemplatesAsync(): Promise<ReminderTemplate[]> {\r\n  try {\r\n    const data = await fetchWarrantySetting<ReminderTemplate[]>('reminder-templates')\r\n    templatesCache = data\r\n    return data\r\n  } catch {\r\n    // Return cache or defaults if API fails\r\n    return templatesCache ?? DEFAULTS.templates\r\n  }\r\n}\r\n\r\n/**\r\n * Get reminder templates synchronously (from cache only)\r\n */\r\nexport function getWarrantyTemplatesSync(): ReminderTemplate[] {\r\n  return templatesCache ?? []\r\n}\r\n\r\n/**\r\n * Save reminder templates\r\n */\r\nexport async function saveWarrantyTemplatesAsync(templates: ReminderTemplate[]): Promise<void> {\r\n  await saveWarrantySetting('reminder-templates', templates)\r\n  templatesCache = templates\r\n}\r\n\r\n// ============= INITIALIZATION =============\r\n\r\n/**\r\n * Initialize all warranty settings from database\r\n * Call this on app startup or user login\r\n */\r\nexport async function initWarrantySettings(): Promise<void> {\r\n  await Promise.all([\r\n    loadWarrantySLATargetsAsync(),\r\n    loadWarrantyNotificationsAsync(),\r\n    loadWarrantyTrackingAsync(),\r\n    loadWarrantyTemplatesAsync(),\r\n  ])\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 255, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/lib/id-utils.ts"],"sourcesContent":["/**\r\n * ID Utilities\r\n * Helpers for generating and validating IDs (systemId & business id)\r\n */\r\n\r\nimport { getPrefix, type EntityType } from './smart-prefix';\r\nimport { ID_CONFIG } from './id-config';\r\n\r\n// Re-export EntityType for convenience\r\nexport type { EntityType } from './smart-prefix';\r\n\r\n/**\r\n * Generate SystemId (6 digits, immutable, internal use only)\r\n * Format: SYSTEMID_PREFIX + 6 digits (e.g., \"EMP000001\", \"CUSTOMER000001\", \"ORDER000001\")\r\n * Uses systemIdPrefix from ID_CONFIG (English full words)\r\n */\r\nexport function generateSystemId(entityType: EntityType, counter: number): string {\r\n  const config = ID_CONFIG[entityType];\r\n  if (!config) {\r\n    throw new Error(`No configuration found for entity type: ${entityType}`);\r\n  }\r\n  const prefix = config.systemIdPrefix;\r\n  const digitCount = config.digitCount || 6;\r\n  return `${prefix}${String(counter).padStart(digitCount, '0')}`;\r\n}\r\n\r\n/**\r\n * Generate Business ID (6 digits, user-facing, editable)\r\n * Format: PREFIX + 6 digits (e.g., \"NV000001\", \"KH000001\", \"CTV000001\")\r\n * All entities use same 6-digit format for consistency\r\n * \r\n * @param entityType - Entity type from smart-prefix\r\n * @param counter - Current counter value\r\n * @param customId - Optional custom ID from user input\r\n * @returns Generated ID or validated custom ID\r\n */\r\nexport function generateBusinessId(\r\n  entityType: EntityType, \r\n  counter: number,\r\n  customId?: string\r\n): string {\r\n  // If user provided custom ID, validate and return it\r\n  if (customId && customId.trim()) {\r\n    const sanitized = sanitizeBusinessId(customId);\r\n    if (!sanitized) {\r\n      throw new Error('Mã không hợp lệ! Chỉ được phép sử dụng chữ cái và số.');\r\n    }\r\n    return sanitized;\r\n  }\r\n  \r\n  // Otherwise, auto-generate\r\n  const prefix = getPrefix(entityType);\r\n  return `${prefix}${String(counter).padStart(6, '0')}`;\r\n}\r\n\r\n/**\r\n * Sanitize business ID\r\n * - Remove special characters (keep only letters and numbers)\r\n * - Convert to uppercase\r\n * - Trim whitespace\r\n * \r\n * @param id - Raw user input\r\n * @returns Sanitized ID or null if invalid\r\n */\r\nexport function sanitizeBusinessId(id: string): string | null {\r\n  if (!id || typeof id !== 'string') return null;\r\n  \r\n  // Remove all special characters, keep only alphanumeric\r\n  const cleaned = id.trim().replace(/[^a-zA-Z0-9]/g, '');\r\n  \r\n  if (!cleaned) return null;\r\n  \r\n  // Convert to uppercase for consistency\r\n  return cleaned.toUpperCase();\r\n}\r\n\r\n/**\r\n * Validate business ID uniqueness (case-insensitive)\r\n * \r\n * @param id - ID to check\r\n * @param existingIds - Array of existing IDs in the system\r\n * @param currentId - Current ID (for edit mode, to exclude self)\r\n * @returns true if unique, false if duplicate\r\n */\r\nexport function isBusinessIdUnique(\r\n  id: string,\r\n  existingIds: string[],\r\n  currentId?: string\r\n): boolean {\r\n  if (!id) return false;\r\n  \r\n  const normalizedId = id.toUpperCase();\r\n  const normalizedCurrentId = currentId?.toUpperCase();\r\n  \r\n  return !existingIds.some(existingId => {\r\n    // ✅ Filter out empty/undefined IDs\r\n    if (!existingId || existingId.trim() === '') return false;\r\n    \r\n    const normalizedExisting = existingId.toUpperCase();\r\n    // Skip self-comparison in edit mode\r\n    if (normalizedCurrentId && normalizedExisting === normalizedCurrentId) {\r\n      return false;\r\n    }\r\n    return normalizedExisting === normalizedId;\r\n  });\r\n}\r\n\r\n/**\r\n * Extract counter from system ID\r\n * Used to initialize counter when loading from localStorage\r\n * Supports both 6, 7 and 8 digits\r\n * \r\n * @param systemId - System ID to parse (e.g., \"EMP000001\", \"CUSTOMER000001\", \"WARRANTY0000001\")\r\n * @param prefix - Expected systemIdPrefix (e.g., \"EMP\", \"CUSTOMER\", \"WARRANTY\")\r\n * @returns Counter value or 0 if invalid\r\n */\r\nexport function extractCounterFromSystemId(systemId: string, prefix: string): number {\r\n  if (!systemId || typeof systemId !== 'string') return 0;\r\n  \r\n  // Try different digit counts (most entities use 6 digits, some use 7-8)\r\n  const regex8 = new RegExp(`^${prefix}(\\\\d{8})$`);\r\n  const regex7 = new RegExp(`^${prefix}(\\\\d{7})$`);\r\n  const regex6 = new RegExp(`^${prefix}(\\\\d{6})$`);\r\n  \r\n  const match8 = systemId.match(regex8);\r\n  if (match8) return parseInt(match8[1], 10);\r\n  \r\n  const match7 = systemId.match(regex7);\r\n  if (match7) return parseInt(match7[1], 10);\r\n  \r\n  const match6 = systemId.match(regex6);\r\n  if (match6) return parseInt(match6[1], 10);\r\n  \r\n  return 0;\r\n}\r\n\r\n/**\r\n * Extract counter from business ID\r\n * Used to initialize counter when loading from localStorage\r\n * \r\n * @param businessId - Business ID to parse (e.g., \"NV000001\")\r\n * @param prefix - Expected prefix (e.g., \"NV\")\r\n * @returns Counter value or 0 if invalid\r\n */\r\nexport function extractCounterFromBusinessId(businessId: string, prefix: string): number {\r\n  if (!businessId || typeof businessId !== 'string') return 0;\r\n  const regex = new RegExp(`^${prefix}(\\\\d+)$`);\r\n  const match = businessId.match(regex);\r\n  return match ? parseInt(match[1], 10) : 0;\r\n}\r\n\r\n/**\r\n * Get max counter from array of items (for systemId)\r\n * \r\n * @param items - Array of items with systemId\r\n * @param prefix - Prefix to match\r\n * @returns Maximum counter value\r\n */\r\nexport function getMaxSystemIdCounter<T extends { systemId: string }>(\r\n  items: T[],\r\n  prefix: string\r\n): number {\r\n  if (!items || !Array.isArray(items)) return 0;\r\n  \r\n  let maxCounter = 0;\r\n  \r\n  items.forEach(item => {\r\n    if (!item || !item.systemId) return;\r\n    const counter = extractCounterFromSystemId(item.systemId, prefix);\r\n    if (counter > maxCounter) {\r\n      maxCounter = counter;\r\n    }\r\n  });\r\n  \r\n  return maxCounter;\r\n}\r\n\r\n/**\r\n * Get max counter from array of items (for business id)\r\n * Only counts auto-generated IDs (PREFIX + digits)\r\n * \r\n * @param items - Array of items with id\r\n * @param prefix - Prefix to match\r\n * @returns Maximum counter value\r\n */\r\nexport function getMaxBusinessIdCounter<T extends { id: string }>(\r\n  items: T[],\r\n  prefix: string\r\n): number {\r\n  if (!items || !Array.isArray(items)) return 0;\r\n  \r\n  let maxCounter = 0;\r\n  \r\n  items.forEach(item => {\r\n    if (!item || !item.id) return;\r\n    const counter = extractCounterFromBusinessId(item.id, prefix);\r\n    if (counter > maxCounter) {\r\n      maxCounter = counter;\r\n    }\r\n  });\r\n  \r\n  return maxCounter;\r\n}\r\n\r\n/**\r\n * Format ID for display\r\n * Adds spacing for readability\r\n * \r\n * @param id - ID to format\r\n * @returns Formatted ID (e.g., \"NV-000001\", \"KH-000123\")\r\n */\r\nexport function formatIdForDisplay(id: string): string {\r\n  // Match pattern: PREFIX followed by numbers\r\n  const match = id.match(/^([A-Z]+)(\\d+)$/);\r\n  if (!match) return id;\r\n  \r\n  const [, prefix, numbers] = match;\r\n  return `${prefix}-${numbers}`;\r\n}\r\n\r\n/**\r\n * Validate ID format\r\n * Check if ID follows valid pattern (letters + numbers only)\r\n * \r\n * @param id - ID to validate\r\n * @returns true if valid format\r\n */\r\nexport function isValidIdFormat(id: string): boolean {\r\n  if (!id || typeof id !== 'string') return false;\r\n  \r\n  // Only alphanumeric characters allowed\r\n  const regex = /^[A-Z0-9]+$/i;\r\n  return regex.test(id);\r\n}\r\n\r\n/**\r\n * Generate suggested IDs based on entity type\r\n * Useful for autocomplete or placeholder text\r\n * \r\n * @param entityType - Entity type\r\n * @param counter - Current counter\r\n * @param count - Number of suggestions\r\n * @returns Array of suggested IDs\r\n */\r\nexport function generateSuggestedIds(\r\n  entityType: EntityType,\r\n  counter: number,\r\n  count: number = 3\r\n): string[] {\r\n  const suggestions: string[] = [];\r\n  const prefix = getPrefix(entityType);\r\n  \r\n  for (let i = 0; i < count; i++) {\r\n    suggestions.push(`${prefix}${String(counter + i + 1).padStart(6, '0')}`);\r\n  }\r\n  \r\n  return suggestions;\r\n}\r\n\r\n/**\r\n * ✨ Find next available business ID\r\n * Checks existing IDs and increments counter until finding a unique ID\r\n * \r\n * @param prefix - ID prefix (e.g., 'PT', 'PC', 'NV')\r\n * @param existingIds - Array of existing business IDs\r\n * @param startCounter - Starting counter value\r\n * @param digitCount - Number of digits (default: 6)\r\n * @returns Object with nextId and updatedCounter\r\n */\r\nexport function findNextAvailableBusinessId(\r\n  prefix: string,\r\n  existingIds: string[],\r\n  startCounter: number,\r\n  digitCount: number = 6\r\n): { nextId: string; updatedCounter: number } {\r\n  let counter = startCounter;\r\n  let nextId: string;\r\n  \r\n  // Keep incrementing until we find a unique ID\r\n  do {\r\n    counter++;\r\n    nextId = `${prefix}${String(counter).padStart(digitCount, '0')}`;\r\n  } while (existingIds.some(id => id === nextId));\r\n  \r\n  return {\r\n    nextId,\r\n    updatedCounter: counter\r\n  };\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 415, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/lib/store-factory.ts"],"sourcesContent":["import { create } from 'zustand';\r\n// persist, createJSONStorage removed - database is now source of truth\r\nimport { \r\n  generateSystemId, \r\n  generateBusinessId, \r\n  isBusinessIdUnique,\r\n  getMaxSystemIdCounter,\r\n  getMaxBusinessIdCounter,\r\n  findNextAvailableBusinessId,\r\n  type EntityType \r\n} from './id-utils';\r\nimport { getPrefix } from './smart-prefix';\r\nimport { ID_CONFIG, type SystemId, type BusinessId, createSystemId, createBusinessId as brandBusinessId } from './id-config';\r\n\r\nconst SYSTEM_FALLBACK_ID: SystemId = createSystemId('SYS000000');\r\n\r\nconst asSystemIdFallback = (): SystemId => SYSTEM_FALLBACK_ID;\r\n\r\n// ✅ API Sync helper for store-factory\r\nasync function syncToAPI<T>(\r\n  apiEndpoint: string,\r\n  action: 'create' | 'update' | 'delete' | 'restore',\r\n  data: T | { systemId: SystemId },\r\n  systemId?: SystemId\r\n): Promise<boolean> {\r\n  try {\r\n    const endpoint = action === 'create' \r\n      ? apiEndpoint \r\n      : `${apiEndpoint}/${systemId || (data as any).systemId}`;\r\n    \r\n    const method = action === 'create' ? 'POST' \r\n      : action === 'update' ? 'PATCH' \r\n      : action === 'delete' ? 'DELETE'\r\n      : 'PATCH'; // restore uses PATCH\r\n    \r\n    const response = await fetch(endpoint, {\r\n      method,\r\n      headers: { 'Content-Type': 'application/json' },\r\n      credentials: 'include',\r\n      body: action !== 'delete' ? JSON.stringify(data) : undefined,\r\n    });\r\n    \r\n    if (!response.ok) {\r\n      console.warn(`[Store Factory API] ${action} failed for ${apiEndpoint}:`, response.status);\r\n    }\r\n    return response.ok;\r\n  } catch (error) {\r\n    console.error(`[Store Factory API] ${action} error for ${apiEndpoint}:`, error);\r\n    return false;\r\n  }\r\n}\r\n\r\n// Item with SystemId (branded type)\r\nexport type ItemWithSystemId = { systemId: SystemId; [key: string]: any };\r\n\r\n// ✅ Counter state for ID generation\r\nexport type CounterState = {\r\n  systemId: number;\r\n  businessId: number;\r\n};\r\n\r\nexport type CrudState<T extends ItemWithSystemId> = {\r\n  data: T[];\r\n  _counters: CounterState; // ✅ Persisted counters\r\n  _initialized: boolean; // ✅ Track if loaded from API\r\n  add: (item: Omit<T, 'systemId'>) => T;\r\n  addMultiple: (items: Omit<T, 'systemId'>[]) => void;\r\n  update: (systemId: SystemId, item: Partial<T>) => void; // ✅ Accept partial updates\r\n  remove: (systemId: SystemId) => void; // ✅ Branded type\r\n  hardDelete: (systemId: SystemId) => void; // ✅ Branded type\r\n  restore: (systemId: SystemId) => void; // ✅ Branded type\r\n  findById: (systemId: SystemId | string) => T | undefined; // ✅ Branded type\r\n  getActive: () => T[];\r\n  getDeleted: () => T[];\r\n  loadFromAPI: () => Promise<void>; // ✅ Load data from database\r\n};\r\n\r\nexport const createCrudStore = <T extends ItemWithSystemId>(\r\n  _initialData: T[], // @deprecated - Kept for backward compatibility but NO LONGER USED\r\n  entityType: EntityType, // Changed from idPrefix to entityType\r\n  options?: {\r\n    businessIdField?: keyof T; // Field name for business ID (default: 'id')\r\n    persistKey?: string; // @deprecated - No longer used, kept for backward compatibility\r\n    getCurrentUser?: () => string | undefined; // Function to get current user systemId\r\n    apiEndpoint?: string; // ✅ API endpoint for database sync (e.g., '/api/employees')\r\n  }\r\n) => {\r\n  const businessPrefix = getPrefix(entityType); // Vietnamese prefix for Business ID (NV, KH, DH)\r\n  const config = ID_CONFIG[entityType];\r\n  const systemIdPrefix = config?.systemIdPrefix || entityType.toUpperCase(); // English prefix for SystemId (EMP, CUSTOMER, ORDER)\r\n  \r\n  const businessIdField = options?.businessIdField ?? 'id';\r\n  // const persistKey = options?.persistKey; // @deprecated - No longer used\r\n  const getCurrentUser = options?.getCurrentUser;\r\n  const apiEndpoint = options?.apiEndpoint;\r\n\r\n  // ✅ CHANGED: Start with empty array - database is source of truth\r\n  // Mock data files (data.ts) are NO LONGER USED for runtime\r\n  const normalizedInitialData: T[] = [];\r\n\r\n  const storeConfig = (set: any, get: any) => ({\r\n    data: normalizedInitialData, // ✅ Start empty - data loaded via React Query\r\n    // ✅ Counters start at 0 - will be initialized from API via loadFromAPI()\r\n    _counters: {\r\n      systemId: 0,\r\n      businessId: 0\r\n    },\r\n    _initialized: false, // ✅ Track API initialization\r\n    add: (item: Omit<T, 'systemId'>): T => {\r\n        // ✅ Get counters from state (persisted)\r\n        const currentCounters = get()._counters;\r\n        const newSystemIdCounter = currentCounters.systemId + 1;\r\n        const newSystemId = createSystemId(generateSystemId(entityType, newSystemIdCounter));\r\n        \r\n        // Generate or validate Business ID (if field exists)\r\n        let finalItem = { ...item } as any;\r\n        let newBusinessIdCounter = currentCounters.businessId;\r\n        \r\n        if (businessIdField in item) {\r\n          const customId = (item as any)[businessIdField];\r\n          const existingIds = get().data.map((d: any) => d[businessIdField]);\r\n          \r\n          // ✅ If customId provided, validate uniqueness\r\n          if (customId && customId.trim()) {\r\n            if (!isBusinessIdUnique(customId, existingIds)) {\r\n              throw new Error(`Mã \"${customId}\" đã tồn tại! Vui lòng sử dụng mã khác.`);\r\n            }\r\n            finalItem[businessIdField] = customId.trim().toUpperCase();\r\n          } else {\r\n            // ✅ Auto-generate with findNextAvailableBusinessId\r\n            const digitCount = 6; // All entities use 6 digits\r\n            const result = findNextAvailableBusinessId(businessPrefix, existingIds, newBusinessIdCounter, digitCount);\r\n            finalItem[businessIdField] = result.nextId;\r\n            newBusinessIdCounter = result.updatedCounter;\r\n          }\r\n        }\r\n        \r\n        const now = new Date().toISOString();\r\n        const currentUser = getCurrentUser?.();\r\n        const newItem = { \r\n          ...finalItem, \r\n          systemId: newSystemId, // ✅ Branded SystemId\r\n          createdAt: finalItem.createdAt || now,\r\n          updatedAt: now,\r\n          createdBy: finalItem.createdBy || currentUser,\r\n          updatedBy: currentUser,\r\n        } as unknown as T;\r\n        \r\n        // ✅ Update both data and counters atomically\r\n        set((state: any) => ({ \r\n          data: [...state.data, newItem],\r\n          _counters: {\r\n            systemId: newSystemIdCounter,\r\n            businessId: newBusinessIdCounter\r\n          }\r\n        }));\r\n        \r\n        // ✅ Sync to API in background\r\n        if (apiEndpoint) {\r\n          syncToAPI(apiEndpoint, 'create', newItem).catch(console.error);\r\n        }\r\n        \r\n        return newItem;\r\n    },\r\n    addMultiple: (items: Omit<T, 'systemId'>[]) => \r\n        set((state: any) => {\r\n            const now = new Date().toISOString();\r\n            const currentUser = getCurrentUser?.();\r\n            const newItems: T[] = [];\r\n            const digitCount = 6; // All entities use 6 digits\r\n            \r\n            // ✅ Start from current counters\r\n            let currentSystemIdCounter = state._counters.systemId;\r\n            let currentBusinessIdCounter = state._counters.businessId;\r\n            \r\n            items.forEach(item => {\r\n                // ✅ Generate SystemId from current counter\r\n                currentSystemIdCounter++;\r\n                const newSystemId = createSystemId(generateSystemId(entityType, currentSystemIdCounter));\r\n                \r\n                // Generate or validate Business ID (if field exists)\r\n                let finalItem = { ...item } as any;\r\n                if (businessIdField in item) {\r\n                  const customId = (item as any)[businessIdField];\r\n                  \r\n                  // Collect existing IDs (from state + already added in this batch)\r\n                  const existingIds = [\r\n                    ...state.data.map((d: any) => d[businessIdField]),\r\n                    ...newItems.map((d: any) => d[businessIdField])\r\n                  ];\r\n                  \r\n                  // ✅ If customId provided, validate uniqueness\r\n                  if (customId && customId.trim()) {\r\n                    if (!isBusinessIdUnique(customId, existingIds)) {\r\n                      throw new Error(`Mã \"${customId}\" đã tồn tại! Vui lòng sử dụng mã khác.`);\r\n                    }\r\n                    finalItem[businessIdField] = customId.trim().toUpperCase();\r\n                  } else {\r\n                    // ✅ Auto-generate with findNextAvailableBusinessId\r\n                    const result = findNextAvailableBusinessId(businessPrefix, existingIds, currentBusinessIdCounter, digitCount);\r\n                    finalItem[businessIdField] = result.nextId;\r\n                    currentBusinessIdCounter = result.updatedCounter;\r\n                  }\r\n                }\r\n                \r\n                newItems.push({ \r\n                  ...finalItem, \r\n                  systemId: newSystemId,\r\n                  createdAt: now,\r\n                  updatedAt: now,\r\n                  createdBy: currentUser,\r\n                  updatedBy: currentUser,\r\n                } as unknown as T);\r\n            });\r\n            \r\n            // ✅ Update both data and counters\r\n            const result = { \r\n              data: [...state.data, ...newItems],\r\n              _counters: {\r\n                systemId: currentSystemIdCounter,\r\n                businessId: currentBusinessIdCounter\r\n              }\r\n            };\r\n            \r\n            // ✅ Sync to API in background (batch)\r\n            if (apiEndpoint) {\r\n              newItems.forEach(item => {\r\n                syncToAPI(apiEndpoint, 'create', item).catch(console.error);\r\n              });\r\n            }\r\n            \r\n            return result;\r\n        }),\r\n    update: (systemId: SystemId, updatedItem: Partial<T>) => {\r\n      // Validate unique business ID (case-insensitive, skip self)\r\n      if (businessIdField in updatedItem) {\r\n        const businessId = (updatedItem as any)[businessIdField];\r\n        const existingIds = get().data\r\n          .filter((d: any) => d.systemId !== systemId)\r\n          .map((d: any) => d[businessIdField]);\r\n        \r\n        if (businessId && !isBusinessIdUnique(businessId, existingIds)) {\r\n          throw new Error(`Mã \"${businessId}\" đã tồn tại! Vui lòng sử dụng mã khác.`);\r\n        }\r\n      }\r\n\r\n      const now = new Date().toISOString();\r\n      const currentUser = getCurrentUser?.();\r\n      set((state: any) => ({\r\n        data: state.data.map((item: T) =>\r\n          item.systemId === systemId \r\n            ? { ...item, ...updatedItem, updatedAt: now, updatedBy: currentUser } as T\r\n            : item\r\n        ),\r\n      }));\r\n      \r\n      // ✅ Sync to API in background\r\n      if (apiEndpoint) {\r\n        const fullItem = get().data.find((item: T) => item.systemId === systemId);\r\n        if (fullItem) {\r\n          syncToAPI(apiEndpoint, 'update', fullItem, systemId).catch(console.error);\r\n        }\r\n      }\r\n    },\r\n    remove: (systemId: SystemId) => {\r\n      // Soft delete - mark as deleted\r\n      const now = new Date().toISOString();\r\n      set((state: any) => ({\r\n        data: state.data.map((item: T) =>\r\n          item.systemId === systemId\r\n            ? { ...item, isDeleted: true, deletedAt: now } as T\r\n            : item\r\n        ),\r\n      }));\r\n      \r\n      // ✅ Sync to API in background\r\n      if (apiEndpoint) {\r\n        const item = get().data.find((item: T) => item.systemId === systemId);\r\n        if (item) {\r\n          syncToAPI(apiEndpoint, 'update', { ...item, isDeleted: true, deletedAt: now }, systemId).catch(console.error);\r\n        }\r\n      }\r\n    },\r\n    hardDelete: (systemId: SystemId) => {\r\n      // Permanent delete - remove from array\r\n      set((state: any) => ({\r\n        data: state.data.filter((item: T) => item.systemId !== systemId),\r\n      }));\r\n      \r\n      // ✅ Sync to API in background\r\n      if (apiEndpoint) {\r\n        syncToAPI(apiEndpoint, 'delete', { systemId }, systemId).catch(console.error);\r\n      }\r\n    },\r\n    restore: (systemId: SystemId) => {\r\n      // Restore soft-deleted item\r\n      set((state: any) => ({\r\n        data: state.data.map((item: T) =>\r\n          item.systemId === systemId\r\n            ? { ...item, isDeleted: false, deletedAt: null } as T\r\n            : item\r\n        ),\r\n      }));\r\n      \r\n      // ✅ Sync to API in background\r\n      if (apiEndpoint) {\r\n        const item = get().data.find((item: T) => item.systemId === systemId);\r\n        if (item) {\r\n          syncToAPI(apiEndpoint, 'restore', { ...item, isDeleted: false, deletedAt: null }, systemId).catch(console.error);\r\n        }\r\n      }\r\n    },\r\n    getActive: () => get().data.filter((item: any) => !item.isDeleted),\r\n    getDeleted: () => get().data.filter((item: any) => item.isDeleted),\r\n    findById: (id: SystemId | string) => get().data.find((item: T) => item.systemId === id || (item as any).id === id),\r\n    \r\n    // ✅ Load data from database API - OPTIMIZED: No more limit=10000!\r\n    // This is now only used for counter initialization, NOT for loading all data\r\n    // Use React Query hooks for data fetching with proper pagination\r\n    loadFromAPI: async () => {\r\n      if (!apiEndpoint) return;\r\n      if (get()._initialized) return;\r\n      \r\n      try {\r\n        // Only fetch minimal data needed to initialize counters\r\n        // Actual data loading should be done via React Query hooks\r\n        const response = await fetch(`${apiEndpoint}?limit=1&sortBy=systemId&sortOrder=desc`, {\r\n          credentials: 'include',\r\n        });\r\n        if (response.ok) {\r\n          const json = await response.json();\r\n          const pagination = json.pagination || {};\r\n          const lastItem = json.data?.[0];\r\n          \r\n          // Initialize counters from the latest item (highest IDs)\r\n          const newCounters = {\r\n            systemId: lastItem ? getMaxSystemIdCounter([lastItem], systemIdPrefix) : 0,\r\n            businessId: (lastItem && options?.businessIdField)\r\n              ? getMaxBusinessIdCounter([lastItem] as any[], businessPrefix)\r\n              : 0\r\n          };\r\n          \r\n          set({ \r\n            data: [], // Don't store data in Zustand anymore - use React Query\r\n            _counters: newCounters,\r\n            _initialized: true \r\n          });\r\n          \r\n          console.log(`[Store Factory] ${apiEndpoint} initialized. Total records: ${pagination.total || 'unknown'}`);\r\n        }\r\n      } catch (error) {\r\n        console.error(`[Store Factory] loadFromAPI error for ${apiEndpoint}:`, error);\r\n        // Still mark as initialized to prevent infinite retry\r\n        set({ _initialized: true });\r\n      }\r\n    },\r\n  });\r\n\r\n  // ✅ SIMPLIFIED: No localStorage persistence, database is source of truth\r\n  // Data is loaded via ApiSyncProvider on app init\r\n  return create<CrudState<T>>(storeConfig);\r\n};\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 723, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/lib/seed-audit.ts"],"sourcesContent":["import { asSystemId, type SystemId } from './id-types';\r\n\r\nexport const DEFAULT_SEED_AUTHOR = asSystemId('EMP000001');\r\n\r\ntype SeedAuditInput = {\r\n  createdAt: string;\r\n  createdBy?: SystemId;\r\n  updatedAt?: string;\r\n  updatedBy?: SystemId;\r\n};\r\n\r\nexport const buildSeedAuditFields = ({\r\n  createdAt,\r\n  createdBy = DEFAULT_SEED_AUTHOR,\r\n  updatedAt,\r\n  updatedBy,\r\n}: SeedAuditInput) => ({\r\n  createdAt,\r\n  updatedAt: updatedAt ?? createdAt,\r\n  createdBy,\r\n  updatedBy: updatedBy ?? createdBy,\r\n});\r\n"],"names":[],"mappings":";;;;;;AAAA;;AAEO,MAAM,sBAAsB,IAAA,gIAAU,EAAC;AASvC,MAAM,uBAAuB,CAAC,EACnC,SAAS,EACT,YAAY,mBAAmB,EAC/B,SAAS,EACT,SAAS,EACM,GAAK,CAAC;QACrB;QACA,WAAW,aAAa;QACxB;QACA,WAAW,aAAa;IAC1B,CAAC"}},
    {"offset": {"line": 742, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/lib/activity-history-helper.ts"],"sourcesContent":["/**\r\n * Activity History Helper\r\n * \r\n * Helper để tạo các entry lịch sử hoạt động một cách nhất quán\r\n * Dùng chung cho tất cả các modules trong hệ thống\r\n * \r\n * NOTE: Đã remove import useEmployeeStore để tránh circular dependency\r\n * và cải thiện compile time\r\n */\r\n\r\nimport type { HistoryEntry } from '../components/ActivityHistory';\r\nimport { getCurrentUserInfo as getAuthUserInfo } from '../contexts/auth-context';\r\nimport type { SystemId } from './id-types';\r\n\r\n// Re-export HistoryEntry type for convenience\r\nexport type { HistoryEntry } from '../components/ActivityHistory';\r\n\r\n/**\r\n * Lấy thông tin người dùng hiện tại từ auth context\r\n * NOTE: Avatar lookup từ employee store đã bị remove để tránh circular dependency\r\n */\r\nexport function getCurrentUserInfo(): { systemId: string; name: string; avatar?: string } {\r\n  const authInfo = getAuthUserInfo();\r\n  \r\n  return {\r\n    systemId: authInfo.systemId || 'SYSTEM',\r\n    name: authInfo.name || 'Hệ thống',\r\n    avatar: undefined, // Avatar will be fetched by component if needed\r\n  };\r\n}\r\n\r\n/**\r\n * Lấy thông tin nhân viên từ systemId\r\n * NOTE: This function now requires employee data to be passed in\r\n * to avoid circular dependency with employee store\r\n */\r\nexport function getEmployeeInfoFromData(\r\n  employeeSystemId: SystemId | string,\r\n  employees: Array<{ systemId: string; fullName: string; avatarUrl?: string }>\r\n): { systemId: string; name: string; avatar?: string } {\r\n  const employee = employees.find(e => e.systemId === employeeSystemId);\r\n  \r\n  if (employee) {\r\n    return {\r\n      systemId: employee.systemId,\r\n      name: employee.fullName,\r\n      avatar: employee.avatarUrl,\r\n    };\r\n  }\r\n  \r\n  // Fallback to system\r\n  return {\r\n    systemId: String(employeeSystemId) || 'SYSTEM',\r\n    name: 'Hệ thống',\r\n  };\r\n}\r\n\r\n/**\r\n * @deprecated Use getEmployeeInfoFromData instead\r\n */\r\nexport function getEmployeeInfo(employeeSystemId: SystemId | string): { systemId: string; name: string; avatar?: string } {\r\n  // Return minimal info without employee store lookup\r\n  return {\r\n    systemId: String(employeeSystemId) || 'SYSTEM',\r\n    name: 'Hệ thống',\r\n  };\r\n}\r\n\r\n/**\r\n * Tạo một history entry mới\r\n */\r\nexport function createHistoryEntry(\r\n  action: HistoryEntry['action'],\r\n  userOrDescription: { systemId: string; name: string; avatar?: string } | string,\r\n  descriptionOrMetadata?: string | HistoryEntry['metadata'],\r\n  metadata?: HistoryEntry['metadata']\r\n): HistoryEntry {\r\n  const hasUserObject = typeof userOrDescription === 'object' && userOrDescription !== null;\r\n  const user = hasUserObject ? userOrDescription : getCurrentUserInfo();\r\n  const description = (hasUserObject ? descriptionOrMetadata : userOrDescription) as string | undefined;\r\n  const meta = (hasUserObject ? metadata : descriptionOrMetadata) as HistoryEntry['metadata'] | undefined;\r\n\r\n  return {\r\n    id: `history-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,\r\n    action,\r\n    timestamp: new Date(),\r\n    user: {\r\n      systemId: user.systemId,\r\n      name: user.name,\r\n      avatar: user.avatar,\r\n    },\r\n    description: description ?? '',\r\n    metadata: meta,\r\n  };\r\n}\r\n\r\n/**\r\n * Tạo history entry cho action \"created\"\r\n */\r\nexport function createCreatedEntry(\r\n  user: { systemId: string; name: string; avatar?: string },\r\n  description: string\r\n): HistoryEntry {\r\n  return createHistoryEntry('created', user, description);\r\n}\r\n\r\n/**\r\n * Tạo history entry cho action \"updated\"\r\n */\r\nexport function createUpdatedEntry(\r\n  user: { systemId: string; name: string; avatar?: string },\r\n  description: string\r\n): HistoryEntry {\r\n  return createHistoryEntry('updated', user, description);\r\n}\r\n\r\n/**\r\n * Tạo history entry cho action \"status_changed\"\r\n */\r\nexport function createStatusChangedEntry(\r\n  user: { systemId: string; name: string; avatar?: string },\r\n  oldStatus: string,\r\n  newStatus: string,\r\n  description: string\r\n): HistoryEntry {\r\n  return createHistoryEntry(\r\n    'status_changed',\r\n    user,\r\n    description,\r\n    { field: 'status', oldValue: oldStatus, newValue: newStatus }\r\n  );\r\n}\r\n\r\n/**\r\n * Tạo history entry cho action \"deleted\"\r\n */\r\nexport function createDeletedEntry(\r\n  user: { systemId: string; name: string; avatar?: string },\r\n  description: string\r\n): HistoryEntry {\r\n  return createHistoryEntry('deleted', user, description);\r\n}\r\n\r\n/**\r\n * Tạo history entry cho action \"assigned\"\r\n */\r\nexport function createAssignedEntry(\r\n  user: { systemId: string; name: string; avatar?: string },\r\n  description: string\r\n): HistoryEntry {\r\n  return createHistoryEntry('assigned', user, description);\r\n}\r\n\r\n/**\r\n * Tạo history entry cho action \"payment_made\"\r\n */\r\nexport function createPaymentEntry(\r\n  user: { systemId: string; name: string; avatar?: string },\r\n  description: string\r\n): HistoryEntry {\r\n  return createHistoryEntry('payment_made', user, description);\r\n}\r\n\r\n/**\r\n * Tạo history entry cho action \"comment_added\"\r\n */\r\nexport function createCommentEntry(\r\n  user: { systemId: string; name: string; avatar?: string },\r\n  description: string\r\n): HistoryEntry {\r\n  return createHistoryEntry('comment_added', user, description);\r\n}\r\n\r\n/**\r\n * Tạo history entry cho action \"cancelled\"\r\n */\r\nexport function createCancelledEntry(\r\n  user: { systemId: string; name: string; avatar?: string },\r\n  description: string\r\n): HistoryEntry {\r\n  return createHistoryEntry('cancelled', user, description);\r\n}\r\n\r\n/**\r\n * Tạo history entry cho action \"verified\"\r\n */\r\nexport function createVerifiedEntry(\r\n  user: { systemId: string; name: string; avatar?: string },\r\n  description: string\r\n): HistoryEntry {\r\n  return createHistoryEntry('verified', user, description);\r\n}\r\n\r\n/**\r\n * Tạo history entry cho action \"ended\"\r\n */\r\nexport function createEndedEntry(\r\n  user: { systemId: string; name: string; avatar?: string },\r\n  description: string\r\n): HistoryEntry {\r\n  return createHistoryEntry('ended', user, description);\r\n}\r\n\r\n/**\r\n * Tạo history entry cho action \"reopened\"\r\n */\r\nexport function createReopenedEntry(\r\n  user: { systemId: string; name: string; avatar?: string },\r\n  description: string\r\n): HistoryEntry {\r\n  return createHistoryEntry('reopened', user, description);\r\n}\r\n\r\n/**\r\n * Tạo history entry cho product actions\r\n */\r\nexport function createProductEntry(\r\n  user: { systemId: string; name: string; avatar?: string },\r\n  action: 'product_added' | 'product_updated' | 'product_removed',\r\n  description: string\r\n): HistoryEntry {\r\n  return createHistoryEntry(action, user, description);\r\n}\r\n\r\n/**\r\n * Helper để append history entry vào existing array\r\n */\r\nexport function appendHistoryEntry(\r\n  existingHistory: HistoryEntry[] | undefined,\r\n  ...newEntries: HistoryEntry[]\r\n): HistoryEntry[] {\r\n  return [...(existingHistory || []), ...newEntries];\r\n}\r\n\r\n/**\r\n * Helper để tạo nhiều history entries cùng lúc\r\n */\r\nexport function createBulkUpdateEntries(\r\n  user: { systemId: string; name: string; avatar?: string },\r\n  changes: Array<{ field: string; description: string }>\r\n): HistoryEntry[] {\r\n  return changes.map(change => createHistoryEntry('updated', user, change.description));\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 891, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/lib/api-config.ts"],"sourcesContent":["/**\r\n * API Configuration Utilities\r\n * \r\n * Centralized configuration for API endpoints.\r\n * All API URLs should use these utilities instead of hardcoding.\r\n */\r\n\r\n/**\r\n * Get the API base URL from environment variables\r\n * Falls back to localhost:3001 for development\r\n */\r\nexport function getApiBaseUrl(): string {\r\n  // Use relative path to leverage Vite proxy in development\r\n  // This avoids CORS issues when frontend (5173) talks to backend (3001)\r\n  if ((import.meta as any).env?.DEV) {\r\n    return '/api';\r\n  }\r\n  return (import.meta as any).env?.VITE_API_BASE_URL || 'http://localhost:3001/api';\r\n}\r\n\r\n/**\r\n * Get the base URL without /api suffix\r\n * Falls back to localhost:3001 for development\r\n */\r\nexport function getBaseUrl(): string {\r\n  const apiUrl = getApiBaseUrl();\r\n  return apiUrl.replace('/api', '');\r\n}\r\n\r\n/**\r\n * Build a full file URL from a relative path\r\n * @param relativePath - Relative file path (e.g., \"/uploads/documents/file.pdf\")\r\n * @returns Full URL to the file\r\n */\r\nexport function getFileUrl(relativePath: string): string {\r\n  if (!relativePath) return '';\r\n  \r\n  // If already a full URL, return as is\r\n  if (relativePath.startsWith('http://') || relativePath.startsWith('https://')) {\r\n    return relativePath;\r\n  }\r\n  \r\n  // Build full URL\r\n  const baseUrl = getBaseUrl();\r\n  return `${baseUrl}${relativePath}`;\r\n}\r\n\r\n/**\r\n * Build an API endpoint URL\r\n * @param endpoint - API endpoint path (e.g., \"/employees/documents\")\r\n * @returns Full API URL\r\n */\r\nexport function getApiUrl(endpoint: string): string {\r\n  const apiBaseUrl = getApiBaseUrl();\r\n  return `${apiBaseUrl}${endpoint}`;\r\n}\r\n"],"names":[],"mappings":"AAAA;;;;;CAKC,GAED;;;CAGC;;;;;;;;;;;;;;;AACM,SAAS;IACd,0DAA0D;IAC1D,uEAAuE;IACvE,IAAI,8BAAqB,GAAG,EAAE,KAAK;QACjC,OAAO;IACT;IACA,OAAO,8BAAqB,GAAG,EAAE,qBAAqB;AACxD;AAMO,SAAS;IACd,MAAM,SAAS;IACf,OAAO,OAAO,OAAO,CAAC,QAAQ;AAChC;AAOO,SAAS,WAAW,YAAoB;IAC7C,IAAI,CAAC,cAAc,OAAO;IAE1B,sCAAsC;IACtC,IAAI,aAAa,UAAU,CAAC,cAAc,aAAa,UAAU,CAAC,aAAa;QAC7E,OAAO;IACT;IAEA,iBAAiB;IACjB,MAAM,UAAU;IAChB,OAAO,GAAG,UAAU,cAAc;AACpC;AAOO,SAAS,UAAU,QAAgB;IACxC,MAAM,aAAa;IACnB,OAAO,GAAG,aAAa,UAAU;AACnC"}},
    {"offset": {"line": 944, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/lib/ghtk-constants.ts"],"sourcesContent":["/**\r\n * GHTK Status Mapping & Constants\r\n * Based on GHTK API documentation: https://api.ghtk.vn/docs/submit-order/webhook\r\n */\r\n\r\nimport type { OrderDeliveryStatus } from '@/features/orders/types';\r\n\r\nexport type GHTKStatusId = -1 | 1 | 2 | 3 | 4 | 5 | 6 | 7 | 8 | 9 | 10 | 11 | 12 | 13 | 20 | 21 | 123 | 127 | 128 | 45 | 49 | 410;\r\n\r\nexport type GHTKReasonCode = \r\n  // Chậm lấy hàng (100-107)\r\n  | '100' | '101' | '102' | '103' | '104' | '105' | '106' | '107'\r\n  // Không lấy được (110-115)\r\n  | '110' | '111' | '112' | '113' | '114' | '115'\r\n  // Chậm giao (120-129)\r\n  | '120' | '121' | '122' | '123' | '124' | '125' | '126' | '127' | '128' | '129' | '1200'\r\n  // Không giao được (130-135)\r\n  | '130' | '131' | '132' | '133' | '134' | '135'\r\n  // Delay trả hàng (140-144)\r\n  | '140' | '141' | '142' | '143' | '144';\r\n\r\nexport interface GHTKStatusMapping {\r\n  statusId: GHTKStatusId;\r\n  statusText: string;\r\n  deliveryStatus: OrderDeliveryStatus;\r\n  description: string;\r\n  canCancel: boolean; // Có thể hủy qua API không\r\n  shouldUpdateStock: boolean; // Có cần update stock không\r\n  stockAction?: 'dispatch' | 'complete' | 'return'; // Loại stock action\r\n  isFinal: boolean; // Trạng thái cuối (không cần sync nữa)\r\n}\r\n\r\n/**\r\n * Complete GHTK Status Mapping\r\n */\r\nexport const GHTK_STATUS_MAP: Record<GHTKStatusId, GHTKStatusMapping> = {\r\n  '-1': {\r\n    statusId: -1,\r\n    statusText: 'Hủy đơn hàng',\r\n    deliveryStatus: 'Chờ giao lại',\r\n    description: 'Đơn hàng đã bị hủy',\r\n    canCancel: false,\r\n    shouldUpdateStock: true,\r\n    stockAction: 'return',\r\n    isFinal: true,\r\n  },\r\n  '1': {\r\n    statusId: 1,\r\n    statusText: 'Chưa tiếp nhận',\r\n    deliveryStatus: 'Chờ lấy hàng',\r\n    description: 'GHTK chưa tiếp nhận đơn hàng',\r\n    canCancel: true,\r\n    shouldUpdateStock: false,\r\n    isFinal: false,\r\n  },\r\n  '2': {\r\n    statusId: 2,\r\n    statusText: 'Đã tiếp nhận',\r\n    deliveryStatus: 'Chờ lấy hàng',\r\n    description: 'GHTK đã tiếp nhận và đang chuẩn bị lấy hàng',\r\n    canCancel: true,\r\n    shouldUpdateStock: false,\r\n    isFinal: false,\r\n  },\r\n  '3': {\r\n    statusId: 3,\r\n    statusText: 'Đã lấy hàng/Đã nhập kho',\r\n    deliveryStatus: 'Đang giao hàng',\r\n    description: 'Shipper đã lấy hàng thành công',\r\n    canCancel: false,\r\n    shouldUpdateStock: true,\r\n    stockAction: 'dispatch',\r\n    isFinal: false,\r\n  },\r\n  '4': {\r\n    statusId: 4,\r\n    statusText: 'Đã điều phối giao hàng/Đang giao hàng',\r\n    deliveryStatus: 'Đang giao hàng',\r\n    description: 'Đơn hàng đang được giao đến khách',\r\n    canCancel: false,\r\n    shouldUpdateStock: false,\r\n    isFinal: false,\r\n  },\r\n  '5': {\r\n    statusId: 5,\r\n    statusText: 'Đã giao hàng/Chưa đối soát',\r\n    deliveryStatus: 'Đã giao hàng',\r\n    description: 'Giao hàng thành công, chưa đối soát',\r\n    canCancel: false,\r\n    shouldUpdateStock: true,\r\n    stockAction: 'complete',\r\n    isFinal: false,\r\n  },\r\n  '6': {\r\n    statusId: 6,\r\n    statusText: 'Đã đối soát',\r\n    deliveryStatus: 'Đã giao hàng',\r\n    description: 'Đã đối soát COD với GHTK',\r\n    canCancel: false,\r\n    shouldUpdateStock: false,\r\n    isFinal: true,\r\n  },\r\n  '7': {\r\n    statusId: 7,\r\n    statusText: 'Không lấy được hàng',\r\n    deliveryStatus: 'Chờ giao lại',\r\n    description: 'Shipper không lấy được hàng từ người gửi',\r\n    canCancel: false,\r\n    shouldUpdateStock: true,\r\n    stockAction: 'return',\r\n    isFinal: false,\r\n  },\r\n  '8': {\r\n    statusId: 8,\r\n    statusText: 'Hoãn lấy hàng',\r\n    deliveryStatus: 'Chờ lấy hàng',\r\n    description: 'Lấy hàng bị hoãn, sẽ lấy lại sau',\r\n    canCancel: false,\r\n    shouldUpdateStock: false,\r\n    isFinal: false,\r\n  },\r\n  '9': {\r\n    statusId: 9,\r\n    statusText: 'Không giao được hàng',\r\n    deliveryStatus: 'Chờ giao lại',\r\n    description: 'Giao hàng thất bại, sẽ giao lại hoặc trả hàng',\r\n    canCancel: false,\r\n    shouldUpdateStock: true,\r\n    stockAction: 'return',\r\n    isFinal: false,\r\n  },\r\n  '10': {\r\n    statusId: 10,\r\n    statusText: 'Delay giao hàng',\r\n    deliveryStatus: 'Đang giao hàng',\r\n    description: 'Giao hàng bị chậm trễ',\r\n    canCancel: false,\r\n    shouldUpdateStock: false,\r\n    isFinal: false,\r\n  },\r\n  '11': {\r\n    statusId: 11,\r\n    statusText: 'Đã đối soát công nợ trả hàng',\r\n    deliveryStatus: 'Chờ giao lại',\r\n    description: 'Đã đối soát tiền trả hàng',\r\n    canCancel: false,\r\n    shouldUpdateStock: false,\r\n    isFinal: true,\r\n  },\r\n  '12': {\r\n    statusId: 12,\r\n    statusText: 'Đã điều phối lấy hàng/Đang lấy hàng',\r\n    deliveryStatus: 'Chờ lấy hàng',\r\n    description: 'Shipper đang trên đường đến lấy hàng',\r\n    canCancel: true,\r\n    shouldUpdateStock: false,\r\n    isFinal: false,\r\n  },\r\n  '13': {\r\n    statusId: 13,\r\n    statusText: 'Đơn hàng bồi hoàn',\r\n    deliveryStatus: 'Chờ giao lại',\r\n    description: 'Đơn hàng bị mất/hỏng, đang xử lý bồi hoàn',\r\n    canCancel: false,\r\n    shouldUpdateStock: true,\r\n    stockAction: 'return',\r\n    isFinal: true,\r\n  },\r\n  '20': {\r\n    statusId: 20,\r\n    statusText: 'Đang trả hàng (COD cầm hàng đi trả)',\r\n    deliveryStatus: 'Chờ giao lại',\r\n    description: 'Shipper đang mang hàng về trả người gửi',\r\n    canCancel: false,\r\n    shouldUpdateStock: true,\r\n    stockAction: 'return',\r\n    isFinal: false,\r\n  },\r\n  '21': {\r\n    statusId: 21,\r\n    statusText: 'Đã trả hàng (COD đã trả xong hàng)',\r\n    deliveryStatus: 'Chờ giao lại',\r\n    description: 'Đã trả hàng về cho người gửi',\r\n    canCancel: false,\r\n    shouldUpdateStock: false,\r\n    isFinal: true,\r\n  },\r\n  '123': {\r\n    statusId: 123,\r\n    statusText: 'Shipper báo đã lấy hàng',\r\n    deliveryStatus: 'Chờ lấy hàng',\r\n    description: 'Shipper cập nhật đã lấy hàng (chưa xác nhận)',\r\n    canCancel: false,\r\n    shouldUpdateStock: false,\r\n    isFinal: false,\r\n  },\r\n  '127': {\r\n    statusId: 127,\r\n    statusText: 'Shipper báo không lấy được hàng',\r\n    deliveryStatus: 'Chờ lấy hàng',\r\n    description: 'Shipper báo không lấy được (chưa xác nhận)',\r\n    canCancel: false,\r\n    shouldUpdateStock: false,\r\n    isFinal: false,\r\n  },\r\n  '128': {\r\n    statusId: 128,\r\n    statusText: 'Shipper báo delay lấy hàng',\r\n    deliveryStatus: 'Chờ lấy hàng',\r\n    description: 'Shipper báo hoãn lấy hàng (chưa xác nhận)',\r\n    canCancel: false,\r\n    shouldUpdateStock: false,\r\n    isFinal: false,\r\n  },\r\n  '45': {\r\n    statusId: 45,\r\n    statusText: 'Shipper báo đã giao hàng',\r\n    deliveryStatus: 'Đang giao hàng',\r\n    description: 'Shipper cập nhật đã giao (chưa xác nhận)',\r\n    canCancel: false,\r\n    shouldUpdateStock: false,\r\n    isFinal: false,\r\n  },\r\n  '49': {\r\n    statusId: 49,\r\n    statusText: 'Shipper báo không giao được hàng',\r\n    deliveryStatus: 'Đang giao hàng',\r\n    description: 'Shipper báo giao thất bại (chưa xác nhận)',\r\n    canCancel: false,\r\n    shouldUpdateStock: false,\r\n    isFinal: false,\r\n  },\r\n  '410': {\r\n    statusId: 410,\r\n    statusText: 'Shipper báo delay giao hàng',\r\n    deliveryStatus: 'Đang giao hàng',\r\n    description: 'Shipper báo hoãn giao hàng (chưa xác nhận)',\r\n    canCancel: false,\r\n    shouldUpdateStock: false,\r\n    isFinal: false,\r\n  },\r\n};\r\n\r\n/**\r\n * Reason code mappings\r\n */\r\nexport const GHTK_REASON_MAP: Record<GHTKReasonCode, string> = {\r\n  // Chậm lấy hàng (100-107)\r\n  '100': 'Nhà cung cấp (NCC) hẹn lấy vào ca tiếp theo',\r\n  '101': 'GHTK không liên lạc được với NCC',\r\n  '102': 'NCC chưa có hàng',\r\n  '103': 'NCC đổi địa chỉ',\r\n  '104': 'NCC hẹn ngày lấy hàng',\r\n  '105': 'GHTK quá tải, không lấy kịp',\r\n  '106': 'Do điều kiện thời tiết, khách quan',\r\n  '107': 'Lý do khác',\r\n  \r\n  // Không lấy được hàng (110-115)\r\n  '110': 'Địa chỉ ngoài vùng phục vụ',\r\n  '111': 'Hàng không nhận vận chuyển',\r\n  '112': 'NCC báo hủy',\r\n  '113': 'NCC hoãn/không liên lạc được 3 lần',\r\n  '114': 'Lý do khác',\r\n  '115': 'Đối tác hủy đơn qua API',\r\n  \r\n  // Chậm giao hàng (120-1200)\r\n  '120': 'GHTK quá tải, giao không kịp',\r\n  '121': 'Người nhận hàng hẹn giao ca tiếp theo',\r\n  '122': 'Không gọi được cho người nhận hàng',\r\n  '123': 'Người nhận hàng hẹn ngày giao',\r\n  '124': 'Người nhận hàng chuyển địa chỉ nhận mới',\r\n  '125': 'Địa chỉ người nhận sai, cần NCC check lại',\r\n  '126': 'Do điều kiện thời tiết, khách quan',\r\n  '127': 'Lý do khác',\r\n  '128': 'Đối tác hẹn thời gian giao hàng',\r\n  '129': 'Không tìm thấy hàng',\r\n  '1200': 'SĐT người nhận sai, cần NCC check lại',\r\n  \r\n  // Không giao được hàng (130-135)\r\n  '130': 'Người nhận không đồng ý nhận sản phẩm',\r\n  '131': 'Không liên lạc được với KH 3 lần',\r\n  '132': 'KH hẹn giao lại quá 3 lần',\r\n  '133': 'Shop báo hủy đơn hàng',\r\n  '134': 'Lý do khác',\r\n  '135': 'Đối tác hủy đơn qua API',\r\n  \r\n  // Delay trả hàng (140-144)\r\n  '140': 'NCC hẹn trả ca sau',\r\n  '141': 'Không liên lạc được với NCC',\r\n  '142': 'NCC không có nhà',\r\n  '143': 'NCC hẹn ngày trả',\r\n  '144': 'Lý do khác',\r\n};\r\n\r\n/**\r\n * Helper functions\r\n */\r\n\r\nexport function getGHTKStatusInfo(statusId: number): GHTKStatusMapping | null {\r\n  return GHTK_STATUS_MAP[statusId as GHTKStatusId] || null;\r\n}\r\n\r\n/**\r\n * Get GHTK status text\r\n */\r\nexport function getGHTKStatusText(statusId: number): string {\r\n  const info = getGHTKStatusInfo(statusId);\r\n  return info?.statusText || `Trạng thái #${statusId}`;\r\n}\r\n\r\nexport function getGHTKReasonText(reasonCode: string): string {\r\n  return GHTK_REASON_MAP[reasonCode as GHTKReasonCode] || reasonCode;\r\n}\r\n\r\nexport function canCancelGHTKShipment(statusId?: number): boolean {\r\n  if (!statusId) return false;\r\n  const info = getGHTKStatusInfo(statusId);\r\n  return info?.canCancel || false;\r\n}\r\n\r\nexport function shouldSyncGHTKStatus(statusId?: number): boolean {\r\n  if (!statusId) return true; // Sync nếu chưa có status\r\n  const info = getGHTKStatusInfo(statusId);\r\n  return !info?.isFinal; // Sync nếu chưa đến trạng thái cuối\r\n}\r\n\r\n/**\r\n * Badge variant for UI\r\n */\r\nexport function getGHTKStatusVariant(statusId?: number): 'default' | 'secondary' | 'success' | 'destructive' | 'warning' {\r\n  if (!statusId) return 'secondary';\r\n  \r\n  const info = getGHTKStatusInfo(statusId);\r\n  if (!info) return 'secondary';\r\n  \r\n  // Đã giao hàng, đã đối soát\r\n  if ([5, 6].includes(statusId)) return 'success';\r\n  \r\n  // Hủy, không lấy/giao được, bồi hoàn\r\n  if ([-1, 7, 9, 13].includes(statusId)) return 'destructive';\r\n  \r\n  // Delay, hoãn\r\n  if ([8, 10].includes(statusId)) return 'warning';\r\n  \r\n  // Đang xử lý\r\n  if ([3, 4, 12].includes(statusId)) return 'default';\r\n  \r\n  return 'secondary';\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1268, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/lib/print-service.ts"],"sourcesContent":["import { usePrintTemplateStore } from '@/features/settings/printer/store';\r\nimport { TemplateType, PaperSize } from '@/features/settings/printer/types';\r\nimport { formatDateForDisplay, formatTimeForDisplay, formatDateTimeForDisplay } from '@/lib/date-utils';\r\nimport { getGeneralSettingsSync } from '@/lib/settings-cache';\r\n\r\n// ============================================\r\n// HELPER FUNCTIONS\r\n// ============================================\r\n\r\n/**\r\n * Lấy general-settings từ cache (loaded from database)\r\n */\r\nexport function getGeneralSettings(): {\r\n  companyName?: string;\r\n  companyAddress?: string;\r\n  phoneNumber?: string;\r\n  email?: string;\r\n  website?: string;\r\n  taxCode?: string;\r\n  logoUrl?: string;\r\n  storeName?: string;\r\n  storeAddress?: string;\r\n  storePhone?: string;\r\n} | null {\r\n  try {\r\n    const settings = getGeneralSettingsSync();\r\n    return {\r\n      companyName: settings.storeName,\r\n      companyAddress: settings.storeAddress,\r\n      phoneNumber: settings.storePhone,\r\n      storeName: settings.storeName,\r\n      storeAddress: settings.storeAddress,\r\n      storePhone: settings.storePhone,\r\n      logoUrl: settings.logoUrl,\r\n    };\r\n  } catch (e) { /* ignore */ }\r\n  return null;\r\n}\r\n\r\n/**\r\n * Lấy logo từ general-settings (fallback khi storeInfo không có logo)\r\n */\r\nexport function getStoreLogo(storeInfoLogo?: string): string | undefined {\r\n  if (storeInfoLogo) return storeInfoLogo;\r\n  try {\r\n    const settings = getGeneralSettingsSync();\r\n    return settings.logoUrl || undefined;\r\n  } catch (e) { /* ignore */ }\r\n  return undefined;\r\n}\r\n\r\n/**\r\n * Format số tiền theo định dạng VN\r\n */\r\nexport function formatCurrency(amount: number | undefined | null): string {\r\n  if (amount === undefined || amount === null) return '0';\r\n  return new Intl.NumberFormat('vi-VN').format(amount);\r\n}\r\n\r\n/**\r\n * Chuyển số sang chữ tiếng Việt\r\n */\r\nexport function numberToWords(amount: number | undefined | null): string {\r\n  if (!amount || amount === 0) return 'Không đồng';\r\n  \r\n  const units = ['', 'một', 'hai', 'ba', 'bốn', 'năm', 'sáu', 'bảy', 'tám', 'chín'];\r\n  const positions = ['', 'nghìn', 'triệu', 'tỷ', 'nghìn tỷ', 'triệu tỷ'];\r\n  \r\n  const readThreeDigits = (num: number): string => {\r\n    const hundred = Math.floor(num / 100);\r\n    const ten = Math.floor((num % 100) / 10);\r\n    const unit = num % 10;\r\n    \r\n    let result = '';\r\n    \r\n    if (hundred > 0) {\r\n      result += units[hundred] + ' trăm ';\r\n    }\r\n    \r\n    if (ten > 1) {\r\n      result += units[ten] + ' mươi ';\r\n      if (unit === 1) {\r\n        result += 'mốt ';\r\n      } else if (unit === 5) {\r\n        result += 'lăm ';\r\n      } else if (unit > 0) {\r\n        result += units[unit] + ' ';\r\n      }\r\n    } else if (ten === 1) {\r\n      result += 'mười ';\r\n      if (unit === 5) {\r\n        result += 'lăm ';\r\n      } else if (unit > 0) {\r\n        result += units[unit] + ' ';\r\n      }\r\n    } else if (ten === 0 && hundred > 0 && unit > 0) {\r\n      result += 'lẻ ' + units[unit] + ' ';\r\n    } else if (unit > 0) {\r\n      result += units[unit] + ' ';\r\n    }\r\n    \r\n    return result.trim();\r\n  };\r\n  \r\n  let result = '';\r\n  let num = Math.abs(Math.round(amount));\r\n  let posIndex = 0;\r\n  \r\n  while (num > 0) {\r\n    const threeDigits = num % 1000;\r\n    if (threeDigits > 0) {\r\n      const words = readThreeDigits(threeDigits);\r\n      result = words + ' ' + positions[posIndex] + ' ' + result;\r\n    }\r\n    num = Math.floor(num / 1000);\r\n    posIndex++;\r\n  }\r\n  \r\n  result = result.trim();\r\n  // Capitalize first letter\r\n  result = result.charAt(0).toUpperCase() + result.slice(1) + ' đồng';\r\n  \r\n  if (amount < 0) {\r\n    result = 'Âm ' + result;\r\n  }\r\n  \r\n  return result;\r\n}\r\n\r\n/**\r\n * Format ngày theo định dạng dd/MM/yyyy\r\n * Uses centralized date-utils for consistent formatting\r\n */\r\nexport function formatDate(date: string | Date | undefined | null): string {\r\n  return formatDateForDisplay(date);\r\n}\r\n\r\n/**\r\n * Format giờ theo định dạng HH:mm\r\n * Uses centralized date-utils for consistent formatting\r\n */\r\nexport function formatTime(date: string | Date | undefined | null): string {\r\n  return formatTimeForDisplay(date);\r\n}\r\n\r\n/**\r\n * Format ngày giờ đầy đủ\r\n * Uses centralized date-utils for consistent formatting\r\n */\r\nexport function formatDateTime(date: string | Date | undefined | null): string {\r\n  return formatDateTimeForDisplay(date);\r\n}\r\n\r\n// ============================================\r\n// PRINT SERVICE\r\n// ============================================\r\n\r\n/**\r\n * CSS styles cho in ấn\r\n */\r\nconst PRINT_STYLES = `\r\n  * { box-sizing: border-box; }\r\n  body { \r\n    font-family: 'Times New Roman', Times, serif;\r\n    font-size: 13px;\r\n    line-height: 1.5;\r\n    margin: 0;\r\n    padding: 20px;\r\n    color: #000;\r\n  }\r\n  h1, h2, h3, h4 { margin: 0.5em 0; }\r\n  h2 { font-size: 18px; font-weight: bold; }\r\n  p { margin: 0.3em 0; }\r\n  table { \r\n    width: 100%; \r\n    border-collapse: collapse; \r\n    margin: 10px 0;\r\n  }\r\n  th, td { \r\n    border: 1px solid #333; \r\n    padding: 6px 8px; \r\n    text-align: left;\r\n    vertical-align: top;\r\n  }\r\n  th { \r\n    background: #f0f0f0; \r\n    font-weight: bold;\r\n  }\r\n  strong { font-weight: bold; }\r\n  em { font-style: italic; }\r\n  hr { border: none; border-top: 1px solid #333; margin: 10px 0; }\r\n  ul { margin: 0.5em 0; padding-left: 25px; list-style-type: disc; }\r\n  ol { margin: 0.5em 0; padding-left: 25px; list-style-type: decimal; }\r\n  li { margin: 0.2em 0; display: list-item; }\r\n  img { max-width: 100%; height: auto; }\r\n  @media print { \r\n    body { padding: 0; } \r\n    @page { margin: 15mm; }\r\n  }\r\n`;\r\n\r\n/**\r\n * Interface cho dữ liệu in\r\n */\r\nexport interface PrintData {\r\n  [key: string]: string | number | boolean | undefined | null | PrintLineItem[];\r\n}\r\n\r\nexport interface PrintLineItem {\r\n  [key: string]: string | number | boolean | undefined | null;\r\n}\r\n\r\n/**\r\n * Replace tất cả variables trong template với data\r\n */\r\nexport function replaceVariables(template: string, data: PrintData): string {\r\n  let result = template;\r\n  \r\n  // Replace các biến đơn lẻ\r\n  Object.entries(data).forEach(([key, value]) => {\r\n    // Nếu không phải array (line items), replace trực tiếp\r\n    if (!Array.isArray(value)) {\r\n      const placeholder = key.startsWith('{') ? key : `{${key}}`;\r\n      const stringValue = value?.toString() || '';\r\n      result = result.split(placeholder).join(stringValue);\r\n    }\r\n  });\r\n  \r\n  return result;\r\n}\r\n\r\n/**\r\n * Tạo HTML rows cho line items (sản phẩm trong đơn hàng)\r\n * Template row sẽ được nhân bản cho mỗi item\r\n */\r\nexport function generateLineItemsHtml(\r\n  templateRow: string, \r\n  items: PrintLineItem[],\r\n  startIndex: number = 1\r\n): string {\r\n  return items.map((item, index) => {\r\n    let row = templateRow;\r\n    \r\n    // Replace {line_stt} với số thứ tự\r\n    row = row.replace(/{line_stt}/g, (startIndex + index).toString());\r\n    \r\n    // Replace các biến line_* khác\r\n    Object.entries(item).forEach(([key, value]) => {\r\n      const placeholder = key.startsWith('{') ? key : `{${key}}`;\r\n      const stringValue = value?.toString() || '';\r\n      row = row.split(placeholder).join(stringValue);\r\n    });\r\n    \r\n    return row;\r\n  }).join('\\n');\r\n}\r\n\r\n/**\r\n * Tạo nội dung HTML để in từ template và data\r\n */\r\nexport function generatePrintHtml(\r\n  templateType: TemplateType,\r\n  data: PrintData,\r\n  branchId?: string\r\n): string {\r\n  const store = usePrintTemplateStore.getState();\r\n  const defaultSize = store.getDefaultSize(templateType);\r\n  const template = store.getTemplate(templateType, defaultSize, branchId);\r\n  \r\n  let html = template.content;\r\n  \r\n  // Replace variables\r\n  html = replaceVariables(html, data);\r\n  \r\n  return html;\r\n}\r\n\r\n/**\r\n * In document với template\r\n */\r\nexport function printDocument(\r\n  templateType: TemplateType,\r\n  data: PrintData,\r\n  options?: {\r\n    branchId?: string;\r\n    paperSize?: PaperSize;\r\n    title?: string;\r\n  }\r\n): void {\r\n  const store = usePrintTemplateStore.getState();\r\n  const paperSize = options?.paperSize || store.getDefaultSize(templateType);\r\n  const template = store.getTemplate(templateType, paperSize, options?.branchId);\r\n  \r\n  // Generate HTML content\r\n  let html = replaceVariables(template.content, data);\r\n  \r\n  // Tạo iframe ẩn để in\r\n  const printFrame = document.createElement('iframe');\r\n  printFrame.style.position = 'absolute';\r\n  printFrame.style.top = '-10000px';\r\n  printFrame.style.left = '-10000px';\r\n  document.body.appendChild(printFrame);\r\n  \r\n  const printDoc = printFrame.contentDocument || printFrame.contentWindow?.document;\r\n  if (printDoc) {\r\n    const title = options?.title || `In ${templateType}`;\r\n    \r\n    printDoc.write(`\r\n      <!DOCTYPE html>\r\n      <html>\r\n      <head>\r\n        <title>${title}</title>\r\n        <style>${PRINT_STYLES}</style>\r\n      </head>\r\n      <body>${html}</body>\r\n      </html>\r\n    `);\r\n    printDoc.close();\r\n    \r\n    // Đợi load xong rồi in\r\n    setTimeout(() => {\r\n      printFrame.contentWindow?.print();\r\n      // Xóa iframe sau khi in\r\n      setTimeout(() => {\r\n        if (document.body.contains(printFrame)) {\r\n          document.body.removeChild(printFrame);\r\n        }\r\n      }, 1000);\r\n    }, 100);\r\n  }\r\n}\r\n\r\n/**\r\n * Preview document (trả về HTML string)\r\n */\r\nexport function getPreviewHtml(\r\n  templateType: TemplateType,\r\n  data: PrintData,\r\n  options?: {\r\n    branchId?: string;\r\n    paperSize?: PaperSize;\r\n  }\r\n): string {\r\n  const store = usePrintTemplateStore.getState();\r\n  const paperSize = options?.paperSize || store.getDefaultSize(templateType);\r\n  const template = store.getTemplate(templateType, paperSize, options?.branchId);\r\n  \r\n  return replaceVariables(template.content, data);\r\n}\r\n\r\n// ============================================\r\n// DATA MAPPERS - Chuyển đổi data từ entity sang print data\r\n// ============================================\r\n\r\n/**\r\n * Base interface cho store settings (cần import từ settings store)\r\n */\r\nexport interface StoreSettings {\r\n  name?: string;\r\n  address?: string;\r\n  phone?: string;\r\n  hotline?: string;\r\n  email?: string;\r\n  logo?: string;\r\n  fax?: string;\r\n  province?: string;\r\n  website?: string;\r\n  taxCode?: string;\r\n}\r\n\r\n/**\r\n * Tạo data cho thông tin cửa hàng\r\n */\r\nexport function getStoreData(settings: StoreSettings): PrintData {\r\n  const now = new Date();\r\n  const logo = getStoreLogo(settings.logo);\r\n  return {\r\n    '{store_logo}': logo \r\n      ? `<img src=\"${logo}\" alt=\"Logo\" style=\"max-height:60px\"/>` \r\n      : '',\r\n    '{store_name}': settings.name || '',\r\n    '{store_address}': settings.address || '',\r\n    '{store_phone_number}': settings.phone || '',\r\n    '{hotline}': settings.hotline || settings.phone || '',\r\n    '{store_hotline}': settings.hotline || settings.phone || '',\r\n    '{store_email}': settings.email || '',\r\n    '{store_fax}': settings.fax || '',\r\n    '{store_website}': settings.website || '',\r\n    '{store_tax_code}': settings.taxCode || '',\r\n    // Print timestamp - always inject current time\r\n    '{print_date}': formatDate(now),\r\n    '{print_time}': formatTime(now),\r\n  };\r\n}\r\n\r\n/**\r\n * Export default cho tiện import\r\n */\r\nexport const PrintService = {\r\n  formatCurrency,\r\n  numberToWords,\r\n  formatDate,\r\n  formatTime,\r\n  formatDateTime,\r\n  replaceVariables,\r\n  generateLineItemsHtml,\r\n  generatePrintHtml,\r\n  printDocument,\r\n  getPreviewHtml,\r\n  getStoreData,\r\n  getStoreLogo,\r\n};\r\n\r\nexport default PrintService;\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1578, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/lib/use-print.ts"],"sourcesContent":["/**\r\n * Hook để sử dụng Print Service trong các component\r\n */\r\n\r\nimport * as React from 'react';\r\nimport type { TemplateType, PaperSize } from '../features/settings/printer/types';\r\nimport { \r\n  PrintData, \r\n  PrintLineItem,\r\n  replaceVariables,\r\n} from './print-service';\r\nimport { usePrintTemplateStore } from '../features/settings/printer/store';\r\n\r\ninterface PrintOptions {\r\n  /** Dữ liệu để thay thế biến trong template */\r\n  data: PrintData;\r\n  /** Line items (sản phẩm, hàng hóa) */\r\n  lineItems?: PrintLineItem[];\r\n  /** Khổ giấy cụ thể (nếu muốn override default) */\r\n  paperSize?: PaperSize;\r\n  /** Branch ID cụ thể (nếu muốn override current branch) */\r\n  branchId?: string;\r\n}\r\n\r\ninterface UsePrintResult {\r\n  /** Hàm in tài liệu */\r\n  print: (type: TemplateType, options: PrintOptions) => void;\r\n  /** Hàm in nhiều tài liệu cùng lúc (gộp thành 1 document) */\r\n  printMultiple: (type: TemplateType, optionsList: PrintOptions[]) => void;\r\n  /** Hàm in nhiều loại tài liệu khác nhau cùng lúc (gộp thành 1 popup) */\r\n  printMixedDocuments: (documents: Array<{ type: TemplateType; options: PrintOptions }>) => void;\r\n  /** Hàm lấy HTML preview */\r\n  getPreview: (type: TemplateType, options: PrintOptions) => string;\r\n  /** Kiểm tra template có tồn tại không */\r\n  hasTemplate: (type: TemplateType, paperSize?: PaperSize) => boolean;\r\n  /** Lấy danh sách khổ giấy có template */\r\n  getAvailableSizes: (type: TemplateType) => PaperSize[];\r\n  /** Lấy khổ giấy mặc định cho loại template */\r\n  getDefaultSize: (type: TemplateType) => PaperSize;\r\n  /** Đang loading template store */\r\n  isLoading: boolean;\r\n}\r\n\r\n/**\r\n * Kiểm tra giá trị có \"empty\" không (null, undefined, '', '0', 0)\r\n */\r\nfunction isEmptyValue(value: unknown): boolean {\r\n  if (value === undefined || value === null || value === '') return true;\r\n  // Coi '0' và các biến thể như empty\r\n  const strValue = String(value).trim();\r\n  if (strValue === '0' || strValue === '0đ' || strValue === '0 đ') return true;\r\n  return false;\r\n}\r\n\r\n/**\r\n * Xử lý các điều kiện trong template\r\n * Hỗ trợ:\r\n * - {{#if has_tax}}...{{/if}} - Điều kiện boolean\r\n * - {{#if_empty {field}}}...{{/if_empty}} - Nếu field rỗng\r\n * - {{#if_not_empty {field}}}...{{/if_not_empty}} - Nếu field không rỗng\r\n * - {{#if_gt {field} value}}...{{/if_gt}} - Nếu field > value (greater than)\r\n */\r\nfunction processConditionals(html: string, data: PrintData, lineItems?: PrintLineItem[]): string {\r\n  let result = html;\r\n\r\n  // 1. Xử lý {{#if_not_empty {field}}}...{{/if_not_empty}}\r\n  const ifNotEmptyPattern = /\\{\\{#if_not_empty\\s+\\{([^}]+)\\}\\}\\}([\\s\\S]*?)\\{\\{\\/if_not_empty\\}\\}/gi;\r\n  result = result.replace(ifNotEmptyPattern, (match, field, content) => {\r\n    const key = `{${field}}`;\r\n    const value = data[key];\r\n    if (!isEmptyValue(value)) {\r\n      return content;\r\n    }\r\n    return '';\r\n  });\r\n\r\n  // 2. Xử lý {{#if_empty {field}}}...{{/if_empty}}\r\n  const ifEmptyPattern = /\\{\\{#if_empty\\s+\\{([^}]+)\\}\\}\\}([\\s\\S]*?)\\{\\{\\/if_empty\\}\\}/gi;\r\n  result = result.replace(ifEmptyPattern, (match, field, content) => {\r\n    const key = `{${field}}`;\r\n    const value = data[key];\r\n    if (isEmptyValue(value)) {\r\n      return content;\r\n    }\r\n    return '';\r\n  });\r\n\r\n  // 3. Xử lý {{#if_gt {field} value}}...{{/if_gt}} (greater than 0)\r\n  const ifGtPattern = /\\{\\{#if_gt\\s+\\{([^}]+)\\}\\s+(\\d+)\\}\\}([\\s\\S]*?)\\{\\{\\/if_gt\\}\\}/gi;\r\n  result = result.replace(ifGtPattern, (match, field, compareValue, content) => {\r\n    const key = `{${field}}`;\r\n    const value = data[key];\r\n    // Parse số từ giá trị (loại bỏ dấu chấm, đ, etc.)\r\n    const numValue = parseFloat((value || '0').toString().replace(/[^\\d.-]/g, ''));\r\n    const numCompare = parseFloat(compareValue);\r\n    if (numValue > numCompare) {\r\n      return content;\r\n    }\r\n    return '';\r\n  });\r\n\r\n  // 4. Xử lý {{#if has_tax}}...{{/if}} - Boolean conditions\r\n  // has_tax = true nếu total_tax > 0\r\n  const hasTax = !isEmptyValue(data['{total_tax}']);\r\n  const hasDiscount = !isEmptyValue(data['{total_discount}']);\r\n  const hasDeliveryFee = !isEmptyValue(data['{delivery_fee}']);\r\n  const hasNote = !isEmptyValue(data['{order_note}']);\r\n\r\n  const booleanConditions: Record<string, boolean> = {\r\n    'has_tax': hasTax,\r\n    'has_discount': hasDiscount,\r\n    'has_delivery_fee': hasDeliveryFee,\r\n    'has_note': hasNote,\r\n    'has_shipping_address': !isEmptyValue(data['{shipping_address}']),\r\n    'has_customer_email': !isEmptyValue(data['{customer_email}']),\r\n    'has_customer_phone': !isEmptyValue(data['{customer_phone_number}']),\r\n  };\r\n\r\n  // Xử lý {{#if condition}}...{{/if}}\r\n  const ifPattern = /\\{\\{#if\\s+(\\w+)\\}\\}([\\s\\S]*?)\\{\\{\\/if\\}\\}/gi;\r\n  result = result.replace(ifPattern, (match, condition, content) => {\r\n    if (booleanConditions[condition]) {\r\n      return content;\r\n    }\r\n    return '';\r\n  });\r\n\r\n  // 5. Xử lý {{#unless condition}}...{{/unless}} (ngược lại với if)\r\n  const unlessPattern = /\\{\\{#unless\\s+(\\w+)\\}\\}([\\s\\S]*?)\\{\\{\\/unless\\}\\}/gi;\r\n  result = result.replace(unlessPattern, (match, condition, content) => {\r\n    if (!booleanConditions[condition]) {\r\n      return content;\r\n    }\r\n    return '';\r\n  });\r\n\r\n  return result;\r\n}\r\n\r\n/**\r\n * Xử lý điều kiện cho line items\r\n * Ví dụ: {{#line_if_not_empty {line_tax_amount}}}...{{/line_if_not_empty}}\r\n */\r\nfunction processLineItemConditionals(rowHtml: string, item: PrintLineItem): string {\r\n  let result = rowHtml;\r\n\r\n  // Xử lý {{#line_if_not_empty {field}}}...{{/line_if_not_empty}}\r\n  const lineIfNotEmptyPattern = /\\{\\{#line_if_not_empty\\s+\\{([^}]+)\\}\\}\\}([\\s\\S]*?)\\{\\{\\/line_if_not_empty\\}\\}/gi;\r\n  result = result.replace(lineIfNotEmptyPattern, (match, field, content) => {\r\n    const key = `{${field}}`;\r\n    const value = item[key];\r\n    if (!isEmptyValue(value)) {\r\n      return content;\r\n    }\r\n    return '';\r\n  });\r\n\r\n  // Xử lý {{#line_if_empty {field}}}...{{/line_if_empty}}\r\n  const lineIfEmptyPattern = /\\{\\{#line_if_empty\\s+\\{([^}]+)\\}\\}\\}([\\s\\S]*?)\\{\\{\\/line_if_empty\\}\\}/gi;\r\n  result = result.replace(lineIfEmptyPattern, (match, field, content) => {\r\n    const key = `{${field}}`;\r\n    const value = item[key];\r\n    if (isEmptyValue(value)) {\r\n      return content;\r\n    }\r\n    return '';\r\n  });\r\n\r\n  return result;\r\n}\r\n\r\n/**\r\n * Hook để sử dụng chức năng in trong các trang\r\n * @param currentBranchId - ID của branch hiện tại (optional)\r\n * @example\r\n * const { print, getPreview } = usePrint(currentBranch?.systemId);\r\n * \r\n * // In đơn hàng\r\n * print('order', {\r\n *   data: mapOrderToPrintData(order, storeSettings),\r\n *   lineItems: mapOrderLineItems(order.items),\r\n * });\r\n */\r\nexport function usePrint(currentBranchId?: string): UsePrintResult {\r\n  const templateStore = usePrintTemplateStore();\r\n  const [isLoading] = React.useState(false);\r\n\r\n  const getTemplateContent = React.useCallback((\r\n    type: TemplateType, \r\n    paperSize?: PaperSize, \r\n    branchId?: string\r\n  ): string | null => {\r\n    // Xác định paperSize sử dụng\r\n    const size = paperSize || templateStore.getDefaultSize(type);\r\n    const branch = branchId || currentBranchId;\r\n\r\n    // Lấy template\r\n    const template = templateStore.getTemplate(type, size, branch);\r\n    if (template?.content) {\r\n      return template.content;\r\n    }\r\n\r\n    // Fallback: thử lấy template không có branch\r\n    const defaultTemplate = templateStore.getTemplate(type, size);\r\n    return defaultTemplate?.content || null;\r\n  }, [templateStore, currentBranchId]);\r\n\r\n  const processTemplate = React.useCallback((\r\n    templateContent: string,\r\n    data: PrintData,\r\n    lineItems?: PrintLineItem[]\r\n  ): string => {\r\n    // Bước 1: Xử lý line items nếu có\r\n    let html = templateContent;\r\n    \r\n    console.log('[processTemplate] Starting, lineItems count:', lineItems?.length);\r\n    \r\n    if (lineItems && lineItems.length > 0) {\r\n      // === XỬ LÝ CÚ PHÁP {{#line_items}}...{{/line_items}} ===\r\n      // Dành cho template lặp toàn bộ section (mỗi employee 1 page)\r\n      const lineItemsBlockPattern = /\\{\\{#line_items\\}\\}([\\s\\S]*?)\\{\\{\\/line_items\\}\\}/gi;\r\n      const lineItemsBlockMatch = html.match(lineItemsBlockPattern);\r\n      \r\n      console.log('[processTemplate] Block match found:', !!lineItemsBlockMatch, lineItemsBlockMatch?.length);\r\n      \r\n      if (lineItemsBlockMatch && lineItemsBlockMatch.length > 0) {\r\n        // Có block {{#line_items}} - lặp cả block cho mỗi item\r\n        html = html.replace(lineItemsBlockPattern, (match, blockContent) => {\r\n          return lineItems.map((item, index) => {\r\n            let itemHtml = blockContent;\r\n            \r\n            // Thêm {line_index}\r\n            itemHtml = itemHtml.replace(/\\{line_index\\}/g, String(index + 1));\r\n            \r\n            // Replace các biến từ item (line item data)\r\n            Object.entries(item).forEach(([key, value]) => {\r\n              const placeholder = key.startsWith('{') ? key : `{${key}}`;\r\n              const regex = new RegExp(placeholder.replace(/[{}]/g, '\\\\$&'), 'g');\r\n              itemHtml = itemHtml.replace(regex, value?.toString() || '');\r\n            });\r\n            \r\n            // Replace các biến global (data) cho mỗi item page\r\n            Object.entries(data).forEach(([key, value]) => {\r\n              const placeholder = key.startsWith('{') ? key : `{${key}}`;\r\n              const regex = new RegExp(placeholder.replace(/[{}]/g, '\\\\$&'), 'g');\r\n              itemHtml = itemHtml.replace(regex, value?.toString() || '');\r\n            });\r\n            \r\n            return itemHtml;\r\n          }).join('\\n');\r\n        });\r\n        \r\n        // Đã xử lý xong line items theo block mode, skip table mode\r\n      } else {\r\n        // === XỬ LÝ TABLE MODE (cũ) ===\r\n        // Tìm tất cả các table trong template\r\n        const tablePattern = /<table[^>]*>[\\s\\S]*?<\\/table>/gi;\r\n        const tables = html.match(tablePattern);\r\n      \r\n        if (tables) {\r\n          // Tìm table chứa {line_stt} - đây là bảng line items\r\n          const lineItemsTable = tables.find(table => table.includes('{line_stt}'));\r\n        \r\n          if (lineItemsTable) {\r\n            // Tìm tbody trong table này\r\n            let tbodyMatch = lineItemsTable.match(/<tbody[^>]*>([\\s\\S]*?)<\\/tbody>/i);\r\n          \r\n            // Nếu không có tbody, có thể table chỉ có tr trực tiếp\r\n            // (một số template không dùng thead/tbody)\r\n            if (!tbodyMatch) {\r\n              // Tìm tất cả tr trong table (trừ tr trong thead)\r\n              const theadMatch = lineItemsTable.match(/<thead[^>]*>[\\s\\S]*?<\\/thead>/i);\r\n              let tableWithoutThead = lineItemsTable;\r\n              if (theadMatch) {\r\n                tableWithoutThead = lineItemsTable.replace(theadMatch[0], '');\r\n              }\r\n            \r\n              // Tìm tr chứa {line_stt}\r\n              const rowPattern = /<tr[^>]*>[\\s\\S]*?\\{line_stt\\}[\\s\\S]*?<\\/tr>/i;\r\n              const rowMatch = tableWithoutThead.match(rowPattern);\r\n            \r\n              if (rowMatch) {\r\n                const templateRow = rowMatch[0];\r\n              \r\n                // Tạo các row mới từ template\r\n                const rowsHtml = lineItems.map((item) => {\r\n                  let row = templateRow;\r\n                \r\n                  // Xử lý điều kiện cho line item trước\r\n                  row = processLineItemConditionals(row, item);\r\n                \r\n                  Object.entries(item).forEach(([key, value]) => {\r\n                    const placeholder = key.startsWith('{') ? key : `{${key}}`;\r\n                    const regex = new RegExp(placeholder.replace(/[{}]/g, '\\\\$&'), 'g');\r\n                    row = row.replace(regex, value?.toString() || '');\r\n                  });\r\n                  return row;\r\n                }).join('\\n    ');\r\n              \r\n                // Thay thế row mẫu bằng các rows mới\r\n                const newTable = lineItemsTable.replace(templateRow, rowsHtml);\r\n                html = html.replace(lineItemsTable, newTable);\r\n              }\r\n            } else {\r\n              // Có tbody - xử lý như cũ\r\n              const tbodyContent = tbodyMatch[1];\r\n            \r\n              // Tìm TẤT CẢ các row trong tbody\r\n              const allRowsPattern = /<tr[^>]*>[\\s\\S]*?<\\/tr>/gi;\r\n              const allRows = tbodyContent.match(allRowsPattern);\r\n            \r\n              if (allRows && allRows.length > 0) {\r\n                // Tìm row chứa {line_stt} - đây là row mẫu\r\n                const templateRow = allRows.find(row => row.includes('{line_stt}')) || allRows[0];\r\n              \r\n                // Tạo các row mới từ template\r\n                const rowsHtml = lineItems.map((item) => {\r\n                  let row = templateRow;\r\n                \r\n                  // Xử lý điều kiện cho line item trước\r\n                  row = processLineItemConditionals(row, item);\r\n                \r\n                  // Replace từng biến trong item\r\n                  Object.entries(item).forEach(([key, value]) => {\r\n                    const placeholder = key.startsWith('{') ? key : `{${key}}`;\r\n                    const regex = new RegExp(placeholder.replace(/[{}]/g, '\\\\$&'), 'g');\r\n                    row = row.replace(regex, value?.toString() || '');\r\n                  });\r\n                \r\n                  return row;\r\n                }).join('\\n    ');\r\n              \r\n                // Tạo tbody mới\r\n                const newTbody = `<tbody>\\n    ${rowsHtml}\\n  </tbody>`;\r\n              \r\n                // Thay thế tbody cũ trong table\r\n                const newTable = lineItemsTable.replace(tbodyMatch[0], newTbody);\r\n              \r\n                // Thay thế table cũ bằng table mới trong html\r\n                html = html.replace(lineItemsTable, newTable);\r\n              }\r\n            }\r\n          }\r\n        }\r\n      } // End of else (TABLE MODE)\r\n    }\r\n\r\n    // Bước 2: Xử lý các điều kiện (conditionals)\r\n    html = processConditionals(html, data, lineItems);\r\n\r\n    // Bước 3: Thay thế các biến còn lại\r\n    html = replaceVariables(html, data);\r\n\r\n    return html;\r\n  }, []);\r\n\r\n  const print = React.useCallback((type: TemplateType, options: PrintOptions) => {\r\n    const { data, lineItems, paperSize, branchId } = options;\r\n\r\n    console.log('[usePrint] Starting print for type:', type);\r\n    console.log('[usePrint] Data keys:', Object.keys(data));\r\n    console.log('[usePrint] LineItems count:', lineItems?.length || 0);\r\n\r\n    // Lấy template content\r\n    const size = paperSize || templateStore.getDefaultSize(type);\r\n    const templateContent = getTemplateContent(type, size, branchId);\r\n    \r\n    if (!templateContent) {\r\n      console.error(`[usePrint] No template found for type: ${type}`);\r\n      return;\r\n    }\r\n\r\n    console.log('[usePrint] Template found, length:', templateContent.length);\r\n\r\n    // Xử lý template\r\n    let html: string;\r\n    try {\r\n      html = processTemplate(templateContent, data, lineItems);\r\n      console.log('[usePrint] Template processed, html length:', html.length);\r\n    } catch (err) {\r\n      console.error('[usePrint] Error processing template:', err);\r\n      return;\r\n    }\r\n\r\n    // Tạo iframe ẩn để in\r\n    const printFrame = document.createElement('iframe');\r\n    printFrame.style.position = 'absolute';\r\n    printFrame.style.top = '-10000px';\r\n    printFrame.style.left = '-10000px';\r\n    document.body.appendChild(printFrame);\r\n    \r\n    const printDoc = printFrame.contentDocument || printFrame.contentWindow?.document;\r\n    if (printDoc) {\r\n      // CSS cơ bản cho print - giống với Settings preview\r\n      const printCSS = `\r\n        body { font-family: Arial, sans-serif; font-size: 12px; line-height: 1.5; }\r\n        table { width: 100%; border-collapse: collapse; margin: 8px 0; }\r\n        th, td { border: 1px solid #333; padding: 6px 8px; }\r\n        th { background-color: #f5f5f5; font-weight: bold; }\r\n        .text-center, [style*=\"text-align: center\"] { text-align: center; }\r\n        .text-right, [style*=\"text-align: right\"] { text-align: right; }\r\n        img { max-width: 100%; height: auto; }\r\n        h1, h2, h3 { margin: 8px 0; }\r\n        p { margin: 4px 0; }\r\n      `;\r\n      \r\n      printDoc.write(`\r\n        <!DOCTYPE html>\r\n        <html>\r\n        <head>\r\n          <title>In ${type}</title>\r\n          <style>${printCSS}</style>\r\n        </head>\r\n        <body>${html}</body>\r\n        </html>\r\n      `);\r\n      printDoc.close();\r\n      \r\n      // Đợi load xong rồi in\r\n      setTimeout(() => {\r\n        printFrame.contentWindow?.print();\r\n        // Xóa iframe sau khi in\r\n        setTimeout(() => {\r\n          if (document.body.contains(printFrame)) {\r\n            document.body.removeChild(printFrame);\r\n          }\r\n        }, 1000);\r\n      }, 100);\r\n    }\r\n  }, [getTemplateContent, processTemplate]);\r\n\r\n  /**\r\n   * In nhiều tài liệu cùng lúc - gộp thành 1 document với page break giữa các tài liệu\r\n   */\r\n  const printMultiple = React.useCallback((type: TemplateType, optionsList: PrintOptions[]) => {\r\n    if (optionsList.length === 0) return;\r\n\r\n    // Lấy template content (dùng paperSize của item đầu tiên hoặc default)\r\n    const firstOptions = optionsList[0];\r\n    const size = firstOptions.paperSize || templateStore.getDefaultSize(type);\r\n    const templateContent = getTemplateContent(type, size, firstOptions.branchId);\r\n    \r\n    if (!templateContent) {\r\n      console.error(`[usePrint] No template found for type: ${type}`);\r\n      return;\r\n    }\r\n\r\n    // Xử lý từng document và gộp lại với page break\r\n    const allHtmlParts = optionsList.map((options, index) => {\r\n      const html = processTemplate(templateContent, options.data, options.lineItems);\r\n      // Thêm page break sau mỗi document (trừ document cuối)\r\n      if (index < optionsList.length - 1) {\r\n        return `<div class=\"print-page\" style=\"page-break-after: always; break-after: page;\">${html}</div>`;\r\n      }\r\n      return `<div class=\"print-page-last\">${html}</div>`;\r\n    });\r\n\r\n    const combinedHtml = allHtmlParts.join('\\n');\r\n\r\n    // Tạo iframe ẩn để in\r\n    const printFrame = document.createElement('iframe');\r\n    printFrame.style.position = 'absolute';\r\n    printFrame.style.top = '-10000px';\r\n    printFrame.style.left = '-10000px';\r\n    document.body.appendChild(printFrame);\r\n    \r\n    const printDoc = printFrame.contentDocument || printFrame.contentWindow?.document;\r\n    if (printDoc) {\r\n      // CSS cơ bản cho print với page break\r\n      const printCSS = `\r\n        * { box-sizing: border-box; }\r\n        body { font-family: Arial, sans-serif; font-size: 12px; line-height: 1.5; margin: 0; padding: 0; }\r\n        table { width: 100%; border-collapse: collapse; margin: 8px 0; }\r\n        th, td { border: 1px solid #333; padding: 6px 8px; }\r\n        th { background-color: #f5f5f5; font-weight: bold; }\r\n        .text-center, [style*=\"text-align: center\"] { text-align: center; }\r\n        .text-right, [style*=\"text-align: right\"] { text-align: right; }\r\n        img { max-width: 100%; height: auto; }\r\n        h1, h2, h3 { margin: 8px 0; }\r\n        p { margin: 4px 0; }\r\n        .print-page { \r\n          page-break-after: always !important; \r\n          break-after: page !important;\r\n          page-break-inside: avoid;\r\n        }\r\n        .print-page-last { \r\n          page-break-after: auto; \r\n        }\r\n        @media print {\r\n          .print-page { \r\n            page-break-after: always !important; \r\n            break-after: page !important;\r\n          }\r\n          .print-page-last { \r\n            page-break-after: auto; \r\n          }\r\n        }\r\n      `;\r\n      \r\n      printDoc.write(`\r\n        <!DOCTYPE html>\r\n        <html>\r\n        <head>\r\n          <title>In ${optionsList.length} ${type}</title>\r\n          <style>${printCSS}</style>\r\n        </head>\r\n        <body>${combinedHtml}</body>\r\n        </html>\r\n      `);\r\n      printDoc.close();\r\n      \r\n      // Đợi load xong rồi in\r\n      setTimeout(() => {\r\n        printFrame.contentWindow?.print();\r\n        // Xóa iframe sau khi in\r\n        setTimeout(() => {\r\n          if (document.body.contains(printFrame)) {\r\n            document.body.removeChild(printFrame);\r\n          }\r\n        }, 1000);\r\n      }, 100);\r\n    }\r\n  }, [templateStore, getTemplateContent, processTemplate]);\r\n\r\n  /**\r\n   * In nhiều loại tài liệu khác nhau cùng lúc - gộp thành 1 popup duy nhất\r\n   * Ví dụ: In đơn hàng + phiếu giao hàng + phiếu đóng gói trong 1 lần\r\n   */\r\n  const printMixedDocuments = React.useCallback((documents: Array<{ type: TemplateType; options: PrintOptions }>) => {\r\n    if (documents.length === 0) return;\r\n\r\n    // Xử lý từng document và gộp lại với page break\r\n    const allHtmlParts: string[] = [];\r\n    \r\n    documents.forEach((doc, docIndex) => {\r\n      const { type, options } = doc;\r\n      const { data, lineItems, paperSize, branchId } = options;\r\n      \r\n      // Lấy template content cho loại này\r\n      const size = paperSize || templateStore.getDefaultSize(type);\r\n      const templateContent = getTemplateContent(type, size, branchId);\r\n      \r\n      if (!templateContent) {\r\n        console.warn(`[printMixedDocuments] No template found for type: ${type}, skipping`);\r\n        return;\r\n      }\r\n      \r\n      const html = processTemplate(templateContent, data, lineItems);\r\n      \r\n      // Thêm page break sau mỗi document (trừ document cuối)\r\n      if (docIndex < documents.length - 1) {\r\n        allHtmlParts.push(`<div class=\"print-page\" style=\"page-break-after: always; break-after: page;\">${html}</div>`);\r\n      } else {\r\n        allHtmlParts.push(`<div class=\"print-page-last\">${html}</div>`);\r\n      }\r\n    });\r\n\r\n    if (allHtmlParts.length === 0) {\r\n      console.error('[printMixedDocuments] No documents to print');\r\n      return;\r\n    }\r\n\r\n    const combinedHtml = allHtmlParts.join('\\n');\r\n\r\n    // Tạo iframe ẩn để in\r\n    const printFrame = document.createElement('iframe');\r\n    printFrame.style.position = 'absolute';\r\n    printFrame.style.top = '-10000px';\r\n    printFrame.style.left = '-10000px';\r\n    document.body.appendChild(printFrame);\r\n    \r\n    const printDoc = printFrame.contentDocument || printFrame.contentWindow?.document;\r\n    if (printDoc) {\r\n      // CSS cơ bản cho print với page break\r\n      const printCSS = `\r\n        * { box-sizing: border-box; }\r\n        body { font-family: Arial, sans-serif; font-size: 12px; line-height: 1.5; margin: 0; padding: 0; }\r\n        table { width: 100%; border-collapse: collapse; margin: 8px 0; }\r\n        th, td { border: 1px solid #333; padding: 6px 8px; }\r\n        th { background-color: #f5f5f5; font-weight: bold; }\r\n        .text-center, [style*=\"text-align: center\"] { text-align: center; }\r\n        .text-right, [style*=\"text-align: right\"] { text-align: right; }\r\n        img { max-width: 100%; height: auto; }\r\n        h1, h2, h3 { margin: 8px 0; }\r\n        p { margin: 4px 0; }\r\n        .print-page { \r\n          page-break-after: always !important; \r\n          break-after: page !important;\r\n          page-break-inside: avoid;\r\n        }\r\n        .print-page-last { \r\n          page-break-after: auto; \r\n        }\r\n        @media print {\r\n          .print-page { \r\n            page-break-after: always !important; \r\n            break-after: page !important;\r\n          }\r\n          .print-page-last { \r\n            page-break-after: auto; \r\n          }\r\n        }\r\n      `;\r\n      \r\n      printDoc.write(`\r\n        <!DOCTYPE html>\r\n        <html>\r\n        <head>\r\n          <title>In ${documents.length} tài liệu</title>\r\n          <style>${printCSS}</style>\r\n        </head>\r\n        <body>${combinedHtml}</body>\r\n        </html>\r\n      `);\r\n      printDoc.close();\r\n      \r\n      // Đợi load xong rồi in\r\n      setTimeout(() => {\r\n        printFrame.contentWindow?.print();\r\n        // Xóa iframe sau khi in\r\n        setTimeout(() => {\r\n          if (document.body.contains(printFrame)) {\r\n            document.body.removeChild(printFrame);\r\n          }\r\n        }, 1000);\r\n      }, 100);\r\n    }\r\n  }, [templateStore, getTemplateContent, processTemplate]);\r\n\r\n  const getPreview = React.useCallback((type: TemplateType, options: PrintOptions): string => {\r\n    const { data, lineItems, paperSize, branchId } = options;\r\n\r\n    // Lấy template content\r\n    const templateContent = getTemplateContent(type, paperSize, branchId);\r\n    if (!templateContent) {\r\n      return '<p style=\"color: red;\">Không tìm thấy mẫu in</p>';\r\n    }\r\n\r\n    // Xử lý template\r\n    return processTemplate(templateContent, data, lineItems);\r\n  }, [getTemplateContent, processTemplate]);\r\n\r\n  const hasTemplate = React.useCallback((type: TemplateType, paperSize?: PaperSize): boolean => {\r\n    const size = paperSize || templateStore.getDefaultSize(type);\r\n    const template = templateStore.getTemplate(type, size, currentBranchId);\r\n    return !!template?.content;\r\n  }, [templateStore, currentBranchId]);\r\n\r\n  const getAvailableSizes = React.useCallback((type: TemplateType): PaperSize[] => {\r\n    const sizes: PaperSize[] = ['K57', 'K80', 'A4', 'A5'];\r\n    return sizes.filter(size => {\r\n      const template = templateStore.getTemplate(type, size, currentBranchId);\r\n      return !!template?.content;\r\n    });\r\n  }, [templateStore, currentBranchId]);\r\n\r\n  const getDefaultSize = React.useCallback((type: TemplateType): PaperSize => {\r\n    return templateStore.getDefaultSize(type);\r\n  }, [templateStore]);\r\n\r\n  return {\r\n    print,\r\n    printMultiple,\r\n    printMixedDocuments,\r\n    getPreview,\r\n    hasTemplate,\r\n    getAvailableSizes,\r\n    getDefaultSize,\r\n    isLoading,\r\n  };\r\n}\r\n\r\nexport type { PrintOptions, UsePrintResult };\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 2140, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/lib/print-mappers/types.ts"],"sourcesContent":["/**\r\n * Print Mappers - Shared Types\r\n * Types và utilities dùng chung cho tất cả mappers\r\n */\r\n\r\nexport { \r\n  formatCurrency, \r\n  numberToWords, \r\n  formatDate, \r\n  formatTime,\r\n  getStoreData,\r\n} from '../print-service';\r\n\r\nexport type { \r\n  PrintData, \r\n  PrintLineItem, \r\n  StoreSettings\r\n} from '../print-service';\r\n\r\n/**\r\n * Helper: Ẩn 4 số giữa của SĐT\r\n * VD: 0912345678 -> 0912***678\r\n */\r\nexport const hidePhoneMiddle = (phone?: string): string => {\r\n  if (!phone || phone.length < 8) return phone || '';\r\n  return phone.slice(0, 4) + '***' + phone.slice(-3);\r\n};\r\n\r\n/**\r\n * Helper: Format ngày dạng chữ\r\n * VD: 05/12/2025 -> Ngày 05 tháng 12 năm 2025\r\n * Note: This is a specific Vietnamese text format, not using date-utils\r\n */\r\nexport const formatDateText = (date?: string | Date): string => {\r\n  if (!date) return '';\r\n  const d = typeof date === 'string' ? new Date(date) : date;\r\n  if (isNaN(d.getTime())) return '';\r\n  const day = d.getDate();\r\n  const month = d.getMonth() + 1;\r\n  const year = d.getFullYear();\r\n  return `Ngày ${day} tháng ${month} năm ${year}`;\r\n};\r\n"],"names":[],"mappings":";;;;;;AAAA;;;CAGC,GAED;;AAkBO,MAAM,kBAAkB,CAAC;IAC9B,IAAI,CAAC,SAAS,MAAM,MAAM,GAAG,GAAG,OAAO,SAAS;IAChD,OAAO,MAAM,KAAK,CAAC,GAAG,KAAK,QAAQ,MAAM,KAAK,CAAC,CAAC;AAClD;AAOO,MAAM,iBAAiB,CAAC;IAC7B,IAAI,CAAC,MAAM,OAAO;IAClB,MAAM,IAAI,OAAO,SAAS,WAAW,IAAI,KAAK,QAAQ;IACtD,IAAI,MAAM,EAAE,OAAO,KAAK,OAAO;IAC/B,MAAM,MAAM,EAAE,OAAO;IACrB,MAAM,QAAQ,EAAE,QAAQ,KAAK;IAC7B,MAAM,OAAO,EAAE,WAAW;IAC1B,OAAO,CAAC,KAAK,EAAE,IAAI,OAAO,EAAE,MAAM,KAAK,EAAE,MAAM;AACjD"}},
    {"offset": {"line": 2168, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/lib/print-mappers/warranty.mapper.ts"],"sourcesContent":["/**\r\n * Warranty Mapper - Phiếu bảo hành\r\n * Đồng bộ với variables/phieu-bao-hanh.ts\r\n */\r\n\r\nimport { \r\n  PrintData, \r\n  PrintLineItem,\r\n  formatDate,\r\n  getStoreData,\r\n  StoreSettings\r\n} from './types';\r\n\r\nexport interface WarrantyForPrint {\r\n  // Thông tin cơ bản\r\n  code: string;\r\n  createdAt: string | Date;\r\n  modifiedAt?: string | Date;\r\n  createdBy?: string;\r\n  status?: string;\r\n  claimStatus?: string;\r\n  \r\n  // Thông tin chi nhánh\r\n  location?: {\r\n    name?: string;\r\n    address?: string;\r\n    province?: string;\r\n  };\r\n  \r\n  // Thông tin khách hàng\r\n  customerName: string;\r\n  customerPhone?: string;\r\n  customerAddress?: string;\r\n  customerGroup?: string;\r\n  \r\n  // Thông tin đơn hàng liên quan\r\n  orderCode?: string;\r\n  \r\n  // Thông tin sản phẩm bảo hành (đơn lẻ - backward compatibility)\r\n  productName?: string;\r\n  variantName?: string;\r\n  variantSku?: string;\r\n  barcode?: string;\r\n  serialNumber?: string;\r\n  warrantyPolicyName?: string;\r\n  warrantyPeriod?: string;\r\n  warrantyPeriodDays?: number;\r\n  startDate?: string | Date;\r\n  endDate?: string | Date;\r\n  \r\n  // Danh sách sản phẩm (nhiều sản phẩm)\r\n  items?: Array<{\r\n    productName: string;\r\n    variantName?: string;\r\n    variantSku?: string;\r\n    barcode?: string;\r\n    serial?: string;\r\n    warrantyPolicyName?: string;\r\n    warrantyPeriod?: string;\r\n    warrantyPeriodDays?: number;\r\n    startDate?: string | Date;\r\n    endDate?: string | Date;\r\n  }>;\r\n  \r\n  issueDescription?: string;\r\n  note?: string;\r\n}\r\n\r\nexport function mapWarrantyToPrintData(warranty: WarrantyForPrint, storeSettings: StoreSettings): PrintData {\r\n  return {\r\n    ...getStoreData(storeSettings),\r\n    \r\n    // === THÔNG TIN CHI NHÁNH ===\r\n    '{location_name}': warranty.location?.name || storeSettings.name || '',\r\n    '{location_address}': warranty.location?.address || storeSettings.address || '',\r\n    '{location_province}': warranty.location?.province || '',\r\n    '{store_province}': storeSettings.province || '',\r\n    \r\n    // === THÔNG TIN PHIẾU BẢO HÀNH ===\r\n    '{warranty_card_code}': warranty.code,\r\n    '{warranty_code}': warranty.code,\r\n    '{created_on}': formatDate(warranty.createdAt),\r\n    '{modified_on}': formatDate(warranty.modifiedAt),\r\n    '{account_name}': warranty.createdBy || '',\r\n    '{status}': warranty.status || '',\r\n    '{claim_status}': warranty.claimStatus || '',\r\n    \r\n    // === THÔNG TIN KHÁCH HÀNG ===\r\n    '{customer_name}': warranty.customerName,\r\n    '{customer_phone_number}': warranty.customerPhone || '',\r\n    '{customer_address1}': warranty.customerAddress || '',\r\n    '{customer_address}': warranty.customerAddress || '',\r\n    '{customer_group}': warranty.customerGroup || '',\r\n    \r\n    // === THÔNG TIN ĐƠN HÀNG ===\r\n    '{order_code}': warranty.orderCode || '',\r\n    \r\n    // === THÔNG TIN SẢN PHẨM (ĐƠN LẺ) ===\r\n    '{line_product_name}': warranty.productName || '',\r\n    '{product_name}': warranty.productName || '',\r\n    '{line_variant_name}': warranty.variantName || '',\r\n    '{line_variant_sku}': warranty.variantSku || '',\r\n    '{line_variant_barcode}': warranty.barcode || '',\r\n    '{serials}': warranty.serialNumber || '',\r\n    '{serial_number}': warranty.serialNumber || '',\r\n    '{term_name}': warranty.warrantyPolicyName || '',\r\n    '{term_number}': warranty.warrantyPeriod || '',\r\n    '{warranty_duration}': warranty.warrantyPeriod || '',\r\n    '{warranty_period_days}': warranty.warrantyPeriodDays?.toString() || '',\r\n    '{start_date}': formatDate(warranty.startDate),\r\n    '{end_date}': formatDate(warranty.endDate),\r\n    '{warranty_expired_on}': formatDate(warranty.endDate),\r\n    \r\n    '{issue_description}': warranty.issueDescription || '',\r\n    '{warranty_note}': warranty.note || '',\r\n  };\r\n}\r\n\r\nexport function mapWarrantyLineItems(items: WarrantyForPrint['items']): PrintLineItem[] {\r\n  if (!items) return [];\r\n  \r\n  return items.map((item, index) => ({\r\n    '{line_stt}': (index + 1).toString(),\r\n    '{line_product_name}': item.productName,\r\n    '{line_variant_name}': item.variantName || '',\r\n    '{line_variant_sku}': item.variantSku || '',\r\n    '{line_variant_barcode}': item.barcode || '',\r\n    '{serials}': item.serial || '',\r\n    '{term_name}': item.warrantyPolicyName || '',\r\n    '{term_number}': item.warrantyPeriod || '',\r\n    '{warranty_period_days}': item.warrantyPeriodDays?.toString() || '',\r\n    '{start_date}': formatDate(item.startDate),\r\n    '{end_date}': formatDate(item.endDate),\r\n  }));\r\n}\r\n"],"names":[],"mappings":";;;;;;AAAA;;;CAGC,GAED;AAAA;;AA+DO,SAAS,uBAAuB,QAA0B,EAAE,aAA4B;IAC7F,OAAO;QACL,GAAG,IAAA,uIAAY,EAAC,cAAc;QAE9B,8BAA8B;QAC9B,mBAAmB,SAAS,QAAQ,EAAE,QAAQ,cAAc,IAAI,IAAI;QACpE,sBAAsB,SAAS,QAAQ,EAAE,WAAW,cAAc,OAAO,IAAI;QAC7E,uBAAuB,SAAS,QAAQ,EAAE,YAAY;QACtD,oBAAoB,cAAc,QAAQ,IAAI;QAE9C,mCAAmC;QACnC,wBAAwB,SAAS,IAAI;QACrC,mBAAmB,SAAS,IAAI;QAChC,gBAAgB,IAAA,qIAAU,EAAC,SAAS,SAAS;QAC7C,iBAAiB,IAAA,qIAAU,EAAC,SAAS,UAAU;QAC/C,kBAAkB,SAAS,SAAS,IAAI;QACxC,YAAY,SAAS,MAAM,IAAI;QAC/B,kBAAkB,SAAS,WAAW,IAAI;QAE1C,+BAA+B;QAC/B,mBAAmB,SAAS,YAAY;QACxC,2BAA2B,SAAS,aAAa,IAAI;QACrD,uBAAuB,SAAS,eAAe,IAAI;QACnD,sBAAsB,SAAS,eAAe,IAAI;QAClD,oBAAoB,SAAS,aAAa,IAAI;QAE9C,6BAA6B;QAC7B,gBAAgB,SAAS,SAAS,IAAI;QAEtC,sCAAsC;QACtC,uBAAuB,SAAS,WAAW,IAAI;QAC/C,kBAAkB,SAAS,WAAW,IAAI;QAC1C,uBAAuB,SAAS,WAAW,IAAI;QAC/C,sBAAsB,SAAS,UAAU,IAAI;QAC7C,0BAA0B,SAAS,OAAO,IAAI;QAC9C,aAAa,SAAS,YAAY,IAAI;QACtC,mBAAmB,SAAS,YAAY,IAAI;QAC5C,eAAe,SAAS,kBAAkB,IAAI;QAC9C,iBAAiB,SAAS,cAAc,IAAI;QAC5C,uBAAuB,SAAS,cAAc,IAAI;QAClD,0BAA0B,SAAS,kBAAkB,EAAE,cAAc;QACrE,gBAAgB,IAAA,qIAAU,EAAC,SAAS,SAAS;QAC7C,cAAc,IAAA,qIAAU,EAAC,SAAS,OAAO;QACzC,yBAAyB,IAAA,qIAAU,EAAC,SAAS,OAAO;QAEpD,uBAAuB,SAAS,gBAAgB,IAAI;QACpD,mBAAmB,SAAS,IAAI,IAAI;IACtC;AACF;AAEO,SAAS,qBAAqB,KAAgC;IACnE,IAAI,CAAC,OAAO,OAAO,EAAE;IAErB,OAAO,MAAM,GAAG,CAAC,CAAC,MAAM,QAAU,CAAC;YACjC,cAAc,CAAC,QAAQ,CAAC,EAAE,QAAQ;YAClC,uBAAuB,KAAK,WAAW;YACvC,uBAAuB,KAAK,WAAW,IAAI;YAC3C,sBAAsB,KAAK,UAAU,IAAI;YACzC,0BAA0B,KAAK,OAAO,IAAI;YAC1C,aAAa,KAAK,MAAM,IAAI;YAC5B,eAAe,KAAK,kBAAkB,IAAI;YAC1C,iBAAiB,KAAK,cAAc,IAAI;YACxC,0BAA0B,KAAK,kBAAkB,EAAE,cAAc;YACjE,gBAAgB,IAAA,qIAAU,EAAC,KAAK,SAAS;YACzC,cAAc,IAAA,qIAAU,EAAC,KAAK,OAAO;QACvC,CAAC;AACH"}},
    {"offset": {"line": 2243, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/lib/print-mappers/warranty-request.mapper.ts"],"sourcesContent":["/**\r\n * Warranty Request Mapper - Phiếu yêu cầu bảo hành (phieu-yeu-cau-bao-hanh)\r\n * Đồng bộ với variables/phieu-yeu-cau-bao-hanh.ts\r\n */\r\n\r\nimport { \r\n  PrintData, \r\n  PrintLineItem,\r\n  formatCurrency,\r\n  formatDate,\r\n  getStoreData,\r\n  StoreSettings\r\n} from './types';\r\n\r\nexport interface WarrantyRequestForPrint {\r\n  // Thông tin cơ bản\r\n  code: string;\r\n  warrantyRequestCode?: string;\r\n  orderCode?: string;\r\n  createdAt: string | Date;\r\n  createdAtTime?: string;\r\n  modifiedAt?: string | Date;\r\n  createdBy?: string;\r\n  reference?: string;\r\n  status?: string;\r\n  priority?: string;\r\n  \r\n  // Thông tin chi nhánh\r\n  location?: {\r\n    name?: string;\r\n    address?: string;\r\n    province?: string;\r\n  };\r\n  \r\n  // Thông tin khách hàng\r\n  customerCode?: string;\r\n  customerName?: string;\r\n  customerPhone?: string;\r\n  customerAddress?: string;\r\n  customerEmail?: string;\r\n  customerGroup?: string;\r\n  \r\n  // Thông tin sản phẩm\r\n  productCode?: string;\r\n  productName?: string;\r\n  serialNumber?: string;\r\n  purchaseDate?: string | Date;\r\n  warrantyExpiredOn?: string | Date;\r\n  warrantyDuration?: string;\r\n  \r\n  // Thông tin sự cố\r\n  issueType?: string;\r\n  issueDescription?: string;\r\n  deviceCondition?: string;\r\n  accessories?: string;\r\n  \r\n  // Xử lý\r\n  receivedBy?: string;\r\n  technicianName?: string;\r\n  expectedCompletionDate?: string | Date;\r\n  note?: string;\r\n  \r\n  // Tags\r\n  tag?: string;\r\n  \r\n  // Danh sách sản phẩm\r\n  items: Array<{\r\n    productName: string;\r\n    variantName?: string;\r\n    variantSku?: string;\r\n    variantBarcode?: string;\r\n    serial?: string;\r\n    warrantyCardCode?: string;\r\n    quantity: number;\r\n    requestType?: string;\r\n    receivedOn?: string | Date;\r\n    status?: string;\r\n    expenseTitle?: string;\r\n    expenseAmount?: number;\r\n    expenseTotalAmount?: number;\r\n  }>;\r\n  \r\n  // Tổng giá trị\r\n  totalQuantity: number;\r\n  totalAmount?: number;\r\n}\r\n\r\nexport function mapWarrantyRequestToPrintData(request: WarrantyRequestForPrint, storeSettings: StoreSettings): PrintData {\r\n  return {\r\n    ...getStoreData(storeSettings),\r\n    \r\n    // === THÔNG TIN CHI NHÁNH ===\r\n    '{location_name}': request.location?.name || storeSettings.name || '',\r\n    '{location_address}': request.location?.address || storeSettings.address || '',\r\n    '{store_province}': storeSettings.province || '',\r\n    '{location_province}': request.location?.province || '',\r\n    \r\n    // === THÔNG TIN PHIẾU YÊU CẦU BẢO HÀNH ===\r\n    '{warranty_claim_card_code}': request.code,\r\n    '{warranty_request_code}': request.warrantyRequestCode || request.code,\r\n    '{order_code}': request.orderCode || '',\r\n    '{created_on}': formatDate(request.createdAt),\r\n    '{created_on_time}': request.createdAtTime || '',\r\n    '{modified_on}': formatDate(request.modifiedAt),\r\n    '{account_name}': request.createdBy || '',\r\n    '{reference}': request.reference || '',\r\n    '{status}': request.status || '',\r\n    '{priority}': request.priority || '',\r\n    \r\n    // === THÔNG TIN KHÁCH HÀNG ===\r\n    '{customer_code}': request.customerCode || '',\r\n    '{customer_name}': request.customerName || '',\r\n    '{customer_phone_number}': request.customerPhone || '',\r\n    '{customer_address1}': request.customerAddress || '',\r\n    '{customer_address}': request.customerAddress || '',\r\n    '{customer_email}': request.customerEmail || '',\r\n    '{customer_group}': request.customerGroup || '',\r\n    \r\n    // === THÔNG TIN SẢN PHẨM ===\r\n    '{product_code}': request.productCode || '',\r\n    '{product_name}': request.productName || '',\r\n    '{serial_number}': request.serialNumber || '',\r\n    '{purchase_date}': formatDate(request.purchaseDate),\r\n    '{warranty_expired_on}': formatDate(request.warrantyExpiredOn),\r\n    '{warranty_duration}': request.warrantyDuration || '',\r\n    \r\n    // === THÔNG TIN SỰ CỐ ===\r\n    '{issue_type}': request.issueType || '',\r\n    '{issue_description}': request.issueDescription || '',\r\n    '{device_condition}': request.deviceCondition || '',\r\n    '{accessories}': request.accessories || '',\r\n    \r\n    // === XỬ LÝ ===\r\n    '{received_by}': request.receivedBy || '',\r\n    '{technician_name}': request.technicianName || '',\r\n    '{expected_completion_date}': formatDate(request.expectedCompletionDate),\r\n    '{note}': request.note || '',\r\n    \r\n    // === TAGS ===\r\n    '{tag}': request.tag || '',\r\n    \r\n    // === TỔNG GIÁ TRỊ ===\r\n    '{total_quantity}': request.totalQuantity.toString(),\r\n    '{total_amount}': formatCurrency(request.totalAmount),\r\n  };\r\n}\r\n\r\nexport function mapWarrantyRequestLineItems(items: WarrantyRequestForPrint['items']): PrintLineItem[] {\r\n  return items.map((item, index) => ({\r\n    '{line_stt}': (index + 1).toString(),\r\n    '{line_product_name}': item.productName,\r\n    '{line_variant_name}': item.variantName || '',\r\n    '{line_variant_sku}': item.variantSku || '',\r\n    '{line_variant_barcode}': item.variantBarcode || '',\r\n    '{serials}': item.serial || '',\r\n    '{warranty_card_code}': item.warrantyCardCode || '',\r\n    '{line_quantity}': item.quantity.toString(),\r\n    '{line_type}': item.requestType || '',\r\n    '{line_received_on}': formatDate(item.receivedOn),\r\n    '{line_status}': item.status || '',\r\n    '{line_expense_title}': item.expenseTitle || '',\r\n    '{line_expense_amount}': formatCurrency(item.expenseAmount),\r\n    '{line_expense_total_amount}': formatCurrency(item.expenseTotalAmount),\r\n  }));\r\n}\r\n"],"names":[],"mappings":";;;;;;AAAA;;;CAGC,GAED;AAAA;;AAkFO,SAAS,8BAA8B,OAAgC,EAAE,aAA4B;IAC1G,OAAO;QACL,GAAG,IAAA,uIAAY,EAAC,cAAc;QAE9B,8BAA8B;QAC9B,mBAAmB,QAAQ,QAAQ,EAAE,QAAQ,cAAc,IAAI,IAAI;QACnE,sBAAsB,QAAQ,QAAQ,EAAE,WAAW,cAAc,OAAO,IAAI;QAC5E,oBAAoB,cAAc,QAAQ,IAAI;QAC9C,uBAAuB,QAAQ,QAAQ,EAAE,YAAY;QAErD,2CAA2C;QAC3C,8BAA8B,QAAQ,IAAI;QAC1C,2BAA2B,QAAQ,mBAAmB,IAAI,QAAQ,IAAI;QACtE,gBAAgB,QAAQ,SAAS,IAAI;QACrC,gBAAgB,IAAA,qIAAU,EAAC,QAAQ,SAAS;QAC5C,qBAAqB,QAAQ,aAAa,IAAI;QAC9C,iBAAiB,IAAA,qIAAU,EAAC,QAAQ,UAAU;QAC9C,kBAAkB,QAAQ,SAAS,IAAI;QACvC,eAAe,QAAQ,SAAS,IAAI;QACpC,YAAY,QAAQ,MAAM,IAAI;QAC9B,cAAc,QAAQ,QAAQ,IAAI;QAElC,+BAA+B;QAC/B,mBAAmB,QAAQ,YAAY,IAAI;QAC3C,mBAAmB,QAAQ,YAAY,IAAI;QAC3C,2BAA2B,QAAQ,aAAa,IAAI;QACpD,uBAAuB,QAAQ,eAAe,IAAI;QAClD,sBAAsB,QAAQ,eAAe,IAAI;QACjD,oBAAoB,QAAQ,aAAa,IAAI;QAC7C,oBAAoB,QAAQ,aAAa,IAAI;QAE7C,6BAA6B;QAC7B,kBAAkB,QAAQ,WAAW,IAAI;QACzC,kBAAkB,QAAQ,WAAW,IAAI;QACzC,mBAAmB,QAAQ,YAAY,IAAI;QAC3C,mBAAmB,IAAA,qIAAU,EAAC,QAAQ,YAAY;QAClD,yBAAyB,IAAA,qIAAU,EAAC,QAAQ,iBAAiB;QAC7D,uBAAuB,QAAQ,gBAAgB,IAAI;QAEnD,0BAA0B;QAC1B,gBAAgB,QAAQ,SAAS,IAAI;QACrC,uBAAuB,QAAQ,gBAAgB,IAAI;QACnD,sBAAsB,QAAQ,eAAe,IAAI;QACjD,iBAAiB,QAAQ,WAAW,IAAI;QAExC,gBAAgB;QAChB,iBAAiB,QAAQ,UAAU,IAAI;QACvC,qBAAqB,QAAQ,cAAc,IAAI;QAC/C,8BAA8B,IAAA,qIAAU,EAAC,QAAQ,sBAAsB;QACvE,UAAU,QAAQ,IAAI,IAAI;QAE1B,eAAe;QACf,SAAS,QAAQ,GAAG,IAAI;QAExB,uBAAuB;QACvB,oBAAoB,QAAQ,aAAa,CAAC,QAAQ;QAClD,kBAAkB,IAAA,yIAAc,EAAC,QAAQ,WAAW;IACtD;AACF;AAEO,SAAS,4BAA4B,KAAuC;IACjF,OAAO,MAAM,GAAG,CAAC,CAAC,MAAM,QAAU,CAAC;YACjC,cAAc,CAAC,QAAQ,CAAC,EAAE,QAAQ;YAClC,uBAAuB,KAAK,WAAW;YACvC,uBAAuB,KAAK,WAAW,IAAI;YAC3C,sBAAsB,KAAK,UAAU,IAAI;YACzC,0BAA0B,KAAK,cAAc,IAAI;YACjD,aAAa,KAAK,MAAM,IAAI;YAC5B,wBAAwB,KAAK,gBAAgB,IAAI;YACjD,mBAAmB,KAAK,QAAQ,CAAC,QAAQ;YACzC,eAAe,KAAK,WAAW,IAAI;YACnC,sBAAsB,IAAA,qIAAU,EAAC,KAAK,UAAU;YAChD,iBAAiB,KAAK,MAAM,IAAI;YAChC,wBAAwB,KAAK,YAAY,IAAI;YAC7C,yBAAyB,IAAA,yIAAc,EAAC,KAAK,aAAa;YAC1D,+BAA+B,IAAA,yIAAc,EAAC,KAAK,kBAAkB;QACvE,CAAC;AACH"}},
    {"offset": {"line": 2328, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/lib/print/warranty-print-helper.ts"],"sourcesContent":["/**\r\n * Warranty Print Helper\r\n * Helpers để chuẩn bị dữ liệu in cho phiếu bảo hành và yêu cầu bảo hành\r\n */\r\n\r\nimport type { Branch } from '../../features/settings/branches/types';\r\nimport type { Customer } from '../../features/customers/types';\r\nimport type { Employee } from '../../features/employees/types';\r\nimport { \r\n  WarrantyForPrint, \r\n  mapWarrantyToPrintData, \r\n  mapWarrantyLineItems,\r\n} from '../print-mappers/warranty.mapper';\r\nimport {\r\n  WarrantyRequestForPrint,\r\n  mapWarrantyRequestToPrintData,\r\n  mapWarrantyRequestLineItems,\r\n} from '../print-mappers/warranty-request.mapper';\r\nimport { StoreSettings, getStoreLogo, getGeneralSettings } from '../print-service';\r\n\r\n// Interface cho warranty item - flexible to accept both Warranty and WarrantyTicket\r\ninterface WarrantyItemLike {\r\n  productSystemId?: string;\r\n  productId?: string;\r\n  productName: string;\r\n  serialNumber?: string;\r\n  sku?: string;\r\n  quantity?: number;\r\n  warrantyStartDate?: string;\r\n  warrantyEndDate?: string;\r\n  issue?: string;\r\n  issueDescription?: string;\r\n  resolution?: string;\r\n  cost?: number;\r\n  note?: string;\r\n}\r\n\r\n// Interface cho warranty - flexible to accept both Warranty and WarrantyTicket\r\ninterface WarrantyLike {\r\n  systemId: string;\r\n  id: string;\r\n  customerSystemId?: string;\r\n  customerName: string;\r\n  customerPhone?: string;\r\n  customerEmail?: string;\r\n  customerAddress?: string;\r\n  orderSystemId?: string;\r\n  orderId?: string;\r\n  linkedOrderSystemId?: string;\r\n  branchSystemId?: string;\r\n  branchName?: string;\r\n  type?: 'warranty' | 'repair';\r\n  status: string;\r\n  items?: WarrantyItemLike[];\r\n  products?: WarrantyItemLike[];\r\n  receivedDate?: string;\r\n  expectedReturnDate?: string;\r\n  returnedDate?: string;\r\n  totalCost?: number;\r\n  paidAmount?: number;\r\n  createdAt?: string;\r\n  createdBy?: string;\r\n  createdByName?: string;\r\n  employeeName?: string;\r\n  technicianSystemId?: string;\r\n  technicianName?: string;\r\n  note?: string;\r\n  notes?: string;\r\n  updatedAt?: string;\r\n}\r\n\r\n// Interface cho warranty request - flexible\r\ninterface WarrantyRequestLike {\r\n  systemId: string;\r\n  id: string;\r\n  customerSystemId?: string;\r\n  customerName: string;\r\n  customerPhone?: string;\r\n  customerEmail?: string;\r\n  customerAddress?: string;\r\n  orderSystemId?: string;\r\n  orderId?: string;\r\n  branchSystemId?: string;\r\n  branchName?: string;\r\n  status: string;\r\n  items?: WarrantyItemLike[];\r\n  products?: WarrantyItemLike[];\r\n  requestDate?: string;\r\n  issue?: string;\r\n  createdAt?: string;\r\n  createdBy?: string;\r\n  createdByName?: string;\r\n  note?: string;\r\n  notes?: string;\r\n}\r\n\r\n/**\r\n * Chuyển đổi Warranty/WarrantyTicket entity sang WarrantyForPrint\r\n */\r\nexport function convertWarrantyForPrint(\r\n  warranty: WarrantyLike,\r\n  options: {\r\n    branch?: Branch | null;\r\n    customer?: Customer | null;\r\n    creator?: Employee | null;\r\n    technician?: Employee | null;\r\n    linkedOrderId?: string;\r\n  } = {}\r\n): WarrantyForPrint {\r\n  const { branch, customer, creator, technician, linkedOrderId } = options;\r\n\r\n  // Map trạng thái sang tiếng Việt\r\n  const statusMap: Record<string, string> = {\r\n    'received': 'Đã nhận',\r\n    'diagnosing': 'Đang kiểm tra',\r\n    'repairing': 'Đang sửa chữa',\r\n    'waiting_parts': 'Chờ linh kiện',\r\n    'completed': 'Hoàn thành',\r\n    'returned': 'Đã trả khách',\r\n    'cancelled': 'Đã hủy',\r\n  };\r\n\r\n  const typeMap: Record<string, string> = {\r\n    'warranty': 'Bảo hành',\r\n    'repair': 'Sửa chữa',\r\n  };\r\n\r\n  // Format địa chỉ khách hàng\r\n  const customerFirstAddress = customer?.addresses?.[0];\r\n  const customerAddressString = customerFirstAddress \r\n    ? [customerFirstAddress.street, customerFirstAddress.ward, customerFirstAddress.district, customerFirstAddress.province].filter(Boolean).join(', ')\r\n    : warranty.customerAddress || '';\r\n\r\n  // Get items from either items or products field\r\n  const warrantyItems = warranty.items || warranty.products || [];\r\n\r\n  return {\r\n    // Thông tin cơ bản\r\n    code: warranty.id,\r\n    createdAt: warranty.createdAt,\r\n    modifiedAt: warranty.updatedAt,\r\n    createdBy: creator?.fullName || warranty.createdByName || warranty.employeeName,\r\n    \r\n    // Trạng thái\r\n    status: statusMap[warranty.status] || warranty.status,\r\n    \r\n    // Chi nhánh\r\n    location: branch ? {\r\n      name: branch.name,\r\n      address: branch.address,\r\n      province: branch.province,\r\n    } : {\r\n      name: warranty.branchName,\r\n    },\r\n    \r\n    // Đơn hàng gốc\r\n    orderCode: linkedOrderId || warranty.orderId,\r\n    \r\n    // Khách hàng\r\n    customerName: customer?.name || warranty.customerName,\r\n    customerPhone: customer?.phone || warranty.customerPhone,\r\n    customerAddress: customerAddressString,\r\n    \r\n    // Danh sách sản phẩm\r\n    items: warrantyItems.map(item => ({\r\n      variantCode: item.productId || item.productSystemId,\r\n      variantSku: item.sku,\r\n      productName: item.productName,\r\n      serialNumber: item.serialNumber,\r\n      quantity: item.quantity,\r\n      warrantyStartDate: item.warrantyStartDate,\r\n      warrantyEndDate: item.warrantyEndDate,\r\n      issue: item.issue || item.issueDescription,\r\n      issueDescription: item.issueDescription || item.issue,\r\n      resolution: item.resolution,\r\n      cost: item.cost,\r\n      note: item.note,\r\n    })),\r\n    \r\n    // Mô tả lỗi chung\r\n    issueDescription: warrantyItems.map(p => p.issueDescription || p.issue).filter(Boolean).join(', '),\r\n    \r\n    note: warranty.note || warranty.notes,\r\n  };\r\n}\r\n\r\n/**\r\n * Chuyển đổi WarrantyRequest entity sang WarrantyRequestForPrint\r\n */\r\nexport function convertWarrantyRequestForPrint(\r\n  request: WarrantyRequestLike,\r\n  options: {\r\n    branch?: Branch | null;\r\n    customer?: Customer | null;\r\n    creator?: Employee | null;\r\n  } = {}\r\n): WarrantyRequestForPrint {\r\n  const { branch, customer, creator } = options;\r\n\r\n  // Map trạng thái sang tiếng Việt\r\n  const statusMap: Record<string, string> = {\r\n    'pending': 'Chờ xử lý',\r\n    'approved': 'Đã duyệt',\r\n    'rejected': 'Từ chối',\r\n    'processing': 'Đang xử lý',\r\n    'completed': 'Hoàn thành',\r\n  };\r\n\r\n  // Format địa chỉ khách hàng\r\n  const customerFirstAddress = customer?.addresses?.[0];\r\n  const customerAddressString = customerFirstAddress \r\n    ? [customerFirstAddress.street, customerFirstAddress.ward, customerFirstAddress.district, customerFirstAddress.province].filter(Boolean).join(', ')\r\n    : request.customerAddress || '';\r\n\r\n  return {\r\n    // Thông tin cơ bản\r\n    code: request.id,\r\n    createdAt: request.createdAt,\r\n    createdBy: creator?.fullName || request.createdByName,\r\n    \r\n    // Chi nhánh\r\n    location: branch ? {\r\n      name: branch.name,\r\n      address: branch.address,\r\n      province: branch.province,\r\n    } : {\r\n      name: request.branchName,\r\n    },\r\n    \r\n    // Khách hàng\r\n    customerName: customer?.name || request.customerName,\r\n    customerPhone: customer?.phone || request.customerPhone,\r\n    customerAddress: customerAddressString,\r\n    \r\n    // Danh sách sản phẩm\r\n    items: (request.items || request.products || []).map(item => ({\r\n      productName: item.productName,\r\n      quantity: item.quantity ?? 1,\r\n    })),\r\n    \r\n    totalQuantity: (request.items || request.products || []).reduce((sum, item) => sum + (item.quantity ?? 1), 0),\r\n  };\r\n}\r\n\r\n/**\r\n * Tạo StoreSettings từ storeInfo\r\n */\r\nexport function createStoreSettings(storeInfo?: {\r\n  companyName?: string;\r\n  brandName?: string;\r\n  hotline?: string;\r\n  email?: string;\r\n  website?: string;\r\n  taxCode?: string;\r\n  headquartersAddress?: string;\r\n  province?: string;\r\n  logo?: string;\r\n}): StoreSettings {\r\n  // Fallback lấy từ general-settings nếu storeInfo trống\r\n  const generalSettings = getGeneralSettings();\r\n  return {\r\n    name: storeInfo?.companyName || storeInfo?.brandName || generalSettings?.companyName || '',\r\n    address: storeInfo?.headquartersAddress || generalSettings?.companyAddress || '',\r\n    phone: storeInfo?.hotline || generalSettings?.phoneNumber || '',\r\n    email: storeInfo?.email || generalSettings?.email || '',\r\n    website: storeInfo?.website,\r\n    taxCode: storeInfo?.taxCode,\r\n    province: storeInfo?.province,\r\n    logo: getStoreLogo(storeInfo?.logo),\r\n  };\r\n}\r\n\r\n// Re-export mappers\r\nexport {\r\n  mapWarrantyToPrintData,\r\n  mapWarrantyLineItems,\r\n  mapWarrantyRequestToPrintData,\r\n  mapWarrantyRequestLineItems,\r\n};\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 2475, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/hooks/use-workflow-templates.ts"],"sourcesContent":["import { useState, useEffect, useCallback, useRef } from 'react'\r\nimport type { Subtask } from '@/components/shared/subtask-list'\r\nimport { nanoid } from 'nanoid'\r\n\r\nexport interface WorkflowTemplate {\r\n  systemId: string\r\n  id: string\r\n  name: string // 'complaints', 'warranty' - workflow type\r\n  label: string // Display name\r\n  description: string\r\n  subtasks: Subtask[]\r\n  isDefault: boolean\r\n  createdAt: Date\r\n  updatedAt: Date\r\n}\r\n\r\n// Default templates for initial setup\r\nfunction getDefaultTemplates(): WorkflowTemplate[] {\r\n  const now = new Date()\r\n  return [\r\n    {\r\n      systemId: nanoid(),\r\n      id: nanoid(),\r\n      name: 'complaints',\r\n      label: 'Quy trình Khiếu nại tiêu chuẩn',\r\n      description: 'Các bước xử lý khiếu nại từ khách hàng',\r\n      isDefault: true,\r\n      createdAt: now,\r\n      updatedAt: now,\r\n      subtasks: [\r\n        { id: nanoid(), title: 'Tiếp nhận và ghi nhận', completed: false, order: 0, createdAt: now },\r\n        { id: nanoid(), title: 'Phân loại và đánh giá', completed: false, order: 1, createdAt: now },\r\n        { id: nanoid(), title: 'Xác minh thông tin', completed: false, order: 2, createdAt: now },\r\n        { id: nanoid(), title: 'Đề xuất giải pháp', completed: false, order: 3, createdAt: now },\r\n        { id: nanoid(), title: 'Thực hiện xử lý', completed: false, order: 4, createdAt: now },\r\n        { id: nanoid(), title: 'Phản hồi khách hàng', completed: false, order: 5, createdAt: now },\r\n        { id: nanoid(), title: 'Đánh giá kết quả', completed: false, order: 6, createdAt: now },\r\n      ],\r\n    },\r\n    {\r\n      systemId: nanoid(),\r\n      id: nanoid(),\r\n      name: 'warranty',\r\n      label: 'Quy trình Bảo hành tiêu chuẩn',\r\n      description: 'Các bước xử lý bảo hành sản phẩm',\r\n      isDefault: true,\r\n      createdAt: now,\r\n      updatedAt: now,\r\n      subtasks: [\r\n        { id: nanoid(), title: 'Tiếp nhận yêu cầu', completed: false, order: 0, createdAt: now },\r\n        { id: nanoid(), title: 'Kiểm tra điều kiện BH', completed: false, order: 1, createdAt: now },\r\n        { id: nanoid(), title: 'Kiểm tra lỗi sản phẩm', completed: false, order: 2, createdAt: now },\r\n        { id: nanoid(), title: 'Báo giá sửa chữa', completed: false, order: 3, createdAt: now },\r\n        { id: nanoid(), title: 'Thực hiện sửa chữa', completed: false, order: 4, createdAt: now },\r\n        { id: nanoid(), title: 'Kiểm tra chất lượng', completed: false, order: 5, createdAt: now },\r\n        { id: nanoid(), title: 'Trả hàng khách', completed: false, order: 6, createdAt: now },\r\n      ],\r\n    },\r\n    {\r\n      systemId: nanoid(),\r\n      id: nanoid(),\r\n      name: 'orders',\r\n      label: 'Quy trình Đơn hàng tiêu chuẩn',\r\n      description: 'Các bước xử lý đơn hàng',\r\n      isDefault: true,\r\n      createdAt: now,\r\n      updatedAt: now,\r\n      subtasks: [\r\n        { id: nanoid(), title: 'Xác nhận đơn hàng', completed: false, order: 0, createdAt: now },\r\n        { id: nanoid(), title: 'Kiểm tra tồn kho', completed: false, order: 1, createdAt: now },\r\n        { id: nanoid(), title: 'Chuẩn bị hàng hóa', completed: false, order: 2, createdAt: now },\r\n        { id: nanoid(), title: 'Đóng gói', completed: false, order: 3, createdAt: now },\r\n        { id: nanoid(), title: 'Giao hàng', completed: false, order: 4, createdAt: now },\r\n        { id: nanoid(), title: 'Thu tiền', completed: false, order: 5, createdAt: now },\r\n        { id: nanoid(), title: 'Hoàn tất', completed: false, order: 6, createdAt: now },\r\n      ],\r\n    },\r\n    {\r\n      systemId: nanoid(),\r\n      id: nanoid(),\r\n      name: 'sales-returns',\r\n      label: 'Quy trình Đổi trả hàng',\r\n      description: 'Các bước xử lý đổi trả hàng bán',\r\n      isDefault: true,\r\n      createdAt: now,\r\n      updatedAt: now,\r\n      subtasks: [\r\n        { id: nanoid(), title: 'Tiếp nhận yêu cầu', completed: false, order: 0, createdAt: now },\r\n        { id: nanoid(), title: 'Kiểm tra điều kiện', completed: false, order: 1, createdAt: now },\r\n        { id: nanoid(), title: 'Kiểm tra sản phẩm', completed: false, order: 2, createdAt: now },\r\n        { id: nanoid(), title: 'Xử lý hoàn tiền/đổi hàng', completed: false, order: 3, createdAt: now },\r\n        { id: nanoid(), title: 'Cập nhật kho', completed: false, order: 4, createdAt: now },\r\n        { id: nanoid(), title: 'Hoàn tất', completed: false, order: 5, createdAt: now },\r\n      ],\r\n    },\r\n    {\r\n      systemId: nanoid(),\r\n      id: nanoid(),\r\n      name: 'purchase-returns',\r\n      label: 'Quy trình Trả hàng NCC',\r\n      description: 'Các bước trả hàng cho nhà cung cấp',\r\n      isDefault: true,\r\n      createdAt: now,\r\n      updatedAt: now,\r\n      subtasks: [\r\n        { id: nanoid(), title: 'Phát hiện sản phẩm lỗi/hỏng', completed: false, order: 0, createdAt: now },\r\n        { id: nanoid(), title: 'Tạo phiếu trả hàng', completed: false, order: 1, createdAt: now },\r\n        { id: nanoid(), title: 'Liên hệ NCC', completed: false, order: 2, createdAt: now },\r\n        { id: nanoid(), title: 'Đóng gói trả hàng', completed: false, order: 3, createdAt: now },\r\n        { id: nanoid(), title: 'Gửi hàng trả', completed: false, order: 4, createdAt: now },\r\n        { id: nanoid(), title: 'Nhận hoàn tiền/đổi hàng', completed: false, order: 5, createdAt: now },\r\n        { id: nanoid(), title: 'Cập nhật kho', completed: false, order: 6, createdAt: now },\r\n      ],\r\n    },\r\n    {\r\n      systemId: nanoid(),\r\n      id: nanoid(),\r\n      name: 'stock-transfers',\r\n      label: 'Quy trình Chuyển kho',\r\n      description: 'Các bước chuyển hàng giữa các kho',\r\n      isDefault: true,\r\n      createdAt: now,\r\n      updatedAt: now,\r\n      subtasks: [\r\n        { id: nanoid(), title: 'Tạo phiếu chuyển kho', completed: false, order: 0, createdAt: now },\r\n        { id: nanoid(), title: 'Kiểm tra tồn kho xuất', completed: false, order: 1, createdAt: now },\r\n        { id: nanoid(), title: 'Lấy hàng và kiểm đếm', completed: false, order: 2, createdAt: now },\r\n        { id: nanoid(), title: 'Đóng gói và ghi chú vận chuyển', completed: false, order: 3, createdAt: now },\r\n        { id: nanoid(), title: 'Xuất kho nguồn', completed: false, order: 4, createdAt: now },\r\n        { id: nanoid(), title: 'Vận chuyển đến kho đích', completed: false, order: 5, createdAt: now },\r\n        { id: nanoid(), title: 'Nhận hàng và kiểm đếm tại kho đích', completed: false, order: 6, createdAt: now },\r\n        { id: nanoid(), title: 'Nhập kho đích và hoàn tất', completed: false, order: 7, createdAt: now },\r\n      ],\r\n    },\r\n    {\r\n      systemId: nanoid(),\r\n      id: nanoid(),\r\n      name: 'inventory-checks',\r\n      label: 'Quy trình Kiểm kho',\r\n      description: 'Các bước thực hiện kiểm kê hàng tồn kho',\r\n      isDefault: true,\r\n      createdAt: now,\r\n      updatedAt: now,\r\n      subtasks: [\r\n        { id: nanoid(), title: 'Lên kế hoạch kiểm kho (thời gian, phạm vi)', completed: false, order: 0, createdAt: now },\r\n        { id: nanoid(), title: 'In danh sách hàng hóa cần kiểm', completed: false, order: 1, createdAt: now },\r\n        { id: nanoid(), title: 'Phân công nhân sự kiểm kê', completed: false, order: 2, createdAt: now },\r\n        { id: nanoid(), title: 'Thực hiện kiểm đếm thực tế', completed: false, order: 3, createdAt: now },\r\n        { id: nanoid(), title: 'Ghi nhận số lượng thực tế', completed: false, order: 4, createdAt: now },\r\n        { id: nanoid(), title: 'Đối chiếu với số liệu hệ thống', completed: false, order: 5, createdAt: now },\r\n        { id: nanoid(), title: 'Xác định và giải trình chênh lệch', completed: false, order: 6, createdAt: now },\r\n        { id: nanoid(), title: 'Duyệt và cập nhật tồn kho', completed: false, order: 7, createdAt: now },\r\n      ],\r\n    },\r\n  ]\r\n}\r\n\r\n// Parse templates from API response\r\nfunction parseTemplates(data: any[]): WorkflowTemplate[] {\r\n  return data.map((t: any) => ({\r\n    ...t,\r\n    systemId: t.systemId || t.id,\r\n    createdAt: new Date(t.createdAt),\r\n    updatedAt: new Date(t.updatedAt),\r\n    subtasks: t.subtasks.map((s: any) => ({\r\n      ...s,\r\n      createdAt: new Date(s.createdAt),\r\n      completedAt: s.completedAt ? new Date(s.completedAt) : undefined,\r\n    })),\r\n  }))\r\n}\r\n\r\n// In-memory cache for templates (shared across components)\r\nlet templatesCache: WorkflowTemplate[] | null = null\r\nlet cachePromise: Promise<WorkflowTemplate[]> | null = null\r\n\r\n/**\r\n * Get workflow templates from database\r\n * This function can be called outside of React components\r\n */\r\nexport async function fetchWorkflowTemplates(): Promise<WorkflowTemplate[]> {\r\n  // Return cached if available\r\n  if (templatesCache) {\r\n    return templatesCache\r\n  }\r\n\r\n  // Prevent multiple simultaneous fetches\r\n  if (cachePromise) {\r\n    return cachePromise\r\n  }\r\n\r\n  cachePromise = (async () => {\r\n    try {\r\n      const res = await fetch('/api/workflow-templates')\r\n      if (res.ok) {\r\n        const json = await res.json()\r\n        if (json.data && json.data.length > 0) {\r\n          templatesCache = parseTemplates(json.data)\r\n          return templatesCache\r\n        }\r\n      }\r\n    } catch (error) {\r\n      console.error('Failed to fetch workflow templates from API:', error)\r\n    }\r\n\r\n    // Return default templates if API fails\r\n    templatesCache = getDefaultTemplates()\r\n    return templatesCache\r\n  })()\r\n\r\n  const result = await cachePromise\r\n  cachePromise = null\r\n  return result\r\n}\r\n\r\n/**\r\n * Get workflow template subtasks for a specific workflow type\r\n * Returns fresh copies with new IDs and reset completed status\r\n */\r\nexport async function getWorkflowTemplateSubtasks(workflowName: string): Promise<Subtask[]> {\r\n  const templates = await fetchWorkflowTemplates()\r\n  \r\n  // Find default template for this workflow\r\n  const template = templates.find(t => t.name === workflowName && t.isDefault)\r\n  \r\n  if (!template) {\r\n    // Fallback: get first template for this workflow\r\n    const fallback = templates.find(t => t.name === workflowName)\r\n    if (!fallback) return []\r\n    \r\n    return fallback.subtasks.map(s => ({\r\n      ...s,\r\n      id: nanoid(),\r\n      completed: false,\r\n      completedAt: undefined,\r\n    }))\r\n  }\r\n  \r\n  // Deep clone and reset completed status\r\n  return template.subtasks.map(s => ({\r\n    ...s,\r\n    id: nanoid(),\r\n    completed: false,\r\n    completedAt: undefined,\r\n  }))\r\n}\r\n\r\n/**\r\n * Get all workflow templates for a specific workflow type\r\n */\r\nexport async function getWorkflowTemplatesByType(workflowName: string): Promise<WorkflowTemplate[]> {\r\n  const templates = await fetchWorkflowTemplates()\r\n  return templates.filter(t => t.name === workflowName)\r\n}\r\n\r\n/**\r\n * Clear templates cache (call after saving templates)\r\n */\r\nexport function clearWorkflowTemplatesCache() {\r\n  templatesCache = null\r\n  cachePromise = null\r\n}\r\n\r\n/**\r\n * Hook to use workflow templates in React components\r\n */\r\nexport function useWorkflowTemplates() {\r\n  const [templates, setTemplates] = useState<WorkflowTemplate[]>([])\r\n  const [isLoading, setIsLoading] = useState(true)\r\n  const [error, setError] = useState<string | null>(null)\r\n  const isSavingRef = useRef(false)\r\n\r\n  // Load templates on mount\r\n  useEffect(() => {\r\n    let mounted = true\r\n\r\n    const load = async () => {\r\n      try {\r\n        const data = await fetchWorkflowTemplates()\r\n        if (mounted) {\r\n          setTemplates(data)\r\n          setError(null)\r\n        }\r\n      } catch (err) {\r\n        if (mounted) {\r\n          setError('Failed to load templates')\r\n          // Use default templates on error\r\n          setTemplates(getDefaultTemplates())\r\n        }\r\n      } finally {\r\n        if (mounted) {\r\n          setIsLoading(false)\r\n        }\r\n      }\r\n    }\r\n\r\n    load()\r\n\r\n    return () => {\r\n      mounted = false\r\n    }\r\n  }, [])\r\n\r\n  // Save templates to database\r\n  const saveTemplates = useCallback(async (newTemplates: WorkflowTemplate[]) => {\r\n    if (isSavingRef.current) return\r\n\r\n    isSavingRef.current = true\r\n    setTemplates(newTemplates)\r\n\r\n    try {\r\n      const res = await fetch('/api/workflow-templates', {\r\n        method: 'POST',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({ templates: newTemplates }),\r\n      })\r\n\r\n      if (!res.ok) {\r\n        throw new Error('Failed to save templates')\r\n      }\r\n\r\n      // Clear cache so next fetch gets fresh data\r\n      clearWorkflowTemplatesCache()\r\n      templatesCache = newTemplates\r\n\r\n      setError(null)\r\n    } catch (err) {\r\n      console.error('Error saving templates:', err)\r\n      setError('Failed to save templates')\r\n    } finally {\r\n      isSavingRef.current = false\r\n    }\r\n  }, [])\r\n\r\n  return {\r\n    templates,\r\n    setTemplates: saveTemplates,\r\n    isLoading,\r\n    error,\r\n  }\r\n}\r\n\r\n/**\r\n * Synchronous getter for workflow templates (uses cache)\r\n * Returns empty array if not yet loaded - use async version for guaranteed data\r\n */\r\nexport function getWorkflowTemplatesSync(): WorkflowTemplate[] {\r\n  if (templatesCache) {\r\n    return templatesCache\r\n  }\r\n  \r\n  // Return default templates if cache not loaded\r\n  \r\n  return getDefaultTemplates()\r\n}\r\n\r\n/**\r\n * Synchronous getter for single workflow template subtasks (uses cache)\r\n */\r\nexport function getWorkflowTemplateSync(workflowName: string): Subtask[] {\r\n  const templates = getWorkflowTemplatesSync()\r\n  const template = templates.find(t => t.name === workflowName && t.isDefault)\r\n  \r\n  if (!template) {\r\n    const fallback = templates.find(t => t.name === workflowName)\r\n    if (!fallback) return []\r\n    \r\n    return fallback.subtasks.map(s => ({\r\n      ...s,\r\n      id: nanoid(),\r\n      completed: false,\r\n      completedAt: undefined,\r\n    }))\r\n  }\r\n  \r\n  return template.subtasks.map(s => ({\r\n    ...s,\r\n    id: nanoid(),\r\n    completed: false,\r\n    completedAt: undefined,\r\n  }))\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 3121, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/hooks/use-debounce.ts"],"sourcesContent":["import * as React from 'react';\r\n\r\nexport function useDebounce<T>(value: T, delay: number): T {\r\n  const [debouncedValue, setDebouncedValue] = React.useState<T>(value);\r\n\r\n  React.useEffect(() => {\r\n    const handler = setTimeout(() => {\r\n      setDebouncedValue(value);\r\n    }, delay);\r\n\r\n    return () => {\r\n      clearTimeout(handler);\r\n    };\r\n  }, [value, delay]);\r\n\r\n  return debouncedValue;\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;;AAEO,SAAS,YAAe,KAAQ,EAAE,KAAa;IACpD,MAAM,CAAC,gBAAgB,kBAAkB,GAAG,iNAAc,CAAI;IAE9D,kNAAe,CAAC;QACd,MAAM,UAAU,WAAW;YACzB,kBAAkB;QACpB,GAAG;QAEH,OAAO;YACL,aAAa;QACf;IACF,GAAG;QAAC;QAAO;KAAM;IAEjB,OAAO;AACT"}},
    {"offset": {"line": 3146, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/repositories/in-memory-repository.ts"],"sourcesContent":["import type { SystemId } from '../lib/id-types';\r\nimport type { CrudState, ItemWithSystemId } from '../lib/store-factory';\r\nimport type { CrudRepository } from './types';\r\n\r\n/**\r\n * Adapter mặc định dùng trực tiếp Zustand store để giả lập tầng persistence.\r\n * Giữ cùng signature với repository interface để sau này thay bằng API/DB dễ dàng.\r\n */\r\nexport const createInMemoryRepository = <TEntity extends ItemWithSystemId>(\r\n  stateGetter: () => CrudState<TEntity>\r\n): CrudRepository<TEntity, Omit<TEntity, 'systemId'>, Partial<TEntity>> => {\r\n  const getStore = () => stateGetter();\r\n\r\n  const ensureEntity = (systemId: SystemId): TEntity => {\r\n    const entity = getStore().findById(systemId);\r\n    if (!entity) {\r\n      throw new Error(`Không tìm thấy entity với systemId=${systemId}`);\r\n    }\r\n    return entity;\r\n  };\r\n\r\n  return {\r\n    async list() {\r\n      return [...getStore().data];\r\n    },\r\n    async getById(systemId) {\r\n      return getStore().findById(systemId);\r\n    },\r\n    async create(payload) {\r\n      return getStore().add(payload as Omit<TEntity, 'systemId'>);\r\n    },\r\n    async update(systemId, payload) {\r\n      ensureEntity(systemId);\r\n      getStore().update(systemId, payload);\r\n      return ensureEntity(systemId);\r\n    },\r\n    async softDelete(systemId) {\r\n      ensureEntity(systemId);\r\n      getStore().remove(systemId);\r\n    },\r\n    async restore(systemId) {\r\n      ensureEntity(systemId);\r\n      getStore().restore(systemId);\r\n      return getStore().findById(systemId);\r\n    },\r\n    async hardDelete(systemId) {\r\n      ensureEntity(systemId);\r\n      getStore().hardDelete(systemId);\r\n    },\r\n  };\r\n};\r\n"],"names":[],"mappings":";;;;AAQO,MAAM,2BAA2B,CACtC;IAEA,MAAM,WAAW,IAAM;IAEvB,MAAM,eAAe,CAAC;QACpB,MAAM,SAAS,WAAW,QAAQ,CAAC;QACnC,IAAI,CAAC,QAAQ;YACX,MAAM,IAAI,MAAM,CAAC,mCAAmC,EAAE,UAAU;QAClE;QACA,OAAO;IACT;IAEA,OAAO;QACL,MAAM;YACJ,OAAO;mBAAI,WAAW,IAAI;aAAC;QAC7B;QACA,MAAM,SAAQ,QAAQ;YACpB,OAAO,WAAW,QAAQ,CAAC;QAC7B;QACA,MAAM,QAAO,OAAO;YAClB,OAAO,WAAW,GAAG,CAAC;QACxB;QACA,MAAM,QAAO,QAAQ,EAAE,OAAO;YAC5B,aAAa;YACb,WAAW,MAAM,CAAC,UAAU;YAC5B,OAAO,aAAa;QACtB;QACA,MAAM,YAAW,QAAQ;YACvB,aAAa;YACb,WAAW,MAAM,CAAC;QACpB;QACA,MAAM,SAAQ,QAAQ;YACpB,aAAa;YACb,WAAW,OAAO,CAAC;YACnB,OAAO,WAAW,QAAQ,CAAC;QAC7B;QACA,MAAM,YAAW,QAAQ;YACvB,aAAa;YACb,WAAW,UAAU,CAAC;QACxB;IACF;AACF"}},
    {"offset": {"line": 3195, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/app/%28authenticated%29/warranty/page.tsx"],"sourcesContent":["\"use client\"\r\nimport { WarrantyListPage } from '@/features/warranty/warranty-list-page'\r\nexport default WarrantyListPage\r\n"],"names":[],"mappings":";;;;AACA;AADA;;uCAEe,qKAAgB"}}]
}