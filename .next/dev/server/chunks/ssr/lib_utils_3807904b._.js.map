{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/lib/utils/shipping-config-migration.ts"],"sourcesContent":["/**\r\n * Shipping Configuration Migration - V2 Multi-Account Structure\r\n * \r\n * NOTE: localStorage has been removed - all data comes from API/database\r\n */\r\n\r\nimport { ShippingConfig, GlobalShippingConfig, PartnerAccount } from '@/lib/types/shipping-config';\r\n\r\n// In-memory cache\r\nlet configCache: ShippingConfig | null = null;\r\n\r\n/**\r\n * Get default global config\r\n */\r\nfunction getDefaultGlobalConfig(): GlobalShippingConfig {\r\n  return {\r\n    weight: {\r\n      mode: 'FROM_PRODUCTS',\r\n      customValue: 500,\r\n    },\r\n    dimensions: {\r\n      length: 30,\r\n      width: 20,\r\n      height: 10,\r\n    },\r\n    requirement: 'ALLOW_CHECK_NOT_TRY',\r\n    note: '',\r\n    autoSyncCancelStatus: false,\r\n    autoSyncCODCollection: false,\r\n    latePickupWarningDays: 2,\r\n    lateDeliveryWarningDays: 7,\r\n  };\r\n}\r\n\r\n/**\r\n * Get default empty shipping config\r\n */\r\nexport function getDefaultShippingConfig(): ShippingConfig {\r\n  return {\r\n    version: 2,\r\n    partners: {\r\n      GHN: { accounts: [] },\r\n      GHTK: { accounts: [] },\r\n      VTP: { accounts: [] },\r\n      'J&T': { accounts: [] },\r\n      SPX: { accounts: [] },\r\n      VNPOST: { accounts: [] },\r\n      NINJA_VAN: { accounts: [] },\r\n      AHAMOVE: { accounts: [] },\r\n    },\r\n    global: getDefaultGlobalConfig(),\r\n    lastUpdated: new Date().toISOString(),\r\n  };\r\n}\r\n\r\n/**\r\n * Load shipping config from database (async)\r\n */\r\nexport async function loadShippingConfigAsync(): Promise<ShippingConfig> {\r\n  try {\r\n    const response = await fetch('/api/shipping-config');\r\n    if (!response.ok) throw new Error('Failed to fetch');\r\n    const config = await response.json();\r\n    configCache = config;\r\n    return config;\r\n  } catch (error) {\r\n    console.error('[ShippingConfig] Failed to load from database:', error);\r\n    // Return cached or default\r\n    return configCache ?? getDefaultShippingConfig();\r\n  }\r\n}\r\n\r\n/**\r\n * Load shipping config (sync) - returns cache or default\r\n */\r\nexport function loadShippingConfig(): ShippingConfig {\r\n  // Return cache if available\r\n  if (configCache) return configCache;\r\n  \r\n  // Return default - async load should be triggered on app init\r\n  return getDefaultShippingConfig();\r\n}\r\n\r\n/**\r\n * Save shipping config to database\r\n */\r\nexport function saveShippingConfig(config: ShippingConfig): void {\r\n  config.lastUpdated = new Date().toISOString();\r\n  \r\n  // Update cache\r\n  configCache = config;\r\n  \r\n  // Save to database\r\n  fetch('/api/shipping-config', {\r\n    method: 'POST',\r\n    headers: { 'Content-Type': 'application/json' },\r\n    body: JSON.stringify(config),\r\n  }).then(response => {\r\n    if (response.ok) {\r\n      console.log('✅ Shipping config saved to database');\r\n    } else {\r\n      console.warn('⚠️ Failed to save shipping config to database');\r\n    }\r\n  }).catch(error => {\r\n    console.error('❌ Error saving shipping config to database:', error);\r\n  });\r\n}\r\n\r\n/**\r\n * Get partner accounts\r\n */\r\nexport function getPartnerAccounts(\r\n  config: ShippingConfig,\r\n  partnerCode: keyof ShippingConfig['partners']\r\n): PartnerAccount[] {\r\n  return config.partners[partnerCode]?.accounts || [];\r\n}\r\n\r\n/**\r\n * Get default account for partner\r\n */\r\nexport function getDefaultAccount(\r\n  config: ShippingConfig,\r\n  partnerCode: keyof ShippingConfig['partners']\r\n): PartnerAccount | null {\r\n  const accounts = getPartnerAccounts(config, partnerCode);\r\n  const defaultAcc = accounts.find(acc => acc.isDefault && acc.active);\r\n  \r\n  if (defaultAcc) return defaultAcc;\r\n  \r\n  // Return first active account if no default\r\n  return accounts.find(acc => acc.active) || null;\r\n}\r\n\r\n/**\r\n * Add new account\r\n */\r\nexport function addPartnerAccount(\r\n  config: ShippingConfig,\r\n  partnerCode: keyof ShippingConfig['partners'],\r\n  account: Omit<PartnerAccount, 'id' | 'createdAt' | 'updatedAt'>\r\n): ShippingConfig {\r\n  const newAccount: PartnerAccount = {\r\n    ...account,\r\n    id: `acc_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,\r\n    createdAt: new Date().toISOString(),\r\n    updatedAt: new Date().toISOString(),\r\n  };\r\n  \r\n  config.partners[partnerCode].accounts.push(newAccount);\r\n  saveShippingConfig(config);\r\n  \r\n  return config;\r\n}\r\n\r\n/**\r\n * Update account\r\n */\r\nexport function updatePartnerAccount(\r\n  config: ShippingConfig,\r\n  partnerCode: keyof ShippingConfig['partners'],\r\n  accountId: string,\r\n  updates: Partial<PartnerAccount>\r\n): ShippingConfig {\r\n  const accounts = config.partners[partnerCode].accounts;\r\n  const index = accounts.findIndex(acc => acc.id === accountId);\r\n  \r\n  if (index !== -1) {\r\n    accounts[index] = {\r\n      ...accounts[index],\r\n      ...updates,\r\n      updatedAt: new Date().toISOString(),\r\n    };\r\n    \r\n    saveShippingConfig(config);\r\n  }\r\n  \r\n  return config;\r\n}\r\n\r\n/**\r\n * Delete account\r\n */\r\nexport function deletePartnerAccount(\r\n  config: ShippingConfig,\r\n  partnerCode: keyof ShippingConfig['partners'],\r\n  accountId: string\r\n): ShippingConfig {\r\n  const accounts = config.partners[partnerCode].accounts;\r\n  const account = accounts.find(acc => acc.id === accountId);\r\n  \r\n  // Remove the account\r\n  config.partners[partnerCode].accounts = accounts.filter(acc => acc.id !== accountId);\r\n  \r\n  // Set a new default if we deleted the default account\r\n  if (account?.isDefault && config.partners[partnerCode].accounts.length > 0) {\r\n    config.partners[partnerCode].accounts[0].isDefault = true;\r\n  }\r\n  \r\n  saveShippingConfig(config);\r\n  return config;\r\n}\r\n\r\n/**\r\n * Set default account\r\n */\r\nexport function setDefaultAccount(\r\n  config: ShippingConfig,\r\n  partnerCode: keyof ShippingConfig['partners'],\r\n  accountId: string\r\n): ShippingConfig {\r\n  const accounts = config.partners[partnerCode].accounts;\r\n  \r\n  // Remove default from all accounts\r\n  accounts.forEach(acc => {\r\n    acc.isDefault = false;\r\n  });\r\n  \r\n  // Set new default\r\n  const account = accounts.find(acc => acc.id === accountId);\r\n  if (account) {\r\n    account.isDefault = true;\r\n    account.updatedAt = new Date().toISOString();\r\n  }\r\n  \r\n  saveShippingConfig(config);\r\n  return config;\r\n}\r\n\r\n/**\r\n * Update global config\r\n */\r\nexport function updateGlobalConfig(\r\n  config: ShippingConfig,\r\n  updates: Partial<GlobalShippingConfig>\r\n): ShippingConfig {\r\n  config.global = {\r\n    ...config.global,\r\n    ...updates,\r\n  };\r\n  \r\n  saveShippingConfig(config);\r\n  return config;\r\n}\r\n\r\n/**\r\n * Export config as JSON\r\n */\r\nexport function exportShippingConfig(): string {\r\n  const config = loadShippingConfig();\r\n  return JSON.stringify(config, null, 2);\r\n}\r\n\r\n/**\r\n * Import config from JSON\r\n */\r\nexport function importShippingConfig(jsonString: string): ShippingConfig {\r\n  try {\r\n    const config = JSON.parse(jsonString);\r\n    \r\n    if (config.version !== 2) {\r\n      throw new Error('Invalid config version');\r\n    }\r\n    \r\n    saveShippingConfig(config);\r\n    return config;\r\n  } catch (error) {\r\n    console.error('Import failed:', error);\r\n    throw error;\r\n  }\r\n}\r\n\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 222, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/lib/utils/get-shipping-credentials.ts"],"sourcesContent":["/**\r\n * Helper functions to get shipping partner credentials\r\n * Centralized source from shipping_partners_config (localStorage)\r\n */\r\n\r\nimport { loadShippingConfig } from './shipping-config-migration';\r\nimport type { PartnerAccount } from '../types/shipping-config';\r\n\r\nexport type ShippingCredentials = {\r\n  apiToken: string;\r\n  partnerCode: string;\r\n  account: PartnerAccount;\r\n};\r\n\r\n/**\r\n * Get GHTK credentials from config\r\n * @throws Error if no active account found\r\n */\r\nexport function getGHTKCredentials(): ShippingCredentials {\r\n  const config = loadShippingConfig();\r\n  const accounts = config.partners.GHTK.accounts;\r\n  \r\n  // Find default active account first, then any active account\r\n  const activeAccount = accounts.find(a => a.isDefault && a.active) \r\n                     || accounts.find(a => a.active);\r\n  \r\n  if (!activeAccount) {\r\n    throw new Error('Chưa cấu hình GHTK. Vui lòng vào Cài đặt → Đối tác vận chuyển.');\r\n  }\r\n  \r\n  if (!activeAccount.credentials?.apiToken) {\r\n    throw new Error('Tài khoản GHTK chưa có API Token. Vui lòng cấu hình lại.');\r\n  }\r\n  \r\n  return {\r\n    apiToken: activeAccount.credentials.apiToken,\r\n    partnerCode: (activeAccount.credentials as any).partnerCode || '',\r\n    account: activeAccount\r\n  };\r\n}\r\n\r\n/**\r\n * Get GHN credentials from config\r\n * @throws Error if no active account found\r\n */\r\nexport function getGHNCredentials(): ShippingCredentials {\r\n  const config = loadShippingConfig();\r\n  const accounts = config.partners.GHN.accounts;\r\n  \r\n  const activeAccount = accounts.find(a => a.isDefault && a.active) \r\n                     || accounts.find(a => a.active);\r\n  \r\n  if (!activeAccount) {\r\n    throw new Error('Chưa cấu hình GHN. Vui lòng vào Cài đặt → Đối tác vận chuyển.');\r\n  }\r\n  \r\n  if (!activeAccount.credentials?.apiToken) {\r\n    throw new Error('Tài khoản GHN chưa có API Token. Vui lòng cấu hình lại.');\r\n  }\r\n  \r\n  return {\r\n    apiToken: activeAccount.credentials.apiToken,\r\n    partnerCode: (activeAccount.credentials as any).partnerCode || '',\r\n    account: activeAccount\r\n  };\r\n}\r\n\r\n/**\r\n * Check if a partner has active account\r\n */\r\nexport function hasActiveAccount(partnerCode: 'GHTK' | 'GHN' | 'VTP' | 'J&T' | 'SPX'): boolean {\r\n  try {\r\n    const config = loadShippingConfig();\r\n    const accounts = config.partners[partnerCode].accounts;\r\n    return accounts.some(a => a.active);\r\n  } catch {\r\n    return false;\r\n  }\r\n}\r\n\r\n/**\r\n * Get all active partners\r\n */\r\nexport function getActivePartners(): Array<'GHTK' | 'GHN' | 'VTP' | 'J&T' | 'SPX'> {\r\n  const partners: Array<'GHTK' | 'GHN' | 'VTP' | 'J&T' | 'SPX'> = ['GHTK', 'GHN', 'VTP', 'J&T', 'SPX'];\r\n  return partners.filter(p => hasActiveAccount(p));\r\n}\r\n"],"names":[],"mappings":";;;;;;;;;;AAAA;;;CAGC,GAED;;AAaO,SAAS;IACd,MAAM,SAAS,IAAA,qKAAkB;IACjC,MAAM,WAAW,OAAO,QAAQ,CAAC,IAAI,CAAC,QAAQ;IAE9C,6DAA6D;IAC7D,MAAM,gBAAgB,SAAS,IAAI,CAAC,CAAA,IAAK,EAAE,SAAS,IAAI,EAAE,MAAM,KAC1C,SAAS,IAAI,CAAC,CAAA,IAAK,EAAE,MAAM;IAEjD,IAAI,CAAC,eAAe;QAClB,MAAM,IAAI,MAAM;IAClB;IAEA,IAAI,CAAC,cAAc,WAAW,EAAE,UAAU;QACxC,MAAM,IAAI,MAAM;IAClB;IAEA,OAAO;QACL,UAAU,cAAc,WAAW,CAAC,QAAQ;QAC5C,aAAa,AAAC,cAAc,WAAW,CAAS,WAAW,IAAI;QAC/D,SAAS;IACX;AACF;AAMO,SAAS;IACd,MAAM,SAAS,IAAA,qKAAkB;IACjC,MAAM,WAAW,OAAO,QAAQ,CAAC,GAAG,CAAC,QAAQ;IAE7C,MAAM,gBAAgB,SAAS,IAAI,CAAC,CAAA,IAAK,EAAE,SAAS,IAAI,EAAE,MAAM,KAC1C,SAAS,IAAI,CAAC,CAAA,IAAK,EAAE,MAAM;IAEjD,IAAI,CAAC,eAAe;QAClB,MAAM,IAAI,MAAM;IAClB;IAEA,IAAI,CAAC,cAAc,WAAW,EAAE,UAAU;QACxC,MAAM,IAAI,MAAM;IAClB;IAEA,OAAO;QACL,UAAU,cAAc,WAAW,CAAC,QAAQ;QAC5C,aAAa,AAAC,cAAc,WAAW,CAAS,WAAW,IAAI;QAC/D,SAAS;IACX;AACF;AAKO,SAAS,iBAAiB,WAAmD;IAClF,IAAI;QACF,MAAM,SAAS,IAAA,qKAAkB;QACjC,MAAM,WAAW,OAAO,QAAQ,CAAC,YAAY,CAAC,QAAQ;QACtD,OAAO,SAAS,IAAI,CAAC,CAAA,IAAK,EAAE,MAAM;IACpC,EAAE,OAAM;QACN,OAAO;IACT;AACF;AAKO,SAAS;IACd,MAAM,WAA0D;QAAC;QAAQ;QAAO;QAAO;QAAO;KAAM;IACpG,OAAO,SAAS,MAAM,CAAC,CAAA,IAAK,iBAAiB;AAC/C"}}]
}