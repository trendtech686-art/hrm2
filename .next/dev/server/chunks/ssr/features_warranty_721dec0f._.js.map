{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/warranty/api/warranties-api.ts"],"sourcesContent":["/**\r\n * Warranty API - Isolated API functions\r\n */\r\n\r\nimport type { WarrantyTicket } from '../types';\r\n\r\nconst API_BASE = '/api/warranties';\r\n\r\nexport interface WarrantiesParams {\r\n  page?: number;\r\n  limit?: number;\r\n  search?: string;\r\n  status?: string;\r\n  customerId?: string;\r\n  branchId?: string;\r\n  startDate?: string;\r\n  endDate?: string;\r\n  sortBy?: string;\r\n  sortOrder?: 'asc' | 'desc';\r\n}\r\n\r\nexport interface PaginatedResponse<T> {\r\n  data: T[];\r\n  pagination: {\r\n    page: number;\r\n    limit: number;\r\n    total: number;\r\n    totalPages: number;\r\n  };\r\n}\r\n\r\nexport async function fetchWarranties(params: WarrantiesParams = {}): Promise<PaginatedResponse<WarrantyTicket>> {\r\n  const { page = 1, limit = 50, ...rest } = params;\r\n  \r\n  const searchParams = new URLSearchParams({\r\n    page: String(page),\r\n    limit: String(limit),\r\n  });\r\n  \r\n  Object.entries(rest).forEach(([key, value]) => {\r\n    if (value != null && value !== '') {\r\n      searchParams.set(key, String(value));\r\n    }\r\n  });\r\n  \r\n  const res = await fetch(`${API_BASE}?${searchParams}`, { credentials: 'include' });\r\n  if (!res.ok) throw new Error(`Failed to fetch warranties: ${res.statusText}`);\r\n  return res.json();\r\n}\r\n\r\nexport async function fetchWarranty(id: string): Promise<WarrantyTicket> {\r\n  const res = await fetch(`${API_BASE}/${id}`, { credentials: 'include' });\r\n  if (!res.ok) throw new Error(`Failed to fetch warranty: ${res.statusText}`);\r\n  return res.json();\r\n}\r\n\r\nexport async function createWarranty(data: Partial<WarrantyTicket>): Promise<WarrantyTicket> {\r\n  const res = await fetch(API_BASE, {\r\n    method: 'POST',\r\n    headers: { 'Content-Type': 'application/json' },\r\n    credentials: 'include',\r\n    body: JSON.stringify(data),\r\n  });\r\n  if (!res.ok) {\r\n    const error = await res.json().catch(() => ({}));\r\n    throw new Error(error.message || `Failed to create warranty`);\r\n  }\r\n  return res.json();\r\n}\r\n\r\nexport async function updateWarranty(systemId: string, data: Partial<WarrantyTicket>): Promise<WarrantyTicket> {\r\n  const res = await fetch(`${API_BASE}/${systemId}`, {\r\n    method: 'PATCH',\r\n    headers: { 'Content-Type': 'application/json' },\r\n    credentials: 'include',\r\n    body: JSON.stringify(data),\r\n  });\r\n  if (!res.ok) {\r\n    const error = await res.json().catch(() => ({}));\r\n    throw new Error(error.message || `Failed to update warranty`);\r\n  }\r\n  return res.json();\r\n}\r\n\r\nexport async function deleteWarranty(id: string): Promise<void> {\r\n  const res = await fetch(`${API_BASE}/${id}`, { method: 'DELETE', credentials: 'include' });\r\n  if (!res.ok) throw new Error(`Failed to delete warranty`);\r\n}\r\n\r\nexport async function fetchWarrantyStats(): Promise<{\r\n  total: number;\r\n  pending: number;\r\n  processed: number;\r\n  completed: number;\r\n}> {\r\n  const res = await fetch(`${API_BASE}/stats`, { credentials: 'include' });\r\n  if (!res.ok) throw new Error(`Failed to fetch warranty stats`);\r\n  return res.json();\r\n}\r\n"],"names":[],"mappings":"AAAA;;CAEC;;;;;;;;;;;;;;AAID,MAAM,WAAW;AAyBV,eAAe,gBAAgB,SAA2B,CAAC,CAAC;IACjE,MAAM,EAAE,OAAO,CAAC,EAAE,QAAQ,EAAE,EAAE,GAAG,MAAM,GAAG;IAE1C,MAAM,eAAe,IAAI,gBAAgB;QACvC,MAAM,OAAO;QACb,OAAO,OAAO;IAChB;IAEA,OAAO,OAAO,CAAC,MAAM,OAAO,CAAC,CAAC,CAAC,KAAK,MAAM;QACxC,IAAI,SAAS,QAAQ,UAAU,IAAI;YACjC,aAAa,GAAG,CAAC,KAAK,OAAO;QAC/B;IACF;IAEA,MAAM,MAAM,MAAM,MAAM,GAAG,SAAS,CAAC,EAAE,cAAc,EAAE;QAAE,aAAa;IAAU;IAChF,IAAI,CAAC,IAAI,EAAE,EAAE,MAAM,IAAI,MAAM,CAAC,4BAA4B,EAAE,IAAI,UAAU,EAAE;IAC5E,OAAO,IAAI,IAAI;AACjB;AAEO,eAAe,cAAc,EAAU;IAC5C,MAAM,MAAM,MAAM,MAAM,GAAG,SAAS,CAAC,EAAE,IAAI,EAAE;QAAE,aAAa;IAAU;IACtE,IAAI,CAAC,IAAI,EAAE,EAAE,MAAM,IAAI,MAAM,CAAC,0BAA0B,EAAE,IAAI,UAAU,EAAE;IAC1E,OAAO,IAAI,IAAI;AACjB;AAEO,eAAe,eAAe,IAA6B;IAChE,MAAM,MAAM,MAAM,MAAM,UAAU;QAChC,QAAQ;QACR,SAAS;YAAE,gBAAgB;QAAmB;QAC9C,aAAa;QACb,MAAM,KAAK,SAAS,CAAC;IACvB;IACA,IAAI,CAAC,IAAI,EAAE,EAAE;QACX,MAAM,QAAQ,MAAM,IAAI,IAAI,GAAG,KAAK,CAAC,IAAM,CAAC,CAAC,CAAC;QAC9C,MAAM,IAAI,MAAM,MAAM,OAAO,IAAI,CAAC,yBAAyB,CAAC;IAC9D;IACA,OAAO,IAAI,IAAI;AACjB;AAEO,eAAe,eAAe,QAAgB,EAAE,IAA6B;IAClF,MAAM,MAAM,MAAM,MAAM,GAAG,SAAS,CAAC,EAAE,UAAU,EAAE;QACjD,QAAQ;QACR,SAAS;YAAE,gBAAgB;QAAmB;QAC9C,aAAa;QACb,MAAM,KAAK,SAAS,CAAC;IACvB;IACA,IAAI,CAAC,IAAI,EAAE,EAAE;QACX,MAAM,QAAQ,MAAM,IAAI,IAAI,GAAG,KAAK,CAAC,IAAM,CAAC,CAAC,CAAC;QAC9C,MAAM,IAAI,MAAM,MAAM,OAAO,IAAI,CAAC,yBAAyB,CAAC;IAC9D;IACA,OAAO,IAAI,IAAI;AACjB;AAEO,eAAe,eAAe,EAAU;IAC7C,MAAM,MAAM,MAAM,MAAM,GAAG,SAAS,CAAC,EAAE,IAAI,EAAE;QAAE,QAAQ;QAAU,aAAa;IAAU;IACxF,IAAI,CAAC,IAAI,EAAE,EAAE,MAAM,IAAI,MAAM,CAAC,yBAAyB,CAAC;AAC1D;AAEO,eAAe;IAMpB,MAAM,MAAM,MAAM,MAAM,GAAG,SAAS,MAAM,CAAC,EAAE;QAAE,aAAa;IAAU;IACtE,IAAI,CAAC,IAAI,EAAE,EAAE,MAAM,IAAI,MAAM,CAAC,8BAA8B,CAAC;IAC7D,OAAO,IAAI,IAAI;AACjB"}},
    {"offset": {"line": 93, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/warranty/hooks/use-warranties.ts"],"sourcesContent":["/**\r\n * useWarranties - React Query hooks\r\n * \r\n * ⚠️ Direct import: import { useWarranties } from '@/features/warranty/hooks/use-warranties'\r\n */\r\n\r\nimport { useQuery, useMutation, useQueryClient, keepPreviousData } from '@tanstack/react-query';\r\nimport {\r\n  fetchWarranties,\r\n  fetchWarranty,\r\n  createWarranty,\r\n  updateWarranty,\r\n  deleteWarranty,\r\n  fetchWarrantyStats,\r\n  type WarrantiesParams,\r\n} from '../api/warranties-api';\r\nimport type { WarrantyTicket } from '../types';\r\n\r\nexport const warrantyKeys = {\r\n  all: ['warranties'] as const,\r\n  lists: () => [...warrantyKeys.all, 'list'] as const,\r\n  list: (params: WarrantiesParams) => [...warrantyKeys.lists(), params] as const,\r\n  details: () => [...warrantyKeys.all, 'detail'] as const,\r\n  detail: (id: string) => [...warrantyKeys.details(), id] as const,\r\n  stats: () => [...warrantyKeys.all, 'stats'] as const,\r\n};\r\n\r\nexport function useWarranties(params: WarrantiesParams = {}) {\r\n  return useQuery({\r\n    queryKey: warrantyKeys.list(params),\r\n    queryFn: () => fetchWarranties(params),\r\n    staleTime: 30_000,\r\n    gcTime: 5 * 60 * 1000,\r\n    placeholderData: keepPreviousData,\r\n  });\r\n}\r\n\r\nexport function useWarranty(id: string | null | undefined) {\r\n  return useQuery({\r\n    queryKey: warrantyKeys.detail(id!),\r\n    queryFn: () => fetchWarranty(id!),\r\n    enabled: !!id,\r\n    staleTime: 60_000,\r\n  });\r\n}\r\n\r\nexport function useWarrantyStats() {\r\n  return useQuery({\r\n    queryKey: warrantyKeys.stats(),\r\n    queryFn: fetchWarrantyStats,\r\n    staleTime: 60_000,\r\n  });\r\n}\r\n\r\ninterface UseWarrantyMutationsOptions {\r\n  onCreateSuccess?: (warranty: WarrantyTicket) => void;\r\n  onUpdateSuccess?: (warranty: WarrantyTicket) => void;\r\n  onDeleteSuccess?: () => void;\r\n  onError?: (error: Error) => void;\r\n}\r\n\r\nexport function useWarrantyMutations(options: UseWarrantyMutationsOptions = {}) {\r\n  const queryClient = useQueryClient();\r\n  \r\n  const create = useMutation({\r\n    mutationFn: createWarranty,\r\n    onSuccess: (data) => {\r\n      queryClient.invalidateQueries({ queryKey: warrantyKeys.lists() });\r\n      queryClient.invalidateQueries({ queryKey: warrantyKeys.stats() });\r\n      options.onCreateSuccess?.(data);\r\n    },\r\n    onError: options.onError,\r\n  });\r\n  \r\n  const update = useMutation({\r\n    mutationFn: ({ systemId, data }: { systemId: string; data: Partial<WarrantyTicket> }) => \r\n      updateWarranty(systemId, data),\r\n    onSuccess: (data, variables) => {\r\n      queryClient.invalidateQueries({ queryKey: warrantyKeys.detail(variables.systemId) });\r\n      queryClient.invalidateQueries({ queryKey: warrantyKeys.lists() });\r\n      queryClient.invalidateQueries({ queryKey: warrantyKeys.stats() });\r\n      options.onUpdateSuccess?.(data);\r\n    },\r\n    onError: options.onError,\r\n  });\r\n  \r\n  const remove = useMutation({\r\n    mutationFn: deleteWarranty,\r\n    onSuccess: () => {\r\n      queryClient.invalidateQueries({ queryKey: warrantyKeys.all });\r\n      options.onDeleteSuccess?.();\r\n    },\r\n    onError: options.onError,\r\n  });\r\n  \r\n  return { create, update, remove };\r\n}\r\n\r\nexport function usePendingWarranties() {\r\n  return useWarranties({ status: 'pending' });\r\n}\r\n\r\nexport function useWarrantiesByCustomer(customerId: string | null | undefined) {\r\n  return useWarranties({ customerId: customerId || undefined, limit: 50 });\r\n}\r\n"],"names":[],"mappings":";;;;;;;;;;;;;;;;AAAA;;;;CAIC,GAED;AAAA;AAAA;AAAA;AACA;;;AAWO,MAAM,eAAe;IAC1B,KAAK;QAAC;KAAa;IACnB,OAAO,IAAM;eAAI,aAAa,GAAG;YAAE;SAAO;IAC1C,MAAM,CAAC,SAA6B;eAAI,aAAa,KAAK;YAAI;SAAO;IACrE,SAAS,IAAM;eAAI,aAAa,GAAG;YAAE;SAAS;IAC9C,QAAQ,CAAC,KAAe;eAAI,aAAa,OAAO;YAAI;SAAG;IACvD,OAAO,IAAM;eAAI,aAAa,GAAG;YAAE;SAAQ;AAC7C;AAEO,SAAS,cAAc,SAA2B,CAAC,CAAC;IACzD,OAAO,IAAA,uLAAQ,EAAC;QACd,UAAU,aAAa,IAAI,CAAC;QAC5B,SAAS,IAAM,IAAA,mKAAe,EAAC;QAC/B,WAAW;QACX,QAAQ,IAAI,KAAK;QACjB,iBAAiB,2LAAgB;IACnC;AACF;AAEO,SAAS,YAAY,EAA6B;IACvD,OAAO,IAAA,uLAAQ,EAAC;QACd,UAAU,aAAa,MAAM,CAAC;QAC9B,SAAS,IAAM,IAAA,iKAAa,EAAC;QAC7B,SAAS,CAAC,CAAC;QACX,WAAW;IACb;AACF;AAEO,SAAS;IACd,OAAO,IAAA,uLAAQ,EAAC;QACd,UAAU,aAAa,KAAK;QAC5B,SAAS,sKAAkB;QAC3B,WAAW;IACb;AACF;AASO,SAAS,qBAAqB,UAAuC,CAAC,CAAC;IAC5E,MAAM,cAAc,IAAA,wMAAc;IAElC,MAAM,SAAS,IAAA,6LAAW,EAAC;QACzB,YAAY,kKAAc;QAC1B,WAAW,CAAC;YACV,YAAY,iBAAiB,CAAC;gBAAE,UAAU,aAAa,KAAK;YAAG;YAC/D,YAAY,iBAAiB,CAAC;gBAAE,UAAU,aAAa,KAAK;YAAG;YAC/D,QAAQ,eAAe,GAAG;QAC5B;QACA,SAAS,QAAQ,OAAO;IAC1B;IAEA,MAAM,SAAS,IAAA,6LAAW,EAAC;QACzB,YAAY,CAAC,EAAE,QAAQ,EAAE,IAAI,EAAuD,GAClF,IAAA,kKAAc,EAAC,UAAU;QAC3B,WAAW,CAAC,MAAM;YAChB,YAAY,iBAAiB,CAAC;gBAAE,UAAU,aAAa,MAAM,CAAC,UAAU,QAAQ;YAAE;YAClF,YAAY,iBAAiB,CAAC;gBAAE,UAAU,aAAa,KAAK;YAAG;YAC/D,YAAY,iBAAiB,CAAC;gBAAE,UAAU,aAAa,KAAK;YAAG;YAC/D,QAAQ,eAAe,GAAG;QAC5B;QACA,SAAS,QAAQ,OAAO;IAC1B;IAEA,MAAM,SAAS,IAAA,6LAAW,EAAC;QACzB,YAAY,kKAAc;QAC1B,WAAW;YACT,YAAY,iBAAiB,CAAC;gBAAE,UAAU,aAAa,GAAG;YAAC;YAC3D,QAAQ,eAAe;QACzB;QACA,SAAS,QAAQ,OAAO;IAC1B;IAEA,OAAO;QAAE;QAAQ;QAAQ;IAAO;AAClC;AAEO,SAAS;IACd,OAAO,cAAc;QAAE,QAAQ;IAAU;AAC3C;AAEO,SAAS,wBAAwB,UAAqC;IAC3E,OAAO,cAAc;QAAE,YAAY,cAAc;QAAW,OAAO;IAAG;AACxE"}},
    {"offset": {"line": 231, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/warranty/hooks/use-all-warranties.ts"],"sourcesContent":["/**\r\n * useAllWarranties - Convenience hook for components needing all warranties as flat array\r\n */\r\n\r\nimport { useWarranties } from './use-warranties';\r\n\r\nexport function useAllWarranties() {\r\n  const query = useWarranties({});\r\n  \r\n  return {\r\n    data: query.data?.data || [],\r\n    isLoading: query.isLoading,\r\n    isError: query.isError,\r\n    error: query.error,\r\n  };\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;;CAEC,GAED;;AAEO,SAAS;IACd,MAAM,QAAQ,IAAA,mKAAa,EAAC,CAAC;IAE7B,OAAO;QACL,MAAM,MAAM,IAAI,EAAE,QAAQ,EAAE;QAC5B,WAAW,MAAM,SAAS;QAC1B,SAAS,MAAM,OAAO;QACtB,OAAO,MAAM,KAAK;IACpB;AACF"}},
    {"offset": {"line": 252, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/warranty/warranty-sla-utils.ts"],"sourcesContent":["/**\r\n * Warranty SLA Utilities\r\n * \r\n * Calculate and format SLA-related metrics for warranty tickets\r\n * \r\n * NOTE: SLA settings are now synced with database via warranty-settings-sync.ts\r\n * These functions are kept for backwards compatibility but use the sync utility internally\r\n */\r\n\r\nimport { WarrantyTicket } from './types';\r\nimport {\r\n  getWarrantySLATargetsSync,\r\n  loadWarrantySLATargetsAsync,\r\n  saveWarrantySLATargetsAsync,\r\n} from '@/lib/warranty-settings-sync';\r\n\r\n/**\r\n * Default SLA Targets (in minutes)\r\n */\r\nconst DEFAULT_WARRANTY_SLA_TARGETS = {\r\n  response: 2 * 60,      // 2 hours - Thời gian phản hồi\r\n  processing: 24 * 60,   // 24 hours - Thời gian xử lý\r\n  return: 48 * 60,       // 48 hours - Thời gian trả hàng\r\n};\r\n\r\n/**\r\n * Load SLA targets from database (async)\r\n * @deprecated Use loadWarrantySLATargetsAsync from warranty-settings-sync.ts\r\n */\r\nexport function loadWarrantySLATargets() {\r\n  return getWarrantySLATargetsSync();\r\n}\r\n\r\n/**\r\n * Save SLA targets to database\r\n * @deprecated Use saveWarrantySLATargetsAsync from warranty-settings-sync.ts\r\n */\r\nexport function saveWarrantySLATargets(targets: typeof DEFAULT_WARRANTY_SLA_TARGETS) {\r\n  // Fire and forget - save to database in background\r\n  saveWarrantySLATargetsAsync(targets).catch(error => {\r\n    console.error('Failed to save SLA targets:', error);\r\n  });\r\n}\r\n\r\n/**\r\n * Current SLA Targets (loaded from cache or localStorage)\r\n * Uses sync function for immediate access\r\n */\r\nexport const WARRANTY_SLA_TARGETS = getWarrantySLATargetsSync();\r\n\r\nexport interface WarrantyOverdueStatus {\r\n  isOverdueResponse: boolean;\r\n  isOverdueProcessing: boolean;\r\n  isOverdueReturn: boolean;\r\n  responseTimeLeft: number; // minutes (negative if overdue)\r\n  processingTimeLeft: number;\r\n  returnTimeLeft: number;\r\n  overdueDuration?: string | undefined; // formatted string\r\n}\r\n\r\n/**\r\n * Check if warranty ticket is overdue\r\n */\r\nexport function checkWarrantyOverdue(ticket: WarrantyTicket): WarrantyOverdueStatus {\r\n  const now = new Date();\r\n  const createdAt = new Date(ticket.createdAt);\r\n  const elapsedMinutes = Math.floor((now.getTime() - createdAt.getTime()) / (1000 * 60));\r\n\r\n  // Response time: from created to first action (status changed to pending)\r\n  const hasResponse = ticket.status !== 'incomplete';\r\n  const responseTimeLeft = WARRANTY_SLA_TARGETS.response - elapsedMinutes;\r\n  const isOverdueResponse = !hasResponse && responseTimeLeft < 0;\r\n\r\n  // Processing time: from created to processed\r\n  const hasProcessed = ticket.status === 'processed' || ticket.status === 'returned';\r\n  const processingTimeLeft = WARRANTY_SLA_TARGETS.processing - elapsedMinutes;\r\n  const isOverdueProcessing = !hasProcessed && processingTimeLeft < 0;\r\n\r\n  // Return time: from created to returned\r\n  const hasReturned = ticket.status === 'returned';\r\n  const returnTimeLeft = WARRANTY_SLA_TARGETS.return - elapsedMinutes;\r\n  const isOverdueReturn = !hasReturned && returnTimeLeft < 0;\r\n\r\n  // Format most critical overdue duration\r\n  let overdueDuration: string | undefined;\r\n  if (isOverdueResponse) {\r\n    overdueDuration = formatTimeLeft(Math.abs(responseTimeLeft));\r\n  } else if (isOverdueProcessing) {\r\n    overdueDuration = formatTimeLeft(Math.abs(processingTimeLeft));\r\n  } else if (isOverdueReturn) {\r\n    overdueDuration = formatTimeLeft(Math.abs(returnTimeLeft));\r\n  }\r\n\r\n  return {\r\n    isOverdueResponse,\r\n    isOverdueProcessing,\r\n    isOverdueReturn,\r\n    responseTimeLeft,\r\n    processingTimeLeft,\r\n    returnTimeLeft,\r\n    overdueDuration,\r\n  };\r\n}\r\n\r\n/**\r\n * Format minutes to readable time string\r\n * Examples: \"2 giờ 30 phút\", \"45 phút\", \"1 ngày 3 giờ 15 phút\"\r\n */\r\nexport function formatTimeLeft(minutes: number): string {\r\n  const abs = Math.abs(minutes);\r\n  const totalHours = Math.floor(abs / 60);\r\n  const mins = Math.floor(abs % 60);\r\n  \r\n  if (abs < 60) {\r\n    return `${mins} phút`;\r\n  }\r\n  if (totalHours < 24) {\r\n    return mins > 0 ? `${totalHours} giờ ${mins} phút` : `${totalHours} giờ`;\r\n  }\r\n  const days = Math.floor(totalHours / 24);\r\n  const remainingHours = totalHours % 24;\r\n  \r\n  // Always show format: X ngày X giờ X phút\r\n  const parts: string[] = [];\r\n  parts.push(`${days} ngày`);\r\n  if (remainingHours > 0) {\r\n    parts.push(`${remainingHours} giờ`);\r\n  }\r\n  if (mins > 0) {\r\n    parts.push(`${mins} phút`);\r\n  }\r\n  \r\n  return parts.join(' ');\r\n}\r\n\r\n/**\r\n * Get hours since a timestamp\r\n */\r\nexport function getHoursSince(timestamp: string): number {\r\n  const now = new Date();\r\n  const then = new Date(timestamp);\r\n  return Math.floor((now.getTime() - then.getTime()) / (1000 * 60 * 60));\r\n}\r\n\r\n/**\r\n * Get urgency level based on time left\r\n */\r\nexport function getUrgencyLevel(minutesLeft: number): 'normal' | 'warning' | 'critical' | 'overdue' {\r\n  if (minutesLeft < 0) return 'overdue';\r\n  \r\n  const hoursLeft = minutesLeft / 60;\r\n  if (hoursLeft < 1) return 'critical';\r\n  if (hoursLeft < 3) return 'warning';\r\n  return 'normal';\r\n}\r\n\r\n/**\r\n * Get urgency color class\r\n */\r\nexport function getUrgencyColor(level: 'normal' | 'warning' | 'critical' | 'overdue'): string {\r\n  const colors = {\r\n    normal: 'text-muted-foreground',\r\n    warning: 'text-orange-500 font-medium',\r\n    critical: 'text-destructive animate-pulse',\r\n    overdue: 'text-destructive font-semibold',\r\n  };\r\n  return colors[level];\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 379, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/warranty/columns.tsx"],"sourcesContent":["import * as React from \"react\";\r\nimport type { AppRouterInstance } from 'next/dist/shared/lib/app-router-context.shared-runtime';\r\nimport { toast } from 'sonner';\r\nimport { formatDate, formatDateTime } from '../../lib/date-utils';\r\nimport type { WarrantyTicket } from './types';\r\nimport type { Order } from '../orders/types';\r\nimport { WARRANTY_STATUS_LABELS, WARRANTY_STATUS_COLORS, WARRANTY_SETTLEMENT_STATUS_LABELS, WARRANTY_SETTLEMENT_STATUS_COLORS, type SettlementStatus } from './types';\r\nimport { checkWarrantyOverdue, formatTimeLeft } from './warranty-sla-utils';\r\nimport { Checkbox } from \"../../components/ui/checkbox\";\r\nimport { DataTableColumnHeader } from \"../../components/data-table/data-table-column-header\";\r\nimport { Badge } from \"../../components/ui/badge\";\r\nimport type { ColumnDef } from '../../components/data-table/types';\r\nimport { Button } from \"../../components/ui/button\";\r\nimport { Pencil, Trash2, MoreHorizontal, Package, Printer, Link as LinkIcon, AlertTriangle } from \"lucide-react\";\r\nimport { DropdownMenu, DropdownMenuContent, DropdownMenuItem, DropdownMenuSeparator, DropdownMenuTrigger } from \"../../components/ui/dropdown-menu\";\r\nimport { ROUTES, generatePath } from '../../lib/router';\r\n\r\n// Local helper function to calculate settlement status\r\nfunction calculateSettlementStatus(totalSettlement: number, totalPaid: number, shippingFee: number): SettlementStatus {\r\n  const totalDue = totalSettlement + shippingFee;\r\n  if (totalPaid >= totalDue) return 'completed';\r\n  if (totalPaid > 0) return 'partial';\r\n  return 'pending';\r\n}\r\n\r\nconst formatCurrency = (value?: number) => {\r\n  if (typeof value !== 'number') return '0';\r\n  return new Intl.NumberFormat('vi-VN').format(value);\r\n};\r\n\r\nexport const getColumns = (\r\n  onDelete: (systemId: string) => void,\r\n  onEdit: (ticket: WarrantyTicket) => void,\r\n  router: AppRouterInstance,\r\n  orders: Order[] = [], // ✅ Add orders parameter\r\n): ColumnDef<WarrantyTicket>[] => [\r\n  // Select column - sticky left\r\n  {\r\n    id: \"select\",\r\n    header: ({ isAllPageRowsSelected, isSomePageRowsSelected, onToggleAll }) => (\r\n      <Checkbox\r\n        checked={isAllPageRowsSelected ? true : isSomePageRowsSelected ? \"indeterminate\" : false}\r\n        onCheckedChange={(value) => onToggleAll?.(!!value)}\r\n        aria-label=\"Select all\"\r\n      />\r\n    ),\r\n    cell: ({ onToggleSelect, isSelected }) => (\r\n      <Checkbox\r\n        checked={isSelected}\r\n        onCheckedChange={onToggleSelect}\r\n        aria-label=\"Select row\"\r\n      />\r\n    ),\r\n    size: 48,\r\n    meta: {\r\n      displayName: \"Chọn\",\r\n      sticky: \"left\",\r\n    }\r\n  },\r\n\r\n  // ID column - clickable, sticky left\r\n  {\r\n    id: \"id\",\r\n    accessorKey: \"id\",\r\n    header: ({ sorting, setSorting }) => (\r\n      <DataTableColumnHeader \r\n        title=\"Mã phiếu\"\r\n        sortKey=\"id\"\r\n        isSorted={sorting?.id === 'id'}\r\n        sortDirection={sorting?.desc ? 'desc' : 'asc'}\r\n        onSort={() => setSorting?.((s: any) => ({ id: 'id', desc: s.id === 'id' ? !s.desc : false }))}\r\n      />\r\n    ),\r\n    cell: ({ row }) => (\r\n      <div \r\n        className=\"font-medium text-primary cursor-pointer hover:underline whitespace-nowrap\" \r\n        onClick={() => router.push(`/warranty/${row.systemId}`)}\r\n      >\r\n        {row.id}\r\n      </div>\r\n    ),\r\n    meta: {\r\n      displayName: \"Mã phiếu\",\r\n      group: \"Thông tin cơ bản\"\r\n    },\r\n  },\r\n\r\n  // Branch & Employee info\r\n  {\r\n    id: \"branchName\",\r\n    accessorKey: \"branchName\",\r\n    header: \"Chi nhánh\",\r\n    cell: ({ row }) => (\r\n      <div className=\"max-w-[150px] truncate\" title={row.branchName}>\r\n        {row.branchName}\r\n      </div>\r\n    ),\r\n    meta: {\r\n      displayName: \"Chi nhánh\",\r\n      group: \"Thông tin cơ bản\"\r\n    },\r\n  },\r\n\r\n  {\r\n    id: \"employeeName\",\r\n    accessorKey: \"employeeName\",\r\n    header: \"Nhân viên\",\r\n    cell: ({ row }) => (\r\n      <div className=\"max-w-[150px] truncate\" title={row.employeeName}>\r\n        {row.employeeName}\r\n      </div>\r\n    ),\r\n    meta: {\r\n      displayName: \"Nhân viên phụ trách\",\r\n      group: \"Thông tin cơ bản\"\r\n    },\r\n  },\r\n\r\n  // Customer info\r\n  {\r\n    id: \"customerName\",\r\n    accessorKey: \"customerName\",\r\n    header: ({ sorting, setSorting }) => (\r\n      <DataTableColumnHeader \r\n        title=\"Khách hàng\"\r\n        sortKey=\"customerName\"\r\n        isSorted={sorting?.id === 'customerName'}\r\n        sortDirection={sorting?.desc ? 'desc' : 'asc'}\r\n        onSort={() => setSorting?.((s: any) => ({ id: 'customerName', desc: s.id === 'customerName' ? !s.desc : false }))}\r\n      />\r\n    ),\r\n    cell: ({ row }) => (\r\n      <div className=\"max-w-[180px] truncate\" title={row.customerName}>\r\n        {row.customerName}\r\n      </div>\r\n    ),\r\n    meta: {\r\n      displayName: \"Tên khách hàng\",\r\n      group: \"Thông tin khách hàng\"\r\n    },\r\n  },\r\n\r\n  {\r\n    id: \"customerPhone\",\r\n    accessorKey: \"customerPhone\",\r\n    header: \"Số điện thoại\",\r\n    cell: ({ row }) => (\r\n      <div className=\"whitespace-nowrap\">{row.customerPhone}</div>\r\n    ),\r\n    meta: {\r\n      displayName: \"SĐT khách hàng\",\r\n      group: \"Thông tin khách hàng\"\r\n    },\r\n  },\r\n\r\n  {\r\n    id: \"customerAddress\",\r\n    accessorKey: \"customerAddress\",\r\n    header: \"Địa chỉ\",\r\n    cell: ({ row }) => (\r\n      <div className=\"max-w-[200px] truncate\" title={row.customerAddress}>\r\n        {row.customerAddress || '—'}\r\n      </div>\r\n    ),\r\n    meta: {\r\n      displayName: \"Địa chỉ khách hàng\",\r\n      group: \"Thông tin khách hàng\"\r\n    },\r\n  },\r\n\r\n  // Tracking info\r\n  {\r\n    id: \"trackingCode\",\r\n    accessorKey: \"trackingCode\",\r\n    header: \"Mã vận đơn / Mã tra cứu\",\r\n    cell: ({ row }) => (\r\n      <div className=\"space-y-0.5\">\r\n        <div className=\"font-mono text-body-xs whitespace-nowrap\">{row.trackingCode}</div>\r\n        {row.publicTrackingCode && (\r\n          <div className=\"font-mono text-body-xs text-muted-foreground\">\r\n            Tra cứu: {row.publicTrackingCode}\r\n          </div>\r\n        )}\r\n      </div>\r\n    ),\r\n    meta: {\r\n      displayName: \"Mã vận đơn / Tra cứu\",\r\n      group: \"Vận chuyển\"\r\n    },\r\n  },\r\n\r\n  {\r\n    id: \"shippingFee\",\r\n    accessorKey: \"shippingFee\",\r\n    header: \"Phí cước\",\r\n    cell: ({ row }) => (\r\n      <div className=\"text-right whitespace-nowrap\">\r\n        {row.shippingFee ? `${formatCurrency(row.shippingFee)} ₫` : '—'}\r\n      </div>\r\n    ),\r\n    meta: {\r\n      displayName: \"Phí cước\",\r\n      group: \"Vận chuyển\"\r\n    },\r\n  },\r\n\r\n  // Reference fields\r\n  {\r\n    id: \"linkedOrderId\",\r\n    accessorKey: \"linkedOrderSystemId\", // ✅ Use systemId\r\n    header: \"Đơn hàng liên kết\",\r\n    cell: ({ row }) => {\r\n      if (!row.linkedOrderSystemId) return <span className=\"text-muted-foreground text-body-xs\">—</span>;\r\n      const orderBusinessId = orders.find(o => o.systemId === row.linkedOrderSystemId)?.id;\r\n      return (\r\n        <div \r\n          className=\"font-medium text-primary cursor-pointer hover:underline whitespace-nowrap\" \r\n          onClick={() => router.push(`/orders/${row.linkedOrderSystemId}`)}\r\n        >\r\n          {orderBusinessId || row.linkedOrderSystemId}\r\n        </div>\r\n      );\r\n    },\r\n    meta: {\r\n      displayName: \"Đơn hàng liên kết\",\r\n      group: \"Tham chiếu\"\r\n    },\r\n  },\r\n\r\n  {\r\n    id: \"referenceUrl\",\r\n    accessorKey: \"referenceUrl\",\r\n    header: \"Link tham chiếu\",\r\n    cell: ({ row }) => {\r\n      if (!row.referenceUrl) return <span className=\"text-muted-foreground text-body-xs\">—</span>;\r\n      return (\r\n        <a \r\n          href={row.referenceUrl}\r\n          target=\"_blank\"\r\n          rel=\"noopener noreferrer\"\r\n          className=\"text-primary hover:underline text-body-xs flex items-center gap-1\"\r\n          onClick={(e) => e.stopPropagation()}\r\n        >\r\n          <LinkIcon className=\"h-3 w-3\" />\r\n          Link\r\n        </a>\r\n      );\r\n    },\r\n    meta: {\r\n      displayName: \"Đường dẫn tham chiếu\",\r\n      group: \"Tham chiếu\"\r\n    },\r\n  },\r\n\r\n  {\r\n    id: \"externalReference\",\r\n    accessorKey: \"externalReference\",\r\n    header: \"Mã tham chiếu\",\r\n    cell: ({ row }) => (\r\n      <div className=\"font-mono text-body-xs whitespace-nowrap\">\r\n        {row.externalReference || '—'}\r\n      </div>\r\n    ),\r\n    meta: {\r\n      displayName: \"Mã tham chiếu bên ngoài\",\r\n      group: \"Tham chiếu\"\r\n    },\r\n  },\r\n\r\n  // Status\r\n  {\r\n    id: \"status\",\r\n    accessorKey: \"status\",\r\n    header: ({ sorting, setSorting }) => (\r\n      <DataTableColumnHeader \r\n        title=\"Trạng thái\"\r\n        sortKey=\"status\"\r\n        isSorted={sorting?.id === 'status'}\r\n        sortDirection={sorting?.desc ? 'desc' : 'asc'}\r\n        onSort={() => setSorting?.((s: any) => ({ id: 'status', desc: s.id === 'status' ? !s.desc : false }))}\r\n      />\r\n    ),\r\n    cell: ({ row }) => (\r\n      <Badge className={WARRANTY_STATUS_COLORS[row.status]}>\r\n        {WARRANTY_STATUS_LABELS[row.status]}\r\n      </Badge>\r\n    ),\r\n    meta: {\r\n      displayName: \"Trạng thái\",\r\n      group: \"Trạng thái\"\r\n    },\r\n  },\r\n\r\n  // SLA Status column - NEW\r\n  {\r\n    id: \"slaStatus\",\r\n    header: \"SLA\",\r\n    cell: ({ row }) => {\r\n      const overdueStatus = checkWarrantyOverdue(row);\r\n      \r\n      // Nếu đã trả hàng\r\n      if (row.status === 'returned') {\r\n        return <span className=\"text-muted-foreground\">Hoàn thành</span>;\r\n      }\r\n\r\n      // Check trạng thái quá hạn (kiểm tra từng loại)\r\n      const isOverdue = overdueStatus.isOverdueResponse || \r\n                        overdueStatus.isOverdueProcessing || \r\n                        overdueStatus.isOverdueReturn;\r\n\r\n      // Nếu không quá hạn - hiển thị thời gian còn lại theo trạng thái\r\n      if (!isOverdue) {\r\n        let timeLeft = 0;\r\n        if (row.status === 'incomplete') {\r\n          timeLeft = overdueStatus.responseTimeLeft;\r\n        } else if (row.status === 'pending') {\r\n          timeLeft = overdueStatus.processingTimeLeft;\r\n        } else if (row.status === 'processed') {\r\n          timeLeft = overdueStatus.returnTimeLeft;\r\n        }\r\n        \r\n        const timeLeftStr = formatTimeLeft(timeLeft);\r\n        return (\r\n          <div className=\"flex items-center gap-1\">\r\n            <span className=\"text-green-600\">Còn {timeLeftStr}</span>\r\n          </div>\r\n        );\r\n      }\r\n\r\n      // Quá hạn - hiển thị từ overdueDuration\r\n      return (\r\n        <div className=\"flex items-center gap-1 text-red-600\">\r\n          <AlertTriangle className=\"h-3 w-3\" />\r\n          <span>Quá {overdueStatus.overdueDuration}</span>\r\n        </div>\r\n      );\r\n    },\r\n    size: 140,\r\n    meta: {\r\n      displayName: \"SLA\",\r\n      group: \"Trạng thái\"\r\n    },\r\n  },\r\n\r\n  // Settlement Status - NEW: Trạng thái thanh toán\r\n  {\r\n    id: \"settlementStatus\",\r\n    header: \"Thanh toán\",\r\n    cell: ({ row }) => {\r\n      // Chỉ hiển thị cho phiếu đã trả và có totalSettlement > 0\r\n      if (row.status !== 'returned' || !row.summary?.totalSettlement || row.summary.totalSettlement <= 0) {\r\n        return <span className=\"text-muted-foreground text-body-xs\">—</span>;\r\n      }\r\n\r\n      // Get vouchers and calculate\r\n      // REMOVED: useVoucherStore no longer exists\r\n      // const vouchers = useVoucherStore.getState().data;\r\n      const vouchers: any[] = [];\r\n      const relatedVouchers = vouchers.filter(v => v.linkedWarrantySystemId === row.systemId);\r\n      const totalPaid = relatedVouchers.reduce((sum, v) => sum + (v.amount || 0), 0);\r\n      \r\n      // Calculate status\r\n      const status = calculateSettlementStatus(\r\n        Math.abs(row.summary.totalSettlement),\r\n        totalPaid,\r\n        row.shippingFee || 0\r\n      );\r\n\r\n      return (\r\n        <Badge className={WARRANTY_SETTLEMENT_STATUS_COLORS[status]}>\r\n          {WARRANTY_SETTLEMENT_STATUS_LABELS[status]}\r\n        </Badge>\r\n      );\r\n    },\r\n    meta: {\r\n      displayName: \"Trạng thái thanh toán\",\r\n      group: \"Trạng thái\"\r\n    },\r\n  },\r\n\r\n  // Products summary\r\n  {\r\n    id: \"productsCount\",\r\n    accessorKey: \"products\",\r\n    header: \"Sản phẩm\",\r\n    cell: ({ row }) => {\r\n      const totalQty = row.products?.reduce((sum, p) => sum + (p.quantity || 1), 0) || 0;\r\n      return (\r\n        <div className=\"flex items-center gap-2\">\r\n          <Package className=\"h-4 w-4 text-muted-foreground\" />\r\n          <span>{totalQty}</span>\r\n        </div>\r\n      );\r\n    },\r\n    meta: {\r\n      displayName: \"Tổng số lượng sản phẩm\",\r\n      group: \"Sản phẩm\"\r\n    },\r\n  },\r\n\r\n  {\r\n    id: \"totalProducts\",\r\n    accessorKey: \"summary\",\r\n    header: \"Tổng SP\",\r\n    cell: ({ row }) => (\r\n      <div className=\"text-center font-medium\">{row.summary?.totalProducts || 0}</div>\r\n    ),\r\n    meta: {\r\n      displayName: \"Tổng sản phẩm\",\r\n      group: \"Sản phẩm\"\r\n    },\r\n  },\r\n\r\n  {\r\n    id: \"totalReplaced\",\r\n    accessorKey: \"summary\",\r\n    header: \"Đổi mới\",\r\n    cell: ({ row }) => {\r\n      // Fallback: Calculate from products if summary is missing\r\n      let replaced = row.summary?.totalReplaced;\r\n      if (replaced === undefined || replaced === null) {\r\n        replaced = row.products\r\n          ?.filter((p: any) => p.resolution === 'replace')\r\n          .reduce((sum: number, p: any) => sum + (p.quantity || 1), 0) || 0;\r\n      }\r\n      if (replaced === 0) return <span className=\"text-muted-foreground text-body-xs\">—</span>;\r\n      return <div className=\"text-center text-green-600 font-medium\">{replaced}</div>;\r\n    },\r\n    meta: {\r\n      displayName: \"Số lượng đổi mới\",\r\n      group: \"Sản phẩm\"\r\n    },\r\n  },\r\n\r\n  {\r\n    id: \"totalReturned\",\r\n    accessorKey: \"summary\",\r\n    header: \"Trả lại\",\r\n    cell: ({ row }) => {\r\n      // Fallback: Calculate from products if summary is missing\r\n      let returned = row.summary?.totalReturned;\r\n      if (returned === undefined || returned === null) {\r\n        returned = row.products\r\n          ?.filter((p: any) => p.resolution === 'return')\r\n          .reduce((sum: number, p: any) => sum + (p.quantity || 1), 0) || 0;\r\n      }\r\n      if (returned === 0) return <span className=\"text-muted-foreground text-body-xs\">—</span>;\r\n      return <div className=\"text-center text-blue-600 font-medium\">{returned}</div>;\r\n    },\r\n    meta: {\r\n      displayName: \"Số lượng trả lại\",\r\n      group: \"Sản phẩm\"\r\n    },\r\n  },\r\n\r\n  {\r\n    id: \"totalOutOfStock\",\r\n    accessorKey: \"summary\",\r\n    header: \"Hết hàng\",\r\n    cell: ({ row }) => {\r\n      // Fallback: Calculate from products if summary is missing or incorrect\r\n      // Gộp cả \"out_of_stock\" và \"deduct\" vì đều là hết hàng → khấu trừ tiền\r\n      let outOfStock = row.summary?.totalOutOfStock;\r\n      let deduction = row.summary?.totalDeduction;\r\n      \r\n      if (outOfStock === undefined || outOfStock === null || deduction === undefined || deduction === null) {\r\n        const outOfStockProducts = row.products?.filter((p: any) => \r\n          p.resolution === 'out_of_stock' || p.resolution === 'deduct'\r\n        ) || [];\r\n        outOfStock = outOfStockProducts.reduce((sum: number, p: any) => sum + (p.quantity || 1), 0);\r\n        deduction = outOfStockProducts.reduce((sum: number, p: any) => {\r\n          if (p.resolution === 'deduct') return sum + (p.deductionAmount || 0);\r\n          if (p.resolution === 'out_of_stock') return sum + ((p.quantity || 1) * (p.unitPrice || 0));\r\n          return sum;\r\n        }, 0);\r\n      }\r\n      \r\n      if (outOfStock === 0 && deduction === 0) return <span className=\"text-muted-foreground text-body-xs\">—</span>;\r\n      \r\n      return (\r\n        <div className=\"text-center\">\r\n          <div className=\"text-orange-600 font-medium\">{outOfStock} SP</div>\r\n          {deduction > 0 && (\r\n            <div className=\"text-body-xs text-red-600 whitespace-nowrap\">\r\n              {formatCurrency(deduction)} ₫\r\n            </div>\r\n          )}\r\n        </div>\r\n      );\r\n    },\r\n    meta: {\r\n      displayName: \"Hết hàng (Khấu trừ tiền)\",\r\n      group: \"Sản phẩm\"\r\n    },\r\n  },\r\n\r\n  {\r\n    id: \"totalSettlement\",\r\n    accessorKey: \"summary\",\r\n    header: \"Bù trừ\",\r\n    cell: ({ row }) => {\r\n      const settlement = row.summary?.totalSettlement || 0;\r\n      if (settlement === 0) return <span className=\"text-muted-foreground text-body-xs\">—</span>;\r\n      return (\r\n        <div className=\"text-right text-blue-600 whitespace-nowrap\">\r\n          {formatCurrency(Math.abs(settlement))} ₫\r\n        </div>\r\n      );\r\n    },\r\n    meta: {\r\n      displayName: \"Tổng tiền bù trừ\",\r\n      group: \"Sản phẩm\"\r\n    },\r\n  },\r\n\r\n  // Images\r\n  {\r\n    id: \"receivedImagesCount\",\r\n    accessorKey: \"receivedImages\",\r\n    header: \"Hình nhận\",\r\n    cell: ({ row }) => (\r\n      <div className=\"text-center\">{row.receivedImages?.length || 0} ảnh</div>\r\n    ),\r\n    meta: {\r\n      displayName: \"Số ảnh nhận hàng\",\r\n      group: \"Hình ảnh\"\r\n    },\r\n  },\r\n\r\n  {\r\n    id: \"processedImagesCount\",\r\n    accessorKey: \"processedImages\",\r\n    header: \"Hình xử lý\",\r\n    cell: ({ row }) => (\r\n      <div className=\"text-center\">{row.processedImages?.length || 0} ảnh</div>\r\n    ),\r\n    meta: {\r\n      displayName: \"Số ảnh xử lý xong\",\r\n      group: \"Hình ảnh\"\r\n    },\r\n  },\r\n\r\n  // History & Comments\r\n  {\r\n    id: \"historyCount\",\r\n    accessorKey: \"history\",\r\n    header: \"Lịch sử\",\r\n    cell: ({ row }) => (\r\n      <div className=\"text-center\">{row.history?.length || 0}</div>\r\n    ),\r\n    meta: {\r\n      displayName: \"Số bản ghi lịch sử\",\r\n      group: \"Lịch sử & Bình luận\"\r\n    },\r\n  },\r\n\r\n  {\r\n    id: \"commentsCount\",\r\n    accessorKey: \"comments\",\r\n    header: \"Bình luận\",\r\n    cell: ({ row }) => (\r\n      <div className=\"text-center\">{row.comments?.length || 0}</div>\r\n    ),\r\n    meta: {\r\n      displayName: \"Số bình luận\",\r\n      group: \"Lịch sử & Bình luận\"\r\n    },\r\n  },\r\n\r\n  {\r\n    id: \"subtasksCount\",\r\n    accessorKey: \"subtasks\",\r\n    header: \"Công việc\",\r\n    cell: ({ row }) => {\r\n      const count = row.subtasks?.length || 0;\r\n      if (count === 0) return <span className=\"text-muted-foreground text-body-xs\">—</span>;\r\n      return <div className=\"text-center\">{count}</div>;\r\n    },\r\n    meta: {\r\n      displayName: \"Số công việc\",\r\n      group: \"Lịch sử & Bình luận\"\r\n    },\r\n  },\r\n\r\n  // Notes\r\n  {\r\n    id: \"notes\",\r\n    accessorKey: \"notes\",\r\n    header: \"Ghi chú\",\r\n    cell: ({ row }) => {\r\n      if (!row.notes?.trim()) return <span className=\"text-muted-foreground text-body-xs\">—</span>;\r\n      return (\r\n        <div className=\"max-w-[200px] truncate text-body-xs\" title={row.notes}>\r\n          {row.notes}\r\n        </div>\r\n      );\r\n    },\r\n    meta: {\r\n      displayName: \"Ghi chú\",\r\n      group: \"Thông tin bổ sung\"\r\n    },\r\n  },\r\n\r\n  // Timestamps\r\n  {\r\n    id: \"returnedAt\",\r\n    accessorKey: \"returnedAt\",\r\n    header: \"Ngày trả hàng\",\r\n    cell: ({ row }) => {\r\n      if (!row.returnedAt) return <span className=\"text-muted-foreground text-body-xs\">—</span>;\r\n      return <div className=\"whitespace-nowrap text-body-xs\">{formatDateTime(row.returnedAt)}</div>;\r\n    },\r\n    meta: {\r\n      displayName: \"Ngày trả hàng\",\r\n      group: \"Thời gian\"\r\n    },\r\n  },\r\n\r\n  {\r\n    id: \"completedAt\",\r\n    accessorKey: \"completedAt\",\r\n    header: \"Ngày kết thúc\",\r\n    cell: ({ row }) => {\r\n      if (!row.completedAt) return <span className=\"text-muted-foreground text-body-xs\">—</span>;\r\n      return <div className=\"whitespace-nowrap text-body-xs\">{formatDateTime(row.completedAt)}</div>;\r\n    },\r\n    meta: {\r\n      displayName: \"Ngày kết thúc\",\r\n      group: \"Thời gian\"\r\n    },\r\n  },\r\n\r\n  // Audit fields\r\n  {\r\n    id: \"createdBy\",\r\n    accessorKey: \"createdBy\",\r\n    header: \"Người tạo\",\r\n    cell: ({ row }) => (\r\n      <div className=\"whitespace-nowrap\">{row.createdBy}</div>\r\n    ),\r\n    meta: {\r\n      displayName: \"Người tạo\",\r\n      group: \"Audit\"\r\n    },\r\n  },\r\n\r\n  {\r\n    id: \"createdAt\",\r\n    accessorKey: \"createdAt\",\r\n    header: ({ sorting, setSorting }) => (\r\n      <DataTableColumnHeader \r\n        title=\"Ngày tạo\"\r\n        sortKey=\"createdAt\"\r\n        isSorted={sorting?.id === 'createdAt'}\r\n        sortDirection={sorting?.desc ? 'desc' : 'asc'}\r\n        onSort={() => setSorting?.((s: any) => ({ id: 'createdAt', desc: s.id === 'createdAt' ? !s.desc : false }))}\r\n      />\r\n    ),\r\n    cell: ({ row }) => (\r\n      <div className=\"whitespace-nowrap\">{formatDateTime(row.createdAt)}</div>\r\n    ),\r\n    meta: {\r\n      displayName: \"Ngày tạo\",\r\n      group: \"Audit\"\r\n    },\r\n  },\r\n\r\n  {\r\n    id: \"updatedAt\",\r\n    accessorKey: \"updatedAt\",\r\n    header: \"Ngày cập nhật\",\r\n    cell: ({ row }) => (\r\n      <div className=\"whitespace-nowrap\">{formatDateTime(row.updatedAt)}</div>\r\n    ),\r\n    meta: {\r\n      displayName: \"Ngày cập nhật cuối\",\r\n      group: \"Audit\"\r\n    },\r\n  },\r\n\r\n  // Actions column - sticky right\r\n  {\r\n    id: \"actions\",\r\n    header: () => <div className=\"text-center\">Hành động</div>,\r\n    cell: ({ row }) => (\r\n      <div className=\"text-center\">\r\n        <DropdownMenu>\r\n          <DropdownMenuTrigger asChild>\r\n            <Button variant=\"ghost\" className=\"h-8 w-8 p-0\">\r\n              <MoreHorizontal className=\"h-4 w-4\" />\r\n            </Button>\r\n          </DropdownMenuTrigger>\r\n          <DropdownMenuContent align=\"end\">\r\n            <DropdownMenuItem onClick={() => onEdit(row)}>\r\n              <Pencil className=\"mr-2 h-4 w-4\" />\r\n              Chỉnh Sửa\r\n            </DropdownMenuItem>\r\n            <DropdownMenuItem onClick={() => {\r\n              window.print();\r\n            }}>\r\n              <Printer className=\"mr-2 h-4 w-4\" />\r\n              In\r\n            </DropdownMenuItem>\r\n            <DropdownMenuItem \r\n              disabled={!row.publicTrackingCode}\r\n              onClick={() => {\r\n                if (!row.publicTrackingCode) return;\r\n                // CHỈ dùng publicTrackingCode (mã tra cứu chính thức)\r\n                const trackingPath = generatePath(ROUTES.INTERNAL.WARRANTY_TRACKING, { trackingCode: row.publicTrackingCode });\r\n                const trackingUrl = `${window.location.origin}${trackingPath}`;\r\n                navigator.clipboard.writeText(trackingUrl);\r\n                toast.success(\r\n                  <div className=\"flex flex-col gap-1\">\r\n                    <div className=\"font-semibold\">Đã copy link tracking</div>\r\n                    <div className=\"text-body-sm text-muted-foreground\">Mã: {row.publicTrackingCode}</div>\r\n                  </div>,\r\n                  { duration: 5000 }\r\n                );\r\n            }}>\r\n              <LinkIcon className=\"mr-2 h-4 w-4\" />\r\n              Get Link Tracking\r\n              {!row.publicTrackingCode && <span className=\"ml-2 text-body-xs text-orange-600\">(Chưa có mã)</span>}\r\n            </DropdownMenuItem>\r\n            <DropdownMenuSeparator />\r\n            <DropdownMenuItem \r\n              className=\"text-destructive\"\r\n              onClick={() => onDelete(row.systemId)}\r\n            >\r\n              <Trash2 className=\"mr-2 h-4 w-4\" />\r\n              Hủy\r\n            </DropdownMenuItem>\r\n          </DropdownMenuContent>\r\n        </DropdownMenu>\r\n      </div>\r\n    ),\r\n    meta: {\r\n      displayName: \"Hành động\",\r\n      sticky: \"right\",\r\n    },\r\n    size: 90,\r\n  },\r\n];\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1541, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/warranty/warranty-card.tsx"],"sourcesContent":["'use client'\r\n\r\nimport * as React from 'react';\r\nimport { useRouter } from 'next/navigation';\r\nimport { formatDateTime } from '../../lib/date-utils';\r\nimport type { WarrantyTicket } from './types';\r\nimport { WARRANTY_STATUS_LABELS, WARRANTY_STATUS_COLORS } from './types';\r\nimport { Card, CardContent } from '../../components/ui/card';\r\nimport { Badge } from '../../components/ui/badge';\r\nimport { DropdownMenu, DropdownMenuContent, DropdownMenuItem, DropdownMenuTrigger } from '../../components/ui/dropdown-menu';\r\nimport { Package, Phone, Truck, User, AlertTriangle } from 'lucide-react';\r\nimport { cn } from '../../lib/utils';\r\nimport { checkWarrantyOverdue } from './warranty-sla-utils';\r\nimport { SlaTimer, WARRANTY_SLA_CONFIGS } from '../../components/SlaTimer';\r\nimport { loadCardColorSettings } from '../settings/warranty/warranty-settings-page';\r\n\r\ninterface WarrantyCardProps {\r\n  ticket: WarrantyTicket;\r\n  onEdit?: (ticket: WarrantyTicket) => void;\r\n  onDelete?: (systemId: string) => void;\r\n  onClick?: (ticket: WarrantyTicket) => void;\r\n}\r\n\r\n// ✅ OPTIMIZATION: Memoize component to prevent unnecessary re-renders\r\n// Only re-render if ticket data or callbacks change\r\nexport const WarrantyCard = React.memo(function WarrantyCard({ ticket, onEdit, onDelete, onClick }: WarrantyCardProps) {\r\n  const router = useRouter();\r\n\r\n  const handleCardClick = (e: React.MouseEvent) => {\r\n    // Ignore right-click\r\n    if (e.type === 'contextmenu' || e.button === 2) {\r\n      return;\r\n    }\r\n    \r\n    if (onClick) {\r\n      onClick(ticket);\r\n    } else {\r\n      router.push(`/warranty/${ticket.systemId}`);\r\n    }\r\n  };\r\n\r\n  // Check if overdue\r\n  const overdueStatus = checkWarrantyOverdue(ticket);\r\n  const isOverdue = \r\n    overdueStatus.isOverdueResponse || \r\n    overdueStatus.isOverdueProcessing || \r\n    overdueStatus.isOverdueReturn;\r\n\r\n  // Load card color settings\r\n  const cardColors = React.useMemo(() => loadCardColorSettings(), []);\r\n\r\n  // Calculate summary with fallback from products\r\n  const summary = React.useMemo(() => {\r\n    if (ticket.summary?.totalReplaced !== undefined && ticket.summary?.totalOutOfStock !== undefined) {\r\n      console.log('✅ Using existing summary:', ticket.id, ticket.summary);\r\n      return ticket.summary;\r\n    }\r\n    // Fallback: Calculate from products (with null checks)\r\n    if (!ticket.products || !Array.isArray(ticket.products)) {\r\n      return {\r\n        ...ticket.summary,\r\n        totalProducts: 0,\r\n        totalReplaced: 0,\r\n        totalReturned: 0,\r\n        totalOutOfStock: 0,\r\n        totalDeduction: 0,\r\n      };\r\n    }\r\n    \r\n    const totalProducts = ticket.products.reduce((sum: number, p: any) => sum + (p.quantity || 1), 0);\r\n    const totalReplaced = ticket.products\r\n      .filter((p: any) => p.resolution === 'replace')\r\n      .reduce((sum: number, p: any) => sum + (p.quantity || 1), 0);\r\n    const totalReturned = ticket.products\r\n      .filter((p: any) => p.resolution === 'return')\r\n      .reduce((sum: number, p: any) => sum + (p.quantity || 1), 0);\r\n    \r\n    // Gộp \"out_of_stock\" và \"deduct\" thành \"Hết hàng (Khấu trừ)\"\r\n    const outOfStockProducts = ticket.products.filter((p: any) => \r\n      p.resolution === 'out_of_stock' || p.resolution === 'deduct'\r\n    );\r\n    \r\n    const totalOutOfStock = outOfStockProducts.reduce((sum: number, p: any) => sum + (p.quantity || 1), 0);\r\n    const totalDeduction = outOfStockProducts.reduce((sum: number, p: any) => {\r\n      if (p.resolution === 'deduct') return sum + (p.deductionAmount || 0);\r\n      if (p.resolution === 'out_of_stock') return sum + ((p.quantity || 1) * (p.unitPrice || 0));\r\n      return sum;\r\n    }, 0);\r\n    \r\n    const calculated = {\r\n      ...ticket.summary,\r\n      totalProducts,\r\n      totalReplaced,\r\n      totalReturned,\r\n      totalOutOfStock,\r\n      totalDeduction,\r\n    };\r\n    \r\n    console.log('⚙️ Calculated summary:', ticket.id, calculated);\r\n    return calculated;\r\n  }, [ticket.summary, ticket.products]);\r\n\r\n  // Determine card color (priority: overdue > status)\r\n  let cardColorClass = \"\";\r\n  let borderClass = \"border-l-4\";\r\n\r\n  if (cardColors.enableOverdueColor && isOverdue) {\r\n    cardColorClass = cardColors.overdueColor || \"bg-red-50\"; // Fallback\r\n    borderClass += \" border-l-red-500\";\r\n  } else if (cardColors.enableStatusColors) {\r\n    cardColorClass = cardColors.statusColors[ticket.status] || \"\";\r\n    const statusBorderColors: Record<string, string> = {\r\n      incomplete: \"border-l-orange-500\",\r\n      pending: \"border-l-yellow-500\",\r\n      processed: \"border-l-green-500\",\r\n      returned: \"border-l-gray-500\",\r\n      completed: \"border-l-blue-500\",\r\n      cancelled: \"border-l-red-500\",\r\n    };\r\n    borderClass += \" \" + (statusBorderColors[ticket.status] || \"border-l-gray-200\");\r\n  }\r\n\r\n  return (\r\n    <Card \r\n      className={cn(\r\n        \"hover:shadow-md transition-all cursor-pointer\",\r\n        borderClass,\r\n        cardColorClass,\r\n        ticket.status === 'cancelled' && \"opacity-60\" // Dim cancelled tickets\r\n      )}\r\n      onClick={handleCardClick}\r\n    >\r\n      <CardContent className=\"p-4\">\r\n        {/* Header: ID + Status + Overdue Badge (1 row) */}\r\n        <div className=\"flex items-center justify-between mb-2\">\r\n          <div className=\"flex items-center gap-2 flex-wrap\">\r\n            <span className={cn(\r\n              \"font-semibold text-primary text-body-sm font-mono\",\r\n              ticket.status === 'cancelled' && \"line-through\" // Strike through cancelled ID\r\n            )}>\r\n              {ticket.id}\r\n            </span>\r\n            <Badge className={WARRANTY_STATUS_COLORS[ticket.status] + \" text-body-xs\"}>\r\n              {WARRANTY_STATUS_LABELS[ticket.status]}\r\n            </Badge>\r\n          </div>\r\n          {isOverdue && (\r\n            <Badge variant=\"outline\" className=\"text-body-xs bg-red-100 text-red-800 whitespace-nowrap\">\r\n              <AlertTriangle className=\"h-3 w-3 mr-1\" />\r\n              Quá hạn\r\n            </Badge>\r\n          )}\r\n        </div>\r\n\r\n        {/* Customer Name */}\r\n        <div className={cn(\r\n          \"flex items-center text-body-sm font-medium mb-2\",\r\n          ticket.status === 'cancelled' && \"line-through\" // Strike through cancelled customer name\r\n        )}>\r\n          <User className=\"h-3.5 w-3.5 mr-1.5 flex-shrink-0 text-muted-foreground\" />\r\n          <span className=\"truncate\">{ticket.customerName}</span>\r\n        </div>\r\n\r\n        {/* Divider */}\r\n        <div className=\"border-t border-border mb-2\" />\r\n\r\n        {/* Info Grid */}\r\n        <div className=\"space-y-1.5\">\r\n          {/* Row 1: Phone + Tracking */}\r\n          <div className=\"flex items-center justify-between text-body-xs text-muted-foreground\">\r\n            {ticket.customerPhone && (\r\n              <div className=\"flex items-center\">\r\n                <Phone className=\"h-3 w-3 mr-1\" />\r\n                <span>{ticket.customerPhone}</span>\r\n              </div>\r\n            )}\r\n            <div className=\"flex items-center\">\r\n              <Truck className=\"h-3 w-3 mr-1\" />\r\n              <span className=\"font-mono\">{ticket.trackingCode}</span>\r\n            </div>\r\n          </div>\r\n\r\n          {/* Row 2: Products Summary inline */}\r\n          <div className=\"flex items-center text-body-xs gap-1.5 flex-wrap\">\r\n            <div className=\"flex items-center text-muted-foreground\">\r\n              <Package className=\"h-3 w-3 mr-1\" />\r\n              <span className=\"font-semibold\">{summary?.totalProducts || ticket.products?.length || 0}</span>\r\n            </div>\r\n            {summary && (\r\n              <>\r\n                {summary.totalReplaced > 0 && <span className=\"text-green-600 font-medium\">• {summary.totalReplaced}đổi mới</span>}\r\n                {summary.totalReturned > 0 && <span className=\"text-blue-600 font-medium\">• {summary.totalReturned}trả lại</span>}\r\n                {summary.totalOutOfStock > 0 && <span className=\"text-orange-600 font-medium\">• {summary.totalOutOfStock}hết hàng</span>}\r\n                {summary.totalDeduction > 0 && (\r\n                  <span className=\"text-red-600 font-medium ml-auto\">\r\n                    Bù trừ {new Intl.NumberFormat('vi-VN').format(summary.totalDeduction)}₫\r\n                  </span>\r\n                )}\r\n              </>\r\n            )}\r\n          </div>\r\n\r\n          {/* SLA Timer */}\r\n          <SlaTimer\r\n            startTime={ticket.createdAt}\r\n            targetMinutes={\r\n              ticket.status === 'incomplete'\r\n                ? WARRANTY_SLA_CONFIGS.response.targetMinutes\r\n                : ticket.status === 'pending'\r\n                ? WARRANTY_SLA_CONFIGS.processing.targetMinutes\r\n                : WARRANTY_SLA_CONFIGS.return.targetMinutes\r\n            }\r\n            isCompleted={ticket.status === 'returned'}\r\n            thresholds={\r\n              ticket.status === 'incomplete'\r\n                ? WARRANTY_SLA_CONFIGS.response.thresholds\r\n                : ticket.status === 'pending'\r\n                ? WARRANTY_SLA_CONFIGS.processing.thresholds\r\n                : WARRANTY_SLA_CONFIGS.return.thresholds\r\n            }\r\n            className=\"mt-1\"\r\n          />\r\n\r\n          {/* Row 3: Created + Updated */}\r\n          <div className=\"flex items-center justify-between text-body-xs pt-1.5 border-t\">\r\n            <span className=\"text-muted-foreground\">Tạo {formatDateTime(ticket.createdAt)}</span>\r\n            <span className=\"text-muted-foreground\">CN {formatDateTime(ticket.updatedAt)}</span>\r\n          </div>\r\n\r\n          {/* Row 4: Returned + Created By */}\r\n          <div className=\"flex items-center justify-between text-body-xs\">\r\n            {ticket.status === 'completed' && ticket.completedAt ? (\r\n              <span className=\"text-blue-700 font-medium\">✓ Kết thúc {formatDateTime(ticket.completedAt)}</span>\r\n            ) : ticket.returnedAt ? (\r\n              <span className=\"text-green-700 font-medium\">✓ Đã trả {formatDateTime(ticket.returnedAt)}</span>\r\n            ) : (\r\n              <span className=\"text-muted-foreground\">Người tạo: {ticket.createdBy}</span>\r\n            )}\r\n          </div>\r\n        </div>\r\n      </CardContent>\r\n    </Card>\r\n  );\r\n});\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1994, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/warranty/warranty-card-context-menu.tsx"],"sourcesContent":["import * as React from 'react';\r\nimport {\r\n  ContextMenu,\r\n  ContextMenuContent,\r\n  ContextMenuItem,\r\n  ContextMenuSeparator,\r\n  ContextMenuTrigger,\r\n} from '../../components/ui/context-menu';\r\nimport { WarrantyTicket } from './types';\r\nimport { toast } from 'sonner';\r\n\r\ninterface WarrantyCardContextMenuProps {\r\n  ticket: WarrantyTicket;\r\n  onEdit: (systemId: string) => void;\r\n  onGetLink: (systemId: string) => void;\r\n  onStartProcessing: (systemId: string) => void;\r\n  onMarkProcessed: (systemId: string) => void;\r\n  onMarkReturned: (systemId: string) => void;\r\n  onCancel: (systemId: string) => void;\r\n  onRemind?: (systemId: string) => void;\r\n  children: React.ReactNode;\r\n}\r\n\r\n/**\r\n * Context Menu for Warranty Card - Status-based actions (no icons)\r\n * \r\n * Right-click menu với actions thay đổi theo status:\r\n * - new: Sửa, Bắt đầu xử lý, Copy link, Nhắc nhở, Hủy\r\n * - pending: Hoàn thành xử lý, Copy link, Nhắc nhở\r\n * - processed: Đã trả hàng, Copy link\r\n * - returned: Copy link\r\n */\r\nexport function WarrantyCardContextMenu({\r\n  ticket,\r\n  onEdit,\r\n  onGetLink,\r\n  onStartProcessing,\r\n  onMarkProcessed,\r\n  onMarkReturned,\r\n  onCancel,\r\n  onRemind,\r\n  children,\r\n}: WarrantyCardContextMenuProps) {\r\n  const { status } = ticket;\r\n\r\n  return (\r\n    <ContextMenu>\r\n      <ContextMenuTrigger asChild>\r\n        {children}\r\n      </ContextMenuTrigger>\r\n      <ContextMenuContent className=\"w-56\">\r\n        {/* NEW: Mới tạo */}\r\n        {status === 'incomplete' && (\r\n          <>\r\n            <ContextMenuItem onSelect={() => onEdit(ticket.systemId)}>\r\n              Sửa thông tin\r\n            </ContextMenuItem>\r\n            <ContextMenuItem onSelect={() => onStartProcessing(ticket.systemId)}>\r\n              Bắt đầu xử lý\r\n            </ContextMenuItem>\r\n            <ContextMenuItem onSelect={() => onGetLink(ticket.systemId)}>\r\n              Copy link tracking\r\n            </ContextMenuItem>\r\n            {onRemind && (\r\n              <ContextMenuItem onSelect={() => onRemind(ticket.systemId)}>\r\n                Gửi thông báo nhắc nhở\r\n              </ContextMenuItem>\r\n            )}\r\n            <ContextMenuSeparator />\r\n            <ContextMenuItem\r\n              onSelect={() => onCancel(ticket.systemId)}\r\n              className=\"text-destructive focus:text-destructive\"\r\n            >\r\n              Hủy phiếu\r\n            </ContextMenuItem>\r\n          </>\r\n        )}\r\n\r\n        {/* PENDING: Chưa xử lý */}\r\n        {status === 'pending' && (\r\n          <>\r\n            <ContextMenuItem onSelect={() => onEdit(ticket.systemId)}>\r\n              Sửa thông tin\r\n            </ContextMenuItem>\r\n            <ContextMenuItem onSelect={() => onMarkProcessed(ticket.systemId)}>\r\n              Hoàn thành xử lý\r\n            </ContextMenuItem>\r\n            <ContextMenuItem onSelect={() => onGetLink(ticket.systemId)}>\r\n              Copy link tracking\r\n            </ContextMenuItem>\r\n            {onRemind && (\r\n              <ContextMenuItem onSelect={() => onRemind(ticket.systemId)}>\r\n                Gửi thông báo nhắc nhở\r\n              </ContextMenuItem>\r\n            )}\r\n          </>\r\n        )}\r\n\r\n        {/* PROCESSED: Đã xử lý */}\r\n        {status === 'processed' && (\r\n          <>\r\n            <ContextMenuItem onSelect={() => onMarkReturned(ticket.systemId)}>\r\n              Đã trả hàng cho khách\r\n            </ContextMenuItem>\r\n            <ContextMenuItem onSelect={() => onGetLink(ticket.systemId)}>\r\n              Copy link tracking\r\n            </ContextMenuItem>\r\n          </>\r\n        )}\r\n\r\n        {/* RETURNED: Đã trả */}\r\n        {status === 'returned' && (\r\n          <ContextMenuItem onSelect={() => onGetLink(ticket.systemId)}>\r\n            Copy link tracking\r\n          </ContextMenuItem>\r\n        )}\r\n\r\n        {/* COMPLETED: Kết thúc */}\r\n        {status === 'completed' && (\r\n          <ContextMenuItem onSelect={() => onGetLink(ticket.systemId)}>\r\n            Copy link tracking\r\n          </ContextMenuItem>\r\n        )}\r\n      </ContextMenuContent>\r\n    </ContextMenu>\r\n  );\r\n}\r\n"],"names":[],"mappings":";;;;;AACA;;;AA+BO,SAAS,wBAAwB,EACtC,MAAM,EACN,MAAM,EACN,SAAS,EACT,iBAAiB,EACjB,eAAe,EACf,cAAc,EACd,QAAQ,EACR,QAAQ,EACR,QAAQ,EACqB;IAC7B,MAAM,EAAE,MAAM,EAAE,GAAG;IAEnB,qBACE,8OAAC,mJAAW;;0BACV,8OAAC,0JAAkB;gBAAC,OAAO;0BACxB;;;;;;0BAEH,8OAAC,0JAAkB;gBAAC,WAAU;;oBAE3B,WAAW,8BACV;;0CACE,8OAAC,uJAAe;gCAAC,UAAU,IAAM,OAAO,OAAO,QAAQ;0CAAG;;;;;;0CAG1D,8OAAC,uJAAe;gCAAC,UAAU,IAAM,kBAAkB,OAAO,QAAQ;0CAAG;;;;;;0CAGrE,8OAAC,uJAAe;gCAAC,UAAU,IAAM,UAAU,OAAO,QAAQ;0CAAG;;;;;;4BAG5D,0BACC,8OAAC,uJAAe;gCAAC,UAAU,IAAM,SAAS,OAAO,QAAQ;0CAAG;;;;;;0CAI9D,8OAAC,4JAAoB;;;;;0CACrB,8OAAC,uJAAe;gCACd,UAAU,IAAM,SAAS,OAAO,QAAQ;gCACxC,WAAU;0CACX;;;;;;;;oBAOJ,WAAW,2BACV;;0CACE,8OAAC,uJAAe;gCAAC,UAAU,IAAM,OAAO,OAAO,QAAQ;0CAAG;;;;;;0CAG1D,8OAAC,uJAAe;gCAAC,UAAU,IAAM,gBAAgB,OAAO,QAAQ;0CAAG;;;;;;0CAGnE,8OAAC,uJAAe;gCAAC,UAAU,IAAM,UAAU,OAAO,QAAQ;0CAAG;;;;;;4BAG5D,0BACC,8OAAC,uJAAe;gCAAC,UAAU,IAAM,SAAS,OAAO,QAAQ;0CAAG;;;;;;;;oBAQjE,WAAW,6BACV;;0CACE,8OAAC,uJAAe;gCAAC,UAAU,IAAM,eAAe,OAAO,QAAQ;0CAAG;;;;;;0CAGlE,8OAAC,uJAAe;gCAAC,UAAU,IAAM,UAAU,OAAO,QAAQ;0CAAG;;;;;;;;oBAOhE,WAAW,4BACV,8OAAC,uJAAe;wBAAC,UAAU,IAAM,UAAU,OAAO,QAAQ;kCAAG;;;;;;oBAM9D,WAAW,6BACV,8OAAC,uJAAe;wBAAC,UAAU,IAAM,UAAU,OAAO,QAAQ;kCAAG;;;;;;;;;;;;;;;;;;AAOvE"}},
    {"offset": {"line": 2156, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/warranty/notification-utils.ts"],"sourcesContent":["/**\r\n * Warranty Notification Utilities\r\n * Handle notification settings and events for warranty tickets\r\n * Pattern copied from Complaints notification system\r\n * \r\n * NOTE: Settings are now synced with database via warranty-settings-sync.ts\r\n */\r\n\r\nimport { toast } from \"sonner\";\r\nimport {\r\n  getWarrantyNotificationsSync,\r\n  saveWarrantyNotificationsAsync,\r\n  type WarrantyNotificationSettings,\r\n} from '@/lib/warranty-settings-sync';\r\n\r\n// Re-export interface for backwards compatibility\r\nexport type { WarrantyNotificationSettings } from '@/lib/warranty-settings-sync';\r\n\r\n// Default notification settings\r\nconst defaultNotifications: WarrantyNotificationSettings = {\r\n  emailOnCreate: true,\r\n  emailOnAssign: true,\r\n  emailOnProcessing: false,\r\n  emailOnProcessed: true,\r\n  emailOnReturned: true,\r\n  emailOnOverdue: true,\r\n  smsOnOverdue: false,\r\n  inAppNotifications: true,\r\n  reminderNotifications: true,\r\n};\r\n\r\n/**\r\n * Load notification settings from database (sync version)\r\n * @deprecated Use getWarrantyNotificationsSync from warranty-settings-sync.ts\r\n */\r\nexport function loadWarrantyNotificationSettings(): WarrantyNotificationSettings {\r\n  return getWarrantyNotificationsSync();\r\n}\r\n\r\n/**\r\n * Save notification settings to database\r\n * @deprecated Use saveWarrantyNotificationsAsync from warranty-settings-sync.ts\r\n */\r\nexport function saveWarrantyNotificationSettings(settings: WarrantyNotificationSettings): void {\r\n  // Fire and forget - save to database in background\r\n  saveWarrantyNotificationsAsync(settings).catch(error => {\r\n    console.error('Failed to save warranty notification settings:', error);\r\n  });\r\n}\r\n\r\n/**\r\n * Show toast notification based on settings\r\n */\r\nexport function showWarrantyNotification(\r\n  type: 'success' | 'error' | 'info' | 'warning',\r\n  message: string,\r\n  options?: { id?: string | number; description?: string | undefined; duration?: number }\r\n) {\r\n  const settings = loadWarrantyNotificationSettings();\r\n  \r\n  // Always show if inAppNotifications is enabled\r\n  if (settings.inAppNotifications) {\r\n    switch (type) {\r\n      case 'success':\r\n        toast.success(message, options);\r\n        break;\r\n      case 'error':\r\n        toast.error(message, options);\r\n        break;\r\n      case 'info':\r\n        toast.info(message, options);\r\n        break;\r\n      case 'warning':\r\n        toast.warning(message, options);\r\n        break;\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * Show loading toast (always shown regardless of settings)\r\n */\r\nexport function showWarrantyLoading(message: string) {\r\n  return toast.loading(message);\r\n}\r\n\r\n/**\r\n * Check if a specific notification event is enabled\r\n */\r\nexport function isWarrantyNotificationEnabled(event: keyof WarrantyNotificationSettings): boolean {\r\n  const settings = loadWarrantyNotificationSettings();\r\n  return settings[event] || false;\r\n}\r\n\r\n/**\r\n * Wrapper functions for specific warranty events\r\n */\r\n\r\nexport function notifyWarrantyCreated(ticketId: string) {\r\n  if (isWarrantyNotificationEnabled('emailOnCreate')) {\r\n    showWarrantyNotification('success', `Đã tạo phiếu bảo hành ${ticketId}`, {\r\n      description: 'Phiếu mới đã được tạo thành công',\r\n    });\r\n  }\r\n}\r\n\r\nexport function notifyWarrantyAssigned(ticketId: string, employeeName: string) {\r\n  if (isWarrantyNotificationEnabled('emailOnAssign')) {\r\n    showWarrantyNotification('info', `Phiếu ${ticketId} được gán cho ${employeeName}`, {\r\n      description: 'Đã cập nhật người phụ trách',\r\n    });\r\n  }\r\n}\r\n\r\nexport function notifyWarrantyProcessing(ticketId: string) {\r\n  if (isWarrantyNotificationEnabled('emailOnProcessing')) {\r\n    showWarrantyNotification('info', `Phiếu ${ticketId} đang được xử lý`, {\r\n      description: 'Nhân viên đã bắt đầu xử lý phiếu',\r\n    });\r\n  }\r\n}\r\n\r\nexport function notifyWarrantyProcessed(ticketId: string) {\r\n  if (isWarrantyNotificationEnabled('emailOnProcessed')) {\r\n    showWarrantyNotification('success', `Phiếu ${ticketId} đã xử lý xong`, {\r\n      description: 'Sản phẩm sẵn sàng để trả khách',\r\n    });\r\n  }\r\n}\r\n\r\nexport function notifyWarrantyReturned(ticketId: string, orderId?: string) {\r\n  if (isWarrantyNotificationEnabled('emailOnReturned')) {\r\n    showWarrantyNotification('success', `Phiếu ${ticketId} đã trả hàng`, {\r\n      description: orderId ? `Liên kết với đơn hàng ${orderId}` : 'Đã hoàn tất quy trình',\r\n    });\r\n  }\r\n}\r\n\r\nexport function notifyWarrantyOverdue(ticketId: string, type: 'response' | 'processing' | 'return') {\r\n  if (isWarrantyNotificationEnabled('emailOnOverdue')) {\r\n    const typeLabels = {\r\n      response: 'phản hồi',\r\n      processing: 'xử lý',\r\n      return: 'trả hàng',\r\n    };\r\n    \r\n    showWarrantyNotification('warning', `Phiếu ${ticketId} quá hạn ${typeLabels[type]}`, {\r\n      description: 'Vui lòng kiểm tra và xử lý ngay',\r\n      duration: 10000, // Show longer for overdue warnings\r\n    });\r\n  }\r\n}\r\n\r\nexport function notifyWarrantyReminder(ticketId: string, message: string) {\r\n  if (isWarrantyNotificationEnabled('reminderNotifications')) {\r\n    showWarrantyNotification('info', `Nhắc nhở: ${ticketId}`, {\r\n      description: message,\r\n      duration: 8000,\r\n    });\r\n  }\r\n}\r\n\r\nexport function notifyWarrantyStatusChange(ticketId: string, oldStatus: string, newStatus: string) {\r\n  showWarrantyNotification('info', `Phiếu ${ticketId} đã chuyển trạng thái`, {\r\n    description: `${oldStatus} → ${newStatus}`,\r\n  });\r\n}\r\n\r\n/**\r\n * Batch notification for multiple tickets\r\n */\r\nexport function notifyWarrantyBulkAction(action: string, count: number) {\r\n  showWarrantyNotification('success', `Đã ${action} ${count} phiếu bảo hành`, {\r\n    description: 'Thao tác hàng loạt thành công',\r\n  });\r\n}\r\n\r\n/**\r\n * Error notification\r\n */\r\nexport function notifyWarrantyError(message: string, details?: string) {\r\n  showWarrantyNotification('error', message, {\r\n    description: details,\r\n    duration: 5000,\r\n  });\r\n}\r\n\r\n/**\r\n * Get notification summary for dashboard\r\n */\r\nexport function getWarrantyNotificationSummary() {\r\n  const settings = loadWarrantyNotificationSettings();\r\n  const enabledCount = Object.values(settings).filter(Boolean).length;\r\n  const totalCount = Object.keys(settings).length;\r\n  \r\n  return {\r\n    enabled: enabledCount,\r\n    total: totalCount,\r\n    percentage: Math.round((enabledCount / totalCount) * 100),\r\n  };\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 2334, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/warranty/use-realtime-updates.ts"],"sourcesContent":["/**\r\n * Realtime Updates Hook for Warranty Module\r\n * Uses in-memory versioning - localStorage has been removed\r\n */\r\n\r\nimport * as React from 'react';\r\nimport { toast } from 'sonner';\r\n\r\n// In-memory version tracking\r\nlet warrantyDataVersion = 0;\r\nconst versionListeners = new Set<() => void>();\r\n\r\ninterface UseRealtimeUpdatesOptions {\r\n  onRefresh: () => void;\r\n  dataVersion: number;\r\n  interval?: number;\r\n}\r\n\r\n/**\r\n * Hook for managing realtime updates with polling\r\n */\r\nexport function useRealtimeUpdates({\r\n  onRefresh,\r\n  dataVersion,\r\n  interval = 30000,\r\n}: UseRealtimeUpdatesOptions) {\r\n  const [hasUpdates, setHasUpdates] = React.useState(false);\r\n  const [isPolling, setIsPolling] = React.useState(false);\r\n  const [lastVersion, setLastVersion] = React.useState(dataVersion);\r\n\r\n  // Subscribe to version changes\r\n  React.useEffect(() => {\r\n    const listener = () => {\r\n      setHasUpdates(true);\r\n    };\r\n    versionListeners.add(listener);\r\n    return () => {\r\n      versionListeners.delete(listener);\r\n    };\r\n  }, []);\r\n\r\n  // Polling effect\r\n  React.useEffect(() => {\r\n    if (!isPolling) return;\r\n\r\n    const timer = setInterval(() => {\r\n      if (warrantyDataVersion > lastVersion) {\r\n        setHasUpdates(true);\r\n      }\r\n    }, interval);\r\n\r\n    return () => clearInterval(timer);\r\n  }, [isPolling, interval, lastVersion]);\r\n\r\n  // Check if data version changed\r\n  React.useEffect(() => {\r\n    if (dataVersion !== lastVersion) {\r\n      setHasUpdates(true);\r\n    }\r\n  }, [dataVersion, lastVersion]);\r\n\r\n  const checkForUpdates = (): boolean => {\r\n    return warrantyDataVersion > lastVersion;\r\n  };\r\n\r\n  const showUpdateNotification = () => {\r\n    toast.info('Có cập nhật mới cho bảo hành', {\r\n      duration: 10000,\r\n      position: 'top-right',\r\n      action: {\r\n        label: 'Làm mới',\r\n        onClick: () => {\r\n          handleRefresh();\r\n        },\r\n      },\r\n    });\r\n  };\r\n\r\n  const handleRefresh = React.useCallback(() => {\r\n    setLastVersion(warrantyDataVersion);\r\n    setHasUpdates(false);\r\n    onRefresh();\r\n    toast.success('Đã làm mới dữ liệu bảo hành');\r\n  }, [onRefresh]);\r\n\r\n  const togglePolling = () => {\r\n    setIsPolling(prev => !prev);\r\n    if (!isPolling) {\r\n      toast.info('Đã bật chế độ cập nhật tự động (30s)', { duration: 3000 });\r\n    } else {\r\n      toast.info('Đã tắt chế độ cập nhật tự động', { duration: 3000 });\r\n    }\r\n  };\r\n\r\n  return {\r\n    hasUpdates,\r\n    isPolling,\r\n    refresh: handleRefresh,\r\n    togglePolling,\r\n  };\r\n}\r\n\r\n/**\r\n * Manual trigger for simulating data updates\r\n * Call this when data changes (e.g., after create/update/delete)\r\n */\r\nexport function triggerWarrantyDataUpdate() {\r\n  warrantyDataVersion++;\r\n  versionListeners.forEach(listener => listener());\r\n}\r\n\r\n/**\r\n * Get current data version\r\n */\r\nexport function getWarrantyDataVersion(): number {\r\n  return warrantyDataVersion;\r\n}\r\n"],"names":[],"mappings":";;;;;;;;AAAA;;;CAGC,GAED;AACA;;;AAEA,6BAA6B;AAC7B,IAAI,sBAAsB;AAC1B,MAAM,mBAAmB,IAAI;AAWtB,SAAS,mBAAmB,EACjC,SAAS,EACT,WAAW,EACX,WAAW,KAAK,EACU;IAC1B,MAAM,CAAC,YAAY,cAAc,GAAG,iNAAc,CAAC;IACnD,MAAM,CAAC,WAAW,aAAa,GAAG,iNAAc,CAAC;IACjD,MAAM,CAAC,aAAa,eAAe,GAAG,iNAAc,CAAC;IAErD,+BAA+B;IAC/B,kNAAe,CAAC;QACd,MAAM,WAAW;YACf,cAAc;QAChB;QACA,iBAAiB,GAAG,CAAC;QACrB,OAAO;YACL,iBAAiB,MAAM,CAAC;QAC1B;IACF,GAAG,EAAE;IAEL,iBAAiB;IACjB,kNAAe,CAAC;QACd,IAAI,CAAC,WAAW;QAEhB,MAAM,QAAQ,YAAY;YACxB,IAAI,sBAAsB,aAAa;gBACrC,cAAc;YAChB;QACF,GAAG;QAEH,OAAO,IAAM,cAAc;IAC7B,GAAG;QAAC;QAAW;QAAU;KAAY;IAErC,gCAAgC;IAChC,kNAAe,CAAC;QACd,IAAI,gBAAgB,aAAa;YAC/B,cAAc;QAChB;IACF,GAAG;QAAC;QAAa;KAAY;IAE7B,MAAM,kBAAkB;QACtB,OAAO,sBAAsB;IAC/B;IAEA,MAAM,yBAAyB;QAC7B,iJAAK,CAAC,IAAI,CAAC,gCAAgC;YACzC,UAAU;YACV,UAAU;YACV,QAAQ;gBACN,OAAO;gBACP,SAAS;oBACP;gBACF;YACF;QACF;IACF;IAEA,MAAM,gBAAgB,oNAAiB,CAAC;QACtC,eAAe;QACf,cAAc;QACd;QACA,iJAAK,CAAC,OAAO,CAAC;IAChB,GAAG;QAAC;KAAU;IAEd,MAAM,gBAAgB;QACpB,aAAa,CAAA,OAAQ,CAAC;QACtB,IAAI,CAAC,WAAW;YACd,iJAAK,CAAC,IAAI,CAAC,wCAAwC;gBAAE,UAAU;YAAK;QACtE,OAAO;YACL,iJAAK,CAAC,IAAI,CAAC,kCAAkC;gBAAE,UAAU;YAAK;QAChE;IACF;IAEA,OAAO;QACL;QACA;QACA,SAAS;QACT;IACF;AACF;AAMO,SAAS;IACd;IACA,iBAAiB,OAAO,CAAC,CAAA,WAAY;AACvC;AAKO,SAAS;IACd,OAAO;AACT"}},
    {"offset": {"line": 2442, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/warranty/initial-data.ts"],"sourcesContent":["import type { WarrantyTicket } from './types';\nimport { asSystemId, asBusinessId } from '../../lib/id-types';\nimport { buildSeedAuditFields } from '@/lib/seed-audit';\n\n/**\n * Initial Warranty Data\n * Empty array - data will be persisted in localStorage by createCrudStore\n * \n * Example of properly typed warranty record:\n * {\n *   systemId: asSystemId('WARRANTY00000001'),\n *   id: asBusinessId('WR001'),\n *   branchSystemId: asSystemId('BRANCH00000001'),\n *   employeeSystemId: asSystemId('NV00000001'),\n *   customerSystemId: asSystemId('CUSTOMER00000001'),\n *   linkedOrderSystemId: asSystemId('ORDER00000123'),\n *   products: [\n *     {\n *       systemId: asSystemId('WARPROD00000001'),\n *       productSystemId: asSystemId('PRODUCT00000045'),\n *       sku: asBusinessId('SKU001'),\n *       ...\n *     }\n *   ],\n *   ...\n * }\n */\nconst seedCustomer = {\n\tsystemId: asSystemId('CUST000001'),\n\tname: 'Công ty Cổ phần Bất động sản Hưng Thịnh',\n\tphone: '0901112233',\n\taddress: '123 Đường ABC, Phường 1, Quận 1, TP.HCM',\n};\n\nconst seedBranch = {\n\tsystemId: asSystemId('BRANCH000003'),\n\tname: 'Chi nhánh Trung tâm',\n};\n\nconst warrantyOwner = {\n\tsystemId: asSystemId('EMP000002'),\n\tname: 'Trần Thị Bình',\n};\n\nexport const warrantyInitialData: WarrantyTicket[] = [\n\t{\n\t\tsystemId: asSystemId('WARRANTY000001'),\n\t\tid: asBusinessId('BH000001'),\n\t\tbranchSystemId: seedBranch.systemId,\n\t\tbranchName: seedBranch.name,\n\t\temployeeSystemId: warrantyOwner.systemId,\n\t\temployeeName: warrantyOwner.name,\n\t\tcustomerSystemId: seedCustomer.systemId,\n\t\tcustomerName: seedCustomer.name,\n\t\tcustomerPhone: seedCustomer.phone,\n\t\tcustomerAddress: seedCustomer.address,\n\t\ttrackingCode: 'GHN-WAR-0001',\n\t\tpublicTrackingCode: 'wh8ut4nz9p',\n\t\tshippingFee: 45000,\n\t\treferenceUrl: 'https://docs.google.com/spreadsheets/d/war-0001',\n\t\tlinkedOrderSystemId: asSystemId('ORDER000001'),\n\t\treceivedImages: [\n\t\t\t'https://images.unsplash.com/photo-1517336714731-489689fd1ca8?auto=format&fit=crop&w=640&q=80',\n\t\t],\n\t\tproducts: [\n\t\t\t{\n\t\t\t\tsystemId: asSystemId('WARPROD000001'),\n\t\t\t\tproductSystemId: asSystemId('SP000001'),\n\t\t\t\tsku: asBusinessId('SP000001'),\n\t\t\t\tproductName: 'Laptop Dell Inspiron 15',\n\t\t\t\tquantity: 1,\n\t\t\t\tunitPrice: 15000000,\n\t\t\t\tissueDescription: 'Máy tự tắt khi sử dụng hơn 30 phút',\n\t\t\t\tresolution: 'replace',\n\t\t\t\tdeductionAmount: 0,\n\t\t\t\tproductImages: [\n\t\t\t\t\t'https://images.unsplash.com/photo-1517336714731-489689fd1ca8?auto=format&fit=crop&w=400&q=80',\n\t\t\t\t],\n\t\t\t\tnotes: 'Cần sao lưu dữ liệu trước khi chuyển hãng',\n\t\t\t},\n\t\t\t{\n\t\t\t\tsystemId: asSystemId('WARPROD000002'),\n\t\t\t\tproductSystemId: asSystemId('SP000002'),\n\t\t\t\tsku: asBusinessId('SP000002'),\n\t\t\t\tproductName: 'Chuột Logitech MX Master 3',\n\t\t\t\tquantity: 1,\n\t\t\t\tunitPrice: 2000000,\n\t\t\t\tissueDescription: 'Con lăn bị kẹt định kỳ',\n\t\t\t\tresolution: 'return',\n\t\t\t\tproductImages: [\n\t\t\t\t\t'https://images.unsplash.com/photo-1481277542470-605612bd2d61?auto=format&fit=crop&w=400&q=80',\n\t\t\t\t],\n\t\t\t\tnotes: 'Đã vệ sinh nhưng lỗi tái diễn',\n\t\t\t},\n\t\t],\n\t\tprocessedImages: [\n\t\t\t'https://images.unsplash.com/photo-1517430816045-df4b7de11d1d?auto=format&fit=crop&w=640&q=80',\n\t\t],\n\t\tstatus: 'processed',\n\t\tsettlementStatus: 'pending',\n\t\tstockDeducted: false,\n\t\tprocessingStartedAt: '2025-11-13T01:30:00Z',\n\t\tprocessedAt: '2025-11-13T09:00:00Z',\n\t\tnotes: 'Đợi xác nhận của khách về phương án đổi mới laptop.',\n\t\tsummary: {\n\t\t\ttotalProducts: 2,\n\t\t\ttotalReplaced: 1,\n\t\t\ttotalReturned: 1,\n\t\t\ttotalDeduction: 0,\n\t\t\ttotalOutOfStock: 0,\n\t\t\ttotalSettlement: 0,\n\t\t},\n\t\thistory: [\n\t\t\t{\n\t\t\t\tsystemId: asSystemId('WARHIST000001'),\n\t\t\t\taction: 'create',\n\t\t\t\tactionLabel: 'Tạo phiếu bảo hành',\n\t\t\t\tperformedBy: warrantyOwner.name,\n\t\t\t\tperformedBySystemId: warrantyOwner.systemId,\n\t\t\t\tperformedAt: '2025-11-12T09:00:00Z',\n\t\t\t\tnote: 'Tiếp nhận phiếu bảo hành từ khách Hưng Thịnh.',\n\t\t\t\tlinkedOrderSystemId: asSystemId('ORDER000001'),\n\t\t\t},\n\t\t\t{\n\t\t\t\tsystemId: asSystemId('WARHIST000002'),\n\t\t\t\taction: 'update_status',\n\t\t\t\tactionLabel: 'Bắt đầu xử lý',\n\t\t\t\tperformedBy: warrantyOwner.name,\n\t\t\t\tperformedBySystemId: warrantyOwner.systemId,\n\t\t\t\tperformedAt: '2025-11-13T01:30:00Z',\n\t\t\t\tnote: 'Chuyển trạng thái sang Đang xử lý và gửi thiết bị sang ASUS.',\n\t\t\t},\n\t\t\t{\n\t\t\t\tsystemId: asSystemId('WARHIST000003'),\n\t\t\t\taction: 'update_status',\n\t\t\t\tactionLabel: 'Hoàn tất xử lý',\n\t\t\t\tperformedBy: warrantyOwner.name,\n\t\t\t\tperformedBySystemId: warrantyOwner.systemId,\n\t\t\t\tperformedAt: '2025-11-13T09:00:00Z',\n\t\t\t\tnote: 'Laptop sẽ đổi máy mới, chuột vệ sinh và trả lại.',\n\t\t\t},\n\t\t],\n\t\tcomments: [],\n\t\tsubtasks: [],\n\t\tcreatedBy: warrantyOwner.name,\n\t\tcreatedBySystemId: warrantyOwner.systemId,\n\t\tcreatedAt: '2025-11-12T09:00:00Z',\n\t\tupdatedAt: '2025-11-13T09:00:00Z',\n\t\tupdatedBySystemId: warrantyOwner.systemId,\n\t},\n\t{\n\t\tsystemId: asSystemId('WARRANTY000002'),\n\t\tid: asBusinessId('BH000002'),\n\t\tbranchSystemId: seedBranch.systemId,\n\t\tbranchName: seedBranch.name,\n\t\temployeeSystemId: warrantyOwner.systemId,\n\t\temployeeName: warrantyOwner.name,\n\t\tcustomerSystemId: seedCustomer.systemId,\n\t\tcustomerName: seedCustomer.name,\n\t\tcustomerPhone: seedCustomer.phone,\n\t\tcustomerAddress: seedCustomer.address,\n\t\ttrackingCode: 'GHTK-WAR-0452',\n\t\tpublicTrackingCode: 'r9bth1e6md',\n\t\tshippingFee: 30000,\n\t\tlinkedOrderSystemId: asSystemId('ORDER000005'),\n\t\treceivedImages: [\n\t\t\t'https://images.unsplash.com/photo-1581291518823-11e99804a128?auto=format&fit=crop&w=640&q=80',\n\t\t],\n\t\tproducts: [\n\t\t\t{\n\t\t\t\tsystemId: asSystemId('WARPROD000003'),\n\t\t\t\tproductSystemId: asSystemId('SP000008'),\n\t\t\t\tsku: asBusinessId('SP000008'),\n\t\t\t\tproductName: 'Bàn phím cơ Keychron K2',\n\t\t\t\tquantity: 1,\n\t\t\t\tunitPrice: 2500000,\n\t\t\t\tissueDescription: 'Phím space bị kẹt sau 1 tuần sử dụng',\n\t\t\t\tresolution: 'replace',\n\t\t\t\tproductImages: [\n\t\t\t\t\t'https://images.unsplash.com/photo-1503602642458-232111445657?auto=format&fit=crop&w=400&q=80',\n\t\t\t\t],\n\t\t\t},\n\t\t\t{\n\t\t\t\tsystemId: asSystemId('WARPROD000004'),\n\t\t\t\tproductSystemId: asSystemId('SP000010'),\n\t\t\t\tsku: asBusinessId('SP000010'),\n\t\t\t\tproductName: 'Switch Gateron Yellow',\n\t\t\t\tquantity: 6,\n\t\t\t\tunitPrice: 5000,\n\t\t\t\tissueDescription: 'Một số switch không nhận tín hiệu sau khi lắp',\n\t\t\t\tresolution: 'deduct',\n\t\t\t\tdeductionAmount: 60000,\n\t\t\t\tproductImages: [],\n\t\t\t\tnotes: 'Khách đề nghị hoàn tiền cho số switch lỗi',\n\t\t\t},\n\t\t],\n\t\tstatus: 'pending',\n\t\tsettlementStatus: 'pending',\n\t\tstockDeducted: false,\n\t\tnotes: 'Đang chờ kỹ thuật kiểm tra bàn phím.',\n\t\tsummary: {\n\t\t\ttotalProducts: 2,\n\t\t\ttotalReplaced: 0,\n\t\t\ttotalReturned: 0,\n\t\t\ttotalDeduction: 60000,\n\t\t\ttotalOutOfStock: 0,\n\t\t\ttotalSettlement: 60000,\n\t\t},\n\t\thistory: [\n\t\t\t{\n\t\t\t\tsystemId: asSystemId('WARHIST000004'),\n\t\t\t\taction: 'create',\n\t\t\t\tactionLabel: 'Tạo phiếu bảo hành',\n\t\t\t\tperformedBy: warrantyOwner.name,\n\t\t\t\tperformedBySystemId: warrantyOwner.systemId,\n\t\t\t\tperformedAt: '2025-11-18T03:00:00Z',\n\t\t\t\tnote: 'Khách gửi bàn phím Keychron cần bảo hành.',\n\t\t\t\tlinkedOrderSystemId: asSystemId('ORDER000005'),\n\t\t\t},\n\t\t],\n\t\tcomments: [],\n\t\tsubtasks: [],\n\t\tcreatedBy: warrantyOwner.name,\n\t\tcreatedBySystemId: warrantyOwner.systemId,\n\t\tcreatedAt: '2025-11-18T03:00:00Z',\n\t\tupdatedAt: '2025-11-18T03:00:00Z',\n\t\tupdatedBySystemId: warrantyOwner.systemId,\n\t},\n];\n\n// Template metadata snippet used when inserting new warranty tickets via seed scripts.\nexport const WARRANTY_SEED_AUDIT_TEMPLATE = buildSeedAuditFields({ createdAt: '2024-02-01T00:00:00Z' });\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 2680, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/warranty/store/base-store.ts"],"sourcesContent":["import { getCurrentDate, toISODateTime } from '../../../lib/date-utils';\r\nimport { createCrudStore } from '../../../lib/store-factory';\r\nimport type { WarrantyTicket } from '../types';\r\nimport { warrantyInitialData } from '../initial-data';\r\nimport { getCurrentUserInfo, getCurrentUserSystemId } from '../../../contexts/auth-context';\r\nimport type { SystemId } from '../../../lib/id-types';\r\n\r\n// Utility: Get Current User Info\r\nexport function getCurrentUserName(): string {\r\n  return getCurrentUserInfo().name;\r\n}\r\n\r\n// Utility: Generate Public Tracking Code\r\nexport function generatePublicTrackingCode(): string {\r\n  const chars = 'abcdefghijklmnopqrstuvwxyz0123456789';\r\n  let result = '';\r\n  for (let i = 0; i < 10; i++) {\r\n    result += chars.charAt(Math.floor(Math.random() * chars.length));\r\n  }\r\n  return result;\r\n}\r\n\r\n// Create Base Store with createCrudStore\r\nexport const baseStore = createCrudStore<WarrantyTicket>(warrantyInitialData, 'warranty', {\r\n  businessIdField: 'id',\r\n  getCurrentUser: getCurrentUserSystemId,\r\n  apiEndpoint: '/api/warranties',\r\n});\r\n\r\n// ✅ API Sync helpers\r\nconst API_ENDPOINT = '/api/warranties';\r\n\r\nconst syncToApi = {\r\n  create: async (warranty: WarrantyTicket) => {\r\n    try {\r\n      const response = await fetch(API_ENDPOINT, {\r\n        method: 'POST',\r\n        credentials: 'include',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify(warranty),\r\n      });\r\n      if (!response.ok) console.warn('[Warranty API] Create sync failed');\r\n      else console.log('[Warranty API] Created:', warranty.systemId);\r\n    } catch (e) {\r\n      console.warn('[Warranty API] Create sync error:', e);\r\n    }\r\n  },\r\n  update: async (systemId: SystemId, updates: Partial<WarrantyTicket>) => {\r\n    try {\r\n      const response = await fetch(`${API_ENDPOINT}/${systemId}`, {\r\n        method: 'PATCH',\r\n        credentials: 'include',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify(updates),\r\n      });\r\n      if (!response.ok) console.warn('[Warranty API] Update sync failed');\r\n      else console.log('[Warranty API] Updated:', systemId);\r\n    } catch (e) {\r\n      console.warn('[Warranty API] Update sync error:', e);\r\n    }\r\n  },\r\n  delete: async (systemId: SystemId, hard = false) => {\r\n    try {\r\n      const response = await fetch(`${API_ENDPOINT}/${systemId}`, {\r\n        method: 'DELETE',\r\n        credentials: 'include',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({ hard }),\r\n      });\r\n      if (!response.ok) console.warn('[Warranty API] Delete sync failed');\r\n      else console.log('[Warranty API] Deleted:', systemId);\r\n    } catch (e) {\r\n      console.warn('[Warranty API] Delete sync error:', e);\r\n    }\r\n  },\r\n  restore: async (systemId: SystemId) => {\r\n    try {\r\n      const response = await fetch(`${API_ENDPOINT}/${systemId}/restore`, {\r\n        method: 'POST',\r\n        credentials: 'include',\r\n        headers: { 'Content-Type': 'application/json' },\r\n      });\r\n      if (!response.ok) console.warn('[Warranty API] Restore sync failed');\r\n      else console.log('[Warranty API] Restored:', systemId);\r\n    } catch (e) {\r\n      console.warn('[Warranty API] Restore sync error:', e);\r\n    }\r\n  },\r\n};\r\n\r\n// Export original CRUD methods for overriding (before wrapping)\r\nexport const originalAdd = baseStore.getState().add;\r\nexport const originalUpdate = baseStore.getState().update;\r\nexport const originalRemove = baseStore.getState().remove;\r\n\r\n// ✅ Wrap base store methods with API sync (for direct usage)\r\nconst originalHardDelete = baseStore.getState().hardDelete;\r\nconst originalRestore = baseStore.getState().restore;\r\n\r\nbaseStore.setState({\r\n  hardDelete: (systemId: SystemId) => {\r\n    originalHardDelete(systemId);\r\n    syncToApi.delete(systemId, true);\r\n  },\r\n  restore: (systemId: SystemId) => {\r\n    originalRestore(systemId);\r\n    syncToApi.restore(systemId);\r\n  },\r\n});\r\n\r\n// Export sync helpers for use in index.ts (where add/update are overridden)\r\nexport { syncToApi };\r\n"],"names":[],"mappings":";;;;;;;;;;;;;;;;AACA;AAEA;AACA;;;;AAIO,SAAS;IACd,OAAO,IAAA,kJAAkB,IAAG,IAAI;AAClC;AAGO,SAAS;IACd,MAAM,QAAQ;IACd,IAAI,SAAS;IACb,IAAK,IAAI,IAAI,GAAG,IAAI,IAAI,IAAK;QAC3B,UAAU,MAAM,MAAM,CAAC,KAAK,KAAK,CAAC,KAAK,MAAM,KAAK,MAAM,MAAM;IAChE;IACA,OAAO;AACT;AAGO,MAAM,YAAY,IAAA,0IAAe,EAAiB,8JAAmB,EAAE,YAAY;IACxF,iBAAiB;IACjB,gBAAgB,sJAAsB;IACtC,aAAa;AACf;AAEA,qBAAqB;AACrB,MAAM,eAAe;AAErB,MAAM,YAAY;IAChB,QAAQ,OAAO;QACb,IAAI;YACF,MAAM,WAAW,MAAM,MAAM,cAAc;gBACzC,QAAQ;gBACR,aAAa;gBACb,SAAS;oBAAE,gBAAgB;gBAAmB;gBAC9C,MAAM,KAAK,SAAS,CAAC;YACvB;YACA,IAAI,CAAC,SAAS,EAAE,EAAE,QAAQ,IAAI,CAAC;iBAC1B,QAAQ,GAAG,CAAC,2BAA2B,SAAS,QAAQ;QAC/D,EAAE,OAAO,GAAG;YACV,QAAQ,IAAI,CAAC,qCAAqC;QACpD;IACF;IACA,QAAQ,OAAO,UAAoB;QACjC,IAAI;YACF,MAAM,WAAW,MAAM,MAAM,GAAG,aAAa,CAAC,EAAE,UAAU,EAAE;gBAC1D,QAAQ;gBACR,aAAa;gBACb,SAAS;oBAAE,gBAAgB;gBAAmB;gBAC9C,MAAM,KAAK,SAAS,CAAC;YACvB;YACA,IAAI,CAAC,SAAS,EAAE,EAAE,QAAQ,IAAI,CAAC;iBAC1B,QAAQ,GAAG,CAAC,2BAA2B;QAC9C,EAAE,OAAO,GAAG;YACV,QAAQ,IAAI,CAAC,qCAAqC;QACpD;IACF;IACA,QAAQ,OAAO,UAAoB,OAAO,KAAK;QAC7C,IAAI;YACF,MAAM,WAAW,MAAM,MAAM,GAAG,aAAa,CAAC,EAAE,UAAU,EAAE;gBAC1D,QAAQ;gBACR,aAAa;gBACb,SAAS;oBAAE,gBAAgB;gBAAmB;gBAC9C,MAAM,KAAK,SAAS,CAAC;oBAAE;gBAAK;YAC9B;YACA,IAAI,CAAC,SAAS,EAAE,EAAE,QAAQ,IAAI,CAAC;iBAC1B,QAAQ,GAAG,CAAC,2BAA2B;QAC9C,EAAE,OAAO,GAAG;YACV,QAAQ,IAAI,CAAC,qCAAqC;QACpD;IACF;IACA,SAAS,OAAO;QACd,IAAI;YACF,MAAM,WAAW,MAAM,MAAM,GAAG,aAAa,CAAC,EAAE,SAAS,QAAQ,CAAC,EAAE;gBAClE,QAAQ;gBACR,aAAa;gBACb,SAAS;oBAAE,gBAAgB;gBAAmB;YAChD;YACA,IAAI,CAAC,SAAS,EAAE,EAAE,QAAQ,IAAI,CAAC;iBAC1B,QAAQ,GAAG,CAAC,4BAA4B;QAC/C,EAAE,OAAO,GAAG;YACV,QAAQ,IAAI,CAAC,sCAAsC;QACrD;IACF;AACF;AAGO,MAAM,cAAc,UAAU,QAAQ,GAAG,GAAG;AAC5C,MAAM,iBAAiB,UAAU,QAAQ,GAAG,MAAM;AAClD,MAAM,iBAAiB,UAAU,QAAQ,GAAG,MAAM;AAEzD,6DAA6D;AAC7D,MAAM,qBAAqB,UAAU,QAAQ,GAAG,UAAU;AAC1D,MAAM,kBAAkB,UAAU,QAAQ,GAAG,OAAO;AAEpD,UAAU,QAAQ,CAAC;IACjB,YAAY,CAAC;QACX,mBAAmB;QACnB,UAAU,MAAM,CAAC,UAAU;IAC7B;IACA,SAAS,CAAC;QACR,gBAAgB;QAChB,UAAU,OAAO,CAAC;IACpB;AACF"}},
    {"offset": {"line": 2808, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/warranty/store/stock-management.ts"],"sourcesContent":["import { getCurrentDate, toISODateTime } from '../../../lib/date-utils';\r\nimport { useProductStore } from '../../products/store';\r\nimport { useStockHistoryStore } from '../../stock-history/store';\r\nimport { toast } from 'sonner';\r\nimport type { WarrantyTicket } from '../types';\r\nimport { getCurrentUserName } from './base-store';\r\n\r\n/**\r\n * Commit stock khi tạo warranty (reserve hàng cho đổi mới)\r\n * Reuse productStore.commitStock()\r\n */\r\nexport function commitWarrantyStock(ticket: WarrantyTicket) {\r\n  const replaceProducts = ticket.products.filter(p => p.resolution === 'replace');\r\n  \r\n  if (replaceProducts.length > 0) {\r\n    const productStore = useProductStore.getState();\r\n    const productCache = new Map<string, any>();\r\n    productStore.data.forEach(p => productCache.set(p.id, p));\r\n    \r\n    replaceProducts.forEach(warrantyProduct => {\r\n      if (!warrantyProduct.sku) {\r\n        console.warn('Sản phẩm thiếu SKU, bỏ qua commit:', warrantyProduct.productName);\r\n        return;\r\n      }\r\n      \r\n      const product = productCache.get(warrantyProduct.sku);\r\n      \r\n      if (!product) {\r\n        console.warn('Không tìm thấy sản phẩm trong kho:', warrantyProduct.sku);\r\n        return;\r\n      }\r\n      \r\n      const quantityToCommit = warrantyProduct.quantity || 1;\r\n      \r\n      // Reuse productStore.commitStock()\r\n      productStore.commitStock(product.systemId as any, ticket.branchSystemId as any, quantityToCommit);\r\n      \r\n      console.log('✅ [COMMIT STOCK] Giữ hàng thay thế:', {\r\n        productId: product.id,\r\n        productName: product.name,\r\n        quantity: quantityToCommit,\r\n        warranty: ticket.id,\r\n        branch: ticket.branchName\r\n      });\r\n    });\r\n  }\r\n}\r\n\r\n/**\r\n * Uncommit stock khi xóa warranty (giải phóng hàng giữ chỗ)\r\n * Reuse productStore.uncommitStock()\r\n */\r\nexport function uncommitWarrantyStock(ticket: WarrantyTicket, options?: { silent?: boolean }) {\r\n  const replaceProducts = ticket.products.filter(p => p.resolution === 'replace');\r\n  \r\n  if (replaceProducts.length > 0) {\r\n    const productStore = useProductStore.getState();\r\n    const productCache = new Map<string, any>();\r\n    productStore.data.forEach(p => productCache.set(p.id, p));\r\n    \r\n    replaceProducts.forEach(warrantyProduct => {\r\n      if (!warrantyProduct.sku) return;\r\n      \r\n      const product = productCache.get(warrantyProduct.sku);\r\n      \r\n      if (product) {\r\n      const quantityToUncommit = warrantyProduct.quantity || 1;\r\n      \r\n      // Reuse productStore.uncommitStock()\r\n      productStore.uncommitStock(product.systemId as any, ticket.branchSystemId as any, quantityToUncommit);        console.log('Đã uncommit stock:', {\r\n          productId: product.id,\r\n          quantity: quantityToUncommit,\r\n          warranty: ticket.id\r\n        });\r\n      }\r\n    });\r\n    \r\n    if (!options?.silent) {\r\n      toast.info('Đã giải phóng hàng giữ chỗ', {\r\n        description: `${replaceProducts.length} sản phẩm đã được trả lại kho có thể bán`,\r\n        duration: 3000\r\n      });\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * Xuất kho khi 'completed' - Dùng dispatchStock giống đơn hàng\r\n * NEW LOGIC: Bước 4 - Kết thúc\r\n */\r\nexport function deductWarrantyStock(ticket: WarrantyTicket) {\r\n  console.log('📤 [DEDUCT FUNCTION CALLED]:', {\r\n    ticketId: ticket.id,\r\n    ticketStatus: ticket.status,\r\n    stockDeducted: ticket.stockDeducted,\r\n    productsCount: ticket.products.length,\r\n    replaceProducts: ticket.products.filter(p => p.resolution === 'replace').length\r\n  });\r\n  \r\n  const replacedProducts = ticket.products.filter(p => p.resolution === 'replace');\r\n  \r\n  if (replacedProducts.length > 0) {\r\n    const productStore = useProductStore.getState();\r\n    const stockHistoryStore = useStockHistoryStore.getState();\r\n    const productCache = new Map<string, any>();\r\n    productStore.data.forEach(p => productCache.set(p.id, p));\r\n    \r\n    const deductionResults: string[] = [];\r\n    let hasErrors = false;\r\n    \r\n    replacedProducts.forEach(warrantyProduct => {\r\n      if (!warrantyProduct.sku) {\r\n        deductionResults.push(`Sản phẩm \"${warrantyProduct.productName}\" không có SKU`);\r\n        hasErrors = true;\r\n        return;\r\n      }\r\n      \r\n      const product = productCache.get(warrantyProduct.sku);\r\n      \r\n      if (!product) {\r\n        deductionResults.push(`Không tìm thấy SP SKU: ${warrantyProduct.sku}`);\r\n        hasErrors = true;\r\n        return;\r\n      }\r\n      \r\n      const currentInventory = product.inventoryByBranch[ticket.branchSystemId] || 0;\r\n      const quantityToDeduct = warrantyProduct.quantity || 1;\r\n      \r\n      console.log('📤 [DEDUCT] Before:', {\r\n        productId: product.id,\r\n        currentInventory,\r\n        quantityToDeduct,\r\n        branchSystemId: ticket.branchSystemId\r\n      });\r\n      \r\n      if (currentInventory < quantityToDeduct) {\r\n        deductionResults.push(`${product.name} (${product.id}): Không đủ hàng (Tồn: ${currentInventory}, Cần: ${quantityToDeduct})`);\r\n        hasErrors = true;\r\n        return;\r\n      }\r\n      \r\n      // ✅ Xuất kho trực tiếp (không dùng dispatchStock vì warranty không có inTransit)\r\n      // -Tồn kho\r\n      productStore.updateInventory(product.systemId as any, ticket.branchSystemId as any, -quantityToDeduct);\r\n      // -Đang giao dịch (uncommit)\r\n      productStore.uncommitStock(product.systemId as any, ticket.branchSystemId as any, quantityToDeduct);\r\n      \r\n      // ✅ Lấy lại product sau khi update\r\n      const freshProductStore = useProductStore.getState();\r\n      const updatedProduct = freshProductStore.data.find(p => p.systemId === product.systemId);\r\n      const newStockLevel = updatedProduct?.inventoryByBranch[ticket.branchSystemId] || currentInventory - quantityToDeduct;\r\n      \r\n      console.log('✅ [DEDUCT] After:', {\r\n        productId: product.id,\r\n        newStockLevel,\r\n        expectedLevel: currentInventory - quantityToDeduct\r\n      });\r\n      \r\n      stockHistoryStore.addEntry({\r\n        productId: product.systemId,\r\n        date: toISODateTime(getCurrentDate()),\r\n        employeeName: getCurrentUserName(),\r\n        action: 'Xuất bảo hành (đổi mới)',\r\n        quantityChange: -quantityToDeduct,\r\n        newStockLevel,\r\n        documentId: ticket.id, // Business ID for display (BH000001)\r\n        branchSystemId: ticket.branchSystemId,\r\n        branch: ticket.branchName,\r\n      });\r\n      \r\n      deductionResults.push(`${product.name} (${product.id}): Trừ ${quantityToDeduct} cái (Còn: ${newStockLevel})`);\r\n    });\r\n    \r\n    if (hasErrors) {\r\n      toast.error('Có lỗi khi xuất kho', {\r\n        description: deductionResults.join('\\n'),\r\n        duration: 6000,\r\n      });\r\n    } else {\r\n      toast.success('Đã xuất kho sản phẩm thay thế', {\r\n        description: `Xuất ${replacedProducts.length} sản phẩm tại chi nhánh ${ticket.branchName}`,\r\n        duration: 4000,\r\n      });\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * Hoàn kho khi hủy warranty - Ngược lại với dispatchStock\r\n * NEW LOGIC: +Tồn kho + +Đang giao dịch\r\n */\r\nexport function rollbackWarrantyStock(ticket: WarrantyTicket) {\r\n  console.log('🔄 [ROLLBACK FUNCTION CALLED]:', {\r\n    ticketId: ticket.id,\r\n    ticketStatus: ticket.status,\r\n    stockDeducted: ticket.stockDeducted,\r\n    productsCount: ticket.products.length,\r\n    replaceProducts: ticket.products.filter(p => p.resolution === 'replace').length\r\n  });\r\n  \r\n  const replacedProducts = ticket.products.filter(p => p.resolution === 'replace');\r\n  \r\n  if (replacedProducts.length > 0) {\r\n    const productStore = useProductStore.getState();\r\n    const stockHistoryStore = useStockHistoryStore.getState();\r\n    const productCache = new Map<string, any>();\r\n    productStore.data.forEach(p => productCache.set(p.id, p));\r\n    \r\n    const rollbackResults: string[] = [];\r\n    \r\n    replacedProducts.forEach(warrantyProduct => {\r\n      if (!warrantyProduct.sku) {\r\n        rollbackResults.push(`Sản phẩm \"${warrantyProduct.productName}\" không có SKU`);\r\n        return;\r\n      }\r\n      \r\n      const product = productCache.get(warrantyProduct.sku);\r\n      \r\n      if (!product) {\r\n        rollbackResults.push(`Không tìm thấy SP SKU: ${warrantyProduct.sku}`);\r\n        return;\r\n      }\r\n      \r\n      const quantityToRollback = warrantyProduct.quantity || 1;\r\n      const currentInventory = product.inventoryByBranch[ticket.branchSystemId] || 0;\r\n      \r\n      console.log('🔄 [ROLLBACK] Before:', {\r\n        productId: product.id,\r\n        currentInventory,\r\n        quantityToRollback,\r\n        branchSystemId: ticket.branchSystemId\r\n      });\r\n      \r\n      // ✅ Hoàn kho: +Tồn kho (warranty xuất trực tiếp, không qua inTransit)\r\n      productStore.updateInventory(product.systemId as any, ticket.branchSystemId as any, quantityToRollback);\r\n      \r\n      // ✅ Lấy lại product sau khi update để có inventory mới\r\n      const freshProductStore = useProductStore.getState();\r\n      const updatedProduct = freshProductStore.data.find(p => p.systemId === product.systemId);\r\n      const newStockLevel = updatedProduct?.inventoryByBranch[ticket.branchSystemId] || currentInventory + quantityToRollback;\r\n      \r\n      console.log('✅ [ROLLBACK] After:', {\r\n        productId: product.id,\r\n        newStockLevel,\r\n        expectedLevel: currentInventory + quantityToRollback\r\n      });\r\n      \r\n      // Note: Không cần uncommit vì khi deduct đã uncommit rồi\r\n      \r\n      stockHistoryStore.addEntry({\r\n        productId: product.systemId,\r\n        date: toISODateTime(getCurrentDate()),\r\n        employeeName: getCurrentUserName(),\r\n        action: 'Hoàn kho (Hủy bảo hành)',\r\n        quantityChange: quantityToRollback,\r\n        newStockLevel,\r\n        documentId: ticket.id,\r\n        branchSystemId: ticket.branchSystemId,\r\n        branch: ticket.branchName,\r\n      });\r\n      \r\n      rollbackResults.push(`${product.name} (${product.id}): Hoàn ${quantityToRollback} cái`);\r\n    });\r\n    \r\n    toast.info('Đã hoàn kho sản phẩm thay thế', {\r\n      description: rollbackResults.join('\\n'),\r\n      duration: 4000,\r\n    });\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 3034, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/warranty/store/product-management.ts"],"sourcesContent":["import { getCurrentDate, toISODateTime } from '../../../lib/date-utils';\r\nimport { asSystemId } from '../../../lib/id-types';\r\nimport type { SystemId } from '../../../lib/id-types';\r\nimport type { WarrantyProduct, WarrantyHistory, WarrantyTicket } from '../types';\r\nimport { baseStore, originalUpdate, getCurrentUserName } from './base-store';\r\nimport { commitWarrantyStock, uncommitWarrantyStock } from './stock-management';\r\n\r\n/**\r\n * Tính summary từ danh sách sản phẩm\r\n */\r\nexport function calculateSummary(products: WarrantyProduct[]) {\r\n  const outOfStockProducts = products.filter(p => p.resolution === 'out_of_stock' || p.resolution === 'deduct');\r\n  \r\n  const totalSettlement = outOfStockProducts.reduce((sum, p) => {\r\n    if (p.resolution === 'deduct') return sum + (p.deductionAmount || 0);\r\n    if (p.resolution === 'out_of_stock') return sum + ((p.quantity || 1) * (p.unitPrice || 0));\r\n    return sum;\r\n  }, 0);\r\n  \r\n  return {\r\n    totalProducts: products.reduce((sum, p) => sum + (p.quantity || 1), 0),\r\n    totalReplaced: products.filter(p => p.resolution === 'replace').reduce((sum, p) => sum + (p.quantity || 1), 0),\r\n    totalReturned: products.filter(p => p.resolution === 'return').reduce((sum, p) => sum + (p.quantity || 1), 0),\r\n    totalDeduction: totalSettlement,\r\n    totalOutOfStock: outOfStockProducts.reduce((sum, p) => sum + (p.quantity || 1), 0),\r\n    totalSettlement: totalSettlement,\r\n  };\r\n}\r\n\r\nfunction adjustReplacementStock(\r\n  ticket: WarrantyTicket,\r\n  previousProduct?: WarrantyProduct,\r\n  nextProduct?: WarrantyProduct\r\n) {\r\n  if (!ticket) return;\r\n\r\n  const previousQty = previousProduct?.resolution === 'replace' ? (previousProduct.quantity || 1) : 0;\r\n  const nextQty = nextProduct?.resolution === 'replace' ? (nextProduct.quantity || 1) : 0;\r\n\r\n  if (previousQty === nextQty) {\r\n    return;\r\n  }\r\n\r\n  const diff = Math.abs(nextQty - previousQty);\r\n  const referenceProduct = nextQty > previousQty ? nextProduct : previousProduct;\r\n  if (!referenceProduct || diff <= 0) return;\r\n\r\n  const tempProduct: WarrantyProduct = {\r\n    ...referenceProduct,\r\n    quantity: diff,\r\n  };\r\n\r\n  const tempTicket = {\r\n    ...ticket,\r\n    products: [tempProduct],\r\n  } as WarrantyTicket;\r\n\r\n  if (nextQty > previousQty) {\r\n    commitWarrantyStock(tempTicket);\r\n  } else {\r\n    uncommitWarrantyStock(tempTicket, { silent: true });\r\n  }\r\n}\r\n\r\n/**\r\n * Thêm sản phẩm vào phiếu bảo hành\r\n */\r\nexport function addProduct(ticketSystemId: SystemId, product: Omit<WarrantyProduct, 'systemId'>) {\r\n  const ticket = baseStore.getState().data.find(t => t.systemId === ticketSystemId);\r\n  if (!ticket) return;\r\n  \r\n  const newProduct: WarrantyProduct = {\r\n    ...product,\r\n    systemId: asSystemId(`WP_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`),\r\n  };\r\n\r\n  adjustReplacementStock(ticket, undefined, newProduct);\r\n  \r\n  const updatedProducts = [...ticket.products, newProduct];\r\n  const summary = calculateSummary(updatedProducts);\r\n  \r\n  originalUpdate(ticketSystemId, {\r\n    ...ticket,\r\n    products: updatedProducts,\r\n    summary,\r\n    updatedAt: toISODateTime(getCurrentDate()),\r\n  } as any);\r\n  \r\n  // Add history\r\n  const resolutionLabels: Record<string, string> = {\r\n    replace: 'Thay thế',\r\n    refund: 'Hoàn tiền',\r\n    deduct: 'Trừ tiền',\r\n    warranty_extension: 'Gia hạn BH',\r\n    no_warranty: 'Không BH',\r\n    out_of_stock: 'Hết hàng',\r\n    return: 'Trả hàng'\r\n  };\r\n  const resolution = resolutionLabels[newProduct.resolution] || newProduct.resolution;\r\n  const quantity = newProduct.quantity || 1;\r\n  \r\n  addHistory(ticketSystemId, `Thêm SP: ${newProduct.productName} (${resolution}, SL: ${quantity})`, getCurrentUserName());\r\n}\r\n\r\n/**\r\n * Cập nhật sản phẩm trong phiếu\r\n */\r\nexport function updateProduct(ticketSystemId: SystemId, productSystemId: SystemId, updates: Partial<WarrantyProduct>) {\r\n  const ticket = baseStore.getState().data.find(t => t.systemId === ticketSystemId);\r\n  if (!ticket) return;\r\n  const originalProduct = ticket.products.find(p => p.systemId === productSystemId);\r\n  if (!originalProduct) return;\r\n  \r\n  const updatedProducts = ticket.products.map(p =>\r\n    p.systemId === productSystemId ? { ...p, ...updates } : p\r\n  );\r\n  \r\n  const summary = calculateSummary(updatedProducts);\r\n  const updatedProduct = updatedProducts.find(p => p.systemId === productSystemId);\r\n  adjustReplacementStock(ticket, originalProduct, updatedProduct);\r\n  \r\n  originalUpdate(ticketSystemId, {\r\n    ...ticket,\r\n    products: updatedProducts,\r\n    summary,\r\n    updatedAt: toISODateTime(getCurrentDate()),\r\n  } as any);\r\n  \r\n  // Add history\r\n  if (updatedProduct) {\r\n    addHistory(ticketSystemId, `Cập nhật SP: ${updatedProduct.productName}`, getCurrentUserName());\r\n  }\r\n}\r\n\r\n/**\r\n * Xóa sản phẩm khỏi phiếu\r\n */\r\nexport function removeProduct(ticketSystemId: SystemId, productSystemId: SystemId) {\r\n  const ticket = baseStore.getState().data.find(t => t.systemId === ticketSystemId);\r\n  if (!ticket) return;\r\n  \r\n  const productToRemove = ticket.products.find(p => p.systemId === productSystemId);\r\n  const updatedProducts = ticket.products.filter(p => p.systemId !== productSystemId);\r\n  \r\n  const summary = calculateSummary(updatedProducts);\r\n\r\n  if (productToRemove) {\r\n    adjustReplacementStock(ticket, productToRemove, undefined);\r\n  }\r\n  \r\n  originalUpdate(ticketSystemId, {\r\n    ...ticket,\r\n    products: updatedProducts,\r\n    summary,\r\n    updatedAt: toISODateTime(getCurrentDate()),\r\n  } as any);\r\n  \r\n  if (productToRemove) {\r\n    addHistory(ticketSystemId, `Xóa SP: ${productToRemove.productName}`, getCurrentUserName());\r\n  }\r\n}\r\n\r\n/**\r\n * Tính toán lại summary\r\n */\r\nexport function recalculateSummary(ticketSystemId: SystemId) {\r\n  const ticket = baseStore.getState().data.find(t => t.systemId === ticketSystemId);\r\n  if (!ticket) return;\r\n  \r\n  const summary = calculateSummary(ticket.products);\r\n  \r\n  originalUpdate(ticketSystemId, {\r\n    ...ticket,\r\n    summary,\r\n  } as any);\r\n}\r\n\r\n/**\r\n * Helper: Tính trạng thái thanh toán\r\n */\r\nexport function calculateSettlementStatus(\r\n  totalSettlement: number, \r\n  totalPaid: number, \r\n  shippingFee: number = 0\r\n): 'pending' | 'partial' | 'completed' {\r\n  if (totalSettlement <= 0) return 'completed';\r\n  \r\n  const netAmount = totalSettlement - shippingFee;\r\n  if (netAmount <= 0) return 'completed';\r\n  \r\n  if (totalPaid === 0) return 'pending';\r\n  if (totalPaid >= netAmount) return 'completed';\r\n  return 'partial';\r\n}\r\n\r\n/**\r\n * Thêm lịch sử (internal use only)\r\n */\r\nexport function addHistory(\r\n  ticketSystemId: SystemId, \r\n  action: string, \r\n  performedBy: string, \r\n  note?: string,\r\n  metadata?: Record<string, any>\r\n) {\r\n  const ticket = baseStore.getState().data.find(t => t.systemId === ticketSystemId);\r\n  if (!ticket) return;\r\n  \r\n  const historyEntry: WarrantyHistory = {\r\n    systemId: asSystemId(`WH_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`),\r\n    action,\r\n    actionLabel: action,\r\n    performedBy,\r\n    performedAt: toISODateTime(getCurrentDate()),\r\n    note,\r\n    metadata,\r\n  };\r\n  \r\n  originalUpdate(ticketSystemId, {\r\n    ...ticket,\r\n    history: [...(ticket.history || []), historyEntry],\r\n  } as any);\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 3218, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/warranty/store/status-management.ts"],"sourcesContent":["import { getCurrentDate, toISODateTime } from '../../../lib/date-utils';\r\nimport type { SystemId } from '../../../lib/id-types';\r\nimport type { WarrantyTicket, WarrantyStatus } from '../types';\r\nimport { baseStore, originalUpdate, getCurrentUserName } from './base-store';\r\nimport { addHistory } from './product-management';\r\nimport { deductWarrantyStock, rollbackWarrantyStock } from './stock-management';\r\nimport {\r\n  notifyWarrantyProcessing,\r\n  notifyWarrantyProcessed,\r\n  notifyWarrantyReturned,\r\n} from '../notification-utils';\r\nimport { triggerWarrantyDataUpdate } from '../use-realtime-updates';\r\n\r\ntype TimestampKey = 'processingStartedAt' | 'processedAt' | 'returnedAt' | 'completedAt';\r\n\r\nconst STATUS_ORDER: Record<WarrantyStatus, number> = {\r\n  incomplete: 0,\r\n  pending: 1,\r\n  processed: 2,\r\n  returned: 3,\r\n  completed: 4,\r\n  cancelled: 5,\r\n};\r\n\r\nconst TIMESTAMP_STAGES: Array<{ key: TimestampKey; stageOrder: number }> = [\r\n  { key: 'processingStartedAt', stageOrder: STATUS_ORDER.pending },\r\n  { key: 'processedAt', stageOrder: STATUS_ORDER.processed },\r\n  { key: 'returnedAt', stageOrder: STATUS_ORDER.returned },\r\n  { key: 'completedAt', stageOrder: STATUS_ORDER.completed },\r\n];\r\n\r\nfunction computeTimestampUpdates(\r\n  ticket: WarrantyTicket,\r\n  newStatus: WarrantyStatus,\r\n  nowIso: string\r\n): Partial<Pick<WarrantyTicket, TimestampKey>> {\r\n  const updates: Partial<Pick<WarrantyTicket, TimestampKey>> = {};\r\n  const oldOrder = STATUS_ORDER[ticket.status] ?? 0;\r\n  const newOrder = STATUS_ORDER[newStatus] ?? oldOrder;\r\n\r\n  TIMESTAMP_STAGES.forEach(({ key, stageOrder }) => {\r\n    const currentValue = ticket[key];\r\n    const crossedForward = newOrder >= stageOrder && oldOrder < stageOrder;\r\n\r\n    if (newStatus !== 'cancelled' && crossedForward && !currentValue) {\r\n      updates[key] = nowIso;\r\n      return;\r\n    }\r\n\r\n    const movedBackward = newOrder < stageOrder;\r\n    if (movedBackward && currentValue) {\r\n      updates[key] = undefined;\r\n    }\r\n  });\r\n\r\n  return updates;\r\n}\r\n\r\n/**\r\n * Cập nhật trạng thái phiếu bảo hành\r\n * NEW LOGIC theo yêu cầu:\r\n * - pending: +Đang giao dịch (commitWarrantyStock)\r\n * - processed: Không động kho\r\n * - returned: Không động kho\r\n * - completed: -Đang giao dịch + -Tồn kho (deductWarrantyStock)\r\n */\r\nexport function updateStatus(ticketSystemId: SystemId, newStatus: WarrantyTicket['status'], note?: string) {\r\n  const ticket = baseStore.getState().data.find(t => t.systemId === ticketSystemId);\r\n  if (!ticket) return;\r\n  \r\n  console.log('[STATUS CHANGE]', {\r\n    ticketId: ticket.id,\r\n    oldStatus: ticket.status,\r\n    newStatus: newStatus,\r\n    productsCount: ticket.products.length,\r\n    replacedProducts: ticket.products.filter(p => p.resolution === 'replace').length\r\n  });\r\n  \r\n  const nowIso = toISODateTime(getCurrentDate());\r\n  const timestampUpdates = computeTimestampUpdates(ticket, newStatus, nowIso);\r\n  const baseUpdate: WarrantyTicket = {\r\n    ...ticket,\r\n    ...timestampUpdates,\r\n    status: newStatus,\r\n    updatedAt: nowIso,\r\n  };\r\n\r\n  // XUẤT KHO khi completed (CHỈ 1 LẦN DUY NHẤT - không trừ lại khi reopen)\r\n  if (newStatus === 'completed' && ticket.status !== 'completed' && !ticket.stockDeducted) {\r\n    console.log('[COMPLETED - DEDUCT] Xuất kho (LẦN ĐẦU TIÊN):', {\r\n      ticketId: ticket.id,\r\n      oldStatus: ticket.status,\r\n      newStatus: newStatus,\r\n      stockDeducted: ticket.stockDeducted,\r\n      action: '-Đang giao dịch + -Tồn kho'\r\n    });\r\n    deductWarrantyStock(ticket);\r\n    \r\n    // Set flag để không trừ lại lần nữa\r\n    originalUpdate(ticketSystemId, {\r\n      ...baseUpdate,\r\n      stockDeducted: true,\r\n    } as any);\r\n  } else if (newStatus === 'completed' && ticket.stockDeducted) {\r\n    console.log('[COMPLETED - SKIP DEDUCT] Đã trừ kho rồi, bỏ qua:', {\r\n      ticketId: ticket.id,\r\n      oldStatus: ticket.status,\r\n      newStatus: newStatus,\r\n      stockDeducted: ticket.stockDeducted\r\n    });\r\n    \r\n    // Chỉ update status, KHÔNG trừ kho nữa\r\n    originalUpdate(ticketSystemId, baseUpdate as any);\r\n  } else {\r\n    // Normal status update (không phải completed)\r\n    originalUpdate(ticketSystemId, baseUpdate as any);\r\n  }\r\n  \r\n  // KHÔNG ROLLBACK KHO khi mở lại từ completed\r\n  // Lý do:\r\n  // - Kết thúc = Đơn đã xong, hàng đã xuất, tiền đã thanh toán đầy đủ\r\n  // - Mở lại (completed → returned) CHỈ để xem lại, KHÔNG được sửa/thay đổi gì\r\n  // - Nếu cần điều chỉnh → Phải tạo phiếu mới, hoàn hàng thủ công, tạo phiếu thu/chi riêng\r\n  // - Giữ nguyên inventory và payment history để đảm bảo tính toàn vẹn dữ liệu\r\n  \r\n  // KHÔNG ROLLBACK KHO khi mở lại từ completed\r\n  // Lý do:\r\n  // - Kết thúc = Đơn đã xong, hàng đã xuất, tiền đã thanh toán đầy đủ\r\n  // - Mở lại (completed → returned) CHỈ để xem lại, KHÔNG được sửa/thay đổi gì\r\n  // - Nếu cần điều chỉnh → Phải tạo phiếu mới, hoàn hàng thủ công, tạo phiếu thu/chi riêng\r\n  // - Giữ nguyên inventory và payment history để đảm bảo tính toàn vẹn dữ liệu\r\n  \r\n  // Add history với format rõ ràng\r\n  const statusLabels: Record<string, string> = {\r\n    incomplete: 'Chưa đủ thông tin',\r\n    pending: 'Chưa xử lý',\r\n    processed: 'Đã xử lý',\r\n    returned: 'Đã trả hàng',\r\n    completed: 'Kết thúc'\r\n  };\r\n  const oldStatusLabel = statusLabels[ticket.status] || ticket.status;\r\n  const newStatusLabel = statusLabels[newStatus] || newStatus;\r\n  \r\n  // Format history dựa trên hướng chuyển đổi\r\n  let historyAction: string;\r\n  if (ticket.status === 'completed' && (newStatus === 'returned' || newStatus === 'processed')) {\r\n    // Mở lại từ \"Kết thúc\"\r\n    historyAction = `Mở lại từ ${oldStatusLabel}`;\r\n  } else if (ticket.status === 'returned' && newStatus === 'processed') {\r\n    // Mở lại từ \"Đã trả hàng\"\r\n    historyAction = `Mở lại từ ${oldStatusLabel}`;\r\n  } else if (newStatus === 'completed') {\r\n    // Kết thúc phiếu\r\n    historyAction = 'Kết thúc phiếu bảo hành';\r\n  } else {\r\n    // Chuyển trạng thái bình thường\r\n    historyAction = `Chuyển trạng thái: ${oldStatusLabel} → ${newStatusLabel}`;\r\n  }\r\n  \r\n  addHistory(ticketSystemId, historyAction, getCurrentUserName(), note);\r\n  \r\n  // Send notifications\r\n  if (ticket.status !== newStatus) {\r\n    if (newStatus === 'pending') {\r\n      notifyWarrantyProcessing(ticket.id);\r\n    } else if (newStatus === 'processed') {\r\n      notifyWarrantyProcessed(ticket.id);\r\n    } else if (newStatus === 'returned') {\r\n      notifyWarrantyReturned(ticket.id, undefined);\r\n    }\r\n  }\r\n  \r\n  triggerWarrantyDataUpdate();\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;AAGA;AACA;AACA;AACA;AAKA;;;;;;;AAIA,MAAM,eAA+C;IACnD,YAAY;IACZ,SAAS;IACT,WAAW;IACX,UAAU;IACV,WAAW;IACX,WAAW;AACb;AAEA,MAAM,mBAAqE;IACzE;QAAE,KAAK;QAAuB,YAAY,aAAa,OAAO;IAAC;IAC/D;QAAE,KAAK;QAAe,YAAY,aAAa,SAAS;IAAC;IACzD;QAAE,KAAK;QAAc,YAAY,aAAa,QAAQ;IAAC;IACvD;QAAE,KAAK;QAAe,YAAY,aAAa,SAAS;IAAC;CAC1D;AAED,SAAS,wBACP,MAAsB,EACtB,SAAyB,EACzB,MAAc;IAEd,MAAM,UAAuD,CAAC;IAC9D,MAAM,WAAW,YAAY,CAAC,OAAO,MAAM,CAAC,IAAI;IAChD,MAAM,WAAW,YAAY,CAAC,UAAU,IAAI;IAE5C,iBAAiB,OAAO,CAAC,CAAC,EAAE,GAAG,EAAE,UAAU,EAAE;QAC3C,MAAM,eAAe,MAAM,CAAC,IAAI;QAChC,MAAM,iBAAiB,YAAY,cAAc,WAAW;QAE5D,IAAI,cAAc,eAAe,kBAAkB,CAAC,cAAc;YAChE,OAAO,CAAC,IAAI,GAAG;YACf;QACF;QAEA,MAAM,gBAAgB,WAAW;QACjC,IAAI,iBAAiB,cAAc;YACjC,OAAO,CAAC,IAAI,GAAG;QACjB;IACF;IAEA,OAAO;AACT;AAUO,SAAS,aAAa,cAAwB,EAAE,SAAmC,EAAE,IAAa;IACvG,MAAM,SAAS,2JAAS,CAAC,QAAQ,GAAG,IAAI,CAAC,IAAI,CAAC,CAAA,IAAK,EAAE,QAAQ,KAAK;IAClE,IAAI,CAAC,QAAQ;IAEb,QAAQ,GAAG,CAAC,mBAAmB;QAC7B,UAAU,OAAO,EAAE;QACnB,WAAW,OAAO,MAAM;QACxB,WAAW;QACX,eAAe,OAAO,QAAQ,CAAC,MAAM;QACrC,kBAAkB,OAAO,QAAQ,CAAC,MAAM,CAAC,CAAA,IAAK,EAAE,UAAU,KAAK,WAAW,MAAM;IAClF;IAEA,MAAM,SAAS,IAAA,qIAAa,EAAC,IAAA,sIAAc;IAC3C,MAAM,mBAAmB,wBAAwB,QAAQ,WAAW;IACpE,MAAM,aAA6B;QACjC,GAAG,MAAM;QACT,GAAG,gBAAgB;QACnB,QAAQ;QACR,WAAW;IACb;IAEA,yEAAyE;IACzE,IAAI,cAAc,eAAe,OAAO,MAAM,KAAK,eAAe,CAAC,OAAO,aAAa,EAAE;QACvF,QAAQ,GAAG,CAAC,iDAAiD;YAC3D,UAAU,OAAO,EAAE;YACnB,WAAW,OAAO,MAAM;YACxB,WAAW;YACX,eAAe,OAAO,aAAa;YACnC,QAAQ;QACV;QACA,IAAA,2KAAmB,EAAC;QAEpB,oCAAoC;QACpC,IAAA,gKAAc,EAAC,gBAAgB;YAC7B,GAAG,UAAU;YACb,eAAe;QACjB;IACF,OAAO,IAAI,cAAc,eAAe,OAAO,aAAa,EAAE;QAC5D,QAAQ,GAAG,CAAC,qDAAqD;YAC/D,UAAU,OAAO,EAAE;YACnB,WAAW,OAAO,MAAM;YACxB,WAAW;YACX,eAAe,OAAO,aAAa;QACrC;QAEA,uCAAuC;QACvC,IAAA,gKAAc,EAAC,gBAAgB;IACjC,OAAO;QACL,8CAA8C;QAC9C,IAAA,gKAAc,EAAC,gBAAgB;IACjC;IAEA,6CAA6C;IAC7C,SAAS;IACT,oEAAoE;IACpE,6EAA6E;IAC7E,yFAAyF;IACzF,6EAA6E;IAE7E,6CAA6C;IAC7C,SAAS;IACT,oEAAoE;IACpE,6EAA6E;IAC7E,yFAAyF;IACzF,6EAA6E;IAE7E,iCAAiC;IACjC,MAAM,eAAuC;QAC3C,YAAY;QACZ,SAAS;QACT,WAAW;QACX,UAAU;QACV,WAAW;IACb;IACA,MAAM,iBAAiB,YAAY,CAAC,OAAO,MAAM,CAAC,IAAI,OAAO,MAAM;IACnE,MAAM,iBAAiB,YAAY,CAAC,UAAU,IAAI;IAElD,2CAA2C;IAC3C,IAAI;IACJ,IAAI,OAAO,MAAM,KAAK,eAAe,CAAC,cAAc,cAAc,cAAc,WAAW,GAAG;QAC5F,uBAAuB;QACvB,gBAAgB,CAAC,UAAU,EAAE,gBAAgB;IAC/C,OAAO,IAAI,OAAO,MAAM,KAAK,cAAc,cAAc,aAAa;QACpE,0BAA0B;QAC1B,gBAAgB,CAAC,UAAU,EAAE,gBAAgB;IAC/C,OAAO,IAAI,cAAc,aAAa;QACpC,iBAAiB;QACjB,gBAAgB;IAClB,OAAO;QACL,gCAAgC;QAChC,gBAAgB,CAAC,mBAAmB,EAAE,eAAe,GAAG,EAAE,gBAAgB;IAC5E;IAEA,IAAA,oKAAU,EAAC,gBAAgB,eAAe,IAAA,oKAAkB,KAAI;IAEhE,qBAAqB;IACrB,IAAI,OAAO,MAAM,KAAK,WAAW;QAC/B,IAAI,cAAc,WAAW;YAC3B,IAAA,yKAAwB,EAAC,OAAO,EAAE;QACpC,OAAO,IAAI,cAAc,aAAa;YACpC,IAAA,wKAAuB,EAAC,OAAO,EAAE;QACnC,OAAO,IAAI,cAAc,YAAY;YACnC,IAAA,uKAAsB,EAAC,OAAO,EAAE,EAAE;QACpC;IACF;IAEA,IAAA,+KAAyB;AAC3B"}},
    {"offset": {"line": 3378, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/warranty/store/index.ts"],"sourcesContent":["import { create } from 'zustand';\r\nimport { getCurrentDate, toISODateTime } from '../../../lib/date-utils';\r\nimport { getWorkflowTemplate } from '../../settings/printer/workflow-templates-page';\r\nimport { toast } from 'sonner';\r\nimport { asSystemId } from '../../../lib/id-types';\r\nimport type { SystemId } from '../../../lib/id-types';\r\nimport {\r\n  notifyWarrantyCreated,\r\n} from '../notification-utils';\r\nimport { triggerWarrantyDataUpdate } from '../use-realtime-updates';\r\nimport type { WarrantyTicket, WarrantyProduct } from '../types';\r\nimport type { WarrantyStore } from '../types';\r\n\r\n// Import base store và các modules\r\nimport {\r\n  baseStore,\r\n  originalAdd,\r\n  originalUpdate,\r\n  originalRemove,\r\n  generatePublicTrackingCode,\r\n  getCurrentUserName,\r\n  syncToApi,\r\n} from './base-store';\r\n\r\nimport {\r\n  commitWarrantyStock,\r\n  uncommitWarrantyStock,\r\n} from './stock-management';\r\n\r\nimport {\r\n  addProduct,\r\n  updateProduct,\r\n  removeProduct,\r\n  recalculateSummary,\r\n  calculateSummary,\r\n  calculateSettlementStatus,\r\n  addHistory,\r\n} from './product-management';\r\n\r\nimport {\r\n  updateStatus,\r\n} from './status-management';\r\n\r\n// Override add() for custom logic\r\nbaseStore.setState({\r\n  add: (item: Omit<WarrantyTicket, 'systemId'>) => {\r\n    // Auto ID generation by createCrudStore\r\n    const newTicket = originalAdd(item);\r\n    \r\n    // Copy workflow template subtasks\r\n    const subtasks = getWorkflowTemplate('warranty');\r\n    if (subtasks && subtasks.length > 0) {\r\n      newTicket.subtasks = subtasks;\r\n    }\r\n    \r\n    // Generate public tracking code\r\n    if (!newTicket.publicTrackingCode) {\r\n      newTicket.publicTrackingCode = generatePublicTrackingCode();\r\n    }\r\n    \r\n    // Commit stock for replace products\r\n    commitWarrantyStock(newTicket);\r\n    \r\n    // Add initial history\r\n    if (!newTicket.history || newTicket.history.length === 0) {\r\n      newTicket.history = [{\r\n        systemId: asSystemId(`WH_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`),\r\n        action: 'Tạo phiếu bảo hành',\r\n        actionLabel: 'Tạo phiếu bảo hành',\r\n        performedBy: getCurrentUserName(),\r\n        performedAt: toISODateTime(getCurrentDate()),\r\n      }];\r\n    }\r\n    \r\n    // Update state to include subtasks, history, publicTrackingCode\r\n    baseStore.setState((state) => ({\r\n      data: state.data.map(t => t.systemId === newTicket.systemId ? newTicket : t)\r\n    }));\r\n    \r\n    // ✅ Sync to API\r\n    syncToApi.create(newTicket);\r\n    \r\n    // Send notification\r\n    notifyWarrantyCreated(newTicket.id);\r\n    \r\n    // Trigger realtime update\r\n    triggerWarrantyDataUpdate();\r\n    \r\n    return newTicket;\r\n  },\r\n  \r\n  update: (systemId: SystemId, updates: any) => {\r\n    const oldTicket = baseStore.getState().data.find(t => t.systemId === systemId);\r\n    if (!oldTicket) return;\r\n    \r\n    // Check if history is explicitly provided\r\n    const hasExplicitHistory = updates.history && updates.history.length > (oldTicket.history?.length || 0);\r\n    \r\n    // Track changes for auto-history\r\n    const changes: string[] = [];\r\n    \r\n    if (!hasExplicitHistory) {\r\n      if (updates.customerName && updates.customerName !== oldTicket.customerName) {\r\n        changes.push(`Tên khách hàng: \"${oldTicket.customerName}\" → \"${updates.customerName}\"`);\r\n      }\r\n      if (updates.customerPhone && updates.customerPhone !== oldTicket.customerPhone) {\r\n        changes.push(`Số điện thoại: \"${oldTicket.customerPhone}\" → \"${updates.customerPhone}\"`);\r\n      }\r\n      if (updates.trackingCode && updates.trackingCode !== oldTicket.trackingCode) {\r\n        changes.push(`Mã vận đơn: \"${oldTicket.trackingCode}\" → \"${updates.trackingCode}\"`);\r\n      }\r\n    }\r\n    \r\n    originalUpdate(systemId, updates);\r\n    \r\n    // ✅ Sync to API\r\n    syncToApi.update(systemId, updates);\r\n    \r\n    // Add auto-history\r\n    if (!hasExplicitHistory && changes.length > 0) {\r\n      changes.forEach(change => {\r\n        addHistory(systemId, change, getCurrentUserName());\r\n      });\r\n    }\r\n    \r\n    // Trigger realtime update\r\n    triggerWarrantyDataUpdate();\r\n  },\r\n  \r\n  remove: (systemId: SystemId) => {\r\n    const ticket = baseStore.getState().data.find(t => t.systemId === systemId);\r\n    \r\n    if (ticket) {\r\n      // Add history before deletion\r\n      addHistory(systemId, 'Xóa phiếu bảo hành (chuyển vào thùng rác)', getCurrentUserName());\r\n      \r\n      // Uncommit stock\r\n      uncommitWarrantyStock(ticket);\r\n    }\r\n    \r\n    originalRemove(systemId);\r\n    \r\n    // ✅ Sync to API\r\n    syncToApi.delete(systemId, false);\r\n    \r\n    // Trigger realtime update\r\n    triggerWarrantyDataUpdate();\r\n  },\r\n});\r\n\r\nexport const useWarrantyStore = create<WarrantyStore>()((set, get) => ({\r\n  ...baseStore.getState(),\r\n  \r\n  // Warranty-specific methods\r\n  addProduct,\r\n  updateProduct,\r\n  removeProduct,\r\n  updateStatus,\r\n  addHistory,\r\n  recalculateSummary,\r\n  calculateSummary,\r\n  calculateSettlementStatus,\r\n  \r\n  // Placeholder methods for backward compatibility\r\n  addComment: () => console.warn('addComment: Use generic Comments component instead'),\r\n  updateComment: () => console.warn('updateComment: Use generic Comments component instead'),\r\n  deleteComment: () => console.warn('deleteComment: Use generic Comments component instead'),\r\n  replyComment: () => console.warn('replyComment: Use generic Comments component instead'),\r\n  generateNextSystemId: () => {\r\n    // Generate next systemId using same pattern as createCrudStore\r\n    const maxSystemId = baseStore.getState().data.reduce((max, item) => {\r\n      const match = item.systemId.match(/WARRANTY(\\d{6})/);\r\n      return match ? Math.max(max, parseInt(match[1])) : max;\r\n    }, 0);\r\n    return asSystemId(`WARRANTY${String(maxSystemId + 1).padStart(6, '0')}`);\r\n  },\r\n  _migrate: () => console.warn('_migrate: No longer needed with createCrudStore'),\r\n}));\r\n\r\n// Subscribe to base store changes\r\nbaseStore.subscribe((state) => {\r\n  useWarrantyStore.setState(state as any);\r\n});\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 3523, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/warranty/store.ts"],"sourcesContent":["export { useWarrantyStore } from './store/index';\r\n"],"names":[],"mappings":";AAAA"}},
    {"offset": {"line": 3530, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/warranty/components/dialogs/warranty-cancel-dialog.tsx"],"sourcesContent":["/**\r\n * Cancel Warranty Dialog\r\n * Dialog để hủy phiếu bảo hành với lý do\r\n */\r\n\r\nimport * as React from 'react';\r\nimport { toast } from 'sonner';\r\nimport {\r\n  AlertDialog,\r\n  AlertDialogAction,\r\n  AlertDialogCancel,\r\n  AlertDialogContent,\r\n  AlertDialogDescription,\r\n  AlertDialogFooter,\r\n  AlertDialogHeader,\r\n  AlertDialogTitle,\r\n} from '../../../../components/ui/alert-dialog';\r\nimport { Textarea } from '../../../../components/ui/textarea';\r\nimport type { WarrantyTicket, WarrantyHistory } from '../../types';\r\nimport { useWarrantyStore } from '../../store';\r\nimport { usePaymentStore } from '../../../payments/store';\r\nimport { asSystemId } from '@/lib/id-types';\r\nimport { useReceiptStore } from '../../../receipts/store';\r\nimport { useOrderStore } from '../../../orders/store';\r\nimport { useAuth } from '../../../../contexts/auth-context';\r\nimport { toISODateTime, getCurrentDate } from '../../../../lib/date-utils';\r\n\r\ninterface WarrantyCancelDialogProps {\r\n  open: boolean;\r\n  onOpenChange: (open: boolean) => void;\r\n  ticket: WarrantyTicket | null;\r\n  onCancelled?: (ticket: WarrantyTicket) => void;\r\n}\r\n\r\nexport function WarrantyCancelDialog({ open, onOpenChange, ticket, onCancelled }: WarrantyCancelDialogProps) {\r\n  const [cancelReason, setCancelReason] = React.useState('');\r\n  const { user: currentUser } = useAuth();\r\n  const { update, findById, addHistory } = useWarrantyStore();\r\n  const payments = usePaymentStore(state => state.data);\r\n  const receipts = useReceiptStore(state => state.data);\r\n  const { data: orders } = useOrderStore();\r\n\r\n  const handleCancel = React.useCallback(async () => {\r\n    console.log('[CANCEL DIALOG] handleCancel called', { \r\n      hasTicket: !!ticket, \r\n      cancelReason,\r\n      ticketId: ticket?.id \r\n    });\r\n    \r\n    if (!currentUser) {\r\n      toast.error('Vui lòng đăng nhập');\r\n      return;\r\n    }\r\n\r\n    if (!ticket || !cancelReason.trim()) {\r\n      toast.error('Vui lòng nhập lý do hủy phiếu');\r\n      return;\r\n    }\r\n\r\n    try {\r\n      const timestamp = toISODateTime(getCurrentDate());\r\n      // ✅ ROLLBACK KHO khi hủy - Phân biệt theo trạng thái\r\n      const { rollbackWarrantyStock, uncommitWarrantyStock } = await import('../../store/stock-management');\r\n      \r\n      // Check nếu đã xuất kho (completed hoặc returned sau khi completed)\r\n      const hasDeductedStock = ticket.stockDeducted || ticket.status === 'completed';\r\n      \r\n      if (hasDeductedStock) {\r\n        // Đã xuất kho → Hoàn hàng về kho\r\n        rollbackWarrantyStock(ticket);\r\n        console.log('[CANCEL DIALOG] Rollback completed/returned warranty (restore stock):', {\r\n          status: ticket.status,\r\n          ticketId: ticket.id,\r\n          stockDeducted: ticket.stockDeducted,\r\n          products: ticket.products.filter(p => p.resolution === 'replace').length\r\n        });\r\n      } else if (ticket.status === 'pending' || ticket.status === 'processed') {\r\n        // Chưa xuất kho, chỉ uncommit (giải phóng hàng giữ chỗ)\r\n        uncommitWarrantyStock(ticket);\r\n        console.log('[CANCEL DIALOG] Uncommit pending/processing warranty:', {\r\n          status: ticket.status,\r\n          ticketId: ticket.id\r\n        });\r\n      } else if (ticket.status === 'returned') {\r\n        // Đã trả hàng nhưng chưa kết thúc → vẫn đang giữ hàng thay thế\r\n        uncommitWarrantyStock(ticket);\r\n        console.log('[CANCEL DIALOG] Uncommit returned warranty:', {\r\n          status: ticket.status,\r\n          ticketId: ticket.id\r\n        });\r\n      }\r\n      // incomplete: không làm gì cả (chưa commit)\r\n      \r\n      // CANCEL ALL PAYMENT & RECEIPT VOUCHERS linked to this warranty\r\n      const relatedPayments = payments.filter(p => \r\n        p.linkedWarrantySystemId === ticket.systemId && \r\n        p.status !== 'cancelled'\r\n      );\r\n      const relatedReceipts = receipts.filter(r => \r\n        r.linkedWarrantySystemId === ticket.systemId && \r\n        r.status !== 'cancelled'\r\n      );\r\n      \r\n      console.log('[CANCEL DIALOG] Found transactions:', {\r\n        payments: relatedPayments.length,\r\n        receipts: relatedReceipts.length,\r\n        paymentIds: relatedPayments.map(p => p.id),\r\n        receiptIds: relatedReceipts.map(r => r.id)\r\n      });\r\n      \r\n      const allVouchers = [...relatedPayments, ...relatedReceipts];\r\n      \r\n      if (allVouchers.length > 0) {\r\n        const paymentStore = usePaymentStore.getState();\r\n        const receiptStore = useReceiptStore.getState();\r\n        const orderStore = useOrderStore.getState();\r\n        \r\n        const cancelledCount = { payments: 0, receipts: 0 };\r\n        \r\n        // Soft delete payments - update status to 'cancelled' + save cancelReason in description\r\n        relatedPayments.forEach(payment => {\r\n          const newDescription = `[HỦY] ${cancelReason}${payment.description ? ` | Gốc: ${payment.description}` : ''}`;\r\n          console.log('[CANCEL DIALOG] Saving payment with description:', {\r\n            paymentId: payment.id,\r\n            originalDesc: payment.description,\r\n            newDescription,\r\n            cancelReason\r\n          });\r\n          \r\n          paymentStore.update(payment.systemId as any, {\r\n            ...payment,\r\n            status: 'cancelled',\r\n            cancelledAt: timestamp,\r\n            description: newDescription,\r\n          });\r\n          cancelledCount.payments++;\r\n          console.log('[WARRANTY CANCEL] Cancelled payment:', payment.id);\r\n          \r\n          // ✅ UPDATE ORDER: Remove payment from order.payments and decrease paidAmount\r\n          if (payment.linkedOrderSystemId) {\r\n            const order = orders.find(o => o.systemId === payment.linkedOrderSystemId);\r\n            if (order) {\r\n              // Remove this payment from order.payments array\r\n              const updatedPayments = order.payments.filter(p => p.systemId !== payment.systemId);\r\n              \r\n              // Decrease paidAmount (payment.amount is negative, so we subtract it back)\r\n              const newPaidAmount = (order.paidAmount || 0) - Math.abs(payment.amount);\r\n              \r\n              console.log('[WARRANTY CANCEL] Updating order:', {\r\n                orderId: order.id,\r\n                oldPaidAmount: order.paidAmount,\r\n                newPaidAmount,\r\n                removedPayment: payment.id\r\n              });\r\n              \r\n              orderStore.update(payment.linkedOrderSystemId, {\r\n                payments: updatedPayments,\r\n                paidAmount: Math.max(0, newPaidAmount), // Ensure not negative\r\n              });\r\n            }\r\n          }\r\n        });\r\n        \r\n        // Soft delete receipts - update status to 'cancelled' + save cancelReason in description\r\n        relatedReceipts.forEach(receipt => {\r\n          receiptStore.update(receipt.systemId as any, {\r\n            ...receipt,\r\n            status: 'cancelled',\r\n            cancelledAt: timestamp,\r\n            description: `[HỦY] ${cancelReason}${receipt.description ? ` | Gốc: ${receipt.description}` : ''}`,\r\n          });\r\n          cancelledCount.receipts++;\r\n          console.log('[WARRANTY CANCEL] Cancelled receipt:', receipt.id);\r\n        });\r\n        \r\n        const voucherList = allVouchers.map(v => `${v.id} (${v.amount.toLocaleString('vi-VN')}đ)`).join(', ');\r\n        \r\n        toast.warning(`Đã hủy ${cancelledCount.payments} phiếu chi và ${cancelledCount.receipts} phiếu thu`, {\r\n          description: voucherList,\r\n          duration: 5000\r\n        });\r\n        \r\n        addHistory(\r\n          ticket.systemId,\r\n          `🗑️ Hủy ${allVouchers.length} phiếu thu/chi (${cancelledCount.payments} phiếu chi, ${cancelledCount.receipts} phiếu thu)`,\r\n          currentUser.name,\r\n          `Danh sách: ${voucherList}`\r\n        );\r\n      }\r\n      \r\n      // Update warranty ticket status to 'cancelled'\r\n      const latestTicket = findById(ticket.systemId);\r\n      if (!latestTicket) {\r\n        toast.error('Không tìm thấy phiếu');\r\n        return;\r\n      }\r\n\r\n      const newHistory: WarrantyHistory = {\r\n        systemId: asSystemId(`history_${Date.now()}`),\r\n        action: 'Hủy phiếu bảo hành',\r\n        actionLabel: 'Đã hủy phiếu',\r\n        entityType: 'status',\r\n        performedBy: currentUser.name,\r\n        performedAt: timestamp,\r\n        note: `Lý do: ${cancelReason}`,\r\n      };\r\n\r\n      const updatedTicket: WarrantyTicket = {\r\n        ...latestTicket,\r\n        status: 'cancelled',\r\n        cancelledAt: timestamp,\r\n        cancelReason,\r\n        linkedOrderSystemId: undefined,\r\n        stockDeducted: false,\r\n        history: [...latestTicket.history, newHistory],\r\n      };\r\n\r\n      update(ticket.systemId, updatedTicket);\r\n      onCancelled?.(updatedTicket);\r\n      \r\n      onOpenChange(false);\r\n      setCancelReason('');\r\n      toast.success('Đã hủy phiếu bảo hành');\r\n    } catch (error) {\r\n      console.error('Failed to cancel ticket:', error);\r\n      toast.error('Không thể hủy phiếu');\r\n    }\r\n  }, [ticket, cancelReason, update, currentUser, findById, payments, receipts, addHistory, onOpenChange, orders]);\r\n\r\n  return (\r\n    <AlertDialog open={open} onOpenChange={onOpenChange}>\r\n      <AlertDialogContent>\r\n        <AlertDialogHeader>\r\n          <AlertDialogTitle>Xác nhận hủy phiếu bảo hành</AlertDialogTitle>\r\n          <AlertDialogDescription>\r\n            Bạn có chắc chắn muốn hủy phiếu bảo hành này? Vui lòng nhập lý do hủy.\r\n          </AlertDialogDescription>\r\n        </AlertDialogHeader>\r\n        <Textarea\r\n          value={cancelReason}\r\n          onChange={(e) => setCancelReason(e.target.value)}\r\n          placeholder=\"Nhập lý do hủy phiếu (bắt buộc)...\"\r\n          className=\"min-h-[100px]\"\r\n        />\r\n        <AlertDialogFooter>\r\n          <AlertDialogCancel onClick={() => setCancelReason('')}>Hủy</AlertDialogCancel>\r\n          <AlertDialogAction\r\n            onClick={handleCancel}\r\n            className=\"bg-destructive hover:bg-destructive/90\"\r\n          >\r\n            Hủy phiếu\r\n          </AlertDialogAction>\r\n        </AlertDialogFooter>\r\n      </AlertDialogContent>\r\n    </AlertDialog>\r\n  );\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 3817, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/warranty/components/logic/processing.ts"],"sourcesContent":["/**\r\n * Warranty Processing Logic\r\n * Gom toàn bộ tính toán/payment state cho module warranty\r\n */\r\n\r\nimport type { WarrantyTicket } from '../../types';\r\nimport type { Payment } from '../../../payments/types';\r\nimport type { Receipt } from '../../../receipts/types';\r\n\r\n// ============================================================\r\n// TYPES\r\n// ============================================================\r\n\r\nexport interface WarrantyProcessingState {\r\n\tticket: WarrantyTicket | null;\r\n\tpayments: Payment[];\r\n\treceipts: Receipt[];\r\n\ttotalPayment: number;\r\n\twarrantyPayments: Payment[];\r\n\twarrantyReceipts: Receipt[];\r\n\ttotalPaid: number;\r\n\tremainingAmount: number;\r\n\thasTransactions: boolean;\r\n\tallTransactionsCancelled: boolean;\r\n\tshouldHideCard: boolean;\r\n\tcanShowActionButtons: boolean;\r\n\tcanShowPaymentButton: boolean;\r\n\tcanShowReceiptButton: boolean;\r\n}\r\n\r\n// ============================================================\r\n// HELPER FUNCTIONS\r\n// ============================================================\r\n\r\nexport function getWarrantyPayments(payments: Payment[], warrantySystemId: string): Payment[] {\r\n\treturn payments\r\n\t\t.filter(p => p.linkedWarrantySystemId === warrantySystemId && p.status !== 'cancelled')\r\n\t\t.sort((a, b) => new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime());\r\n}\r\n\r\nexport function getWarrantyReceipts(receipts: Receipt[], warrantySystemId: string): Receipt[] {\r\n\treturn receipts\r\n\t\t.filter(r => (r as any).linkedWarrantySystemId === warrantySystemId && r.status !== 'cancelled')\r\n\t\t.sort((a, b) => new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime());\r\n}\r\n\r\nexport function calculateTotalPaid(\r\n\tpayments: Payment[],\r\n\treceipts: Receipt[],\r\n): { totalPayments: number; totalReceipts: number } {\r\n\tconst totalPayments = payments\r\n\t\t.filter(p => p.status !== 'cancelled')\r\n\t\t.reduce((sum, p) => sum + p.amount, 0);\r\n\r\n\tconst totalReceipts = receipts\r\n\t\t.filter(r => r.status !== 'cancelled')\r\n\t\t.reduce((sum, r) => sum + r.amount, 0);\r\n\r\n\treturn { totalPayments, totalReceipts };\r\n}\r\n\r\nexport function hasAnyTransactions(payments: Payment[], receipts: Receipt[]): boolean {\r\n\treturn payments.length > 0 || receipts.length > 0;\r\n}\r\n\r\nexport function areAllTransactionsCancelled(payments: Payment[], receipts: Receipt[]): boolean {\r\n\tconst allTransactions = [...payments, ...receipts];\r\n\treturn allTransactions.length > 0 && allTransactions.every(t => t.status === 'cancelled');\r\n}\r\n\r\n// ============================================================\r\n// MAIN LOGIC - ĐIỀU KIỆN HIỂN THỊ\r\n// ============================================================\r\n\r\nexport function shouldHideCard(ticket: WarrantyTicket | null, hasTransactions: boolean): boolean {\r\n\tif (!ticket) return true;\r\n\r\n\treturn !hasTransactions &&\r\n\t\t(ticket.status === 'incomplete' || ticket.status === 'pending' || !!ticket.cancelledAt);\r\n}\r\n\r\nexport function canShowActionButtons(\r\n\tticket: WarrantyTicket | null,\r\n\ttotalPayment: number,\r\n\tremainingAmount: number,\r\n\thasTransactions: boolean,\r\n\tallTransactionsCancelled: boolean,\r\n): boolean {\r\n\tif (!ticket) return false;\r\n\r\n\tconst notCancelled = !ticket.cancelledAt;\r\n\tconst hasPaymentNeeded = totalPayment !== 0;\r\n\tconst hasRemainingAmount = remainingAmount > 0;\r\n\r\n\tconst isInProcessingStage =\r\n\t\tticket.status === 'processed' ||\r\n\t\tticket.status === 'returned' ||\r\n\t\tticket.status === 'completed';\r\n\r\n\tconst hasExistingTransactions = hasTransactions;\r\n\r\n\treturn (\r\n\t\tnotCancelled &&\r\n\t\thasPaymentNeeded &&\r\n\t\thasRemainingAmount &&\r\n\t\t(isInProcessingStage || hasExistingTransactions)\r\n\t);\r\n}\r\n\r\nexport function canShowPaymentButton(canShowActions: boolean, totalPayment: number): boolean {\r\n\treturn canShowActions && totalPayment > 0;\r\n}\r\n\r\nexport function canShowReceiptButton(canShowActions: boolean, totalPayment: number): boolean {\r\n\treturn canShowActions && totalPayment < 0;\r\n}\r\n\r\n// ============================================================\r\n// ALL-IN-ONE CALCULATOR\r\n// ============================================================\r\n\r\nexport function calculateWarrantyProcessingState(\r\n\tticket: WarrantyTicket | null,\r\n\tpayments: Payment[],\r\n\treceipts: Receipt[],\r\n\ttotalPayment: number,\r\n): WarrantyProcessingState {\r\n\tif (!ticket) {\r\n\t\treturn {\r\n\t\t\tticket: null,\r\n\t\t\tpayments: [],\r\n\t\t\treceipts: [],\r\n\t\t\ttotalPayment: 0,\r\n\t\t\twarrantyPayments: [],\r\n\t\t\twarrantyReceipts: [],\r\n\t\t\ttotalPaid: 0,\r\n\t\t\tremainingAmount: 0,\r\n\t\t\thasTransactions: false,\r\n\t\t\tallTransactionsCancelled: false,\r\n\t\t\tshouldHideCard: true,\r\n\t\t\tcanShowActionButtons: false,\r\n\t\t\tcanShowPaymentButton: false,\r\n\t\t\tcanShowReceiptButton: false,\r\n\t\t};\r\n\t}\r\n\r\n\tconst warrantyPayments = getWarrantyPayments(payments, ticket.systemId);\r\n\tconst warrantyReceipts = getWarrantyReceipts(receipts, ticket.systemId);\r\n\r\n\tconst { totalPayments, totalReceipts } = calculateTotalPaid(warrantyPayments, warrantyReceipts);\r\n\r\n\tlet remainingAmount = 0;\r\n\tif (totalPayment > 0) {\r\n\t\tremainingAmount = totalPayment - totalPayments;\r\n\t} else if (totalPayment < 0) {\r\n\t\tremainingAmount = Math.abs(totalPayment) - totalReceipts;\r\n\t}\r\n\r\n\tconst totalPaid = totalReceipts - totalPayments;\r\n\tconst hasTransactions = hasAnyTransactions(warrantyPayments, warrantyReceipts);\r\n\tconst allTransactionsCancelled = areAllTransactionsCancelled(warrantyPayments, warrantyReceipts);\r\n\r\n\tconst hideCard = shouldHideCard(ticket, hasTransactions);\r\n\tconst showActionButtons = canShowActionButtons(\r\n\t\tticket,\r\n\t\ttotalPayment,\r\n\t\tremainingAmount,\r\n\t\thasTransactions,\r\n\t\tallTransactionsCancelled,\r\n\t);\r\n\tconst showPaymentButton = canShowPaymentButton(showActionButtons, totalPayment);\r\n\tconst showReceiptButton = canShowReceiptButton(showActionButtons, totalPayment);\r\n\r\n\treturn {\r\n\t\tticket,\r\n\t\tpayments,\r\n\t\treceipts,\r\n\t\ttotalPayment,\r\n\t\twarrantyPayments,\r\n\t\twarrantyReceipts,\r\n\t\ttotalPaid,\r\n\t\tremainingAmount,\r\n\t\thasTransactions,\r\n\t\tallTransactionsCancelled,\r\n\t\tshouldHideCard: hideCard,\r\n\t\tcanShowActionButtons: showActionButtons,\r\n\t\tcanShowPaymentButton: showPaymentButton,\r\n\t\tcanShowReceiptButton: showReceiptButton,\r\n\t};\r\n}\r\n\r\n// ============================================================\r\n// DEBUG HELPERS\r\n// ============================================================\r\n\r\nexport function debugWarrantyProcessing(state: WarrantyProcessingState): void {\r\n\tconsole.group('[WARRANTY PROCESSING] Debug State');\r\n\r\n\tconsole.log('Input:', {\r\n\t\tticketId: state.ticket?.id,\r\n\t\tticketStatus: state.ticket?.status,\r\n\t\tcancelledAt: state.ticket?.cancelledAt,\r\n\t\ttotalPayment: state.totalPayment,\r\n\t});\r\n\r\n\tconsole.log('Calculations:', {\r\n\t\twarrantyPayments: state.warrantyPayments.length,\r\n\t\twarrantyReceipts: state.warrantyReceipts.length,\r\n\t\ttotalPaid: state.totalPaid,\r\n\t\tremainingAmount: state.remainingAmount,\r\n\t\thasTransactions: state.hasTransactions,\r\n\t\tallCancelled: state.allTransactionsCancelled,\r\n\t});\r\n\r\n\tconsole.log('Display Flags:', {\r\n\t\tshouldHideCard: state.shouldHideCard,\r\n\t\tcanShowActionButtons: state.canShowActionButtons,\r\n\t\tcanShowPaymentButton: state.canShowPaymentButton,\r\n\t\tcanShowReceiptButton: state.canShowReceiptButton,\r\n\t});\r\n\r\n\tconsole.groupEnd();\r\n}"],"names":[],"mappings":"AAAA;;;CAGC;;;;;;;;;;;;;;;;;;;;;;;;AA+BM,SAAS,oBAAoB,QAAmB,EAAE,gBAAwB;IAChF,OAAO,SACL,MAAM,CAAC,CAAA,IAAK,EAAE,sBAAsB,KAAK,oBAAoB,EAAE,MAAM,KAAK,aAC1E,IAAI,CAAC,CAAC,GAAG,IAAM,IAAI,KAAK,EAAE,SAAS,EAAE,OAAO,KAAK,IAAI,KAAK,EAAE,SAAS,EAAE,OAAO;AACjF;AAEO,SAAS,oBAAoB,QAAmB,EAAE,gBAAwB;IAChF,OAAO,SACL,MAAM,CAAC,CAAA,IAAK,AAAC,EAAU,sBAAsB,KAAK,oBAAoB,EAAE,MAAM,KAAK,aACnF,IAAI,CAAC,CAAC,GAAG,IAAM,IAAI,KAAK,EAAE,SAAS,EAAE,OAAO,KAAK,IAAI,KAAK,EAAE,SAAS,EAAE,OAAO;AACjF;AAEO,SAAS,mBACf,QAAmB,EACnB,QAAmB;IAEnB,MAAM,gBAAgB,SACpB,MAAM,CAAC,CAAA,IAAK,EAAE,MAAM,KAAK,aACzB,MAAM,CAAC,CAAC,KAAK,IAAM,MAAM,EAAE,MAAM,EAAE;IAErC,MAAM,gBAAgB,SACpB,MAAM,CAAC,CAAA,IAAK,EAAE,MAAM,KAAK,aACzB,MAAM,CAAC,CAAC,KAAK,IAAM,MAAM,EAAE,MAAM,EAAE;IAErC,OAAO;QAAE;QAAe;IAAc;AACvC;AAEO,SAAS,mBAAmB,QAAmB,EAAE,QAAmB;IAC1E,OAAO,SAAS,MAAM,GAAG,KAAK,SAAS,MAAM,GAAG;AACjD;AAEO,SAAS,4BAA4B,QAAmB,EAAE,QAAmB;IACnF,MAAM,kBAAkB;WAAI;WAAa;KAAS;IAClD,OAAO,gBAAgB,MAAM,GAAG,KAAK,gBAAgB,KAAK,CAAC,CAAA,IAAK,EAAE,MAAM,KAAK;AAC9E;AAMO,SAAS,eAAe,MAA6B,EAAE,eAAwB;IACrF,IAAI,CAAC,QAAQ,OAAO;IAEpB,OAAO,CAAC,mBACP,CAAC,OAAO,MAAM,KAAK,gBAAgB,OAAO,MAAM,KAAK,aAAa,CAAC,CAAC,OAAO,WAAW;AACxF;AAEO,SAAS,qBACf,MAA6B,EAC7B,YAAoB,EACpB,eAAuB,EACvB,eAAwB,EACxB,wBAAiC;IAEjC,IAAI,CAAC,QAAQ,OAAO;IAEpB,MAAM,eAAe,CAAC,OAAO,WAAW;IACxC,MAAM,mBAAmB,iBAAiB;IAC1C,MAAM,qBAAqB,kBAAkB;IAE7C,MAAM,sBACL,OAAO,MAAM,KAAK,eAClB,OAAO,MAAM,KAAK,cAClB,OAAO,MAAM,KAAK;IAEnB,MAAM,0BAA0B;IAEhC,OACC,gBACA,oBACA,sBACA,CAAC,uBAAuB,uBAAuB;AAEjD;AAEO,SAAS,qBAAqB,cAAuB,EAAE,YAAoB;IACjF,OAAO,kBAAkB,eAAe;AACzC;AAEO,SAAS,qBAAqB,cAAuB,EAAE,YAAoB;IACjF,OAAO,kBAAkB,eAAe;AACzC;AAMO,SAAS,iCACf,MAA6B,EAC7B,QAAmB,EACnB,QAAmB,EACnB,YAAoB;IAEpB,IAAI,CAAC,QAAQ;QACZ,OAAO;YACN,QAAQ;YACR,UAAU,EAAE;YACZ,UAAU,EAAE;YACZ,cAAc;YACd,kBAAkB,EAAE;YACpB,kBAAkB,EAAE;YACpB,WAAW;YACX,iBAAiB;YACjB,iBAAiB;YACjB,0BAA0B;YAC1B,gBAAgB;YAChB,sBAAsB;YACtB,sBAAsB;YACtB,sBAAsB;QACvB;IACD;IAEA,MAAM,mBAAmB,oBAAoB,UAAU,OAAO,QAAQ;IACtE,MAAM,mBAAmB,oBAAoB,UAAU,OAAO,QAAQ;IAEtE,MAAM,EAAE,aAAa,EAAE,aAAa,EAAE,GAAG,mBAAmB,kBAAkB;IAE9E,IAAI,kBAAkB;IACtB,IAAI,eAAe,GAAG;QACrB,kBAAkB,eAAe;IAClC,OAAO,IAAI,eAAe,GAAG;QAC5B,kBAAkB,KAAK,GAAG,CAAC,gBAAgB;IAC5C;IAEA,MAAM,YAAY,gBAAgB;IAClC,MAAM,kBAAkB,mBAAmB,kBAAkB;IAC7D,MAAM,2BAA2B,4BAA4B,kBAAkB;IAE/E,MAAM,WAAW,eAAe,QAAQ;IACxC,MAAM,oBAAoB,qBACzB,QACA,cACA,iBACA,iBACA;IAED,MAAM,oBAAoB,qBAAqB,mBAAmB;IAClE,MAAM,oBAAoB,qBAAqB,mBAAmB;IAElE,OAAO;QACN;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA,gBAAgB;QAChB,sBAAsB;QACtB,sBAAsB;QACtB,sBAAsB;IACvB;AACD;AAMO,SAAS,wBAAwB,KAA8B;IACrE,QAAQ,KAAK,CAAC;IAEd,QAAQ,GAAG,CAAC,UAAU;QACrB,UAAU,MAAM,MAAM,EAAE;QACxB,cAAc,MAAM,MAAM,EAAE;QAC5B,aAAa,MAAM,MAAM,EAAE;QAC3B,cAAc,MAAM,YAAY;IACjC;IAEA,QAAQ,GAAG,CAAC,iBAAiB;QAC5B,kBAAkB,MAAM,gBAAgB,CAAC,MAAM;QAC/C,kBAAkB,MAAM,gBAAgB,CAAC,MAAM;QAC/C,WAAW,MAAM,SAAS;QAC1B,iBAAiB,MAAM,eAAe;QACtC,iBAAiB,MAAM,eAAe;QACtC,cAAc,MAAM,wBAAwB;IAC7C;IAEA,QAAQ,GAAG,CAAC,kBAAkB;QAC7B,gBAAgB,MAAM,cAAc;QACpC,sBAAsB,MAAM,oBAAoB;QAChD,sBAAsB,MAAM,oBAAoB;QAChD,sBAAsB,MAAM,oBAAoB;IACjD;IAEA,QAAQ,QAAQ;AACjB"}},
    {"offset": {"line": 3967, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/warranty/components/dialogs/insufficient-balance-dialog.tsx"],"sourcesContent":["import * as React from 'react';\r\nimport {\r\n  Dialog,\r\n  DialogContent,\r\n  DialogDescription,\r\n  DialogFooter,\r\n  DialogHeader,\r\n  DialogTitle,\r\n} from '../../../../components/ui/dialog';\r\nimport { Alert, AlertDescription } from '../../../../components/ui/alert';\r\nimport { Button } from '../../../../components/ui/button';\r\nimport { Badge } from '../../../../components/ui/badge';\r\n\r\ninterface InsufficientBalanceDialogProps {\r\n  open: boolean;\r\n  onOpenChange: (open: boolean) => void;\r\n  totalAmount: number;\r\n  orderAmount: number;\r\n  shortageAmount: number;\r\n  orderLabel?: string | undefined;\r\n  onSelectMixed: () => void;\r\n  onSelectCashOnly: () => void;\r\n}\r\n\r\nexport function InsufficientBalanceDialog({\r\n  open,\r\n  onOpenChange,\r\n  totalAmount,\r\n  orderAmount,\r\n  shortageAmount,\r\n  orderLabel,\r\n  onSelectMixed,\r\n  onSelectCashOnly,\r\n}: InsufficientBalanceDialogProps) {\r\n  const formatCurrency = React.useCallback((value: number) => {\r\n    return value.toLocaleString('vi-VN');\r\n  }, []);\r\n\r\n  const recommendedOrderAmount = Math.min(orderAmount, totalAmount);\r\n  const recommendedCashAmount = Math.max(shortageAmount, 0);\r\n\r\n  return (\r\n    <Dialog open={open} onOpenChange={onOpenChange}>\r\n      <DialogContent className=\"max-w-2xl\">\r\n        <DialogHeader>\r\n          <DialogTitle>Xử lý khi đơn không đủ để bù trừ</DialogTitle>\r\n          <DialogDescription>\r\n            Đơn {orderLabel ?? 'đã chọn'} không đủ để bù trừ toàn bộ số tiền bảo hành. Chọn phương án phù hợp bên dưới.\r\n          </DialogDescription>\r\n        </DialogHeader>\r\n\r\n        <div className=\"space-y-4\">\r\n          <Alert>\r\n            <AlertDescription className=\"space-y-1 text-sm\">\r\n              <div>Số tiền cần hoàn: <strong>{formatCurrency(totalAmount)} đ</strong></div>\r\n              <div>Đơn {orderLabel ?? ''} còn lại: <strong>{formatCurrency(orderAmount)} đ</strong></div>\r\n              <div>Thiếu: <strong className=\"text-red-600\">{formatCurrency(shortageAmount)} đ</strong></div>\r\n            </AlertDescription>\r\n          </Alert>\r\n\r\n          <div className=\"grid gap-3 md:grid-cols-2\">\r\n            <div className=\"rounded-lg border border-border p-4\">\r\n              <div className=\"flex items-start justify-between gap-3\">\r\n                <div>\r\n                  <p className=\"font-semibold\">Bù trừ đơn + Chi tiền mặt</p>\r\n                  <p className=\"text-sm text-muted-foreground\">Trừ tối đa vào đơn, phần thiếu chi trực tiếp.</p>\r\n                </div>\r\n                <Badge variant=\"secondary\">Khuyến nghị</Badge>\r\n              </div>\r\n              <ul className=\"mt-3 space-y-1 text-sm text-muted-foreground\">\r\n                <li>Trừ vào đơn: <strong>{formatCurrency(recommendedOrderAmount)} đ</strong></li>\r\n                <li>Chi trực tiếp: <strong>{formatCurrency(recommendedCashAmount)} đ</strong></li>\r\n              </ul>\r\n              <Button className=\"mt-4 w-full\" onClick={onSelectMixed}>\r\n                Áp dụng phương án này\r\n              </Button>\r\n            </div>\r\n\r\n            <div className=\"rounded-lg border border-border p-4\">\r\n              <div className=\"flex items-start justify-between gap-3\">\r\n                <div>\r\n                  <p className=\"font-semibold\">Chỉ chi tiền mặt</p>\r\n                  <p className=\"text-sm text-muted-foreground\">Không trừ vào đơn, chi toàn bộ cho khách.</p>\r\n                </div>\r\n              </div>\r\n              <ul className=\"mt-3 space-y-1 text-sm text-muted-foreground\">\r\n                <li>Trừ vào đơn: <strong>0 đ</strong></li>\r\n                <li>Chi trực tiếp: <strong>{formatCurrency(totalAmount)} đ</strong></li>\r\n              </ul>\r\n              <Button variant=\"outline\" className=\"mt-4 w-full\" onClick={onSelectCashOnly}>\r\n                Chuyển sang chi tiền trực tiếp\r\n              </Button>\r\n            </div>\r\n          </div>\r\n        </div>\r\n\r\n        <DialogFooter>\r\n          <Button variant=\"ghost\" onClick={() => onOpenChange(false)}>\r\n            Đóng\r\n          </Button>\r\n        </DialogFooter>\r\n      </DialogContent>\r\n    </Dialog>\r\n  );\r\n}\r\n"],"names":[],"mappings":";;;;;AAAA;AACA;AAQA;AACA;AACA;;;;;;;AAaO,SAAS,0BAA0B,EACxC,IAAI,EACJ,YAAY,EACZ,WAAW,EACX,WAAW,EACX,cAAc,EACd,UAAU,EACV,aAAa,EACb,gBAAgB,EACe;IAC/B,MAAM,iBAAiB,oNAAiB,CAAC,CAAC;QACxC,OAAO,MAAM,cAAc,CAAC;IAC9B,GAAG,EAAE;IAEL,MAAM,yBAAyB,KAAK,GAAG,CAAC,aAAa;IACrD,MAAM,wBAAwB,KAAK,GAAG,CAAC,gBAAgB;IAEvD,qBACE,8OAAC,qIAAM;QAAC,MAAM;QAAM,cAAc;kBAChC,cAAA,8OAAC,4IAAa;YAAC,WAAU;;8BACvB,8OAAC,2IAAY;;sCACX,8OAAC,0IAAW;sCAAC;;;;;;sCACb,8OAAC,gJAAiB;;gCAAC;gCACZ,cAAc;gCAAU;;;;;;;;;;;;;8BAIjC,8OAAC;oBAAI,WAAU;;sCACb,8OAAC,mIAAK;sCACJ,cAAA,8OAAC,8IAAgB;gCAAC,WAAU;;kDAC1B,8OAAC;;4CAAI;0DAAkB,8OAAC;;oDAAQ,eAAe;oDAAa;;;;;;;;;;;;;kDAC5D,8OAAC;;4CAAI;4CAAK,cAAc;4CAAG;0DAAU,8OAAC;;oDAAQ,eAAe;oDAAa;;;;;;;;;;;;;kDAC1E,8OAAC;;4CAAI;0DAAO,8OAAC;gDAAO,WAAU;;oDAAgB,eAAe;oDAAgB;;;;;;;;;;;;;;;;;;;;;;;;sCAIjF,8OAAC;4BAAI,WAAU;;8CACb,8OAAC;oCAAI,WAAU;;sDACb,8OAAC;4CAAI,WAAU;;8DACb,8OAAC;;sEACC,8OAAC;4DAAE,WAAU;sEAAgB;;;;;;sEAC7B,8OAAC;4DAAE,WAAU;sEAAgC;;;;;;;;;;;;8DAE/C,8OAAC,mIAAK;oDAAC,SAAQ;8DAAY;;;;;;;;;;;;sDAE7B,8OAAC;4CAAG,WAAU;;8DACZ,8OAAC;;wDAAG;sEAAa,8OAAC;;gEAAQ,eAAe;gEAAwB;;;;;;;;;;;;;8DACjE,8OAAC;;wDAAG;sEAAe,8OAAC;;gEAAQ,eAAe;gEAAuB;;;;;;;;;;;;;;;;;;;sDAEpE,8OAAC,qIAAM;4CAAC,WAAU;4CAAc,SAAS;sDAAe;;;;;;;;;;;;8CAK1D,8OAAC;oCAAI,WAAU;;sDACb,8OAAC;4CAAI,WAAU;sDACb,cAAA,8OAAC;;kEACC,8OAAC;wDAAE,WAAU;kEAAgB;;;;;;kEAC7B,8OAAC;wDAAE,WAAU;kEAAgC;;;;;;;;;;;;;;;;;sDAGjD,8OAAC;4CAAG,WAAU;;8DACZ,8OAAC;;wDAAG;sEAAa,8OAAC;sEAAO;;;;;;;;;;;;8DACzB,8OAAC;;wDAAG;sEAAe,8OAAC;;gEAAQ,eAAe;gEAAa;;;;;;;;;;;;;;;;;;;sDAE1D,8OAAC,qIAAM;4CAAC,SAAQ;4CAAU,WAAU;4CAAc,SAAS;sDAAkB;;;;;;;;;;;;;;;;;;;;;;;;8BAOnF,8OAAC,2IAAY;8BACX,cAAA,8OAAC,qIAAM;wBAAC,SAAQ;wBAAQ,SAAS,IAAM,aAAa;kCAAQ;;;;;;;;;;;;;;;;;;;;;;AAOtE"}},
    {"offset": {"line": 4345, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/warranty/utils/payment-calculations.ts"],"sourcesContent":["import type { WarrantyTicket } from '../types';\r\n\r\nconst MONEY_RESOLUTIONS = new Set(['out_of_stock']);\r\n\r\nexport function calculateWarrantySettlementTotal(ticket?: WarrantyTicket | null) {\r\n  if (!ticket) {\r\n    return 0;\r\n  }\r\n\r\n  const productCompensation = (ticket.products || []).reduce((sum, product) => {\r\n    if (!product) {\r\n      return sum;\r\n    }\r\n\r\n    if (MONEY_RESOLUTIONS.has(product.resolution as string)) {\r\n      const quantity = product.quantity ?? 0;\r\n      const unitPrice = product.unitPrice ?? 0;\r\n      return sum + quantity * unitPrice;\r\n    }\r\n\r\n    return sum;\r\n  }, 0);\r\n\r\n  return productCompensation + (ticket.shippingFee ?? 0);\r\n}\r\n"],"names":[],"mappings":";;;;AAEA,MAAM,oBAAoB,IAAI,IAAI;IAAC;CAAe;AAE3C,SAAS,iCAAiC,MAA8B;IAC7E,IAAI,CAAC,QAAQ;QACX,OAAO;IACT;IAEA,MAAM,sBAAsB,CAAC,OAAO,QAAQ,IAAI,EAAE,EAAE,MAAM,CAAC,CAAC,KAAK;QAC/D,IAAI,CAAC,SAAS;YACZ,OAAO;QACT;QAEA,IAAI,kBAAkB,GAAG,CAAC,QAAQ,UAAU,GAAa;YACvD,MAAM,WAAW,QAAQ,QAAQ,IAAI;YACrC,MAAM,YAAY,QAAQ,SAAS,IAAI;YACvC,OAAO,MAAM,WAAW;QAC1B;QAEA,OAAO;IACT,GAAG;IAEH,OAAO,sBAAsB,CAAC,OAAO,WAAW,IAAI,CAAC;AACvD"}},
    {"offset": {"line": 4373, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/warranty/utils/settlement-store.ts"],"sourcesContent":["import type { SettlementMethod, SettlementStatus, SettlementType, WarrantySettlement, WarrantyTicket } from '../types';\r\nimport { useWarrantyStore } from '../store';\r\n\r\nexport interface SettlementMethodInput extends Partial<SettlementMethod> {\r\n  type: SettlementMethod['type'];\r\n  amount: number;\r\n  status?: SettlementStatus;\r\n}\r\n\r\nimport { asSystemId } from '@/lib/id-types';\r\n\r\nconst METHOD_ID_PREFIX = 'SM';\r\nconst SETTLEMENT_ID_PREFIX = 'SET';\r\n\r\nconst generateMethodId = (index: number) => asSystemId(`${METHOD_ID_PREFIX}_${Date.now()}_${index}_${Math.random().toString(36).slice(2, 6).toUpperCase()}`);\r\n\r\nconst normalizeMethod = (method: SettlementMethodInput, index: number): SettlementMethod => {\r\n  const createdAt = method.createdAt ?? new Date().toISOString();\r\n  const status = method.status ?? 'completed';\r\n  const completedAt = status === 'completed' ? (method.completedAt ?? createdAt) : method.completedAt;\r\n\r\n  return {\r\n    ...method,\r\n    amount: Math.abs(method.amount),\r\n    systemId: method.systemId ?? generateMethodId(index),\r\n    createdAt,\r\n    status,\r\n    completedAt,\r\n  } as SettlementMethod;\r\n};\r\n\r\nconst mergeMethods = (existing: SettlementMethod[], incoming: SettlementMethod[]): SettlementMethod[] => {\r\n  const byId = new Map<SettlementMethod['systemId'], SettlementMethod>();\r\n  existing.forEach(method => byId.set(method.systemId, method));\r\n  incoming.forEach(method => byId.set(method.systemId, method));\r\n  return Array.from(byId.values()).sort(\r\n    (a, b) => new Date(a.createdAt).getTime() - new Date(b.createdAt).getTime(),\r\n  );\r\n};\r\n\r\nconst calculateProgress = (totalAmount: number, methods: SettlementMethod[]) => {\r\n  const absoluteTotal = Math.abs(totalAmount);\r\n  const settledAmount = methods\r\n    .filter(method => method.status !== 'cancelled')\r\n    .reduce((sum, method) => sum + Math.abs(method.amount), 0);\r\n  const remainingAmount = Math.max(absoluteTotal - settledAmount, 0);\r\n  const status: SettlementStatus = remainingAmount <= 0\r\n    ? 'completed'\r\n    : settledAmount > 0\r\n      ? 'partial'\r\n      : 'pending';\r\n\r\n  return { settledAmount, remainingAmount, status };\r\n};\r\n\r\nexport function recordWarrantySettlementMethods({\r\n  ticket,\r\n  settlementType,\r\n  totalAmount,\r\n  methods,\r\n}: {\r\n  ticket: WarrantyTicket | null;\r\n  settlementType: SettlementType;\r\n  totalAmount: number;\r\n  methods: SettlementMethodInput[];\r\n}) {\r\n  if (!ticket || !methods.length) {\r\n    return;\r\n  }\r\n\r\n  const normalizedMethods = methods.map(normalizeMethod);\r\n  const store = useWarrantyStore.getState();\r\n  const existingSettlement = ticket.settlement;\r\n  const existingMethods = existingSettlement?.methods ?? [];\r\n  const mergedMethods = mergeMethods(existingMethods, normalizedMethods);\r\n  const now = new Date().toISOString();\r\n\r\n  const inferredSettlementType: SettlementType =\r\n    settlementType === 'mixed' || mergedMethods.length > 1\r\n      ? 'mixed'\r\n      : mergedMethods[0]?.type ?? settlementType;\r\n\r\n  const { settledAmount, remainingAmount, status } = calculateProgress(totalAmount, mergedMethods);\r\n\r\n  const settlement: WarrantySettlement = {\r\n    systemId: existingSettlement?.systemId ?? asSystemId(`${SETTLEMENT_ID_PREFIX}_${Date.now()}`),\r\n    warrantyId: ticket.systemId,\r\n    settlementType: inferredSettlementType,\r\n    totalAmount,\r\n    settledAmount,\r\n    remainingAmount,\r\n    unsettledProducts: existingSettlement?.unsettledProducts ?? [],\r\n    paymentVoucherId: inferredSettlementType !== 'mixed'\r\n      ? mergedMethods.find(method => method.type === inferredSettlementType)?.paymentVoucherId ?? existingSettlement?.paymentVoucherId\r\n      : undefined,\r\n    debtTransactionId: existingSettlement?.debtTransactionId,\r\n    voucherCode: existingSettlement?.voucherCode,\r\n    linkedOrderSystemId: mergedMethods.find(method => method.type === 'order_deduction')?.linkedOrderSystemId ?? existingSettlement?.linkedOrderSystemId,\r\n    methods: mergedMethods,\r\n    status,\r\n    settledAt: status === 'completed' ? (existingSettlement?.settledAt ?? now) : existingSettlement?.settledAt,\r\n    settledBy: status === 'completed'\r\n      ? (existingSettlement?.settledBy ?? asSystemId('SYSTEM'))\r\n      : existingSettlement?.settledBy,\r\n    notes: existingSettlement?.notes ?? '',\r\n    createdAt: existingSettlement?.createdAt ?? now,\r\n    updatedAt: now,\r\n  };\r\n\r\n  store.update(ticket.systemId, { settlement });\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 4455, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/warranty/components/dialogs/warranty-payment-voucher-dialog.tsx"],"sourcesContent":["/**\r\n * WarrantyPaymentVoucherDialog\r\n * \r\n * Dialog tạo phiếu chi (payment voucher) từ warranty\r\n * - Auto-fill số tiền từ remainingAmount\r\n * - Chọn phương thức: Cash / Bank Transfer\r\n * - Optional: Link đơn hàng để trừ vào tiền hàng\r\n */\r\n\r\nimport * as React from 'react';\r\nimport { useForm, Controller } from 'react-hook-form';\r\nimport { useRouter } from 'next/navigation';\r\nimport {\r\n  Dialog,\r\n  DialogContent,\r\n  DialogHeader,\r\n  DialogTitle,\r\n  DialogFooter,\r\n  DialogTrigger,\r\n} from '../../../../components/ui/dialog';\r\nimport { Button } from '../../../../components/ui/button';\r\nimport { Label } from '../../../../components/ui/label';\r\nimport { Input } from '../../../../components/ui/input';\r\nimport { CurrencyInput } from '../../../../components/ui/currency-input';\r\nimport { Textarea } from '../../../../components/ui/textarea';\r\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '../../../../components/ui/select';\r\nimport { Alert, AlertDescription } from '../../../../components/ui/alert';\r\nimport { AlertCircle, AlertTriangle } from 'lucide-react';\r\nimport { toast } from 'sonner';\r\nimport { usePaymentStore } from '../../../payments/store';\r\nimport { useReceiptStore } from '../../../receipts/store';\r\nimport { useOrderStore } from '../../../orders/store';\r\nimport { useWarrantyStore } from '../../store';\r\nimport type { SettlementType, WarrantyVoucherDialogBaseProps } from '../../types';\r\nimport { usePaymentTypeStore } from '../../../settings/payments/types/store';\r\nimport { usePaymentMethodStore } from '../../../settings/payments/methods/store';\r\nimport { useCashbookStore } from '../../../cashbook/store';\r\nimport { toISODateTime } from '../../../../lib/date-utils';\r\nimport { searchOrders, type OrderSearchResult } from '../../../orders/order-search-api';\r\nimport { VirtualizedCombobox } from '../../../../components/ui/virtualized-combobox';\r\nimport type { Payment } from '../../../payments/types';\r\nimport type { PaymentMethod } from '../../../settings/payments/methods/types';\r\nimport { useAuth } from '../../../../contexts/auth-context';\r\nimport { asSystemId, asBusinessId } from '@/lib/id-types';\r\nimport { calculateWarrantyProcessingState } from '../logic/processing';\r\nimport { InsufficientBalanceDialog } from './insufficient-balance-dialog';\r\nimport { calculateWarrantySettlementTotal } from '../../utils/payment-calculations';\r\nimport { recordWarrantySettlementMethods, type SettlementMethodInput } from '../../utils/settlement-store';\r\n\r\ninterface WarrantyPaymentVoucherDialogProps extends WarrantyVoucherDialogBaseProps {\r\n  existingPayments?: Payment[] | undefined;\r\n}\r\n\r\ninterface FormValues {\r\n  amount: number;\r\n  settlementType: 'order_deduction' | 'direct_payment' | 'mixed';\r\n  paymentMethodSystemId?: string | undefined;\r\n  accountSystemId?: string | undefined;\r\n  selectedOrderId?: string | undefined;\r\n  notes: string;\r\n  mixedOrderAmount?: number | undefined;\r\n  mixedCashAmount?: number | undefined;\r\n}\r\n\r\nconst detectDirectSettlementType = (paymentMethod?: PaymentMethod | null): Exclude<SettlementType, 'mixed'> => {\r\n  if (!paymentMethod) {\r\n    return 'cash';\r\n  }\r\n\r\n  const normalizedId = paymentMethod.id?.toUpperCase() || '';\r\n  const normalizedName = paymentMethod.name.toLowerCase();\r\n\r\n  if (normalizedId === 'TIEN_MAT' || normalizedName.includes('tiền mặt')) {\r\n    return 'cash';\r\n  }\r\n\r\n  if (normalizedId === 'VI_DIEN_TU' || normalizedName.includes('momo') || normalizedName.includes('ví')) {\r\n    return 'transfer';\r\n  }\r\n\r\n  return 'transfer';\r\n};\r\n\r\nexport function WarrantyPaymentVoucherDialog({\r\n  warrantyId,\r\n  warrantySystemId,\r\n  customer,\r\n  defaultAmount = 0,\r\n  linkedOrderId,\r\n  branchSystemId,\r\n  branchName,\r\n  existingPayments = [],\r\n}: WarrantyPaymentVoucherDialogProps) {\r\n  const [open, setOpen] = React.useState(false);\r\n  const router = useRouter();\r\n  \r\n  const { add: addPayment, data: payments } = usePaymentStore();\r\n  const { data: receipts } = useReceiptStore();\r\n  const { data: orders, update: updateOrder } = useOrderStore();\r\n  const { findById: findWarrantyById, addHistory } = useWarrantyStore();\r\n  const { data: paymentTypes } = usePaymentTypeStore();\r\n  const { data: paymentMethods } = usePaymentMethodStore();\r\n  const { accounts } = useCashbookStore();\r\n  const { employee: authEmployee } = useAuth();\r\n\r\n  const currentUserSystemId = authEmployee?.systemId ?? 'SYSTEM';\r\n  const currentUserName = authEmployee?.fullName || authEmployee?.id || 'Hệ thống';\r\n\r\n  // Order search state\r\n  const [orderSearchQuery, setOrderSearchQuery] = React.useState('');\r\n  const [orderSearchResults, setOrderSearchResults] = React.useState<OrderSearchResult[]>([]);\r\n  const [isSearchingOrders, setIsSearchingOrders] = React.useState(false);\r\n\r\n  // Get warranty payment types\r\n  const warrantyRefundType = React.useMemo(() => \r\n    paymentTypes.find(t => t.id === 'HOANTIEN_BH' && t.isActive),\r\n    [paymentTypes]\r\n  );\r\n\r\n  const warrantyOrderDeductionType = React.useMemo(() => \r\n    paymentTypes.find(t => t.id === 'TRAVAO_DONHANG' && t.isActive),\r\n    [paymentTypes]\r\n  );\r\n\r\n  // Get default payment method (Tiền mặt)\r\n  const defaultPaymentMethod = React.useMemo(() => \r\n    paymentMethods.find(m => m.isDefault && m.isActive) || paymentMethods.find(m => m.isActive),\r\n    [paymentMethods]\r\n  );\r\n\r\n  // Get default cash account\r\n  const defaultCashAccount = React.useMemo(() => \r\n    accounts.find(a => a.type === 'cash' && a.isDefault && a.isActive) || \r\n    accounts.find(a => a.type === 'cash' && a.isActive),\r\n    [accounts]\r\n  );\r\n\r\n  // ✅ Tính số tiền còn lại THỰC TẾ dùng warranty-processing-logic\r\n  const ticket = React.useMemo(() => \r\n    findWarrantyById(asSystemId(warrantySystemId)),\r\n    [findWarrantyById, warrantySystemId]\r\n  );\r\n  \r\n  const actualRemainingAmount = React.useMemo(() => {\r\n    // ✅ Tính lại từ ticket thực tế, KHÔNG dùng defaultAmount (vì nó đã bị trừ)\r\n    if (!ticket) return 0;\r\n    \r\n    // Tính totalPayment từ ticket (giống WarrantyProcessingCard)\r\n    const totalPaymentFromTicket = ticket.products.reduce((sum, p) => {\r\n      if (p.resolution === 'out_of_stock') {\r\n        return sum + ((p.quantity || 0) * (p.unitPrice || 0));\r\n      }\r\n      return sum;\r\n    }, 0) + (ticket.shippingFee || 0);\r\n    \r\n    const state = calculateWarrantyProcessingState(ticket, payments, receipts, totalPaymentFromTicket);\r\n    \r\n    console.log('💰 [ACTUAL REMAINING CALCULATION]', {\r\n      totalPaymentFromTicket,\r\n      remainingAmount: state.remainingAmount,\r\n      warrantySystemId,\r\n      paymentsCount: state.warrantyPayments.length,\r\n      receiptsCount: state.warrantyReceipts.length,\r\n      warrantyPaymentsTotal: state.warrantyPayments.reduce((sum, p) => p.status !== 'cancelled' ? sum + p.amount : sum, 0)\r\n    });\r\n    \r\n    return state.remainingAmount;\r\n  }, [ticket, payments, receipts, warrantySystemId]);\r\n\r\n  const { control, handleSubmit, watch, reset, setValue } = useForm<FormValues>({\r\n    defaultValues: {\r\n      amount: 0, // Sẽ được set trong useEffect\r\n      settlementType: 'direct_payment',\r\n      paymentMethodSystemId: defaultPaymentMethod?.systemId,\r\n      accountSystemId: defaultCashAccount?.systemId,\r\n      selectedOrderId: linkedOrderId,\r\n      notes: `Hoàn tiền bảo hành ${warrantyId}`,\r\n      mixedOrderAmount: undefined,\r\n      mixedCashAmount: undefined,\r\n    },\r\n  });\r\n\r\n  const settlementType = watch('settlementType');\r\n  const selectedOrderId = watch('selectedOrderId');\r\n  const paymentMethodSystemId = watch('paymentMethodSystemId');\r\n  const accountSystemId = watch('accountSystemId');\r\n  const amount = watch('amount');\r\n  const mixedOrderAmount = watch('mixedOrderAmount');\r\n  const mixedCashAmount = watch('mixedCashAmount');\r\n\r\n  // Get selected payment method to determine account type\r\n  const selectedPaymentMethod = React.useMemo(() => \r\n    paymentMethods.find(m => m.systemId === paymentMethodSystemId),\r\n    [paymentMethods, paymentMethodSystemId]\r\n  );\r\n\r\n  // Filter accounts based on payment method\r\n  // Tiền mặt → cash accounts, Chuyển khoản → bank accounts\r\n  const filteredAccounts = React.useMemo(() => {\r\n    if (!selectedPaymentMethod) return accounts.filter(a => a.isActive);\r\n    \r\n    const isCashMethod = selectedPaymentMethod.name.toLowerCase().includes('tiền mặt') || \r\n                         selectedPaymentMethod.id === 'TIEN_MAT';\r\n    const accountType = isCashMethod ? 'cash' : 'bank';\r\n    \r\n    return accounts.filter(a => a.isActive && a.type === accountType);\r\n  }, [accounts, selectedPaymentMethod]);\r\n\r\n  // Auto-select appropriate account when payment method changes\r\n  React.useEffect(() => {\r\n    if (!selectedPaymentMethod || settlementType !== 'direct_payment') return;\r\n    \r\n    const isCashMethod = selectedPaymentMethod.name.toLowerCase().includes('tiền mặt') || \r\n                         selectedPaymentMethod.id === 'TIEN_MAT';\r\n    const accountType = isCashMethod ? 'cash' : 'bank';\r\n    \r\n    // Find default account of the correct type\r\n    const defaultAccount = accounts.find(a => a.type === accountType && a.isDefault && a.isActive) ||\r\n                          accounts.find(a => a.type === accountType && a.isActive);\r\n    \r\n    if (defaultAccount) {\r\n      setValue('accountSystemId', defaultAccount.systemId);\r\n    }\r\n  }, [selectedPaymentMethod, accounts, setValue, settlementType]);\r\n\r\n  // Reset form when dialog opens và auto-fill số tiền tối đa\r\n  React.useEffect(() => {\r\n    if (open) {\r\n      reset({\r\n        amount: actualRemainingAmount, // ✅ Auto-fill số tiền tối đa\r\n        settlementType: 'direct_payment',\r\n        paymentMethodSystemId: defaultPaymentMethod?.systemId,\r\n        accountSystemId: defaultCashAccount?.systemId,\r\n        selectedOrderId: linkedOrderId,\r\n        notes: `Hoàn tiền bảo hành ${warrantyId}`,\r\n        mixedOrderAmount: undefined,\r\n        mixedCashAmount: undefined,\r\n      });\r\n    }\r\n  }, [open, linkedOrderId, warrantyId, reset, defaultPaymentMethod, defaultCashAccount, actualRemainingAmount]);\r\n\r\n  // Server-side search for orders with debounce - ONLY SHOW ORDERS NOT SHIPPED YET\r\n  React.useEffect(() => {\r\n    const performSearch = async () => {\r\n      setIsSearchingOrders(true);\r\n      try {\r\n        const results = await searchOrders(\r\n          { query: orderSearchQuery, limit: 50 },\r\n          orders\r\n        );\r\n        \r\n        // Filter: Only show orders that:\r\n        // 1. NOT been shipped yet (stockOutStatus === 'Chưa xuất kho')\r\n        // 2. Still have remaining amount to deduct (grandTotal - paidAmount > 0)\r\n        const unshippedResults = results.filter(result => {\r\n          const order = orders.find(o => o.systemId === result.value);\r\n          if (!order) return false;\r\n          \r\n          // Check if order is not shipped yet\r\n          if (order.stockOutStatus !== 'Chưa xuất kho') return false;\r\n          \r\n          // Calculate remaining amount (grandTotal - already paid from warranty)\r\n          const paidAmount = order.paidAmount || 0;\r\n          const remainingAmount = order.grandTotal - paidAmount;\r\n          \r\n          // Only show orders with remaining amount > 0\r\n          return remainingAmount > 0;\r\n        });\r\n        \r\n        // Update subtitle to show remaining amount\r\n        const resultsWithRemaining = unshippedResults.map(result => {\r\n          const order = orders.find(o => o.systemId === result.value);\r\n          if (!order) return result;\r\n          \r\n          const paidAmount = order.paidAmount || 0;\r\n          const remainingAmount = order.grandTotal - paidAmount;\r\n          \r\n          return {\r\n            ...result,\r\n            subtitle: `${order.grandTotal.toLocaleString('vi-VN')} đ • Còn lại: ${remainingAmount.toLocaleString('vi-VN')} đ • ${order.orderDate}`,\r\n          };\r\n        });\r\n        \r\n        setOrderSearchResults(resultsWithRemaining);\r\n      } catch (error) {\r\n        console.error('Order search error:', error);\r\n        setOrderSearchResults([]);\r\n      } finally {\r\n        setIsSearchingOrders(false);\r\n      }\r\n    };\r\n\r\n    performSearch();\r\n  }, [orderSearchQuery, orders]);\r\n\r\n  // Memoize selected order value for VirtualizedCombobox\r\n  const selectedOrderValue = React.useMemo(() => {\r\n    if (!selectedOrderId) return null;\r\n    const order = orders.find(o => o.systemId === selectedOrderId);\r\n    if (!order) return null;\r\n    \r\n    const paidAmount = order.paidAmount || 0;\r\n    const remainingAmount = order.grandTotal - paidAmount;\r\n    \r\n    return {\r\n      value: order.systemId,\r\n      label: `${order.id} - ${order.customerName}`,\r\n      subtitle: `${order.grandTotal.toLocaleString('vi-VN')} đ • Còn lại: ${remainingAmount.toLocaleString('vi-VN')} đ • ${order.orderDate}`\r\n    };\r\n  }, [selectedOrderId, orders]);\r\n\r\n  // Get selected order details for validation\r\n  const selectedOrder = React.useMemo(() => \r\n    orders.find(o => o.systemId === selectedOrderId),\r\n    [orders, selectedOrderId]\r\n  );\r\n\r\n  const [insufficientDialogOpen, setInsufficientDialogOpen] = React.useState(false);\r\n\r\n  const orderRemainingAmount = React.useMemo(() => {\r\n    if (!selectedOrder) return 0;\r\n    const orderPaidAmount = selectedOrder.paidAmount || 0;\r\n    return Math.max(selectedOrder.grandTotal - orderPaidAmount, 0);\r\n  }, [selectedOrder]);\r\n\r\n  const shortageAmount = React.useMemo(() => {\r\n    if (!selectedOrder) return 0;\r\n    return Math.max(actualRemainingAmount - orderRemainingAmount, 0);\r\n  }, [selectedOrder, actualRemainingAmount, orderRemainingAmount]);\r\n\r\n  const shouldShowInsufficientWarning = React.useMemo(() => {\r\n    if (!selectedOrder) return false;\r\n    return settlementType === 'order_deduction' && shortageAmount > 0;\r\n  }, [settlementType, selectedOrder, shortageAmount]);\r\n\r\n  const applyMixedSuggestion = React.useCallback(() => {\r\n    if (!selectedOrder) return;\r\n    const orderAllocation = Math.min(orderRemainingAmount, actualRemainingAmount);\r\n    const cashAllocation = Math.max(actualRemainingAmount - orderAllocation, 0);\r\n    setValue('settlementType', 'mixed', { shouldValidate: true, shouldDirty: true });\r\n    setValue('mixedOrderAmount', orderAllocation, { shouldValidate: true, shouldDirty: true });\r\n    setValue('mixedCashAmount', cashAllocation, { shouldValidate: true, shouldDirty: true });\r\n    setValue('amount', cashAllocation, { shouldValidate: true, shouldDirty: true });\r\n    setInsufficientDialogOpen(false);\r\n  }, [selectedOrder, orderRemainingAmount, actualRemainingAmount, setValue]);\r\n\r\n  const applyCashOnlySuggestion = React.useCallback(() => {\r\n    setValue('settlementType', 'direct_payment', { shouldValidate: true, shouldDirty: true });\r\n    setValue('selectedOrderId', '', { shouldValidate: true, shouldDirty: true });\r\n    setValue('mixedOrderAmount', undefined);\r\n    setValue('mixedCashAmount', undefined);\r\n    setValue('amount', actualRemainingAmount, { shouldValidate: true, shouldDirty: true });\r\n    setInsufficientDialogOpen(false);\r\n  }, [actualRemainingAmount, setValue]);\r\n\r\n  React.useEffect(() => {\r\n    if (settlementType !== 'mixed') return;\r\n    const maxOrderAllocation = Math.min(orderRemainingAmount, actualRemainingAmount);\r\n    const rawOrderAmount = mixedOrderAmount ?? maxOrderAllocation;\r\n    const clampedOrderAmount = Math.max(0, Math.min(rawOrderAmount, maxOrderAllocation));\r\n\r\n    if (clampedOrderAmount !== (mixedOrderAmount ?? 0)) {\r\n      setValue('mixedOrderAmount', clampedOrderAmount, { shouldValidate: true, shouldDirty: true });\r\n    }\r\n\r\n    const recalculatedCashAmount = Math.max(actualRemainingAmount - clampedOrderAmount, 0);\r\n    if (recalculatedCashAmount !== (mixedCashAmount ?? 0)) {\r\n      setValue('mixedCashAmount', recalculatedCashAmount, { shouldValidate: true, shouldDirty: true });\r\n    }\r\n\r\n    if (settlementType === 'mixed' && amount !== recalculatedCashAmount) {\r\n      setValue('amount', recalculatedCashAmount, { shouldValidate: true, shouldDirty: true });\r\n    }\r\n  }, [settlementType, mixedOrderAmount, mixedCashAmount, orderRemainingAmount, actualRemainingAmount, amount, setValue]);\r\n\r\n  // Calculate max amount based on settlement type\r\n  const maxAmount = React.useMemo(() => {\r\n    if (settlementType === 'order_deduction' && selectedOrder) {\r\n      // Nếu trừ vào đơn hàng: max = min(actualRemainingAmount, order remaining amount)\r\n      const orderPaidAmount = selectedOrder.paidAmount || 0;\r\n      const orderRemainingAmount = selectedOrder.grandTotal - orderPaidAmount;\r\n      return Math.min(actualRemainingAmount, orderRemainingAmount);\r\n    }\r\n    // Nếu trả trực tiếp: max = actualRemainingAmount\r\n    return actualRemainingAmount;\r\n  }, [settlementType, selectedOrder, actualRemainingAmount]);\r\n\r\n  const handleMixedSettlement = async (values: FormValues) => {\r\n    if (!ticket) {\r\n      toast.error('Không tìm thấy thông tin phiếu bảo hành');\r\n      return;\r\n    }\r\n\r\n    const selectedOrderSystemId = values.selectedOrderId;\r\n    if (!selectedOrderSystemId) {\r\n      toast.error('Vui lòng chọn đơn hàng để bù trừ');\r\n      return;\r\n    }\r\n\r\n    const order = orders.find(o => o.systemId === selectedOrderSystemId);\r\n    if (!order) {\r\n      toast.error('Không tìm thấy thông tin đơn hàng để bù trừ');\r\n      return;\r\n    }\r\n\r\n    const orderAmount = values.mixedOrderAmount || 0;\r\n    const cashAmount = values.mixedCashAmount || 0;\r\n\r\n    if (orderAmount <= 0) {\r\n      toast.error('Số tiền trừ vào đơn phải lớn hơn 0');\r\n      return;\r\n    }\r\n\r\n    if (cashAmount <= 0) {\r\n      toast.error('Số tiền chi trực tiếp phải lớn hơn 0');\r\n      return;\r\n    }\r\n\r\n    const orderPaidAmount = order.paidAmount || 0;\r\n    const orderRemainingAmountForOrder = order.grandTotal - orderPaidAmount;\r\n    if (orderAmount > orderRemainingAmountForOrder) {\r\n      toast.error('Số tiền trừ vào đơn vượt quá số dư của đơn hàng', {\r\n        description: `Còn lại: ${orderRemainingAmountForOrder.toLocaleString('vi-VN')} đ`,\r\n      });\r\n      return;\r\n    }\r\n\r\n    const latestPayments = usePaymentStore.getState().data;\r\n    const latestReceipts = useReceiptStore.getState().data;\r\n    const totalPaymentFromTicket = calculateWarrantySettlementTotal(ticket);\r\n    const currentState = calculateWarrantyProcessingState(ticket, latestPayments, latestReceipts, totalPaymentFromTicket);\r\n    const currentRemainingAmount = currentState.remainingAmount;\r\n\r\n    if (orderAmount + cashAmount > currentRemainingAmount) {\r\n      toast.error('Tổng số tiền vượt quá số tiền cần hoàn cho khách', {\r\n        description: `Còn lại: ${currentRemainingAmount.toLocaleString('vi-VN')} đ`,\r\n      });\r\n      return;\r\n    }\r\n\r\n    if (!warrantyOrderDeductionType || !warrantyRefundType) {\r\n      toast.error('Thiếu cấu hình loại phiếu chi bảo hành trong cài đặt');\r\n      return;\r\n    }\r\n\r\n    let selectedPaymentMethod = paymentMethods.find(m => m.systemId === values.paymentMethodSystemId);\r\n    if (!selectedPaymentMethod) {\r\n      selectedPaymentMethod = defaultPaymentMethod;\r\n    }\r\n\r\n    if (!selectedPaymentMethod) {\r\n      toast.error('Vui lòng chọn hình thức thanh toán cho phần chi trực tiếp');\r\n      return;\r\n    }\r\n\r\n    if (!values.accountSystemId) {\r\n      toast.error('Vui lòng chọn tài khoản chi cho phần chi trực tiếp');\r\n      return;\r\n    }\r\n\r\n    const now = new Date();\r\n    const isoNow = toISODateTime(now) || now.toISOString();\r\n    const baseNotes = values.notes || `Hoàn tiền bảo hành ${warrantyId}`;\r\n\r\n    // --- Step 1: Order deduction ---\r\n    const orderDeductionPayment: Omit<Payment, 'systemId'> = {\r\n      id: asBusinessId(''),\r\n      date: isoNow,\r\n      amount: orderAmount,\r\n      recipientTypeSystemId: asSystemId('KHACHHANG'),\r\n      recipientTypeName: 'Khách hàng',\r\n      recipientName: customer.name,\r\n      description: `${baseNotes} - Trừ vào đơn ${order.id}`,\r\n      paymentMethodSystemId: asSystemId('ORDER_DEDUCTION'),\r\n      paymentMethodName: 'Bù trừ đơn hàng',\r\n      accountSystemId: asSystemId(''),\r\n      paymentReceiptTypeSystemId: warrantyOrderDeductionType.systemId,\r\n      paymentReceiptTypeName: warrantyOrderDeductionType.name,\r\n      branchSystemId: asSystemId(branchSystemId || ''),\r\n      branchName: branchName || '',\r\n      status: 'completed',\r\n      category: 'warranty_refund',\r\n      linkedWarrantySystemId: asSystemId(warrantySystemId),\r\n      linkedOrderSystemId: order.systemId,\r\n      originalDocumentId: warrantyId,\r\n      customerSystemId: undefined,\r\n      customerName: customer.name,\r\n      affectsDebt: false,\r\n      createdBy: asSystemId(currentUserSystemId),\r\n      createdAt: isoNow,\r\n    };\r\n\r\n    const orderPayment = addPayment(orderDeductionPayment);\r\n\r\n    const existingOrderPayments = order.payments || [];\r\n    const orderPaymentEntry = {\r\n      systemId: orderPayment.systemId,\r\n      id: orderPayment.id,\r\n      date: orderPayment.date,\r\n      method: 'Bù trừ bảo hành',\r\n      amount: -orderAmount,\r\n      createdBy: orderPayment.createdBy,\r\n      description: `Trừ tiền bảo hành ${warrantyId}`,\r\n      linkedWarrantySystemId: warrantySystemId,\r\n    };\r\n\r\n    updateOrder(order.systemId, {\r\n      payments: [...existingOrderPayments, orderPaymentEntry],\r\n      paidAmount: (order.paidAmount || 0) + orderAmount,\r\n    });\r\n\r\n    addHistory(\r\n      asSystemId(warrantySystemId),\r\n      `Bù trừ ${orderAmount.toLocaleString('vi-VN')} đ vào đơn ${order.id}`,\r\n      currentUserName,\r\n      `Đơn ${order.id} - Khách hàng: ${order.customerName}`,\r\n      { paymentSystemId: orderPayment.systemId, linkedOrderSystemId: order.systemId }\r\n    );\r\n\r\n    // --- Step 2: Cash payment ---\r\n    const cashPayment: Omit<Payment, 'systemId'> = {\r\n      id: asBusinessId(''),\r\n      date: isoNow,\r\n      amount: cashAmount,\r\n      recipientTypeSystemId: asSystemId('KHACHHANG'),\r\n      recipientTypeName: 'Khách hàng',\r\n      recipientName: customer.name,\r\n      description: `${baseNotes} - Chi trực tiếp`,\r\n      paymentMethodSystemId: selectedPaymentMethod.systemId,\r\n      paymentMethodName: selectedPaymentMethod.name,\r\n      accountSystemId: asSystemId(values.accountSystemId || ''),\r\n      paymentReceiptTypeSystemId: warrantyRefundType.systemId,\r\n      paymentReceiptTypeName: warrantyRefundType.name,\r\n      branchSystemId: asSystemId(branchSystemId || ''),\r\n      branchName: branchName || '',\r\n      status: 'completed',\r\n      category: 'warranty_refund',\r\n      linkedWarrantySystemId: asSystemId(warrantySystemId),\r\n      originalDocumentId: warrantyId,\r\n      customerSystemId: undefined,\r\n      customerName: customer.name,\r\n      affectsDebt: false,\r\n      createdBy: asSystemId(currentUserSystemId),\r\n      createdAt: isoNow,\r\n    };\r\n\r\n    const cashPaymentResult = addPayment(cashPayment);\r\n\r\n    addHistory(\r\n      asSystemId(warrantySystemId),\r\n      `Chi ${cashAmount.toLocaleString('vi-VN')} đ cho khách`,\r\n      currentUserName,\r\n      `${selectedPaymentMethod.name} - ${cashAmount.toLocaleString('vi-VN')} đ`,\r\n      { paymentSystemId: cashPaymentResult.systemId }\r\n    );\r\n\r\n    const settlementMethods: SettlementMethodInput[] = [\r\n      {\r\n        type: 'order_deduction',\r\n        amount: orderAmount,\r\n        status: 'completed',\r\n        linkedOrderSystemId: order.systemId,\r\n        paymentVoucherId: orderPayment.systemId,\r\n        notes: `Trừ vào đơn ${order.id}`,\r\n        createdAt: isoNow,\r\n        completedAt: isoNow,\r\n      },\r\n      {\r\n        type: detectDirectSettlementType(selectedPaymentMethod),\r\n        amount: cashAmount,\r\n        status: 'completed',\r\n        paymentVoucherId: cashPaymentResult.systemId,\r\n        notes: `${selectedPaymentMethod.name} - ${baseNotes}`,\r\n        createdAt: isoNow,\r\n        completedAt: cashPaymentResult.status === 'completed' ? isoNow : undefined,\r\n      },\r\n    ];\r\n\r\n    recordWarrantySettlementMethods({\r\n      ticket,\r\n      settlementType: 'mixed',\r\n      totalAmount: totalPaymentFromTicket,\r\n      methods: settlementMethods,\r\n    });\r\n\r\n    setInsufficientDialogOpen(false);\r\n    toast.success('Đã xử lý bù trừ + chi tiền', {\r\n      description: `Trừ ${orderAmount.toLocaleString('vi-VN')} đ vào ${order.id} + Chi ${cashAmount.toLocaleString('vi-VN')} đ`,\r\n      action: {\r\n        label: 'Xem phiếu chi',\r\n        onClick: () => router.push(`/payments/${cashPaymentResult.systemId}`),\r\n      },\r\n    });\r\n  };\r\n\r\n  const onSubmit = async (values: FormValues) => {\r\n    try {\r\n      if (values.settlementType === 'mixed') {\r\n        await handleMixedSettlement(values);\r\n        setOpen(false);\r\n        return;\r\n      }\r\n\r\n      const now = new Date();\r\n\r\n      if (!ticket) {\r\n        toast.error('Không tìm thấy thông tin phiếu bảo hành');\r\n        return;\r\n      }\r\n\r\n      const totalPaymentFromTicket = calculateWarrantySettlementTotal(ticket);\r\n      const currentState = calculateWarrantyProcessingState(ticket, payments, receipts, totalPaymentFromTicket);\r\n      const currentRemainingAmount = currentState.remainingAmount;\r\n      \r\n      console.log('💰 [PAYMENT VALIDATION]', {\r\n        totalPaymentFromTicket,\r\n        totalPayments: currentState.warrantyPayments.reduce((sum, p) => p.status !== 'cancelled' ? sum + p.amount : sum, 0),\r\n        totalReceipts: currentState.warrantyReceipts.reduce((sum, r) => r.status !== 'cancelled' ? sum + r.amount : sum, 0),\r\n        currentRemainingAmount,\r\n        attemptingToPay: values.amount,\r\n        willExceed: values.amount > currentRemainingAmount\r\n      });\r\n\r\n      // Không cho thanh toán vượt quá số tiền còn phải trả\r\n      if (values.amount > currentRemainingAmount) {\r\n        const totalPaid = totalPaymentFromTicket - currentRemainingAmount;\r\n        toast.error('Số tiền không được vượt quá số tiền còn phải trả cho khách', {\r\n          description: `Đã trả: ${totalPaid.toLocaleString('vi-VN')} đ\\nCòn lại: ${currentRemainingAmount.toLocaleString('vi-VN')} đ`,\r\n          duration: 5000,\r\n        });\r\n        return;\r\n      }\r\n\r\n      // Determine payment type and method based on settlement type\r\n      let paymentType = warrantyRefundType;\r\n      let selectedPaymentMethod = paymentMethods.find(m => m.systemId === values.paymentMethodSystemId);\r\n      let linkedOrderSystemId: string | undefined;\r\n\r\n      if (values.settlementType === 'order_deduction') {\r\n        // Trừ vào đơn hàng - use TRAVAO_DONHANG type\r\n        paymentType = warrantyOrderDeductionType;\r\n        linkedOrderSystemId = values.selectedOrderId;\r\n        \r\n        if (!linkedOrderSystemId) {\r\n          toast.error('Vui lòng chọn đơn hàng');\r\n          return;\r\n        }\r\n        \r\n        // ✅ ADDITIONAL VALIDATION: Kiểm tra số tiền không vượt quá số dư đơn hàng\r\n        if (selectedOrder) {\r\n          const orderPaidAmount = selectedOrder.paidAmount || 0;\r\n          const orderRemainingAmount = selectedOrder.grandTotal - orderPaidAmount;\r\n          if (values.amount > orderRemainingAmount) {\r\n            toast.error('Số tiền không được vượt quá số dư đơn hàng', {\r\n              description: `Còn lại: ${orderRemainingAmount.toLocaleString('vi-VN')} đ`,\r\n              duration: 5000,\r\n            });\r\n            return;\r\n          }\r\n        }\r\n      }\r\n\r\n      // Validation\r\n      if (!paymentType) {\r\n        toast.error('Không tìm thấy loại phiếu chi phù hợp trong cài đặt');\r\n        return;\r\n      }\r\n\r\n      if (!selectedPaymentMethod) {\r\n        selectedPaymentMethod = defaultPaymentMethod;\r\n      }\r\n\r\n      if (!selectedPaymentMethod) {\r\n        toast.error('Không tìm thấy phương thức thanh toán');\r\n        return;\r\n      }\r\n\r\n      // Validate account for direct payment\r\n      if (values.settlementType === 'direct_payment' && !values.accountSystemId) {\r\n        toast.error('Vui lòng chọn tài khoản chi');\r\n        return;\r\n      }\r\n\r\n      const settlementRecordType: SettlementType = values.settlementType === 'order_deduction'\r\n        ? 'order_deduction'\r\n        : detectDirectSettlementType(selectedPaymentMethod);\r\n\r\n      const payment: Omit<Payment, 'systemId'> = {\r\n        id: asBusinessId(''), // Let store generate PC-XXXXXX ID\r\n        date: toISODateTime(now) || now.toISOString(),\r\n        amount: values.amount,\r\n        \r\n        // Recipient info (TargetGroup)\r\n        recipientTypeSystemId: asSystemId('KHACHHANG'), // TODO: Get KHACHHANG systemId from TargetGroup\r\n        recipientTypeName: 'Khách hàng',\r\n        recipientName: customer.name,\r\n        recipientSystemId: undefined, // TODO: Get customer systemId if needed\r\n        \r\n        description: values.notes || `Hoàn tiền bảo hành ${warrantyId}`,\r\n        \r\n        // Payment Method - From settings\r\n        paymentMethodSystemId: selectedPaymentMethod.systemId,\r\n        paymentMethodName: selectedPaymentMethod.name,\r\n        \r\n        // Account & Type - From settings\r\n        accountSystemId: asSystemId(values.accountSystemId || ''),\r\n        paymentReceiptTypeSystemId: paymentType.systemId,\r\n        paymentReceiptTypeName: paymentType.name,\r\n        \r\n        // Branch info\r\n        branchSystemId: asSystemId(branchSystemId || ''),\r\n        branchName: branchName || '',\r\n        \r\n        // Status & Category\r\n        status: 'completed', // Xuất tiền luôn\r\n        category: 'warranty_refund',\r\n        \r\n        // Links to warranty and order\r\n        linkedWarrantySystemId: asSystemId(warrantySystemId), // Link đến phiếu bảo hành\r\n        linkedOrderSystemId: linkedOrderSystemId ? asSystemId(linkedOrderSystemId) : undefined, // Link đến đơn hàng (nếu trừ vào đơn)\r\n        originalDocumentId: warrantyId,\r\n        customerSystemId: undefined,\r\n        customerName: customer.name,\r\n        \r\n        // Financial\r\n        affectsDebt: false,\r\n        \r\n        createdBy: asSystemId(currentUserSystemId),\r\n        createdAt: toISODateTime(now) || now.toISOString(),\r\n      };\r\n\r\n      const newPayment = addPayment(payment);\r\n\r\n      // ============================================================\r\n      // UPDATE ORDER if this is order_deduction\r\n      // ============================================================\r\n      if (linkedOrderSystemId) {\r\n        const order = orders.find(o => o.systemId === linkedOrderSystemId);\r\n        if (order) {\r\n          // Create OrderPayment object\r\n          const orderPayment = {\r\n            systemId: newPayment.systemId,\r\n            id: newPayment.id,\r\n            date: newPayment.date,\r\n            method: selectedPaymentMethod?.name || 'N/A',\r\n            amount: -values.amount, // ÂM vì đây là trả tiền khách (giảm công nợ)\r\n            createdBy: newPayment.createdBy,\r\n            description: `Trừ tiền bảo hành ${warrantyId}`,\r\n            linkedWarrantySystemId: warrantySystemId,\r\n          };\r\n\r\n          // Update order: add payment and increase paidAmount\r\n          const updatedPayments = [...order.payments, orderPayment];\r\n          const newPaidAmount = (order.paidAmount || 0) + values.amount;\r\n\r\n          updateOrder(linkedOrderSystemId, {\r\n            payments: updatedPayments,\r\n            paidAmount: newPaidAmount,\r\n          });\r\n        }\r\n      }\r\n\r\n      // Add history to warranty với metadata\r\n      const settlementLabel = values.settlementType === 'order_deduction' \r\n        ? `Trừ vào đơn hàng (${paymentType.name})` \r\n        : `${selectedPaymentMethod.name} (${paymentType.name})`;\r\n      \r\n      addHistory(\r\n        asSystemId(warrantySystemId), \r\n        `Tạo phiếu chi ${newPayment.id}`,\r\n        currentUserName,\r\n        `Số tiền: ${values.amount.toLocaleString('vi-VN')}đ - Phương thức: ${settlementLabel}`,\r\n        { paymentSystemId: newPayment.systemId } // ✅ Lưu systemId vào metadata\r\n      );\r\n\r\n      recordWarrantySettlementMethods({\r\n        ticket,\r\n        settlementType: settlementRecordType,\r\n        totalAmount: totalPaymentFromTicket,\r\n        methods: [{\r\n          type: settlementRecordType,\r\n          amount: values.amount,\r\n          status: 'completed',\r\n          paymentVoucherId: newPayment.systemId,\r\n          linkedOrderSystemId: linkedOrderSystemId ? asSystemId(linkedOrderSystemId) : undefined,\r\n          notes: settlementLabel,\r\n          createdAt: newPayment.createdAt,\r\n          completedAt: newPayment.status === 'completed' ? newPayment.createdAt : undefined,\r\n        }],\r\n      });\r\n\r\n      toast.success(`Đã tạo phiếu chi ${newPayment.id}`, {\r\n        description: `Đã xuất tiền (${values.amount.toLocaleString('vi-VN')} đ)`,\r\n        action: {\r\n          label: 'Xem phiếu chi',\r\n          onClick: () => router.push(`/payments/${newPayment.systemId}`),\r\n        },\r\n      });\r\n\r\n      setOpen(false);\r\n    } catch (error) {\r\n      console.error('Error creating payment voucher:', error);\r\n      toast.error('Không thể tạo phiếu chi');\r\n    }\r\n  };\r\n\r\n  return (\r\n    <Dialog open={open} onOpenChange={setOpen}>\r\n      <DialogTrigger asChild>\r\n        <Button \r\n          variant=\"default\" \r\n          size=\"lg\"\r\n          className=\"h-9 flex-1\"\r\n        >\r\n          Tạo phiếu chi\r\n        </Button>\r\n      </DialogTrigger>\r\n      \r\n      <DialogContent className=\"max-w-2xl max-h-[90vh] overflow-y-auto\">\r\n        <DialogHeader>\r\n          <DialogTitle>Tạo phiếu chi - Hoàn tiền bảo hành</DialogTitle>\r\n        </DialogHeader>\r\n\r\n        <form onSubmit={handleSubmit(onSubmit)} className=\"space-y-4\">\r\n          {/* Warning if payment types not found */}\r\n          {(!warrantyRefundType || !warrantyOrderDeductionType) && (\r\n            <Alert variant=\"destructive\">\r\n              <AlertCircle className=\"h-4 w-4\" />\r\n              <AlertDescription>\r\n                <strong>Thiếu cấu hình:</strong> Không tìm thấy loại phiếu chi phù hợp trong cài đặt.\r\n                Vui lòng vào <strong>Cài đặt {'>'} Loại phiếu chi</strong> để kiểm tra các loại:\r\n                <ul className=\"mt-2 ml-4 list-disc text-sm\">\r\n                  {!warrantyRefundType && <li><strong>HOANTIEN_BH</strong> - Hoàn tiền bảo hành</li>}\r\n                  {!warrantyOrderDeductionType && <li><strong>TRAVAO_DONHANG</strong> - Trả bảo hành vào đơn hàng</li>}\r\n                </ul>\r\n              </AlertDescription>\r\n            </Alert>\r\n          )}\r\n\r\n          {/* Warranty Info */}\r\n          <Alert>\r\n            <AlertCircle className=\"h-4 w-4\" />\r\n            <AlertDescription className=\"space-y-1\">\r\n              <div className=\"flex items-center gap-2\">\r\n                <span className=\"font-medium\">Phiếu bảo hành:</span>\r\n                <span className=\"font-mono\">{warrantyId}</span>\r\n              </div>\r\n              <div className=\"flex items-center gap-2\">\r\n                <span className=\"font-medium\">Khách hàng:</span>\r\n                <span>{customer.name} • {customer.phone}</span>\r\n              </div>\r\n              <div className=\"flex items-center gap-2\">\r\n                <span className=\"font-medium\">Cần bù trừ:</span>\r\n                <span className=\"font-semibold text-red-600\">{actualRemainingAmount.toLocaleString('vi-VN')} đ</span>\r\n              </div>\r\n            </AlertDescription>\r\n          </Alert>\r\n\r\n\r\n          {/* Settlement Type */}\r\n          <div className=\"space-y-2\">\r\n            <Label htmlFor=\"settlementType\">Phương thức *</Label>\r\n            <Controller\r\n              name=\"settlementType\"\r\n              control={control}\r\n              render={({ field }) => (\r\n                <Select value={field.value} onValueChange={field.onChange}>\r\n                  <SelectTrigger id=\"settlementType\">\r\n                    <SelectValue />\r\n                  </SelectTrigger>\r\n                  <SelectContent>\r\n                    <SelectItem value=\"direct_payment\">Trả tiền trực tiếp</SelectItem>\r\n                    <SelectItem value=\"order_deduction\">Trừ vào đơn hàng</SelectItem>\r\n                    <SelectItem value=\"mixed\">Bù trừ đơn + Chi tiền</SelectItem>\r\n                  </SelectContent>\r\n                </Select>\r\n              )}\r\n            />\r\n          </div>\r\n\r\n          {/* Payment Method - Show for direct payment and mixed (cash portion) */}\r\n          {(settlementType === 'direct_payment' || settlementType === 'mixed') && (\r\n            <>\r\n              <div className=\"space-y-2\">\r\n                <Label htmlFor=\"paymentMethodSystemId\">Hình thức thanh toán *</Label>\r\n                <Controller\r\n                  name=\"paymentMethodSystemId\"\r\n                  control={control}\r\n                  rules={{ required: settlementType === 'direct_payment' || settlementType === 'mixed' }}\r\n                  render={({ field }) => (\r\n                    <Select value={field.value} onValueChange={field.onChange}>\r\n                      <SelectTrigger id=\"paymentMethodSystemId\">\r\n                        <SelectValue placeholder=\"-- Chọn hình thức --\" />\r\n                      </SelectTrigger>\r\n                      <SelectContent>\r\n                        {paymentMethods.filter(m => m.isActive).map((method) => (\r\n                          <SelectItem key={method.systemId} value={method.systemId}>\r\n                            <div className=\"flex items-center gap-2\">\r\n                              <span>{method.name}</span>\r\n                            </div>\r\n                          </SelectItem>\r\n                        ))}\r\n                      </SelectContent>\r\n                    </Select>\r\n                  )}\r\n                />\r\n                <p className=\"text-xs text-muted-foreground\">\r\n                  Chọn hình thức thanh toán phù hợp từ cài đặt hệ thống\r\n                </p>\r\n              </div>\r\n\r\n              {/* Account Selection - Show for direct payment */}\r\n              <div className=\"space-y-2\">\r\n                <Label htmlFor=\"accountSystemId\">Tài khoản chi *</Label>\r\n                <Controller\r\n                  name=\"accountSystemId\"\r\n                  control={control}\r\n                  rules={{ required: settlementType === 'direct_payment' || settlementType === 'mixed' }}\r\n                  render={({ field }) => (\r\n                    <Select value={field.value} onValueChange={field.onChange}>\r\n                      <SelectTrigger id=\"accountSystemId\">\r\n                        <SelectValue placeholder=\"-- Chọn tài khoản --\" />\r\n                      </SelectTrigger>\r\n                      <SelectContent>\r\n                        {filteredAccounts.length === 0 ? (\r\n                          <div className=\"p-4 text-sm text-muted-foreground text-center\">\r\n                            Không có tài khoản khả dụng\r\n                          </div>\r\n                        ) : (\r\n                          filteredAccounts.map((account) => (\r\n                            <SelectItem key={account.systemId} value={account.systemId}>\r\n                              <div className=\"flex items-center gap-2\">\r\n                                <span>{account.name}</span>\r\n                              </div>\r\n                            </SelectItem>\r\n                          ))\r\n                        )}\r\n                      </SelectContent>\r\n                    </Select>\r\n                  )}\r\n                />\r\n                <p className=\"text-xs text-muted-foreground\">\r\n                  {selectedPaymentMethod?.name === 'Tiền mặt' \r\n                    ? 'Hiển thị tài khoản quỹ tiền mặt' \r\n                    : 'Hiển thị tài khoản ngân hàng'}\r\n                </p>\r\n              </div>\r\n            </>\r\n          )}\r\n\r\n          {/* Order Selection - Show for order deduction and mixed */}\r\n          {(settlementType === 'order_deduction' || settlementType === 'mixed') && (\r\n            <div className=\"space-y-2\">\r\n              <Label htmlFor=\"selectedOrderId\">Chọn đơn hàng *</Label>\r\n              <div className=\"text-xs text-muted-foreground mb-2\">\r\n                Nhập mã đơn hàng hoặc tên khách để tìm nhanh. \r\n                Hệ thống tự động lọc kết quả từ đơn hàng.\r\n              </div>\r\n              <VirtualizedCombobox\r\n                options={orderSearchResults}\r\n                value={selectedOrderValue}\r\n                onChange={(option) => setValue('selectedOrderId', option?.value || '')}\r\n                onSearchChange={(query) => setOrderSearchQuery(query)}\r\n                placeholder=\"Tìm kiếm đơn hàng...\"\r\n                searchPlaceholder=\"Nhập mã đơn hoặc tên khách hàng...\"\r\n                emptyPlaceholder={\r\n                  orderSearchQuery \r\n                    ? \"Không tìm thấy đơn hàng phù hợp\" \r\n                    : \"Nhập từ khóa để tìm kiếm đơn hàng\"\r\n                }\r\n                isLoading={isSearchingOrders}\r\n                minSearchLength={0}\r\n                estimatedItemHeight={56}\r\n                maxHeight={400}\r\n              />\r\n              <p className=\"text-xs text-muted-foreground\">\r\n                Chỉ hiển thị đơn hàng <strong>chưa xuất kho</strong> và <strong>còn số dư có thể trừ</strong>.\r\n              </p>\r\n            </div>\r\n          )}\r\n\r\n          {shouldShowInsufficientWarning && (\r\n            <Alert className=\"border-yellow-400 bg-yellow-50 text-yellow-900\">\r\n              <div className=\"flex items-start gap-3\">\r\n                <AlertTriangle className=\"h-4 w-4 mt-0.5\" />\r\n                <div className=\"space-y-1 text-sm\">\r\n                  <p className=\"font-medium\">Đơn {selectedOrder?.id} không đủ để trừ toàn bộ.</p>\r\n                  <p className=\"text-xs\">\r\n                    Thiếu <strong>{shortageAmount.toLocaleString('vi-VN')} đ</strong> so với số tiền cần hoàn. Chọn cách xử lý bên dưới.\r\n                  </p>\r\n                  <Button\r\n                    type=\"button\"\r\n                    size=\"sm\"\r\n                    variant=\"secondary\"\r\n                    className=\"mt-1\"\r\n                    onClick={() => setInsufficientDialogOpen(true)}\r\n                  >\r\n                    Mở gợi ý xử lý\r\n                  </Button>\r\n                </div>\r\n              </div>\r\n            </Alert>\r\n          )}\r\n          {/* Amount Input */}\r\n          <div className=\"space-y-2\">\r\n            <Label htmlFor=\"amount\">Số tiền *</Label>\r\n            <Controller\r\n              name=\"amount\"\r\n              control={control}\r\n              rules={{ \r\n                required: 'Vui lòng nhập số tiền',\r\n                min: { value: 1, message: 'Số tiền phải lớn hơn 0' },\r\n                max: { \r\n                  value: maxAmount, \r\n                  message: settlementType === 'order_deduction' && selectedOrder\r\n                    ? (() => {\r\n                        const orderPaidAmount = selectedOrder.paidAmount || 0;\r\n                        const orderRemainingAmount = selectedOrder.grandTotal - orderPaidAmount;\r\n                        return `Số tiền không được vượt quá số tiền còn lại của đơn hàng (${orderRemainingAmount.toLocaleString('vi-VN')} đ)`;\r\n                      })()\r\n                    : `Số tiền không được vượt quá ${actualRemainingAmount.toLocaleString('vi-VN')} đ`\r\n                }\r\n              }}\r\n              render={({ field, fieldState }) => (\r\n                <div className=\"space-y-1\">\r\n                  <CurrencyInput\r\n                    value={field.value}\r\n                    onChange={field.onChange}\r\n                    disabled={settlementType === 'mixed'}\r\n                    placeholder=\"0\"\r\n                  />\r\n                  {fieldState.error && (\r\n                    <p className=\"text-xs text-destructive\">{fieldState.error.message}</p>\r\n                  )}\r\n                  <p className=\"text-xs text-muted-foreground\">\r\n                    {settlementType === 'order_deduction' && selectedOrder ? (\r\n                      <>\r\n                        {(() => {\r\n                          const orderPaidAmount = selectedOrder.paidAmount || 0;\r\n                          const orderRemainingAmount = selectedOrder.grandTotal - orderPaidAmount;\r\n                          const maxAllowed = Math.min(actualRemainingAmount, orderRemainingAmount);\r\n                          \r\n                          return (\r\n                            <>\r\n                              Số tiền tối đa: {maxAllowed.toLocaleString('vi-VN')} đ\r\n                              {orderPaidAmount > 0 && (\r\n                                <span className=\"text-blue-600 font-medium\">\r\n                                  {' '}(Đã trừ: {orderPaidAmount.toLocaleString('vi-VN')} đ / {selectedOrder.grandTotal.toLocaleString('vi-VN')} đ)\r\n                                </span>\r\n                              )}\r\n                            </>\r\n                          );\r\n                        })()}\r\n                      </>\r\n                    ) : settlementType === 'mixed' ? (\r\n                      `Tiền mặt cần chi: ${(mixedCashAmount || 0).toLocaleString('vi-VN')} đ (tự động từ phần bù trừ)`\r\n                    ) : (\r\n                      `Số tiền tối đa: ${actualRemainingAmount.toLocaleString('vi-VN')} đ`\r\n                    )}\r\n                  </p>\r\n                </div>\r\n              )}\r\n            />\r\n          </div>\r\n\r\n          {settlementType === 'mixed' && (\r\n            <div className=\"space-y-3 rounded-lg border border-border p-3 bg-muted/40\">\r\n              <div className=\"text-sm font-medium\">Phân bổ bù trừ</div>\r\n              <div className=\"text-xs text-muted-foreground\">\r\n                Tổng cần hoàn: <strong>{actualRemainingAmount.toLocaleString('vi-VN')} đ</strong>. Điều chỉnh số tiền trừ vào đơn, phần còn lại sẽ chi trực tiếp.\r\n              </div>\r\n              <div className=\"grid gap-3 md:grid-cols-2\">\r\n                <div className=\"space-y-1\">\r\n                  <Label>Trừ vào đơn</Label>\r\n                  <CurrencyInput\r\n                    value={mixedOrderAmount || 0}\r\n                    onChange={(value) => setValue('mixedOrderAmount', value || 0, { shouldValidate: true, shouldDirty: true })}\r\n                    max={orderRemainingAmount}\r\n                    min={0}\r\n                  />\r\n                  <p className=\"text-xs text-muted-foreground\">\r\n                    Tối đa: {orderRemainingAmount.toLocaleString('vi-VN')} đ\r\n                  </p>\r\n                </div>\r\n                <div className=\"space-y-1\">\r\n                  <Label>Chi trực tiếp</Label>\r\n                  <div className=\"rounded-md border bg-background px-3 py-2 text-right font-semibold\">\r\n                    {(mixedCashAmount || 0).toLocaleString('vi-VN')} đ\r\n                  </div>\r\n                  <p className=\"text-xs text-muted-foreground\">Tự động tính = Tổng cần hoàn - Trừ vào đơn</p>\r\n                </div>\r\n              </div>\r\n            </div>\r\n          )}\r\n\r\n          {/* Notes */}\r\n          <div className=\"space-y-2\">\r\n            <Label htmlFor=\"notes\">Ghi chú</Label>\r\n            <Controller\r\n              name=\"notes\"\r\n              control={control}\r\n              render={({ field }) => (\r\n                <Textarea\r\n                  {...field}\r\n                  id=\"notes\"\r\n                  placeholder=\"Thêm ghi chú cho phiếu chi...\"\r\n                  rows={3}\r\n                />\r\n              )}\r\n            />\r\n          </div>\r\n\r\n          <DialogFooter>\r\n            <Button type=\"button\" variant=\"outline\" onClick={() => setOpen(false)}>\r\n              Hủy\r\n            </Button>\r\n            <Button type=\"submit\">\r\n              Tạo phiếu chi\r\n            </Button>\r\n          </DialogFooter>\r\n        </form>\r\n      </DialogContent>\r\n\r\n      <InsufficientBalanceDialog\r\n        open={insufficientDialogOpen}\r\n        onOpenChange={setInsufficientDialogOpen}\r\n        totalAmount={actualRemainingAmount}\r\n        orderAmount={orderRemainingAmount}\r\n        shortageAmount={shortageAmount}\r\n        orderLabel={selectedOrder?.id}\r\n        onSelectMixed={applyMixedSuggestion}\r\n        onSelectCashOnly={applyCashOnlySuggestion}\r\n      />\r\n    </Dialog>\r\n  );\r\n}\r\n"],"names":[],"mappings":";;;;;AAAA;;;;;;;CAOC,GAED;AACA;AACA;AACA;AAQA;AACA;AAEA;AACA;AACA;AACA;AACA;AAAA;AACA;AACA;AACA;AACA;AACA;AAAA;AAEA;AACA;AACA;AACA;AACA;AACA;AAGA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAiBA,MAAM,6BAA6B,CAAC;IAClC,IAAI,CAAC,eAAe;QAClB,OAAO;IACT;IAEA,MAAM,eAAe,cAAc,EAAE,EAAE,iBAAiB;IACxD,MAAM,iBAAiB,cAAc,IAAI,CAAC,WAAW;IAErD,IAAI,iBAAiB,cAAc,eAAe,QAAQ,CAAC,aAAa;QACtE,OAAO;IACT;IAEA,IAAI,iBAAiB,gBAAgB,eAAe,QAAQ,CAAC,WAAW,eAAe,QAAQ,CAAC,OAAO;QACrG,OAAO;IACT;IAEA,OAAO;AACT;AAEO,SAAS,6BAA6B,EAC3C,UAAU,EACV,gBAAgB,EAChB,QAAQ,EACR,gBAAgB,CAAC,EACjB,aAAa,EACb,cAAc,EACd,UAAU,EACV,mBAAmB,EAAE,EACa;IAClC,MAAM,CAAC,MAAM,QAAQ,GAAG,iNAAc,CAAC;IACvC,MAAM,SAAS,IAAA,+IAAS;IAExB,MAAM,EAAE,KAAK,UAAU,EAAE,MAAM,QAAQ,EAAE,GAAG,IAAA,gJAAe;IAC3D,MAAM,EAAE,MAAM,QAAQ,EAAE,GAAG,IAAA,gJAAe;IAC1C,MAAM,EAAE,MAAM,MAAM,EAAE,QAAQ,WAAW,EAAE,GAAG,IAAA,4IAAa;IAC3D,MAAM,EAAE,UAAU,gBAAgB,EAAE,UAAU,EAAE,GAAG,IAAA,0JAAgB;IACnE,MAAM,EAAE,MAAM,YAAY,EAAE,GAAG,IAAA,yKAAmB;IAClD,MAAM,EAAE,MAAM,cAAc,EAAE,GAAG,IAAA,6KAAqB;IACtD,MAAM,EAAE,QAAQ,EAAE,GAAG,IAAA,iJAAgB;IACrC,MAAM,EAAE,UAAU,YAAY,EAAE,GAAG,IAAA,uIAAO;IAE1C,MAAM,sBAAsB,cAAc,YAAY;IACtD,MAAM,kBAAkB,cAAc,YAAY,cAAc,MAAM;IAEtE,qBAAqB;IACrB,MAAM,CAAC,kBAAkB,oBAAoB,GAAG,iNAAc,CAAC;IAC/D,MAAM,CAAC,oBAAoB,sBAAsB,GAAG,iNAAc,CAAsB,EAAE;IAC1F,MAAM,CAAC,mBAAmB,qBAAqB,GAAG,iNAAc,CAAC;IAEjE,6BAA6B;IAC7B,MAAM,qBAAqB,gNAAa,CAAC,IACvC,aAAa,IAAI,CAAC,CAAA,IAAK,EAAE,EAAE,KAAK,iBAAiB,EAAE,QAAQ,GAC3D;QAAC;KAAa;IAGhB,MAAM,6BAA6B,gNAAa,CAAC,IAC/C,aAAa,IAAI,CAAC,CAAA,IAAK,EAAE,EAAE,KAAK,oBAAoB,EAAE,QAAQ,GAC9D;QAAC;KAAa;IAGhB,wCAAwC;IACxC,MAAM,uBAAuB,gNAAa,CAAC,IACzC,eAAe,IAAI,CAAC,CAAA,IAAK,EAAE,SAAS,IAAI,EAAE,QAAQ,KAAK,eAAe,IAAI,CAAC,CAAA,IAAK,EAAE,QAAQ,GAC1F;QAAC;KAAe;IAGlB,2BAA2B;IAC3B,MAAM,qBAAqB,gNAAa,CAAC,IACvC,SAAS,IAAI,CAAC,CAAA,IAAK,EAAE,IAAI,KAAK,UAAU,EAAE,SAAS,IAAI,EAAE,QAAQ,KACjE,SAAS,IAAI,CAAC,CAAA,IAAK,EAAE,IAAI,KAAK,UAAU,EAAE,QAAQ,GAClD;QAAC;KAAS;IAGZ,gEAAgE;IAChE,MAAM,SAAS,gNAAa,CAAC,IAC3B,iBAAiB,IAAA,gIAAU,EAAC,oBAC5B;QAAC;QAAkB;KAAiB;IAGtC,MAAM,wBAAwB,gNAAa,CAAC;QAC1C,2EAA2E;QAC3E,IAAI,CAAC,QAAQ,OAAO;QAEpB,6DAA6D;QAC7D,MAAM,yBAAyB,OAAO,QAAQ,CAAC,MAAM,CAAC,CAAC,KAAK;YAC1D,IAAI,EAAE,UAAU,KAAK,gBAAgB;gBACnC,OAAO,MAAO,CAAC,EAAE,QAAQ,IAAI,CAAC,IAAI,CAAC,EAAE,SAAS,IAAI,CAAC;YACrD;YACA,OAAO;QACT,GAAG,KAAK,CAAC,OAAO,WAAW,IAAI,CAAC;QAEhC,MAAM,QAAQ,IAAA,6LAAgC,EAAC,QAAQ,UAAU,UAAU;QAE3E,QAAQ,GAAG,CAAC,qCAAqC;YAC/C;YACA,iBAAiB,MAAM,eAAe;YACtC;YACA,eAAe,MAAM,gBAAgB,CAAC,MAAM;YAC5C,eAAe,MAAM,gBAAgB,CAAC,MAAM;YAC5C,uBAAuB,MAAM,gBAAgB,CAAC,MAAM,CAAC,CAAC,KAAK,IAAM,EAAE,MAAM,KAAK,cAAc,MAAM,EAAE,MAAM,GAAG,KAAK;QACpH;QAEA,OAAO,MAAM,eAAe;IAC9B,GAAG;QAAC;QAAQ;QAAU;QAAU;KAAiB;IAEjD,MAAM,EAAE,OAAO,EAAE,YAAY,EAAE,KAAK,EAAE,KAAK,EAAE,QAAQ,EAAE,GAAG,IAAA,yKAAO,EAAa;QAC5E,eAAe;YACb,QAAQ;YACR,gBAAgB;YAChB,uBAAuB,sBAAsB;YAC7C,iBAAiB,oBAAoB;YACrC,iBAAiB;YACjB,OAAO,CAAC,mBAAmB,EAAE,YAAY;YACzC,kBAAkB;YAClB,iBAAiB;QACnB;IACF;IAEA,MAAM,iBAAiB,MAAM;IAC7B,MAAM,kBAAkB,MAAM;IAC9B,MAAM,wBAAwB,MAAM;IACpC,MAAM,kBAAkB,MAAM;IAC9B,MAAM,SAAS,MAAM;IACrB,MAAM,mBAAmB,MAAM;IAC/B,MAAM,kBAAkB,MAAM;IAE9B,wDAAwD;IACxD,MAAM,wBAAwB,gNAAa,CAAC,IAC1C,eAAe,IAAI,CAAC,CAAA,IAAK,EAAE,QAAQ,KAAK,wBACxC;QAAC;QAAgB;KAAsB;IAGzC,0CAA0C;IAC1C,yDAAyD;IACzD,MAAM,mBAAmB,gNAAa,CAAC;QACrC,IAAI,CAAC,uBAAuB,OAAO,SAAS,MAAM,CAAC,CAAA,IAAK,EAAE,QAAQ;QAElE,MAAM,eAAe,sBAAsB,IAAI,CAAC,WAAW,GAAG,QAAQ,CAAC,eAClD,sBAAsB,EAAE,KAAK;QAClD,MAAM,cAAc,eAAe,SAAS;QAE5C,OAAO,SAAS,MAAM,CAAC,CAAA,IAAK,EAAE,QAAQ,IAAI,EAAE,IAAI,KAAK;IACvD,GAAG;QAAC;QAAU;KAAsB;IAEpC,8DAA8D;IAC9D,kNAAe,CAAC;QACd,IAAI,CAAC,yBAAyB,mBAAmB,kBAAkB;QAEnE,MAAM,eAAe,sBAAsB,IAAI,CAAC,WAAW,GAAG,QAAQ,CAAC,eAClD,sBAAsB,EAAE,KAAK;QAClD,MAAM,cAAc,eAAe,SAAS;QAE5C,2CAA2C;QAC3C,MAAM,iBAAiB,SAAS,IAAI,CAAC,CAAA,IAAK,EAAE,IAAI,KAAK,eAAe,EAAE,SAAS,IAAI,EAAE,QAAQ,KACvE,SAAS,IAAI,CAAC,CAAA,IAAK,EAAE,IAAI,KAAK,eAAe,EAAE,QAAQ;QAE7E,IAAI,gBAAgB;YAClB,SAAS,mBAAmB,eAAe,QAAQ;QACrD;IACF,GAAG;QAAC;QAAuB;QAAU;QAAU;KAAe;IAE9D,2DAA2D;IAC3D,kNAAe,CAAC;QACd,IAAI,MAAM;YACR,MAAM;gBACJ,QAAQ;gBACR,gBAAgB;gBAChB,uBAAuB,sBAAsB;gBAC7C,iBAAiB,oBAAoB;gBACrC,iBAAiB;gBACjB,OAAO,CAAC,mBAAmB,EAAE,YAAY;gBACzC,kBAAkB;gBAClB,iBAAiB;YACnB;QACF;IACF,GAAG;QAAC;QAAM;QAAe;QAAY;QAAO;QAAsB;QAAoB;KAAsB;IAE5G,iFAAiF;IACjF,kNAAe,CAAC;QACd,MAAM,gBAAgB;YACpB,qBAAqB;YACrB,IAAI;gBACF,MAAM,UAAU,MAAM,IAAA,4JAAY,EAChC;oBAAE,OAAO;oBAAkB,OAAO;gBAAG,GACrC;gBAGF,iCAAiC;gBACjC,+DAA+D;gBAC/D,yEAAyE;gBACzE,MAAM,mBAAmB,QAAQ,MAAM,CAAC,CAAA;oBACtC,MAAM,QAAQ,OAAO,IAAI,CAAC,CAAA,IAAK,EAAE,QAAQ,KAAK,OAAO,KAAK;oBAC1D,IAAI,CAAC,OAAO,OAAO;oBAEnB,oCAAoC;oBACpC,IAAI,MAAM,cAAc,KAAK,iBAAiB,OAAO;oBAErD,uEAAuE;oBACvE,MAAM,aAAa,MAAM,UAAU,IAAI;oBACvC,MAAM,kBAAkB,MAAM,UAAU,GAAG;oBAE3C,6CAA6C;oBAC7C,OAAO,kBAAkB;gBAC3B;gBAEA,2CAA2C;gBAC3C,MAAM,uBAAuB,iBAAiB,GAAG,CAAC,CAAA;oBAChD,MAAM,QAAQ,OAAO,IAAI,CAAC,CAAA,IAAK,EAAE,QAAQ,KAAK,OAAO,KAAK;oBAC1D,IAAI,CAAC,OAAO,OAAO;oBAEnB,MAAM,aAAa,MAAM,UAAU,IAAI;oBACvC,MAAM,kBAAkB,MAAM,UAAU,GAAG;oBAE3C,OAAO;wBACL,GAAG,MAAM;wBACT,UAAU,GAAG,MAAM,UAAU,CAAC,cAAc,CAAC,SAAS,cAAc,EAAE,gBAAgB,cAAc,CAAC,SAAS,KAAK,EAAE,MAAM,SAAS,EAAE;oBACxI;gBACF;gBAEA,sBAAsB;YACxB,EAAE,OAAO,OAAO;gBACd,QAAQ,KAAK,CAAC,uBAAuB;gBACrC,sBAAsB,EAAE;YAC1B,SAAU;gBACR,qBAAqB;YACvB;QACF;QAEA;IACF,GAAG;QAAC;QAAkB;KAAO;IAE7B,uDAAuD;IACvD,MAAM,qBAAqB,gNAAa,CAAC;QACvC,IAAI,CAAC,iBAAiB,OAAO;QAC7B,MAAM,QAAQ,OAAO,IAAI,CAAC,CAAA,IAAK,EAAE,QAAQ,KAAK;QAC9C,IAAI,CAAC,OAAO,OAAO;QAEnB,MAAM,aAAa,MAAM,UAAU,IAAI;QACvC,MAAM,kBAAkB,MAAM,UAAU,GAAG;QAE3C,OAAO;YACL,OAAO,MAAM,QAAQ;YACrB,OAAO,GAAG,MAAM,EAAE,CAAC,GAAG,EAAE,MAAM,YAAY,EAAE;YAC5C,UAAU,GAAG,MAAM,UAAU,CAAC,cAAc,CAAC,SAAS,cAAc,EAAE,gBAAgB,cAAc,CAAC,SAAS,KAAK,EAAE,MAAM,SAAS,EAAE;QACxI;IACF,GAAG;QAAC;QAAiB;KAAO;IAE5B,4CAA4C;IAC5C,MAAM,gBAAgB,gNAAa,CAAC,IAClC,OAAO,IAAI,CAAC,CAAA,IAAK,EAAE,QAAQ,KAAK,kBAChC;QAAC;QAAQ;KAAgB;IAG3B,MAAM,CAAC,wBAAwB,0BAA0B,GAAG,iNAAc,CAAC;IAE3E,MAAM,uBAAuB,gNAAa,CAAC;QACzC,IAAI,CAAC,eAAe,OAAO;QAC3B,MAAM,kBAAkB,cAAc,UAAU,IAAI;QACpD,OAAO,KAAK,GAAG,CAAC,cAAc,UAAU,GAAG,iBAAiB;IAC9D,GAAG;QAAC;KAAc;IAElB,MAAM,iBAAiB,gNAAa,CAAC;QACnC,IAAI,CAAC,eAAe,OAAO;QAC3B,OAAO,KAAK,GAAG,CAAC,wBAAwB,sBAAsB;IAChE,GAAG;QAAC;QAAe;QAAuB;KAAqB;IAE/D,MAAM,gCAAgC,gNAAa,CAAC;QAClD,IAAI,CAAC,eAAe,OAAO;QAC3B,OAAO,mBAAmB,qBAAqB,iBAAiB;IAClE,GAAG;QAAC;QAAgB;QAAe;KAAe;IAElD,MAAM,uBAAuB,oNAAiB,CAAC;QAC7C,IAAI,CAAC,eAAe;QACpB,MAAM,kBAAkB,KAAK,GAAG,CAAC,sBAAsB;QACvD,MAAM,iBAAiB,KAAK,GAAG,CAAC,wBAAwB,iBAAiB;QACzE,SAAS,kBAAkB,SAAS;YAAE,gBAAgB;YAAM,aAAa;QAAK;QAC9E,SAAS,oBAAoB,iBAAiB;YAAE,gBAAgB;YAAM,aAAa;QAAK;QACxF,SAAS,mBAAmB,gBAAgB;YAAE,gBAAgB;YAAM,aAAa;QAAK;QACtF,SAAS,UAAU,gBAAgB;YAAE,gBAAgB;YAAM,aAAa;QAAK;QAC7E,0BAA0B;IAC5B,GAAG;QAAC;QAAe;QAAsB;QAAuB;KAAS;IAEzE,MAAM,0BAA0B,oNAAiB,CAAC;QAChD,SAAS,kBAAkB,kBAAkB;YAAE,gBAAgB;YAAM,aAAa;QAAK;QACvF,SAAS,mBAAmB,IAAI;YAAE,gBAAgB;YAAM,aAAa;QAAK;QAC1E,SAAS,oBAAoB;QAC7B,SAAS,mBAAmB;QAC5B,SAAS,UAAU,uBAAuB;YAAE,gBAAgB;YAAM,aAAa;QAAK;QACpF,0BAA0B;IAC5B,GAAG;QAAC;QAAuB;KAAS;IAEpC,kNAAe,CAAC;QACd,IAAI,mBAAmB,SAAS;QAChC,MAAM,qBAAqB,KAAK,GAAG,CAAC,sBAAsB;QAC1D,MAAM,iBAAiB,oBAAoB;QAC3C,MAAM,qBAAqB,KAAK,GAAG,CAAC,GAAG,KAAK,GAAG,CAAC,gBAAgB;QAEhE,IAAI,uBAAuB,CAAC,oBAAoB,CAAC,GAAG;YAClD,SAAS,oBAAoB,oBAAoB;gBAAE,gBAAgB;gBAAM,aAAa;YAAK;QAC7F;QAEA,MAAM,yBAAyB,KAAK,GAAG,CAAC,wBAAwB,oBAAoB;QACpF,IAAI,2BAA2B,CAAC,mBAAmB,CAAC,GAAG;YACrD,SAAS,mBAAmB,wBAAwB;gBAAE,gBAAgB;gBAAM,aAAa;YAAK;QAChG;QAEA,IAAI,mBAAmB,WAAW,WAAW,wBAAwB;YACnE,SAAS,UAAU,wBAAwB;gBAAE,gBAAgB;gBAAM,aAAa;YAAK;QACvF;IACF,GAAG;QAAC;QAAgB;QAAkB;QAAiB;QAAsB;QAAuB;QAAQ;KAAS;IAErH,gDAAgD;IAChD,MAAM,YAAY,gNAAa,CAAC;QAC9B,IAAI,mBAAmB,qBAAqB,eAAe;YACzD,iFAAiF;YACjF,MAAM,kBAAkB,cAAc,UAAU,IAAI;YACpD,MAAM,uBAAuB,cAAc,UAAU,GAAG;YACxD,OAAO,KAAK,GAAG,CAAC,uBAAuB;QACzC;QACA,iDAAiD;QACjD,OAAO;IACT,GAAG;QAAC;QAAgB;QAAe;KAAsB;IAEzD,MAAM,wBAAwB,OAAO;QACnC,IAAI,CAAC,QAAQ;YACX,iJAAK,CAAC,KAAK,CAAC;YACZ;QACF;QAEA,MAAM,wBAAwB,OAAO,eAAe;QACpD,IAAI,CAAC,uBAAuB;YAC1B,iJAAK,CAAC,KAAK,CAAC;YACZ;QACF;QAEA,MAAM,QAAQ,OAAO,IAAI,CAAC,CAAA,IAAK,EAAE,QAAQ,KAAK;QAC9C,IAAI,CAAC,OAAO;YACV,iJAAK,CAAC,KAAK,CAAC;YACZ;QACF;QAEA,MAAM,cAAc,OAAO,gBAAgB,IAAI;QAC/C,MAAM,aAAa,OAAO,eAAe,IAAI;QAE7C,IAAI,eAAe,GAAG;YACpB,iJAAK,CAAC,KAAK,CAAC;YACZ;QACF;QAEA,IAAI,cAAc,GAAG;YACnB,iJAAK,CAAC,KAAK,CAAC;YACZ;QACF;QAEA,MAAM,kBAAkB,MAAM,UAAU,IAAI;QAC5C,MAAM,+BAA+B,MAAM,UAAU,GAAG;QACxD,IAAI,cAAc,8BAA8B;YAC9C,iJAAK,CAAC,KAAK,CAAC,mDAAmD;gBAC7D,aAAa,CAAC,SAAS,EAAE,6BAA6B,cAAc,CAAC,SAAS,EAAE,CAAC;YACnF;YACA;QACF;QAEA,MAAM,iBAAiB,gJAAe,CAAC,QAAQ,GAAG,IAAI;QACtD,MAAM,iBAAiB,gJAAe,CAAC,QAAQ,GAAG,IAAI;QACtD,MAAM,yBAAyB,IAAA,4LAAgC,EAAC;QAChE,MAAM,eAAe,IAAA,6LAAgC,EAAC,QAAQ,gBAAgB,gBAAgB;QAC9F,MAAM,yBAAyB,aAAa,eAAe;QAE3D,IAAI,cAAc,aAAa,wBAAwB;YACrD,iJAAK,CAAC,KAAK,CAAC,oDAAoD;gBAC9D,aAAa,CAAC,SAAS,EAAE,uBAAuB,cAAc,CAAC,SAAS,EAAE,CAAC;YAC7E;YACA;QACF;QAEA,IAAI,CAAC,8BAA8B,CAAC,oBAAoB;YACtD,iJAAK,CAAC,KAAK,CAAC;YACZ;QACF;QAEA,IAAI,wBAAwB,eAAe,IAAI,CAAC,CAAA,IAAK,EAAE,QAAQ,KAAK,OAAO,qBAAqB;QAChG,IAAI,CAAC,uBAAuB;YAC1B,wBAAwB;QAC1B;QAEA,IAAI,CAAC,uBAAuB;YAC1B,iJAAK,CAAC,KAAK,CAAC;YACZ;QACF;QAEA,IAAI,CAAC,OAAO,eAAe,EAAE;YAC3B,iJAAK,CAAC,KAAK,CAAC;YACZ;QACF;QAEA,MAAM,MAAM,IAAI;QAChB,MAAM,SAAS,IAAA,qIAAa,EAAC,QAAQ,IAAI,WAAW;QACpD,MAAM,YAAY,OAAO,KAAK,IAAI,CAAC,mBAAmB,EAAE,YAAY;QAEpE,kCAAkC;QAClC,MAAM,wBAAmD;YACvD,IAAI,IAAA,kIAAY,EAAC;YACjB,MAAM;YACN,QAAQ;YACR,uBAAuB,IAAA,gIAAU,EAAC;YAClC,mBAAmB;YACnB,eAAe,SAAS,IAAI;YAC5B,aAAa,GAAG,UAAU,eAAe,EAAE,MAAM,EAAE,EAAE;YACrD,uBAAuB,IAAA,gIAAU,EAAC;YAClC,mBAAmB;YACnB,iBAAiB,IAAA,gIAAU,EAAC;YAC5B,4BAA4B,2BAA2B,QAAQ;YAC/D,wBAAwB,2BAA2B,IAAI;YACvD,gBAAgB,IAAA,gIAAU,EAAC,kBAAkB;YAC7C,YAAY,cAAc;YAC1B,QAAQ;YACR,UAAU;YACV,wBAAwB,IAAA,gIAAU,EAAC;YACnC,qBAAqB,MAAM,QAAQ;YACnC,oBAAoB;YACpB,kBAAkB;YAClB,cAAc,SAAS,IAAI;YAC3B,aAAa;YACb,WAAW,IAAA,gIAAU,EAAC;YACtB,WAAW;QACb;QAEA,MAAM,eAAe,WAAW;QAEhC,MAAM,wBAAwB,MAAM,QAAQ,IAAI,EAAE;QAClD,MAAM,oBAAoB;YACxB,UAAU,aAAa,QAAQ;YAC/B,IAAI,aAAa,EAAE;YACnB,MAAM,aAAa,IAAI;YACvB,QAAQ;YACR,QAAQ,CAAC;YACT,WAAW,aAAa,SAAS;YACjC,aAAa,CAAC,kBAAkB,EAAE,YAAY;YAC9C,wBAAwB;QAC1B;QAEA,YAAY,MAAM,QAAQ,EAAE;YAC1B,UAAU;mBAAI;gBAAuB;aAAkB;YACvD,YAAY,CAAC,MAAM,UAAU,IAAI,CAAC,IAAI;QACxC;QAEA,WACE,IAAA,gIAAU,EAAC,mBACX,CAAC,OAAO,EAAE,YAAY,cAAc,CAAC,SAAS,WAAW,EAAE,MAAM,EAAE,EAAE,EACrE,iBACA,CAAC,IAAI,EAAE,MAAM,EAAE,CAAC,eAAe,EAAE,MAAM,YAAY,EAAE,EACrD;YAAE,iBAAiB,aAAa,QAAQ;YAAE,qBAAqB,MAAM,QAAQ;QAAC;QAGhF,+BAA+B;QAC/B,MAAM,cAAyC;YAC7C,IAAI,IAAA,kIAAY,EAAC;YACjB,MAAM;YACN,QAAQ;YACR,uBAAuB,IAAA,gIAAU,EAAC;YAClC,mBAAmB;YACnB,eAAe,SAAS,IAAI;YAC5B,aAAa,GAAG,UAAU,gBAAgB,CAAC;YAC3C,uBAAuB,sBAAsB,QAAQ;YACrD,mBAAmB,sBAAsB,IAAI;YAC7C,iBAAiB,IAAA,gIAAU,EAAC,OAAO,eAAe,IAAI;YACtD,4BAA4B,mBAAmB,QAAQ;YACvD,wBAAwB,mBAAmB,IAAI;YAC/C,gBAAgB,IAAA,gIAAU,EAAC,kBAAkB;YAC7C,YAAY,cAAc;YAC1B,QAAQ;YACR,UAAU;YACV,wBAAwB,IAAA,gIAAU,EAAC;YACnC,oBAAoB;YACpB,kBAAkB;YAClB,cAAc,SAAS,IAAI;YAC3B,aAAa;YACb,WAAW,IAAA,gIAAU,EAAC;YACtB,WAAW;QACb;QAEA,MAAM,oBAAoB,WAAW;QAErC,WACE,IAAA,gIAAU,EAAC,mBACX,CAAC,IAAI,EAAE,WAAW,cAAc,CAAC,SAAS,YAAY,CAAC,EACvD,iBACA,GAAG,sBAAsB,IAAI,CAAC,GAAG,EAAE,WAAW,cAAc,CAAC,SAAS,EAAE,CAAC,EACzE;YAAE,iBAAiB,kBAAkB,QAAQ;QAAC;QAGhD,MAAM,oBAA6C;YACjD;gBACE,MAAM;gBACN,QAAQ;gBACR,QAAQ;gBACR,qBAAqB,MAAM,QAAQ;gBACnC,kBAAkB,aAAa,QAAQ;gBACvC,OAAO,CAAC,YAAY,EAAE,MAAM,EAAE,EAAE;gBAChC,WAAW;gBACX,aAAa;YACf;YACA;gBACE,MAAM,2BAA2B;gBACjC,QAAQ;gBACR,QAAQ;gBACR,kBAAkB,kBAAkB,QAAQ;gBAC5C,OAAO,GAAG,sBAAsB,IAAI,CAAC,GAAG,EAAE,WAAW;gBACrD,WAAW;gBACX,aAAa,kBAAkB,MAAM,KAAK,cAAc,SAAS;YACnE;SACD;QAED,IAAA,uLAA+B,EAAC;YAC9B;YACA,gBAAgB;YAChB,aAAa;YACb,SAAS;QACX;QAEA,0BAA0B;QAC1B,iJAAK,CAAC,OAAO,CAAC,8BAA8B;YAC1C,aAAa,CAAC,IAAI,EAAE,YAAY,cAAc,CAAC,SAAS,OAAO,EAAE,MAAM,EAAE,CAAC,OAAO,EAAE,WAAW,cAAc,CAAC,SAAS,EAAE,CAAC;YACzH,QAAQ;gBACN,OAAO;gBACP,SAAS,IAAM,OAAO,IAAI,CAAC,CAAC,UAAU,EAAE,kBAAkB,QAAQ,EAAE;YACtE;QACF;IACF;IAEA,MAAM,WAAW,OAAO;QACtB,IAAI;YACF,IAAI,OAAO,cAAc,KAAK,SAAS;gBACrC,MAAM,sBAAsB;gBAC5B,QAAQ;gBACR;YACF;YAEA,MAAM,MAAM,IAAI;YAEhB,IAAI,CAAC,QAAQ;gBACX,iJAAK,CAAC,KAAK,CAAC;gBACZ;YACF;YAEA,MAAM,yBAAyB,IAAA,4LAAgC,EAAC;YAChE,MAAM,eAAe,IAAA,6LAAgC,EAAC,QAAQ,UAAU,UAAU;YAClF,MAAM,yBAAyB,aAAa,eAAe;YAE3D,QAAQ,GAAG,CAAC,2BAA2B;gBACrC;gBACA,eAAe,aAAa,gBAAgB,CAAC,MAAM,CAAC,CAAC,KAAK,IAAM,EAAE,MAAM,KAAK,cAAc,MAAM,EAAE,MAAM,GAAG,KAAK;gBACjH,eAAe,aAAa,gBAAgB,CAAC,MAAM,CAAC,CAAC,KAAK,IAAM,EAAE,MAAM,KAAK,cAAc,MAAM,EAAE,MAAM,GAAG,KAAK;gBACjH;gBACA,iBAAiB,OAAO,MAAM;gBAC9B,YAAY,OAAO,MAAM,GAAG;YAC9B;YAEA,qDAAqD;YACrD,IAAI,OAAO,MAAM,GAAG,wBAAwB;gBAC1C,MAAM,YAAY,yBAAyB;gBAC3C,iJAAK,CAAC,KAAK,CAAC,8DAA8D;oBACxE,aAAa,CAAC,QAAQ,EAAE,UAAU,cAAc,CAAC,SAAS,aAAa,EAAE,uBAAuB,cAAc,CAAC,SAAS,EAAE,CAAC;oBAC3H,UAAU;gBACZ;gBACA;YACF;YAEA,6DAA6D;YAC7D,IAAI,cAAc;YAClB,IAAI,wBAAwB,eAAe,IAAI,CAAC,CAAA,IAAK,EAAE,QAAQ,KAAK,OAAO,qBAAqB;YAChG,IAAI;YAEJ,IAAI,OAAO,cAAc,KAAK,mBAAmB;gBAC/C,6CAA6C;gBAC7C,cAAc;gBACd,sBAAsB,OAAO,eAAe;gBAE5C,IAAI,CAAC,qBAAqB;oBACxB,iJAAK,CAAC,KAAK,CAAC;oBACZ;gBACF;gBAEA,0EAA0E;gBAC1E,IAAI,eAAe;oBACjB,MAAM,kBAAkB,cAAc,UAAU,IAAI;oBACpD,MAAM,uBAAuB,cAAc,UAAU,GAAG;oBACxD,IAAI,OAAO,MAAM,GAAG,sBAAsB;wBACxC,iJAAK,CAAC,KAAK,CAAC,8CAA8C;4BACxD,aAAa,CAAC,SAAS,EAAE,qBAAqB,cAAc,CAAC,SAAS,EAAE,CAAC;4BACzE,UAAU;wBACZ;wBACA;oBACF;gBACF;YACF;YAEA,aAAa;YACb,IAAI,CAAC,aAAa;gBAChB,iJAAK,CAAC,KAAK,CAAC;gBACZ;YACF;YAEA,IAAI,CAAC,uBAAuB;gBAC1B,wBAAwB;YAC1B;YAEA,IAAI,CAAC,uBAAuB;gBAC1B,iJAAK,CAAC,KAAK,CAAC;gBACZ;YACF;YAEA,sCAAsC;YACtC,IAAI,OAAO,cAAc,KAAK,oBAAoB,CAAC,OAAO,eAAe,EAAE;gBACzE,iJAAK,CAAC,KAAK,CAAC;gBACZ;YACF;YAEA,MAAM,uBAAuC,OAAO,cAAc,KAAK,oBACnE,oBACA,2BAA2B;YAE/B,MAAM,UAAqC;gBACzC,IAAI,IAAA,kIAAY,EAAC;gBACjB,MAAM,IAAA,qIAAa,EAAC,QAAQ,IAAI,WAAW;gBAC3C,QAAQ,OAAO,MAAM;gBAErB,+BAA+B;gBAC/B,uBAAuB,IAAA,gIAAU,EAAC;gBAClC,mBAAmB;gBACnB,eAAe,SAAS,IAAI;gBAC5B,mBAAmB;gBAEnB,aAAa,OAAO,KAAK,IAAI,CAAC,mBAAmB,EAAE,YAAY;gBAE/D,iCAAiC;gBACjC,uBAAuB,sBAAsB,QAAQ;gBACrD,mBAAmB,sBAAsB,IAAI;gBAE7C,iCAAiC;gBACjC,iBAAiB,IAAA,gIAAU,EAAC,OAAO,eAAe,IAAI;gBACtD,4BAA4B,YAAY,QAAQ;gBAChD,wBAAwB,YAAY,IAAI;gBAExC,cAAc;gBACd,gBAAgB,IAAA,gIAAU,EAAC,kBAAkB;gBAC7C,YAAY,cAAc;gBAE1B,oBAAoB;gBACpB,QAAQ;gBACR,UAAU;gBAEV,8BAA8B;gBAC9B,wBAAwB,IAAA,gIAAU,EAAC;gBACnC,qBAAqB,sBAAsB,IAAA,gIAAU,EAAC,uBAAuB;gBAC7E,oBAAoB;gBACpB,kBAAkB;gBAClB,cAAc,SAAS,IAAI;gBAE3B,YAAY;gBACZ,aAAa;gBAEb,WAAW,IAAA,gIAAU,EAAC;gBACtB,WAAW,IAAA,qIAAa,EAAC,QAAQ,IAAI,WAAW;YAClD;YAEA,MAAM,aAAa,WAAW;YAE9B,+DAA+D;YAC/D,0CAA0C;YAC1C,+DAA+D;YAC/D,IAAI,qBAAqB;gBACvB,MAAM,QAAQ,OAAO,IAAI,CAAC,CAAA,IAAK,EAAE,QAAQ,KAAK;gBAC9C,IAAI,OAAO;oBACT,6BAA6B;oBAC7B,MAAM,eAAe;wBACnB,UAAU,WAAW,QAAQ;wBAC7B,IAAI,WAAW,EAAE;wBACjB,MAAM,WAAW,IAAI;wBACrB,QAAQ,uBAAuB,QAAQ;wBACvC,QAAQ,CAAC,OAAO,MAAM;wBACtB,WAAW,WAAW,SAAS;wBAC/B,aAAa,CAAC,kBAAkB,EAAE,YAAY;wBAC9C,wBAAwB;oBAC1B;oBAEA,oDAAoD;oBACpD,MAAM,kBAAkB;2BAAI,MAAM,QAAQ;wBAAE;qBAAa;oBACzD,MAAM,gBAAgB,CAAC,MAAM,UAAU,IAAI,CAAC,IAAI,OAAO,MAAM;oBAE7D,YAAY,qBAAqB;wBAC/B,UAAU;wBACV,YAAY;oBACd;gBACF;YACF;YAEA,uCAAuC;YACvC,MAAM,kBAAkB,OAAO,cAAc,KAAK,oBAC9C,CAAC,kBAAkB,EAAE,YAAY,IAAI,CAAC,CAAC,CAAC,GACxC,GAAG,sBAAsB,IAAI,CAAC,EAAE,EAAE,YAAY,IAAI,CAAC,CAAC,CAAC;YAEzD,WACE,IAAA,gIAAU,EAAC,mBACX,CAAC,cAAc,EAAE,WAAW,EAAE,EAAE,EAChC,iBACA,CAAC,SAAS,EAAE,OAAO,MAAM,CAAC,cAAc,CAAC,SAAS,iBAAiB,EAAE,iBAAiB,EACtF;gBAAE,iBAAiB,WAAW,QAAQ;YAAC,EAAE,8BAA8B;;YAGzE,IAAA,uLAA+B,EAAC;gBAC9B;gBACA,gBAAgB;gBAChB,aAAa;gBACb,SAAS;oBAAC;wBACR,MAAM;wBACN,QAAQ,OAAO,MAAM;wBACrB,QAAQ;wBACR,kBAAkB,WAAW,QAAQ;wBACrC,qBAAqB,sBAAsB,IAAA,gIAAU,EAAC,uBAAuB;wBAC7E,OAAO;wBACP,WAAW,WAAW,SAAS;wBAC/B,aAAa,WAAW,MAAM,KAAK,cAAc,WAAW,SAAS,GAAG;oBAC1E;iBAAE;YACJ;YAEA,iJAAK,CAAC,OAAO,CAAC,CAAC,iBAAiB,EAAE,WAAW,EAAE,EAAE,EAAE;gBACjD,aAAa,CAAC,cAAc,EAAE,OAAO,MAAM,CAAC,cAAc,CAAC,SAAS,GAAG,CAAC;gBACxE,QAAQ;oBACN,OAAO;oBACP,SAAS,IAAM,OAAO,IAAI,CAAC,CAAC,UAAU,EAAE,WAAW,QAAQ,EAAE;gBAC/D;YACF;YAEA,QAAQ;QACV,EAAE,OAAO,OAAO;YACd,QAAQ,KAAK,CAAC,mCAAmC;YACjD,iJAAK,CAAC,KAAK,CAAC;QACd;IACF;IAEA,qBACE,8OAAC,qIAAM;QAAC,MAAM;QAAM,cAAc;;0BAChC,8OAAC,4IAAa;gBAAC,OAAO;0BACpB,cAAA,8OAAC,qIAAM;oBACL,SAAQ;oBACR,MAAK;oBACL,WAAU;8BACX;;;;;;;;;;;0BAKH,8OAAC,4IAAa;gBAAC,WAAU;;kCACvB,8OAAC,2IAAY;kCACX,cAAA,8OAAC,0IAAW;sCAAC;;;;;;;;;;;kCAGf,8OAAC;wBAAK,UAAU,aAAa;wBAAW,WAAU;;4BAE/C,CAAC,CAAC,sBAAsB,CAAC,0BAA0B,mBAClD,8OAAC,mIAAK;gCAAC,SAAQ;;kDACb,8OAAC,mOAAW;wCAAC,WAAU;;;;;;kDACvB,8OAAC,8IAAgB;;0DACf,8OAAC;0DAAO;;;;;;4CAAwB;0DACnB,8OAAC;;oDAAO;oDAAS;oDAAI;;;;;;;4CAAwB;0DAC1D,8OAAC;gDAAG,WAAU;;oDACX,CAAC,oCAAsB,8OAAC;;0EAAG,8OAAC;0EAAO;;;;;;4DAAoB;;;;;;;oDACvD,CAAC,4CAA8B,8OAAC;;0EAAG,8OAAC;0EAAO;;;;;;4DAAuB;;;;;;;;;;;;;;;;;;;;;;;;;0CAO3E,8OAAC,mIAAK;;kDACJ,8OAAC,mOAAW;wCAAC,WAAU;;;;;;kDACvB,8OAAC,8IAAgB;wCAAC,WAAU;;0DAC1B,8OAAC;gDAAI,WAAU;;kEACb,8OAAC;wDAAK,WAAU;kEAAc;;;;;;kEAC9B,8OAAC;wDAAK,WAAU;kEAAa;;;;;;;;;;;;0DAE/B,8OAAC;gDAAI,WAAU;;kEACb,8OAAC;wDAAK,WAAU;kEAAc;;;;;;kEAC9B,8OAAC;;4DAAM,SAAS,IAAI;4DAAC;4DAAI,SAAS,KAAK;;;;;;;;;;;;;0DAEzC,8OAAC;gDAAI,WAAU;;kEACb,8OAAC;wDAAK,WAAU;kEAAc;;;;;;kEAC9B,8OAAC;wDAAK,WAAU;;4DAA8B,sBAAsB,cAAc,CAAC;4DAAS;;;;;;;;;;;;;;;;;;;;;;;;;0CAOlG,8OAAC;gCAAI,WAAU;;kDACb,8OAAC,mIAAK;wCAAC,SAAQ;kDAAiB;;;;;;kDAChC,8OAAC,4KAAU;wCACT,MAAK;wCACL,SAAS;wCACT,QAAQ,CAAC,EAAE,KAAK,EAAE,iBAChB,8OAAC,qIAAM;gDAAC,OAAO,MAAM,KAAK;gDAAE,eAAe,MAAM,QAAQ;;kEACvD,8OAAC,4IAAa;wDAAC,IAAG;kEAChB,cAAA,8OAAC,0IAAW;;;;;;;;;;kEAEd,8OAAC,4IAAa;;0EACZ,8OAAC,yIAAU;gEAAC,OAAM;0EAAiB;;;;;;0EACnC,8OAAC,yIAAU;gEAAC,OAAM;0EAAkB;;;;;;0EACpC,8OAAC,yIAAU;gEAAC,OAAM;0EAAQ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;4BAQnC,CAAC,mBAAmB,oBAAoB,mBAAmB,OAAO,mBACjE;;kDACE,8OAAC;wCAAI,WAAU;;0DACb,8OAAC,mIAAK;gDAAC,SAAQ;0DAAwB;;;;;;0DACvC,8OAAC,4KAAU;gDACT,MAAK;gDACL,SAAS;gDACT,OAAO;oDAAE,UAAU,mBAAmB,oBAAoB,mBAAmB;gDAAQ;gDACrF,QAAQ,CAAC,EAAE,KAAK,EAAE,iBAChB,8OAAC,qIAAM;wDAAC,OAAO,MAAM,KAAK;wDAAE,eAAe,MAAM,QAAQ;;0EACvD,8OAAC,4IAAa;gEAAC,IAAG;0EAChB,cAAA,8OAAC,0IAAW;oEAAC,aAAY;;;;;;;;;;;0EAE3B,8OAAC,4IAAa;0EACX,eAAe,MAAM,CAAC,CAAA,IAAK,EAAE,QAAQ,EAAE,GAAG,CAAC,CAAC,uBAC3C,8OAAC,yIAAU;wEAAuB,OAAO,OAAO,QAAQ;kFACtD,cAAA,8OAAC;4EAAI,WAAU;sFACb,cAAA,8OAAC;0FAAM,OAAO,IAAI;;;;;;;;;;;uEAFL,OAAO,QAAQ;;;;;;;;;;;;;;;;;;;;;0DAU1C,8OAAC;gDAAE,WAAU;0DAAgC;;;;;;;;;;;;kDAM/C,8OAAC;wCAAI,WAAU;;0DACb,8OAAC,mIAAK;gDAAC,SAAQ;0DAAkB;;;;;;0DACjC,8OAAC,4KAAU;gDACT,MAAK;gDACL,SAAS;gDACT,OAAO;oDAAE,UAAU,mBAAmB,oBAAoB,mBAAmB;gDAAQ;gDACrF,QAAQ,CAAC,EAAE,KAAK,EAAE,iBAChB,8OAAC,qIAAM;wDAAC,OAAO,MAAM,KAAK;wDAAE,eAAe,MAAM,QAAQ;;0EACvD,8OAAC,4IAAa;gEAAC,IAAG;0EAChB,cAAA,8OAAC,0IAAW;oEAAC,aAAY;;;;;;;;;;;0EAE3B,8OAAC,4IAAa;0EACX,iBAAiB,MAAM,KAAK,kBAC3B,8OAAC;oEAAI,WAAU;8EAAgD;;;;;6EAI/D,iBAAiB,GAAG,CAAC,CAAC,wBACpB,8OAAC,yIAAU;wEAAwB,OAAO,QAAQ,QAAQ;kFACxD,cAAA,8OAAC;4EAAI,WAAU;sFACb,cAAA,8OAAC;0FAAM,QAAQ,IAAI;;;;;;;;;;;uEAFN,QAAQ,QAAQ;;;;;;;;;;;;;;;;;;;;;0DAW7C,8OAAC;gDAAE,WAAU;0DACV,uBAAuB,SAAS,aAC7B,oCACA;;;;;;;;;;;;;;4BAOX,CAAC,mBAAmB,qBAAqB,mBAAmB,OAAO,mBAClE,8OAAC;gCAAI,WAAU;;kDACb,8OAAC,mIAAK;wCAAC,SAAQ;kDAAkB;;;;;;kDACjC,8OAAC;wCAAI,WAAU;kDAAqC;;;;;;kDAIpD,8OAAC,mKAAmB;wCAClB,SAAS;wCACT,OAAO;wCACP,UAAU,CAAC,SAAW,SAAS,mBAAmB,QAAQ,SAAS;wCACnE,gBAAgB,CAAC,QAAU,oBAAoB;wCAC/C,aAAY;wCACZ,mBAAkB;wCAClB,kBACE,mBACI,oCACA;wCAEN,WAAW;wCACX,iBAAiB;wCACjB,qBAAqB;wCACrB,WAAW;;;;;;kDAEb,8OAAC;wCAAE,WAAU;;4CAAgC;0DACrB,8OAAC;0DAAO;;;;;;4CAAsB;0DAAI,8OAAC;0DAAO;;;;;;4CAA6B;;;;;;;;;;;;;4BAKlG,+CACC,8OAAC,mIAAK;gCAAC,WAAU;0CACf,cAAA,8OAAC;oCAAI,WAAU;;sDACb,8OAAC,yOAAa;4CAAC,WAAU;;;;;;sDACzB,8OAAC;4CAAI,WAAU;;8DACb,8OAAC;oDAAE,WAAU;;wDAAc;wDAAK,eAAe;wDAAG;;;;;;;8DAClD,8OAAC;oDAAE,WAAU;;wDAAU;sEACf,8OAAC;;gEAAQ,eAAe,cAAc,CAAC;gEAAS;;;;;;;wDAAW;;;;;;;8DAEnE,8OAAC,qIAAM;oDACL,MAAK;oDACL,MAAK;oDACL,SAAQ;oDACR,WAAU;oDACV,SAAS,IAAM,0BAA0B;8DAC1C;;;;;;;;;;;;;;;;;;;;;;;0CAQT,8OAAC;gCAAI,WAAU;;kDACb,8OAAC,mIAAK;wCAAC,SAAQ;kDAAS;;;;;;kDACxB,8OAAC,4KAAU;wCACT,MAAK;wCACL,SAAS;wCACT,OAAO;4CACL,UAAU;4CACV,KAAK;gDAAE,OAAO;gDAAG,SAAS;4CAAyB;4CACnD,KAAK;gDACH,OAAO;gDACP,SAAS,mBAAmB,qBAAqB,gBAC7C,CAAC;oDACC,MAAM,kBAAkB,cAAc,UAAU,IAAI;oDACpD,MAAM,uBAAuB,cAAc,UAAU,GAAG;oDACxD,OAAO,CAAC,0DAA0D,EAAE,qBAAqB,cAAc,CAAC,SAAS,GAAG,CAAC;gDACvH,CAAC,MACD,CAAC,4BAA4B,EAAE,sBAAsB,cAAc,CAAC,SAAS,EAAE,CAAC;4CACtF;wCACF;wCACA,QAAQ,CAAC,EAAE,KAAK,EAAE,UAAU,EAAE,iBAC5B,8OAAC;gDAAI,WAAU;;kEACb,8OAAC,uJAAa;wDACZ,OAAO,MAAM,KAAK;wDAClB,UAAU,MAAM,QAAQ;wDACxB,UAAU,mBAAmB;wDAC7B,aAAY;;;;;;oDAEb,WAAW,KAAK,kBACf,8OAAC;wDAAE,WAAU;kEAA4B,WAAW,KAAK,CAAC,OAAO;;;;;;kEAEnE,8OAAC;wDAAE,WAAU;kEACV,mBAAmB,qBAAqB,8BACvC;sEACG,CAAC;gEACA,MAAM,kBAAkB,cAAc,UAAU,IAAI;gEACpD,MAAM,uBAAuB,cAAc,UAAU,GAAG;gEACxD,MAAM,aAAa,KAAK,GAAG,CAAC,uBAAuB;gEAEnD,qBACE;;wEAAE;wEACiB,WAAW,cAAc,CAAC;wEAAS;wEACnD,kBAAkB,mBACjB,8OAAC;4EAAK,WAAU;;gFACb;gFAAI;gFAAU,gBAAgB,cAAc,CAAC;gFAAS;gFAAM,cAAc,UAAU,CAAC,cAAc,CAAC;gFAAS;;;;;;;;;4DAKxH,CAAC;4EAED,mBAAmB,UACrB,CAAC,kBAAkB,EAAE,CAAC,mBAAmB,CAAC,EAAE,cAAc,CAAC,SAAS,2BAA2B,CAAC,GAEhG,CAAC,gBAAgB,EAAE,sBAAsB,cAAc,CAAC,SAAS,EAAE,CAAC;;;;;;;;;;;;;;;;;;;;;;;4BAQ/E,mBAAmB,yBAClB,8OAAC;gCAAI,WAAU;;kDACb,8OAAC;wCAAI,WAAU;kDAAsB;;;;;;kDACrC,8OAAC;wCAAI,WAAU;;4CAAgC;0DAC9B,8OAAC;;oDAAQ,sBAAsB,cAAc,CAAC;oDAAS;;;;;;;4CAAW;;;;;;;kDAEnF,8OAAC;wCAAI,WAAU;;0DACb,8OAAC;gDAAI,WAAU;;kEACb,8OAAC,mIAAK;kEAAC;;;;;;kEACP,8OAAC,uJAAa;wDACZ,OAAO,oBAAoB;wDAC3B,UAAU,CAAC,QAAU,SAAS,oBAAoB,SAAS,GAAG;gEAAE,gBAAgB;gEAAM,aAAa;4DAAK;wDACxG,KAAK;wDACL,KAAK;;;;;;kEAEP,8OAAC;wDAAE,WAAU;;4DAAgC;4DAClC,qBAAqB,cAAc,CAAC;4DAAS;;;;;;;;;;;;;0DAG1D,8OAAC;gDAAI,WAAU;;kEACb,8OAAC,mIAAK;kEAAC;;;;;;kEACP,8OAAC;wDAAI,WAAU;;4DACZ,CAAC,mBAAmB,CAAC,EAAE,cAAc,CAAC;4DAAS;;;;;;;kEAElD,8OAAC;wDAAE,WAAU;kEAAgC;;;;;;;;;;;;;;;;;;;;;;;;0CAOrD,8OAAC;gCAAI,WAAU;;kDACb,8OAAC,mIAAK;wCAAC,SAAQ;kDAAQ;;;;;;kDACvB,8OAAC,4KAAU;wCACT,MAAK;wCACL,SAAS;wCACT,QAAQ,CAAC,EAAE,KAAK,EAAE,iBAChB,8OAAC,yIAAQ;gDACN,GAAG,KAAK;gDACT,IAAG;gDACH,aAAY;gDACZ,MAAM;;;;;;;;;;;;;;;;;0CAMd,8OAAC,2IAAY;;kDACX,8OAAC,qIAAM;wCAAC,MAAK;wCAAS,SAAQ;wCAAU,SAAS,IAAM,QAAQ;kDAAQ;;;;;;kDAGvE,8OAAC,qIAAM;wCAAC,MAAK;kDAAS;;;;;;;;;;;;;;;;;;;;;;;;0BAO5B,8OAAC,gNAAyB;gBACxB,MAAM;gBACN,cAAc;gBACd,aAAa;gBACb,aAAa;gBACb,gBAAgB;gBAChB,YAAY,eAAe;gBAC3B,eAAe;gBACf,kBAAkB;;;;;;;;;;;;AAI1B"}},
    {"offset": {"line": 6182, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/warranty/hooks/use-warranty-settlement.ts"],"sourcesContent":["import * as React from 'react';\r\nimport { useWarrantyStore } from '../store';\r\nimport { usePaymentStore } from '../../payments/store';\r\nimport { useReceiptStore } from '../../receipts/store';\r\nimport { calculateWarrantyProcessingState } from '../components/logic/processing';\r\nimport { calculateWarrantySettlementTotal } from '../utils/payment-calculations';\r\nimport type { SettlementMethod, WarrantySettlement, WarrantyTicket } from '../types';\r\nimport { asSystemId } from '@/lib/id-types';\r\n\r\nexport interface WarrantySettlementState {\r\n  ticket: WarrantyTicket | null;\r\n  totalPayment: number;\r\n  remainingAmount: number;\r\n  processingState: ReturnType<typeof calculateWarrantyProcessingState>;\r\n  settlementSnapshot: WarrantySettlement | null;\r\n  settlementMethods: SettlementMethod[];\r\n  snapshotSettledAmount: number;\r\n  snapshotRemainingAmount: number;\r\n}\r\n\r\ninterface WarrantySettlementOptions {\r\n  ticket?: WarrantyTicket | null;\r\n}\r\n\r\nexport function useWarrantySettlement(\r\n  warrantySystemId?: string | null,\r\n  options?: WarrantySettlementOptions,\r\n): WarrantySettlementState {\r\n  const { findById } = useWarrantyStore();\r\n  const payments = usePaymentStore(state => state.data);\r\n  const receipts = useReceiptStore(state => state.data);\r\n  const overrideTicket = options?.ticket ?? null;\r\n  const normalizedWarrantySystemId = React.useMemo(\r\n    () => (warrantySystemId ? asSystemId(warrantySystemId) : undefined),\r\n    [warrantySystemId],\r\n  );\r\n\r\n  const ticket = React.useMemo(() => {\r\n    if (overrideTicket) {\r\n      return overrideTicket;\r\n    }\r\n    if (!normalizedWarrantySystemId) return null;\r\n    return findById(normalizedWarrantySystemId) || null;\r\n  }, [findById, normalizedWarrantySystemId, overrideTicket]);\r\n\r\n  const fallbackTotalPayment = React.useMemo(() => calculateWarrantySettlementTotal(ticket), [ticket]);\r\n  const settlementSnapshot = ticket?.settlement ?? null;\r\n  const totalPayment = settlementSnapshot?.totalAmount ?? fallbackTotalPayment;\r\n\r\n  const settlementMethods = React.useMemo(() => {\r\n    if (!settlementSnapshot) {\r\n      return [];\r\n    }\r\n\r\n    if (settlementSnapshot.methods?.length) {\r\n      return [...settlementSnapshot.methods].sort((a, b) =>\r\n        new Date(a.createdAt).getTime() - new Date(b.createdAt).getTime(),\r\n      );\r\n    }\r\n\r\n    const fallbackType = settlementSnapshot.settlementType;\r\n    if (!fallbackType || fallbackType === 'mixed') {\r\n      return [];\r\n    }\r\n\r\n    const inferredMethod: SettlementMethod = {\r\n      systemId: asSystemId(`${settlementSnapshot.systemId}_fallback_method`),\r\n      type: fallbackType,\r\n      amount: Math.abs(settlementSnapshot.totalAmount ?? totalPayment),\r\n      status: settlementSnapshot.status,\r\n      paymentVoucherId: settlementSnapshot.paymentVoucherId,\r\n      debtTransactionId: settlementSnapshot.debtTransactionId,\r\n      voucherCode: settlementSnapshot.voucherCode,\r\n      linkedOrderSystemId: settlementSnapshot.linkedOrderSystemId,\r\n      notes: settlementSnapshot.notes,\r\n      createdAt: settlementSnapshot.createdAt,\r\n      completedAt: settlementSnapshot.settledAt,\r\n    };\r\n\r\n    return [inferredMethod];\r\n  }, [settlementSnapshot, totalPayment]);\r\n\r\n  const processingState = React.useMemo(() => {\r\n    return calculateWarrantyProcessingState(ticket, payments, receipts, totalPayment);\r\n  }, [ticket, payments, receipts, totalPayment]);\r\n\r\n  const snapshotSettledAmount = React.useMemo(() => {\r\n    if (settlementSnapshot?.settledAmount != null) {\r\n      return Math.abs(settlementSnapshot.settledAmount);\r\n    }\r\n\r\n    return settlementMethods\r\n      .filter(method => method.status === 'completed')\r\n      .reduce((sum, method) => sum + Math.abs(method.amount), 0);\r\n  }, [settlementMethods, settlementSnapshot]);\r\n\r\n  const snapshotRemainingAmount = React.useMemo(() => {\r\n    if (settlementSnapshot?.remainingAmount != null) {\r\n      return Math.abs(settlementSnapshot.remainingAmount);\r\n    }\r\n\r\n    return Math.max(Math.abs(totalPayment) - snapshotSettledAmount, 0);\r\n  }, [settlementSnapshot, snapshotSettledAmount, totalPayment]);\r\n\r\n  const remainingAmount = React.useMemo(() => {\r\n    if (settlementSnapshot) {\r\n      return snapshotRemainingAmount;\r\n    }\r\n    return Math.max(processingState.remainingAmount, 0);\r\n  }, [processingState.remainingAmount, settlementSnapshot, snapshotRemainingAmount]);\r\n\r\n  return {\r\n    ticket,\r\n    totalPayment,\r\n    remainingAmount,\r\n    processingState,\r\n    settlementSnapshot,\r\n    settlementMethods,\r\n    snapshotSettledAmount,\r\n    snapshotRemainingAmount,\r\n  };\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 6310, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/warranty/components/dialogs/warranty-receipt-voucher-dialog.tsx"],"sourcesContent":["/**\r\n * CreateReceiptVoucherDialog\r\n * \r\n * Dialog tạo phiếu thu (receipt voucher) từ warranty\r\n * - Thu thêm tiền từ khách (trường hợp đặc biệt)\r\n * - Nhập số tiền, lý do, phương thức thu\r\n */\r\n\r\nimport * as React from 'react';\r\nimport { useForm, Controller, type RegisterOptions } from 'react-hook-form';\r\nimport { useRouter } from 'next/navigation';\r\nimport {\r\n  Dialog,\r\n  DialogContent,\r\n  DialogHeader,\r\n  DialogTitle,\r\n  DialogFooter,\r\n  DialogTrigger,\r\n} from '../../../../components/ui/dialog';\r\nimport { Button } from '../../../../components/ui/button';\r\nimport { Label } from '../../../../components/ui/label';\r\nimport { Textarea } from '../../../../components/ui/textarea';\r\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '../../../../components/ui/select';\r\nimport { Alert, AlertDescription } from '../../../../components/ui/alert';\r\nimport { AlertCircle } from 'lucide-react';\r\nimport { toast } from 'sonner';\r\nimport { usePaymentStore } from '../../../payments/store';\r\nimport { useReceiptStore } from '../../../receipts/store';\r\nimport { useWarrantyStore } from '../../store';\r\nimport type { WarrantyVoucherDialogBaseProps } from '../../types';\r\nimport { useAuth } from '../../../../contexts/auth-context';\r\nimport { toISODateTime } from '../../../../lib/date-utils';\r\nimport type { Receipt } from '../../../receipts/types';\r\nimport { asBusinessId, asSystemId } from '../../../../lib/id-types';\r\nimport { calculateWarrantyProcessingState } from '../logic/processing';\r\nimport { calculateWarrantySettlementTotal } from '../../utils/payment-calculations';\r\nimport { useWarrantySettlement } from '../../hooks/use-warranty-settlement';\r\nimport { CurrencyInput } from '../../../../components/ui/currency-input';\r\n\r\ninterface WarrantyReceiptVoucherDialogProps extends WarrantyVoucherDialogBaseProps {\r\n  existingReceipts?: Receipt[] | undefined;\r\n}\r\n\r\ninterface FormValues {\r\n  amount: number;\r\n  reason: string;\r\n  paymentMethod: 'Tiền mặt' | 'Chuyển khoản';\r\n  notes: string;\r\n}\r\n\r\nexport function WarrantyReceiptVoucherDialog({\r\n  warrantyId,\r\n  warrantySystemId,\r\n  customer,\r\n  defaultAmount = 0,\r\n  linkedOrderId,\r\n  branchSystemId,\r\n  branchName,\r\n  existingReceipts = [],\r\n}: WarrantyReceiptVoucherDialogProps) {\r\n  const [open, setOpen] = React.useState(false);\r\n  const router = useRouter();\r\n  \r\n  const { add: addReceipt } = useReceiptStore();\r\n  const { findById, addHistory } = useWarrantyStore();\r\n  const { employee: authEmployee } = useAuth();\r\n  const currentUserSystemId = authEmployee?.systemId ?? asSystemId('SYSTEM');\r\n  const currentUserName = authEmployee?.fullName || authEmployee?.id || 'Hệ thống';\r\n\r\n  const { remainingAmount: remainingAmountForReceipt } = useWarrantySettlement(warrantySystemId);\r\n\r\n  const amountValidationRules = React.useMemo<RegisterOptions<FormValues, 'amount'>>(() => {\r\n    const baseRules: RegisterOptions<FormValues, 'amount'> = {\r\n      required: 'Vui lòng nhập số tiền',\r\n      min: { value: 1, message: 'Số tiền phải lớn hơn 0' },\r\n    };\r\n\r\n    if (remainingAmountForReceipt > 0) {\r\n      baseRules.max = {\r\n        value: remainingAmountForReceipt,\r\n        message: `Số tiền không được vượt quá ${remainingAmountForReceipt.toLocaleString('vi-VN')} đ`,\r\n      };\r\n    }\r\n\r\n    return baseRules;\r\n  }, [remainingAmountForReceipt]);\r\n\r\n  const { control, handleSubmit, watch, reset } = useForm<FormValues>({\r\n    defaultValues: {\r\n      amount: defaultAmount,\r\n      reason: 'Chi phí sửa chữa thêm',\r\n      paymentMethod: 'Tiền mặt',\r\n      notes: `Thu thêm từ bảo hành ${warrantyId}`,\r\n    },\r\n  });\r\n\r\n  const amount = watch('amount');\r\n\r\n  // Reset form when dialog opens\r\n  React.useEffect(() => {\r\n    if (open) {\r\n      reset({\r\n        amount: remainingAmountForReceipt || defaultAmount,\r\n        reason: 'Chi phí sửa chữa thêm',\r\n        paymentMethod: 'Tiền mặt',\r\n        notes: `Thu thêm từ bảo hành ${warrantyId}`,\r\n      });\r\n    }\r\n  }, [open, warrantyId, defaultAmount, remainingAmountForReceipt, reset]);\r\n\r\n  const onSubmit = (values: FormValues) => {\r\n    try {\r\n      const now = new Date();\r\n      const latestTicket = findById(asSystemId(warrantySystemId));\r\n      if (!latestTicket) {\r\n        toast.error('Không tìm thấy phiếu bảo hành');\r\n        return;\r\n      }\r\n\r\n      const latestPayments = usePaymentStore.getState().data;\r\n      const latestReceipts = useReceiptStore.getState().data;\r\n\r\n      const totalPaymentFromTicket = calculateWarrantySettlementTotal(latestTicket);\r\n\r\n      const currentState = calculateWarrantyProcessingState(latestTicket, latestPayments, latestReceipts, totalPaymentFromTicket);\r\n\r\n      if (totalPaymentFromTicket >= 0) {\r\n        toast.error('Phiếu này không cần thu thêm tiền');\r\n        return;\r\n      }\r\n\r\n      if (values.amount > currentState.remainingAmount) {\r\n        const collected = Math.abs(totalPaymentFromTicket) - currentState.remainingAmount;\r\n        toast.error('Số tiền không được vượt quá số tiền khách phải trả', {\r\n          description: `Đã thu: ${collected.toLocaleString('vi-VN')} đ • Còn lại: ${currentState.remainingAmount.toLocaleString('vi-VN')} đ`,\r\n          duration: 5000,\r\n        });\r\n        return;\r\n      }\r\n\r\n      const receipt: Omit<Receipt, 'systemId'> = {\r\n        id: asBusinessId(''), // Let store generate PT-XXXXXX ID\r\n        date: toISODateTime(now) || now.toISOString(),\r\n        amount: values.amount,\r\n        \r\n        // Payer info (TargetGroup)\r\n        payerTypeSystemId: asSystemId('KHACHHANG'), // TODO: Get KHACHHANG systemId from TargetGroup\r\n        payerTypeName: 'Khách hàng',\r\n        payerName: customer.name,\r\n        payerSystemId: undefined, // TODO: Get customer systemId if needed\r\n        \r\n        description: values.reason,\r\n        \r\n        // Payment Method - TODO: Get from settings\r\n        paymentMethodSystemId: asSystemId(''), // TODO: Get payment method systemId\r\n        paymentMethodName: values.paymentMethod,\r\n        \r\n        // Account & Type - TODO: Get from settings\r\n        accountSystemId: asSystemId(''), // TODO: Get default cash account\r\n        paymentReceiptTypeSystemId: asSystemId(''), // TODO: Get \"Thu thêm bảo hành\" type\r\n        paymentReceiptTypeName: 'Thu thêm bảo hành',\r\n        \r\n        // Branch info\r\n        branchSystemId: asSystemId(branchSystemId || ''),\r\n        branchName: branchName || '',\r\n        \r\n        // Status & Category\r\n        status: 'completed', // Receipt usually completed immediately\r\n        category: 'warranty_additional',\r\n        \r\n        // Links to warranty\r\n        linkedWarrantySystemId: asSystemId(warrantySystemId), // Link đến phiếu bảo hành\r\n        originalDocumentId: warrantyId ? asBusinessId(warrantyId) : undefined,\r\n        customerSystemId: undefined,\r\n        customerName: customer.name,\r\n        \r\n        // Financial\r\n        affectsDebt: false, // Không ảnh hưởng công nợ\r\n        \r\n        createdBy: asSystemId(currentUserSystemId),\r\n        createdAt: toISODateTime(now) || now.toISOString(),\r\n      };\r\n\r\n      const newReceipt = addReceipt(receipt);\r\n\r\n      // Add history to warranty với metadata\r\n      addHistory(\r\n        asSystemId(warrantySystemId),\r\n        `Tạo phiếu thu ${newReceipt.id}`,\r\n        currentUserName,\r\n        `Số tiền: ${values.amount.toLocaleString('vi-VN')}đ - Phương thức: ${values.paymentMethod}`,\r\n        { receiptSystemId: newReceipt.systemId } // ✅ Lưu systemId vào metadata\r\n      );\r\n\r\n      toast.success(`Đã tạo phiếu thu ${newReceipt.id}`, {\r\n        description: `Thu ${values.amount.toLocaleString('vi-VN')} đ từ ${customer.name}`,\r\n        action: {\r\n          label: 'Xem phiếu thu',\r\n          onClick: () => router.push(`/receipts/${newReceipt.systemId}`),\r\n        },\r\n      });\r\n\r\n      setOpen(false);\r\n    } catch (error) {\r\n      console.error('Error creating receipt voucher:', error);\r\n      toast.error('Không thể tạo phiếu thu');\r\n    }\r\n  };\r\n\r\n  return (\r\n    <Dialog open={open} onOpenChange={setOpen}>\r\n      <DialogTrigger asChild>\r\n        <Button \r\n          variant=\"default\" \r\n          size=\"lg\"\r\n          className=\"h-9 flex-1\"\r\n        >\r\n          Tạo phiếu thu\r\n        </Button>\r\n      </DialogTrigger>\r\n      \r\n      <DialogContent className=\"max-w-2xl max-h-[90vh] overflow-y-auto\">\r\n        <DialogHeader>\r\n          <DialogTitle>Tạo phiếu thu - Thu thêm từ khách</DialogTitle>\r\n        </DialogHeader>\r\n\r\n        <form onSubmit={handleSubmit(onSubmit)} className=\"space-y-4\">\r\n          {/* Warranty Info */}\r\n          <Alert>\r\n            <AlertCircle className=\"h-4 w-4\" />\r\n            <AlertDescription className=\"space-y-1\">\r\n              <div className=\"flex items-center gap-2\">\r\n                <span className=\"font-medium\">Phiếu bảo hành:</span>\r\n                <span className=\"font-mono\">{warrantyId}</span>\r\n              </div>\r\n              <div className=\"flex items-center gap-2\">\r\n                <span className=\"font-medium\">Khách hàng:</span>\r\n                <span>{customer.name} • {customer.phone}</span>\r\n              </div>\r\n            </AlertDescription>\r\n          </Alert>\r\n\r\n          {/* Amount */}\r\n          <div className=\"space-y-2\">\r\n            <Label htmlFor=\"amount\">Số tiền thu *</Label>\r\n            <Controller\r\n              name=\"amount\"\r\n              control={control}\r\n              rules={amountValidationRules}\r\n              render={({ field, fieldState }) => (\r\n                <div className=\"space-y-1\">\r\n                  <CurrencyInput\r\n                    id=\"amount\"\r\n                    value={field.value}\r\n                    onChange={field.onChange}\r\n                    placeholder=\"Nhập số tiền cần thu thêm\"\r\n                  />\r\n                  {fieldState.error && (\r\n                    <p className=\"text-xs text-destructive\">{fieldState.error.message}</p>\r\n                  )}\r\n                </div>\r\n              )}\r\n            />\r\n            <p className=\"text-xs text-muted-foreground\">\r\n              {amount > 0 ? `Đã nhập: ${amount.toLocaleString('vi-VN')} đ` : 'Chưa nhập số tiền'}\r\n            </p>\r\n            {remainingAmountForReceipt > 0 && (\r\n              <p className=\"text-xs text-muted-foreground\">\r\n                Có thể thu tối đa: {remainingAmountForReceipt.toLocaleString('vi-VN')} đ\r\n              </p>\r\n            )}\r\n          </div>\r\n\r\n          {/* Reason */}\r\n          <div className=\"space-y-2\">\r\n            <Label htmlFor=\"reason\">Lý do thu thêm *</Label>\r\n            <Controller\r\n              name=\"reason\"\r\n              control={control}\r\n              rules={{ required: true }}\r\n              render={({ field }) => (\r\n                <Select value={field.value} onValueChange={field.onChange}>\r\n                  <SelectTrigger id=\"reason\">\r\n                    <SelectValue />\r\n                  </SelectTrigger>\r\n                  <SelectContent>\r\n                    <SelectItem value=\"Chi phí sửa chữa thêm\">Chi phí sửa chữa thêm</SelectItem>\r\n                    <SelectItem value=\"Chi phí linh kiện\">Chi phí linh kiện</SelectItem>\r\n                    <SelectItem value=\"Phí dịch vụ\">Phí dịch vụ</SelectItem>\r\n                    <SelectItem value=\"Bù trừ thiếu hụt\">Bù trừ thiếu hụt</SelectItem>\r\n                    <SelectItem value=\"Khác\">Khác</SelectItem>\r\n                  </SelectContent>\r\n                </Select>\r\n              )}\r\n            />\r\n          </div>\r\n\r\n          {/* Payment Method */}\r\n          <div className=\"space-y-2\">\r\n            <Label htmlFor=\"paymentMethod\">Phương thức thu *</Label>\r\n            <Controller\r\n              name=\"paymentMethod\"\r\n              control={control}\r\n              render={({ field }) => (\r\n                <Select value={field.value} onValueChange={field.onChange}>\r\n                  <SelectTrigger id=\"paymentMethod\">\r\n                    <SelectValue />\r\n                  </SelectTrigger>\r\n                  <SelectContent>\r\n                    <SelectItem value=\"Tiền mặt\">Tiền mặt</SelectItem>\r\n                    <SelectItem value=\"Chuyển khoản\">Chuyển khoản</SelectItem>\r\n                  </SelectContent>\r\n                </Select>\r\n              )}\r\n            />\r\n          </div>\r\n\r\n          {/* Notes */}\r\n          <div className=\"space-y-2\">\r\n            <Label htmlFor=\"notes\">Ghi chú</Label>\r\n            <Controller\r\n              name=\"notes\"\r\n              control={control}\r\n              render={({ field }) => (\r\n                <Textarea\r\n                  {...field}\r\n                  id=\"notes\"\r\n                  placeholder=\"Thêm ghi chú cho phiếu thu...\"\r\n                  rows={3}\r\n                />\r\n              )}\r\n            />\r\n          </div>\r\n\r\n          {/* Info */}\r\n          <Alert className=\"border-blue-200 bg-blue-50\">\r\n            <AlertCircle className=\"h-4 w-4 text-blue-600\" />\r\n            <AlertDescription className=\"text-blue-800 text-sm\">\r\n              💡 <strong>Lưu ý:</strong> Phiếu thu dùng khi khách hàng phải bù thêm chi phí (sản phẩm hỏng nặng, cần sửa chữa thêm, v.v.)\r\n            </AlertDescription>\r\n          </Alert>\r\n\r\n          <DialogFooter>\r\n            <Button type=\"button\" variant=\"outline\" onClick={() => setOpen(false)}>\r\n              Hủy\r\n            </Button>\r\n            <Button type=\"submit\">\r\n              Tạo phiếu thu\r\n            </Button>\r\n          </DialogFooter>\r\n        </form>\r\n      </DialogContent>\r\n    </Dialog>\r\n  );\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 6972, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/warranty/components/dialogs/warranty-reopen-from-cancelled-dialog.tsx"],"sourcesContent":["/**\r\n * Reopen From Cancelled Dialog\r\n * Dialog để mở lại phiếu bảo hành từ trạng thái đã hủy\r\n */\r\n\r\nimport * as React from 'react';\r\nimport { toast } from 'sonner';\r\nimport {\r\n  AlertDialog,\r\n  AlertDialogAction,\r\n  AlertDialogCancel,\r\n  AlertDialogContent,\r\n  AlertDialogDescription,\r\n  AlertDialogFooter,\r\n  AlertDialogHeader,\r\n  AlertDialogTitle,\r\n} from '../../../../components/ui/alert-dialog';\r\nimport { Textarea } from '../../../../components/ui/textarea';\r\nimport type { WarrantyTicket, WarrantyHistory } from '../../types';\r\nimport { useWarrantyStore } from '../../store';\r\nimport { useProductStore } from '../../../products/store';\r\nimport { useAuth } from '../../../../contexts/auth-context';\r\nimport { toISODateTime, getCurrentDate } from '../../../../lib/date-utils';\r\nimport { asSystemId, type SystemId } from '../../../../lib/id-types';\r\nimport { getMaxSystemIdCounter } from '../../../../lib/id-utils';\r\n\r\ninterface WarrantyReopenFromCancelledDialogProps {\r\n  open: boolean;\r\n  onOpenChange: (open: boolean) => void;\r\n  ticket: WarrantyTicket | null;\r\n}\r\n\r\nconst HISTORY_ID_PREFIX = 'WARRANTYHISTORY';\r\n\r\nconst generateHistorySystemId = (historyEntries: WarrantyHistory[] = []): SystemId => {\r\n  const latestCounter = getMaxSystemIdCounter(historyEntries, HISTORY_ID_PREFIX);\r\n  return asSystemId(`${HISTORY_ID_PREFIX}${String(latestCounter + 1).padStart(6, '0')}`);\r\n};\r\n\r\nexport function WarrantyReopenFromCancelledDialog({ open, onOpenChange, ticket }: WarrantyReopenFromCancelledDialogProps) {\r\n  const [reopenReason, setReopenReason] = React.useState('');\r\n  const { user, employee } = useAuth();\r\n  const performerName = employee?.fullName ?? user?.name ?? 'Hệ thống';\r\n  const performerSystemId = employee?.systemId ?? user?.employeeId;\r\n  const { update, findById } = useWarrantyStore();\r\n\r\n  const handleReopen = React.useCallback(() => {\r\n    if (!ticket || !reopenReason.trim()) {\r\n      toast.error('Vui lòng nhập lý do mở lại phiếu');\r\n      return;\r\n    }\r\n\r\n    try {\r\n      // ✅ RE-COMMIT STOCK: Commit stock again when reopening from cancelled\r\n      const replacedProducts = ticket.products.filter(p => p.resolution === 'replace');\r\n      \r\n      if (replacedProducts.length > 0) {\r\n        const productStore = useProductStore.getState();\r\n        \r\n        replacedProducts.forEach(warrantyProduct => {\r\n          const fallbackProduct = warrantyProduct.productSystemId\r\n            ? productStore.data.find(p => p.systemId === warrantyProduct.productSystemId)\r\n            : warrantyProduct.sku\r\n              ? productStore.data.find(p => p.id === warrantyProduct.sku)\r\n              : undefined;\r\n\r\n          const productSystemId = warrantyProduct.productSystemId ?? fallbackProduct?.systemId;\r\n\r\n          if (!productSystemId) {\r\n            console.warn('[WARRANTY REOPEN] Không tìm thấy SystemId cho sản phẩm:', warrantyProduct.productName || warrantyProduct.sku);\r\n            return;\r\n          }\r\n\r\n          const quantityToCommit = warrantyProduct.quantity || 1;\r\n          productStore.commitStock(productSystemId, ticket.branchSystemId, quantityToCommit);\r\n\r\n          console.log('[WARRANTY REOPEN] Đã giữ lại hàng:', {\r\n            productSystemId,\r\n            productId: fallbackProduct?.id ?? warrantyProduct.sku,\r\n            productName: fallbackProduct?.name ?? warrantyProduct.productName,\r\n            quantity: quantityToCommit,\r\n            warranty: ticket.id,\r\n          });\r\n        });\r\n        \r\n        toast.info('Đã giữ hàng cho phiếu bảo hành', {\r\n          description: `${replacedProducts.length} sản phẩm đã được giữ lại trong kho`,\r\n          duration: 3000\r\n        });\r\n      }\r\n      \r\n      // ✅ Add history entry WITH REASON\r\n      const inventoryNote = replacedProducts.length > 0 \r\n        ? ` (Đã giữ lại ${replacedProducts.length} sản phẩm)` \r\n        : '';\r\n      \r\n      // ✅ Get latest ticket from store to avoid stale history\r\n      const latestTicket = findById(ticket.systemId);\r\n      if (!latestTicket) {\r\n        toast.error('Không tìm thấy phiếu');\r\n        return;\r\n      }\r\n      \r\n      const newHistory: WarrantyHistory = {\r\n        systemId: generateHistorySystemId(latestTicket.history ?? []),\r\n        action: 'Mở lại phiếu từ trạng thái Đã hủy',\r\n        actionLabel: 'Đã mở lại phiếu từ trạng thái Đã hủy',\r\n        entityType: 'status',\r\n        performedBy: performerName,\r\n        performedBySystemId: performerSystemId ? asSystemId(performerSystemId) : undefined,\r\n        performedAt: toISODateTime(getCurrentDate()),\r\n        note: `Lý do mở lại: ${reopenReason}${inventoryNote}`,\r\n      };\r\n\r\n      update(ticket.systemId, {\r\n        cancelledAt: undefined,\r\n        status: 'pending', // ✅ Reset to pending (ready to process) instead of incomplete\r\n        returnedAt: undefined, // ✅ Clear returnedAt timestamp\r\n        processedAt: undefined, // ✅ Clear processedAt timestamp\r\n        processingStartedAt: undefined, // ✅ Clear processingStartedAt timestamp\r\n        linkedOrderSystemId: undefined, // ✅ Clear order link\r\n        history: [...latestTicket.history, newHistory],\r\n      });\r\n      \r\n      onOpenChange(false);\r\n      setReopenReason('');\r\n      toast.success('Đã mở lại phiếu bảo hành');\r\n    } catch (error) {\r\n      console.error('Failed to reopen ticket:', error);\r\n      toast.error('Không thể mở lại phiếu');\r\n    }\r\n  }, [ticket, reopenReason, update, performerName, performerSystemId, findById, onOpenChange]);\r\n\r\n  return (\r\n    <AlertDialog open={open} onOpenChange={onOpenChange}>\r\n      <AlertDialogContent>\r\n        <AlertDialogHeader>\r\n          <AlertDialogTitle>Xác nhận mở lại phiếu</AlertDialogTitle>\r\n          <AlertDialogDescription>\r\n            Bạn có chắc chắn muốn mở lại phiếu bảo hành này? Vui lòng nhập lý do mở lại.\r\n          </AlertDialogDescription>\r\n        </AlertDialogHeader>\r\n        <Textarea\r\n          value={reopenReason}\r\n          onChange={(e) => setReopenReason(e.target.value)}\r\n          placeholder=\"Nhập lý do mở lại phiếu (bắt buộc)...\"\r\n          className=\"min-h-[100px]\"\r\n        />\r\n        <AlertDialogFooter>\r\n          <AlertDialogCancel onClick={() => setReopenReason('')}>Hủy</AlertDialogCancel>\r\n          <AlertDialogAction onClick={handleReopen}>\r\n            Mở lại\r\n          </AlertDialogAction>\r\n        </AlertDialogFooter>\r\n      </AlertDialogContent>\r\n    </AlertDialog>\r\n  );\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 7168, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/warranty/components/dialogs/warranty-reopen-from-returned-dialog.tsx"],"sourcesContent":["/**\r\n * Reopen From Returned Dialog\r\n * Dialog để mở lại phiếu bảo hành từ trạng thái đã trả/kết thúc\r\n */\r\n\r\nimport * as React from 'react';\r\nimport { toast } from 'sonner';\r\nimport {\r\n  AlertDialog,\r\n  AlertDialogAction,\r\n  AlertDialogCancel,\r\n  AlertDialogContent,\r\n  AlertDialogDescription,\r\n  AlertDialogFooter,\r\n  AlertDialogHeader,\r\n  AlertDialogTitle,\r\n} from '../../../../components/ui/alert-dialog';\r\nimport { Textarea } from '../../../../components/ui/textarea';\r\nimport type { WarrantyTicket } from '../../types';\r\nimport { WARRANTY_STATUS_LABELS } from '../../types';\r\nimport { useWarrantyStore } from '../../store';\r\nimport { useAuth } from '../../../../contexts/auth-context';\r\n\r\ninterface WarrantyReopenFromReturnedDialogProps {\r\n  open: boolean;\r\n  onOpenChange: (open: boolean) => void;\r\n  ticket: WarrantyTicket | null;\r\n}\r\n\r\nexport function WarrantyReopenFromReturnedDialog({ open, onOpenChange, ticket }: WarrantyReopenFromReturnedDialogProps) {\r\n  const [reopenReason, setReopenReason] = React.useState('');\r\n  const { user: currentUser } = useAuth();\r\n  const { update, updateStatus, addHistory } = useWarrantyStore();\r\n\r\n  const handleReopen = React.useCallback(() => {\r\n    if (!ticket || !reopenReason.trim()) {\r\n      toast.error('Vui lòng nhập lý do mở lại');\r\n      return;\r\n    }\r\n\r\n    try {\r\n      // Determine target status based on current status\r\n      const targetStatus = ticket.status === 'completed' ? 'returned' : 'processed';\r\n      \r\n      // ⚠️ KHÔNG ĐỘNG CHẠM GÌ KHI MỞ LẠI TỪ COMPLETED\r\n      // Lý do:\r\n      // - Kết thúc = Đơn đã xong, hàng đã xuất, tiền đã thanh toán\r\n      // - Mở lại CHỈ để xem lại, không được sửa/thay đổi gì\r\n      // - Nếu muốn điều chỉnh → Phải thao tác thêm (tạo phiếu mới, hoàn hàng thủ công, etc.)\r\n      if (ticket.status === 'completed') {\r\n        console.log('📋 [REOPEN FROM COMPLETED] Chỉ mở để xem, không động kho/voucher:', {\r\n          ticketId: ticket.id,\r\n          note: 'Read-only reopen - No inventory/payment changes'\r\n        });\r\n      }\r\n      \r\n      // ✅ Pass lý do mở lại vào note parameter\r\n      updateStatus(ticket.systemId, targetStatus, `Lý do: ${reopenReason}`);\r\n      \r\n      // Clear returnedAt và linkedOrderSystemId only when going back to processed (not from completed)\r\n      if (targetStatus === 'processed') {\r\n        update(ticket.systemId, {\r\n          returnedAt: undefined,\r\n          linkedOrderSystemId: undefined,\r\n        });\r\n      }\r\n      \r\n      onOpenChange(false);\r\n      setReopenReason('');\r\n      toast.success(`Đã mở lại phiếu`, {\r\n        description: ticket.status === 'completed' \r\n          ? 'Phiếu đã mở lại để xem. Không thay đổi kho hàng hay thanh toán.' \r\n          : undefined\r\n      });\r\n    } catch (error) {\r\n      console.error('Failed to reopen ticket:', error);\r\n      toast.error('Không thể mở lại phiếu');\r\n    }\r\n  }, [ticket, reopenReason, update, updateStatus, onOpenChange]);\r\n\r\n  return (\r\n    <AlertDialog open={open} onOpenChange={onOpenChange}>\r\n      <AlertDialogContent>\r\n        <AlertDialogHeader>\r\n          <AlertDialogTitle>Xác nhận mở lại phiếu đã trả</AlertDialogTitle>\r\n          <AlertDialogDescription>\r\n            Phiếu này đã trả hàng cho khách. Vui lòng nhập lý do cần mở lại.\r\n          </AlertDialogDescription>\r\n        </AlertDialogHeader>\r\n        <Textarea\r\n          value={reopenReason}\r\n          onChange={(e) => setReopenReason(e.target.value)}\r\n          placeholder=\"Nhập lý do mở lại (bắt buộc)...\"\r\n          className=\"min-h-[100px]\"\r\n        />\r\n        <AlertDialogFooter>\r\n          <AlertDialogCancel onClick={() => setReopenReason('')}>Hủy</AlertDialogCancel>\r\n          <AlertDialogAction onClick={handleReopen}>\r\n            Mở lại\r\n          </AlertDialogAction>\r\n        </AlertDialogFooter>\r\n      </AlertDialogContent>\r\n    </AlertDialog>\r\n  );\r\n}\r\n"],"names":[],"mappings":";;;;;AAAA;;;CAGC,GAED;AACA;AACA;AAUA;AAGA;AAAA;AACA;;;;;;;;AAQO,SAAS,iCAAiC,EAAE,IAAI,EAAE,YAAY,EAAE,MAAM,EAAyC;IACpH,MAAM,CAAC,cAAc,gBAAgB,GAAG,iNAAc,CAAC;IACvD,MAAM,EAAE,MAAM,WAAW,EAAE,GAAG,IAAA,uIAAO;IACrC,MAAM,EAAE,MAAM,EAAE,YAAY,EAAE,UAAU,EAAE,GAAG,IAAA,0JAAgB;IAE7D,MAAM,eAAe,oNAAiB,CAAC;QACrC,IAAI,CAAC,UAAU,CAAC,aAAa,IAAI,IAAI;YACnC,iJAAK,CAAC,KAAK,CAAC;YACZ;QACF;QAEA,IAAI;YACF,kDAAkD;YAClD,MAAM,eAAe,OAAO,MAAM,KAAK,cAAc,aAAa;YAElE,gDAAgD;YAChD,SAAS;YACT,6DAA6D;YAC7D,sDAAsD;YACtD,uFAAuF;YACvF,IAAI,OAAO,MAAM,KAAK,aAAa;gBACjC,QAAQ,GAAG,CAAC,qEAAqE;oBAC/E,UAAU,OAAO,EAAE;oBACnB,MAAM;gBACR;YACF;YAEA,yCAAyC;YACzC,aAAa,OAAO,QAAQ,EAAE,cAAc,CAAC,OAAO,EAAE,cAAc;YAEpE,iGAAiG;YACjG,IAAI,iBAAiB,aAAa;gBAChC,OAAO,OAAO,QAAQ,EAAE;oBACtB,YAAY;oBACZ,qBAAqB;gBACvB;YACF;YAEA,aAAa;YACb,gBAAgB;YAChB,iJAAK,CAAC,OAAO,CAAC,CAAC,eAAe,CAAC,EAAE;gBAC/B,aAAa,OAAO,MAAM,KAAK,cAC3B,oEACA;YACN;QACF,EAAE,OAAO,OAAO;YACd,QAAQ,KAAK,CAAC,4BAA4B;YAC1C,iJAAK,CAAC,KAAK,CAAC;QACd;IACF,GAAG;QAAC;QAAQ;QAAc;QAAQ;QAAc;KAAa;IAE7D,qBACE,8OAAC,mJAAW;QAAC,MAAM;QAAM,cAAc;kBACrC,cAAA,8OAAC,0JAAkB;;8BACjB,8OAAC,yJAAiB;;sCAChB,8OAAC,wJAAgB;sCAAC;;;;;;sCAClB,8OAAC,8JAAsB;sCAAC;;;;;;;;;;;;8BAI1B,8OAAC,yIAAQ;oBACP,OAAO;oBACP,UAAU,CAAC,IAAM,gBAAgB,EAAE,MAAM,CAAC,KAAK;oBAC/C,aAAY;oBACZ,WAAU;;;;;;8BAEZ,8OAAC,yJAAiB;;sCAChB,8OAAC,yJAAiB;4BAAC,SAAS,IAAM,gBAAgB;sCAAK;;;;;;sCACvD,8OAAC,yJAAiB;4BAAC,SAAS;sCAAc;;;;;;;;;;;;;;;;;;;;;;;AAOpD"}},
    {"offset": {"line": 7315, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/warranty/components/dialogs/warranty-return-method-dialog.tsx"],"sourcesContent":["import * as React from 'react';\r\nimport { Button } from '../../../../components/ui/button';\r\nimport {\r\n  Dialog,\r\n  DialogContent,\r\n  DialogDescription,\r\n  DialogHeader,\r\n  DialogTitle,\r\n} from '../../../../components/ui/dialog';\r\nimport { VirtualizedCombobox, type ComboboxOption } from '../../../../components/ui/virtualized-combobox';\r\nimport type { WarrantyTicket } from '../../types';\r\nimport type { OrderSearchResult } from '../../../orders/order-search-api';\r\n\r\ntype ReturnMethod = 'direct' | 'order' | null;\r\n\r\ninterface WarrantyReturnMethodDialogProps {\r\n  open: boolean;\r\n  ticket: WarrantyTicket | null;\r\n  currentMethodLabel?: string | null | undefined;\r\n  returnMethod: ReturnMethod;\r\n  onReturnMethodChange: (method: ReturnMethod) => void;\r\n  selectedOrderValue: ComboboxOption | null;\r\n  onOrderSelect: (option: ComboboxOption | null) => void;\r\n  orderSearchResults: OrderSearchResult[];\r\n  orderSearchQuery: string;\r\n  onOrderSearchChange: (query: string) => void;\r\n  isSearchingOrders: boolean;\r\n  totalOrderCount: number;\r\n  onConfirmDirect: () => void;\r\n  onConfirmWithOrder: () => void;\r\n  onOpenChange: (open: boolean) => void;\r\n  onReset: () => void;\r\n}\r\n\r\nexport function WarrantyReturnMethodDialog({\r\n  open,\r\n  ticket,\r\n  currentMethodLabel,\r\n  returnMethod,\r\n  onReturnMethodChange,\r\n  selectedOrderValue,\r\n  onOrderSelect,\r\n  orderSearchResults,\r\n  orderSearchQuery,\r\n  onOrderSearchChange,\r\n  isSearchingOrders,\r\n  totalOrderCount,\r\n  onConfirmDirect,\r\n  onConfirmWithOrder,\r\n  onOpenChange,\r\n  onReset,\r\n}: WarrantyReturnMethodDialogProps) {\r\n  const handleOpenChange = React.useCallback((nextOpen: boolean) => {\r\n    if (!nextOpen) {\r\n      onReset();\r\n    }\r\n    onOpenChange(nextOpen);\r\n  }, [onOpenChange, onReset]);\r\n\r\n  const handleConfirm = React.useCallback(() => {\r\n    if (returnMethod === 'direct') {\r\n      onConfirmDirect();\r\n    } else if (returnMethod === 'order') {\r\n      onConfirmWithOrder();\r\n    }\r\n  }, [onConfirmDirect, onConfirmWithOrder, returnMethod]);\r\n\r\n  const handleCancel = React.useCallback(() => {\r\n    onReset();\r\n    onOpenChange(false);\r\n  }, [onOpenChange, onReset]);\r\n\r\n  const showCurrentMethod = ticket?.status === 'returned' && (currentMethodLabel || ticket);\r\n  const orderCountLabel = totalOrderCount.toLocaleString('vi-VN');\r\n  const isOrderDisabled = returnMethod === 'order' && !selectedOrderValue;\r\n\r\n  return (\r\n    <Dialog open={open} onOpenChange={handleOpenChange}>\r\n      <DialogContent className=\"max-w-2xl max-h-[90vh] overflow-y-auto\">\r\n        <DialogHeader>\r\n          <DialogTitle>\r\n            {ticket?.status === 'returned' ? 'Cập nhật phương thức trả hàng' : 'Đã trả hàng cho khách'}\r\n          </DialogTitle>\r\n          <DialogDescription>\r\n            {ticket?.status === 'returned'\r\n              ? 'Thay đổi phương thức trả hàng cho khách. Phương thức hiện tại sẽ được cập nhật.'\r\n              : 'Chọn phương thức trả hàng cho khách.'}\r\n          </DialogDescription>\r\n        </DialogHeader>\r\n\r\n        <div className=\"py-4 space-y-4\">\r\n          {showCurrentMethod && (\r\n            <div className=\"bg-blue-50 border border-blue-200 rounded-lg p-3\">\r\n              <div className=\"text-sm font-medium text-blue-900 mb-1\">\r\n                Phương thức hiện tại:\r\n              </div>\r\n              <div className=\"text-sm text-blue-700\">\r\n                {currentMethodLabel || 'Khách lấy trực tiếp tại cửa hàng'}\r\n              </div>\r\n            </div>\r\n          )}\r\n\r\n          <div className=\"space-y-3\">\r\n            <label className=\"text-sm font-medium\">Phương thức trả hàng *</label>\r\n            <div className=\"grid grid-cols-2 gap-3\">\r\n              <Button\r\n                type=\"button\"\r\n                variant={returnMethod === 'direct' ? 'default' : 'outline'}\r\n                className=\"h-auto py-4 flex flex-col items-center gap-2\"\r\n                onClick={() => onReturnMethodChange('direct')}\r\n              >\r\n                <div className=\"text-base font-semibold\">Khách lấy trực tiếp</div>\r\n                <div className=\"text-xs text-muted-foreground\">Tại cửa hàng</div>\r\n              </Button>\r\n              <Button\r\n                type=\"button\"\r\n                variant={returnMethod === 'order' ? 'default' : 'outline'}\r\n                className=\"h-auto py-4 flex flex-col items-center gap-2\"\r\n                onClick={() => onReturnMethodChange('order')}\r\n              >\r\n                <div className=\"text-base font-semibold\">Giao qua đơn hàng</div>\r\n                <div className=\"text-xs text-muted-foreground\">Link với đơn hàng</div>\r\n              </Button>\r\n            </div>\r\n          </div>\r\n\r\n          {returnMethod === 'order' && (\r\n            <div className=\"space-y-2\">\r\n              <label className=\"text-sm font-medium\">Chọn đơn hàng</label>\r\n              <div className=\"text-xs text-muted-foreground mb-2\">\r\n                💡 <strong>Tìm kiếm thông minh:</strong> Nhập mã đơn hàng hoặc tên khách để tìm nhanh.\r\n                Hệ thống tự động lọc kết quả từ {orderCountLabel} đơn hàng.\r\n              </div>\r\n              <VirtualizedCombobox\r\n                options={orderSearchResults}\r\n                value={selectedOrderValue}\r\n                onChange={onOrderSelect}\r\n                onSearchChange={onOrderSearchChange}\r\n                placeholder=\"Tìm kiếm đơn hàng...\"\r\n                searchPlaceholder=\"Nhập mã đơn hoặc tên khách hàng...\"\r\n                emptyPlaceholder={\r\n                  orderSearchQuery\r\n                    ? 'Không tìm thấy đơn hàng phù hợp'\r\n                    : 'Nhập từ khóa để tìm kiếm đơn hàng'\r\n                }\r\n                isLoading={isSearchingOrders}\r\n                minSearchLength={0}\r\n                estimatedItemHeight={56}\r\n                maxHeight={400}\r\n              />\r\n              <p className=\"text-xs text-muted-foreground\">\r\n                {isSearchingOrders ? (\r\n                  <span className=\"text-blue-600\">⏳ Đang tìm kiếm...</span>\r\n                ) : orderSearchQuery ? (\r\n                  <span>✓ Tìm thấy <strong>{orderSearchResults.length}</strong> đơn hàng</span>\r\n                ) : (\r\n                  <span>Hiển thị <strong>{orderSearchResults.length}</strong> đơn hàng gần nhất</span>\r\n                )}\r\n              </p>\r\n            </div>\r\n          )}\r\n        </div>\r\n\r\n        <div className=\"flex justify-end gap-2 pt-4 border-t\">\r\n          <Button variant=\"outline\" onClick={handleCancel}>\r\n            Hủy\r\n          </Button>\r\n          <Button onClick={handleConfirm} disabled={!returnMethod || isOrderDisabled}>\r\n            Xác nhận\r\n          </Button>\r\n        </div>\r\n      </DialogContent>\r\n    </Dialog>\r\n  );\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 7648, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/warranty/hooks/use-warranty-reminders.ts"],"sourcesContent":["/**\r\n * Warranty Reminders Hook\r\n * Auto-scheduling and reminder management for warranty tickets\r\n * Pattern copied from Complaints system\r\n * \r\n * NOTE: Templates are now synced with database via warranty-settings-sync.ts\r\n */\r\n\r\nimport { useState, useCallback } from 'react';\r\nimport { useWarrantyStore } from '../store';\r\nimport type { WarrantyTicket } from '../types';\r\nimport { notifyWarrantyReminder } from '../notification-utils';\r\nimport {\r\n  getWarrantyTemplatesSync,\r\n  saveWarrantyTemplatesAsync,\r\n  type ReminderTemplate,\r\n} from '@/lib/warranty-settings-sync';\r\n\r\n// Re-export for backwards compatibility\r\nexport type { ReminderTemplate } from '@/lib/warranty-settings-sync';\r\n\r\nexport const DEFAULT_REMINDER_TEMPLATES: ReminderTemplate[] = [\r\n  {\r\n    id: 'overdue',\r\n    name: 'Nhắc nhở quá hạn',\r\n    message: 'Phiếu bảo hành #{ticketId} đã quá hạn xử lý. Vui lòng kiểm tra và cập nhật trạng thái.',\r\n    isDefault: true,\r\n  },\r\n  {\r\n    id: 'follow-up',\r\n    name: 'Theo dõi tiến độ',\r\n    message: 'Phiếu bảo hành #{ticketId} đang được xử lý. Vui lòng cập nhật tiến độ cho khách hàng {customerName}.',\r\n    isDefault: true,\r\n  },\r\n  {\r\n    id: 'return-ready',\r\n    name: 'Sẵn sàng trả hàng',\r\n    message: 'Sản phẩm bảo hành #{ticketId} đã xử lý xong. Vui lòng chuẩn bị trả hàng cho khách {customerName}.',\r\n    isDefault: true,\r\n  },\r\n  {\r\n    id: 'custom',\r\n    name: 'Nhắc nhở tùy chỉnh',\r\n    message: '',\r\n    isDefault: false,\r\n  },\r\n];\r\n\r\nexport interface WarrantyReminder {\r\n  id: string;\r\n  ticketSystemId: string;\r\n  ticketId: string;\r\n  templateId: string;\r\n  message: string;\r\n  assignedTo: string; // Employee ID\r\n  createdBy: string;\r\n  createdAt: Date;\r\n  status: 'pending' | 'sent' | 'dismissed';\r\n  scheduledFor?: Date;\r\n}\r\n\r\n/**\r\n * Load reminder templates from database (sync version)\r\n */\r\nexport function loadReminderTemplates(): ReminderTemplate[] {\r\n  try {\r\n    const custom = getWarrantyTemplatesSync();\r\n    return [...DEFAULT_REMINDER_TEMPLATES, ...custom];\r\n  } catch (error) {\r\n    console.error('Failed to load reminder templates:', error);\r\n    return DEFAULT_REMINDER_TEMPLATES;\r\n  }\r\n}\r\n\r\n/**\r\n * Save custom reminder templates to database\r\n */\r\nexport function saveReminderTemplates(templates: ReminderTemplate[]): void {\r\n  try {\r\n    const customTemplates = templates.filter(t => !t.isDefault);\r\n    // Fire and forget - save to database in background\r\n    saveWarrantyTemplatesAsync(customTemplates).catch(error => {\r\n      console.error('Failed to save reminder templates:', error);\r\n    });\r\n  } catch (error) {\r\n    console.error('Failed to save reminder templates:', error);\r\n  }\r\n}\r\n\r\n/**\r\n * Format reminder message with ticket data\r\n */\r\nexport function formatReminderMessage(template: string, ticket: WarrantyTicket): string {\r\n  return template\r\n    .replace(/{ticketId}/g, ticket.id)\r\n    .replace(/{customerName}/g, ticket.customerName)\r\n    .replace(/{customerPhone}/g, ticket.customerPhone)\r\n    .replace(/{trackingCode}/g, ticket.trackingCode || 'N/A');\r\n}\r\n\r\n/**\r\n * Hook for warranty reminders management\r\n */\r\nexport function useWarrantyReminders() {\r\n  const [isReminderModalOpen, setIsReminderModalOpen] = useState(false);\r\n  const [selectedTicket, setSelectedTicket] = useState<WarrantyTicket | null>(null);\r\n  const [templates] = useState<ReminderTemplate[]>(loadReminderTemplates());\r\n\r\n  /**\r\n   * Open reminder modal for a ticket\r\n   */\r\n  const openReminderModal = useCallback((ticket: WarrantyTicket) => {\r\n    setSelectedTicket(ticket);\r\n    setIsReminderModalOpen(true);\r\n  }, []);\r\n\r\n  /**\r\n   * Close reminder modal\r\n   */\r\n  const closeReminderModal = useCallback(() => {\r\n    setIsReminderModalOpen(false);\r\n    setSelectedTicket(null);\r\n  }, []);\r\n\r\n  /**\r\n   * Send reminder for a ticket\r\n   */\r\n  const sendReminder = useCallback(async (\r\n    ticket: WarrantyTicket,\r\n    templateId: string,\r\n    customMessage?: string,\r\n    assignedTo?: string,\r\n  ): Promise<boolean> => {\r\n    try {\r\n      const template = templates.find(t => t.id === templateId);\r\n      if (!template) {\r\n        throw new Error('Template not found');\r\n      }\r\n\r\n      const message = customMessage || formatReminderMessage(template.message, ticket);\r\n\r\n      const reminder: WarrantyReminder = {\r\n        id: `reminder_${Date.now()}`,\r\n        ticketSystemId: ticket.systemId,\r\n        ticketId: ticket.id,\r\n        templateId,\r\n        message,\r\n        assignedTo: assignedTo || ticket.employeeSystemId || 'unassigned',\r\n        createdBy: 'current_user', // TODO: Get from auth context\r\n        createdAt: new Date(),\r\n        status: 'sent',\r\n      };\r\n\r\n      // Store reminder in ticket history\r\n      const { addHistory } = useWarrantyStore.getState();\r\n      addHistory(ticket.systemId, 'Gửi nhắc nhở', 'current_user', message);\r\n\r\n      // Send notification\r\n      notifyWarrantyReminder(ticket.id, message);\r\n\r\n      return true;\r\n    } catch (error) {\r\n      console.error('Failed to send reminder:', error);\r\n      return false;\r\n    }\r\n  }, [templates]);\r\n\r\n  /**\r\n   * Schedule automatic reminder for overdue tickets\r\n   */\r\n  const scheduleAutoReminder = useCallback((ticket: WarrantyTicket): void => {\r\n    // This would be called by a background job\r\n    // For now, it's a placeholder for future implementation\r\n    console.log('Auto reminder scheduled for:', ticket.id);\r\n  }, []);\r\n\r\n  /**\r\n   * Get pending reminders for a ticket\r\n   */\r\n  const getTicketReminders = useCallback((ticketSystemId: string): WarrantyReminder[] => {\r\n    // TODO: Load from store or API\r\n    return [];\r\n  }, []);\r\n\r\n  /**\r\n   * Dismiss a reminder\r\n   */\r\n  const dismissReminder = useCallback((reminderId: string): void => {\r\n    // TODO: Update reminder status\r\n    console.log('Reminder dismissed:', reminderId);\r\n  }, []);\r\n\r\n  return {\r\n    // Modal state\r\n    isReminderModalOpen,\r\n    openReminderModal,\r\n    closeReminderModal,\r\n    selectedTicket,\r\n\r\n    // Templates\r\n    templates,\r\n\r\n    // Actions\r\n    sendReminder,\r\n    scheduleAutoReminder,\r\n    getTicketReminders,\r\n    dismissReminder,\r\n\r\n    // Utils\r\n    formatReminderMessage,\r\n  };\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 7816, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/warranty/components/dialogs/warranty-reminder-dialog.tsx"],"sourcesContent":["/**\r\n * Warranty Reminder Dialog\r\n * Modal for sending reminders for warranty tickets\r\n * Pattern copied from Complaints system\r\n */\r\n\r\nimport * as React from 'react';\r\nimport { Bell, Send } from 'lucide-react';\r\nimport { toast } from 'sonner';\r\nimport {\r\n  Dialog,\r\n  DialogContent,\r\n  DialogHeader,\r\n  DialogTitle,\r\n  DialogFooter,\r\n} from '@/components/ui/dialog';\r\nimport { Button } from '@/components/ui/button';\r\nimport { Label } from '@/components/ui/label';\r\nimport { Textarea } from '@/components/ui/textarea';\r\nimport {\r\n  Select,\r\n  SelectContent,\r\n  SelectItem,\r\n  SelectTrigger,\r\n  SelectValue,\r\n} from '@/components/ui/select';\r\nimport type { WarrantyTicket } from '../../types';\r\nimport type { ReminderTemplate } from '../../hooks/use-warranty-reminders';\r\nimport { formatReminderMessage } from '../../hooks/use-warranty-reminders';\r\n\r\ninterface WarrantyReminderDialogProps {\r\n  open: boolean;\r\n  onOpenChange: (open: boolean) => void;\r\n  ticket: WarrantyTicket | null;\r\n  templates: ReminderTemplate[];\r\n  onSendReminder: (\r\n    ticket: WarrantyTicket,\r\n    templateId: string,\r\n    customMessage?: string | undefined,\r\n  ) => Promise<boolean>;\r\n}\r\n\r\nexport function WarrantyReminderDialog({\r\n  open,\r\n  onOpenChange,\r\n  ticket,\r\n  templates,\r\n  onSendReminder,\r\n}: WarrantyReminderDialogProps) {\r\n  const [selectedTemplateId, setSelectedTemplateId] = React.useState<string>('');\r\n  const [customMessage, setCustomMessage] = React.useState<string>('');\r\n  const [isSending, setIsSending] = React.useState(false);\r\n\r\n  // Reset state when modal opens\r\n  React.useEffect(() => {\r\n    if (open && ticket) {\r\n      // Default to first template\r\n      const defaultTemplate = templates.find(t => t.id === 'follow-up') || templates[0];\r\n      setSelectedTemplateId(defaultTemplate?.id || '');\r\n      setCustomMessage('');\r\n    }\r\n  }, [open, ticket, templates]);\r\n\r\n  // Update message preview when template changes\r\n  React.useEffect(() => {\r\n    if (!selectedTemplateId || !ticket) return;\r\n\r\n    const template = templates.find(t => t.id === selectedTemplateId);\r\n    if (!template) return;\r\n\r\n    // For custom template, keep user input\r\n    if (template.id === 'custom') {\r\n      return;\r\n    }\r\n\r\n    // Auto-fill message from template\r\n    const formatted = formatReminderMessage(template.message, ticket);\r\n    setCustomMessage(formatted);\r\n  }, [selectedTemplateId, ticket, templates]);\r\n\r\n  const handleSend = async () => {\r\n    if (!ticket) return;\r\n\r\n    if (!customMessage.trim()) {\r\n      toast.error('Vui lòng nhập nội dung nhắc nhở');\r\n      return;\r\n    }\r\n\r\n    setIsSending(true);\r\n    try {\r\n      const success = await onSendReminder(ticket, selectedTemplateId, customMessage);\r\n      \r\n      if (success) {\r\n        toast.success('Đã gửi nhắc nhở thành công');\r\n        onOpenChange(false);\r\n      } else {\r\n        toast.error('Không thể gửi nhắc nhở');\r\n      }\r\n    } catch (error) {\r\n      console.error('Send reminder error:', error);\r\n      toast.error('Có lỗi xảy ra khi gửi nhắc nhở');\r\n    } finally {\r\n      setIsSending(false);\r\n    }\r\n  };\r\n\r\n  if (!ticket) return null;\r\n\r\n  return (\r\n    <Dialog open={open} onOpenChange={onOpenChange}>\r\n      <DialogContent className=\"sm:max-w-[500px]\">\r\n        <DialogHeader>\r\n          <DialogTitle className=\"flex items-center gap-2\">\r\n            <Bell className=\"h-5 w-5\" />\r\n            Gửi nhắc nhở - {ticket.id}\r\n          </DialogTitle>\r\n        </DialogHeader>\r\n\r\n        <div className=\"space-y-4 py-4\">\r\n          {/* Ticket Info */}\r\n          <div className=\"rounded-lg border border-border p-3 bg-muted/50 space-y-1 text-sm\">\r\n            <div className=\"font-medium\">{ticket.customerName}</div>\r\n            <div className=\"text-muted-foreground\">{ticket.customerPhone}</div>\r\n            <div className=\"text-muted-foreground\">\r\n              {ticket.summary.totalProducts} sản phẩm\r\n            </div>\r\n          </div>\r\n\r\n          {/* Template Selection */}\r\n          <div className=\"space-y-2\">\r\n            <Label htmlFor=\"template\">Mẫu nhắc nhở</Label>\r\n            <Select\r\n              value={selectedTemplateId}\r\n              onValueChange={setSelectedTemplateId}\r\n            >\r\n              <SelectTrigger id=\"template\">\r\n                <SelectValue placeholder=\"Chọn mẫu...\" />\r\n              </SelectTrigger>\r\n              <SelectContent>\r\n                {templates.map((template) => (\r\n                  <SelectItem key={template.id} value={template.id}>\r\n                    {template.name}\r\n                  </SelectItem>\r\n                ))}\r\n              </SelectContent>\r\n            </Select>\r\n          </div>\r\n\r\n          {/* Message Input */}\r\n          <div className=\"space-y-2\">\r\n            <Label htmlFor=\"message\">Nội dung nhắc nhở</Label>\r\n            <Textarea\r\n              id=\"message\"\r\n              value={customMessage}\r\n              onChange={(e) => setCustomMessage(e.target.value)}\r\n              placeholder=\"Nhập nội dung nhắc nhở...\"\r\n              rows={6}\r\n              className=\"resize-none\"\r\n            />\r\n            <div className=\"text-xs text-muted-foreground\">\r\n              Có thể dùng: {'{ticketId}'}, {'{customerName}'}, {'{customerPhone}'}, {'{trackingCode}'}\r\n            </div>\r\n          </div>\r\n        </div>\r\n\r\n        <DialogFooter>\r\n          <Button\r\n            type=\"button\"\r\n            variant=\"outline\"\r\n            onClick={() => onOpenChange(false)}\r\n            disabled={isSending}\r\n          >\r\n            Hủy\r\n          </Button>\r\n          <Button\r\n            type=\"button\"\r\n            onClick={handleSend}\r\n            disabled={isSending || !customMessage.trim()}\r\n          >\r\n            <Send className=\"h-4 w-4 mr-2\" />\r\n            {isSending ? 'Đang gửi...' : 'Gửi nhắc nhở'}\r\n          </Button>\r\n        </DialogFooter>\r\n      </DialogContent>\r\n    </Dialog>\r\n  );\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 8132, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/warranty/components/dialogs/index.ts"],"sourcesContent":["export { WarrantyCancelDialog } from './warranty-cancel-dialog';\r\nexport { WarrantyPaymentVoucherDialog } from './warranty-payment-voucher-dialog';\r\nexport { WarrantyReceiptVoucherDialog } from './warranty-receipt-voucher-dialog';\r\nexport { WarrantyReopenFromCancelledDialog } from './warranty-reopen-from-cancelled-dialog';\r\nexport { WarrantyReopenFromReturnedDialog } from './warranty-reopen-from-returned-dialog';\r\nexport { WarrantyReturnMethodDialog } from './warranty-return-method-dialog';\r\nexport { WarrantyReminderDialog } from './warranty-reminder-dialog';\r\n"],"names":[],"mappings":";AAAA;AACA;AACA;AACA;AACA;AACA;AACA"}},
    {"offset": {"line": 8151, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/warranty/warranty-list-page.tsx"],"sourcesContent":["'use client'\r\n\r\nimport * as React from 'react';\r\nimport { useRouter } from 'next/navigation';\r\nimport { Plus, Download, Upload, Filter, X, LayoutGrid, Table, Settings, BarChart3, RefreshCw, AlertCircle, Clock, CheckCircle2, XCircle } from 'lucide-react';\r\nimport Fuse from 'fuse.js';\r\nimport { cn } from '../../lib/utils';\r\nimport { toast } from 'sonner';\r\nimport {\r\n  type ColumnDef,\r\n  type SortingState,\r\n  type ColumnFiltersState,\r\n  type VisibilityState,\r\n  type ColumnOrderState,\r\n  type ColumnPinningState,\r\n  type RowSelectionState,\r\n} from '@tanstack/react-table';\r\n\r\n// Types & Hooks\r\nimport type { WarrantyTicket, WarrantyStatus } from './types';\r\nimport { useAllWarranties } from './hooks/use-all-warranties';\r\nimport { useWarrantyMutations } from './hooks/use-warranties';\r\nimport { useAllOrders } from '../orders/hooks/use-all-orders';\r\nimport { WARRANTY_STATUS_LABELS } from './types';\r\nimport { asSystemId } from '@/lib/id-types';\r\n\r\n// Column definitions & Mobile card\r\nimport { getColumns } from './columns';\r\nimport { WarrantyCard } from './warranty-card';\r\nimport { WarrantyCardContextMenu } from './warranty-card-context-menu';\r\nimport { WarrantyReminderDialog, WarrantyCancelDialog } from './components/dialogs/index';\r\nimport { useWarrantyReminders } from './hooks/use-warranty-reminders';\r\nimport { useRealtimeUpdates, getWarrantyDataVersion } from './use-realtime-updates';\r\n\r\n// UI Components\r\nimport { Button } from '../../components/ui/button';\r\nimport { Input } from '../../components/ui/input';\r\nimport { ResponsiveDataTable } from '../../components/data-table/responsive-data-table';\r\nimport { DataTableFacetedFilter } from '../../components/data-table/data-table-faceted-filter';\r\nimport { DataTableColumnCustomizer } from '../../components/data-table/data-table-column-toggle';\r\nimport { PageFilters } from '../../components/layout/page-filters';\r\nimport { PageToolbar } from '../../components/layout/page-toolbar';\r\nimport {\r\n  AlertDialog,\r\n  AlertDialogAction,\r\n  AlertDialogCancel,\r\n  AlertDialogContent,\r\n  AlertDialogDescription,\r\n  AlertDialogFooter,\r\n  AlertDialogHeader,\r\n  AlertDialogTitle,\r\n} from '../../components/ui/alert-dialog';\r\n\r\n// Hooks & Utils\r\nimport { usePageHeader } from '../../contexts/page-header-context';\r\nimport { useBreakpoint } from '../../contexts/breakpoint-context';\r\nimport { useDebounce } from '../../hooks/use-debounce';\r\nimport { loadCardColorSettings } from '../settings/warranty/warranty-settings-page';\r\nimport { checkWarrantyOverdue } from './warranty-sla-utils';\r\nimport { ROUTES, generatePath } from '../../lib/router';\r\nimport { usePrint } from '../../lib/use-print';\r\nimport { useAllBranches } from '../settings/branches/hooks/use-all-branches';\r\nimport { useStoreInfo } from '../settings/store-info/hooks/use-store-info';\r\nimport {\r\n  convertWarrantyForPrint,\r\n  mapWarrantyToPrintData,\r\n  mapWarrantyLineItems,\r\n  createStoreSettings\r\n} from '../../lib/print/warranty-print-helper';\r\nimport { SimplePrintOptionsDialog, SimplePrintOptionsResult } from '../../components/shared/simple-print-options-dialog';\r\n\r\n/**\r\n * KanbanColumn Component - Display warranties by status\r\n */\r\nfunction KanbanColumn({\r\n  status,\r\n  tickets,\r\n  onTicketClick,\r\n  cardColors,\r\n  onEdit,\r\n  onGetLink,\r\n  onStartProcessing,\r\n  onMarkProcessed,\r\n  onMarkReturned,\r\n  onCancel,\r\n  onRemind,\r\n}: {\r\n  status: WarrantyStatus;\r\n  tickets: WarrantyTicket[];\r\n  onTicketClick: (ticket: WarrantyTicket) => void;\r\n  cardColors: ReturnType<typeof loadCardColorSettings>;\r\n  onEdit: (systemId: string) => void;\r\n  onGetLink: (systemId: string) => void;\r\n  onStartProcessing: (systemId: string) => void;\r\n  onMarkProcessed: (systemId: string) => void;\r\n  onMarkReturned: (systemId: string) => void;\r\n  onCancel: (systemId: string) => void;\r\n  onRemind: (systemId: string) => void;\r\n}) {\r\n  const [searchQuery, setSearchQuery] = React.useState('');\r\n\r\n  const statusIcons: Record<WarrantyStatus, React.ElementType> = {\r\n    incomplete: AlertCircle,\r\n    pending: Clock,\r\n    processed: CheckCircle2,\r\n    returned: XCircle,\r\n    completed: CheckCircle2,\r\n    cancelled: XCircle,\r\n  };\r\n\r\n  const StatusIcon = statusIcons[status];\r\n\r\n  // Filter tickets based on local search\r\n  const filteredTickets = React.useMemo(() => {\r\n    if (!searchQuery.trim()) return tickets;\r\n\r\n    const query = searchQuery.toLowerCase();\r\n    return tickets.filter(t =>\r\n      t.id.toLowerCase().includes(query) ||\r\n      t.customerName.toLowerCase().includes(query) ||\r\n      t.customerPhone.includes(query) ||\r\n      t.trackingCode.toLowerCase().includes(query)\r\n    );\r\n  }, [tickets, searchQuery]);\r\n\r\n  return (\r\n    <div className=\"flex-1 min-w-[300px] flex flex-col max-h-[calc(100vh-320px)]\">\r\n      {/* Header - Neutral bg-muted with icon */}\r\n      <div className=\"text-body-sm font-semibold px-4 py-3 mb-2 rounded-lg border bg-muted flex items-center justify-between\">\r\n        <div className=\"flex items-center gap-2\">\r\n          <StatusIcon className=\"h-4 w-4\" />\r\n          {WARRANTY_STATUS_LABELS[status]}\r\n        </div>\r\n        <span className=\"text-body-sm font-normal bg-background h-6 w-6 flex items-center justify-center rounded-full\">\r\n          {filteredTickets.length}\r\n        </span>\r\n      </div>\r\n\r\n      {/* Local Search Input */}\r\n      <div className=\"mb-2\">\r\n        <Input\r\n          placeholder=\"Tìm kiếm...\"\r\n          value={searchQuery}\r\n          onChange={(e) => setSearchQuery(e.target.value)}\r\n          className=\"h-9\"\r\n        />\r\n      </div>\r\n\r\n      {/* Scrollable Cards Area */}\r\n      <div className=\"flex-1 space-y-3 overflow-y-auto pb-2\">\r\n        {filteredTickets.length === 0 ? (\r\n          <div className=\"text-center py-8 text-muted-foreground text-body-sm\">\r\n            {searchQuery ? 'Không tìm thấy kết quả' : 'Không có bảo hành nào'}\r\n          </div>\r\n        ) : (\r\n          filteredTickets.map((ticket) => (\r\n            <WarrantyCardContextMenu\r\n              key={ticket.systemId}\r\n              ticket={ticket}\r\n              onEdit={onEdit}\r\n              onGetLink={onGetLink}\r\n              onStartProcessing={onStartProcessing}\r\n              onMarkProcessed={onMarkProcessed}\r\n              onMarkReturned={onMarkReturned}\r\n              onCancel={onCancel}\r\n              onRemind={onRemind}\r\n            >\r\n              <div>\r\n                <WarrantyCard\r\n                  ticket={ticket}\r\n                  onClick={() => onTicketClick(ticket)}\r\n                />\r\n              </div>\r\n            </WarrantyCardContextMenu>\r\n          ))\r\n        )}\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n\r\n/**\r\n * Trang danh sách phiếu bảo hành - Nâng cấp với VirtualizedDataTable\r\n * \r\n * Features:\r\n * ✅ Virtual Scrolling: Chỉ render visible rows, mượt mà với 10K+ records\r\n * ✅ Search: Fuse.js với threshold 0.3\r\n * ✅ Filters: Status, date range\r\n * ✅ Bulk actions: Delete, export selected\r\n * ✅ Import/Export: Dialogs\r\n * ✅ Column customizer: Show/hide/reorder\r\n * ✅ Header: Auto-generated title from breadcrumb\r\n */\r\nexport function WarrantyListPage() {\r\n  const router = useRouter();\r\n  const { isMobile } = useBreakpoint();\r\n  const { data: tickets = [] } = useAllWarranties();\r\n  const { update: updateWarranty, remove: deleteWarrantyMutation } = useWarrantyMutations();\r\n  const { data: orders = [] } = useAllOrders();\r\n\r\n  // Load card color settings\r\n  const cardColors = React.useMemo(() => loadCardColorSettings(), []);\r\n\r\n  // Get row style based on overdue/status (same logic as card)\r\n  const getRowStyle = React.useCallback((ticket: WarrantyTicket): React.CSSProperties => {\r\n    // Check if overdue and overdue color is enabled (Priority 1)\r\n    const overdueStatus = checkWarrantyOverdue(ticket);\r\n    const isOverdue = overdueStatus.isOverdueResponse || \r\n                      overdueStatus.isOverdueProcessing || \r\n                      overdueStatus.isOverdueReturn;\r\n    \r\n    if (cardColors.enableOverdueColor && isOverdue) {\r\n      const colorClass = cardColors.overdueColor;\r\n      return parseColorClass(colorClass);\r\n    }\r\n    \r\n    // Check status color if enabled (Priority 2)\r\n    if (cardColors.enableStatusColors) {\r\n      const colorClass = cardColors.statusColors[ticket.status];\r\n      if (colorClass) {\r\n        return parseColorClass(colorClass);\r\n      }\r\n    }\r\n    \r\n    return {};\r\n  }, [cardColors]);\r\n\r\n  // Helper function to parse Tailwind color classes to CSS\r\n  function parseColorClass(colorClass: string): React.CSSProperties {\r\n    if (!colorClass || typeof colorClass !== 'string') {\r\n      return {};\r\n    }\r\n    \r\n    // Extract Tailwind color from class (e.g., 'bg-yellow-50 border-yellow-200')\r\n    const colorMap: Record<string, string> = {\r\n      'bg-yellow-50': '#fefce8',\r\n      'bg-blue-50': '#eff6ff',\r\n      'bg-green-50': '#f0fdf4',\r\n      'bg-gray-50': '#f9fafb',\r\n      'bg-amber-50': '#fffbeb',\r\n      'bg-orange-50': '#fff7ed',\r\n      'bg-red-50': '#fef2f2',\r\n      'bg-red-100': '#fee2e2',\r\n      'bg-slate-50': '#f8fafc',\r\n    };\r\n    \r\n    // Find the bg color class\r\n    const bgClass = colorClass.split(' ').find(c => c.startsWith('bg-'));\r\n    const hexColor = bgClass ? colorMap[bgClass] : null;\r\n    \r\n    if (!hexColor) return {};\r\n    \r\n    return {\r\n      backgroundColor: hexColor,\r\n    };\r\n  }\r\n\r\n  // ==========================================\r\n  // State Management\r\n  // ==========================================\r\n  const [searchQuery, setSearchQuery] = React.useState('');\r\n  // ✅ OPTIMIZATION: Use debounce hook instead of manual setTimeout\r\n  const debouncedSearch = useDebounce(searchQuery, 300);\r\n  const [sorting, setSorting] = React.useState<{ id: string; desc: boolean }>({ id: 'createdAt', desc: true });\r\n  const [columnFilters, setColumnFilters] = React.useState<ColumnFiltersState>([]);\r\n  const [rowSelection, setRowSelection] = React.useState<RowSelectionState>({});\r\n  const [statusFilter, setStatusFilter] = React.useState<Set<string>>(new Set());\r\n  const [expanded, setExpanded] = React.useState<Record<string, boolean>>({});\r\n\r\n  // ==========================================\r\n  // Default visible columns (20+ columns visible for sticky scrollbar)\r\n  // ==========================================\r\n  const defaultVisibleColumns: VisibilityState = React.useMemo(\r\n    () => ({\r\n      select: true,\r\n      id: true,\r\n      branchName: true,\r\n      employeeName: true,\r\n      customerName: true,\r\n      customerPhone: true,\r\n      customerAddress: true,\r\n      trackingCode: true,\r\n      shippingFee: true,\r\n      linkedOrderId: true, // ✅ Column ID (keep as is - matches column.id from columns)\r\n      referenceUrl: true, // ✅ Show new columns\r\n      externalReference: true, // ✅ Show new columns\r\n      status: true,\r\n      slaStatus: true,\r\n      settlementStatus: true,\r\n      productsCount: true,\r\n      totalProducts: true,\r\n      totalReplaced: true,\r\n      totalReturned: true, // ✅ Show new columns\r\n      totalOutOfStock: true, // ✅ Hết hàng (Khấu trừ) - gộp cả deduct + out_of_stock\r\n      totalSettlement: true, // ✅ Show new columns\r\n      receivedImagesCount: true,\r\n      processedImagesCount: true,\r\n      historyCount: true, // ✅ Show new columns\r\n      commentsCount: true, // ✅ Show new columns\r\n      subtasksCount: true, // ✅ Show new columns\r\n      notes: true, // ✅ Show new columns\r\n      returnedAt: true, // ✅ Show new columns\r\n      completedAt: true,\r\n      createdBy: true,\r\n      createdAt: true,\r\n      updatedAt: true, // ✅ Show new columns\r\n      actions: true,\r\n    }),\r\n    []\r\n  );\r\n\r\n  // Column visibility: 15+ columns for better UX\r\n  const [columnVisibility, setColumnVisibility] = React.useState<VisibilityState>(() => defaultVisibleColumns);\r\n  const [columnOrder, setColumnOrder] = React.useState<ColumnOrderState>([]);\r\n  const [pinnedColumns, setPinnedColumns] = React.useState<string[]>(['select', 'actions']);\r\n\r\n  // Pagination state\r\n  const [pagination, setPagination] = React.useState({ pageIndex: 0, pageSize: 20 });\r\n\r\n  // Dialogs\r\n  const [deleteDialogOpen, setDeleteDialogOpen] = React.useState(false);\r\n  const [cancelDialogOpen, setCancelDialogOpen] = React.useState(false);\r\n  const [cancelQueue, setCancelQueue] = React.useState<WarrantyTicket[]>([]);\r\n  const bulkCancelRef = React.useRef(false);\r\n  const bulkCancelTicketIdsRef = React.useRef<Set<string>>(new Set());\r\n  const bulkCancelPendingRef = React.useRef(0);\r\n  const bulkCancelCompletedRef = React.useRef(0);\r\n  const currentCancelTicket = cancelQueue[0] ?? null;\r\n\r\n  // View mode: kanban or table\r\n  const [viewMode, setViewMode] = React.useState<'kanban' | 'table'>('table');\r\n\r\n  // Reminder system\r\n  const {\r\n    isReminderModalOpen,\r\n    openReminderModal,\r\n    closeReminderModal,\r\n    selectedTicket,\r\n    templates,\r\n    sendReminder,\r\n  } = useWarrantyReminders();\r\n\r\n  // Real-time updates\r\n  const [dataVersion, setDataVersion] = React.useState(() => getWarrantyDataVersion());\r\n  const { isPolling, togglePolling, refresh } = useRealtimeUpdates({\r\n    dataVersion,\r\n    onRefresh: () => {\r\n      // Reload warranty data\r\n      setDataVersion(getWarrantyDataVersion());\r\n      // Force re-render\r\n      window.location.reload();\r\n    },\r\n    interval: 30000 // 30 seconds\r\n  });\r\n\r\n\r\n  // ==========================================\r\n  // Handlers\r\n  // ==========================================\r\n  const handleEdit = React.useCallback(\r\n    (ticket: WarrantyTicket) => {\r\n      router.push(`/warranty/${ticket.systemId}/edit`);\r\n    },\r\n    [router]\r\n  );\r\n\r\n  const startCancelWorkflow = React.useCallback((ticketsToCancel: WarrantyTicket[], options?: { bulk?: boolean }) => {\r\n    if (!ticketsToCancel || ticketsToCancel.length === 0) {\r\n      toast.error('Không có phiếu hợp lệ để hủy');\r\n      return;\r\n    }\r\n\r\n    const normalized = ticketsToCancel\r\n      .filter((ticket): ticket is WarrantyTicket => Boolean(ticket))\r\n      .filter((ticket, index, self) => self.findIndex((item) => item.systemId === ticket.systemId) === index)\r\n      .filter((ticket) => ticket.status !== 'cancelled' && !ticket.cancelledAt);\r\n\r\n    const skipped = ticketsToCancel.length - normalized.length;\r\n\r\n    if (normalized.length === 0) {\r\n      toast.info('Các phiếu đã chọn đều đã bị hủy trước đó');\r\n      return;\r\n    }\r\n\r\n    if (skipped > 0) {\r\n      toast.info(`${skipped} phiếu đã được bỏ qua vì đã hủy trước đó.`);\r\n    }\r\n\r\n    const isBulk = Boolean(options?.bulk);\r\n    if (isBulk && bulkCancelPendingRef.current === 0) {\r\n      bulkCancelCompletedRef.current = 0;\r\n    }\r\n\r\n    setCancelQueue(prevQueue => {\r\n      if (prevQueue.length === 0) {\r\n        if (isBulk) {\r\n          normalized.forEach(ticket => bulkCancelTicketIdsRef.current.add(ticket.systemId));\r\n          bulkCancelPendingRef.current += normalized.length;\r\n          bulkCancelRef.current = true;\r\n        }\r\n        return normalized;\r\n      }\r\n\r\n      const existingIds = new Set(prevQueue.map(ticket => ticket.systemId));\r\n      const additionalTickets = normalized.filter(ticket => !existingIds.has(ticket.systemId));\r\n\r\n      if (additionalTickets.length === 0) {\r\n        toast.info('Các phiếu đã nằm trong hàng chờ hủy');\r\n        return prevQueue;\r\n      }\r\n\r\n      if (isBulk) {\r\n        additionalTickets.forEach(ticket => bulkCancelTicketIdsRef.current.add(ticket.systemId));\r\n        bulkCancelPendingRef.current += additionalTickets.length;\r\n        bulkCancelRef.current = true;\r\n      }\r\n\r\n      return [...prevQueue, ...additionalTickets];\r\n    });\r\n    setCancelDialogOpen(true);\r\n  }, []);\r\n\r\n  // Context menu handlers\r\n  const handleGetLink = React.useCallback((systemId: string) => {\r\n    const ticket = tickets.find(t => t.systemId === asSystemId(systemId));\r\n    if (!ticket) {\r\n      toast.error('Không tìm thấy phiếu bảo hành');\r\n      return;\r\n    }\r\n    const trackingPath = generatePath(ROUTES.INTERNAL.WARRANTY_TRACKING, {\r\n      trackingCode: ticket.publicTrackingCode || ticket.id,\r\n    });\r\n    const trackingUrl = `${window.location.origin}${trackingPath}`;\r\n    navigator.clipboard.writeText(trackingUrl);\r\n    toast.success('Đã copy link tracking vào clipboard');\r\n  }, [tickets]);\r\n\r\n  const handleStartProcessing = React.useCallback((systemId: string) => {\r\n    const normalizedId = asSystemId(systemId);\r\n    const ticket = tickets.find(t => t.systemId === normalizedId);\r\n    if (!ticket) {\r\n      toast.error('Không tìm thấy phiếu bảo hành');\r\n      return;\r\n    }\r\n\r\n    updateWarranty.mutate(\r\n      { systemId: normalizedId, data: { status: 'pending', statusReason: 'Bắt đầu xử lý từ danh sách' } },\r\n      { onSuccess: () => toast.success('Đã chuyển sang trạng thái Chưa xử lý') }\r\n    );\r\n  }, [tickets, updateWarranty]);\r\n\r\n  const handleMarkProcessed = React.useCallback((systemId: string) => {\r\n    const normalizedId = asSystemId(systemId);\r\n    const ticket = tickets.find(t => t.systemId === normalizedId);\r\n    if (!ticket) {\r\n      toast.error('Không tìm thấy phiếu bảo hành');\r\n      return;\r\n    }\r\n\r\n    updateWarranty.mutate(\r\n      { systemId: normalizedId, data: { status: 'processed', statusReason: 'Hoàn thành xử lý từ danh sách' } },\r\n      { onSuccess: () => toast.success('Đã hoàn thành xử lý') }\r\n    );\r\n  }, [tickets, updateWarranty]);\r\n\r\n  const handleMarkReturned = React.useCallback((systemId: string) => {\r\n    router.push(`/warranty/${systemId}`); // Go to detail page to link order\r\n  }, [router]);\r\n\r\n  const handleCancel = React.useCallback((systemId: string) => {\r\n    const normalizedId = asSystemId(systemId);\r\n    const ticket = tickets.find((t) => t.systemId === normalizedId);\r\n    if (!ticket) {\r\n      toast.error('Không tìm thấy phiếu bảo hành');\r\n      return;\r\n    }\r\n    startCancelWorkflow([ticket]);\r\n  }, [tickets, startCancelWorkflow]);\r\n\r\n  const handleCancelSuccess = React.useCallback((ticket: WarrantyTicket) => {\r\n    let queueBecameEmpty = false;\r\n\r\n    setCancelQueue(prevQueue => {\r\n      const [, ...rest] = prevQueue;\r\n      queueBecameEmpty = rest.length === 0;\r\n      return rest;\r\n    });\r\n\r\n    if (queueBecameEmpty) {\r\n      setCancelDialogOpen(false);\r\n    }\r\n\r\n    if (bulkCancelTicketIdsRef.current.has(ticket.systemId)) {\r\n      bulkCancelTicketIdsRef.current.delete(ticket.systemId);\r\n      bulkCancelPendingRef.current = Math.max(0, bulkCancelPendingRef.current - 1);\r\n      bulkCancelCompletedRef.current += 1;\r\n    }\r\n\r\n    if (bulkCancelRef.current && bulkCancelPendingRef.current === 0) {\r\n      const completed = bulkCancelCompletedRef.current || 0;\r\n      toast.success(`Đã hủy ${completed} phiếu bảo hành`);\r\n      setRowSelection({});\r\n      bulkCancelRef.current = false;\r\n      bulkCancelPendingRef.current = 0;\r\n      bulkCancelCompletedRef.current = 0;\r\n      bulkCancelTicketIdsRef.current.clear();\r\n    }\r\n\r\n    if (queueBecameEmpty && !bulkCancelRef.current) {\r\n      bulkCancelTicketIdsRef.current.clear();\r\n    }\r\n  }, [setRowSelection]);\r\n\r\n  const handleCancelDialogOpenChange = React.useCallback((open: boolean) => {\r\n    setCancelDialogOpen(open);\r\n    if (!open) {\r\n      setCancelQueue([]);\r\n      bulkCancelTicketIdsRef.current.clear();\r\n      bulkCancelPendingRef.current = 0;\r\n      bulkCancelCompletedRef.current = 0;\r\n      bulkCancelRef.current = false;\r\n    }\r\n  }, []);\r\n\r\n  const handleRemind = React.useCallback((systemId: string) => {\r\n    const ticket = tickets.find(t => t.systemId === asSystemId(systemId));\r\n    if (ticket) {\r\n      openReminderModal(ticket);\r\n    }\r\n  }, [tickets, openReminderModal]);\r\n\r\n  // Generate columns\r\n  const columns = React.useMemo(\r\n    () => {\r\n      const cols = getColumns(handleCancel, handleEdit, router, orders); // ✅ Pass orders\r\n      console.log('📊 Warranty columns generated:', cols.length, 'columns', cols.map(c => c.id));\r\n      return cols;\r\n    },\r\n    [handleCancel, handleEdit, router, orders] // ✅ Add orders dependency\r\n  );\r\n\r\n  const hasInitializedColumns = React.useRef(false);\r\n\r\n  React.useEffect(() => {\r\n    if (hasInitializedColumns.current) return;\r\n    const allColumnIds = columns.map((c) => c.id).filter(Boolean) as string[];\r\n    setColumnOrder(allColumnIds);\r\n    hasInitializedColumns.current = true;\r\n  }, [columns]);\r\n\r\n  // ==========================================\r\n  // Search with Fuse.js (threshold 0.3)\r\n  // ==========================================\r\n  const fuse = React.useMemo(() => {\r\n    return new Fuse(tickets, {\r\n      keys: ['id', 'customerName', 'customerPhone', 'trackingCode'],\r\n      threshold: 0.3,\r\n      ignoreLocation: true,\r\n    });\r\n  }, [tickets]);\r\n\r\n  const searchedData = React.useMemo(() => {\r\n    if (!debouncedSearch.trim()) return tickets;\r\n    return fuse.search(debouncedSearch.trim()).map((result) => result.item);\r\n  }, [fuse, debouncedSearch, tickets]);\r\n\r\n  // ==========================================\r\n  // Filters\r\n  // ==========================================\r\n  const filteredData = React.useMemo(() => {\r\n    let result = searchedData;\r\n\r\n    // Status filter\r\n    if (statusFilter.size > 0) {\r\n      result = result.filter((ticket) => statusFilter.has(ticket.status));\r\n    }\r\n\r\n    return result;\r\n  }, [searchedData, statusFilter]);\r\n\r\n  // ==========================================\r\n  // Sorting\r\n  // ==========================================\r\n  const sortedData = React.useMemo(() => {\r\n    if (!sorting || !sorting.id) return filteredData;\r\n\r\n    const sorted = [...filteredData];\r\n\r\n    sorted.sort((a, b) => {\r\n      const aValue = (a as any)[sorting.id];\r\n      const bValue = (b as any)[sorting.id];\r\n\r\n      if (aValue == null) return 1;\r\n      if (bValue == null) return -1;\r\n\r\n      if (typeof aValue === 'string') {\r\n        return sorting.desc\r\n          ? bValue.localeCompare(aValue)\r\n          : aValue.localeCompare(bValue);\r\n      }\r\n\r\n      if (typeof aValue === 'number') {\r\n        return sorting.desc ? bValue - aValue : aValue - bValue;\r\n      }\r\n\r\n      // Date comparison\r\n      const aDate = new Date(aValue).getTime();\r\n      const bDate = new Date(bValue).getTime();\r\n      return sorting.desc ? bDate - aDate : aDate - bDate;\r\n    });\r\n\r\n    return sorted;\r\n  }, [filteredData, sorting]);\r\n\r\n  // ==========================================\r\n  // Pagination\r\n  // ==========================================\r\n  const pageCount = React.useMemo(() => {\r\n    return Math.ceil(sortedData.length / pagination.pageSize);\r\n  }, [sortedData.length, pagination.pageSize]);\r\n\r\n  const paginatedData = React.useMemo(() => {\r\n    const start = pagination.pageIndex * pagination.pageSize;\r\n    const end = start + pagination.pageSize;\r\n    return sortedData.slice(start, end);\r\n  }, [sortedData, pagination]);\r\n\r\n  // ==========================================\r\n  // Bulk Actions\r\n  // ==========================================\r\n  const selectedTickets = React.useMemo(() => {\r\n    return sortedData.filter((ticket) => rowSelection[ticket.systemId]);\r\n  }, [sortedData, rowSelection]);\r\n\r\n  const handleBulkDelete = React.useCallback(() => {\r\n    selectedTickets.forEach((ticket) => {\r\n      deleteWarrantyMutation.mutate(ticket.systemId);\r\n    });\r\n    setRowSelection({});\r\n    setDeleteDialogOpen(false);\r\n  }, [selectedTickets, deleteWarrantyMutation]);\r\n\r\n  const handleExportSelected = React.useCallback(() => {\r\n    // Export selected rows\r\n    const dataToExport = selectedTickets.map((ticket) => ({\r\n      'Mã phiếu': ticket.id,\r\n      'Khách hàng': ticket.customerName,\r\n      'SĐT': ticket.customerPhone,\r\n      'Địa chỉ': ticket.customerAddress,\r\n      'Mã vận đơn': ticket.trackingCode,\r\n      'Phí vận chuyển': ticket.shippingFee,\r\n      'Trạng thái': WARRANTY_STATUS_LABELS[ticket.status],\r\n      'Số SP': ticket.summary.totalProducts,\r\n      'SP đổi mới': ticket.summary.totalReplaced,\r\n      'SP trả lại': ticket.summary.totalReturned,\r\n      'SP hết hàng': ticket.summary.totalOutOfStock,\r\n      'Tiền bù trừ': ticket.summary.totalDeduction,\r\n      'Ngày tạo': ticket.createdAt,\r\n    }));\r\n\r\n    const csv = [\r\n      Object.keys(dataToExport[0]).join(','),\r\n      ...dataToExport.map((row) => Object.values(row).join(',')),\r\n    ].join('\\n');\r\n\r\n    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });\r\n    const link = document.createElement('a');\r\n    link.href = URL.createObjectURL(blob);\r\n    link.download = `warranty-export-${new Date().toISOString()}.csv`;\r\n    link.click();\r\n  }, [selectedTickets]);\r\n\r\n  // Print imports\r\n  const { data: branches = [] } = useAllBranches();\r\n  const { data: storeInfo } = useStoreInfo();\r\n  const { printMultiple } = usePrint();\r\n  const [isPrintDialogOpen, setIsPrintDialogOpen] = React.useState(false);\r\n  const [pendingPrintTickets, setPendingPrintTickets] = React.useState<WarrantyTicket[]>([]);\r\n\r\n  const handleBulkPrint = React.useCallback(() => {\r\n    if (selectedTickets.length === 0) {\r\n      toast.error('Vui lòng chọn ít nhất một phiếu để in');\r\n      return;\r\n    }\r\n    setPendingPrintTickets(selectedTickets);\r\n    setIsPrintDialogOpen(true);\r\n  }, [selectedTickets]);\r\n\r\n  const handlePrintConfirm = React.useCallback((options: SimplePrintOptionsResult) => {\r\n    const { branchSystemId, paperSize } = options;\r\n    \r\n    const printOptionsList = pendingPrintTickets.map(ticket => {\r\n      const branch = branchSystemId \r\n        ? branches.find(b => b.systemId === branchSystemId)\r\n        : branches.find(b => b.systemId === ticket.branchSystemId);\r\n      const storeSettings = branch \r\n        ? createStoreSettings(branch)\r\n        : createStoreSettings(storeInfo);\r\n      const ticketData = convertWarrantyForPrint(ticket, { branch });\r\n      \r\n      return {\r\n        data: mapWarrantyToPrintData(ticketData, storeSettings),\r\n        lineItems: mapWarrantyLineItems(ticketData.items),\r\n        paperSize,\r\n      };\r\n    });\r\n    \r\n    printMultiple('warranty', printOptionsList);\r\n    \r\n    toast.success('Đã gửi lệnh in', {\r\n      description: `Đang in ${pendingPrintTickets.length} phiếu bảo hành`\r\n    });\r\n    setRowSelection({});\r\n    setPendingPrintTickets([]);\r\n  }, [pendingPrintTickets, branches, storeInfo, printMultiple]);\r\n\r\n  const handleBulkGetTrackingLink = React.useCallback(() => {\r\n    if (selectedTickets.length === 0) {\r\n      toast.error('Vui lòng chọn ít nhất một phiếu');\r\n      return;\r\n    }\r\n\r\n    try {\r\n      const trackingLinks = selectedTickets.map(ticket => {\r\n        const publicCode = ticket.publicTrackingCode || ticket.id;\r\n        const trackingPath = generatePath(ROUTES.INTERNAL.WARRANTY_TRACKING, { trackingCode: publicCode });\r\n        const trackingUrl = `${window.location.origin}${trackingPath}`;\r\n        return `${publicCode}: ${trackingUrl}`;\r\n      });\r\n      \r\n      navigator.clipboard.writeText(trackingLinks.join('\\n'));\r\n      toast.success(`Đã copy ${selectedTickets.length} link tracking vào clipboard`);\r\n    } catch (error) {\r\n      toast.error('Không thể copy link tracking');\r\n    }\r\n  }, [selectedTickets]);\r\n\r\n  const handleBulkCancel = React.useCallback(() => {\r\n    if (selectedTickets.length === 0) {\r\n      toast.error('Vui lòng chọn ít nhất một phiếu');\r\n      return;\r\n    }\r\n    startCancelWorkflow([...selectedTickets], { bulk: true });\r\n  }, [selectedTickets, startCancelWorkflow]);\r\n\r\n  // Bulk actions array\r\n  const bulkActions = React.useMemo(() => [\r\n    {\r\n      label: \"In\",\r\n      onSelect: handleBulkPrint\r\n    },\r\n    {\r\n      label: \"Get Link Tracking\",\r\n      onSelect: handleBulkGetTrackingLink\r\n    },\r\n    {\r\n      label: \"Hủy\",\r\n      onSelect: handleBulkCancel\r\n    }\r\n  ], [handleBulkPrint, handleBulkGetTrackingLink, handleBulkCancel]);\r\n\r\n  // ==========================================\r\n  // Kanban Data (Group by status)\r\n  // ==========================================\r\n  const ticketsByStatus = React.useMemo(() => {\r\n    const statuses: WarrantyStatus[] = ['incomplete', 'pending', 'processed', 'returned', 'completed'];\r\n    return statuses.reduce((acc, status) => {\r\n      acc[status] = sortedData.filter((ticket) => ticket.status === status && !ticket.cancelledAt); // Exclude cancelled\r\n      return acc;\r\n    }, {} as Record<WarrantyStatus, WarrantyTicket[]>);\r\n  }, [sortedData]);\r\n\r\n  // ==========================================\r\n  // Header Actions\r\n  // ==========================================\r\n  const actions = React.useMemo(\r\n    () => [\r\n      // Real-time toggle (LEFT)\r\n      <Button\r\n        key=\"realtime\"\r\n        variant={isPolling ? \"default\" : \"outline\"}\r\n        onClick={togglePolling}\r\n        size=\"sm\"\r\n        className=\"h-9\"\r\n      >\r\n        <RefreshCw className={cn(\"h-4 w-4 mr-2\", isPolling && \"animate-spin\")} />\r\n        {isPolling ? \"Live\" : \"Manual\"}\r\n      </Button>,\r\n      // Statistics (LEFT)\r\n      <Button\r\n        key=\"statistics\"\r\n        onClick={() => router.push('/warranty/statistics')}\r\n        variant=\"outline\"\r\n        size=\"sm\"\r\n        className=\"h-9\"\r\n      >\r\n        <BarChart3 className=\"h-4 w-4 mr-2\" />\r\n        Thống kê\r\n      </Button>,\r\n      // View toggle (RIGHT)\r\n      <Button\r\n        key=\"view-toggle\"\r\n        onClick={() => setViewMode(viewMode === 'kanban' ? 'table' : 'kanban')}\r\n        variant=\"outline\"\r\n        size=\"sm\"\r\n        className=\"h-9\"\r\n      >\r\n        {viewMode === 'kanban' ? (\r\n          <>\r\n            <Table className=\"h-4 w-4 mr-2\" />\r\n            Chế độ bảng\r\n          </>\r\n        ) : (\r\n          <>\r\n            <LayoutGrid className=\"h-4 w-4 mr-2\" />\r\n            Chế độ Kanban\r\n          </>\r\n        )}\r\n      </Button>,\r\n      // Create button (RIGHT)\r\n      <Button\r\n        key=\"new\"\r\n        onClick={() => router.push('/warranty/new')}\r\n        size=\"sm\"\r\n        className=\"h-9\"\r\n      >\r\n        <Plus className=\"h-4 w-4 mr-2\" />\r\n        Tạo phiếu mới\r\n      </Button>,\r\n    ],\r\n    [router, viewMode, isPolling, togglePolling]\r\n  );\r\n  const warrantyStats = React.useMemo(() => {\r\n    return tickets.reduce(\r\n      (acc, ticket) => {\r\n        acc.total += 1;\r\n        if (ticket.status === 'incomplete') acc.incomplete += 1;\r\n        if (ticket.status === 'pending') acc.pending += 1;\r\n        if (ticket.status === 'processed') acc.processed += 1;\r\n        if (ticket.status === 'returned') acc.returned += 1;\r\n        if (ticket.status === 'completed') acc.completed += 1;\r\n        if (ticket.status === 'cancelled') acc.cancelled += 1;\r\n        const overdue = checkWarrantyOverdue(ticket);\r\n        if (overdue.isOverdueResponse || overdue.isOverdueProcessing || overdue.isOverdueReturn) {\r\n          acc.overdue += 1;\r\n        }\r\n        return acc;\r\n      },\r\n      { total: 0, incomplete: 0, pending: 0, processed: 0, returned: 0, completed: 0, cancelled: 0, overdue: 0 }\r\n    );\r\n  }, [tickets]);\r\n\r\n  usePageHeader({\r\n    title: 'Quản lý bảo hành',\r\n    actions,\r\n    breadcrumb: [\r\n      { label: 'Trang chủ', href: '/', isCurrent: false },\r\n      { label: 'Quản lý bảo hành', href: '/warranty', isCurrent: true }\r\n    ]\r\n  });\r\n\r\n  // ==========================================\r\n  // Render\r\n  // ==========================================\r\n  return (\r\n    <div className=\"flex flex-col w-full h-full\">\r\n      {/* Toolbar - Import/Export & Column Customizer */}\r\n      {!isMobile && (\r\n        <PageToolbar\r\n          leftActions={\r\n            <>\r\n              <Button\r\n                onClick={() => router.push('/settings/warranty')}\r\n                variant=\"outline\"\r\n                size=\"sm\"\r\n              >\r\n                <Settings className=\"h-4 w-4 mr-2\" />\r\n                Cài đặt\r\n              </Button>\r\n              {/* TODO: Add Import/Export dialogs with proper config */}\r\n            </>\r\n          }\r\n          rightActions={\r\n            <>\r\n              <DataTableColumnCustomizer\r\n                columns={columns}\r\n                columnVisibility={columnVisibility}\r\n                setColumnVisibility={setColumnVisibility}\r\n                columnOrder={columnOrder}\r\n                setColumnOrder={setColumnOrder}\r\n                pinnedColumns={pinnedColumns}\r\n                setPinnedColumns={setPinnedColumns}\r\n              />\r\n            </>\r\n          }\r\n        />\r\n      )}\r\n\r\n      {/* Filters */}\r\n      <PageFilters\r\n        searchValue={searchQuery}\r\n        onSearchChange={setSearchQuery}\r\n        searchPlaceholder=\"Tìm theo mã phiếu, tên KH, SĐT, mã vận đơn...\"\r\n      >\r\n        {/* Status Filter */}\r\n        <DataTableFacetedFilter\r\n          title=\"Trạng thái\"\r\n          options={[\r\n            { label: 'Chưa đầy đủ', value: 'incomplete' },\r\n            { label: 'Chưa xử lý', value: 'pending' },\r\n            { label: 'Đã xử lý', value: 'processed' },\r\n            { label: 'Đã trả', value: 'returned' },\r\n          ]}\r\n          selectedValues={statusFilter}\r\n          onSelectedValuesChange={setStatusFilter}\r\n        />\r\n\r\n        {/* Clear filters */}\r\n        {(searchQuery || statusFilter.size > 0) && (\r\n          <Button\r\n            variant=\"ghost\"\r\n            size=\"sm\"\r\n            onClick={() => {\r\n              setSearchQuery('');\r\n              setStatusFilter(new Set());\r\n            }}\r\n          >\r\n            <X className=\"h-4 w-4 mr-2\" />\r\n            Xóa bộ lọc\r\n          </Button>\r\n        )}\r\n      </PageFilters>\r\n\r\n      {/* Table - Desktop View */}\r\n      <div className=\"w-full py-4\">\r\n        {viewMode === 'table' ? (\r\n          <ResponsiveDataTable<WarrantyTicket>\r\n            columns={columns as any}\r\n            data={paginatedData}\r\n            renderMobileCard={(ticket) => (\r\n              <WarrantyCard\r\n                key={ticket.systemId}\r\n                ticket={ticket}\r\n                onClick={() => router.push(`/warranty/${ticket.systemId}`)}\r\n              />\r\n            )}\r\n            pageCount={pageCount}\r\n            pagination={pagination}\r\n            setPagination={setPagination}\r\n            rowCount={sortedData.length}\r\n            rowSelection={rowSelection}\r\n            setRowSelection={setRowSelection}\r\n            onBulkDelete={() => setDeleteDialogOpen(true)}\r\n            bulkActions={bulkActions}\r\n            allSelectedRows={selectedTickets}\r\n            expanded={expanded}\r\n            setExpanded={setExpanded}\r\n            sorting={sorting}\r\n            setSorting={setSorting}\r\n            columnVisibility={columnVisibility}\r\n            setColumnVisibility={setColumnVisibility}\r\n            columnOrder={columnOrder}\r\n            setColumnOrder={setColumnOrder}\r\n            pinnedColumns={pinnedColumns}\r\n            setPinnedColumns={setPinnedColumns}\r\n            onRowClick={(ticket) => router.push(`/warranty/${ticket.systemId}`)}\r\n            getRowStyle={getRowStyle}\r\n          />\r\n        ) : (\r\n          <div className=\"flex gap-4 overflow-x-auto pb-4\">\r\n            <KanbanColumn\r\n              status=\"incomplete\"\r\n              tickets={ticketsByStatus.incomplete}\r\n              onTicketClick={(ticket) => router.push(`/warranty/${ticket.systemId}`)}\r\n              cardColors={cardColors}\r\n              onEdit={(systemId) => router.push(`/warranty/${systemId}/edit`)}\r\n              onGetLink={handleGetLink}\r\n              onStartProcessing={handleStartProcessing}\r\n              onMarkProcessed={handleMarkProcessed}\r\n              onMarkReturned={handleMarkReturned}\r\n              onCancel={handleCancel}\r\n              onRemind={handleRemind}\r\n            />\r\n            <KanbanColumn\r\n              status=\"pending\"\r\n              tickets={ticketsByStatus.pending}\r\n              onTicketClick={(ticket) => router.push(`/warranty/${ticket.systemId}`)}\r\n              cardColors={cardColors}\r\n              onEdit={(systemId) => router.push(`/warranty/${systemId}/edit`)}\r\n              onGetLink={handleGetLink}\r\n              onStartProcessing={handleStartProcessing}\r\n              onMarkProcessed={handleMarkProcessed}\r\n              onMarkReturned={handleMarkReturned}\r\n              onCancel={handleCancel}\r\n              onRemind={handleRemind}\r\n            />\r\n            <KanbanColumn\r\n              status=\"processed\"\r\n              tickets={ticketsByStatus.processed}\r\n              onTicketClick={(ticket) => router.push(`/warranty/${ticket.systemId}`)}\r\n              cardColors={cardColors}\r\n              onEdit={(systemId) => router.push(`/warranty/${systemId}/edit`)}\r\n              onGetLink={handleGetLink}\r\n              onStartProcessing={handleStartProcessing}\r\n              onMarkProcessed={handleMarkProcessed}\r\n              onMarkReturned={handleMarkReturned}\r\n              onCancel={handleCancel}\r\n              onRemind={handleRemind}\r\n            />\r\n            <KanbanColumn\r\n              status=\"returned\"\r\n              tickets={ticketsByStatus.returned}\r\n              onTicketClick={(ticket) => router.push(`/warranty/${ticket.systemId}`)}\r\n              cardColors={cardColors}\r\n              onEdit={(systemId) => router.push(`/warranty/${systemId}/edit`)}\r\n              onGetLink={handleGetLink}\r\n              onStartProcessing={handleStartProcessing}\r\n              onMarkProcessed={handleMarkProcessed}\r\n              onMarkReturned={handleMarkReturned}\r\n              onCancel={handleCancel}\r\n              onRemind={handleRemind}\r\n            />\r\n            <KanbanColumn\r\n              status=\"completed\"\r\n              tickets={ticketsByStatus.completed}\r\n              onTicketClick={(ticket) => router.push(`/warranty/${ticket.systemId}`)}\r\n              cardColors={cardColors}\r\n              onEdit={(systemId) => router.push(`/warranty/${systemId}/edit`)}\r\n              onGetLink={handleGetLink}\r\n              onStartProcessing={handleStartProcessing}\r\n              onMarkProcessed={handleMarkProcessed}\r\n              onMarkReturned={handleMarkReturned}\r\n              onCancel={handleCancel}\r\n              onRemind={handleRemind}\r\n            />\r\n          </div>\r\n        )}\r\n      </div>\r\n\r\n      {/* Cancel Dialog */}\r\n      <WarrantyCancelDialog\r\n        open={cancelDialogOpen && Boolean(currentCancelTicket)}\r\n        onOpenChange={handleCancelDialogOpenChange}\r\n        ticket={currentCancelTicket}\r\n        onCancelled={handleCancelSuccess}\r\n      />\r\n\r\n      {/* Reminder Dialog */}\r\n      <WarrantyReminderDialog\r\n        open={isReminderModalOpen}\r\n        onOpenChange={closeReminderModal}\r\n        ticket={selectedTicket}\r\n        templates={templates}\r\n        onSendReminder={sendReminder}\r\n      />\r\n\r\n      {/* Bulk Delete Confirmation */}\r\n      <AlertDialog open={deleteDialogOpen} onOpenChange={setDeleteDialogOpen}>\r\n        <AlertDialogContent>\r\n          <AlertDialogHeader>\r\n            <AlertDialogTitle>Xác nhận xóa</AlertDialogTitle>\r\n            <AlertDialogDescription>\r\n              Bạn có chắc muốn xóa {selectedTickets.length} phiếu bảo hành đã chọn?\r\n              Hành động này không thể hoàn tác.\r\n            </AlertDialogDescription>\r\n          </AlertDialogHeader>\r\n          <AlertDialogFooter>\r\n            <AlertDialogCancel>Hủy</AlertDialogCancel>\r\n            <AlertDialogAction onClick={handleBulkDelete}>Xóa</AlertDialogAction>\r\n          </AlertDialogFooter>\r\n        </AlertDialogContent>\r\n      </AlertDialog>\r\n\r\n      {/* Print Options Dialog */}\r\n      <SimplePrintOptionsDialog\r\n        open={isPrintDialogOpen}\r\n        onOpenChange={setIsPrintDialogOpen}\r\n        onConfirm={handlePrintConfirm}\r\n        selectedCount={pendingPrintTickets.length}\r\n        title=\"In phiếu bảo hành\"\r\n      />\r\n    </div>\r\n  );\r\n}\r\n"],"names":[],"mappings":"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"}}]
}