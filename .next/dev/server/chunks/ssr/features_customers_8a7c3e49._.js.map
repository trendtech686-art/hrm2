{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/customers/api/customers-api.ts"],"sourcesContent":["/**\r\n * Customers API - Isolated API functions\r\n * \r\n * ⚠️ IMPORTANT: This file should ONLY contain:\r\n * - Fetch functions\r\n * - Type imports from ../types\r\n * - NO store imports\r\n * - NO cross-feature imports\r\n */\r\n\r\nimport type { Customer } from '../types';\r\n\r\nconst API_BASE = '/api/customers';\r\n\r\nexport interface CustomersParams {\r\n  page?: number;\r\n  limit?: number;\r\n  search?: string;\r\n  status?: string;\r\n  type?: string;\r\n  targetGroup?: string;\r\n  lifecycleStage?: string;\r\n  hasDebt?: boolean;\r\n  sortBy?: string;\r\n  sortOrder?: 'asc' | 'desc';\r\n}\r\n\r\nexport interface PaginatedResponse<T> {\r\n  data: T[];\r\n  pagination: {\r\n    page: number;\r\n    limit: number;\r\n    total: number;\r\n    totalPages: number;\r\n  };\r\n}\r\n\r\nexport interface CreateCustomerInput {\r\n  name: string;\r\n  email?: string;\r\n  phone?: string;\r\n  company?: string;\r\n  addresses?: Array<{\r\n    street: string;\r\n    ward?: string;\r\n    district?: string;\r\n    province?: string;\r\n    isDefault?: boolean;\r\n  }>;\r\n  notes?: string;\r\n  // Optional fields for updates\r\n  isDeleted?: boolean;\r\n  status?: string;\r\n}\r\n\r\nexport interface UpdateCustomerInput extends Partial<CreateCustomerInput> {\r\n  systemId: string;\r\n}\r\n\r\n/**\r\n * Fetch paginated customers list\r\n */\r\nexport async function fetchCustomers(params: CustomersParams = {}): Promise<PaginatedResponse<Customer>> {\r\n  const { page = 1, limit = 50, ...rest } = params;\r\n  \r\n  const searchParams = new URLSearchParams({\r\n    page: String(page),\r\n    limit: String(limit),\r\n  });\r\n  \r\n  // Add optional params\r\n  Object.entries(rest).forEach(([key, value]) => {\r\n    if (value != null && value !== '') {\r\n      searchParams.set(key, String(value));\r\n    }\r\n  });\r\n  \r\n  const res = await fetch(`${API_BASE}?${searchParams}`, {\r\n    credentials: 'include',\r\n  });\r\n  \r\n  if (!res.ok) {\r\n    throw new Error(`Failed to fetch customers: ${res.statusText}`);\r\n  }\r\n  \r\n  return res.json();\r\n}\r\n\r\n/**\r\n * Fetch single customer by ID\r\n */\r\nexport async function fetchCustomer(id: string): Promise<Customer> {\r\n  const res = await fetch(`${API_BASE}/${id}`, {\r\n    credentials: 'include',\r\n  });\r\n  \r\n  if (!res.ok) {\r\n    throw new Error(`Failed to fetch customer ${id}: ${res.statusText}`);\r\n  }\r\n  \r\n  return res.json();\r\n}\r\n\r\n/**\r\n * Create new customer\r\n */\r\nexport async function createCustomer(data: CreateCustomerInput): Promise<Customer> {\r\n  const res = await fetch(API_BASE, {\r\n    method: 'POST',\r\n    headers: { 'Content-Type': 'application/json' },\r\n    credentials: 'include',\r\n    body: JSON.stringify(data),\r\n  });\r\n  \r\n  if (!res.ok) {\r\n    const error = await res.json().catch(() => ({}));\r\n    throw new Error(error.message || `Failed to create customer: ${res.statusText}`);\r\n  }\r\n  \r\n  return res.json();\r\n}\r\n\r\n/**\r\n * Update existing customer\r\n */\r\nexport async function updateCustomer({ systemId, ...data }: UpdateCustomerInput): Promise<Customer> {\r\n  const res = await fetch(`${API_BASE}/${systemId}`, {\r\n    method: 'PATCH',\r\n    headers: { 'Content-Type': 'application/json' },\r\n    credentials: 'include',\r\n    body: JSON.stringify(data),\r\n  });\r\n  \r\n  if (!res.ok) {\r\n    const error = await res.json().catch(() => ({}));\r\n    throw new Error(error.message || `Failed to update customer: ${res.statusText}`);\r\n  }\r\n  \r\n  return res.json();\r\n}\r\n\r\n/**\r\n * Delete customer (soft delete)\r\n */\r\nexport async function deleteCustomer(id: string): Promise<void> {\r\n  const res = await fetch(`${API_BASE}/${id}`, {\r\n    method: 'DELETE',\r\n    credentials: 'include',\r\n  });\r\n  \r\n  if (!res.ok) {\r\n    const error = await res.json().catch(() => ({}));\r\n    throw new Error(error.message || `Failed to delete customer: ${res.statusText}`);\r\n  }\r\n}\r\n\r\n/**\r\n * Search customers for autocomplete\r\n */\r\nexport async function searchCustomers(query: string, limit = 20): Promise<Customer[]> {\r\n  const res = await fetch(`${API_BASE}?search=${encodeURIComponent(query)}&limit=${limit}`, {\r\n    credentials: 'include',\r\n  });\r\n  \r\n  if (!res.ok) {\r\n    throw new Error(`Failed to search customers: ${res.statusText}`);\r\n  }\r\n  \r\n  const json = await res.json();\r\n  return json.data || [];\r\n}\r\n\r\n/**\r\n * Fetch customer debt summary\r\n */\r\nexport async function fetchCustomerDebt(customerId: string): Promise<{\r\n  totalDebt: number;\r\n  overdueDebt: number;\r\n  transactions: Array<{\r\n    orderId: string;\r\n    amount: number;\r\n    dueDate: string;\r\n    status: string;\r\n  }>;\r\n}> {\r\n  const res = await fetch(`${API_BASE}/${customerId}/debt`, {\r\n    credentials: 'include',\r\n  });\r\n  \r\n  if (!res.ok) {\r\n    throw new Error(`Failed to fetch customer debt: ${res.statusText}`);\r\n  }\r\n  \r\n  return res.json();\r\n}\r\n\r\n/**\r\n * Fetch customer order history\r\n */\r\nexport async function fetchCustomerOrders(customerId: string, params: { page?: number; limit?: number } = {}): Promise<PaginatedResponse<unknown>> {\r\n  const { page = 1, limit = 20 } = params;\r\n  \r\n  const res = await fetch(`${API_BASE}/${customerId}/orders?page=${page}&limit=${limit}`, {\r\n    credentials: 'include',\r\n  });\r\n  \r\n  if (!res.ok) {\r\n    throw new Error(`Failed to fetch customer orders: ${res.statusText}`);\r\n  }\r\n  \r\n  return res.json();\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 133, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/customers/hooks/use-customers.ts"],"sourcesContent":["/**\r\n * useCustomers - React Query hooks for customers\r\n * \r\n * ⚠️ IMPORTANT: Direct import pattern\r\n * - Import this file directly: import { useCustomers } from '@/features/customers/hooks/use-customers'\r\n * - NEVER import from '@/features/customers' or '@/features/customers/store'\r\n * \r\n * This hook is ISOLATED - it only depends on:\r\n * - @tanstack/react-query\r\n * - Local API functions\r\n * - Local types\r\n */\r\n\r\nimport { useQuery, useMutation, useQueryClient, keepPreviousData } from '@tanstack/react-query';\r\nimport {\r\n  fetchCustomers,\r\n  fetchCustomer,\r\n  createCustomer,\r\n  updateCustomer,\r\n  deleteCustomer,\r\n  searchCustomers,\r\n  fetchCustomerDebt,\r\n  fetchCustomerOrders,\r\n  type CustomersParams,\r\n  type CreateCustomerInput,\r\n  type UpdateCustomerInput,\r\n} from '../api/customers-api';\r\n\r\n// Query keys - exported for invalidation\r\nexport const customerKeys = {\r\n  all: ['customers'] as const,\r\n  lists: () => [...customerKeys.all, 'list'] as const,\r\n  list: (params: CustomersParams) => [...customerKeys.lists(), params] as const,\r\n  details: () => [...customerKeys.all, 'detail'] as const,\r\n  detail: (id: string) => [...customerKeys.details(), id] as const,\r\n  search: (query: string) => [...customerKeys.all, 'search', query] as const,\r\n  debt: (id: string) => [...customerKeys.all, 'debt', id] as const,\r\n  orders: (id: string, params?: { page?: number; limit?: number }) => [...customerKeys.all, 'orders', id, params] as const,\r\n};\r\n\r\n/**\r\n * Hook for fetching paginated customers list\r\n * \r\n * @example\r\n * ```tsx\r\n * function CustomersPage() {\r\n *   const [page, setPage] = useState(1);\r\n *   const { data, isLoading } = useCustomers({ page, limit: 50 });\r\n *   \r\n *   return (\r\n *     <DataTable \r\n *       data={data?.data || []} \r\n *       pagination={data?.pagination}\r\n *       onPageChange={setPage}\r\n *     />\r\n *   );\r\n * }\r\n * ```\r\n */\r\nexport function useCustomers(params: CustomersParams = {}) {\r\n  return useQuery({\r\n    queryKey: customerKeys.list(params),\r\n    queryFn: () => fetchCustomers(params),\r\n    staleTime: 60_000, // 1 minute\r\n    gcTime: 10 * 60 * 1000, // 10 minutes\r\n    placeholderData: keepPreviousData,\r\n  });\r\n}\r\n\r\n/**\r\n * Hook for fetching single customer by ID\r\n */\r\nexport function useCustomer(id: string | null | undefined) {\r\n  return useQuery({\r\n    queryKey: customerKeys.detail(id!),\r\n    queryFn: () => fetchCustomer(id!),\r\n    enabled: !!id,\r\n    staleTime: 60_000,\r\n    gcTime: 10 * 60 * 1000,\r\n  });\r\n}\r\n\r\n/**\r\n * Hook for searching customers (autocomplete)\r\n */\r\nexport function useCustomerSearch(query: string, limit = 20) {\r\n  return useQuery({\r\n    queryKey: customerKeys.search(query),\r\n    queryFn: () => searchCustomers(query, limit),\r\n    enabled: query.length >= 2,\r\n    staleTime: 30_000,\r\n  });\r\n}\r\n\r\n/**\r\n * Hook for fetching customer debt info\r\n */\r\nexport function useCustomerDebt(customerId: string | null | undefined) {\r\n  return useQuery({\r\n    queryKey: customerKeys.debt(customerId!),\r\n    queryFn: () => fetchCustomerDebt(customerId!),\r\n    enabled: !!customerId,\r\n    staleTime: 30_000,\r\n  });\r\n}\r\n\r\n/**\r\n * Hook for fetching customer order history\r\n */\r\nexport function useCustomerOrders(customerId: string | null | undefined, params: { page?: number; limit?: number } = {}) {\r\n  return useQuery({\r\n    queryKey: customerKeys.orders(customerId!, params),\r\n    queryFn: () => fetchCustomerOrders(customerId!, params),\r\n    enabled: !!customerId,\r\n    staleTime: 60_000,\r\n    placeholderData: keepPreviousData,\r\n  });\r\n}\r\n\r\n/**\r\n * Hook for customer mutations (create/update/delete)\r\n */\r\ninterface UseCustomerMutationsOptions {\r\n  onCreateSuccess?: (customer: unknown) => void;\r\n  onUpdateSuccess?: (customer: unknown) => void;\r\n  onDeleteSuccess?: () => void;\r\n  onError?: (error: Error) => void;\r\n}\r\n\r\nexport function useCustomerMutations(options: UseCustomerMutationsOptions = {}) {\r\n  const queryClient = useQueryClient();\r\n  \r\n  const create = useMutation({\r\n    mutationFn: createCustomer,\r\n    onSuccess: (data) => {\r\n      queryClient.invalidateQueries({ queryKey: customerKeys.lists() });\r\n      options.onCreateSuccess?.(data);\r\n    },\r\n    onError: options.onError,\r\n  });\r\n  \r\n  const update = useMutation({\r\n    mutationFn: updateCustomer,\r\n    onSuccess: (data, variables) => {\r\n      queryClient.invalidateQueries({ queryKey: customerKeys.detail(variables.systemId) });\r\n      queryClient.invalidateQueries({ queryKey: customerKeys.lists() });\r\n      options.onUpdateSuccess?.(data);\r\n    },\r\n    onError: options.onError,\r\n  });\r\n  \r\n  const remove = useMutation({\r\n    mutationFn: deleteCustomer,\r\n    onSuccess: () => {\r\n      queryClient.invalidateQueries({ queryKey: customerKeys.all });\r\n      options.onDeleteSuccess?.();\r\n    },\r\n    onError: options.onError,\r\n  });\r\n  \r\n  return {\r\n    create,\r\n    update,\r\n    remove,\r\n    isCreating: create.isPending,\r\n    isUpdating: update.isPending,\r\n    isDeleting: remove.isPending,\r\n    isMutating: create.isPending || update.isPending || remove.isPending,\r\n  };\r\n}\r\n\r\n/**\r\n * Hook for getting customers with debt\r\n */\r\nexport function useCustomersWithDebt(params: Omit<CustomersParams, 'hasDebt'> = {}) {\r\n  return useCustomers({ ...params, hasDebt: true });\r\n}\r\n\r\n/**\r\n * Hook for getting VIP customers\r\n */\r\nexport function useVIPCustomers(params: Omit<CustomersParams, 'lifecycleStage'> = {}) {\r\n  return useCustomers({ ...params, lifecycleStage: 'Khách VIP' });\r\n}\r\n\r\n/**\r\n * Hook for getting active customers\r\n */\r\nexport function useActiveCustomers(params: Omit<CustomersParams, 'status'> = {}) {\r\n  return useCustomers({ ...params, status: 'active' });\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 320, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/customers/hooks/use-all-customers.ts"],"sourcesContent":["/**\r\n * useAllCustomers - Convenience hook for components needing all customers as flat array\r\n */\r\n\r\nimport * as React from 'react';\r\nimport { useCustomers } from './use-customers';\r\nimport type { SystemId } from '@/lib/id-types';\r\n\r\nexport function useAllCustomers() {\r\n  const query = useCustomers({ limit: 30 });\r\n  \r\n  return {\r\n    data: query.data?.data || [],\r\n    isLoading: query.isLoading,\r\n    isError: query.isError,\r\n    error: query.error,\r\n  };\r\n}\r\n\r\n/**\r\n * Helper hook to find a customer by ID from cached data\r\n * Replaces legacy findById() method\r\n */\r\nexport function useCustomerFinder() {\r\n  const { data } = useAllCustomers();\r\n  \r\n  const findById = React.useCallback(\r\n    (systemId: SystemId | string | undefined) => {\r\n      if (!systemId) return undefined;\r\n      return data.find(c => c.systemId === systemId);\r\n    },\r\n    [data]\r\n  );\r\n  \r\n  return { findById };\r\n}\r\n"],"names":[],"mappings":";;;;;;AAAA;;CAEC,GAED;AACA;;;AAGO,SAAS;IACd,MAAM,QAAQ,IAAA,kKAAY,EAAC;QAAE,OAAO;IAAG;IAEvC,OAAO;QACL,MAAM,MAAM,IAAI,EAAE,QAAQ,EAAE;QAC5B,WAAW,MAAM,SAAS;QAC1B,SAAS,MAAM,OAAO;QACtB,OAAO,MAAM,KAAK;IACpB;AACF;AAMO,SAAS;IACd,MAAM,EAAE,IAAI,EAAE,GAAG;IAEjB,MAAM,WAAW,oNAAiB,CAChC,CAAC;QACC,IAAI,CAAC,UAAU,OAAO;QACtB,OAAO,KAAK,IAAI,CAAC,CAAA,IAAK,EAAE,QAAQ,KAAK;IACvC,GACA;QAAC;KAAK;IAGR,OAAO;QAAE;IAAS;AACpB"}},
    {"offset": {"line": 359, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/customers/lifecycle-utils.ts"],"sourcesContent":["import type { Customer, CustomerLifecycleStage } from './types';\r\nimport { formatDate, formatDateTime, formatDateTimeSeconds, formatDateCustom, getCurrentDate, getDaysDiff } from '@/lib/date-utils';\r\n/**\r\n * Tự động tính toán giai đoạn vòng đời khách hàng dựa trên hành vi\r\n */\r\nexport const calculateLifecycleStage = (customer: Customer): CustomerLifecycleStage => {\r\n  const totalOrders = customer.totalOrders || 0;\r\n  const totalSpent = customer.totalSpent || 0;\r\n  const lastPurchaseDate = customer.lastPurchaseDate;\r\n  \r\n  // Nếu chưa mua lần nào\r\n  if (totalOrders === 0) {\r\n    return \"Khách tiềm năng\";\r\n  }\r\n  \r\n  // Tính số ngày từ lần mua cuối\r\n  const daysSinceLastPurchase = lastPurchaseDate \r\n    ? getDaysDiff(getCurrentDate(), new Date(lastPurchaseDate))\r\n    : Infinity;\r\n  \r\n  // Khách đã mất (không mua > 365 ngày)\r\n  if (daysSinceLastPurchase > 365) {\r\n    return \"Mất khách\";\r\n  }\r\n  \r\n  // Không hoạt động (không mua > 180 ngày)\r\n  if (daysSinceLastPurchase > 180) {\r\n    return \"Không hoạt động\";\r\n  }\r\n  \r\n  // Khách VIP: Top 10% spending (>= 50 triệu) và mua >= 5 lần\r\n  if (totalSpent >= 50_000_000 && totalOrders >= 5) {\r\n    return \"Khách VIP\";\r\n  }\r\n  \r\n  // Khách thân thiết: Mua >= 5 lần\r\n  if (totalOrders >= 5) {\r\n    return \"Khách thân thiết\";\r\n  }\r\n  \r\n  // Khách quay lại: Mua 2-4 lần\r\n  if (totalOrders >= 2) {\r\n    return \"Khách quay lại\";\r\n  }\r\n  \r\n  // Khách mới: Mua lần đầu\r\n  return \"Khách mới\";\r\n};\r\n\r\n/**\r\n * Lấy màu badge cho lifecycle stage\r\n */\r\nexport const getLifecycleStageVariant = (stage?: CustomerLifecycleStage): \r\n  'default' | 'secondary' | 'success' | 'warning' | 'destructive' => {\r\n  switch (stage) {\r\n    case \"Khách VIP\":\r\n      return \"success\";\r\n    case \"Khách thân thiết\":\r\n      return \"success\";\r\n    case \"Khách quay lại\":\r\n      return \"default\";\r\n    case \"Khách mới\":\r\n      return \"secondary\";\r\n    case \"Khách tiềm năng\":\r\n      return \"secondary\";\r\n    case \"Không hoạt động\":\r\n      return \"warning\";\r\n    case \"Mất khách\":\r\n      return \"destructive\";\r\n    default:\r\n      return \"secondary\";\r\n  }\r\n};\r\n\r\n/**\r\n * Cập nhật lifecycle stage cho tất cả customers (chạy batch)\r\n */\r\nexport const updateAllCustomerLifecycleStages = (customers: Customer[]): Customer[] => {\r\n  return customers.map(customer => ({\r\n    ...customer,\r\n    lifecycleStage: calculateLifecycleStage(customer)\r\n  }));\r\n};\r\n"],"names":[],"mappings":";;;;;;;;AACA;;AAIO,MAAM,0BAA0B,CAAC;IACtC,MAAM,cAAc,SAAS,WAAW,IAAI;IAC5C,MAAM,aAAa,SAAS,UAAU,IAAI;IAC1C,MAAM,mBAAmB,SAAS,gBAAgB;IAElD,uBAAuB;IACvB,IAAI,gBAAgB,GAAG;QACrB,OAAO;IACT;IAEA,+BAA+B;IAC/B,MAAM,wBAAwB,mBAC1B,IAAA,mIAAW,EAAC,IAAA,sIAAc,KAAI,IAAI,KAAK,qBACvC;IAEJ,sCAAsC;IACtC,IAAI,wBAAwB,KAAK;QAC/B,OAAO;IACT;IAEA,yCAAyC;IACzC,IAAI,wBAAwB,KAAK;QAC/B,OAAO;IACT;IAEA,4DAA4D;IAC5D,IAAI,cAAc,cAAc,eAAe,GAAG;QAChD,OAAO;IACT;IAEA,iCAAiC;IACjC,IAAI,eAAe,GAAG;QACpB,OAAO;IACT;IAEA,8BAA8B;IAC9B,IAAI,eAAe,GAAG;QACpB,OAAO;IACT;IAEA,yBAAyB;IACzB,OAAO;AACT;AAKO,MAAM,2BAA2B,CAAC;IAEvC,OAAQ;QACN,KAAK;YACH,OAAO;QACT,KAAK;YACH,OAAO;QACT,KAAK;YACH,OAAO;QACT,KAAK;YACH,OAAO;QACT,KAAK;YACH,OAAO;QACT,KAAK;YACH,OAAO;QACT,KAAK;YACH,OAAO;QACT;YACE,OAAO;IACX;AACF;AAKO,MAAM,mCAAmC,CAAC;IAC/C,OAAO,UAAU,GAAG,CAAC,CAAA,WAAY,CAAC;YAChC,GAAG,QAAQ;YACX,gBAAgB,wBAAwB;QAC1C,CAAC;AACH"}},
    {"offset": {"line": 432, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/customers/credit-utils.ts"],"sourcesContent":["import type { Customer } from './types';\r\n\r\nexport type CreditAlertLevel = 'safe' | 'warning' | 'danger' | 'exceeded';\r\n\r\n/**\r\n * Tính mức độ cảnh báo công nợ\r\n */\r\nexport const getCreditAlertLevel = (customer: Customer): CreditAlertLevel => {\r\n  const currentDebt = customer.currentDebt || 0;\r\n  const maxDebt = customer.maxDebt || 0;\r\n  \r\n  // Nếu không có hạn mức hoặc hạn mức = 0, không cảnh báo\r\n  if (maxDebt === 0) return 'safe';\r\n  \r\n  const debtRatio = (currentDebt / maxDebt) * 100;\r\n  \r\n  if (debtRatio >= 100) return 'exceeded';  // Vượt hạn mức\r\n  if (debtRatio >= 90) return 'danger';     // >= 90%\r\n  if (debtRatio >= 70) return 'warning';    // >= 70%\r\n  return 'safe';                             // < 70%\r\n};\r\n\r\n/**\r\n * Lấy variant Badge cho credit alert\r\n */\r\nexport const getCreditAlertBadgeVariant = (level: CreditAlertLevel): \r\n  'default' | 'secondary' | 'success' | 'warning' | 'destructive' => {\r\n  switch (level) {\r\n    case 'exceeded':\r\n    case 'danger':\r\n      return 'destructive';\r\n    case 'warning':\r\n      return 'warning';\r\n    case 'safe':\r\n      return 'success';\r\n    default:\r\n      return 'secondary';\r\n  }\r\n};\r\n\r\n/**\r\n * Lấy text cho credit alert\r\n */\r\nexport const getCreditAlertText = (level: CreditAlertLevel): string => {\r\n  switch (level) {\r\n    case 'exceeded':\r\n      return 'Vượt hạn mức';\r\n    case 'danger':\r\n      return 'Sắp vượt hạn';\r\n    case 'warning':\r\n      return 'Cần theo dõi';\r\n    case 'safe':\r\n      return 'An toàn';\r\n    default:\r\n      return '';\r\n  }\r\n};\r\n\r\n/**\r\n * Kiểm tra xem có thể tạo đơn hàng không (dựa vào công nợ)\r\n */\r\nexport const canCreateOrder = (customer: Customer, orderAmount: number): {\r\n  allowed: boolean;\r\n  reason?: string;\r\n} => {\r\n  const currentDebt = customer.currentDebt || 0;\r\n  const maxDebt = customer.maxDebt || 0;\r\n  \r\n  // Nếu không cho phép công nợ và có công nợ hiện tại\r\n  if (!customer.allowCredit && currentDebt > 0) {\r\n    return {\r\n      allowed: false,\r\n      reason: 'Khách hàng không được phép công nợ và còn nợ cũ'\r\n    };\r\n  }\r\n  \r\n  // Nếu có hạn mức công nợ\r\n  if (maxDebt > 0) {\r\n    const newDebt = currentDebt + orderAmount;\r\n    if (newDebt > maxDebt) {\r\n      return {\r\n        allowed: false,\r\n        reason: `Đơn hàng này sẽ vượt hạn mức công nợ (${formatCurrency(newDebt)} / ${formatCurrency(maxDebt)})`\r\n      };\r\n    }\r\n  }\r\n  \r\n  return { allowed: true };\r\n};\r\n\r\n/**\r\n * Lấy danh sách khách hàng có nguy cơ công nợ cao\r\n */\r\nexport const getHighRiskDebtCustomers = (customers: Customer[]): Customer[] => {\r\n  return customers.filter(customer => {\r\n    const level = getCreditAlertLevel(customer);\r\n    return level === 'danger' || level === 'exceeded';\r\n  }).sort((a, b) => {\r\n    const ratioA = ((a.currentDebt || 0) / (a.maxDebt || 1)) * 100;\r\n    const ratioB = ((b.currentDebt || 0) / (b.maxDebt || 1)) * 100;\r\n    return ratioB - ratioA; // Sort by ratio descending\r\n  });\r\n};\r\n\r\n/**\r\n * Helper format currency\r\n */\r\nconst formatCurrency = (value: number): string => {\r\n  return new Intl.NumberFormat('vi-VN', { \r\n    style: 'currency', \r\n    currency: 'VND' \r\n  }).format(value);\r\n};\r\n"],"names":[],"mappings":";;;;;;;;;;;;AAOO,MAAM,sBAAsB,CAAC;IAClC,MAAM,cAAc,SAAS,WAAW,IAAI;IAC5C,MAAM,UAAU,SAAS,OAAO,IAAI;IAEpC,wDAAwD;IACxD,IAAI,YAAY,GAAG,OAAO;IAE1B,MAAM,YAAY,AAAC,cAAc,UAAW;IAE5C,IAAI,aAAa,KAAK,OAAO,YAAa,eAAe;IACzD,IAAI,aAAa,IAAI,OAAO,UAAc,SAAS;IACnD,IAAI,aAAa,IAAI,OAAO,WAAc,SAAS;IACnD,OAAO,QAAoC,QAAQ;AACrD;AAKO,MAAM,6BAA6B,CAAC;IAEzC,OAAQ;QACN,KAAK;QACL,KAAK;YACH,OAAO;QACT,KAAK;YACH,OAAO;QACT,KAAK;YACH,OAAO;QACT;YACE,OAAO;IACX;AACF;AAKO,MAAM,qBAAqB,CAAC;IACjC,OAAQ;QACN,KAAK;YACH,OAAO;QACT,KAAK;YACH,OAAO;QACT,KAAK;YACH,OAAO;QACT,KAAK;YACH,OAAO;QACT;YACE,OAAO;IACX;AACF;AAKO,MAAM,iBAAiB,CAAC,UAAoB;IAIjD,MAAM,cAAc,SAAS,WAAW,IAAI;IAC5C,MAAM,UAAU,SAAS,OAAO,IAAI;IAEpC,oDAAoD;IACpD,IAAI,CAAC,SAAS,WAAW,IAAI,cAAc,GAAG;QAC5C,OAAO;YACL,SAAS;YACT,QAAQ;QACV;IACF;IAEA,yBAAyB;IACzB,IAAI,UAAU,GAAG;QACf,MAAM,UAAU,cAAc;QAC9B,IAAI,UAAU,SAAS;YACrB,OAAO;gBACL,SAAS;gBACT,QAAQ,CAAC,sCAAsC,EAAE,eAAe,SAAS,GAAG,EAAE,eAAe,SAAS,CAAC,CAAC;YAC1G;QACF;IACF;IAEA,OAAO;QAAE,SAAS;IAAK;AACzB;AAKO,MAAM,2BAA2B,CAAC;IACvC,OAAO,UAAU,MAAM,CAAC,CAAA;QACtB,MAAM,QAAQ,oBAAoB;QAClC,OAAO,UAAU,YAAY,UAAU;IACzC,GAAG,IAAI,CAAC,CAAC,GAAG;QACV,MAAM,SAAS,AAAC,CAAC,EAAE,WAAW,IAAI,CAAC,IAAI,CAAC,EAAE,OAAO,IAAI,CAAC,IAAK;QAC3D,MAAM,SAAS,AAAC,CAAC,EAAE,WAAW,IAAI,CAAC,IAAI,CAAC,EAAE,OAAO,IAAI,CAAC,IAAK;QAC3D,OAAO,SAAS,QAAQ,2BAA2B;IACrD;AACF;AAEA;;CAEC,GACD,MAAM,iBAAiB,CAAC;IACtB,OAAO,IAAI,KAAK,YAAY,CAAC,SAAS;QACpC,OAAO;QACP,UAAU;IACZ,GAAG,MAAM,CAAC;AACZ"}},
    {"offset": {"line": 528, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/customers/intelligence-utils.ts"],"sourcesContent":["import type { Customer } from './types';\r\nimport { formatDate, formatDateTime, formatDateTimeSeconds, formatDateCustom, getCurrentDate, getDaysDiff } from '@/lib/date-utils';\r\n// RFM Score types\r\nexport type RFMScore = {\r\n  recency: 1 | 2 | 3 | 4 | 5;      // 5 = Best (mua gần đây)\r\n  frequency: 1 | 2 | 3 | 4 | 5;    // 5 = Best (mua thường xuyên)\r\n  monetary: 1 | 2 | 3 | 4 | 5;     // 5 = Best (chi tiêu nhiều)\r\n};\r\n\r\n// Customer Segment based on RFM\r\nexport type CustomerSegment = \r\n  | 'Champions'           // RFM: 5-5-5, 5-4-5, 4-5-5 - Khách hàng tốt nhất\r\n  | 'Loyal Customers'     // RFM: 4-4-4, 4-5-4, 5-4-4 - Khách thân thiết\r\n  | 'Potential Loyalist'  // RFM: 4-3-*, 3-4-*, 5-3-* - Tiềm năng trở thành thân thiết\r\n  | 'New Customers'       // RFM: 5-1-*, 4-1-* - Khách mới\r\n  | 'Promising'           // RFM: 4-2-*, 3-3-* - Đầy hứa hẹn\r\n  | 'Need Attention'      // RFM: 3-2-*, 2-3-* - Cần chú ý\r\n  | 'About To Sleep'      // RFM: 3-1-*, 2-2-* - Sắp ngủ đông\r\n  | 'At Risk'             // RFM: 2-5-*, 2-4-*, 1-3-* - Có nguy cơ\r\n  | 'Cannot Lose Them'    // RFM: 1-5-5, 1-4-5 - Không thể mất\r\n  | 'Hibernating'         // RFM: 2-1-*, 1-2-* - Ngủ đông\r\n  | 'Lost';               // RFM: 1-1-* - Đã mất\r\n\r\n/**\r\n * Tính RFM scores cho một khách hàng\r\n */\r\nexport const calculateRFMScores = (customer: Customer, allCustomers: Customer[]): RFMScore => {\r\n  // Recency: Số ngày từ lần mua cuối\r\n  const daysSinceLastPurchase = customer.lastPurchaseDate \r\n    ? getDaysDiff(getCurrentDate(), new Date(customer.lastPurchaseDate))\r\n    : 999999;\r\n  \r\n  // Frequency: Tổng số đơn hàng\r\n  const frequency = customer.totalOrders || 0;\r\n  \r\n  // Monetary: Tổng chi tiêu\r\n  const monetary = customer.totalSpent || 0;\r\n\r\n  // Calculate percentiles for scoring\r\n  const allRecencies = allCustomers.map(c => \r\n    c.lastPurchaseDate ? getDaysDiff(getCurrentDate(), new Date(c.lastPurchaseDate)) : 999999\r\n  ).sort((a, b) => a - b);\r\n  \r\n  const allFrequencies = allCustomers.map(c => c.totalOrders || 0).sort((a, b) => b - a);\r\n  const allMonetary = allCustomers.map(c => c.totalSpent || 0).sort((a, b) => b - a);\r\n\r\n  // Score Recency (lower is better, so invert)\r\n  const recencyScore = getScore(daysSinceLastPurchase, allRecencies, true) as RFMScore['recency'];\r\n  \r\n  // Score Frequency (higher is better)\r\n  const frequencyScore = getScore(frequency, allFrequencies, false) as RFMScore['frequency'];\r\n  \r\n  // Score Monetary (higher is better)\r\n  const monetaryScore = getScore(monetary, allMonetary, false) as RFMScore['monetary'];\r\n\r\n  return {\r\n    recency: recencyScore,\r\n    frequency: frequencyScore,\r\n    monetary: monetaryScore\r\n  };\r\n};\r\n\r\n/**\r\n * Helper: Tính score 1-5 dựa trên percentile\r\n */\r\nconst getScore = (value: number, sortedValues: number[], invert: boolean): 1 | 2 | 3 | 4 | 5 => {\r\n  const index = sortedValues.indexOf(value);\r\n  if (index === -1) return 1;\r\n  \r\n  const percentile = (index / sortedValues.length) * 100;\r\n  \r\n  let score: number;\r\n  if (percentile >= 80) score = 5;\r\n  else if (percentile >= 60) score = 4;\r\n  else if (percentile >= 40) score = 3;\r\n  else if (percentile >= 20) score = 2;\r\n  else score = 1;\r\n  \r\n  // Invert for recency (lower days = better)\r\n  if (invert) {\r\n    score = 6 - score;\r\n  }\r\n  \r\n  return score as 1 | 2 | 3 | 4 | 5;\r\n};\r\n\r\n/**\r\n * Phân loại segment dựa trên RFM scores\r\n */\r\nexport const getCustomerSegment = (rfm: RFMScore): CustomerSegment => {\r\n  const { recency: R, frequency: F, monetary: M } = rfm;\r\n  \r\n  // Champions: RFM 5-5-5, 5-4-5, 4-5-5, 5-5-4\r\n  if ((R >= 4 && F >= 4 && M >= 4) && (R === 5 || F === 5)) {\r\n    return 'Champions';\r\n  }\r\n  \r\n  // Loyal Customers: RFM 4-4-4, 4-5-4, 5-4-4, 4-4-5\r\n  if (R >= 4 && F >= 4 && M >= 4) {\r\n    return 'Loyal Customers';\r\n  }\r\n  \r\n  // Potential Loyalist: High frequency, good recency\r\n  if (R >= 3 && F >= 3 && M >= 3) {\r\n    return 'Potential Loyalist';\r\n  }\r\n  \r\n  // New Customers: High recency, low frequency\r\n  if (R >= 4 && F <= 2) {\r\n    return 'New Customers';\r\n  }\r\n  \r\n  // Promising: Good recency, moderate frequency\r\n  if (R >= 3 && F >= 2 && F <= 3) {\r\n    return 'Promising';\r\n  }\r\n  \r\n  // Need Attention: Moderate scores\r\n  if (R === 3 && F === 2) {\r\n    return 'Need Attention';\r\n  }\r\n  \r\n  // About To Sleep: Low frequency, moderate recency\r\n  if ((R === 3 || R === 2) && F <= 2) {\r\n    return 'About To Sleep';\r\n  }\r\n  \r\n  // Cannot Lose Them: Low recency but high value\r\n  if (R === 1 && F >= 4 && M >= 4) {\r\n    return 'Cannot Lose Them';\r\n  }\r\n  \r\n  // At Risk: Low recency, good history\r\n  if (R <= 2 && F >= 3) {\r\n    return 'At Risk';\r\n  }\r\n  \r\n  // Hibernating: Low recency and frequency\r\n  if (R <= 2 && F <= 2 && M >= 2) {\r\n    return 'Hibernating';\r\n  }\r\n  \r\n  // Lost: Lowest scores\r\n  return 'Lost';\r\n};\r\n\r\n/**\r\n * Lấy màu badge cho segment\r\n */\r\nexport const getSegmentBadgeVariant = (segment: CustomerSegment): \r\n  'default' | 'secondary' | 'success' | 'warning' | 'destructive' => {\r\n  switch (segment) {\r\n    case 'Champions':\r\n    case 'Loyal Customers':\r\n      return 'success';\r\n    case 'Potential Loyalist':\r\n    case 'Promising':\r\n      return 'default';\r\n    case 'New Customers':\r\n      return 'secondary';\r\n    case 'Need Attention':\r\n    case 'About To Sleep':\r\n      return 'warning';\r\n    case 'At Risk':\r\n    case 'Cannot Lose Them':\r\n    case 'Hibernating':\r\n    case 'Lost':\r\n      return 'destructive';\r\n    default:\r\n      return 'secondary';\r\n  }\r\n};\r\n\r\n/**\r\n * Dịch segment sang tiếng Việt\r\n */\r\nexport const getSegmentLabel = (segment: CustomerSegment): string => {\r\n  const labels: Record<CustomerSegment, string> = {\r\n    'Champions': 'Xuất sắc',\r\n    'Loyal Customers': 'Trung thành',\r\n    'Potential Loyalist': 'Tiềm năng cao',\r\n    'New Customers': 'Khách mới',\r\n    'Promising': 'Hứa hẹn',\r\n    'Need Attention': 'Cần quan tâm',\r\n    'About To Sleep': 'Sắp ngủ đông',\r\n    'At Risk': 'Có nguy cơ',\r\n    'Cannot Lose Them': 'Không thể mất',\r\n    'Hibernating': 'Ngủ đông',\r\n    'Lost': 'Đã mất'\r\n  };\r\n  return labels[segment];\r\n};\r\n\r\n/**\r\n * Tính Customer Health Score (0-100)\r\n * Dựa trên 4 yếu tố: Recency, Frequency, Monetary, Payment Behavior\r\n */\r\nexport const calculateHealthScore = (customer: Customer): number => {\r\n  let score = 0;\r\n  \r\n  // 1. Recency - Thời gian mua gần nhất (30 points)\r\n  const daysSinceLastPurchase = customer.lastPurchaseDate \r\n    ? getDaysDiff(getCurrentDate(), new Date(customer.lastPurchaseDate))\r\n    : Infinity;\r\n    \r\n  if (daysSinceLastPurchase <= 7) score += 30;\r\n  else if (daysSinceLastPurchase <= 30) score += 25;\r\n  else if (daysSinceLastPurchase <= 60) score += 20;\r\n  else if (daysSinceLastPurchase <= 90) score += 15;\r\n  else if (daysSinceLastPurchase <= 180) score += 10;\r\n  else if (daysSinceLastPurchase <= 365) score += 5;\r\n  \r\n  // 2. Frequency - Tần suất mua (25 points)\r\n  const totalOrders = customer.totalOrders || 0;\r\n  if (totalOrders >= 20) score += 25;\r\n  else if (totalOrders >= 10) score += 20;\r\n  else if (totalOrders >= 5) score += 15;\r\n  else if (totalOrders >= 3) score += 10;\r\n  else if (totalOrders >= 1) score += 5;\r\n  \r\n  // 3. Monetary - Tổng chi tiêu (30 points)\r\n  const totalSpent = customer.totalSpent || 0;\r\n  if (totalSpent >= 500_000_000) score += 30;\r\n  else if (totalSpent >= 200_000_000) score += 25;\r\n  else if (totalSpent >= 100_000_000) score += 20;\r\n  else if (totalSpent >= 50_000_000) score += 15;\r\n  else if (totalSpent >= 20_000_000) score += 10;\r\n  else if (totalSpent >= 5_000_000) score += 5;\r\n  \r\n  // 4. Payment Behavior - Hành vi thanh toán (15 points)\r\n  // Dựa trên tỷ lệ nợ hiện tại so với hạn mức\r\n  if (customer.maxDebt && customer.maxDebt > 0) {\r\n    const debtRatio = (customer.currentDebt || 0) / customer.maxDebt;\r\n    if (debtRatio <= 0.2) score += 15;\r\n    else if (debtRatio <= 0.4) score += 12;\r\n    else if (debtRatio <= 0.6) score += 8;\r\n    else if (debtRatio <= 0.8) score += 4;\r\n    // > 80% = 0 điểm\r\n  } else {\r\n    // Không có hạn mức công nợ → xem như thanh toán tốt\r\n    score += 15;\r\n  }\r\n  \r\n  return Math.min(100, score);\r\n};\r\n\r\n/**\r\n * Lấy health score level\r\n */\r\nexport const getHealthScoreLevel = (score: number): {\r\n  level: 'excellent' | 'good' | 'fair' | 'poor' | 'critical';\r\n  label: string;\r\n  variant: 'success' | 'default' | 'warning' | 'destructive';\r\n} => {\r\n  if (score >= 80) return { level: 'excellent', label: 'Xuất sắc', variant: 'success' };\r\n  if (score >= 60) return { level: 'good', label: 'Tốt', variant: 'default' };\r\n  if (score >= 40) return { level: 'fair', label: 'Trung bình', variant: 'warning' };\r\n  if (score >= 20) return { level: 'poor', label: 'Yếu', variant: 'destructive' };\r\n  return { level: 'critical', label: 'Nguy hiểm', variant: 'destructive' };\r\n};\r\n\r\n/**\r\n * Dự đoán Churn Risk\r\n */\r\nexport const calculateChurnRisk = (customer: Customer): {\r\n  risk: 'low' | 'medium' | 'high';\r\n  label: string;\r\n  variant: 'success' | 'warning' | 'destructive';\r\n  reason: string;\r\n} => {\r\n  const daysSinceLastPurchase = customer.lastPurchaseDate \r\n    ? getDaysDiff(getCurrentDate(), new Date(customer.lastPurchaseDate))\r\n    : Infinity;\r\n  \r\n  const totalOrders = customer.totalOrders || 0;\r\n  \r\n  // Nếu khách mới (chưa có đơn hoặc chỉ 1 đơn), dùng default 30 ngày\r\n  // Nếu khách cũ, tính dựa trên thời gian từ createdAt đến lastPurchaseDate / số đơn\r\n  let avgDaysBetweenOrders = 30; // Default\r\n  if (totalOrders > 1 && customer.createdAt && customer.lastPurchaseDate) {\r\n    const customerAge = getDaysDiff(new Date(customer.lastPurchaseDate), new Date(customer.createdAt));\r\n    avgDaysBetweenOrders = Math.max(7, customerAge / (totalOrders - 1)); // Tối thiểu 7 ngày\r\n  }\r\n  \r\n  // Khách vừa mua hàng gần đây (< 7 ngày) = low risk\r\n  if (daysSinceLastPurchase <= 7) {\r\n    return {\r\n      risk: 'low',\r\n      label: 'Nguy cơ thấp',\r\n      variant: 'success',\r\n      reason: 'Khách hàng đang hoạt động tốt'\r\n    };\r\n  }\r\n  \r\n  // High risk: Không mua > 2x thời gian trung bình hoặc > 365 ngày\r\n  if (daysSinceLastPurchase > avgDaysBetweenOrders * 2 || daysSinceLastPurchase > 365) {\r\n    return {\r\n      risk: 'high',\r\n      label: 'Nguy cơ cao',\r\n      variant: 'destructive',\r\n      reason: `Không mua hàng ${Math.floor(daysSinceLastPurchase)} ngày, vượt quá 2x chu kỳ trung bình`\r\n    };\r\n  }\r\n  \r\n  // Medium risk: Không mua > 1.5x thời gian trung bình hoặc > 180 ngày\r\n  if (daysSinceLastPurchase > avgDaysBetweenOrders * 1.5 || daysSinceLastPurchase > 180) {\r\n    return {\r\n      risk: 'medium',\r\n      label: 'Nguy cơ trung bình',\r\n      variant: 'warning',\r\n      reason: `Không mua hàng ${Math.floor(daysSinceLastPurchase)} ngày, đang giảm tần suất`\r\n    };\r\n  }\r\n  \r\n  // Low risk\r\n  return {\r\n    risk: 'low',\r\n    label: 'Nguy cơ thấp',\r\n    variant: 'success',\r\n    reason: 'Khách hàng đang hoạt động tốt'\r\n  };\r\n};\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 786, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/customers/debt-tracking-utils.ts"],"sourcesContent":["import type { Customer, DebtStatus, DebtTransaction } from './types';\r\nimport { formatDate, formatDateTime, formatDateTimeSeconds, formatDateCustom, getCurrentDate, addDays, getDaysDiff, isDateBefore, toISODate } from '@/lib/date-utils';\r\n/**\r\n * Tính ngày đến hạn dựa trên ngày đơn hàng và payment terms\r\n */\r\nexport const calculateDueDate = (orderDate: string, paymentTermsDays: number): string => {\r\n  return toISODate(addDays(new Date(orderDate), paymentTermsDays));\r\n};\r\n\r\n/**\r\n * Parse payment terms string thành số ngày\r\n * \"NET30\" → 30, \"NET15\" → 15, \"COD\" → 0\r\n */\r\nexport const parsePaymentTerms = (paymentTerms?: string): number => {\r\n  if (!paymentTerms) return 0;\r\n  \r\n  const match = paymentTerms.match(/NET(\\d+)/i);\r\n  if (match) {\r\n    return parseInt(match[1], 10);\r\n  }\r\n  \r\n  if (paymentTerms.toUpperCase() === 'COD') {\r\n    return 0; // COD = thanh toán ngay\r\n  }\r\n  \r\n  return 30; // Default 30 ngày\r\n};\r\n\r\n/**\r\n * Tính số ngày quá hạn (nếu > 0 thì quá hạn)\r\n */\r\nexport const calculateDaysOverdue = (dueDate: string): number => {\r\n  const days = getDaysDiff(getCurrentDate(), new Date(dueDate));\r\n  return days > 0 ? days : 0;\r\n};\r\n\r\n/**\r\n * Tính số ngày còn lại đến hạn (nếu > 0 thì chưa đến hạn)\r\n */\r\nexport const calculateDaysUntilDue = (dueDate: string): number => {\r\n  return getDaysDiff(new Date(dueDate), getCurrentDate());\r\n};\r\n\r\n/**\r\n * Phân loại trạng thái công nợ dựa trên ngày đến hạn\r\n */\r\nexport const getDebtStatus = (dueDate: string, hasDebt: boolean): DebtStatus | null => {\r\n  if (!hasDebt) return null;\r\n  \r\n  const daysUntilDue = calculateDaysUntilDue(dueDate);\r\n  \r\n  // Chưa đến hạn\r\n  if (daysUntilDue > 3) return \"Chưa đến hạn\";\r\n  \r\n  // Sắp đến hạn (1-3 ngày)\r\n  if (daysUntilDue >= 1 && daysUntilDue <= 3) return \"Sắp đến hạn\";\r\n  \r\n  // Đến hạn hôm nay\r\n  if (daysUntilDue === 0) return \"Đến hạn hôm nay\";\r\n  \r\n  // Quá hạn\r\n  const daysOverdue = Math.abs(daysUntilDue);\r\n  \r\n  if (daysOverdue >= 1 && daysOverdue <= 7) return \"Quá hạn 1-7 ngày\";\r\n  if (daysOverdue >= 8 && daysOverdue <= 15) return \"Quá hạn 8-15 ngày\";\r\n  if (daysOverdue >= 16 && daysOverdue <= 30) return \"Quá hạn 16-30 ngày\";\r\n  \r\n  return \"Quá hạn > 30 ngày\";\r\n};\r\n\r\n/**\r\n * Lấy variant cho badge trạng thái công nợ\r\n */\r\nexport const getDebtStatusVariant = (status?: DebtStatus | null): \r\n  'default' | 'secondary' | 'success' | 'warning' | 'destructive' => {\r\n  if (!status) return 'secondary';\r\n  \r\n  switch (status) {\r\n    case \"Chưa đến hạn\":\r\n      return \"secondary\";\r\n    case \"Sắp đến hạn\":\r\n      return \"default\";\r\n    case \"Đến hạn hôm nay\":\r\n      return \"warning\";\r\n    case \"Quá hạn 1-7 ngày\":\r\n      return \"warning\";\r\n    case \"Quá hạn 8-15 ngày\":\r\n    case \"Quá hạn 16-30 ngày\":\r\n    case \"Quá hạn > 30 ngày\":\r\n      return \"destructive\";\r\n    default:\r\n      return \"secondary\";\r\n  }\r\n};\r\n\r\n/**\r\n * Tính toán debt tracking info cho customer\r\n */\r\nexport const calculateDebtTrackingInfo = (customer: Customer): {\r\n  oldestDebtDueDate?: string;\r\n  maxDaysOverdue: number;\r\n  debtStatus?: DebtStatus | null;\r\n} => {\r\n  const debtTransactions = customer.debtTransactions || [];\r\n  const unpaidTransactions = debtTransactions.filter(t => !t.isPaid);\r\n  \r\n  if (unpaidTransactions.length === 0 || !customer.currentDebt || customer.currentDebt === 0) {\r\n    return {\r\n      maxDaysOverdue: 0,\r\n      debtStatus: null\r\n    };\r\n  }\r\n  \r\n  // Tìm giao dịch có dueDate sớm nhất (nợ lâu nhất)\r\n  const oldestTransaction = unpaidTransactions.reduce((oldest, current) => {\r\n    return isDateBefore(new Date(current.dueDate), new Date(oldest.dueDate)) ? current : oldest;\r\n  });\r\n  \r\n  const oldestDebtDueDate = oldestTransaction.dueDate;\r\n  const maxDaysOverdue = calculateDaysOverdue(oldestDebtDueDate);\r\n  const debtStatus = getDebtStatus(oldestDebtDueDate, true);\r\n  \r\n  return {\r\n    oldestDebtDueDate,\r\n    maxDaysOverdue,\r\n    debtStatus\r\n  };\r\n};\r\n\r\n/**\r\n * Lấy danh sách khách hàng có nợ quá hạn, sắp xếp theo mức độ ưu tiên\r\n */\r\nexport const getOverdueDebtCustomers = (customers: Customer[]): Customer[] => {\r\n  return customers\r\n    .filter(c => {\r\n      const info = calculateDebtTrackingInfo(c);\r\n      return info.maxDaysOverdue > 0; // Chỉ lấy KH quá hạn\r\n    })\r\n    .sort((a, b) => {\r\n      const infoA = calculateDebtTrackingInfo(a);\r\n      const infoB = calculateDebtTrackingInfo(b);\r\n      \r\n      // Sắp xếp theo số ngày quá hạn (giảm dần)\r\n      return (infoB.maxDaysOverdue || 0) - (infoA.maxDaysOverdue || 0);\r\n    });\r\n};\r\n\r\n/**\r\n * Lấy danh sách khách hàng sắp đến hạn thanh toán (1-3 ngày)\r\n */\r\nexport const getDueSoonCustomers = (customers: Customer[]): Customer[] => {\r\n  return customers\r\n    .filter(c => {\r\n      const info = calculateDebtTrackingInfo(c);\r\n      if (!info.oldestDebtDueDate) return false;\r\n      \r\n      const daysUntil = calculateDaysUntilDue(info.oldestDebtDueDate);\r\n      return daysUntil >= 1 && daysUntil <= 3;\r\n    })\r\n    .sort((a, b) => {\r\n      const infoA = calculateDebtTrackingInfo(a);\r\n      const infoB = calculateDebtTrackingInfo(b);\r\n      \r\n      const daysA = infoA.oldestDebtDueDate ? calculateDaysUntilDue(infoA.oldestDebtDueDate) : 999;\r\n      const daysB = infoB.oldestDebtDueDate ? calculateDaysUntilDue(infoB.oldestDebtDueDate) : 999;\r\n      \r\n      return daysA - daysB; // Sắp xếp theo ngày đến hạn (tăng dần)\r\n    });\r\n};\r\n\r\n/**\r\n * Tính tổng công nợ quá hạn\r\n */\r\nexport const calculateTotalOverdueDebt = (customers: Customer[]): number => {\r\n  return getOverdueDebtCustomers(customers).reduce((sum, c) => sum + (c.currentDebt || 0), 0);\r\n};\r\n\r\n/**\r\n * Tính tổng công nợ sắp đến hạn\r\n */\r\nexport const calculateTotalDueSoonDebt = (customers: Customer[]): number => {\r\n  return getDueSoonCustomers(customers).reduce((sum, c) => sum + (c.currentDebt || 0), 0);\r\n};\r\n\r\n/**\r\n * Format ngày hiển thị\r\n */\r\nexport const formatDebtDate = (dateString?: string): string => {\r\n  if (!dateString) return '-';\r\n  return formatDate(dateString);\r\n};\r\n\r\n/**\r\n * Helper format currency\r\n */\r\nexport const formatCurrency = (value?: number): string => {\r\n  if (typeof value !== 'number') return '0 ₫';\r\n  return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(value);\r\n};\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 940, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/customers/sla/constants.ts"],"sourcesContent":["export const SLA_EVALUATION_KEY = 'hrm-customer-sla-evals';\r\nexport const SLA_ACKNOWLEDGEMENTS_KEY = 'hrm-customer-sla-acks';\r\nexport const SLA_LAST_RUN_KEY = 'hrm-customer-sla-last-run';\r\n\r\nexport const SLA_TYPE_BADGES: Record<string, { label: string; color: string }> = {\r\n  'follow-up': {\r\n    label: 'Liên hệ định kỳ',\r\n    color: 'text-blue-600 bg-blue-50'\r\n  },\r\n  're-engagement': {\r\n    label: 'Kích hoạt lại',\r\n    color: 'text-orange-600 bg-orange-50'\r\n  },\r\n  'debt-payment': {\r\n    label: 'Nhắc công nợ',\r\n    color: 'text-rose-600 bg-rose-50'\r\n  }\r\n};\r\n"],"names":[],"mappings":";;;;;;;;;;AAAO,MAAM,qBAAqB;AAC3B,MAAM,2BAA2B;AACjC,MAAM,mBAAmB;AAEzB,MAAM,kBAAoE;IAC/E,aAAa;QACX,OAAO;QACP,OAAO;IACT;IACA,iBAAiB;QACf,OAAO;QACP,OAAO;IACT;IACA,gBAAgB;QACd,OAAO;QACP,OAAO;IACT;AACF"}},
    {"offset": {"line": 971, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/customers/columns.tsx"],"sourcesContent":["import * as React from \"react\";\r\nimport type { AppRouterInstance } from 'next/dist/shared/lib/app-router-context.shared-runtime';\r\nimport { formatDate, formatDateTime, formatDateTimeSeconds, formatDateCustom, getCurrentDate, isValidDate, getDaysDiff } from '@/lib/date-utils';\r\nimport type { Customer } from './types'\r\nimport { calculateLifecycleStage, getLifecycleStageVariant } from './lifecycle-utils';\r\nimport { getCreditAlertLevel, getCreditAlertBadgeVariant, getCreditAlertText } from './credit-utils';\r\nimport { \r\n  calculateHealthScore, \r\n  getHealthScoreLevel,\r\n  calculateRFMScores,\r\n  getCustomerSegment,\r\n  getSegmentLabel,\r\n  getSegmentBadgeVariant,\r\n  calculateChurnRisk\r\n} from './intelligence-utils';\r\nimport { \r\n  calculateDebtTrackingInfo, \r\n  getDebtStatusVariant,\r\n  formatDebtDate \r\n} from './debt-tracking-utils';\r\nimport { Checkbox } from \"../../components/ui/checkbox\"\r\nimport { DataTableColumnHeader } from \"../../components/data-table/data-table-column-header\"\r\nimport { Badge } from \"../../components/ui/badge\"\r\nimport { Progress } from \"../../components/ui/progress\"\r\nimport type { ColumnDef } from '../../components/data-table/types';\r\nimport { DropdownMenu, DropdownMenuContent, DropdownMenuItem, DropdownMenuTrigger } from \"../../components/ui/dropdown-menu\";\r\nimport { Button } from \"../../components/ui/button\";\r\nimport { MoreHorizontal, RotateCcw, AlertTriangle } from \"lucide-react\";\r\nimport type { CustomerSlaIndex } from './sla/types';\r\nimport { SLA_TYPE_BADGES } from './sla/constants';\r\nimport { formatDaysRemaining, getAlertBadgeVariant } from '../reports/customer-sla-report/sla-utils';\r\nconst formatCurrency = (value?: number) => {\r\n    if (typeof value !== 'number') return '';\r\n    return new Intl.NumberFormat('vi-VN').format(value);\r\n};\r\n\r\ntype ColumnOptions = {\r\n  slaIndex?: CustomerSlaIndex | null;\r\n};\r\n\r\nexport const getColumns = (\r\n  onDelete: (systemId: string) => void,\r\n  onRestore: (systemId: string) => void,\r\n  router: AppRouterInstance,\r\n  options?: ColumnOptions,\r\n): ColumnDef<Customer>[] => [\r\n  {\r\n    id: \"select\",\r\n    header: ({ isAllPageRowsSelected, isSomePageRowsSelected, onToggleAll }) => (\r\n        <Checkbox\r\n          checked={isAllPageRowsSelected ? true : isSomePageRowsSelected ? \"indeterminate\" : false}\r\n          onCheckedChange={(value) => onToggleAll?.(!!value)}\r\n          aria-label=\"Select all\"\r\n        />\r\n    ),\r\n    cell: ({ isSelected, onToggleSelect }) => (\r\n        <Checkbox\r\n          checked={isSelected}\r\n          onCheckedChange={onToggleSelect}\r\n          aria-label=\"Select row\"\r\n        />\r\n    ),\r\n    size: 48,\r\n    meta: {\r\n      // FIX: Added missing 'displayName' property to satisfy the ColumnDef type.\r\n      displayName: \"Select\",\r\n      sticky: \"left\",\r\n    },\r\n  },\r\n  {\r\n    id: \"id\",\r\n    accessorKey: \"id\",\r\n    header: ({ sorting, setSorting }) => (\r\n      <DataTableColumnHeader \r\n        title=\"Mã KH\"\r\n        sortKey=\"id\"\r\n        isSorted={sorting?.id === 'id'}\r\n        sortDirection={sorting?.desc ? 'desc' : 'asc'}\r\n        onSort={() => setSorting?.((s: any) => ({ id: 'id', desc: s.id === 'id' ? !s.desc : false }))}\r\n       />\r\n    ),\r\n    cell: ({ row }) => <div className=\"font-medium\">{row.id}</div>,\r\n    meta: {\r\n      displayName: \"Mã KH\",\r\n    },\r\n    size: 100,\r\n  },\r\n  {\r\n    id: \"name\",\r\n    accessorKey: \"name\",\r\n    header: ({ sorting, setSorting }) => (\r\n      <DataTableColumnHeader \r\n        title=\"Tên khách hàng\"\r\n        sortKey=\"name\"\r\n        isSorted={sorting?.id === 'name'}\r\n        sortDirection={sorting?.desc ? 'desc' : 'asc'}\r\n        onSort={() => setSorting?.((s: any) => ({ id: 'name', desc: s.id === 'name' ? !s.desc : false }))}\r\n       />\r\n    ),\r\n    cell: ({ row }) => row.name,\r\n    meta: {\r\n      displayName: \"Tên khách hàng\",\r\n    },\r\n  },\r\n  {\r\n    id: \"email\",\r\n    accessorKey: \"email\",\r\n    header: \"Email\",\r\n    cell: ({ row }) => row.email,\r\n    meta: {\r\n      displayName: \"Email\",\r\n    },\r\n  },\r\n  {\r\n    id: \"phone\",\r\n    accessorKey: \"phone\",\r\n    header: \"Số điện thoại\",\r\n    cell: ({ row }) => row.phone,\r\n    meta: {\r\n      displayName: \"Số điện thoại\",\r\n    },\r\n  },\r\n  {\r\n    id: \"company\",\r\n    accessorKey: \"company\",\r\n    header: \"Công ty\",\r\n    cell: ({ row }) => row.company || '—',\r\n    meta: { displayName: \"Công ty\" },\r\n  },\r\n  {\r\n    id: \"type\",\r\n    accessorKey: \"type\",\r\n    header: \"Loại KH\",\r\n    cell: ({ row }) => {\r\n      if (!row.type) return '—';\r\n      const variant = row.type === 'Cá nhân' ? 'secondary' : 'default';\r\n      return <Badge variant={variant}>{row.type}</Badge>;\r\n    },\r\n    meta: { displayName: \"Loại khách hàng\" },\r\n  },\r\n  {\r\n    id: \"accountManagerName\",\r\n    accessorKey: \"accountManagerName\",\r\n    header: \"NV phụ trách\",\r\n    cell: ({ row }) => row.accountManagerName || '—',\r\n    meta: { displayName: \"NV phụ trách\" },\r\n  },\r\n  {\r\n    id: \"currentDebt\",\r\n    accessorKey: \"currentDebt\",\r\n    header: \"Công nợ\",\r\n    cell: ({ row }) => {\r\n      const alertLevel = getCreditAlertLevel(row);\r\n      const showAlert = alertLevel === 'warning' || alertLevel === 'danger' || alertLevel === 'exceeded';\r\n      \r\n      return (\r\n        <div className=\"flex items-center gap-2\">\r\n          <span>{formatCurrency(row.currentDebt)}</span>\r\n          {showAlert && (\r\n            <Badge variant={getCreditAlertBadgeVariant(alertLevel)} className=\"gap-1\">\r\n              <AlertTriangle className=\"h-3 w-3\" />\r\n              {getCreditAlertText(alertLevel)}\r\n            </Badge>\r\n          )}\r\n        </div>\r\n      );\r\n    },\r\n    meta: { displayName: \"Công nợ hiện tại\" },\r\n  },\r\n  {\r\n    id: \"debtStatus\",\r\n    accessorKey: \"debtStatus\",\r\n    header: \"Trạng thái công nợ\",\r\n    cell: ({ row }) => {\r\n      const info = calculateDebtTrackingInfo(row);\r\n      \r\n      if (!row.currentDebt || row.currentDebt === 0 || !info.debtStatus) {\r\n        return <Badge variant=\"outline\">Không có công nợ</Badge>;\r\n      }\r\n      \r\n      return (\r\n        <div className=\"flex flex-col gap-1\">\r\n          <Badge variant={getDebtStatusVariant(info.debtStatus)}>\r\n            {info.debtStatus}\r\n            {info.maxDaysOverdue > 0 && ` (${info.maxDaysOverdue} ngày)`}\r\n          </Badge>\r\n          {info.oldestDebtDueDate && (\r\n            <span className=\"text-body-xs text-muted-foreground\">\r\n              Hạn: {formatDebtDate(info.oldestDebtDueDate)}\r\n            </span>\r\n          )}\r\n        </div>\r\n      );\r\n    },\r\n    meta: { displayName: \"Trạng thái công nợ\" },\r\n  },\r\n  {\r\n    id: \"status\",\r\n    accessorKey: \"status\",\r\n    header: \"Trạng thái\",\r\n    cell: ({ row }) => {\r\n        const status = row.status;\r\n        const variant = status === \"Đang giao dịch\" ? \"success\" : \"secondary\";\r\n        return <Badge variant={variant as any}>{status}</Badge>\r\n    },\r\n    meta: {\r\n      displayName: \"Trạng thái\",\r\n    },\r\n  },\r\n    {\r\n    id: \"slaStatus\",\r\n    header: \"SLA\",\r\n    cell: ({ row }) => {\r\n      const entry = options?.slaIndex?.entries[row.systemId];\r\n      if (!entry || !entry.alerts.length) {\r\n        return <Badge variant=\"outline\" className=\"text-body-xs text-muted-foreground\">Ổn định</Badge>;\r\n      }\r\n\r\n      const alerts = entry.alerts.slice(0, 2);\r\n      return (\r\n        <div className=\"space-y-1\">\r\n          {alerts.map((alert) => {\r\n            const badgeMeta = SLA_TYPE_BADGES[alert.slaType];\r\n            return (\r\n              <div key={`${alert.slaType}-${alert.targetDate}`} className=\"flex items-center gap-2\">\r\n                <Badge variant=\"outline\" className=\"text-[11px]\">\r\n                  {badgeMeta?.label || alert.slaName}\r\n                </Badge>\r\n                <Badge variant={getAlertBadgeVariant(alert.alertLevel)} className=\"text-[11px]\">\r\n                  {formatDaysRemaining(alert.daysRemaining)}\r\n                </Badge>\r\n              </div>\r\n            );\r\n          })}\r\n          {entry.alerts.length > 2 && (\r\n            <span className=\"text-[11px] text-muted-foreground\">+{entry.alerts.length - 2} cảnh báo khác</span>\r\n          )}\r\n        </div>\r\n      );\r\n    },\r\n    meta: {\r\n      displayName: \"SLA\",\r\n    },\r\n    size: 220,\r\n    },\r\n  {\r\n    id: \"lifecycleStage\",\r\n    header: \"Giai đoạn\",\r\n    cell: ({ row }) => {\r\n        const stage = row.lifecycleStage || calculateLifecycleStage(row);\r\n        const variant = getLifecycleStageVariant(stage);\r\n        return <Badge variant={variant}>{stage}</Badge>\r\n    },\r\n    meta: {\r\n      displayName: \"Giai đoạn KH\",\r\n    },\r\n  },\r\n  {\r\n    id: \"healthScore\",\r\n    header: \"Health Score\",\r\n    cell: ({ row }) => {\r\n        const score = row.healthScore || calculateHealthScore(row);\r\n        const { label, variant } = getHealthScoreLevel(score);\r\n        return (\r\n          <div className=\"flex items-center gap-2\">\r\n            <div className=\"w-16\">\r\n              <Progress value={score} className=\"h-2\" />\r\n            </div>\r\n            <span className=\"text-body-sm font-medium\">{score}</span>\r\n            <Badge variant={variant} className=\"text-body-xs\">{label}</Badge>\r\n          </div>\r\n        );\r\n    },\r\n    meta: {\r\n      displayName: \"Điểm sức khỏe KH\",\r\n    },\r\n    size: 200,\r\n  },\r\n  {\r\n    id: \"churnRisk\",\r\n    header: \"Rủi ro rời bỏ\",\r\n    cell: ({ row }) => {\r\n        const churn = calculateChurnRisk(row);\r\n        return <Badge variant={churn.variant}>{churn.label}</Badge>;\r\n    },\r\n    meta: {\r\n      displayName: \"Rủi ro rời bỏ\",\r\n    },\r\n    size: 120,\r\n  },\r\n  {\r\n    id: \"segment\",\r\n    header: \"Phân khúc\",\r\n    cell: ({ row }) => {\r\n        // Sử dụng rfmScores đã lưu sẵn hoặc tính đơn giản nếu chưa có\r\n        if (row.segment) {\r\n          const segment = row.segment as import('./intelligence-utils').CustomerSegment;\r\n          return (\r\n            <Badge variant={getSegmentBadgeVariant(segment)} className=\"text-body-xs\">\r\n              {getSegmentLabel(segment)}\r\n            </Badge>\r\n          );\r\n        }\r\n        // Fallback: hiển thị dựa trên rfmScores nếu có\r\n        if (row.rfmScores) {\r\n          const segment = getCustomerSegment(row.rfmScores);\r\n          return (\r\n            <Badge variant={getSegmentBadgeVariant(segment)} className=\"text-body-xs\">\r\n              {getSegmentLabel(segment)}\r\n            </Badge>\r\n          );\r\n        }\r\n        return <span className=\"text-body-xs text-muted-foreground\">—</span>;\r\n    },\r\n    meta: {\r\n      displayName: \"Phân khúc RFM\",\r\n    },\r\n    size: 120,\r\n  },\r\n  {\r\n    id: \"taxCode\",\r\n    accessorKey: \"taxCode\",\r\n    header: \"Mã số thuế\",\r\n    cell: ({ row }) => row.taxCode,\r\n    meta: { displayName: \"Mã số thuế\" },\r\n  },\r\n  {\r\n    id: \"createdAt\",\r\n    accessorKey: \"createdAt\",\r\n    header: \"Ngày khởi tạo\",\r\n    cell: ({ row }) => formatDate(row.createdAt),\r\n    meta: { displayName: \"Ngày khởi tạo\" },\r\n  },\r\n  {\r\n    id: \"totalOrders\",\r\n    accessorKey: \"totalOrders\",\r\n    header: \"Tổng đơn\",\r\n    cell: ({ row }) => row.totalOrders,\r\n    meta: { displayName: \"Tổng SL đơn hàng\" },\r\n  },\r\n  {\r\n    id: \"totalSpent\",\r\n    accessorKey: \"totalSpent\",\r\n    header: \"Tổng chi tiêu\",\r\n    cell: ({ row }) => formatCurrency(row.totalSpent),\r\n    meta: { displayName: \"Tổng chi tiêu\" },\r\n  },\r\n  {\r\n    id: \"lastPurchaseDate\",\r\n    accessorKey: \"lastPurchaseDate\",\r\n    header: \"Mua gần nhất\",\r\n    cell: ({ row }) => formatDate(row.lastPurchaseDate),\r\n    meta: { displayName: \"Ngày cuối cùng mua hàng\" },\r\n  },\r\n  {\r\n    id: \"daysSinceLastPurchase\",\r\n    header: \"Mua lần cuối\",\r\n    cell: ({ row }) => {\r\n      if (!row.lastPurchaseDate) return <span className=\"text-muted-foreground\">Chưa mua</span>;\r\n      \r\n      const days = getDaysDiff(getCurrentDate(), new Date(row.lastPurchaseDate));\r\n      \r\n      // Color coding based on recency\r\n      let colorClass = 'text-foreground';\r\n      if (days > 180) colorClass = 'text-destructive';\r\n      else if (days > 90) colorClass = 'text-orange-600';\r\n      else if (days > 30) colorClass = 'text-yellow-600';\r\n      else colorClass = 'text-green-600';\r\n      \r\n      return (\r\n        <div className=\"flex flex-col\">\r\n          <span className={colorClass}>{formatDate(row.lastPurchaseDate)}</span>\r\n          <span className=\"text-body-xs text-muted-foreground\">{days} ngày trước</span>\r\n        </div>\r\n      );\r\n    },\r\n    meta: { displayName: \"Mua lần cuối\" },\r\n  },\r\n  {\r\n    id: \"debtRatio\",\r\n    header: \"Công nợ/Hạn mức\",\r\n    cell: ({ row }) => {\r\n      if (!row.maxDebt || row.maxDebt === 0) {\r\n        return <span className=\"text-muted-foreground text-body-xs\">Chưa cấp hạn mức</span>;\r\n      }\r\n      \r\n      const currentDebt = row.currentDebt || 0;\r\n      const ratio = (currentDebt / row.maxDebt) * 100;\r\n      \r\n      // Color based on ratio\r\n      let variant: 'default' | 'success' | 'warning' | 'destructive' = 'default';\r\n      if (ratio >= 90) variant = 'destructive';\r\n      else if (ratio >= 70) variant = 'warning';\r\n      else variant = 'success';\r\n      \r\n      return (\r\n        <div className=\"flex items-center gap-2 min-w-[180px]\">\r\n          <Progress value={ratio} className={`w-20 h-2 ${variant === 'destructive' ? 'bg-red-100' : variant === 'warning' ? 'bg-yellow-100' : 'bg-green-100'}`} />\r\n          <span className=\"text-body-xs font-medium tabular-nums\">{ratio.toFixed(0)}%</span>\r\n          <span className=\"text-body-xs text-muted-foreground\">\r\n            {formatCurrency(currentDebt)}/{formatCurrency(row.maxDebt)}\r\n          </span>\r\n        </div>\r\n      );\r\n    },\r\n    meta: { displayName: \"Tỷ lệ công nợ/Hạn mức\" },\r\n    size: 250,\r\n  },\r\n   {\r\n    id: \"actions\",\r\n    header: () => \"Hành động\",\r\n    cell: ({ row }) => {\r\n      // ✅ Show restore button for deleted items\r\n      if (row.deletedAt) {\r\n        return (\r\n          <Button\r\n            variant=\"ghost\"\r\n            size=\"sm\"\r\n            onClick={() => onRestore(row.systemId)}\r\n          >\r\n            <RotateCcw className=\"mr-2 h-4 w-4\" />\r\n            Khôi phục\r\n          </Button>\r\n        );\r\n      }\r\n      \r\n      // ✅ Show dropdown menu only\r\n      return (\r\n        <DropdownMenu>\r\n          <DropdownMenuTrigger asChild>\r\n            <Button variant=\"ghost\" className=\"h-8 w-8 p-0\">\r\n              <span className=\"sr-only\">Mở menu</span>\r\n              <MoreHorizontal className=\"h-4 w-4\" />\r\n            </Button>\r\n          </DropdownMenuTrigger>\r\n          <DropdownMenuContent align=\"end\">\r\n            <DropdownMenuItem onSelect={() => router.push(`/customers/${row.systemId}/edit`)}>Sửa</DropdownMenuItem>\r\n            <DropdownMenuItem className=\"text-destructive\" onSelect={() => onDelete(row.systemId)}>\r\n              Chuyển vào thùng rác\r\n            </DropdownMenuItem>\r\n          </DropdownMenuContent>\r\n        </DropdownMenu>\r\n      );\r\n    },\r\n    meta: {\r\n      displayName: \"Hành động\",\r\n      sticky: \"right\",\r\n    },\r\n    size: 80,\r\n  },\r\n];\r\n"],"names":[],"mappings":";;;;;AAEA;AAEA;AACA;AACA;AASA;AAKA;AACA;AACA;AACA;AAEA;AACA;AACA;AAAA;AAAA;AAEA;AACA;;;;;;;;;;;;;;;;AACA,MAAM,iBAAiB,CAAC;IACpB,IAAI,OAAO,UAAU,UAAU,OAAO;IACtC,OAAO,IAAI,KAAK,YAAY,CAAC,SAAS,MAAM,CAAC;AACjD;AAMO,MAAM,aAAa,CACxB,UACA,WACA,QACA,UAC0B;QAC1B;YACE,IAAI;YACJ,QAAQ,CAAC,EAAE,qBAAqB,EAAE,sBAAsB,EAAE,WAAW,EAAE,iBACnE,8OAAC,yIAAQ;oBACP,SAAS,wBAAwB,OAAO,yBAAyB,kBAAkB;oBACnF,iBAAiB,CAAC,QAAU,cAAc,CAAC,CAAC;oBAC5C,cAAW;;;;;;YAGjB,MAAM,CAAC,EAAE,UAAU,EAAE,cAAc,EAAE,iBACjC,8OAAC,yIAAQ;oBACP,SAAS;oBACT,iBAAiB;oBACjB,cAAW;;;;;;YAGjB,MAAM;YACN,MAAM;gBACJ,2EAA2E;gBAC3E,aAAa;gBACb,QAAQ;YACV;QACF;QACA;YACE,IAAI;YACJ,aAAa;YACb,QAAQ,CAAC,EAAE,OAAO,EAAE,UAAU,EAAE,iBAC9B,8OAAC,0LAAqB;oBACpB,OAAM;oBACN,SAAQ;oBACR,UAAU,SAAS,OAAO;oBAC1B,eAAe,SAAS,OAAO,SAAS;oBACxC,QAAQ,IAAM,aAAa,CAAC,IAAW,CAAC;gCAAE,IAAI;gCAAM,MAAM,EAAE,EAAE,KAAK,OAAO,CAAC,EAAE,IAAI,GAAG;4BAAM,CAAC;;;;;;YAG/F,MAAM,CAAC,EAAE,GAAG,EAAE,iBAAK,8OAAC;oBAAI,WAAU;8BAAe,IAAI,EAAE;;;;;;YACvD,MAAM;gBACJ,aAAa;YACf;YACA,MAAM;QACR;QACA;YACE,IAAI;YACJ,aAAa;YACb,QAAQ,CAAC,EAAE,OAAO,EAAE,UAAU,EAAE,iBAC9B,8OAAC,0LAAqB;oBACpB,OAAM;oBACN,SAAQ;oBACR,UAAU,SAAS,OAAO;oBAC1B,eAAe,SAAS,OAAO,SAAS;oBACxC,QAAQ,IAAM,aAAa,CAAC,IAAW,CAAC;gCAAE,IAAI;gCAAQ,MAAM,EAAE,EAAE,KAAK,SAAS,CAAC,EAAE,IAAI,GAAG;4BAAM,CAAC;;;;;;YAGnG,MAAM,CAAC,EAAE,GAAG,EAAE,GAAK,IAAI,IAAI;YAC3B,MAAM;gBACJ,aAAa;YACf;QACF;QACA;YACE,IAAI;YACJ,aAAa;YACb,QAAQ;YACR,MAAM,CAAC,EAAE,GAAG,EAAE,GAAK,IAAI,KAAK;YAC5B,MAAM;gBACJ,aAAa;YACf;QACF;QACA;YACE,IAAI;YACJ,aAAa;YACb,QAAQ;YACR,MAAM,CAAC,EAAE,GAAG,EAAE,GAAK,IAAI,KAAK;YAC5B,MAAM;gBACJ,aAAa;YACf;QACF;QACA;YACE,IAAI;YACJ,aAAa;YACb,QAAQ;YACR,MAAM,CAAC,EAAE,GAAG,EAAE,GAAK,IAAI,OAAO,IAAI;YAClC,MAAM;gBAAE,aAAa;YAAU;QACjC;QACA;YACE,IAAI;YACJ,aAAa;YACb,QAAQ;YACR,MAAM,CAAC,EAAE,GAAG,EAAE;gBACZ,IAAI,CAAC,IAAI,IAAI,EAAE,OAAO;gBACtB,MAAM,UAAU,IAAI,IAAI,KAAK,YAAY,cAAc;gBACvD,qBAAO,8OAAC,mIAAK;oBAAC,SAAS;8BAAU,IAAI,IAAI;;;;;;YAC3C;YACA,MAAM;gBAAE,aAAa;YAAkB;QACzC;QACA;YACE,IAAI;YACJ,aAAa;YACb,QAAQ;YACR,MAAM,CAAC,EAAE,GAAG,EAAE,GAAK,IAAI,kBAAkB,IAAI;YAC7C,MAAM;gBAAE,aAAa;YAAe;QACtC;QACA;YACE,IAAI;YACJ,aAAa;YACb,QAAQ;YACR,MAAM,CAAC,EAAE,GAAG,EAAE;gBACZ,MAAM,aAAa,IAAA,+JAAmB,EAAC;gBACvC,MAAM,YAAY,eAAe,aAAa,eAAe,YAAY,eAAe;gBAExF,qBACE,8OAAC;oBAAI,WAAU;;sCACb,8OAAC;sCAAM,eAAe,IAAI,WAAW;;;;;;wBACpC,2BACC,8OAAC,mIAAK;4BAAC,SAAS,IAAA,sKAA0B,EAAC;4BAAa,WAAU;;8CAChE,8OAAC,yOAAa;oCAAC,WAAU;;;;;;gCACxB,IAAA,8JAAkB,EAAC;;;;;;;;;;;;;YAK9B;YACA,MAAM;gBAAE,aAAa;YAAmB;QAC1C;QACA;YACE,IAAI;YACJ,aAAa;YACb,QAAQ;YACR,MAAM,CAAC,EAAE,GAAG,EAAE;gBACZ,MAAM,OAAO,IAAA,+KAAyB,EAAC;gBAEvC,IAAI,CAAC,IAAI,WAAW,IAAI,IAAI,WAAW,KAAK,KAAK,CAAC,KAAK,UAAU,EAAE;oBACjE,qBAAO,8OAAC,mIAAK;wBAAC,SAAQ;kCAAU;;;;;;gBAClC;gBAEA,qBACE,8OAAC;oBAAI,WAAU;;sCACb,8OAAC,mIAAK;4BAAC,SAAS,IAAA,0KAAoB,EAAC,KAAK,UAAU;;gCACjD,KAAK,UAAU;gCACf,KAAK,cAAc,GAAG,KAAK,CAAC,EAAE,EAAE,KAAK,cAAc,CAAC,MAAM,CAAC;;;;;;;wBAE7D,KAAK,iBAAiB,kBACrB,8OAAC;4BAAK,WAAU;;gCAAqC;gCAC7C,IAAA,oKAAc,EAAC,KAAK,iBAAiB;;;;;;;;;;;;;YAKrD;YACA,MAAM;gBAAE,aAAa;YAAqB;QAC5C;QACA;YACE,IAAI;YACJ,aAAa;YACb,QAAQ;YACR,MAAM,CAAC,EAAE,GAAG,EAAE;gBACV,MAAM,SAAS,IAAI,MAAM;gBACzB,MAAM,UAAU,WAAW,mBAAmB,YAAY;gBAC1D,qBAAO,8OAAC,mIAAK;oBAAC,SAAS;8BAAiB;;;;;;YAC5C;YACA,MAAM;gBACJ,aAAa;YACf;QACF;QACE;YACA,IAAI;YACJ,QAAQ;YACR,MAAM,CAAC,EAAE,GAAG,EAAE;gBACZ,MAAM,QAAQ,SAAS,UAAU,OAAO,CAAC,IAAI,QAAQ,CAAC;gBACtD,IAAI,CAAC,SAAS,CAAC,MAAM,MAAM,CAAC,MAAM,EAAE;oBAClC,qBAAO,8OAAC,mIAAK;wBAAC,SAAQ;wBAAU,WAAU;kCAAqC;;;;;;gBACjF;gBAEA,MAAM,SAAS,MAAM,MAAM,CAAC,KAAK,CAAC,GAAG;gBACrC,qBACE,8OAAC;oBAAI,WAAU;;wBACZ,OAAO,GAAG,CAAC,CAAC;4BACX,MAAM,YAAY,4JAAe,CAAC,MAAM,OAAO,CAAC;4BAChD,qBACE,8OAAC;gCAAiD,WAAU;;kDAC1D,8OAAC,mIAAK;wCAAC,SAAQ;wCAAU,WAAU;kDAChC,WAAW,SAAS,MAAM,OAAO;;;;;;kDAEpC,8OAAC,mIAAK;wCAAC,SAAS,IAAA,wLAAoB,EAAC,MAAM,UAAU;wCAAG,WAAU;kDAC/D,IAAA,uLAAmB,EAAC,MAAM,aAAa;;;;;;;+BALlC,GAAG,MAAM,OAAO,CAAC,CAAC,EAAE,MAAM,UAAU,EAAE;;;;;wBASpD;wBACC,MAAM,MAAM,CAAC,MAAM,GAAG,mBACrB,8OAAC;4BAAK,WAAU;;gCAAoC;gCAAE,MAAM,MAAM,CAAC,MAAM,GAAG;gCAAE;;;;;;;;;;;;;YAItF;YACA,MAAM;gBACJ,aAAa;YACf;YACA,MAAM;QACN;QACF;YACE,IAAI;YACJ,QAAQ;YACR,MAAM,CAAC,EAAE,GAAG,EAAE;gBACV,MAAM,QAAQ,IAAI,cAAc,IAAI,IAAA,sKAAuB,EAAC;gBAC5D,MAAM,UAAU,IAAA,uKAAwB,EAAC;gBACzC,qBAAO,8OAAC,mIAAK;oBAAC,SAAS;8BAAU;;;;;;YACrC;YACA,MAAM;gBACJ,aAAa;YACf;QACF;QACA;YACE,IAAI;YACJ,QAAQ;YACR,MAAM,CAAC,EAAE,GAAG,EAAE;gBACV,MAAM,QAAQ,IAAI,WAAW,IAAI,IAAA,sKAAoB,EAAC;gBACtD,MAAM,EAAE,KAAK,EAAE,OAAO,EAAE,GAAG,IAAA,qKAAmB,EAAC;gBAC/C,qBACE,8OAAC;oBAAI,WAAU;;sCACb,8OAAC;4BAAI,WAAU;sCACb,cAAA,8OAAC,yIAAQ;gCAAC,OAAO;gCAAO,WAAU;;;;;;;;;;;sCAEpC,8OAAC;4BAAK,WAAU;sCAA4B;;;;;;sCAC5C,8OAAC,mIAAK;4BAAC,SAAS;4BAAS,WAAU;sCAAgB;;;;;;;;;;;;YAG3D;YACA,MAAM;gBACJ,aAAa;YACf;YACA,MAAM;QACR;QACA;YACE,IAAI;YACJ,QAAQ;YACR,MAAM,CAAC,EAAE,GAAG,EAAE;gBACV,MAAM,QAAQ,IAAA,oKAAkB,EAAC;gBACjC,qBAAO,8OAAC,mIAAK;oBAAC,SAAS,MAAM,OAAO;8BAAG,MAAM,KAAK;;;;;;YACtD;YACA,MAAM;gBACJ,aAAa;YACf;YACA,MAAM;QACR;QACA;YACE,IAAI;YACJ,QAAQ;YACR,MAAM,CAAC,EAAE,GAAG,EAAE;gBACV,8DAA8D;gBAC9D,IAAI,IAAI,OAAO,EAAE;oBACf,MAAM,UAAU,IAAI,OAAO;oBAC3B,qBACE,8OAAC,mIAAK;wBAAC,SAAS,IAAA,wKAAsB,EAAC;wBAAU,WAAU;kCACxD,IAAA,iKAAe,EAAC;;;;;;gBAGvB;gBACA,+CAA+C;gBAC/C,IAAI,IAAI,SAAS,EAAE;oBACjB,MAAM,UAAU,IAAA,oKAAkB,EAAC,IAAI,SAAS;oBAChD,qBACE,8OAAC,mIAAK;wBAAC,SAAS,IAAA,wKAAsB,EAAC;wBAAU,WAAU;kCACxD,IAAA,iKAAe,EAAC;;;;;;gBAGvB;gBACA,qBAAO,8OAAC;oBAAK,WAAU;8BAAqC;;;;;;YAChE;YACA,MAAM;gBACJ,aAAa;YACf;YACA,MAAM;QACR;QACA;YACE,IAAI;YACJ,aAAa;YACb,QAAQ;YACR,MAAM,CAAC,EAAE,GAAG,EAAE,GAAK,IAAI,OAAO;YAC9B,MAAM;gBAAE,aAAa;YAAa;QACpC;QACA;YACE,IAAI;YACJ,aAAa;YACb,QAAQ;YACR,MAAM,CAAC,EAAE,GAAG,EAAE,GAAK,IAAA,kIAAU,EAAC,IAAI,SAAS;YAC3C,MAAM;gBAAE,aAAa;YAAgB;QACvC;QACA;YACE,IAAI;YACJ,aAAa;YACb,QAAQ;YACR,MAAM,CAAC,EAAE,GAAG,EAAE,GAAK,IAAI,WAAW;YAClC,MAAM;gBAAE,aAAa;YAAmB;QAC1C;QACA;YACE,IAAI;YACJ,aAAa;YACb,QAAQ;YACR,MAAM,CAAC,EAAE,GAAG,EAAE,GAAK,eAAe,IAAI,UAAU;YAChD,MAAM;gBAAE,aAAa;YAAgB;QACvC;QACA;YACE,IAAI;YACJ,aAAa;YACb,QAAQ;YACR,MAAM,CAAC,EAAE,GAAG,EAAE,GAAK,IAAA,kIAAU,EAAC,IAAI,gBAAgB;YAClD,MAAM;gBAAE,aAAa;YAA0B;QACjD;QACA;YACE,IAAI;YACJ,QAAQ;YACR,MAAM,CAAC,EAAE,GAAG,EAAE;gBACZ,IAAI,CAAC,IAAI,gBAAgB,EAAE,qBAAO,8OAAC;oBAAK,WAAU;8BAAwB;;;;;;gBAE1E,MAAM,OAAO,IAAA,mIAAW,EAAC,IAAA,sIAAc,KAAI,IAAI,KAAK,IAAI,gBAAgB;gBAExE,gCAAgC;gBAChC,IAAI,aAAa;gBACjB,IAAI,OAAO,KAAK,aAAa;qBACxB,IAAI,OAAO,IAAI,aAAa;qBAC5B,IAAI,OAAO,IAAI,aAAa;qBAC5B,aAAa;gBAElB,qBACE,8OAAC;oBAAI,WAAU;;sCACb,8OAAC;4BAAK,WAAW;sCAAa,IAAA,kIAAU,EAAC,IAAI,gBAAgB;;;;;;sCAC7D,8OAAC;4BAAK,WAAU;;gCAAsC;gCAAK;;;;;;;;;;;;;YAGjE;YACA,MAAM;gBAAE,aAAa;YAAe;QACtC;QACA;YACE,IAAI;YACJ,QAAQ;YACR,MAAM,CAAC,EAAE,GAAG,EAAE;gBACZ,IAAI,CAAC,IAAI,OAAO,IAAI,IAAI,OAAO,KAAK,GAAG;oBACrC,qBAAO,8OAAC;wBAAK,WAAU;kCAAqC;;;;;;gBAC9D;gBAEA,MAAM,cAAc,IAAI,WAAW,IAAI;gBACvC,MAAM,QAAQ,AAAC,cAAc,IAAI,OAAO,GAAI;gBAE5C,uBAAuB;gBACvB,IAAI,UAA6D;gBACjE,IAAI,SAAS,IAAI,UAAU;qBACtB,IAAI,SAAS,IAAI,UAAU;qBAC3B,UAAU;gBAEf,qBACE,8OAAC;oBAAI,WAAU;;sCACb,8OAAC,yIAAQ;4BAAC,OAAO;4BAAO,WAAW,CAAC,SAAS,EAAE,YAAY,gBAAgB,eAAe,YAAY,YAAY,kBAAkB,gBAAgB;;;;;;sCACpJ,8OAAC;4BAAK,WAAU;;gCAAyC,MAAM,OAAO,CAAC;gCAAG;;;;;;;sCAC1E,8OAAC;4BAAK,WAAU;;gCACb,eAAe;gCAAa;gCAAE,eAAe,IAAI,OAAO;;;;;;;;;;;;;YAIjE;YACA,MAAM;gBAAE,aAAa;YAAwB;YAC7C,MAAM;QACR;QACC;YACC,IAAI;YACJ,QAAQ,IAAM;YACd,MAAM,CAAC,EAAE,GAAG,EAAE;gBACZ,0CAA0C;gBAC1C,IAAI,IAAI,SAAS,EAAE;oBACjB,qBACE,8OAAC,qIAAM;wBACL,SAAQ;wBACR,MAAK;wBACL,SAAS,IAAM,UAAU,IAAI,QAAQ;;0CAErC,8OAAC,6NAAS;gCAAC,WAAU;;;;;;4BAAiB;;;;;;;gBAI5C;gBAEA,4BAA4B;gBAC5B,qBACE,8OAAC,qJAAY;;sCACX,8OAAC,4JAAmB;4BAAC,OAAO;sCAC1B,cAAA,8OAAC,qIAAM;gCAAC,SAAQ;gCAAQ,WAAU;;kDAChC,8OAAC;wCAAK,WAAU;kDAAU;;;;;;kDAC1B,8OAAC,kOAAc;wCAAC,WAAU;;;;;;;;;;;;;;;;;sCAG9B,8OAAC,4JAAmB;4BAAC,OAAM;;8CACzB,8OAAC,yJAAgB;oCAAC,UAAU,IAAM,OAAO,IAAI,CAAC,CAAC,WAAW,EAAE,IAAI,QAAQ,CAAC,KAAK,CAAC;8CAAG;;;;;;8CAClF,8OAAC,yJAAgB;oCAAC,WAAU;oCAAmB,UAAU,IAAM,SAAS,IAAI,QAAQ;8CAAG;;;;;;;;;;;;;;;;;;YAM/F;YACA,MAAM;gBACJ,aAAa;gBACb,QAAQ;YACV;YACA,MAAM;QACR;KACD"}},
    {"offset": {"line": 1743, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/customers/components/bulk-action-confirm-dialog.tsx"],"sourcesContent":["import * as React from 'react';\r\nimport {\r\n  AlertDialog,\r\n  AlertDialogAction,\r\n  AlertDialogCancel,\r\n  AlertDialogContent,\r\n  AlertDialogDescription,\r\n  AlertDialogFooter,\r\n  AlertDialogHeader,\r\n  AlertDialogTitle,\r\n} from '../../../components/ui/alert-dialog';\r\nimport type { Customer } from '../types';\r\n\r\nexport interface BulkActionConfirmDialogProps {\r\n  open: boolean;\r\n  title: string;\r\n  description: string;\r\n  confirmLabel?: string;\r\n  customers: Customer[];\r\n  onConfirm: () => void;\r\n  onCancel: () => void;\r\n}\r\n\r\nexport function BulkActionConfirmDialog({\r\n  open,\r\n  title,\r\n  description,\r\n  confirmLabel = 'Xác nhận',\r\n  customers,\r\n  onConfirm,\r\n  onCancel,\r\n}: BulkActionConfirmDialogProps) {\r\n  const previewCustomers = customers.slice(0, 3);\r\n\r\n  return (\r\n    <AlertDialog open={open} onOpenChange={(value) => !value && onCancel()}>\r\n      <AlertDialogContent>\r\n        <AlertDialogHeader>\r\n          <AlertDialogTitle>{title}</AlertDialogTitle>\r\n          <AlertDialogDescription>\r\n            {description}\r\n            {previewCustomers.length > 0 && (\r\n              <ul className=\"mt-3 space-y-1 text-sm text-muted-foreground\">\r\n                {previewCustomers.map((customer) => (\r\n                  <li key={customer.systemId}>• {customer.name} ({customer.id})</li>\r\n                ))}\r\n                {customers.length > previewCustomers.length && (\r\n                  <li className=\"text-xs\">+ {customers.length - previewCustomers.length} khách hàng khác</li>\r\n                )}\r\n              </ul>\r\n            )}\r\n          </AlertDialogDescription>\r\n        </AlertDialogHeader>\r\n        <AlertDialogFooter>\r\n          <AlertDialogCancel>Hủy</AlertDialogCancel>\r\n          <AlertDialogAction onClick={onConfirm}>{confirmLabel}</AlertDialogAction>\r\n        </AlertDialogFooter>\r\n      </AlertDialogContent>\r\n    </AlertDialog>\r\n  );\r\n}\r\n"],"names":[],"mappings":";;;;;AACA;;;AAsBO,SAAS,wBAAwB,EACtC,IAAI,EACJ,KAAK,EACL,WAAW,EACX,eAAe,UAAU,EACzB,SAAS,EACT,SAAS,EACT,QAAQ,EACqB;IAC7B,MAAM,mBAAmB,UAAU,KAAK,CAAC,GAAG;IAE5C,qBACE,8OAAC,mJAAW;QAAC,MAAM;QAAM,cAAc,CAAC,QAAU,CAAC,SAAS;kBAC1D,cAAA,8OAAC,0JAAkB;;8BACjB,8OAAC,yJAAiB;;sCAChB,8OAAC,wJAAgB;sCAAE;;;;;;sCACnB,8OAAC,8JAAsB;;gCACpB;gCACA,iBAAiB,MAAM,GAAG,mBACzB,8OAAC;oCAAG,WAAU;;wCACX,iBAAiB,GAAG,CAAC,CAAC,yBACrB,8OAAC;;oDAA2B;oDAAG,SAAS,IAAI;oDAAC;oDAAG,SAAS,EAAE;oDAAC;;+CAAnD,SAAS,QAAQ;;;;;wCAE3B,UAAU,MAAM,GAAG,iBAAiB,MAAM,kBACzC,8OAAC;4CAAG,WAAU;;gDAAU;gDAAG,UAAU,MAAM,GAAG,iBAAiB,MAAM;gDAAC;;;;;;;;;;;;;;;;;;;;;;;;;8BAMhF,8OAAC,yJAAiB;;sCAChB,8OAAC,yJAAiB;sCAAC;;;;;;sCACnB,8OAAC,yJAAiB;4BAAC,SAAS;sCAAY;;;;;;;;;;;;;;;;;;;;;;;AAKlD"}},
    {"offset": {"line": 1855, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/customers/store.ts"],"sourcesContent":["import { create } from 'zustand';\r\nimport { createCrudStore, CrudState } from '../../lib/store-factory';\r\n// REMOVED: import { data as initialData } from './data'; // Mock data no longer used - database is source of truth\r\nimport type { Customer } from './types';\r\nimport { SystemId, BusinessId } from '../../lib/id-types';\r\nimport { calculateLifecycleStage } from './lifecycle-utils';\r\nimport { getHighRiskDebtCustomers } from './credit-utils';\r\nimport { \r\n  calculateRFMScores, \r\n  getCustomerSegment, \r\n  calculateHealthScore,\r\n  calculateChurnRisk \r\n} from './intelligence-utils';\r\nimport { getOverdueDebtCustomers, getDueSoonCustomers } from './debt-tracking-utils';\r\nimport Fuse from 'fuse.js';\r\nimport { getCurrentUserSystemId } from '../../contexts/auth-context';\r\nimport {\r\n  getCurrentUserInfo,\r\n  createCreatedEntry,\r\n  createUpdatedEntry,\r\n  createStatusChangedEntry,\r\n  appendHistoryEntry,\r\n  type HistoryEntry\r\n} from '../../lib/activity-history-helper';\r\n\r\nconst baseStore = createCrudStore<Customer>([], 'customers', {\r\n  businessIdField: 'id',\r\n  getCurrentUser: getCurrentUserSystemId, // Track who creates/updates\r\n  apiEndpoint: '/api/customers',\r\n});\r\n\r\n// ✅ API Sync helpers\r\nconst API_ENDPOINT = '/api/customers';\r\n\r\nconst syncToApi = {\r\n  create: async (customer: Customer) => {\r\n    try {\r\n      const response = await fetch(API_ENDPOINT, {\r\n        method: 'POST',\r\n        credentials: 'include',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify(customer),\r\n      });\r\n      if (!response.ok) console.warn('[Customer API] Create sync failed');\r\n      else console.log('[Customer API] Created:', customer.systemId);\r\n    } catch (e) {\r\n      console.warn('[Customer API] Create sync error:', e);\r\n    }\r\n  },\r\n  update: async (systemId: SystemId, updates: Partial<Customer>) => {\r\n    try {\r\n      const response = await fetch(`${API_ENDPOINT}/${systemId}`, {\r\n        method: 'PATCH',\r\n        credentials: 'include',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify(updates),\r\n      });\r\n      if (!response.ok) console.warn('[Customer API] Update sync failed');\r\n      else console.log('[Customer API] Updated:', systemId);\r\n    } catch (e) {\r\n      console.warn('[Customer API] Update sync error:', e);\r\n    }\r\n  },\r\n  delete: async (systemId: SystemId, hard = false) => {\r\n    try {\r\n      const response = await fetch(`${API_ENDPOINT}/${systemId}`, {\r\n        method: 'DELETE',\r\n        credentials: 'include',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({ hard }),\r\n      });\r\n      if (!response.ok) console.warn('[Customer API] Delete sync failed');\r\n      else console.log('[Customer API] Deleted:', systemId);\r\n    } catch (e) {\r\n      console.warn('[Customer API] Delete sync error:', e);\r\n    }\r\n  },\r\n  restore: async (systemId: SystemId) => {\r\n    try {\r\n      const response = await fetch(`${API_ENDPOINT}/${systemId}/restore`, {\r\n        method: 'POST',\r\n        credentials: 'include',\r\n        headers: { 'Content-Type': 'application/json' },\r\n      });\r\n      if (!response.ok) console.warn('[Customer API] Restore sync failed');\r\n      else console.log('[Customer API] Restored:', systemId);\r\n    } catch (e) {\r\n      console.warn('[Customer API] Restore sync error:', e);\r\n    }\r\n  },\r\n};\r\n\r\n// ✅ Wrap base store methods with API sync\r\nconst originalAdd = baseStore.getState().add;\r\nconst originalUpdate = baseStore.getState().update;\r\nconst originalRemove = baseStore.getState().remove;\r\nconst originalHardDelete = baseStore.getState().hardDelete;\r\nconst originalRestore = baseStore.getState().restore;\r\n\r\nbaseStore.setState({\r\n  add: (item: Omit<Customer, 'systemId'>) => {\r\n    const result = originalAdd(item);\r\n    syncToApi.create(result);\r\n    return result;\r\n  },\r\n  update: (systemId: SystemId, updates: Partial<Customer>) => {\r\n    originalUpdate(systemId, updates);\r\n    syncToApi.update(systemId, updates);\r\n  },\r\n  remove: (systemId: SystemId) => {\r\n    originalRemove(systemId);\r\n    syncToApi.delete(systemId, false);\r\n  },\r\n  hardDelete: (systemId: SystemId) => {\r\n    originalHardDelete(systemId);\r\n    syncToApi.delete(systemId, true);\r\n  },\r\n  restore: (systemId: SystemId) => {\r\n    originalRestore(systemId);\r\n    syncToApi.restore(systemId);\r\n  },\r\n});\r\n\r\n// Define enhanced interface\r\ninterface CustomerStoreState extends CrudState<Customer> {\r\n  searchCustomers: (query: string, page: number, limit?: number) => Promise<{ items: { value: string; label: string }[], hasNextPage: boolean }>;\r\n  updateDebt: (systemId: SystemId, amountChange: number) => void;\r\n  incrementOrderStats: (systemId: SystemId, orderValue: number) => void;\r\n  decrementOrderStats: (systemId: SystemId, orderValue: number) => void;\r\n  incrementReturnStats: (systemId: SystemId, quantity: number) => void;\r\n  incrementFailedDeliveryStats: (systemId: SystemId) => void;\r\n  addDebtTransaction: (systemId: SystemId, transaction: import('./types').DebtTransaction) => void;\r\n  addDebtReminder: (systemId: SystemId, reminder: import('./types').DebtReminder) => void;\r\n  updateDebtReminder: (systemId: SystemId, reminderId: SystemId, updates: Partial<import('./types').DebtReminder>) => void;\r\n  removeDebtReminder: (systemId: SystemId, reminderId: SystemId) => void;\r\n  updateDebtTransactionPayment: (systemId: SystemId, orderId: BusinessId, amountPaid: number) => void;\r\n  removeDebtTransaction: (systemId: SystemId, orderId: BusinessId) => void;\r\n  getHighRiskDebtCustomers: () => Customer[];\r\n  updateCustomerIntelligence: () => void; // Batch update RFM, health score, churn risk\r\n  getCustomersBySegment: (segment: string) => Customer[];\r\n  getOverdueDebtCustomers: () => Customer[];\r\n  getDueSoonCustomers: () => Customer[];\r\n    removeMany: (systemIds: SystemId[]) => void;\r\n    updateManyStatus: (systemIds: SystemId[], status: Customer['status']) => void;\r\n    restoreMany: (systemIds: SystemId[]) => void;\r\n}\r\n\r\n// Augmented methods\r\nconst augmentedMethods = {\r\n    searchCustomers: async (query: string, page: number, limit: number = 20) => {\r\n        return new Promise<{ items: { value: string; label: string }[], hasNextPage: boolean }>(resolve => {\r\n            setTimeout(() => {\r\n                const allCustomers = baseStore.getState().data;\r\n                \r\n                // Create fresh Fuse instance with current data (avoid stale data)\r\n                const fuse = new Fuse(allCustomers, {\r\n                    keys: ['name', 'id', 'phone'],\r\n                    threshold: 0.3,\r\n                });\r\n                \r\n                const results = query ? fuse.search(query).map(r => r.item) : allCustomers;\r\n                \r\n                const start = (page - 1) * limit;\r\n                const end = start + limit;\r\n                const paginatedItems = results.slice(start, end);\r\n\r\n                resolve({\r\n                    items: paginatedItems.map(c => ({ value: c.systemId, label: c.name })),\r\n                    hasNextPage: end < results.length,\r\n                });\r\n            }, 300);\r\n        });\r\n    },\r\n    updateDebt: (systemId: SystemId, amountChange: number) => {\r\n        baseStore.setState(state => ({\r\n            data: state.data.map(customer => {\r\n                if (customer.systemId === systemId) {\r\n                    const newDebt = (customer.currentDebt || 0) + amountChange;\r\n                    // Sync to API\r\n                    syncToApi.update(systemId, { currentDebt: newDebt });\r\n                    return {\r\n                        ...customer,\r\n                        currentDebt: newDebt,\r\n                    };\r\n                }\r\n                return customer;\r\n            })\r\n        }));\r\n    },\r\n    incrementOrderStats: (systemId: SystemId, orderValue: number) => {\r\n        const allCustomers = baseStore.getState().getActive();\r\n        \r\n        baseStore.setState(state => ({\r\n            data: state.data.map(customer => {\r\n                if (customer.systemId === systemId) {\r\n                    const updatedCustomer = {\r\n                        ...customer,\r\n                        totalOrders: (customer.totalOrders || 0) + 1,\r\n                        totalSpent: (customer.totalSpent || 0) + orderValue,\r\n                        lastPurchaseDate: new Date().toISOString().split('T')[0],\r\n                    };\r\n                    \r\n                    // Auto-update intelligence after order stats change\r\n                    const rfmScores = calculateRFMScores(updatedCustomer, allCustomers);\r\n                    const segment = getCustomerSegment(rfmScores);\r\n                    const healthScore = calculateHealthScore(updatedCustomer);\r\n                    const churnRisk = calculateChurnRisk(updatedCustomer).risk;\r\n                    const lifecycleStage = calculateLifecycleStage(updatedCustomer);\r\n                    \r\n                    return {\r\n                        ...updatedCustomer,\r\n                        rfmScores,\r\n                        segment,\r\n                        healthScore,\r\n                        churnRisk,\r\n                        lifecycleStage,\r\n                    };\r\n                }\r\n                return customer;\r\n            })\r\n        }));\r\n    },\r\n    decrementOrderStats: (systemId: SystemId, orderValue: number) => {\r\n        const allCustomers = baseStore.getState().getActive();\r\n        \r\n        baseStore.setState(state => ({\r\n            data: state.data.map(customer => {\r\n                if (customer.systemId === systemId) {\r\n                    const updatedCustomer = {\r\n                        ...customer,\r\n                        totalOrders: Math.max(0, (customer.totalOrders || 0) - 1),\r\n                        totalSpent: Math.max(0, (customer.totalSpent || 0) - orderValue),\r\n                    };\r\n                    \r\n                    // Auto-update intelligence after order stats change\r\n                    const rfmScores = calculateRFMScores(updatedCustomer, allCustomers);\r\n                    const segment = getCustomerSegment(rfmScores);\r\n                    const healthScore = calculateHealthScore(updatedCustomer);\r\n                    const churnRisk = calculateChurnRisk(updatedCustomer).risk;\r\n                    const lifecycleStage = calculateLifecycleStage(updatedCustomer);\r\n                    \r\n                    return {\r\n                        ...updatedCustomer,\r\n                        rfmScores,\r\n                        segment,\r\n                        healthScore,\r\n                        churnRisk,\r\n                        lifecycleStage,\r\n                    };\r\n                }\r\n                return customer;\r\n            })\r\n        }));\r\n    },\r\n    incrementReturnStats: (systemId: SystemId, quantity: number) => {\r\n        baseStore.setState(state => ({\r\n            data: state.data.map(customer => {\r\n                if (customer.systemId === systemId) {\r\n                    return {\r\n                        ...customer,\r\n                        totalQuantityReturned: (customer.totalQuantityReturned || 0) + quantity,\r\n                    };\r\n                }\r\n                return customer;\r\n            })\r\n        }));\r\n    },\r\n    incrementFailedDeliveryStats: (systemId: SystemId) => {\r\n        baseStore.setState(state => ({\r\n            data: state.data.map(customer => {\r\n                if (customer.systemId === systemId) {\r\n                    return {\r\n                        ...customer,\r\n                        failedDeliveries: (customer.failedDeliveries || 0) + 1,\r\n                    };\r\n                }\r\n                return customer;\r\n            })\r\n        }));\r\n    },\r\n    addDebtTransaction: (systemId: SystemId, transaction: import('./types').DebtTransaction) => {\r\n        baseStore.setState(state => ({\r\n            data: state.data.map(customer => {\r\n                if (customer.systemId === systemId) {\r\n                    const currentTransactions = customer.debtTransactions || [];\r\n                    // Avoid duplicates\r\n                    if (currentTransactions.some(t => t.orderId === transaction.orderId)) {\r\n                        return customer;\r\n                    }\r\n\r\n                    const outstandingAmount = Math.max(transaction.remainingAmount ?? transaction.amount ?? 0, 0);\r\n                    return {\r\n                        ...customer,\r\n                        currentDebt: Math.max(0, (customer.currentDebt || 0) + outstandingAmount),\r\n                        debtTransactions: [...currentTransactions, transaction],\r\n                    };\r\n                }\r\n                return customer;\r\n            })\r\n        }));\r\n    },\r\n    updateDebtTransactionPayment: (systemId: SystemId, orderId: BusinessId, amountPaid: number) => {\r\n        baseStore.setState(state => ({\r\n            data: state.data.map(customer => {\r\n                if (customer.systemId === systemId && customer.debtTransactions) {\r\n                    let debtDelta = 0;\r\n                    const updatedTransactions = customer.debtTransactions.map(t => {\r\n                        if (t.orderId !== orderId) {\r\n                            return t;\r\n                        }\r\n\r\n                        const currentPaid = t.paidAmount || 0;\r\n                        const currentRemaining = t.remainingAmount ?? Math.max(t.amount - currentPaid, 0);\r\n                        let appliedAmount = amountPaid;\r\n\r\n                        if (appliedAmount > 0) {\r\n                            appliedAmount = Math.min(appliedAmount, currentRemaining);\r\n                        } else if (appliedAmount < 0) {\r\n                            appliedAmount = Math.max(appliedAmount, -currentPaid);\r\n                        }\r\n\r\n                        const newPaidAmount = currentPaid + appliedAmount;\r\n                        const recalculatedRemaining = Math.max(t.amount - newPaidAmount, 0);\r\n                        debtDelta -= appliedAmount;\r\n\r\n                        return {\r\n                            ...t,\r\n                            paidAmount: newPaidAmount,\r\n                            remainingAmount: recalculatedRemaining,\r\n                            isPaid: recalculatedRemaining <= 0,\r\n                            paidDate: recalculatedRemaining <= 0 ? new Date().toISOString().split('T')[0] : t.paidDate,\r\n                        };\r\n                    });\r\n\r\n                    return {\r\n                        ...customer,\r\n                        currentDebt: Math.max(0, (customer.currentDebt || 0) + debtDelta),\r\n                        debtTransactions: updatedTransactions,\r\n                    };\r\n                }\r\n                return customer;\r\n            })\r\n        }));\r\n    },\r\n    removeDebtTransaction: (systemId: SystemId, orderId: BusinessId) => {\r\n        baseStore.setState(state => ({\r\n            data: state.data.map(customer => {\r\n                if (customer.systemId === systemId && customer.debtTransactions) {\r\n                    const transaction = customer.debtTransactions.find(t => t.orderId === orderId);\r\n                    const outstanding = transaction\r\n                        ? Math.max(transaction.remainingAmount ?? (transaction.amount - (transaction.paidAmount || 0)), 0)\r\n                        : 0;\r\n                    return {\r\n                        ...customer,\r\n                        currentDebt: Math.max(0, (customer.currentDebt || 0) - outstanding),\r\n                        debtTransactions: customer.debtTransactions.filter(t => t.orderId !== orderId),\r\n                    };\r\n                }\r\n                return customer;\r\n            })\r\n        }));\r\n    },\r\n    // Add debt reminder (3.3)\r\n    addDebtReminder: (systemId: SystemId, reminder: import('./types').DebtReminder) => {\r\n        baseStore.setState(state => ({\r\n            data: state.data.map(customer => {\r\n                if (customer.systemId === systemId) {\r\n                    const currentReminders = customer.debtReminders || [];\r\n                    return {\r\n                        ...customer,\r\n                        debtReminders: [...currentReminders, reminder],\r\n                    };\r\n                }\r\n                return customer;\r\n            })\r\n        }));\r\n    },\r\n    // Update debt reminder (3.3)\r\n    updateDebtReminder: (systemId: SystemId, reminderId: SystemId, updates: Partial<import('./types').DebtReminder>) => {\r\n        baseStore.setState(state => ({\r\n            data: state.data.map(customer => {\r\n                if (customer.systemId === systemId && customer.debtReminders) {\r\n                    return {\r\n                        ...customer,\r\n                        debtReminders: customer.debtReminders.map(r =>\r\n                            r.systemId === reminderId ? { ...r, ...updates } : r\r\n                        ),\r\n                    };\r\n                }\r\n                return customer;\r\n            })\r\n        }));\r\n    },\r\n    // Remove debt reminder (3.3)\r\n    removeDebtReminder: (systemId: SystemId, reminderId: SystemId) => {\r\n        baseStore.setState(state => ({\r\n            data: state.data.map(customer => {\r\n                if (customer.systemId === systemId && customer.debtReminders) {\r\n                    return {\r\n                        ...customer,\r\n                        debtReminders: customer.debtReminders.filter(r => r.systemId !== reminderId),\r\n                    };\r\n                }\r\n                return customer;\r\n            })\r\n        }));\r\n    },\r\n    // Override add to auto-calculate lifecycle stage and log activity\r\n    add: (customer: Omit<Customer, 'systemId'>) => {\r\n        const userInfo = getCurrentUserInfo();\r\n        const customerWithLifecycle = {\r\n            ...customer,\r\n            lifecycleStage: calculateLifecycleStage(customer as Customer)\r\n        };\r\n        const newCustomer = baseStore.getState().add(customerWithLifecycle);\r\n        \r\n        // Add activity history entry\r\n        const historyEntry = createCreatedEntry(\r\n            userInfo,\r\n            `${userInfo.name} đã tạo khách hàng ${newCustomer.name} (${newCustomer.id})`\r\n        );\r\n        baseStore.getState().update(newCustomer.systemId, {\r\n            ...newCustomer,\r\n            activityHistory: [historyEntry]\r\n        });\r\n        \r\n        return newCustomer;\r\n    },\r\n    // Override update to auto-calculate lifecycle stage and log activity\r\n    update: (systemId: SystemId, updatedCustomer: Customer) => {\r\n        console.log('[CustomerStore] update called:', { systemId, updatedCustomer });\r\n        \r\n        const userInfo = getCurrentUserInfo();\r\n        const existingCustomer = baseStore.getState().data.find(c => c.systemId === systemId);\r\n        const historyEntries: HistoryEntry[] = [];\r\n        \r\n        if (existingCustomer) {\r\n            // Track status changes\r\n            if (existingCustomer.status !== updatedCustomer.status) {\r\n                historyEntries.push(createStatusChangedEntry(\r\n                    userInfo,\r\n                    existingCustomer.status,\r\n                    updatedCustomer.status,\r\n                    `${userInfo.name} đã đổi trạng thái từ \"${existingCustomer.status}\" sang \"${updatedCustomer.status}\"`\r\n                ));\r\n            }\r\n            \r\n            // Track field changes\r\n            const fieldsToTrack: Array<{ key: keyof Customer; label: string }> = [\r\n                { key: 'name', label: 'Tên khách hàng' },\r\n                { key: 'email', label: 'Email' },\r\n                { key: 'phone', label: 'Số điện thoại' },\r\n                { key: 'company', label: 'Công ty' },\r\n                { key: 'taxCode', label: 'Mã số thuế' },\r\n                { key: 'representative', label: 'Người đại diện' },\r\n                { key: 'type', label: 'Loại khách hàng' },\r\n                { key: 'customerGroup', label: 'Nhóm khách hàng' },\r\n                { key: 'lifecycleStage', label: 'Giai đoạn vòng đời' },\r\n                { key: 'maxDebt', label: 'Hạn mức công nợ' },\r\n                { key: 'paymentTerms', label: 'Điều khoản thanh toán' },\r\n                { key: 'creditRating', label: 'Xếp hạng tín dụng' },\r\n                { key: 'pricingLevel', label: 'Mức giá' },\r\n                { key: 'defaultDiscount', label: 'Chiết khấu mặc định' },\r\n                { key: 'accountManagerId', label: 'Nhân viên phụ trách' },\r\n            ];\r\n            \r\n            const changes: string[] = [];\r\n            for (const field of fieldsToTrack) {\r\n                const oldVal = existingCustomer[field.key];\r\n                const newVal = updatedCustomer[field.key];\r\n                if (oldVal !== newVal && !(oldVal === undefined && newVal === undefined)) {\r\n                    // Skip if it's the status field (already tracked above)\r\n                    if (field.key === 'status') continue;\r\n                    const oldDisplay = oldVal !== undefined && oldVal !== null && oldVal !== '' ? String(oldVal) : '(trống)';\r\n                    const newDisplay = newVal !== undefined && newVal !== null && newVal !== '' ? String(newVal) : '(trống)';\r\n                    changes.push(`${field.label}: ${oldDisplay} → ${newDisplay}`);\r\n                }\r\n            }\r\n            \r\n            if (changes.length > 0) {\r\n                historyEntries.push(createUpdatedEntry(\r\n                    userInfo,\r\n                    `${userInfo.name} đã cập nhật: ${changes.join(', ')}`\r\n                ));\r\n            }\r\n        }\r\n        \r\n        const customerWithLifecycle = {\r\n            ...updatedCustomer,\r\n            lifecycleStage: calculateLifecycleStage(updatedCustomer),\r\n            activityHistory: appendHistoryEntry(existingCustomer?.activityHistory, ...historyEntries)\r\n        };\r\n        console.log('[CustomerStore] Calling baseStore.update with:', customerWithLifecycle);\r\n        \r\n        // Call the update function from baseStore directly\r\n        baseStore.getState().update(systemId, customerWithLifecycle);\r\n        \r\n        console.log('[CustomerStore] State after update:', baseStore.getState().data.find(c => c.systemId === systemId));\r\n    },\r\n    // Get customers with high debt risk\r\n    getHighRiskDebtCustomers: () => {\r\n        const activeCustomers = baseStore.getState().getActive();\r\n        return getHighRiskDebtCustomers(activeCustomers);\r\n    },\r\n    // Batch update customer intelligence (RFM, health score, churn risk)\r\n    updateCustomerIntelligence: () => {\r\n        const allCustomers = baseStore.getState().getActive();\r\n        \r\n        baseStore.setState(state => ({\r\n            data: state.data.map(customer => {\r\n                if (customer.isDeleted) return customer;\r\n                \r\n                // Calculate RFM\r\n                const rfmScores = calculateRFMScores(customer, allCustomers);\r\n                const segment = getCustomerSegment(rfmScores);\r\n                \r\n                // Calculate health score\r\n                const healthScore = calculateHealthScore(customer);\r\n                \r\n                // Calculate churn risk\r\n                const churnRisk = calculateChurnRisk(customer).risk;\r\n                \r\n                // Calculate lifecycle stage\r\n                const lifecycleStage = calculateLifecycleStage(customer);\r\n                \r\n                return {\r\n                    ...customer,\r\n                    rfmScores,\r\n                    segment,\r\n                    healthScore,\r\n                    churnRisk,\r\n                    lifecycleStage\r\n                };\r\n            })\r\n        }));\r\n    },\r\n    // Get customers by segment\r\n    getCustomersBySegment: (segment: string) => {\r\n        return baseStore.getState().getActive().filter(c => c.segment === segment);\r\n    },\r\n    // Get customers with overdue debt\r\n    getOverdueDebtCustomers: () => {\r\n        const activeCustomers = baseStore.getState().getActive();\r\n        return getOverdueDebtCustomers(activeCustomers);\r\n    },\r\n    // Get customers with debt due soon\r\n    getDueSoonCustomers: () => {\r\n        const activeCustomers = baseStore.getState().getActive();\r\n        return getDueSoonCustomers(activeCustomers);\r\n    },\r\n    removeMany: (systemIds: SystemId[]) => {\r\n        if (!systemIds.length) return;\r\n        const deletedAtTimestamp = new Date().toISOString();\r\n        baseStore.setState(state => ({\r\n            data: state.data.map(customer =>\r\n                systemIds.includes(customer.systemId)\r\n                    ? { ...customer, isDeleted: true, deletedAt: deletedAtTimestamp }\r\n                    : customer\r\n            )\r\n        }));\r\n    },\r\n    updateManyStatus: (systemIds: SystemId[], status: Customer['status']) => {\r\n        if (!systemIds.length) return;\r\n        baseStore.setState(state => ({\r\n            data: state.data.map(customer =>\r\n                systemIds.includes(customer.systemId)\r\n                    ? { ...customer, status }\r\n                    : customer\r\n            )\r\n        }));\r\n    },\r\n    restoreMany: (systemIds: SystemId[]) => {\r\n        if (!systemIds.length) return;\r\n        baseStore.setState(state => ({\r\n            data: state.data.map(customer =>\r\n                systemIds.includes(customer.systemId)\r\n                    ? { ...customer, isDeleted: false, deletedAt: null }\r\n                    : customer\r\n            )\r\n        }));\r\n    }\r\n};\r\n\r\ntype CustomerStoreSelector<T> = (state: CustomerStoreState) => T;\r\n\r\nlet cachedBaseState: CrudState<Customer> | null = null;\r\nlet cachedCombinedState: CustomerStoreState | null = null;\r\n\r\nconst getCombinedState = (state: CrudState<Customer>): CustomerStoreState => {\r\n    if (cachedBaseState !== state || !cachedCombinedState) {\r\n        cachedBaseState = state;\r\n        cachedCombinedState = { ...state, ...augmentedMethods } as CustomerStoreState;\r\n    }\r\n    return cachedCombinedState!;\r\n};\r\n\r\nconst boundStore = baseStore as unknown as {\r\n    <R>(selector: (state: CrudState<Customer>) => R, equalityFn?: (a: R, b: R) => boolean): R;\r\n    (): CustomerStoreState;\r\n};\r\n\r\nexport const useCustomerStore = <T = CustomerStoreState>(\r\n    selector?: CustomerStoreSelector<T>,\r\n    equalityFn?: (a: T, b: T) => boolean\r\n): T => {\r\n    if (selector) {\r\n        if (equalityFn) {\r\n            return boundStore((state) => selector(getCombinedState(state)), equalityFn);\r\n        }\r\n        return boundStore((state) => selector(getCombinedState(state)));\r\n    }\r\n    return boundStore((state) => getCombinedState(state) as unknown as T);\r\n};\r\n\r\nuseCustomerStore.getState = (): CustomerStoreState => {\r\n    return getCombinedState(baseStore.getState());\r\n};\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 2462, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/customers/sla/evaluator.ts"],"sourcesContent":["import { differenceInDays, parseISO, formatISO } from 'date-fns';\r\nimport type { Customer } from '../types';\r\nimport type { CustomerSlaSetting, CustomerSlaType } from '../../settings/customers/types';\r\nimport type { CustomerSlaAlert, CustomerSlaIndex, CustomerHealthAlert, DebtAlert, ReportSummary } from './types';\r\nimport { calculateChurnRisk, calculateHealthScore } from '../intelligence-utils';\r\n\r\nconst MIN_DATE = '1970-01-01T00:00:00Z';\r\n\r\ntype AlertLevel = CustomerSlaAlert['alertLevel'];\r\n\r\nfunction calculateAlertLevel(daysRemaining: number, slaSetting: CustomerSlaSetting): AlertLevel {\r\n  // daysRemaining < 0 means overdue\r\n  // criticalDays = số ngày quá hạn để coi là nghiêm trọng\r\n  // warningDays = số ngày TRƯỚC target để bắt đầu cảnh báo\r\n  \r\n  if (daysRemaining < -slaSetting.criticalDays) return 'overdue'; // Quá hạn > criticalDays ngày\r\n  if (daysRemaining < 0) return 'critical'; // Quá hạn nhưng chưa đến criticalDays\r\n  if (daysRemaining <= slaSetting.warningDays) return 'warning'; // Còn <= warningDays ngày\r\n  return 'normal';\r\n}\r\n\r\nfunction addDays(base: Date, days: number) {\r\n  return new Date(base.getTime() + days * 24 * 60 * 60 * 1000);\r\n}\r\n\r\nfunction resolveBaselineDate(customer: Customer, slaType: CustomerSlaType) {\r\n  switch (slaType) {\r\n    case 'follow-up':\r\n      return customer.lastContactDate || customer.lastPurchaseDate || customer.updatedAt || customer.createdAt || MIN_DATE;\r\n    case 're-engagement':\r\n      return customer.lastPurchaseDate || customer.updatedAt || customer.createdAt || MIN_DATE;\r\n    case 'debt-payment':\r\n      return customer.oldestDebtDueDate || customer.updatedAt || customer.createdAt || MIN_DATE;\r\n  }\r\n}\r\n\r\nfunction getAssignee(customer: Customer, slaType: CustomerSlaType) {\r\n  if (customer.accountManagerName) return customer.accountManagerName;\r\n  if (customer.accountManagerId) return customer.accountManagerId;\r\n  if (slaType === 'debt-payment') return 'Kế toán công nợ';\r\n  return 'Chưa phân công';\r\n}\r\n\r\nfunction getLastActivity(customer: Customer, slaType: CustomerSlaType) {\r\n  if (slaType === 'debt-payment') {\r\n    return customer.oldestDebtDueDate || customer.updatedAt || customer.createdAt || MIN_DATE;\r\n  }\r\n  if (slaType === 'follow-up') {\r\n    return customer.lastContactDate || customer.lastPurchaseDate || customer.updatedAt || customer.createdAt || MIN_DATE;\r\n  }\r\n  return customer.lastPurchaseDate || customer.updatedAt || customer.createdAt || MIN_DATE;\r\n}\r\n\r\nfunction evaluateSla(customers: Customer[], slaSettings: CustomerSlaSetting[], slaType: CustomerSlaType) {\r\n  const setting = slaSettings.find(s => s.slaType === slaType && s.isActive);\r\n  if (!setting) return [] as CustomerSlaAlert[];\r\n\r\n  const today = new Date();\r\n  const alerts: CustomerSlaAlert[] = [];\r\n\r\n  for (const customer of customers) {\r\n    if (customer.isDeleted || customer.status === 'Ngừng Giao Dịch') continue;\r\n\r\n    const baselineISO = resolveBaselineDate(customer, slaType);\r\n    const baseline = parseISO(baselineISO);\r\n    const daysSinceBaseline = differenceInDays(today, baseline);\r\n    const daysRemaining = setting.targetDays - daysSinceBaseline;\r\n\r\n    if (slaType === 're-engagement' && !customer.totalOrders) continue;\r\n    if (slaType === 'debt-payment' && !customer.currentDebt) continue;\r\n\r\n    // Hiển thị alert khi:\r\n    // - Còn <= warningDays ngày (sắp đến hạn)\r\n    // - Hoặc đã quá hạn (daysRemaining < 0)\r\n    if (daysRemaining <= setting.warningDays) {\r\n      alerts.push({\r\n        systemId: customer.systemId,\r\n        customer,\r\n        slaType,\r\n        slaName: setting.name,\r\n        daysRemaining,\r\n        alertLevel: calculateAlertLevel(daysRemaining, setting),\r\n        targetDate: formatISO(addDays(baseline, setting.targetDays), { representation: 'date' }),\r\n        lastActivityDate: baselineISO,\r\n        assignee: getAssignee(customer, slaType),\r\n      });\r\n    }\r\n  }\r\n\r\n  return alerts.sort((a, b) => a.daysRemaining - b.daysRemaining);\r\n}\r\n\r\nfunction evaluateDebts(customers: Customer[]): DebtAlert[] {\r\n  const alerts: DebtAlert[] = [];\r\n  const today = new Date();\r\n\r\n  for (const customer of customers) {\r\n    if (customer.isDeleted) continue;\r\n    const currentDebt = customer.currentDebt || 0;\r\n    if (currentDebt <= 0) continue;\r\n\r\n    let overdueAmount = 0;\r\n    let maxDaysOverdue = 0;\r\n    let oldestDueDate: string | undefined;\r\n\r\n    if (customer.debtTransactions) {\r\n      for (const txn of customer.debtTransactions) {\r\n        if (txn.isPaid) continue;\r\n        const dueDate = parseISO(txn.dueDate);\r\n        const daysOverdue = differenceInDays(today, dueDate);\r\n        if (daysOverdue > 0) {\r\n          overdueAmount += txn.remainingAmount || txn.amount;\r\n          if (daysOverdue > maxDaysOverdue) {\r\n            maxDaysOverdue = daysOverdue;\r\n            oldestDueDate = txn.dueDate;\r\n          }\r\n        }\r\n      }\r\n    }\r\n\r\n    // ✅ Tính debtStatus realtime thay vì lấy từ dữ liệu cũ\r\n    let debtStatus: NonNullable<Customer['debtStatus']>;\r\n    if (maxDaysOverdue > 30) {\r\n      debtStatus = 'Quá hạn > 30 ngày';\r\n    } else if (maxDaysOverdue > 15) {\r\n      debtStatus = 'Quá hạn 16-30 ngày';\r\n    } else if (maxDaysOverdue > 7) {\r\n      debtStatus = 'Quá hạn 8-15 ngày';\r\n    } else if (maxDaysOverdue > 0) {\r\n      debtStatus = 'Quá hạn 1-7 ngày';\r\n    } else if (oldestDueDate) {\r\n      const daysUntilDue = differenceInDays(parseISO(oldestDueDate), today);\r\n      if (daysUntilDue <= 0) {\r\n        debtStatus = 'Đến hạn hôm nay';\r\n      } else if (daysUntilDue <= 3) {\r\n        debtStatus = 'Sắp đến hạn';\r\n      } else {\r\n        debtStatus = 'Chưa đến hạn';\r\n      }\r\n    } else {\r\n      debtStatus = customer.debtStatus || 'Chưa đến hạn';\r\n    }\r\n    \r\n    // ✅ Chỉ hiển thị nếu thực sự có nợ quá hạn (overdueAmount > 0)\r\n    if (overdueAmount > 0) {\r\n      const debtAlert: DebtAlert = {\r\n        systemId: customer.systemId,\r\n        customer,\r\n        totalDebt: currentDebt,\r\n        overdueAmount,\r\n        daysOverdue: maxDaysOverdue,\r\n        debtStatus,\r\n      };\r\n      if (oldestDueDate !== undefined) {\r\n        debtAlert.oldestDueDate = oldestDueDate;\r\n      }\r\n      alerts.push(debtAlert);\r\n    }\r\n  }\r\n\r\n  return alerts.sort((a, b) => b.daysOverdue - a.daysOverdue);\r\n}\r\n\r\nfunction evaluateHealth(customers: Customer[]): CustomerHealthAlert[] {\r\n  const today = new Date();\r\n  const alerts: CustomerHealthAlert[] = [];\r\n\r\n  for (const customer of customers) {\r\n    if (customer.isDeleted || customer.status === 'Ngừng Giao Dịch') continue;\r\n\r\n    // ✅ Tính realtime thay vì lấy từ dữ liệu cũ\r\n    const healthScore = calculateHealthScore(customer);\r\n    const churnRiskResult = calculateChurnRisk(customer);\r\n    const churnRisk = churnRiskResult.risk;\r\n\r\n    // Chỉ hiển thị nếu có rủi ro medium/high hoặc health score thấp\r\n    if (churnRisk !== 'low' || healthScore < 50) {\r\n      const daysSinceLastPurchase = customer.lastPurchaseDate\r\n        ? differenceInDays(today, parseISO(customer.lastPurchaseDate))\r\n        : 999;\r\n\r\n      const healthAlert: CustomerHealthAlert = {\r\n        systemId: customer.systemId,\r\n        customer,\r\n        healthScore,\r\n        churnRisk,\r\n        daysSinceLastPurchase,\r\n        totalOrders: customer.totalOrders || 0,\r\n        totalSpent: customer.totalSpent || 0,\r\n      };\r\n      if (customer.segment !== undefined) {\r\n        healthAlert.segment = customer.segment;\r\n      }\r\n      alerts.push(healthAlert);\r\n    }\r\n  }\r\n\r\n  return alerts.sort((a, b) => a.healthScore - b.healthScore);\r\n}\r\n\r\nexport function buildSlaIndex(customers: Customer[], slaSettings: CustomerSlaSetting[]): CustomerSlaIndex {\r\n  const followUpAlerts = evaluateSla(customers, slaSettings, 'follow-up');\r\n  const reEngagementAlerts = evaluateSla(customers, slaSettings, 're-engagement');\r\n  const debtAlerts = evaluateDebts(customers);\r\n  const healthAlerts = evaluateHealth(customers);\r\n\r\n  const entries: CustomerSlaIndex['entries'] = {};\r\n\r\n  for (const alert of followUpAlerts) {\r\n    entries[alert.systemId] = entries[alert.systemId] || { customer: alert.customer, alerts: [] };\r\n    entries[alert.systemId].alerts.push(alert);\r\n  }\r\n  for (const alert of reEngagementAlerts) {\r\n    entries[alert.systemId] = entries[alert.systemId] || { customer: alert.customer, alerts: [] };\r\n    entries[alert.systemId].alerts.push(alert);\r\n  }\r\n  for (const alert of debtAlerts) {\r\n    entries[alert.systemId] = entries[alert.systemId] || { customer: alert.customer, alerts: [] };\r\n    entries[alert.systemId].debtAlert = alert;\r\n  }\r\n  for (const alert of healthAlerts) {\r\n    entries[alert.systemId] = entries[alert.systemId] || { customer: alert.customer, alerts: [] };\r\n    entries[alert.systemId].healthAlert = alert;\r\n  }\r\n\r\n  return {\r\n    entries,\r\n    followUpAlerts,\r\n    reEngagementAlerts,\r\n    debtAlerts,\r\n    healthAlerts,\r\n  };\r\n}\r\n\r\nexport function summarizeIndex(index: CustomerSlaIndex): ReportSummary {\r\n  // Count unique customers with critical alerts\r\n  const criticalCustomerIds = new Set<string>();\r\n  \r\n  index.followUpAlerts\r\n    .filter(a => a.alertLevel === 'critical' || a.alertLevel === 'overdue')\r\n    .forEach(a => criticalCustomerIds.add(a.systemId));\r\n  \r\n  index.reEngagementAlerts\r\n    .filter(a => a.alertLevel === 'critical' || a.alertLevel === 'overdue')\r\n    .forEach(a => criticalCustomerIds.add(a.systemId));\r\n  \r\n  index.debtAlerts\r\n    .filter(a => a.daysOverdue > 15)\r\n    .forEach(a => criticalCustomerIds.add(a.systemId));\r\n  \r\n  index.healthAlerts\r\n    .filter(a => a.churnRisk === 'high')\r\n    .forEach(a => criticalCustomerIds.add(a.systemId));\r\n  \r\n  const criticalCount = criticalCustomerIds.size;\r\n  const totalCustomers = Object.keys(index.entries).length;\r\n\r\n  return {\r\n    totalCustomers,\r\n    followUpAlerts: index.followUpAlerts.length,\r\n    reEngagementAlerts: index.reEngagementAlerts.length,\r\n    debtAlerts: index.debtAlerts.length,\r\n    healthAlerts: index.healthAlerts.length,\r\n    criticalCount,\r\n  };\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 2703, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/customers/sla/sla-sync.ts"],"sourcesContent":["/**\r\n * Customer SLA Sync Utilities\r\n * NOTE: localStorage has been removed - uses in-memory cache + database sync\r\n */\r\n\r\nimport type { \r\n  CustomerSlaAckMap, \r\n  SlaActivityLog,\r\n  CustomerSlaIndex \r\n} from './types';\r\n\r\n// In-memory caches\r\nlet ackMapCache: CustomerSlaAckMap | null = null;\r\nlet activityLogCache: SlaActivityLog[] | null = null;\r\nlet evaluationCache: CustomerSlaIndex | null = null;\r\n\r\n// ============= ACKNOWLEDGEMENTS =============\r\n\r\nasync function fetchAckMap(): Promise<CustomerSlaAckMap> {\r\n  try {\r\n    const response = await fetch('/api/customer-sla?type=ack');\r\n    if (!response.ok) throw new Error('Failed to fetch');\r\n    return await response.json();\r\n  } catch (error) {\r\n    console.error('[CustomerSLA] Failed to fetch ack map:', error);\r\n    throw error;\r\n  }\r\n}\r\n\r\nasync function saveAckMapToDb(map: CustomerSlaAckMap): Promise<void> {\r\n  try {\r\n    const response = await fetch('/api/customer-sla', {\r\n      method: 'POST',\r\n      headers: { 'Content-Type': 'application/json' },\r\n      body: JSON.stringify({ type: 'ack', data: map }),\r\n    });\r\n    if (!response.ok) throw new Error('Failed to save');\r\n  } catch (error) {\r\n    console.error('[CustomerSLA] Failed to save ack map:', error);\r\n    throw error;\r\n  }\r\n}\r\n\r\n/**\r\n * Load ack map from database\r\n */\r\nexport async function loadAckMapAsync(): Promise<CustomerSlaAckMap> {\r\n  try {\r\n    const data = await fetchAckMap();\r\n    ackMapCache = data;\r\n    return data;\r\n  } catch {\r\n    return ackMapCache ?? {};\r\n  }\r\n}\r\n\r\n/**\r\n * Get ack map synchronously (from cache)\r\n */\r\nexport function getAckMapSync(): CustomerSlaAckMap {\r\n  return ackMapCache ?? {};\r\n}\r\n\r\n/**\r\n * Save ack map to database\r\n */\r\nexport async function saveAckMapAsync(map: CustomerSlaAckMap): Promise<void> {\r\n  await saveAckMapToDb(map);\r\n  ackMapCache = map;\r\n}\r\n\r\n// ============= ACTIVITY LOG =============\r\n\r\nasync function fetchActivityLog(): Promise<SlaActivityLog[]> {\r\n  try {\r\n    const response = await fetch('/api/customer-sla?type=log');\r\n    if (!response.ok) throw new Error('Failed to fetch');\r\n    return await response.json();\r\n  } catch (error) {\r\n    console.error('[CustomerSLA] Failed to fetch activity log:', error);\r\n    throw error;\r\n  }\r\n}\r\n\r\nasync function saveActivityLogToDb(logs: SlaActivityLog[]): Promise<void> {\r\n  try {\r\n    const response = await fetch('/api/customer-sla', {\r\n      method: 'POST',\r\n      headers: { 'Content-Type': 'application/json' },\r\n      body: JSON.stringify({ type: 'log', data: logs }),\r\n    });\r\n    if (!response.ok) throw new Error('Failed to save');\r\n  } catch (error) {\r\n    console.error('[CustomerSLA] Failed to save activity log:', error);\r\n    throw error;\r\n  }\r\n}\r\n\r\n/**\r\n * Load activity log from database\r\n */\r\nexport async function loadActivityLogAsync(): Promise<SlaActivityLog[]> {\r\n  try {\r\n    const data = await fetchActivityLog();\r\n    activityLogCache = data;\r\n    return data;\r\n  } catch {\r\n    return activityLogCache ?? [];\r\n  }\r\n}\r\n\r\n/**\r\n * Get activity log synchronously\r\n */\r\nexport function getActivityLogSync(): SlaActivityLog[] {\r\n  return activityLogCache ?? [];\r\n}\r\n\r\n/**\r\n * Add to activity log and save to database\r\n */\r\nexport async function addActivityLogAsync(log: SlaActivityLog): Promise<void> {\r\n  const logs = getActivityLogSync();\r\n  logs.push(log);\r\n  // Keep only last 500 entries\r\n  const trimmed = logs.slice(-500);\r\n  await saveActivityLogToDb(trimmed);\r\n  activityLogCache = trimmed;\r\n}\r\n\r\n// ============= EVALUATION DATA =============\r\n\r\nasync function fetchEvaluation(): Promise<CustomerSlaIndex | null> {\r\n  try {\r\n    const response = await fetch('/api/customer-sla?type=evaluation');\r\n    if (!response.ok) throw new Error('Failed to fetch');\r\n    return await response.json();\r\n  } catch (error) {\r\n    console.error('[CustomerSLA] Failed to fetch evaluation:', error);\r\n    throw error;\r\n  }\r\n}\r\n\r\nasync function saveEvaluationToDb(data: CustomerSlaIndex, timestamp: string): Promise<void> {\r\n  try {\r\n    await fetch('/api/customer-sla', {\r\n      method: 'POST',\r\n      headers: { 'Content-Type': 'application/json' },\r\n      body: JSON.stringify({ type: 'evaluation', data }),\r\n    });\r\n  } catch (error) {\r\n    console.error('[CustomerSLA] Failed to save evaluation:', error);\r\n    throw error;\r\n  }\r\n}\r\n\r\n/**\r\n * Load evaluation data from database\r\n */\r\nexport async function loadEvaluationAsync(): Promise<CustomerSlaIndex | null> {\r\n  try {\r\n    const data = await fetchEvaluation();\r\n    evaluationCache = data;\r\n    return data;\r\n  } catch {\r\n    return evaluationCache;\r\n  }\r\n}\r\n\r\n/**\r\n * Get evaluation data synchronously\r\n */\r\nexport function getEvaluationSync(): CustomerSlaIndex | null {\r\n  return evaluationCache;\r\n}\r\n\r\n/**\r\n * Save evaluation data to database\r\n */\r\nexport async function saveEvaluationAsync(data: CustomerSlaIndex, timestamp: string): Promise<void> {\r\n  await saveEvaluationToDb(data, timestamp);\r\n  evaluationCache = data;\r\n}\r\n\r\n// ============= INITIALIZATION =============\r\n\r\n/**\r\n * Initialize all customer SLA data from database\r\n */\r\nexport async function initCustomerSlaData(): Promise<void> {\r\n  await Promise.all([\r\n    loadAckMapAsync(),\r\n    loadActivityLogAsync(),\r\n    loadEvaluationAsync(),\r\n  ]);\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 2881, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/customers/sla/ack-storage.ts"],"sourcesContent":["/**\r\n * Customer SLA Acknowledgement Storage\r\n * \r\n * NOTE: localStorage has been removed - uses in-memory cache + database sync\r\n */\r\n\r\nimport type { CustomerSlaAckMap, CustomerSlaAcknowledgement, CustomerSlaType, SlaActivityLog } from './types';\r\nimport type { SystemId } from '@/lib/id-types';\r\nimport {\r\n  getAckMapSync,\r\n  saveAckMapAsync,\r\n  getActivityLogSync,\r\n  addActivityLogAsync,\r\n} from './sla-sync';\r\n\r\n// In-memory cache\r\nlet cachedMap: CustomerSlaAckMap | null = null;\r\nlet cachedActivityLog: SlaActivityLog[] | null = null;\r\n\r\nfunction ensureCache(): CustomerSlaAckMap {\r\n  if (!cachedMap) {\r\n    cachedMap = getAckMapSync();\r\n  }\r\n  return cachedMap;\r\n}\r\n\r\nfunction saveAckMap(map: CustomerSlaAckMap) {\r\n  cachedMap = map;\r\n  // Fire and forget - save to database in background\r\n  saveAckMapAsync(map).catch(error => {\r\n    console.warn('[customer-sla] Failed to persist ack map to database', error);\r\n  });\r\n}\r\n\r\nexport function getAcknowledgement(customerId: SystemId, slaType: CustomerSlaType): CustomerSlaAcknowledgement | undefined {\r\n  const map = ensureCache();\r\n  const ack = map[customerId]?.[slaType];\r\n  \r\n  // Check if snooze has expired\r\n  if (ack?.snoozeUntil) {\r\n    const snoozeEnd = new Date(ack.snoozeUntil);\r\n    if (snoozeEnd < new Date()) {\r\n      // Snooze expired, remove the acknowledgement\r\n      clearAcknowledgement(customerId, slaType);\r\n      return undefined;\r\n    }\r\n  }\r\n  \r\n  return ack;\r\n}\r\n\r\nexport function setAcknowledgement(customerId: SystemId, ack: CustomerSlaAcknowledgement, performedBy?: string) {\r\n  const map = ensureCache();\r\n  map[customerId] = map[customerId] || {};\r\n  map[customerId][ack.slaType] = ack;\r\n  saveAckMap(map);\r\n  \r\n  // Log activity\r\n  addActivityLog({\r\n    id: `${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,\r\n    customerId,\r\n    slaType: ack.slaType,\r\n    actionType: ack.actionType,\r\n    performedAt: ack.acknowledgedAt,\r\n    performedBy,\r\n    notes: ack.notes,\r\n  });\r\n}\r\n\r\nexport function clearAcknowledgement(customerId: SystemId, slaType?: CustomerSlaType) {\r\n  const map = ensureCache();\r\n  if (!map[customerId]) return;\r\n  if (slaType) {\r\n    delete map[customerId][slaType];\r\n  } else {\r\n    delete map[customerId];\r\n  }\r\n  saveAckMap(map);\r\n}\r\n\r\n// Activity Log functions\r\nfunction loadActivityLog(): SlaActivityLog[] {\r\n  if (!cachedActivityLog) {\r\n    cachedActivityLog = getActivityLogSync();\r\n  }\r\n  return cachedActivityLog;\r\n}\r\n\r\nexport const SLA_LOG_UPDATED_EVENT = 'sla-log-updated';\r\n\r\nexport function addActivityLog(log: SlaActivityLog) {\r\n  const logs = loadActivityLog();\r\n  logs.push(log);\r\n  // Keep only last 500 entries\r\n  cachedActivityLog = logs.slice(-500);\r\n  \r\n  // Fire and forget - save to database in background\r\n  addActivityLogAsync(log).catch(error => {\r\n    console.warn('[customer-sla] Failed to save activity log to database', error);\r\n  });\r\n  \r\n  // Dispatch event to notify listeners\r\n  if (typeof window !== 'undefined') {\r\n    window.dispatchEvent(new CustomEvent(SLA_LOG_UPDATED_EVENT, { detail: { customerId: log.customerId } }));\r\n  }\r\n}\r\n\r\nexport function getActivityLogs(customerId?: SystemId, limit = 50): SlaActivityLog[] {\r\n  const logs = loadActivityLog();\r\n  const filtered = customerId \r\n    ? logs.filter(l => l.customerId === customerId)\r\n    : logs;\r\n  return filtered.slice(-limit).reverse();\r\n}\r\n\r\nexport function isAlertSnoozed(customerId: SystemId, slaType: CustomerSlaType): boolean {\r\n  const ack = getAcknowledgement(customerId, slaType);\r\n  if (!ack?.snoozeUntil) return false;\r\n  return new Date(ack.snoozeUntil) > new Date();\r\n}\r\n\r\nexport function getSnoozeRemaining(customerId: SystemId, slaType: CustomerSlaType): number {\r\n  const ack = getAcknowledgement(customerId, slaType);\r\n  if (!ack?.snoozeUntil) return 0;\r\n  const remaining = new Date(ack.snoozeUntil).getTime() - Date.now();\r\n  return Math.max(0, Math.ceil(remaining / (1000 * 60 * 60 * 24))); // Days remaining\r\n}\r\n"],"names":[],"mappings":"AAAA;;;;CAIC;;;;;;;;;;;;;;;;;;AAID;;AAOA,kBAAkB;AAClB,IAAI,YAAsC;AAC1C,IAAI,oBAA6C;AAEjD,SAAS;IACP,IAAI,CAAC,WAAW;QACd,YAAY,IAAA,4JAAa;IAC3B;IACA,OAAO;AACT;AAEA,SAAS,WAAW,GAAsB;IACxC,YAAY;IACZ,mDAAmD;IACnD,IAAA,8JAAe,EAAC,KAAK,KAAK,CAAC,CAAA;QACzB,QAAQ,IAAI,CAAC,wDAAwD;IACvE;AACF;AAEO,SAAS,mBAAmB,UAAoB,EAAE,OAAwB;IAC/E,MAAM,MAAM;IACZ,MAAM,MAAM,GAAG,CAAC,WAAW,EAAE,CAAC,QAAQ;IAEtC,8BAA8B;IAC9B,IAAI,KAAK,aAAa;QACpB,MAAM,YAAY,IAAI,KAAK,IAAI,WAAW;QAC1C,IAAI,YAAY,IAAI,QAAQ;YAC1B,6CAA6C;YAC7C,qBAAqB,YAAY;YACjC,OAAO;QACT;IACF;IAEA,OAAO;AACT;AAEO,SAAS,mBAAmB,UAAoB,EAAE,GAA+B,EAAE,WAAoB;IAC5G,MAAM,MAAM;IACZ,GAAG,CAAC,WAAW,GAAG,GAAG,CAAC,WAAW,IAAI,CAAC;IACtC,GAAG,CAAC,WAAW,CAAC,IAAI,OAAO,CAAC,GAAG;IAC/B,WAAW;IAEX,eAAe;IACf,eAAe;QACb,IAAI,GAAG,KAAK,GAAG,GAAG,CAAC,EAAE,KAAK,MAAM,GAAG,QAAQ,CAAC,IAAI,MAAM,CAAC,GAAG,IAAI;QAC9D;QACA,SAAS,IAAI,OAAO;QACpB,YAAY,IAAI,UAAU;QAC1B,aAAa,IAAI,cAAc;QAC/B;QACA,OAAO,IAAI,KAAK;IAClB;AACF;AAEO,SAAS,qBAAqB,UAAoB,EAAE,OAAyB;IAClF,MAAM,MAAM;IACZ,IAAI,CAAC,GAAG,CAAC,WAAW,EAAE;IACtB,IAAI,SAAS;QACX,OAAO,GAAG,CAAC,WAAW,CAAC,QAAQ;IACjC,OAAO;QACL,OAAO,GAAG,CAAC,WAAW;IACxB;IACA,WAAW;AACb;AAEA,yBAAyB;AACzB,SAAS;IACP,IAAI,CAAC,mBAAmB;QACtB,oBAAoB,IAAA,iKAAkB;IACxC;IACA,OAAO;AACT;AAEO,MAAM,wBAAwB;AAE9B,SAAS,eAAe,GAAmB;IAChD,MAAM,OAAO;IACb,KAAK,IAAI,CAAC;IACV,6BAA6B;IAC7B,oBAAoB,KAAK,KAAK,CAAC,CAAC;IAEhC,mDAAmD;IACnD,IAAA,kKAAmB,EAAC,KAAK,KAAK,CAAC,CAAA;QAC7B,QAAQ,IAAI,CAAC,0DAA0D;IACzE;IAEA,qCAAqC;IACrC;;AAGF;AAEO,SAAS,gBAAgB,UAAqB,EAAE,QAAQ,EAAE;IAC/D,MAAM,OAAO;IACb,MAAM,WAAW,aACb,KAAK,MAAM,CAAC,CAAA,IAAK,EAAE,UAAU,KAAK,cAClC;IACJ,OAAO,SAAS,KAAK,CAAC,CAAC,OAAO,OAAO;AACvC;AAEO,SAAS,eAAe,UAAoB,EAAE,OAAwB;IAC3E,MAAM,MAAM,mBAAmB,YAAY;IAC3C,IAAI,CAAC,KAAK,aAAa,OAAO;IAC9B,OAAO,IAAI,KAAK,IAAI,WAAW,IAAI,IAAI;AACzC;AAEO,SAAS,mBAAmB,UAAoB,EAAE,OAAwB;IAC/E,MAAM,MAAM,mBAAmB,YAAY;IAC3C,IAAI,CAAC,KAAK,aAAa,OAAO;IAC9B,MAAM,YAAY,IAAI,KAAK,IAAI,WAAW,EAAE,OAAO,KAAK,KAAK,GAAG;IAChE,OAAO,KAAK,GAAG,CAAC,GAAG,KAAK,IAAI,CAAC,YAAY,CAAC,OAAO,KAAK,KAAK,EAAE,KAAK,iBAAiB;AACrF"}},
    {"offset": {"line": 3002, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/customers/sla/store.ts"],"sourcesContent":["/**\r\n * Customer SLA Engine Store\r\n * \r\n * NOTE: Now syncs with database via sla-sync.ts\r\n */\r\n\r\nimport { create } from 'zustand';\r\nimport type { Customer } from '../types';\r\nimport type { CustomerSlaSetting } from '../../settings/customers/types';\r\nimport type { CustomerSlaIndex, ReportSummary, CustomerSlaAlert, SlaActionType } from './types';\r\nimport { buildSlaIndex, summarizeIndex } from './evaluator';\r\nimport { SLA_EVALUATION_KEY, SLA_LAST_RUN_KEY } from './constants';\r\nimport { setAcknowledgement, getAcknowledgement, isAlertSnoozed, getSnoozeRemaining } from './ack-storage';\r\nimport { getEvaluationSync, saveEvaluationAsync } from './sla-sync';\r\nimport type { CustomerSlaType, CustomerSlaAcknowledgement } from './types';\r\nimport type { SystemId } from '@/lib/id-types';\r\nimport { getCurrentUserName } from '@/contexts/auth-context';\r\nimport { useCustomerStore } from '../store';\r\n\r\ntype SlaStoreState = {\r\n  lastEvaluatedAt?: string;\r\n  index: CustomerSlaIndex | null;\r\n  summary: ReportSummary | null;\r\n  isLoading: boolean;\r\n};\r\n\r\ntype AcknowledgeOptions = {\r\n  actionType?: SlaActionType;\r\n  snoozeDays?: number;\r\n  notes?: string;\r\n};\r\n\r\ntype SlaStoreActions = {\r\n  evaluate: (customers: Customer[], settings: CustomerSlaSetting[]) => void;\r\n  acknowledge: (customerId: SystemId, alert: CustomerSlaAlert, options?: AcknowledgeOptions) => void;\r\n  snooze: (customerId: SystemId, alert: CustomerSlaAlert, days: number, notes?: string) => void;\r\n  getAck: (customerId: SystemId, slaType: CustomerSlaType) => CustomerSlaAcknowledgement | undefined;\r\n  isSnoozed: (customerId: SystemId, slaType: CustomerSlaType) => boolean;\r\n  getSnoozeRemaining: (customerId: SystemId, slaType: CustomerSlaType) => number;\r\n  triggerReevaluation: () => void;\r\n};\r\n\r\ntype SlaStore = SlaStoreState & SlaStoreActions;\r\n\r\n// In-memory storage for last run time\r\nlet cachedLastRun: string | undefined = undefined;\r\n\r\nconst getPersistedIndex = (): CustomerSlaIndex | null => {\r\n  // Use sync utility which checks in-memory cache, then database\r\n  return getEvaluationSync();\r\n};\r\n\r\nconst getLastRun = () => {\r\n  return cachedLastRun;\r\n};\r\n\r\nconst persistedIndex = getPersistedIndex();\r\n\r\n// Store reference for re-evaluation\r\nlet lastCustomers: Customer[] = [];\r\nlet lastSettings: CustomerSlaSetting[] = [];\r\n\r\nexport const useCustomerSlaEngineStore = create<SlaStore>((set, get) => {\r\n  const initialState: SlaStoreState = {\r\n    index: persistedIndex,\r\n    summary: persistedIndex ? summarizeIndex(persistedIndex) : null,\r\n    isLoading: false,\r\n  };\r\n  const initialLastRun = getLastRun();\r\n  if (initialLastRun !== undefined) {\r\n    initialState.lastEvaluatedAt = initialLastRun;\r\n  }\r\n\r\n  return {\r\n    ...initialState,\r\n\r\n    evaluate(customers, settings) {\r\n      // Store for re-evaluation\r\n      lastCustomers = customers;\r\n      lastSettings = settings;\r\n      \r\n      set({ isLoading: true });\r\n      const nextIndex = buildSlaIndex(customers, settings);\r\n      const nextSummary = summarizeIndex(nextIndex);\r\n      const timestamp = new Date().toISOString();\r\n\r\n      // Update in-memory cache\r\n      cachedLastRun = timestamp;\r\n      \r\n      // Fire and forget - save to database in background\r\n      saveEvaluationAsync(nextIndex, timestamp).catch(error => {\r\n        console.warn('[customer-sla] Failed to save evaluation to database', error);\r\n      });\r\n\r\n      set({\r\n        index: nextIndex,\r\n        summary: nextSummary,\r\n        lastEvaluatedAt: timestamp,\r\n        isLoading: false,\r\n      });\r\n    },\r\n\r\n    triggerReevaluation() {\r\n      // Get fresh customer data from the customer store\r\n      const freshCustomers = useCustomerStore.getState().data;\r\n      if (freshCustomers.length && lastSettings.length) {\r\n        get().evaluate(freshCustomers, lastSettings);\r\n      }\r\n    },\r\n\r\n    acknowledge(customerId, alert, options = {}) {\r\n      const { actionType = 'acknowledged', snoozeDays, notes } = options;\r\n      const now = new Date();\r\n      const performedBy = getCurrentUserName() || 'Hệ thống';\r\n      \r\n      const ack: CustomerSlaAcknowledgement = {\r\n        slaType: alert.slaType,\r\n        targetDate: alert.targetDate,\r\n        acknowledgedAt: now.toISOString(),\r\n        actionType,\r\n        notes,\r\n      };\r\n      \r\n      if (snoozeDays && snoozeDays > 0) {\r\n        const snoozeEnd = new Date(now.getTime() + snoozeDays * 24 * 60 * 60 * 1000);\r\n        ack.snoozeUntil = snoozeEnd.toISOString();\r\n        ack.actionType = 'snoozed';\r\n      }\r\n      \r\n      setAcknowledgement(customerId, ack, performedBy);\r\n\r\n      const currentIndex = get().index;\r\n      if (!currentIndex) return;\r\n\r\n      // For follow-up SLA, we remove from index because the cycle will be reset\r\n      // (lastContactDate updated -> re-evaluation will create new alert with new targetDate)\r\n      // For other SLA types, we keep the alert visible with \"acknowledged\" badge\r\n      if (alert.slaType === 'follow-up') {\r\n        const nextEntries = { ...currentIndex.entries };\r\n        const entry = nextEntries[customerId];\r\n        if (entry) {\r\n          entry.alerts = entry.alerts.filter(a => !(a.slaType === alert.slaType && a.targetDate === alert.targetDate));\r\n        }\r\n\r\n        const nextIndex = {\r\n          ...currentIndex,\r\n          entries: nextEntries,\r\n          followUpAlerts: currentIndex.followUpAlerts.filter(a => !(a.systemId === customerId && a.slaType === alert.slaType && a.targetDate === alert.targetDate)),\r\n        };\r\n\r\n        const nextSummary = summarizeIndex(nextIndex);\r\n        set({ index: nextIndex, summary: nextSummary });\r\n      } else {\r\n        // For re-engagement, debt-payment - just trigger a re-render\r\n        // Alert stays visible with \"acknowledged\" badge\r\n        // Create new summary object to ensure reference change\r\n        const newSummary = { ...summarizeIndex(currentIndex), _lastAckAt: now.toISOString() };\r\n        set({ summary: newSummary });\r\n      }\r\n    },\r\n\r\n    snooze(customerId, alert, days, notes) {\r\n      get().acknowledge(customerId, alert, {\r\n        actionType: 'snoozed',\r\n        snoozeDays: days,\r\n        notes: notes || `Tạm ẩn ${days} ngày`,\r\n      });\r\n    },\r\n\r\n    getAck(customerId, slaType) {\r\n      return getAcknowledgement(customerId, slaType);\r\n    },\r\n\r\n    isSnoozed(customerId, slaType) {\r\n      return isAlertSnoozed(customerId, slaType);\r\n    },\r\n\r\n    getSnoozeRemaining(customerId, slaType) {\r\n      return getSnoozeRemaining(customerId, slaType);\r\n    },\r\n  };\r\n});\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 3152, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/customers/customer-service.ts"],"sourcesContent":["import Fuse from 'fuse.js';\r\nimport type { IFuseOptions } from 'fuse.js';\r\nimport { isDateAfter, isDateBefore } from '../../lib/date-utils';\r\nimport type { Customer } from './types';\r\nimport { useCustomerStore } from './store';\r\nimport { useCustomerSlaEngineStore } from './sla/store';\r\nimport type { SystemId } from '@/lib/id-types';\r\n\r\nexport type CustomerSortKey = 'name' | 'id' | 'createdAt' | 'status' | 'type';\r\n\r\nexport const DEFAULT_CUSTOMER_SORT: { id: CustomerSortKey; desc: boolean } = {\r\n  id: 'createdAt',\r\n  desc: true,\r\n};\r\n\r\nexport interface CustomerQueryParams {\r\n  search: string;\r\n  statusFilter: string;\r\n  typeFilter: string;\r\n  dateRange?: [string | undefined, string | undefined] | undefined;\r\n  showDeleted: boolean;\r\n  slaFilter: 'all' | 'followUp' | 'reengage' | 'debt' | 'health';\r\n  debtFilter: 'all' | 'totalOverdue' | 'overdue' | 'dueSoon' | 'hasDebt';\r\n  pagination: { pageIndex: number; pageSize: number };\r\n  sorting: { id: CustomerSortKey; desc: boolean };\r\n}\r\n\r\nexport interface CustomerQueryResult {\r\n  items: Customer[];\r\n  total: number;\r\n  pageCount: number;\r\n  pageIndex: number;\r\n}\r\n\r\ninterface PipelineResult {\r\n  filtered: Customer[];\r\n}\r\n\r\nconst fuseOptions: IFuseOptions<Customer> = {\r\n  keys: ['name', 'email', 'phone', 'company', 'taxCode', 'id'],\r\n  threshold: 0.3,\r\n};\r\n\r\nfunction applyFilters(customers: Customer[], params: CustomerQueryParams): PipelineResult {\r\n  const {\r\n    search,\r\n    statusFilter,\r\n    typeFilter,\r\n    dateRange,\r\n    showDeleted,\r\n    sorting,\r\n    slaFilter,\r\n    debtFilter,\r\n  } = params;\r\n\r\n  let dataset = customers.filter(customer =>\r\n    showDeleted ? !!customer.isDeleted : !customer.isDeleted\r\n  );\r\n\r\n  if (statusFilter !== 'all') {\r\n    dataset = dataset.filter(customer => customer.status === statusFilter);\r\n  }\r\n\r\n  if (typeFilter !== 'all') {\r\n    dataset = dataset.filter(customer => customer.type === typeFilter);\r\n  }\r\n\r\n  if (dateRange && (dateRange[0] || dateRange[1])) {\r\n    dataset = dataset.filter(customer => {\r\n      if (!customer.createdAt) return false;\r\n      const createdDate = new Date(customer.createdAt);\r\n      const fromDate = dateRange[0] ? new Date(dateRange[0]) : null;\r\n      const toDate = dateRange[1] ? new Date(dateRange[1]) : null;\r\n      if (fromDate && isDateBefore(createdDate, fromDate)) return false;\r\n      if (toDate && isDateAfter(createdDate, toDate)) return false;\r\n      return true;\r\n    });\r\n  }\r\n\r\n  // Apply SLA filter\r\n  if (slaFilter !== 'all') {\r\n    const slaIndex = useCustomerSlaEngineStore.getState().index;\r\n    if (slaIndex) {\r\n      const relevantSystemIds = new Set<SystemId>();\r\n      \r\n      if (slaFilter === 'followUp') {\r\n        slaIndex.followUpAlerts.forEach(alert => relevantSystemIds.add(alert.systemId));\r\n      } else if (slaFilter === 'reengage') {\r\n        slaIndex.reEngagementAlerts.forEach(alert => relevantSystemIds.add(alert.systemId));\r\n      } else if (slaFilter === 'debt') {\r\n        slaIndex.debtAlerts.forEach(alert => relevantSystemIds.add(alert.systemId));\r\n      } else if (slaFilter === 'health') {\r\n        slaIndex.healthAlerts.forEach(alert => relevantSystemIds.add(alert.systemId));\r\n      }\r\n      \r\n      dataset = dataset.filter(customer => relevantSystemIds.has(customer.systemId));\r\n    }\r\n  }\r\n\r\n  // Apply Debt filter\r\n  if (debtFilter !== 'all') {\r\n    if (debtFilter === 'totalOverdue' || debtFilter === 'overdue') {\r\n      // Filter customers with overdue debt\r\n      dataset = dataset.filter(customer => {\r\n        if (!customer.debtReminders || customer.debtReminders.length === 0) return false;\r\n        const now = new Date();\r\n        return customer.debtReminders.some(reminder => {\r\n          if (!reminder.dueDate) {\r\n            return false;\r\n          }\r\n          const dueDate = new Date(reminder.dueDate);\r\n          const amountDue = reminder.amountDue ?? 0;\r\n          return dueDate < now && amountDue > 0;\r\n        });\r\n      });\r\n    } else if (debtFilter === 'dueSoon') {\r\n      // Filter customers with debt due in 1-3 days\r\n      dataset = dataset.filter(customer => {\r\n        if (!customer.debtReminders || customer.debtReminders.length === 0) return false;\r\n        const now = new Date();\r\n        const threeDaysLater = new Date(now.getTime() + 3 * 24 * 60 * 60 * 1000);\r\n        return customer.debtReminders.some(reminder => {\r\n          if (!reminder.dueDate) {\r\n            return false;\r\n          }\r\n          const dueDate = new Date(reminder.dueDate);\r\n          const amountDue = reminder.amountDue ?? 0;\r\n          return dueDate >= now && dueDate <= threeDaysLater && amountDue > 0;\r\n        });\r\n      });\r\n    } else if (debtFilter === 'hasDebt') {\r\n      // Filter customers with any debt\r\n      dataset = dataset.filter(customer => (customer.currentDebt || 0) > 0);\r\n    }\r\n  }\r\n\r\n  if (search.trim()) {\r\n    const fuse = new Fuse(dataset, fuseOptions);\r\n    dataset = fuse.search(search.trim()).map(result => result.item);\r\n  }\r\n\r\n  const sorter = sorting.id;\r\n  dataset = [...dataset].sort((a, b) => {\r\n    const valueA = (a as any)[sorter] ?? '';\r\n    const valueB = (b as any)[sorter] ?? '';\r\n    if (valueA < valueB) return sorting.desc ? 1 : -1;\r\n    if (valueA > valueB) return sorting.desc ? -1 : 1;\r\n    return 0;\r\n  });\r\n\r\n  return { filtered: dataset };\r\n}\r\n\r\nexport async function fetchCustomersPage(params: CustomerQueryParams): Promise<CustomerQueryResult> {\r\n  const { data } = useCustomerStore.getState();\r\n  const { filtered } = applyFilters(data, params);\r\n\r\n  const { pageIndex, pageSize } = params.pagination;\r\n  const start = pageIndex * pageSize;\r\n  const end = start + pageSize;\r\n  const pagedItems = filtered.slice(start, end);\r\n\r\n  // Simulate async server latency\r\n  await new Promise(resolve => setTimeout(resolve, 120));\r\n\r\n  return {\r\n    items: pagedItems,\r\n    total: filtered.length,\r\n    pageCount: Math.max(1, Math.ceil(filtered.length / pageSize)),\r\n    pageIndex,\r\n  };\r\n}\r\n\r\nexport function getFilteredCustomersSnapshot(params: CustomerQueryParams): Customer[] {\r\n  const { data } = useCustomerStore.getState();\r\n  const { filtered } = applyFilters(data, params);\r\n  return filtered;\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 3299, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/customers/hooks/use-computed-debt.ts"],"sourcesContent":["/**\r\n * Hook to compute customer debt dynamically from orders and receipts/payments\r\n * ═══════════════════════════════════════════════════════════════\r\n * This replaces the static currentDebt field with real-time calculated debt\r\n * based on:\r\n * - Delivered orders (increases debt)\r\n * - Receipts with affectsDebt=true (decreases debt)\r\n * - Payments with affectsDebt=true (increases/decreases debt) - excluding sales return refunds\r\n * \r\n * NOTE: Sales returns and refund payments from sales returns do NOT affect debt.\r\n * They are cash transactions, not debt transactions.\r\n * \r\n * IMPORTANT: This uses the same logic as detail-page.tsx customerDebtTransactions\r\n * to ensure consistency across the app.\r\n * ═══════════════════════════════════════════════════════════════\r\n */\r\n\r\nimport { useMemo } from 'react';\r\nimport { useOrderStore } from '../../orders/store';\r\nimport { useReceiptStore } from '../../receipts/store';\r\nimport { usePaymentStore } from '../../payments/store';\r\nimport type { Customer, DebtTransaction } from '../types';\r\nimport type { Order } from '../../orders/types';\r\nimport type { Receipt } from '../../receipts/types';\r\nimport type { Payment } from '../../payments/types';\r\nimport type { SystemId, BusinessId } from '@/lib/id-types';\r\nimport { asSystemId } from '@/lib/id-types';\r\n\r\nexport type ComputedDebtInfo = {\r\n  currentDebt: number;\r\n  debtTransactions: DebtTransaction[];\r\n};\r\n\r\n/**\r\n * Compute debt transactions and current debt for a customer\r\n * Uses the same logic as detail-page.tsx for consistency\r\n */\r\nfunction computeCustomerDebtTransactions(\r\n  customer: Customer,\r\n  allOrders: Order[],\r\n  allReceipts: Receipt[],\r\n  allPayments: Payment[]\r\n): ComputedDebtInfo {\r\n  // Get orders that create debt for this customer\r\n  // Debt starts when: status='Hoàn thành' OR deliveryStatus='Đã giao hàng' OR stockOutStatus='Xuất kho toàn bộ'\r\n  const debtCreatingOrders = allOrders.filter(\r\n    o => o.customerSystemId === customer.systemId && \r\n         o.status !== 'Đã hủy' &&\r\n         (o.status === 'Hoàn thành' || \r\n          o.deliveryStatus === 'Đã giao hàng' || \r\n          o.stockOutStatus === 'Xuất kho toàn bộ')\r\n  );\r\n\r\n  // Build order transactions - use grandTotal (không trừ paidAmount)\r\n  // vì phiếu thu đã được tính riêng ở receiptTransactions\r\n  const orderTransactions = debtCreatingOrders\r\n    .map(order => {\r\n      // Calculate due date based on payment terms (default NET30)\r\n      const orderDate = new Date(order.orderDate);\r\n      const paymentTermDays = customer.paymentTerms === 'NET60' ? 60 : \r\n                               customer.paymentTerms === 'NET15' ? 15 : \r\n                               customer.paymentTerms === 'COD' ? 0 : 30;\r\n      const dueDate = new Date(orderDate);\r\n      dueDate.setDate(dueDate.getDate() + paymentTermDays);\r\n      \r\n      return {\r\n        systemId: asSystemId(`debt-order-${order.systemId}`),\r\n        orderId: order.id,\r\n        orderDate: order.orderDate,\r\n        amount: order.grandTotal || 0,\r\n        dueDate: dueDate.toISOString().split('T')[0],\r\n        isPaid: false,\r\n        remainingAmount: order.grandTotal || 0,\r\n        notes: `Đơn hàng #${order.id}`,\r\n        _createdAt: order.createdAt || order.orderDate,\r\n        _type: 'order' as const,\r\n        _change: order.grandTotal || 0,\r\n      };\r\n    });\r\n\r\n  // Get receipts affecting this customer's debt\r\n  const customerReceipts = allReceipts.filter(\r\n    r => r.status !== 'cancelled' && \r\n         r.affectsDebt === true && \r\n         (r.customerSystemId === customer.systemId || \r\n          r.payerSystemId === customer.systemId ||\r\n          (r.payerTypeName === 'Khách hàng' && r.payerName === customer.name))\r\n  );\r\n\r\n  const receiptTransactions = customerReceipts.map(receipt => ({\r\n    systemId: asSystemId(`debt-receipt-${receipt.systemId}`),\r\n    orderId: receipt.id,\r\n    orderDate: receipt.date,\r\n    amount: receipt.amount,\r\n    dueDate: receipt.date,\r\n    isPaid: true,\r\n    remainingAmount: 0,\r\n    notes: receipt.description || `Phiếu thu #${receipt.id}`,\r\n    _createdAt: receipt.createdAt || receipt.date,\r\n    _type: 'receipt' as const,\r\n    _change: -receipt.amount, // Receipts reduce debt\r\n  }));\r\n\r\n  // ✅ Phiếu chi - CHỈ TÍNH các phiếu chi KHÔNG phải hoàn tiền từ trả hàng\r\n  // Phiếu chi hoàn tiền từ trả hàng là giao dịch tiền mặt, không ảnh hưởng công nợ\r\n  // Phiếu trả hàng cũng KHÔNG ảnh hưởng công nợ\r\n  const customerPayments = allPayments.filter(\r\n    p => p.status !== 'cancelled' && \r\n         p.affectsDebt === true && \r\n         !p.linkedSalesReturnSystemId && // Loại bỏ phiếu chi từ trả hàng\r\n         (p.customerSystemId === customer.systemId || \r\n          p.recipientSystemId === customer.systemId ||\r\n          (p.recipientTypeName === 'Khách hàng' && p.recipientName === customer.name))\r\n  );\r\n\r\n  const paymentTransactions = customerPayments.map(payment => {\r\n    // Phiếu chi cho khách (không phải trả hàng) → giảm công nợ\r\n    const isRefundToCustomer = payment.paymentReceiptTypeName === 'Hoàn tiền khách hàng' || \r\n                               payment.category === 'complaint_refund';\r\n    const changeAmount = isRefundToCustomer ? -payment.amount : payment.amount;\r\n    \r\n    return {\r\n      systemId: asSystemId(`debt-payment-${payment.systemId}`),\r\n      orderId: payment.id,\r\n      orderDate: payment.date,\r\n      amount: payment.amount,\r\n      dueDate: payment.date,\r\n      isPaid: false,\r\n      remainingAmount: payment.amount,\r\n      notes: payment.description || `Phiếu chi #${payment.id}`,\r\n      _createdAt: payment.createdAt || payment.date,\r\n      _type: 'payment' as const,\r\n      _change: changeAmount,\r\n    };\r\n  });\r\n\r\n  // ✅ Công nợ = Đơn hàng - Phiếu thu - Phiếu chi (không phải trả hàng)\r\n  // Phiếu trả hàng và phiếu chi hoàn tiền từ trả hàng KHÔNG ảnh hưởng công nợ\r\n  const allTransactions = [...orderTransactions, ...receiptTransactions, ...paymentTransactions];\r\n  allTransactions.sort((a, b) => new Date(a._createdAt).getTime() - new Date(b._createdAt).getTime());\r\n\r\n  // Calculate running balance\r\n  let runningDebt = 0;\r\n  const transactionsWithBalance = allTransactions.map(t => {\r\n    runningDebt += t._change;\r\n    return t;\r\n  });\r\n\r\n  // Get current debt (final balance)\r\n  const currentDebt = Math.max(0, runningDebt);\r\n\r\n  // Convert to DebtTransaction format (only unpaid order transactions)\r\n  const debtTransactions: DebtTransaction[] = orderTransactions.map(t => ({\r\n    systemId: t.systemId,\r\n    orderId: t.orderId,\r\n    orderDate: t.orderDate,\r\n    amount: t.amount,\r\n    dueDate: t.dueDate,\r\n    isPaid: currentDebt === 0, // Mark as paid if no outstanding debt\r\n    remainingAmount: currentDebt === 0 ? 0 : t.remainingAmount,\r\n    notes: t.notes,\r\n  }));\r\n\r\n  return {\r\n    currentDebt,\r\n    debtTransactions,\r\n  };\r\n}\r\n\r\n/**\r\n * Hook to get computed debt for a single customer\r\n */\r\nexport function useComputedCustomerDebt(customer: Customer | null | undefined): ComputedDebtInfo | null {\r\n  const { data: allOrders } = useOrderStore();\r\n  const { data: allReceipts } = useReceiptStore();\r\n  const { data: allPayments } = usePaymentStore();\r\n\r\n  return useMemo(() => {\r\n    if (!customer) return null;\r\n    return computeCustomerDebtTransactions(customer, allOrders, allReceipts, allPayments);\r\n  }, [customer, allOrders, allReceipts, allPayments]);\r\n}\r\n\r\n/**\r\n * Hook to get computed debt for all customers as a map\r\n * Returns a Map of customerSystemId -> ComputedDebtInfo\r\n */\r\nexport function useAllCustomersComputedDebt(customers: Customer[]): Map<SystemId, ComputedDebtInfo> {\r\n  const { data: allOrders } = useOrderStore();\r\n  const { data: allReceipts } = useReceiptStore();\r\n  const { data: allPayments } = usePaymentStore();\r\n\r\n  return useMemo(() => {\r\n    const debtMap = new Map<SystemId, ComputedDebtInfo>();\r\n    \r\n    for (const customer of customers) {\r\n      const debtInfo = computeCustomerDebtTransactions(customer, allOrders, allReceipts, allPayments);\r\n      debtMap.set(customer.systemId, debtInfo);\r\n    }\r\n    \r\n    return debtMap;\r\n  }, [customers, allOrders, allReceipts, allPayments]);\r\n}\r\n\r\n/**\r\n * Hook to get customers with computed debt appended\r\n * Returns customers array with currentDebt AND debtTransactions replaced by computed values\r\n */\r\nexport function useCustomersWithComputedDebt(customers: Customer[]): Customer[] {\r\n  const { data: allOrders } = useOrderStore();\r\n  const { data: allReceipts } = useReceiptStore();\r\n  const { data: allPayments } = usePaymentStore();\r\n\r\n  return useMemo(() => {\r\n    return customers.map(customer => {\r\n      const debtInfo = computeCustomerDebtTransactions(customer, allOrders, allReceipts, allPayments);\r\n      return {\r\n        ...customer,\r\n        currentDebt: debtInfo.currentDebt, // Override static currentDebt\r\n        debtTransactions: debtInfo.debtTransactions, // Override static debtTransactions\r\n      };\r\n    });\r\n  }, [customers, allOrders, allReceipts, allPayments]);\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 3487, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/customers/sla/hooks.ts"],"sourcesContent":["import * as React from 'react';\r\nimport { useCustomerStore } from '../store';\r\nimport { useCustomerSlaEngineStore } from './store';\r\nimport { useCustomerSlaStore as useCustomerSlaSettingStore } from '../../settings/customers/sla-settings-store';\r\nimport { useCustomersWithComputedDebt } from '../hooks/use-computed-debt';\r\n\r\nexport function useCustomerSlaEvaluation() {\r\n  const customers = useCustomerStore((state) => state.data);\r\n  const slaSettings = useCustomerSlaSettingStore((state) => state.data);\r\n  const evaluate = useCustomerSlaEngineStore((state) => state.evaluate);\r\n  const storeState = useCustomerSlaEngineStore();\r\n\r\n  // Use computed debt from orders/receipts instead of static currentDebt field\r\n  const customersWithDebt = useCustomersWithComputedDebt(customers);\r\n\r\n  React.useEffect(() => {\r\n    if (!customersWithDebt.length || !slaSettings.length) return;\r\n    evaluate(customersWithDebt, slaSettings);\r\n  }, [customersWithDebt, slaSettings, evaluate]);\r\n\r\n  return storeState;\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;AACA;AACA;;;;;;AAEO,SAAS;IACd,MAAM,YAAY,IAAA,kJAAgB,EAAC,CAAC,QAAU,MAAM,IAAI;IACxD,MAAM,cAAc,IAAA,oLAA0B,EAAC,CAAC,QAAU,MAAM,IAAI;IACpE,MAAM,WAAW,IAAA,kKAAyB,EAAC,CAAC,QAAU,MAAM,QAAQ;IACpE,MAAM,aAAa,IAAA,kKAAyB;IAE5C,6EAA6E;IAC7E,MAAM,oBAAoB,IAAA,yLAA4B,EAAC;IAEvD,kNAAe,CAAC;QACd,IAAI,CAAC,kBAAkB,MAAM,IAAI,CAAC,YAAY,MAAM,EAAE;QACtD,SAAS,mBAAmB;IAC9B,GAAG;QAAC;QAAmB;QAAa;KAAS;IAE7C,OAAO;AACT"}},
    {"offset": {"line": 3522, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/customers/hooks/use-customers-query.ts"],"sourcesContent":["import { useQuery, type UseQueryResult } from '@tanstack/react-query';\r\nimport { fetchCustomersPage, type CustomerQueryParams, type CustomerQueryResult } from '../customer-service';\r\nimport { useCustomerStore } from '../store';\r\nimport { useCustomerSlaEngineStore } from '../sla/store';\r\n\r\nexport function useCustomersQuery(params: CustomerQueryParams): UseQueryResult<CustomerQueryResult, Error> {\r\n  // Subscribe to store data changes to trigger re-fetch\r\n  const storeData = useCustomerStore((state) => state.data);\r\n  const slaLastEvaluated = useCustomerSlaEngineStore((state) => state.lastEvaluatedAt);\r\n  \r\n  return useQuery<CustomerQueryResult, Error>({\r\n    queryKey: ['customers', params, storeData.length, storeData.filter(c => c.isDeleted).length, slaLastEvaluated],\r\n    queryFn: () => fetchCustomersPage(params),\r\n    staleTime: 30_000,\r\n  });\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;AACA;;;;;AAEO,SAAS,kBAAkB,MAA2B;IAC3D,sDAAsD;IACtD,MAAM,YAAY,IAAA,kJAAgB,EAAC,CAAC,QAAU,MAAM,IAAI;IACxD,MAAM,mBAAmB,IAAA,kKAAyB,EAAC,CAAC,QAAU,MAAM,eAAe;IAEnF,OAAO,IAAA,uLAAQ,EAA6B;QAC1C,UAAU;YAAC;YAAa;YAAQ,UAAU,MAAM;YAAE,UAAU,MAAM,CAAC,CAAA,IAAK,EAAE,SAAS,EAAE,MAAM;YAAE;SAAiB;QAC9G,SAAS,IAAM,IAAA,kKAAkB,EAAC;QAClC,WAAW;IACb;AACF"}},
    {"offset": {"line": 3554, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/customers/page.tsx"],"sourcesContent":["'use client'\r\n\r\nimport * as React from \"react\";\r\nimport { useRouter } from 'next/navigation';\r\nimport Link from 'next/link';\r\nimport { useColumnVisibility } from '@/hooks/use-column-visibility';\r\nimport { PlusCircle, Trash2, MoreVertical, Phone, Mail, Building2, Clock, UserX, CreditCard, HeartPulse, X, FileSpreadsheet, Download } from \"lucide-react\";\r\nimport { useShallow } from \"zustand/react/shallow\";\r\nimport { toast } from \"sonner\";\r\nimport Fuse from 'fuse.js';\r\n\r\nimport { useAllCustomers } from \"./hooks/use-all-customers\";\r\nimport { useCustomerMutations } from \"./hooks/use-customers\";\r\nimport { useAllCustomerTypes } from \"../settings/customers/hooks/use-all-customer-settings\";\r\nimport { useAllBranches } from \"../settings/branches/hooks/use-all-branches\";\r\nimport { type Customer } from \"./types\";\r\nimport { getColumns } from \"./columns\";\r\nimport { BulkActionConfirmDialog } from \"./components/bulk-action-confirm-dialog\";\r\nimport { DEFAULT_CUSTOMER_SORT, type CustomerQueryParams, type CustomerSortKey } from \"./customer-service\";\r\nimport { useState } from \"react\";\r\nimport { asSystemId, asBusinessId, type SystemId } from \"../../lib/id-types\";\r\nimport { usePageHeader } from \"../../contexts/page-header-context\";\r\nimport { useMediaQuery } from \"../../lib/use-media-query\";\r\nimport { useDebounce } from \"../../hooks/use-debounce\";\r\nimport { isDateAfter, isDateBefore } from \"../../lib/date-utils\";\r\nimport {\r\n  customerImportExportConfig,\r\n} from \"../../lib/import-export/configs/customer.config\";\r\n\r\nimport { ResponsiveDataTable } from \"../../components/data-table/responsive-data-table\";\r\nimport { GenericImportDialogV2 } from \"../../components/shared/generic-import-dialog-v2\";\r\nimport { GenericExportDialogV2 } from \"../../components/shared/generic-export-dialog-v2\";\r\nimport { DataTableColumnCustomizer } from \"../../components/data-table/data-table-column-toggle\";\r\nimport { DataTableDateFilter } from \"../../components/data-table/data-table-date-filter\";\r\nimport { PageFilters } from \"../../components/layout/page-filters\";\r\nimport { MobileSearchBar } from \"../../components/mobile/mobile-search-bar\";\r\nimport { TouchButton } from \"../../components/mobile/touch-button\";\r\nimport { useCustomerSlaEvaluation } from \"./sla/hooks\";\r\nimport { useCustomersQuery } from \"./hooks/use-customers-query\";\r\nimport { useCustomersWithComputedDebt } from \"./hooks/use-computed-debt\";\r\n\r\nimport {\r\n  Card,\r\n  CardContent,\r\n} from \"../../components/ui/card\";\r\nimport {\r\n  AlertDialog,\r\n  AlertDialogAction,\r\n  AlertDialogCancel,\r\n  AlertDialogContent,\r\n  AlertDialogDescription,\r\n  AlertDialogFooter,\r\n  AlertDialogHeader,\r\n  AlertDialogTitle,\r\n} from \"../../components/ui/alert-dialog\";\r\nimport { Button } from \"../../components/ui/button\";\r\nimport { Badge } from \"../../components/ui/badge\";\r\nimport { Avatar, AvatarFallback, AvatarImage } from \"../../components/ui/avatar\";\r\nimport {\r\n  DropdownMenu,\r\n  DropdownMenuContent,\r\n  DropdownMenuItem,\r\n  DropdownMenuTrigger,\r\n} from \"../../components/ui/dropdown-menu\";\r\nimport {\r\n  Select,\r\n  SelectContent,\r\n  SelectItem,\r\n  SelectTrigger,\r\n  SelectValue,\r\n} from \"../../components/ui/select\";\r\n\r\nconst TABLE_STATE_STORAGE_KEY = \"customers-table-state\";\r\nconst MOBILE_ROW_HEIGHT = 190;\r\nconst MOBILE_LIST_HEIGHT = 520;\r\n\r\ntype PendingBulkAction =\r\n  | { kind: \"delete\"; customers: Customer[] }\r\n  | { kind: \"restore\"; customers: Customer[] }\r\n  | { kind: \"status\"; status: Customer[\"status\"]; customers: Customer[] }\r\n  | null;\r\n\r\nconst defaultTableState: CustomerQueryParams = {\r\n  search: \"\",\r\n  statusFilter: \"all\",\r\n  typeFilter: \"all\",\r\n  dateRange: undefined,\r\n  showDeleted: false,\r\n  slaFilter: \"all\",\r\n  debtFilter: \"all\",\r\n  pagination: { pageIndex: 0, pageSize: 10 },\r\n  sorting: DEFAULT_CUSTOMER_SORT,\r\n};\r\n\r\nfunction resolveStateAction<T>(current: T, action: React.SetStateAction<T>): T {\r\n  return typeof action === \"function\" ? (action as (prev: T) => T)(current) : action;\r\n}\r\n\r\nexport function CustomersPage() {\r\n  const { data: customers } = useAllCustomers();\r\n  const { remove, update, create } = useCustomerMutations();\r\n  const { data: customerTypesData } = useAllCustomerTypes();\r\n  const customerTypes = { data: customerTypesData };\r\n  const { data: branches } = useAllBranches();\r\n  const router = useRouter();\r\n  const isMobile = useMediaQuery(\"(max-width: 768px)\");\r\n\r\n  // Use computed debt from orders/receipts instead of static currentDebt field\r\n  const customersWithDebt = useCustomersWithComputedDebt(customers);\r\n\r\n  const deletedCount = React.useMemo(\r\n    () => customers.filter((customer) => customer.isDeleted).length,\r\n    [customers]\r\n  );\r\n\r\n  const headerActions = React.useMemo(\r\n    () => [\r\n      <Button key=\"trash\" variant=\"outline\" size=\"sm\" className=\"h-9\" asChild>\r\n        <Link href=\"/customers/trash\">\r\n          <Trash2 className=\"mr-2 h-4 w-4\" />\r\n          Thùng rác ({deletedCount})\r\n        </Link>\r\n      </Button>,\r\n      <Button key=\"add\" size=\"sm\" className=\"h-9\" asChild>\r\n        <Link href=\"/customers/new\">\r\n          <PlusCircle className=\"mr-2 h-4 w-4\" />\r\n          Thêm khách hàng\r\n        </Link>\r\n      </Button>,\r\n    ],\r\n    [deletedCount]\r\n  );\r\n\r\n  usePageHeader({\r\n    title: 'Danh sách khách hàng',\r\n    breadcrumb: [\r\n      { label: 'Trang chủ', href: '/', isCurrent: false },\r\n      { label: 'Khách hàng', href: '/customers', isCurrent: true },\r\n    ],\r\n    showBackButton: false,\r\n    actions: headerActions,\r\n  });\r\n\r\n  const [rowSelection, setRowSelection] = React.useState<Record<string, boolean>>({});\r\n  const [isAlertOpen, setIsAlertOpen] = React.useState(false);\r\n  const [idToDelete, setIdToDelete] = React.useState<string | null>(null);\r\n  const [expanded, setExpanded] = React.useState<Record<string, boolean>>({});\r\n  const [pendingAction, setPendingAction] = React.useState<PendingBulkAction>(null);\r\n  const [showImportDialog, setShowImportDialog] = React.useState(false);\r\n  const [showExportDialog, setShowExportDialog] = React.useState(false);\r\n  const [columnVisibility, setColumnVisibility] = useColumnVisibility('customers', {});\r\n  const [columnOrder, setColumnOrder] = React.useState<string[]>([]);\r\n  const [pinnedColumns, setPinnedColumns] = React.useState<string[]>([]);\r\n  const [tableState, setTableState] = useState<CustomerQueryParams>(defaultTableState);\r\n\r\n  const queryParams = React.useMemo<CustomerQueryParams>(() => ({\r\n    ...tableState,\r\n    showDeleted: false,\r\n  }), [tableState]);\r\n\r\n  useCustomersQuery(queryParams);\r\n\r\n  React.useEffect(() => {\r\n    if (tableState.showDeleted) {\r\n      setTableState((prev) => ({ ...prev, showDeleted: false }));\r\n    }\r\n  }, [tableState.showDeleted, setTableState]);\r\n\r\n  const handleDelete = React.useCallback((systemId: string) => {\r\n    setIdToDelete(systemId);\r\n    setIsAlertOpen(true);\r\n  }, []);\r\n\r\n  const handleRestore = React.useCallback(\r\n    (systemId: string) => {\r\n      const customer = customers.find(c => c.systemId === systemId);\r\n      if (customer) {\r\n        update.mutate(\r\n          { systemId: asSystemId(systemId), ...customer, isDeleted: false },\r\n          { onSuccess: () => toast.success(\"Đã khôi phục khách hàng\") }\r\n        );\r\n      }\r\n    },\r\n    [customers, update]\r\n  );\r\n\r\n  const slaEngine = useCustomerSlaEvaluation();\r\n  const slaIndex = slaEngine.index;\r\n  const slaSummary = slaEngine.summary;\r\n  const columns = React.useMemo(\r\n    () => getColumns(handleDelete, handleRestore, router, { slaIndex }),\r\n    [handleDelete, handleRestore, router, slaIndex]\r\n  );\r\n\r\n  React.useEffect(() => {\r\n    if (columnOrder.length) {\r\n      return;\r\n    }\r\n    const defaultVisibleColumns = [\"id\", \"name\", \"email\", \"phone\", \"shippingAddress\", \"status\", \"slaStatus\", \"accountManagerName\"];\r\n    const initialVisibility: Record<string, boolean> = {};\r\n    columns.forEach((column) => {\r\n      if (!column.id) return;\r\n      const alwaysVisible = column.id === \"select\" || column.id === \"actions\";\r\n      initialVisibility[column.id] = alwaysVisible || defaultVisibleColumns.includes(column.id);\r\n    });\r\n    // Only set defaults if visibility is empty\r\n    if (Object.keys(columnVisibility).length === 0) {\r\n      setColumnVisibility(initialVisibility);\r\n    }\r\n    setColumnOrder(columns.map((column) => column.id).filter(Boolean) as string[]);\r\n  }, [columns, columnOrder.length, columnVisibility, setColumnVisibility]);\r\n\r\n  const updateTableState = React.useCallback(\r\n    (updater: (prev: CustomerQueryParams) => CustomerQueryParams) => {\r\n      setTableState((prev) => updater(prev));\r\n    },\r\n    [setTableState]\r\n  );\r\n\r\n  const handleSearchChange = React.useCallback(\r\n    (value: string) => {\r\n      updateTableState((prev) => ({\r\n        ...prev,\r\n        search: value,\r\n        pagination: { ...prev.pagination, pageIndex: 0 },\r\n      }));\r\n    },\r\n    [updateTableState]\r\n  );\r\n\r\n  const handleStatusFilterChange = React.useCallback(\r\n    (value: string) => {\r\n      updateTableState((prev) => ({\r\n        ...prev,\r\n        statusFilter: value,\r\n        pagination: { ...prev.pagination, pageIndex: 0 },\r\n      }));\r\n    },\r\n    [updateTableState]\r\n  );\r\n\r\n  const handleTypeFilterChange = React.useCallback(\r\n    (value: string) => {\r\n      updateTableState((prev) => ({\r\n        ...prev,\r\n        typeFilter: value,\r\n        pagination: { ...prev.pagination, pageIndex: 0 },\r\n      }));\r\n    },\r\n    [updateTableState]\r\n  );\r\n\r\n  const handleDateRangeChange = React.useCallback(\r\n    (value: [string | undefined, string | undefined] | undefined) => {\r\n      updateTableState((prev) => ({\r\n        ...prev,\r\n        dateRange: value,\r\n        pagination: { ...prev.pagination, pageIndex: 0 },\r\n      }));\r\n    },\r\n    [updateTableState]\r\n  );\r\n\r\n  const handlePaginationChange = React.useCallback(\r\n    (action: React.SetStateAction<{ pageIndex: number; pageSize: number }>) => {\r\n      updateTableState((prev) => ({\r\n        ...prev,\r\n        pagination: resolveStateAction(prev.pagination, action),\r\n      }));\r\n    },\r\n    [updateTableState]\r\n  );\r\n\r\n  const handleSortingChange = React.useCallback(\r\n    (action: React.SetStateAction<{ id: string; desc: boolean }>) => {\r\n      updateTableState((prev) => {\r\n        const nextSortingSource =\r\n          typeof action === \"function\"\r\n            ? (action as (value: { id: string; desc: boolean }) => { id: string; desc: boolean })({\r\n                ...prev.sorting,\r\n              })\r\n            : action;\r\n\r\n        return {\r\n          ...prev,\r\n          sorting: {\r\n            id: (nextSortingSource.id as CustomerQueryParams[\"sorting\"][\"id\"]) ?? prev.sorting.id,\r\n            desc: nextSortingSource.desc,\r\n          },\r\n        };\r\n      });\r\n    },\r\n    [updateTableState]\r\n  );\r\n\r\n  // Debounce search for performance\r\n  const debouncedSearch = useDebounce(tableState.search, 300);\r\n\r\n  // Fuse instance for search - use customersWithDebt to include computed debt\r\n  const fuseInstance = React.useMemo(() => {\r\n    return new Fuse(customersWithDebt, {\r\n      keys: ['name', 'email', 'phone', 'company', 'taxCode', 'id'],\r\n      threshold: 0.3,\r\n      ignoreLocation: true,\r\n    });\r\n  }, [customersWithDebt]);\r\n\r\n  // Filter data using useMemo - reactive to store changes\r\n  // Use customersWithDebt instead of static customers data\r\n  const filteredData = React.useMemo(() => {\r\n    // Start with non-deleted customers\r\n    let dataset = customersWithDebt.filter(customer => !customer.isDeleted);\r\n\r\n    // Apply status filter\r\n    if (tableState.statusFilter !== 'all') {\r\n      dataset = dataset.filter(customer => customer.status === tableState.statusFilter);\r\n    }\r\n\r\n    // Apply type filter\r\n    if (tableState.typeFilter !== 'all') {\r\n      dataset = dataset.filter(customer => customer.type === tableState.typeFilter);\r\n    }\r\n\r\n    // Apply date range filter\r\n    if (tableState.dateRange && (tableState.dateRange[0] || tableState.dateRange[1])) {\r\n      dataset = dataset.filter(customer => {\r\n        if (!customer.createdAt) return false;\r\n        const createdDate = new Date(customer.createdAt);\r\n        const fromDate = tableState.dateRange![0] ? new Date(tableState.dateRange![0]) : null;\r\n        const toDate = tableState.dateRange![1] ? new Date(tableState.dateRange![1]) : null;\r\n        if (fromDate && isDateBefore(createdDate, fromDate)) return false;\r\n        if (toDate && isDateAfter(createdDate, toDate)) return false;\r\n        return true;\r\n      });\r\n    }\r\n\r\n    // Apply SLA filter\r\n    if (tableState.slaFilter !== 'all') {\r\n      const relevantSystemIds = new Set<string>();\r\n      \r\n      if (tableState.slaFilter === 'followUp') {\r\n        slaEngine.index?.followUpAlerts.forEach(alert => relevantSystemIds.add(alert.systemId));\r\n      } else if (tableState.slaFilter === 'reengage') {\r\n        slaEngine.index?.reEngagementAlerts.forEach(alert => relevantSystemIds.add(alert.systemId));\r\n      } else if (tableState.slaFilter === 'debt') {\r\n        slaEngine.index?.debtAlerts.forEach(alert => relevantSystemIds.add(alert.systemId));\r\n      } else if (tableState.slaFilter === 'health') {\r\n        slaEngine.index?.healthAlerts.forEach(alert => relevantSystemIds.add(alert.systemId));\r\n      }\r\n      \r\n      dataset = dataset.filter(customer => relevantSystemIds.has(customer.systemId));\r\n    }\r\n\r\n    // Apply Debt filter\r\n    if (tableState.debtFilter !== 'all') {\r\n      if (tableState.debtFilter === 'totalOverdue' || tableState.debtFilter === 'overdue') {\r\n        dataset = dataset.filter(customer => {\r\n          if (!customer.debtReminders || customer.debtReminders.length === 0) return false;\r\n          const now = new Date();\r\n          return customer.debtReminders.some(reminder => {\r\n            if (!reminder.dueDate) {\r\n              return false;\r\n            }\r\n            const dueDate = new Date(reminder.dueDate);\r\n            const amountDue = reminder.amountDue ?? 0;\r\n            return dueDate < now && amountDue > 0;\r\n          });\r\n        });\r\n      } else if (tableState.debtFilter === 'dueSoon') {\r\n        dataset = dataset.filter(customer => {\r\n          if (!customer.debtReminders || customer.debtReminders.length === 0) return false;\r\n          const now = new Date();\r\n          const threeDaysLater = new Date(now.getTime() + 3 * 24 * 60 * 60 * 1000);\r\n          return customer.debtReminders.some(reminder => {\r\n            if (!reminder.dueDate) {\r\n              return false;\r\n            }\r\n            const dueDate = new Date(reminder.dueDate);\r\n            const amountDue = reminder.amountDue ?? 0;\r\n            return dueDate >= now && dueDate <= threeDaysLater && amountDue > 0;\r\n          });\r\n        });\r\n      } else if (tableState.debtFilter === 'hasDebt') {\r\n        dataset = dataset.filter(customer => (customer.currentDebt || 0) > 0);\r\n      }\r\n    }\r\n\r\n    // Apply search filter\r\n    if (debouncedSearch.trim()) {\r\n      fuseInstance.setCollection(dataset);\r\n      dataset = fuseInstance.search(debouncedSearch.trim()).map(result => result.item);\r\n    }\r\n\r\n    return dataset;\r\n  }, [customersWithDebt, tableState.statusFilter, tableState.typeFilter, tableState.dateRange, tableState.slaFilter, tableState.debtFilter, debouncedSearch, fuseInstance, slaEngine.index]);\r\n\r\n  // Sort data\r\n  const sortedData = React.useMemo(() => {\r\n    const sorted = [...filteredData];\r\n    const sortKey = tableState.sorting.id;\r\n    \r\n    sorted.sort((a, b) => {\r\n      const aValue = (a as any)[sortKey] ?? '';\r\n      const bValue = (b as any)[sortKey] ?? '';\r\n      // Special handling for date columns\r\n      if (sortKey === 'createdAt') {\r\n        const aTime = aValue ? new Date(aValue).getTime() : 0;\r\n        const bTime = bValue ? new Date(bValue).getTime() : 0;\r\n        // Nếu thời gian bằng nhau, sort theo systemId (ID mới hơn = số lớn hơn)\r\n        if (aTime === bTime) {\r\n          const aNum = parseInt(a.systemId.replace(/\\D/g, '')) || 0;\r\n          const bNum = parseInt(b.systemId.replace(/\\D/g, '')) || 0;\r\n          return tableState.sorting.desc ? bNum - aNum : aNum - bNum;\r\n        }\r\n        return tableState.sorting.desc ? bTime - aTime : aTime - bTime;\r\n      }\r\n      if (aValue < bValue) return tableState.sorting.desc ? 1 : -1;\r\n      if (aValue > bValue) return tableState.sorting.desc ? -1 : 1;\r\n      return 0;\r\n    });\r\n    \r\n    return sorted;\r\n  }, [filteredData, tableState.sorting]);\r\n\r\n  // Pagination\r\n  const totalRows = sortedData.length;\r\n  const pageCount = Math.max(1, Math.ceil(totalRows / tableState.pagination.pageSize));\r\n  \r\n  const pageData = React.useMemo(() => {\r\n    const start = tableState.pagination.pageIndex * tableState.pagination.pageSize;\r\n    const end = start + tableState.pagination.pageSize;\r\n    return sortedData.slice(start, end);\r\n  }, [sortedData, tableState.pagination]);\r\n\r\n  const selectedCustomers = React.useMemo(\r\n    () => customers.filter((customer) => rowSelection[customer.systemId]),\r\n    [customers, rowSelection]\r\n  );\r\n\r\n  const confirmDelete = React.useCallback(() => {\r\n    if (idToDelete) {\r\n      remove.mutate(asSystemId(idToDelete), {\r\n        onSuccess: () => toast.success(\"Đã chuyển khách hàng vào thùng rác\")\r\n      });\r\n    }\r\n    setIsAlertOpen(false);\r\n    setIdToDelete(null);\r\n  }, [idToDelete, remove]);\r\n\r\n  const handleRowClick = React.useCallback(\r\n    (customer: Customer) => {\r\n      router.push(`/customers/${customer.systemId}`);\r\n    },\r\n    [router]\r\n  );\r\n\r\n  // Active customers (non-deleted) for import/export operations\r\n  const activeCustomers = React.useMemo(\r\n    () => customers.filter(c => !c.isDeleted),\r\n    [customers]\r\n  );\r\n\r\n  // ===== IMPORT/EXPORT V2 =====\r\n  // V2 Import handler with upsert support (like employees)\r\n  const handleImportV2 = React.useCallback(async (\r\n    data: Partial<Customer>[],\r\n    mode: 'insert-only' | 'update-only' | 'upsert',\r\n    _branchId?: string\r\n  ) => {\r\n    let inserted = 0;\r\n    let updated = 0;\r\n    let skipped = 0;\r\n    let failed = 0;\r\n    const errors: Array<{ row: number; message: string }> = [];\r\n\r\n    for (let i = 0; i < data.length; i++) {\r\n      const item = data[i];\r\n      try {\r\n        // Find existing by business ID (id field like KH000001)\r\n        const existingCustomer = item.id \r\n          ? activeCustomers.find(c => c.id === item.id)\r\n          : null;\r\n\r\n        if (existingCustomer) {\r\n          if (mode === 'insert-only') {\r\n            skipped++;\r\n            continue;\r\n          }\r\n          // Update existing\r\n          update.mutate({ systemId: existingCustomer.systemId, ...existingCustomer, ...item });\r\n          updated++;\r\n        } else {\r\n          if (mode === 'update-only') {\r\n            errors.push({ row: i + 2, message: `Không tìm thấy khách hàng với mã ${item.id}` });\r\n            failed++;\r\n            continue;\r\n          }\r\n          // Insert new - remove systemId if present\r\n          const { systemId, ...newData } = item as any;\r\n          const dataWithEmptyId = {\r\n            ...newData,\r\n            id: asBusinessId(\"\"),\r\n            status: newData.status || \"Đang giao dịch\",\r\n          } as Omit<Customer, \"systemId\">;\r\n          create.mutate(dataWithEmptyId);\r\n          inserted++;\r\n        }\r\n      } catch (error) {\r\n        errors.push({ row: i + 2, message: String(error) });\r\n        failed++;\r\n      }\r\n    }\r\n\r\n    return {\r\n      success: inserted + updated,\r\n      failed,\r\n      inserted,\r\n      updated,\r\n      skipped,\r\n      errors,\r\n    };\r\n  }, [activeCustomers, create, update]);\r\n\r\n  // Current user for logging (mock - replace with actual auth)\r\n  const currentUser = React.useMemo(() => ({\r\n    name: 'Admin',\r\n    systemId: 'USR000001' as SystemId,\r\n  }), []);\r\n\r\n  const bulkActions = React.useMemo(() => {\r\n    // Main list only shows non-deleted customers\r\n    return [\r\n      {\r\n        label: \"Chuyển vào thùng rác\",\r\n        onSelect: (rows: Customer[]) => setPendingAction({ kind: \"delete\", customers: rows }),\r\n      },\r\n      {\r\n        label: \"Đang giao dịch\",\r\n        onSelect: (rows: Customer[]) => setPendingAction({ kind: \"status\", status: \"Đang giao dịch\", customers: rows }),\r\n      },\r\n      {\r\n        label: \"Ngừng giao dịch\",\r\n        onSelect: (rows: Customer[]) => setPendingAction({ kind: \"status\", status: \"Ngừng Giao Dịch\", customers: rows }),\r\n      },\r\n    ];\r\n  }, []);\r\n\r\n  const bulkDialogCopy = React.useMemo(() => {\r\n    if (!pendingAction) return null;\r\n    switch (pendingAction.kind) {\r\n      case \"delete\":\r\n        return {\r\n          title: \"Chuyển vào thùng rác\",\r\n          description: `Xác nhận chuyển ${pendingAction.customers.length} khách hàng vào thùng rác?`,\r\n          confirmLabel: \"Chuyển vào thùng rác\",\r\n        };\r\n      case \"restore\":\r\n        return {\r\n          title: \"Khôi phục khách hàng\",\r\n          description: `Khôi phục ${pendingAction.customers.length} khách hàng đã chọn?`,\r\n          confirmLabel: \"Khôi phục\",\r\n        };\r\n      case \"status\":\r\n        return {\r\n          title: \"Cập nhật trạng thái\",\r\n          description: `Xác nhận cập nhật ${pendingAction.customers.length} khách hàng sang trạng thái \"${pendingAction.status}\"?`,\r\n          confirmLabel: \"Cập nhật\",\r\n        };\r\n      default:\r\n        return null;\r\n    }\r\n  }, [pendingAction]);\r\n\r\n  const handleConfirmBulkAction = React.useCallback(() => {\r\n    if (!pendingAction) return;\r\n    const systemIds = pendingAction.customers.map((customer) => asSystemId(customer.systemId));\r\n    if (pendingAction.kind === \"delete\") {\r\n      systemIds.forEach(systemId => remove.mutate(systemId));\r\n      toast.success(`Đã chuyển ${pendingAction.customers.length} khách hàng vào thùng rác`);\r\n    } else if (pendingAction.kind === \"restore\") {\r\n      pendingAction.customers.forEach(customer => {\r\n        update.mutate({ systemId: customer.systemId, ...customer, isDeleted: false });\r\n      });\r\n      toast.success(`Đã khôi phục ${pendingAction.customers.length} khách hàng`);\r\n    } else if (pendingAction.kind === \"status\") {\r\n      pendingAction.customers.forEach(customer => {\r\n        update.mutate({ systemId: customer.systemId, ...customer, status: pendingAction.status });\r\n      });\r\n      toast.success(`Đã cập nhật trạng thái cho ${pendingAction.customers.length} khách hàng`);\r\n    }\r\n    setRowSelection((prev) => {\r\n      const next = { ...prev };\r\n      pendingAction.customers.forEach((customer) => {\r\n        delete next[customer.systemId];\r\n      });\r\n      return next;\r\n    });\r\n    setPendingAction(null);\r\n  }, [pendingAction, remove, update]);\r\n\r\n  const getStatusVariant = (status: string) => {\r\n    switch (status) {\r\n      case \"Đang giao dịch\":\r\n        return \"default\";\r\n      case \"Ngừng giao dịch\":\r\n      case \"Ngừng Giao Dịch\":\r\n        return \"secondary\";\r\n      case \"Nợ xấu\":\r\n        return \"destructive\";\r\n      default:\r\n        return \"default\";\r\n    }\r\n  };\r\n\r\n  const MobileCustomerCard = ({ customer }: { customer: Customer }) => (\r\n    <Card className=\"cursor-pointer hover:shadow-md transition-shadow\" onClick={() => handleRowClick(customer)}>\r\n      <CardContent className=\"p-4\">\r\n        <div className=\"flex items-start gap-3\">\r\n          <Avatar className=\"h-12 w-12 flex-shrink-0\">\r\n            <AvatarImage src=\"\" alt={customer.name} />\r\n            <AvatarFallback className=\"bg-primary/10 text-primary font-semibold\">\r\n              {customer.name.split(\" \").map((n) => n[0]).join(\"\").slice(0, 2)}\r\n            </AvatarFallback>\r\n          </Avatar>\r\n          <div className=\"flex-1 min-w-0\">\r\n            <div className=\"flex items-start justify-between mb-1\">\r\n              <div className=\"flex-1\">\r\n                <h3 className=\"font-semibold text-body-sm truncate\">{customer.name}</h3>\r\n                <p className=\"text-body-xs text-muted-foreground\">{customer.id}</p>\r\n              </div>\r\n              <DropdownMenu>\r\n                <DropdownMenuTrigger asChild>\r\n                  <TouchButton variant=\"ghost\" size=\"sm\" className=\"h-8 w-8 p-0\" onClick={(event) => event.stopPropagation()}>\r\n                    <MoreVertical className=\"h-4 w-4\" />\r\n                  </TouchButton>\r\n                </DropdownMenuTrigger>\r\n                <DropdownMenuContent align=\"end\">\r\n                  <DropdownMenuItem\r\n                    onClick={(event) => {\r\n                      event.stopPropagation();\r\n                      router.push(`/customers/${customer.systemId}/edit`);\r\n                    }}\r\n                  >\r\n                    Chỉnh sửa\r\n                  </DropdownMenuItem>\r\n                  <DropdownMenuItem\r\n                    onClick={(event) => {\r\n                      event.stopPropagation();\r\n                      handleDelete(customer.systemId);\r\n                    }}\r\n                  >\r\n                    Chuyển vào thùng rác\r\n                  </DropdownMenuItem>\r\n                </DropdownMenuContent>\r\n              </DropdownMenu>\r\n            </div>\r\n            <div className=\"space-y-1.5 mt-2\">\r\n              {customer.company && (\r\n                <div className=\"flex items-center text-body-xs text-muted-foreground\">\r\n                  <Building2 className=\"h-3 w-3 mr-1.5\" />\r\n                  <span className=\"truncate\">{customer.company}</span>\r\n                </div>\r\n              )}\r\n              {customer.email && (\r\n                <div className=\"flex items-center text-body-xs text-muted-foreground\">\r\n                  <Mail className=\"h-3 w-3 mr-1.5\" />\r\n                  <span className=\"truncate\">{customer.email}</span>\r\n                </div>\r\n              )}\r\n              {customer.phone && (\r\n                <div className=\"flex items-center text-body-xs text-muted-foreground\">\r\n                  <Phone className=\"h-3 w-3 mr-1.5\" />\r\n                  <span>{customer.phone}</span>\r\n                </div>\r\n              )}\r\n            </div>\r\n            <div className=\"flex items-center justify-between mt-3 pt-2 border-t\">\r\n              <Badge variant={getStatusVariant(customer.status)} className=\"text-body-xs\">\r\n                {customer.status}\r\n              </Badge>\r\n              {customer.accountManagerName && (\r\n                <span className=\"text-body-xs text-muted-foreground\">NV: {customer.accountManagerName}</span>\r\n              )}\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </CardContent>\r\n    </Card>\r\n  );\r\n\r\n  return (\r\n    <div className=\"flex flex-col w-full h-full\">\r\n      <div className=\"flex flex-col gap-4\">\r\n        <div className=\"flex-shrink-0 space-y-4\">\r\n          {isMobile ? (\r\n            <div className=\"space-y-3\">\r\n              <TouchButton onClick={() => router.push(\"/customers/new\")} size=\"default\" className=\"w-full min-h-touch\">\r\n                <PlusCircle className=\"mr-2 h-4 w-4\" />\r\n                Thêm khách hàng\r\n              </TouchButton>\r\n              <div className=\"flex gap-2\">\r\n                <Button variant=\"outline\" size=\"sm\" onClick={() => setShowImportDialog(true)}>\r\n                  <FileSpreadsheet className=\"mr-2 h-4 w-4\" />\r\n                  Nhập\r\n                </Button>\r\n                <Button variant=\"outline\" size=\"sm\" onClick={() => setShowExportDialog(true)}>\r\n                  <Download className=\"mr-2 h-4 w-4\" />\r\n                  Xuất\r\n                </Button>\r\n                <DataTableColumnCustomizer\r\n                  columns={columns}\r\n                  columnVisibility={columnVisibility}\r\n                  setColumnVisibility={setColumnVisibility}\r\n                  columnOrder={columnOrder}\r\n                  setColumnOrder={setColumnOrder}\r\n                  pinnedColumns={pinnedColumns}\r\n                  setPinnedColumns={setPinnedColumns}\r\n                />\r\n              </div>\r\n            </div>\r\n          ) : null}\r\n\r\n          {/* Desktop Actions Row */}\r\n          {!isMobile && (\r\n            <div className=\"flex items-center gap-2\">\r\n              <Button variant=\"outline\" size=\"sm\" onClick={() => setShowImportDialog(true)}>\r\n                <FileSpreadsheet className=\"mr-2 h-4 w-4\" />\r\n                Nhập file\r\n              </Button>\r\n              <Button variant=\"outline\" size=\"sm\" onClick={() => setShowExportDialog(true)}>\r\n                <Download className=\"mr-2 h-4 w-4\" />\r\n                Xuất Excel\r\n              </Button>\r\n              <DataTableColumnCustomizer\r\n                columns={columns}\r\n                columnVisibility={columnVisibility}\r\n                setColumnVisibility={setColumnVisibility}\r\n                columnOrder={columnOrder}\r\n                setColumnOrder={setColumnOrder}\r\n                pinnedColumns={pinnedColumns}\r\n                setPinnedColumns={setPinnedColumns}\r\n              />\r\n            </div>\r\n          )}\r\n\r\n          {isMobile ? (\r\n            <div className=\"space-y-3\">\r\n              <MobileSearchBar value={tableState.search} onChange={handleSearchChange} placeholder=\"Tìm kiếm khách hàng...\" />\r\n              <div className=\"grid grid-cols-2 gap-2\">\r\n                <Select value={tableState.debtFilter} onValueChange={(value) => {\r\n                  updateTableState((prev) => ({\r\n                    ...prev,\r\n                    debtFilter: value as typeof prev.debtFilter,\r\n                    pagination: { ...prev.pagination, pageIndex: 0 },\r\n                  }));\r\n                }}>\r\n                  <SelectTrigger className=\"h-9\">\r\n                    <SelectValue placeholder=\"Công nợ\" />\r\n                  </SelectTrigger>\r\n                  <SelectContent>\r\n                    <SelectItem value=\"all\">Tất cả công nợ</SelectItem>\r\n                    <SelectItem value=\"totalOverdue\">Tổng quá hạn</SelectItem>\r\n                    <SelectItem value=\"overdue\">Quá hạn</SelectItem>\r\n                    <SelectItem value=\"dueSoon\">Sắp đến hạn</SelectItem>\r\n                    <SelectItem value=\"hasDebt\">Có công nợ</SelectItem>\r\n                  </SelectContent>\r\n                </Select>\r\n                <Select value={tableState.slaFilter} onValueChange={(value) => {\r\n                  updateTableState((prev) => ({\r\n                    ...prev,\r\n                    slaFilter: value as typeof prev.slaFilter,\r\n                    pagination: { ...prev.pagination, pageIndex: 0 },\r\n                  }));\r\n                }}>\r\n                  <SelectTrigger className=\"h-9\">\r\n                    <SelectValue placeholder=\"Cảnh báo\" />\r\n                  </SelectTrigger>\r\n                  <SelectContent>\r\n                    <SelectItem value=\"all\">Tất cả cảnh báo</SelectItem>\r\n                    <SelectItem value=\"followUp\">Cần liên hệ</SelectItem>\r\n                    <SelectItem value=\"reengage\">Lâu không mua hàng</SelectItem>\r\n                    <SelectItem value=\"debt\">Cảnh báo công nợ</SelectItem>\r\n                    <SelectItem value=\"health\">Nguy cơ mất khách</SelectItem>\r\n                  </SelectContent>\r\n                </Select>\r\n                <Select value={tableState.statusFilter} onValueChange={handleStatusFilterChange}>\r\n                  <SelectTrigger className=\"h-9\">\r\n                    <SelectValue placeholder=\"Trạng thái\" />\r\n                  </SelectTrigger>\r\n                  <SelectContent>\r\n                    <SelectItem value=\"all\">Tất cả trạng thái</SelectItem>\r\n                    <SelectItem value=\"Đang giao dịch\">Đang giao dịch</SelectItem>\r\n                    <SelectItem value=\"Ngừng Giao Dịch\">Ngừng giao dịch</SelectItem>\r\n                  </SelectContent>\r\n                </Select>\r\n                <Select value={tableState.typeFilter} onValueChange={handleTypeFilterChange}>\r\n                  <SelectTrigger className=\"h-9\">\r\n                    <SelectValue placeholder=\"Loại KH\" />\r\n                  </SelectTrigger>\r\n                  <SelectContent>\r\n                    <SelectItem value=\"all\">Tất cả loại KH</SelectItem>\r\n                    {customerTypes.data.filter((type) => type.isActive !== false).map((type) => (\r\n                      <SelectItem key={type.systemId} value={type.id}>\r\n                        {type.name}\r\n                      </SelectItem>\r\n                    ))}\r\n                  </SelectContent>\r\n                </Select>\r\n              </div>\r\n              <div className=\"flex justify-between items-center pt-2 border-t\">\r\n                <p className=\"text-body-sm text-muted-foreground\">{sortedData.length} khách hàng</p>\r\n              </div>\r\n            </div>\r\n          ) : (\r\n            <PageFilters searchValue={tableState.search} onSearchChange={handleSearchChange} searchPlaceholder=\"Tìm kiếm khách hàng...\">\r\n              <DataTableDateFilter value={tableState.dateRange} onChange={handleDateRangeChange} title=\"Ngày tạo\" />\r\n              \r\n              {/* Debt Filter */}\r\n              <Select value={tableState.debtFilter} onValueChange={(value) => {\r\n                updateTableState((prev) => ({\r\n                  ...prev,\r\n                  debtFilter: value as typeof prev.debtFilter,\r\n                  pagination: { ...prev.pagination, pageIndex: 0 },\r\n                }));\r\n              }}>\r\n                <SelectTrigger className=\"w-[180px] h-9\">\r\n                  <SelectValue placeholder=\"Công nợ\" />\r\n                </SelectTrigger>\r\n                <SelectContent>\r\n                  <SelectItem value=\"all\">Tất cả công nợ</SelectItem>\r\n                  <SelectItem value=\"totalOverdue\">Tổng công nợ quá hạn</SelectItem>\r\n                  <SelectItem value=\"overdue\">Quá hạn thanh toán</SelectItem>\r\n                  <SelectItem value=\"dueSoon\">Sắp đến hạn</SelectItem>\r\n                  <SelectItem value=\"hasDebt\">Có công nợ</SelectItem>\r\n                </SelectContent>\r\n              </Select>\r\n\r\n              {/* SLA Filter */}\r\n              {slaSummary && (\r\n                <Select value={tableState.slaFilter} onValueChange={(value) => {\r\n                  updateTableState((prev) => ({\r\n                    ...prev,\r\n                    slaFilter: value as typeof prev.slaFilter,\r\n                    pagination: { ...prev.pagination, pageIndex: 0 },\r\n                  }));\r\n                }}>\r\n                  <SelectTrigger className=\"w-[180px] h-9\">\r\n                    <SelectValue placeholder=\"Cảnh báo\" />\r\n                  </SelectTrigger>\r\n                  <SelectContent>\r\n                    <SelectItem value=\"all\">Tất cả cảnh báo</SelectItem>\r\n                    <SelectItem value=\"followUp\">Cần liên hệ ({slaSummary.followUpAlerts})</SelectItem>\r\n                    <SelectItem value=\"reengage\">Lâu không mua hàng ({slaSummary.reEngagementAlerts})</SelectItem>\r\n                    <SelectItem value=\"debt\">Cảnh báo công nợ ({slaSummary.debtAlerts})</SelectItem>\r\n                    <SelectItem value=\"health\">Nguy cơ mất khách ({slaSummary.healthAlerts})</SelectItem>\r\n                  </SelectContent>\r\n                </Select>\r\n              )}\r\n\r\n              {/* Status Filter */}\r\n              <Select value={tableState.statusFilter} onValueChange={handleStatusFilterChange}>\r\n                <SelectTrigger className=\"w-[160px] h-9\">\r\n                  <SelectValue placeholder=\"Trạng thái\" />\r\n                </SelectTrigger>\r\n                <SelectContent>\r\n                  <SelectItem value=\"all\">Tất cả trạng thái</SelectItem>\r\n                  <SelectItem value=\"Đang giao dịch\">Đang giao dịch</SelectItem>\r\n                  <SelectItem value=\"Ngừng Giao Dịch\">Ngừng giao dịch</SelectItem>\r\n                </SelectContent>\r\n              </Select>\r\n\r\n              {/* Type Filter */}\r\n              <Select value={tableState.typeFilter} onValueChange={handleTypeFilterChange}>\r\n                <SelectTrigger className=\"w-[160px] h-9\">\r\n                  <SelectValue placeholder=\"Loại KH\" />\r\n                </SelectTrigger>\r\n                <SelectContent>\r\n                  <SelectItem value=\"all\">Tất cả loại</SelectItem>\r\n                  {customerTypes.data.filter((type) => type.isActive !== false).map((type) => (\r\n                    <SelectItem key={type.systemId} value={type.id}>\r\n                      {type.name}\r\n                    </SelectItem>\r\n                  ))}\r\n                </SelectContent>\r\n              </Select>\r\n            </PageFilters>\r\n          )}\r\n        </div>\r\n\r\n        <div className=\"w-full py-4\">\r\n          <ResponsiveDataTable\r\n            columns={columns}\r\n            data={pageData}\r\n            renderMobileCard={(customer) => <MobileCustomerCard customer={customer} />}\r\n            pageCount={pageCount}\r\n            pagination={tableState.pagination}\r\n            setPagination={handlePaginationChange}\r\n            rowCount={totalRows}\r\n            rowSelection={rowSelection}\r\n            setRowSelection={setRowSelection}\r\n            bulkActions={bulkActions}\r\n            allSelectedRows={selectedCustomers}\r\n            sorting={tableState.sorting}\r\n            setSorting={handleSortingChange}\r\n            expanded={expanded}\r\n            setExpanded={setExpanded}\r\n            columnVisibility={columnVisibility}\r\n            setColumnVisibility={setColumnVisibility}\r\n            columnOrder={columnOrder}\r\n            setColumnOrder={setColumnOrder}\r\n            pinnedColumns={pinnedColumns}\r\n            setPinnedColumns={setPinnedColumns}\r\n            onRowClick={handleRowClick}\r\n            mobileVirtualized\r\n            mobileRowHeight={MOBILE_ROW_HEIGHT}\r\n            mobileListHeight={MOBILE_LIST_HEIGHT}\r\n          />\r\n        </div>\r\n      </div>\r\n\r\n      <AlertDialog open={isAlertOpen} onOpenChange={setIsAlertOpen}>\r\n        <AlertDialogContent>\r\n          <AlertDialogHeader>\r\n            <AlertDialogTitle>Bạn có chắc chắn muốn xóa?</AlertDialogTitle>\r\n            <AlertDialogDescription>\r\n              Khách hàng sẽ được chuyển vào thùng rác. Bạn có thể khôi phục lại sau.\r\n            </AlertDialogDescription>\r\n          </AlertDialogHeader>\r\n          <AlertDialogFooter>\r\n            <AlertDialogCancel>Hủy</AlertDialogCancel>\r\n            <AlertDialogAction onClick={confirmDelete}>Xóa</AlertDialogAction>\r\n          </AlertDialogFooter>\r\n        </AlertDialogContent>\r\n      </AlertDialog>\r\n\r\n      {pendingAction && bulkDialogCopy && (\r\n        <BulkActionConfirmDialog\r\n          open\r\n          title={bulkDialogCopy.title}\r\n          description={bulkDialogCopy.description}\r\n          confirmLabel={bulkDialogCopy.confirmLabel}\r\n          customers={pendingAction.customers}\r\n          onConfirm={handleConfirmBulkAction}\r\n          onCancel={() => setPendingAction(null)}\r\n        />\r\n      )}\r\n\r\n      {/* V2 Import Dialog with Preview */}\r\n      <GenericImportDialogV2<Customer>\r\n        open={showImportDialog}\r\n        onOpenChange={setShowImportDialog}\r\n        config={customerImportExportConfig}\r\n        branches={branches.map(b => ({ systemId: b.systemId, name: b.name }))}\r\n        existingData={activeCustomers}\r\n        onImport={handleImportV2}\r\n        currentUser={currentUser}\r\n      />\r\n\r\n      {/* V2 Export Dialog with Column Selection */}\r\n      <GenericExportDialogV2<Customer>\r\n        open={showExportDialog}\r\n        onOpenChange={setShowExportDialog}\r\n        config={customerImportExportConfig}\r\n        allData={activeCustomers}\r\n        filteredData={sortedData}\r\n        currentPageData={pageData}\r\n        selectedData={selectedCustomers}\r\n        currentUser={currentUser}\r\n      />\r\n    </div>\r\n  );\r\n}\r\n"],"names":[],"mappings":"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"}}]
}