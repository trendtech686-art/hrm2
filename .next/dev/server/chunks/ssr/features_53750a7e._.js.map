{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/reports/customer-sla-report/sla-utils.ts"],"sourcesContent":["import type { Customer } from '../../customers/types';\r\nimport type { CustomerSlaSetting } from '../../settings/customers/types';\r\nimport type { \r\n  CustomerSlaAlert, \r\n  DebtAlert, \r\n  CustomerHealthAlert, \r\n  SlaAlertLevel,\r\n  ReportSummary \r\n} from './types';\r\nimport { differenceInDays, parseISO, format } from 'date-fns';\r\n\r\n/**\r\n * T√≠nh to√°n alert level d·ª±a tr√™n s·ªë ng√†y c√≤n l·∫°i v√† c·∫•u h√¨nh SLA\r\n * - daysRemaining < 0 means overdue\r\n * - criticalDays = s·ªë ng√†y qu√° h·∫°n ƒë·ªÉ coi l√† nghi√™m tr·ªçng\r\n * - warningDays = s·ªë ng√†y TR∆Ø·ªöC target ƒë·ªÉ b·∫Øt ƒë·∫ßu c·∫£nh b√°o\r\n */\r\nexport function calculateAlertLevel(\r\n  daysRemaining: number, \r\n  slaSetting: CustomerSlaSetting\r\n): SlaAlertLevel {\r\n  if (daysRemaining < -slaSetting.criticalDays) return 'overdue'; // Qu√° h·∫°n > criticalDays ng√†y\r\n  if (daysRemaining < 0) return 'critical'; // Qu√° h·∫°n nh∆∞ng ch∆∞a ƒë·∫øn criticalDays\r\n  if (daysRemaining <= slaSetting.warningDays) return 'warning'; // C√≤n <= warningDays ng√†y\r\n  return 'normal';\r\n}\r\n\r\n/**\r\n * L·∫•y danh s√°ch kh√°ch h√†ng c·∫ßn follow-up (li√™n h·ªá ƒë·ªãnh k·ª≥)\r\n */\r\nexport function getFollowUpAlerts(\r\n  customers: Customer[],\r\n  slaSettings: CustomerSlaSetting[]\r\n): CustomerSlaAlert[] {\r\n  // Simplified: only 1 SLA per type\r\n  const followUpSla = slaSettings.find(s => s.slaType === 'follow-up' && s.isActive);\r\n  \r\n  if (!followUpSla) return [];\r\n\r\n  const today = new Date();\r\n  const alerts: CustomerSlaAlert[] = [];\r\n\r\n  for (const customer of customers) {\r\n    if (customer.isDeleted || customer.status === 'Ng·ª´ng Giao D·ªãch') continue;\r\n\r\n    // L·∫•y ng√†y li√™n h·ªá cu·ªëi (d·ª±a tr√™n lastPurchaseDate ho·∫∑c updatedAt)\r\n    const lastContactDate = customer.lastPurchaseDate \r\n      || customer.updatedAt \r\n      || customer.createdAt;\r\n    \r\n    if (!lastContactDate) continue;\r\n\r\n    const lastContact = parseISO(lastContactDate);\r\n    const daysSinceContact = differenceInDays(today, lastContact);\r\n    const daysRemaining = followUpSla.targetDays - daysSinceContact;\r\n\r\n    // Hi·ªÉn th·ªã alert khi c√≤n <= warningDays ng√†y ho·∫∑c ƒë√£ qu√° h·∫°n\r\n    if (daysRemaining <= followUpSla.warningDays) {\r\n      alerts.push({\r\n        systemId: customer.systemId,\r\n        customer,\r\n        slaType: 'follow-up',\r\n        slaName: followUpSla.name,\r\n        daysRemaining,\r\n        alertLevel: calculateAlertLevel(daysRemaining, followUpSla),\r\n        targetDate: format(\r\n          new Date(lastContact.getTime() + followUpSla.targetDays * 24 * 60 * 60 * 1000),\r\n          'yyyy-MM-dd'\r\n        ),\r\n        lastActivityDate: lastContactDate,\r\n        ...(customer.accountManagerName ? { assignee: customer.accountManagerName } : {}),\r\n      });\r\n    }\r\n  }\r\n\r\n  return alerts.sort((a, b) => a.daysRemaining - b.daysRemaining);\r\n}\r\n\r\n/**\r\n * L·∫•y danh s√°ch kh√°ch h√†ng c·∫ßn k√≠ch ho·∫°t l·∫°i (kh√¥ng ho·∫°t ƒë·ªông l√¢u)\r\n */\r\nexport function getReEngagementAlerts(\r\n  customers: Customer[],\r\n  slaSettings: CustomerSlaSetting[]\r\n): CustomerSlaAlert[] {\r\n  // Simplified: only 1 SLA per type\r\n  const reEngageSla = slaSettings.find(s => s.slaType === 're-engagement' && s.isActive);\r\n  \r\n  if (!reEngageSla) return [];\r\n\r\n  const today = new Date();\r\n  const alerts: CustomerSlaAlert[] = [];\r\n\r\n  for (const customer of customers) {\r\n    if (customer.isDeleted || customer.status === 'Ng·ª´ng Giao D·ªãch') continue;\r\n\r\n    // Ch·ªâ x√©t kh√°ch ƒë√£ t·ª´ng mua h√†ng\r\n    if (!customer.lastPurchaseDate || !customer.totalOrders) continue;\r\n\r\n    const lastPurchase = parseISO(customer.lastPurchaseDate);\r\n    const daysSincePurchase = differenceInDays(today, lastPurchase);\r\n    const daysRemaining = reEngageSla.targetDays - daysSincePurchase;\r\n\r\n    // Hi·ªÉn th·ªã alert khi c√≤n <= warningDays ng√†y ho·∫∑c ƒë√£ qu√° h·∫°n\r\n    if (daysRemaining <= reEngageSla.warningDays) {\r\n      alerts.push({\r\n        systemId: customer.systemId,\r\n        customer,\r\n        slaType: 're-engagement',\r\n        slaName: reEngageSla.name,\r\n        daysRemaining,\r\n        alertLevel: calculateAlertLevel(daysRemaining, reEngageSla),\r\n        targetDate: format(\r\n          new Date(lastPurchase.getTime() + reEngageSla.targetDays * 24 * 60 * 60 * 1000),\r\n          'yyyy-MM-dd'\r\n        ),\r\n        lastActivityDate: customer.lastPurchaseDate,\r\n        ...(customer.accountManagerName ? { assignee: customer.accountManagerName } : {}),\r\n      });\r\n    }\r\n  }\r\n\r\n  return alerts.sort((a, b) => a.daysRemaining - b.daysRemaining);\r\n}\r\n\r\n/**\r\n * L·∫•y danh s√°ch kh√°ch h√†ng c√≥ v·∫•n ƒë·ªÅ c√¥ng n·ª£\r\n */\r\nexport function getDebtAlerts(customers: Customer[]): DebtAlert[] {\r\n  const alerts: DebtAlert[] = [];\r\n\r\n  for (const customer of customers) {\r\n    if (customer.isDeleted) continue;\r\n\r\n    // Ch·ªâ x√©t kh√°ch c√≥ c√¥ng n·ª£\r\n    const currentDebt = customer.currentDebt || 0;\r\n    if (currentDebt <= 0) continue;\r\n\r\n    // T√≠nh s·ªë ti·ªÅn qu√° h·∫°n v√† ng√†y qu√° h·∫°n\r\n    let overdueAmount = 0;\r\n    let maxDaysOverdue = 0;\r\n    let oldestDueDate: string | undefined;\r\n\r\n    if (customer.debtTransactions) {\r\n      const today = new Date();\r\n      for (const txn of customer.debtTransactions) {\r\n        if (txn.isPaid) continue;\r\n        \r\n        const dueDate = parseISO(txn.dueDate);\r\n        const daysOverdue = differenceInDays(today, dueDate);\r\n        \r\n        if (daysOverdue > 0) {\r\n          overdueAmount += txn.remainingAmount || txn.amount;\r\n          if (daysOverdue > maxDaysOverdue) {\r\n            maxDaysOverdue = daysOverdue;\r\n            oldestDueDate = txn.dueDate;\r\n          }\r\n        }\r\n      }\r\n    }\r\n\r\n    // L·∫•y debtStatus t·ª´ customer ho·∫∑c t√≠nh to√°n\r\n    const debtStatus = customer.debtStatus || 'Ch∆∞a ƒë·∫øn h·∫°n';\r\n\r\n    // Ch·ªâ hi·ªÉn th·ªã n·∫øu c√≥ n·ª£ qu√° h·∫°n ho·∫∑c s·∫Øp ƒë·∫øn h·∫°n\r\n    if (overdueAmount > 0 || debtStatus !== 'Ch∆∞a ƒë·∫øn h·∫°n') {\r\n      alerts.push({\r\n        systemId: customer.systemId,\r\n        customer,\r\n        totalDebt: currentDebt,\r\n        overdueAmount,\r\n        daysOverdue: maxDaysOverdue,\r\n        debtStatus,\r\n        ...(oldestDueDate ? { oldestDueDate } : {}),\r\n      });\r\n    }\r\n  }\r\n\r\n  return alerts.sort((a, b) => b.daysOverdue - a.daysOverdue);\r\n}\r\n\r\n/**\r\n * L·∫•y danh s√°ch kh√°ch h√†ng c√≥ r·ªßi ro churn cao\r\n */\r\nexport function getHealthAlerts(customers: Customer[]): CustomerHealthAlert[] {\r\n  const today = new Date();\r\n  const alerts: CustomerHealthAlert[] = [];\r\n\r\n  for (const customer of customers) {\r\n    if (customer.isDeleted || customer.status === 'Ng·ª´ng Giao D·ªãch') continue;\r\n\r\n    const healthScore = customer.healthScore || 50;\r\n    const churnRisk = customer.churnRisk || 'low';\r\n\r\n    // Ch·ªâ hi·ªÉn th·ªã n·∫øu c√≥ r·ªßi ro medium ho·∫∑c high, ho·∫∑c health score < 50\r\n    if (churnRisk !== 'low' || healthScore < 50) {\r\n      const daysSinceLastPurchase = customer.lastPurchaseDate\r\n        ? differenceInDays(today, parseISO(customer.lastPurchaseDate))\r\n        : 999;\r\n\r\n      alerts.push({\r\n        systemId: customer.systemId,\r\n        customer,\r\n        healthScore,\r\n        churnRisk,\r\n        ...(customer.segment ? { segment: customer.segment } : {}),\r\n        daysSinceLastPurchase,\r\n        totalOrders: customer.totalOrders || 0,\r\n        totalSpent: customer.totalSpent || 0,\r\n      });\r\n    }\r\n  }\r\n\r\n  return alerts.sort((a, b) => a.healthScore - b.healthScore);\r\n}\r\n\r\n/**\r\n * T√≠nh to√°n summary cho report\r\n */\r\nexport function calculateReportSummary(\r\n  customers: Customer[],\r\n  slaSettings: CustomerSlaSetting[]\r\n): ReportSummary {\r\n  const followUpAlerts = getFollowUpAlerts(customers, slaSettings);\r\n  const reEngagementAlerts = getReEngagementAlerts(customers, slaSettings);\r\n  const debtAlerts = getDebtAlerts(customers);\r\n  const healthAlerts = getHealthAlerts(customers);\r\n\r\n  const criticalCount = \r\n    followUpAlerts.filter(a => a.alertLevel === 'critical' || a.alertLevel === 'overdue').length +\r\n    reEngagementAlerts.filter(a => a.alertLevel === 'critical' || a.alertLevel === 'overdue').length +\r\n    debtAlerts.filter(a => a.daysOverdue > 15).length +\r\n    healthAlerts.filter(a => a.churnRisk === 'high').length;\r\n\r\n  return {\r\n    totalCustomers: customers.filter(c => !c.isDeleted).length,\r\n    followUpAlerts: followUpAlerts.length,\r\n    reEngagementAlerts: reEngagementAlerts.length,\r\n    debtAlerts: debtAlerts.length,\r\n    healthAlerts: healthAlerts.length,\r\n    criticalCount,\r\n  };\r\n}\r\n\r\n/**\r\n * Format s·ªë ng√†y c√≤n l·∫°i th√†nh text\r\n */\r\nexport function formatDaysRemaining(days: number): string {\r\n  if (days < 0) return `Qu√° ${Math.abs(days)} ng√†y`;\r\n  if (days === 0) return 'H√¥m nay';\r\n  return `C√≤n ${days} ng√†y`;\r\n}\r\n\r\n/**\r\n * Get color class based on alert level\r\n */\r\nexport function getAlertLevelColor(level: SlaAlertLevel): string {\r\n  switch (level) {\r\n    case 'overdue': return 'text-red-600 bg-red-50';\r\n    case 'critical': return 'text-orange-600 bg-orange-50';\r\n    case 'warning': return 'text-yellow-600 bg-yellow-50';\r\n    default: return 'text-green-600 bg-green-50';\r\n  }\r\n}\r\n\r\n/**\r\n * Get badge variant based on alert level\r\n */\r\nexport function getAlertBadgeVariant(level: SlaAlertLevel): 'destructive' | 'warning' | 'default' | 'secondary' {\r\n  switch (level) {\r\n    case 'overdue': return 'destructive';\r\n    case 'critical': return 'warning';\r\n    case 'warning': return 'default';\r\n    default: return 'secondary';\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 218, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/products/store.ts"],"sourcesContent":["import { createCrudStore, CrudState } from '../../lib/store-factory';\r\n// REMOVED: import { data as initialData } from './data'; // Mock data no longer used - database is source of truth\r\nimport type { Product } from './types';\r\nimport { type SystemId } from '@/lib/id-types';\r\nimport { asSystemId, asBusinessId } from '../../lib/id-types';\r\nimport { getCurrentUserSystemId } from '../../contexts/auth-context';\r\nimport Fuse from 'fuse.js';\r\nimport {\r\n  getCurrentUserInfo,\r\n  createCreatedEntry,\r\n  createUpdatedEntry,\r\n  createStatusChangedEntry,\r\n  appendHistoryEntry,\r\n  type HistoryEntry\r\n} from '../../lib/activity-history-helper';\r\n\r\nconst baseStore = createCrudStore<Product>([], 'products', {\r\n  businessIdField: 'id',\r\n  getCurrentUser: getCurrentUserSystemId, // ‚úÖ Track who creates/updates\r\n  apiEndpoint: '/api/products',\r\n});\r\n\r\n// ‚úÖ API Sync helpers\r\nconst API_ENDPOINT = '/api/products';\r\n\r\nconst syncToApi = {\r\n  create: async (product: Product) => {\r\n    try {\r\n      const response = await fetch(API_ENDPOINT, {\r\n        method: 'POST',\r\n        credentials: 'include',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify(product),\r\n      });\r\n      if (!response.ok) console.warn('[Product API] Create sync failed');\r\n      else console.log('[Product API] Created:', product.systemId);\r\n    } catch (e) {\r\n      console.warn('[Product API] Create sync error:', e);\r\n    }\r\n  },\r\n  update: async (systemId: SystemId, updates: Partial<Product>) => {\r\n    try {\r\n      const response = await fetch(`${API_ENDPOINT}/${systemId}`, {\r\n        method: 'PATCH',\r\n        credentials: 'include',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify(updates),\r\n      });\r\n      if (!response.ok) console.warn('[Product API] Update sync failed');\r\n      else console.log('[Product API] Updated:', systemId);\r\n    } catch (e) {\r\n      console.warn('[Product API] Update sync error:', e);\r\n    }\r\n  },\r\n  delete: async (systemId: SystemId, hard = false) => {\r\n    try {\r\n      const response = await fetch(`${API_ENDPOINT}/${systemId}`, {\r\n        method: 'DELETE',\r\n        credentials: 'include',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({ hard }),\r\n      });\r\n      if (!response.ok) console.warn('[Product API] Delete sync failed');\r\n      else console.log('[Product API] Deleted:', systemId);\r\n    } catch (e) {\r\n      console.warn('[Product API] Delete sync error:', e);\r\n    }\r\n  },\r\n  restore: async (systemId: SystemId) => {\r\n    try {\r\n      const response = await fetch(`${API_ENDPOINT}/${systemId}/restore`, {\r\n        method: 'POST',\r\n        credentials: 'include',\r\n        headers: { 'Content-Type': 'application/json' },\r\n      });\r\n      if (!response.ok) console.warn('[Product API] Restore sync failed');\r\n      else console.log('[Product API] Restored:', systemId);\r\n    } catch (e) {\r\n      console.warn('[Product API] Restore sync error:', e);\r\n    }\r\n  },\r\n};\r\n\r\n// ‚úÖ Wrap base store methods with API sync\r\nconst originalAdd = baseStore.getState().add;\r\nconst originalUpdate = baseStore.getState().update;\r\nconst originalRemove = baseStore.getState().remove;\r\nconst originalHardDelete = baseStore.getState().hardDelete;\r\nconst originalRestore = baseStore.getState().restore;\r\n\r\nbaseStore.setState({\r\n  add: (item: Omit<Product, 'systemId'>) => {\r\n    const result = originalAdd(item);\r\n    syncToApi.create(result);\r\n    return result;\r\n  },\r\n  update: (systemId: SystemId, updates: Partial<Product>) => {\r\n    originalUpdate(systemId, updates);\r\n    syncToApi.update(systemId, updates);\r\n  },\r\n  remove: (systemId: SystemId) => {\r\n    originalRemove(systemId);\r\n    syncToApi.delete(systemId, false);\r\n  },\r\n  hardDelete: (systemId: SystemId) => {\r\n    originalHardDelete(systemId);\r\n    syncToApi.delete(systemId, true);\r\n  },\r\n  restore: (systemId: SystemId) => {\r\n    originalRestore(systemId);\r\n    syncToApi.restore(systemId);\r\n  },\r\n});\r\n\r\n// Define extended store interface\r\nexport interface ProductStoreState extends CrudState<Product> {\r\n  updateInventory: (productSystemId: SystemId, branchSystemId: SystemId, quantityChange: number) => void;\r\n  commitStock: (productSystemId: SystemId, branchSystemId: SystemId, quantity: number) => void;\r\n  uncommitStock: (productSystemId: SystemId, branchSystemId: SystemId, quantity: number) => void;\r\n  dispatchStock: (productSystemId: SystemId, branchSystemId: SystemId, quantity: number) => void;\r\n  completeDelivery: (productSystemId: SystemId, branchSystemId: SystemId, quantity: number) => void;\r\n  returnStockFromTransit: (productSystemId: SystemId, branchSystemId: SystemId, quantity: number) => void;\r\n  updateLastPurchasePrice: (productSystemId: SystemId, price: number, date: string) => void;\r\n  searchProducts: (query: string, page: number, limit?: number) => Promise<{ items: { value: SystemId; label: string }[], hasNextPage: boolean }>;\r\n}\r\n\r\n// Helper to check if product tracks stock\r\nconst canModifyStock = (product: Product | undefined): boolean => {\r\n  if (!product) return false;\r\n  // Services, digital products, and combos don't track stock directly\r\n  if (product.type === 'service' || product.type === 'digital' || product.type === 'combo') return false;\r\n  // Explicitly disabled stock tracking\r\n  if (product.isStockTracked === false) return false;\r\n  return true;\r\n};\r\n\r\n// Define custom methods\r\nconst updateInventory = (productSystemId: SystemId, branchSystemId: SystemId, quantityChange: number) => {\r\n  baseStore.setState(state => {\r\n    const product = state.data.find(p => p.systemId === productSystemId);\r\n    if (!product) return state;\r\n    \r\n    // Skip if product doesn't track stock\r\n    if (!canModifyStock(product)) {\r\n      console.warn(`[updateInventory] Skipped: Product ${productSystemId} does not track stock`);\r\n      return state;\r\n    }\r\n    \r\n    const oldQuantity = product.inventoryByBranch?.[branchSystemId] || 0;\r\n    const newQuantity = oldQuantity + quantityChange;\r\n    \r\n    // ‚úÖ Removed COMPLAINT_ADJUSTMENT stock history creation\r\n    // Stock history will be created by inventory check balance instead\r\n    \r\n    return {\r\n      data: state.data.map(p => {\r\n        if (p.systemId === productSystemId) {\r\n          const newInventoryByBranch = { ...p.inventoryByBranch };\r\n          newInventoryByBranch[branchSystemId] = newQuantity;\r\n          return {\r\n            ...p,\r\n            inventoryByBranch: newInventoryByBranch,\r\n          };\r\n        }\r\n        return p;\r\n      }),\r\n    };\r\n  });\r\n};\r\n\r\nconst commitStock = (productSystemId: SystemId, branchSystemId: SystemId, quantity: number) => {\r\n  baseStore.setState(state => {\r\n    const product = state.data.find(p => p.systemId === productSystemId);\r\n    if (!canModifyStock(product)) {\r\n      console.warn(`[commitStock] Skipped: Product ${productSystemId} does not track stock`);\r\n      return state;\r\n    }\r\n    return {\r\n      data: state.data.map(p => {\r\n        if (p.systemId === productSystemId) {\r\n          const newCommitted = { ...p.committedByBranch };\r\n          newCommitted[branchSystemId] = (newCommitted[branchSystemId] || 0) + quantity;\r\n          return { ...p, committedByBranch: newCommitted };\r\n        }\r\n        return p;\r\n      }),\r\n    };\r\n  });\r\n};\r\n\r\nconst uncommitStock = (productSystemId: SystemId, branchSystemId: SystemId, quantity: number) => {\r\n  baseStore.setState(state => {\r\n    const product = state.data.find(p => p.systemId === productSystemId);\r\n    if (!canModifyStock(product)) {\r\n      console.warn(`[uncommitStock] Skipped: Product ${productSystemId} does not track stock`);\r\n      return state;\r\n    }\r\n    return {\r\n      data: state.data.map(p => {\r\n        if (p.systemId === productSystemId) {\r\n          const newCommitted = { ...p.committedByBranch };\r\n          newCommitted[branchSystemId] = Math.max(0, (newCommitted[branchSystemId] || 0) - quantity);\r\n          return { ...p, committedByBranch: newCommitted };\r\n        }\r\n        return p;\r\n      }),\r\n    };\r\n  });\r\n};\r\n\r\nconst dispatchStock = (productSystemId: SystemId, branchSystemId: SystemId, quantity: number) => {\r\n  console.log('üî¥ [dispatchStock] Called with:', { productSystemId, branchSystemId, quantity });\r\n  \r\n  baseStore.setState(state => {\r\n    const product = state.data.find(p => p.systemId === productSystemId);\r\n    if (!product) {\r\n      console.error('‚ùå [dispatchStock] Product not found:', productSystemId);\r\n      return state;\r\n    }\r\n    \r\n    // Skip if product doesn't track stock\r\n    if (!canModifyStock(product)) {\r\n      console.warn(`[dispatchStock] Skipped: Product ${productSystemId} does not track stock`);\r\n      return state;\r\n    }\r\n    \r\n    console.log('üì¶ [dispatchStock] Current inventory:', product.inventoryByBranch);\r\n    console.log('üì¶ [dispatchStock] Current committed:', product.committedByBranch);\r\n    \r\n    return {\r\n      data: state.data.map(product => {\r\n        if (product.systemId === productSystemId) {\r\n          const newInventory = { ...product.inventoryByBranch };\r\n          const oldInventory = newInventory[branchSystemId] || 0;\r\n          newInventory[branchSystemId] = oldInventory - quantity;\r\n          \r\n          const newCommitted = { ...product.committedByBranch };\r\n          newCommitted[branchSystemId] = Math.max(0, (newCommitted[branchSystemId] || 0) - quantity);\r\n\r\n          const newInTransit = { ...product.inTransitByBranch };\r\n          newInTransit[branchSystemId] = (newInTransit[branchSystemId] || 0) + quantity;\r\n          \r\n          console.log('‚úÖ [dispatchStock] Updated inventory:', {\r\n            old: oldInventory,\r\n            new: newInventory[branchSystemId],\r\n            change: -quantity\r\n          });\r\n          \r\n          return { \r\n            ...product, \r\n            inventoryByBranch: newInventory,\r\n            committedByBranch: newCommitted,\r\n            inTransitByBranch: newInTransit,\r\n          };\r\n        }\r\n        return product;\r\n      }),\r\n    };\r\n  });\r\n  \r\n  console.log('‚úÖ [dispatchStock] Completed');\r\n};\r\n\r\nconst completeDelivery = (productSystemId: SystemId, branchSystemId: SystemId, quantity: number) => {\r\n  baseStore.setState(state => {\r\n    const product = state.data.find(p => p.systemId === productSystemId);\r\n    if (!canModifyStock(product)) {\r\n      return state;\r\n    }\r\n    return {\r\n      data: state.data.map(p => {\r\n        if (p.systemId === productSystemId) {\r\n          const newInTransit = { ...p.inTransitByBranch };\r\n          newInTransit[branchSystemId] = Math.max(0, (newInTransit[branchSystemId] || 0) - quantity);\r\n          return { ...p, inTransitByBranch: newInTransit };\r\n        }\r\n        return p;\r\n      }),\r\n    };\r\n  });\r\n};\r\n\r\nconst returnStockFromTransit = (productSystemId: SystemId, branchSystemId: SystemId, quantity: number) => {\r\n  baseStore.setState(state => {\r\n    const product = state.data.find(p => p.systemId === productSystemId);\r\n    if (!canModifyStock(product)) {\r\n      return state;\r\n    }\r\n    return {\r\n      data: state.data.map(p => {\r\n        if (p.systemId === productSystemId) {\r\n          const newInTransit = { ...p.inTransitByBranch };\r\n          newInTransit[branchSystemId] = Math.max(0, (newInTransit[branchSystemId] || 0) - quantity);\r\n          const newInventory = { ...p.inventoryByBranch };\r\n          newInventory[branchSystemId] = (newInventory[branchSystemId] || 0) + quantity;\r\n          return { ...p, inventoryByBranch: newInventory, inTransitByBranch: newInTransit };\r\n        }\r\n        return p;\r\n      }),\r\n    };\r\n  });\r\n};\r\n\r\nconst updateLastPurchasePrice = (productSystemId: SystemId, price: number, date: string) => {\r\n  baseStore.setState(state => ({\r\n    data: state.data.map(product => {\r\n      if (product.systemId === productSystemId) {\r\n        // Only update if the new date is newer or equal to the existing lastPurchaseDate\r\n        const existingDate = product.lastPurchaseDate ? new Date(product.lastPurchaseDate).getTime() : 0;\r\n        const newDateTs = new Date(date).getTime();\r\n        \r\n        if (newDateTs >= existingDate) {\r\n          return {\r\n            ...product,\r\n            lastPurchasePrice: price,\r\n            lastPurchaseDate: date,\r\n          };\r\n        }\r\n      }\r\n      return product;\r\n    }),\r\n  }));\r\n};\r\n\r\nconst searchProducts = async (query: string, page: number = 1, limit: number = 10): Promise<{ items: { value: SystemId; label: string }[], hasNextPage: boolean }> => {\r\n  const allProducts = baseStore.getState().data;\r\n  \r\n  // ‚úÖ Create fresh Fuse instance with current data (avoid stale data)\r\n  const fuse = new Fuse(allProducts, {\r\n    keys: ['name', 'id', 'sku', 'barcode'],\r\n    threshold: 0.3,\r\n  });\r\n  \r\n  const results = fuse.search(query);\r\n  const startIndex = (page - 1) * limit;\r\n  const endIndex = startIndex + limit;\r\n  const paginatedResults = results.slice(startIndex, endIndex);\r\n\r\n  return {\r\n    items: paginatedResults.map(result => ({\r\n      value: asSystemId(result.item.systemId),\r\n      label: `${result.item.name} (${result.item.id})`,\r\n    })),\r\n    hasNextPage: endIndex < results.length,\r\n  };\r\n};\r\n\r\n// Wrapped add method with activity history logging\r\nconst addProduct = (product: Omit<Product, 'systemId'>) => {\r\n  const userInfo = getCurrentUserInfo();\r\n  const newProduct = baseStore.getState().add(product);\r\n  \r\n  // Add activity history entry\r\n  const historyEntry = createCreatedEntry(\r\n    userInfo,\r\n    `${userInfo.name} ƒë√£ t·∫°o s·∫£n ph·∫©m ${newProduct.name} (${newProduct.id})`\r\n  );\r\n  baseStore.getState().update(newProduct.systemId, {\r\n    ...newProduct,\r\n    activityHistory: [historyEntry]\r\n  });\r\n  \r\n  return newProduct;\r\n};\r\n\r\n// Wrapped update method with activity history logging\r\nconst updateProduct = (systemId: SystemId, updatedProduct: Product) => {\r\n  const userInfo = getCurrentUserInfo();\r\n  const existingProduct = baseStore.getState().data.find(p => p.systemId === systemId);\r\n  const historyEntries: HistoryEntry[] = [];\r\n  \r\n  if (existingProduct) {\r\n    // Track status changes\r\n    if (existingProduct.status !== updatedProduct.status) {\r\n      const statusLabels: Record<string, string> = {\r\n        'active': 'ƒêang kinh doanh',\r\n        'inactive': 'Ng·ª´ng kinh doanh',\r\n        'discontinued': 'Ng·ª´ng s·∫£n xu·∫•t'\r\n      };\r\n      historyEntries.push(createStatusChangedEntry(\r\n        userInfo,\r\n        statusLabels[existingProduct.status || 'active'],\r\n        statusLabels[updatedProduct.status || 'active'],\r\n        `${userInfo.name} ƒë√£ ƒë·ªïi tr·∫°ng th√°i t·ª´ \"${statusLabels[existingProduct.status || 'active']}\" sang \"${statusLabels[updatedProduct.status || 'active']}\"`\r\n      ));\r\n    }\r\n    \r\n    // Track field changes\r\n    const fieldsToTrack: Array<{ key: keyof Product; label: string }> = [\r\n      { key: 'name', label: 'T√™n s·∫£n ph·∫©m' },\r\n      { key: 'id', label: 'M√£ SKU' },\r\n      { key: 'description', label: 'M√¥ t·∫£' },\r\n      { key: 'shortDescription', label: 'M√¥ t·∫£ ng·∫Øn' },\r\n      { key: 'type', label: 'Lo·∫°i s·∫£n ph·∫©m' },\r\n      { key: 'categorySystemId', label: 'Danh m·ª•c' },\r\n      { key: 'brandSystemId', label: 'Th∆∞∆°ng hi·ªáu' },\r\n      { key: 'unit', label: 'ƒê∆°n v·ªã t√≠nh' },\r\n      { key: 'costPrice', label: 'Gi√° v·ªën' },\r\n      { key: 'minPrice', label: 'Gi√° t·ªëi thi·ªÉu' },\r\n      { key: 'barcode', label: 'M√£ v·∫°ch' },\r\n      { key: 'primarySupplierSystemId', label: 'Nh√† cung c·∫•p ch√≠nh' },\r\n      { key: 'warrantyPeriodMonths', label: 'Th·ªùi h·∫°n b·∫£o h√†nh' },\r\n      { key: 'reorderLevel', label: 'M·ª©c ƒë·∫∑t h√†ng l·∫°i' },\r\n      { key: 'safetyStock', label: 'T·ªìn kho an to√†n' },\r\n      { key: 'maxStock', label: 'T·ªìn kho t·ªëi ƒëa' },\r\n    ];\r\n    \r\n    const changes: string[] = [];\r\n    for (const field of fieldsToTrack) {\r\n      const oldVal = existingProduct[field.key];\r\n      const newVal = updatedProduct[field.key];\r\n      if (oldVal !== newVal && !(oldVal === undefined && newVal === undefined)) {\r\n        if (field.key === 'status') continue;\r\n        const oldDisplay = oldVal !== undefined && oldVal !== null && oldVal !== '' ? String(oldVal) : '(tr·ªëng)';\r\n        const newDisplay = newVal !== undefined && newVal !== null && newVal !== '' ? String(newVal) : '(tr·ªëng)';\r\n        changes.push(`${field.label}: ${oldDisplay} ‚Üí ${newDisplay}`);\r\n      }\r\n    }\r\n    \r\n    // Track price changes separately\r\n    if (existingProduct.costPrice !== updatedProduct.costPrice) {\r\n      changes.push(`Gi√° v·ªën: ${existingProduct.costPrice?.toLocaleString('vi-VN')} ‚Üí ${updatedProduct.costPrice?.toLocaleString('vi-VN')}`);\r\n    }\r\n    \r\n    if (changes.length > 0) {\r\n      historyEntries.push(createUpdatedEntry(\r\n        userInfo,\r\n        `${userInfo.name} ƒë√£ c·∫≠p nh·∫≠t: ${changes.join(', ')}`\r\n      ));\r\n    }\r\n  }\r\n  \r\n  const productWithHistory = {\r\n    ...updatedProduct,\r\n    activityHistory: appendHistoryEntry(existingProduct?.activityHistory, ...historyEntries)\r\n  };\r\n  \r\n  baseStore.getState().update(systemId, productWithHistory);\r\n};\r\n\r\n// Export typed hook that includes both base and custom methods\r\nexport const useProductStore = (): ProductStoreState => {\r\n  const state = baseStore();\r\n  return {\r\n    ...state,\r\n    add: addProduct,\r\n    update: updateProduct,\r\n    updateInventory,\r\n    commitStock,\r\n    uncommitStock,\r\n    dispatchStock,\r\n    completeDelivery,\r\n    returnStockFromTransit,\r\n    updateLastPurchasePrice,\r\n    searchProducts,\r\n  };\r\n};\r\n\r\n// Export getState method for non-hook usage\r\nuseProductStore.getState = () => {\r\n  const state = baseStore.getState();\r\n  return {\r\n    ...state,\r\n    add: addProduct,\r\n    update: updateProduct,\r\n    updateInventory,\r\n    commitStock,\r\n    uncommitStock,\r\n    dispatchStock,\r\n    completeDelivery,\r\n    returnStockFromTransit,\r\n    updateLastPurchasePrice,\r\n    searchProducts,\r\n  };\r\n};\r\n\r\n(useProductStore as typeof useProductStore & { subscribe?: typeof baseStore.subscribe }).subscribe = baseStore.subscribe;\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 729, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/products/combo-utils.ts"],"sourcesContent":["/**\r\n * Combo Product Utilities\r\n * ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\r\n * Tham kh·∫£o: Sapo Combo\r\n * - Combo kh√¥ng c√≥ t·ªìn kho ri√™ng\r\n * - T·ªìn kho combo = MIN(t·ªìn kho SP con / s·ªë l∆∞·ª£ng trong combo)\r\n * - T·ªëi ƒëa 20 s·∫£n ph·∫©m con\r\n * - Kh√¥ng cho ph√©p combo l·ªìng combo\r\n * ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\r\n */\r\n\r\nimport type { Product, ComboItem, ComboPricingType } from './types';\r\nimport type { SystemId } from '@/lib/id-types';\r\n\r\n// Constants\r\nexport const MAX_COMBO_ITEMS = 20;\r\nexport const MIN_COMBO_ITEMS = 2;\r\n\r\n/**\r\n * Check if product is a combo\r\n */\r\nexport function isComboProduct(product: Product): boolean {\r\n  return product.type === 'combo';\r\n}\r\n\r\n/**\r\n * Check if a product can be added to combo\r\n * - Kh√¥ng cho ph√©p th√™m combo v√†o combo (no nested combo)\r\n * - S·∫£n ph·∫©m ph·∫£i active\r\n */\r\nexport function canAddToCombo(product: Product): boolean {\r\n  if (product.type === 'combo') return false;\r\n  if (product.status === 'discontinued') return false;\r\n  if (product.isDeleted) return false;\r\n  return true;\r\n}\r\n\r\n/**\r\n * Validate combo items\r\n * Returns error message or null if valid\r\n */\r\nexport function validateComboItems(\r\n  comboItems: ComboItem[],\r\n  allProducts: Product[]\r\n): string | null {\r\n  // Check minimum items\r\n  if (comboItems.length < MIN_COMBO_ITEMS) {\r\n    return `Combo ph·∫£i c√≥ √≠t nh·∫•t ${MIN_COMBO_ITEMS} s·∫£n ph·∫©m`;\r\n  }\r\n  \r\n  // Check maximum items\r\n  if (comboItems.length > MAX_COMBO_ITEMS) {\r\n    return `Combo ch·ªâ ƒë∆∞·ª£c t·ªëi ƒëa ${MAX_COMBO_ITEMS} s·∫£n ph·∫©m`;\r\n  }\r\n  \r\n  // Check for duplicate products\r\n  const productIds = comboItems.map(item => item.productSystemId);\r\n  const uniqueIds = new Set(productIds);\r\n  if (uniqueIds.size !== productIds.length) {\r\n    return 'Combo kh√¥ng ƒë∆∞·ª£c ch·ª©a s·∫£n ph·∫©m tr√πng l·∫∑p';\r\n  }\r\n  \r\n  // Check each item\r\n  for (const item of comboItems) {\r\n    // Check quantity\r\n    if (item.quantity < 1) {\r\n      return 'S·ªë l∆∞·ª£ng s·∫£n ph·∫©m trong combo ph·∫£i >= 1';\r\n    }\r\n    \r\n    if (!Number.isInteger(item.quantity)) {\r\n      return 'S·ªë l∆∞·ª£ng s·∫£n ph·∫©m trong combo ph·∫£i l√† s·ªë nguy√™n';\r\n    }\r\n    \r\n    // Check product exists and is valid\r\n    const product = allProducts.find(p => p.systemId === item.productSystemId);\r\n    if (!product) {\r\n      return 'S·∫£n ph·∫©m trong combo kh√¥ng t·ªìn t·∫°i';\r\n    }\r\n    \r\n    if (!canAddToCombo(product)) {\r\n      return `S·∫£n ph·∫©m \"${product.name}\" kh√¥ng th·ªÉ th√™m v√†o combo`;\r\n    }\r\n  }\r\n  \r\n  return null;\r\n}\r\n\r\n/**\r\n * Calculate combo available stock for a specific branch\r\n * Formula: MIN(child_product_available / quantity_in_combo)\r\n * \r\n * @param comboItems - List of combo items\r\n * @param allProducts - All products to lookup\r\n * @param branchSystemId - Branch to calculate stock for\r\n * @returns Available combo quantity (floored to integer)\r\n */\r\nexport function calculateComboStock(\r\n  comboItems: ComboItem[],\r\n  allProducts: Product[],\r\n  branchSystemId: SystemId\r\n): number {\r\n  if (!comboItems || comboItems.length === 0) return 0;\r\n  \r\n  let minComboQuantity = Infinity;\r\n  \r\n  for (const item of comboItems) {\r\n    const product = allProducts.find(p => p.systemId === item.productSystemId);\r\n    if (!product) return 0; // If any product not found, combo unavailable\r\n    \r\n    // Available = On-hand - Committed\r\n    const onHand = product.inventoryByBranch?.[branchSystemId] || 0;\r\n    const committed = product.committedByBranch?.[branchSystemId] || 0;\r\n    const available = onHand - committed;\r\n    \r\n    // How many combos can we make from this product?\r\n    const comboQuantityFromThisProduct = Math.floor(available / item.quantity);\r\n    \r\n    minComboQuantity = Math.min(minComboQuantity, comboQuantityFromThisProduct);\r\n  }\r\n  \r\n  return minComboQuantity === Infinity ? 0 : Math.max(0, minComboQuantity);\r\n}\r\n\r\n/**\r\n * Calculate combo stock across all branches\r\n * Returns a map of branchSystemId -> available combo quantity\r\n */\r\nexport function calculateComboStockAllBranches(\r\n  comboItems: ComboItem[],\r\n  allProducts: Product[]\r\n): Record<SystemId, number> {\r\n  if (!comboItems || comboItems.length === 0) return {};\r\n  \r\n  // Collect all branch IDs from child products\r\n  const allBranchIds = new Set<SystemId>();\r\n  for (const item of comboItems) {\r\n    const product = allProducts.find(p => p.systemId === item.productSystemId);\r\n    if (product?.inventoryByBranch) {\r\n      Object.keys(product.inventoryByBranch).forEach(branchId => {\r\n        allBranchIds.add(branchId as SystemId);\r\n      });\r\n    }\r\n  }\r\n  \r\n  // Calculate stock for each branch\r\n  const result: Record<SystemId, number> = {};\r\n  for (const branchId of allBranchIds) {\r\n    result[branchId] = calculateComboStock(comboItems, allProducts, branchId);\r\n  }\r\n  \r\n  return result;\r\n}\r\n\r\n/**\r\n * Calculate combo price based on pricing type\r\n * \r\n * @param comboItems - List of combo items\r\n * @param allProducts - All products to lookup prices\r\n * @param pricingPolicySystemId - Which pricing policy to use\r\n * @param comboPricingType - How to calculate price\r\n * @param comboDiscount - Discount value (% or fixed amount)\r\n * @returns Calculated combo price\r\n */\r\nexport function calculateComboPrice(\r\n  comboItems: ComboItem[],\r\n  allProducts: Product[],\r\n  pricingPolicySystemId: SystemId,\r\n  comboPricingType: ComboPricingType,\r\n  comboDiscount: number = 0\r\n): number {\r\n  if (comboPricingType === 'fixed') {\r\n    // Fixed price is stored directly, not calculated\r\n    return comboDiscount; // In fixed mode, comboDiscount IS the price\r\n  }\r\n  \r\n  // Calculate sum of child products' prices\r\n  let sumPrice = 0;\r\n  for (const item of comboItems) {\r\n    const product = allProducts.find(p => p.systemId === item.productSystemId);\r\n    if (!product) continue;\r\n    \r\n    const unitPrice = product.prices?.[pricingPolicySystemId] || 0;\r\n    sumPrice += unitPrice * item.quantity;\r\n  }\r\n  \r\n  // Apply discount\r\n  if (comboPricingType === 'sum_discount_percent') {\r\n    const discountAmount = sumPrice * (comboDiscount / 100);\r\n    return Math.round(sumPrice - discountAmount);\r\n  }\r\n  \r\n  if (comboPricingType === 'sum_discount_amount') {\r\n    return Math.max(0, sumPrice - comboDiscount);\r\n  }\r\n  \r\n  return sumPrice;\r\n}\r\n\r\n/**\r\n * Calculate combo cost price (sum of child products' cost prices)\r\n */\r\ntype ComboCostOptions = {\r\n  /**\r\n   * Optional pricing policy to use when we have to fall back to selling price data.\r\n   * Ensures cost previews stay in sync with the price policy that users actually see.\r\n   */\r\n  fallbackPricingPolicyId?: SystemId;\r\n  /**\r\n   * Allow falling back to selling price data if cost/last purchase/min price are missing.\r\n   * Defaults to true to avoid showing zero cost when data is incomplete.\r\n   */\r\n  allowPriceFallback?: boolean;\r\n};\r\n\r\nconst isNumber = (value: unknown): value is number => typeof value === 'number' && Number.isFinite(value);\r\n\r\nexport function calculateComboCostPrice(\r\n  comboItems: ComboItem[],\r\n  allProducts: Product[],\r\n  options: ComboCostOptions = {}\r\n): number {\r\n  const { fallbackPricingPolicyId, allowPriceFallback = true } = options;\r\n  let totalCost = 0;\r\n  \r\n  for (const item of comboItems) {\r\n    const product = allProducts.find(p => p.systemId === item.productSystemId);\r\n    if (!product) continue;\r\n\r\n    let unitCost = product.costPrice;\r\n\r\n    if (!isNumber(unitCost) && isNumber(product.lastPurchasePrice)) {\r\n      unitCost = product.lastPurchasePrice;\r\n    }\r\n\r\n    if (!isNumber(unitCost) && allowPriceFallback) {\r\n      if (fallbackPricingPolicyId && isNumber(product.prices?.[fallbackPricingPolicyId])) {\r\n        unitCost = product.prices![fallbackPricingPolicyId];\r\n      }\r\n\r\n      if (!isNumber(unitCost)) {\r\n        const firstPrice = Object.values(product.prices || {}).find((price): price is number => isNumber(price));\r\n        if (isNumber(firstPrice)) {\r\n          unitCost = firstPrice;\r\n        }\r\n      }\r\n    }\r\n\r\n    if (!isNumber(unitCost) && isNumber(product.minPrice)) {\r\n      unitCost = product.minPrice;\r\n    }\r\n    \r\n    totalCost += (unitCost || 0) * item.quantity;\r\n  }\r\n  \r\n  return totalCost;\r\n}\r\n\r\n/**\r\n * Calculate combo last purchase price (sum of child products' last purchase prices)\r\n */\r\nexport function calculateComboLastPurchasePrice(\r\n  comboItems: ComboItem[],\r\n  allProducts: Product[]\r\n): number {\r\n  let total = 0;\r\n  \r\n  for (const item of comboItems) {\r\n    const product = allProducts.find(p => p.systemId === item.productSystemId);\r\n    if (!product) continue;\r\n    \r\n    total += (product.lastPurchasePrice || 0) * item.quantity;\r\n  }\r\n  \r\n  return total;\r\n}\r\n\r\n/**\r\n * Calculate combo min price (sum of child products' min prices)\r\n */\r\nexport function calculateComboMinPrice(\r\n  comboItems: ComboItem[],\r\n  allProducts: Product[]\r\n): number {\r\n  let total = 0;\r\n  \r\n  for (const item of comboItems) {\r\n    const product = allProducts.find(p => p.systemId === item.productSystemId);\r\n    if (!product) continue;\r\n    \r\n    total += (product.minPrice || 0) * item.quantity;\r\n  }\r\n  \r\n  return total;\r\n}\r\n\r\n/**\r\n * Calculate combo prices by policy (sum of child products' prices per policy)\r\n * This returns the RAW sum without any discount applied\r\n */\r\nexport function calculateComboPricesByPolicy(\r\n  comboItems: ComboItem[],\r\n  allProducts: Product[]\r\n): Record<string, number> {\r\n  const pricesByPolicy: Record<string, number> = {};\r\n  \r\n  for (const item of comboItems) {\r\n    const product = allProducts.find(p => p.systemId === item.productSystemId);\r\n    if (!product || !product.prices) continue;\r\n    \r\n    for (const [policyId, price] of Object.entries(product.prices)) {\r\n      if (!pricesByPolicy[policyId]) {\r\n        pricesByPolicy[policyId] = 0;\r\n      }\r\n      pricesByPolicy[policyId] += (price || 0) * item.quantity;\r\n    }\r\n  }\r\n  \r\n  return pricesByPolicy;\r\n}\r\n\r\n/**\r\n * Calculate final combo prices by policy with discount applied\r\n * This returns the actual selling prices for the combo\r\n * \r\n * @param comboItems - List of combo items\r\n * @param allProducts - All products to lookup prices\r\n * @param comboPricingType - How to calculate price\r\n * @param comboDiscount - Discount value (% or fixed amount or fixed price)\r\n * @param defaultPolicyId - Default selling policy ID (used for fixed pricing)\r\n * @returns Final combo prices by policy\r\n */\r\nexport function calculateFinalComboPricesByPolicy(\r\n  comboItems: ComboItem[],\r\n  allProducts: Product[],\r\n  comboPricingType: ComboPricingType,\r\n  comboDiscount: number = 0,\r\n  defaultPolicyId?: string\r\n): Record<string, number> {\r\n  // Get raw sum prices first\r\n  const rawPricesByPolicy = calculateComboPricesByPolicy(comboItems, allProducts);\r\n  const finalPricesByPolicy: Record<string, number> = {};\r\n  \r\n  if (comboPricingType === 'fixed') {\r\n    // For fixed pricing, only policies that exist on child products should be auto-filled.\r\n    for (const policyId of Object.keys(rawPricesByPolicy)) {\r\n      finalPricesByPolicy[policyId] = comboDiscount; // comboDiscount IS the price in fixed mode\r\n    }\r\n    return finalPricesByPolicy;\r\n  }\r\n  \r\n  // For discount-based pricing, apply discount to each policy's sum\r\n  for (const [policyId, sumPrice] of Object.entries(rawPricesByPolicy)) {\r\n    if (comboPricingType === 'sum_discount_percent') {\r\n      const discountAmount = sumPrice * (comboDiscount / 100);\r\n      finalPricesByPolicy[policyId] = Math.round(sumPrice - discountAmount);\r\n    } else if (comboPricingType === 'sum_discount_amount') {\r\n      finalPricesByPolicy[policyId] = Math.max(0, sumPrice - comboDiscount);\r\n    } else {\r\n      // No discount, use raw sum\r\n      finalPricesByPolicy[policyId] = sumPrice;\r\n    }\r\n  }\r\n  \r\n  return finalPricesByPolicy;\r\n}\r\n\r\n/**\r\n * Get summary text for combo (e.g., \"3 s·∫£n ph·∫©m, t·ªìn kho: 15\")\r\n */\r\nexport function getComboSummary(\r\n  comboItems: ComboItem[],\r\n  allProducts: Product[],\r\n  branchSystemId?: SystemId\r\n): string {\r\n  const itemCount = comboItems?.length || 0;\r\n  \r\n  if (!branchSystemId) {\r\n    return `${itemCount} s·∫£n ph·∫©m`;\r\n  }\r\n  \r\n  const stock = calculateComboStock(comboItems, allProducts, branchSystemId);\r\n  return `${itemCount} s·∫£n ph·∫©m, t·ªìn kho: ${stock}`;\r\n}\r\n\r\n/**\r\n * Check if combo has sufficient stock for a quantity\r\n */\r\nexport function hasComboStock(\r\n  comboItems: ComboItem[],\r\n  allProducts: Product[],\r\n  branchSystemId: SystemId,\r\n  requiredQuantity: number\r\n): boolean {\r\n  const available = calculateComboStock(comboItems, allProducts, branchSystemId);\r\n  return available >= requiredQuantity;\r\n}\r\n\r\n/**\r\n * Get the limiting product(s) for combo stock\r\n * Returns the product(s) that have the lowest available combo quantity\r\n */\r\nexport function getComboBottleneckProducts(\r\n  comboItems: ComboItem[],\r\n  allProducts: Product[],\r\n  branchSystemId: SystemId\r\n): Array<{ product: Product; availableForCombo: number; itemQuantity: number }> {\r\n  if (!comboItems || comboItems.length === 0) return [];\r\n  \r\n  const comboStock = calculateComboStock(comboItems, allProducts, branchSystemId);\r\n  const bottlenecks: Array<{ product: Product; availableForCombo: number; itemQuantity: number }> = [];\r\n  \r\n  for (const item of comboItems) {\r\n    const product = allProducts.find(p => p.systemId === item.productSystemId);\r\n    if (!product) continue;\r\n    \r\n    const onHand = product.inventoryByBranch?.[branchSystemId] || 0;\r\n    const committed = product.committedByBranch?.[branchSystemId] || 0;\r\n    const available = onHand - committed;\r\n    const comboQuantityFromThisProduct = Math.floor(available / item.quantity);\r\n    \r\n    // This product is a bottleneck if it limits the combo quantity\r\n    if (comboQuantityFromThisProduct === comboStock) {\r\n      bottlenecks.push({\r\n        product,\r\n        availableForCombo: comboQuantityFromThisProduct,\r\n        itemQuantity: item.quantity,\r\n      });\r\n    }\r\n  }\r\n  \r\n  return bottlenecks;\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1000, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/employees/store.ts"],"sourcesContent":["import { createCrudStore, CrudState } from '../../lib/store-factory';\r\n// REMOVED: import { data as initialData } from './data'; // Mock data no longer used - database is source of truth\r\nimport type { Employee } from './types';\r\nimport type { HistoryEntry } from '../../components/ActivityHistory';\r\nimport Fuse from 'fuse.js';\r\nimport { getCurrentUserSystemId } from '../../contexts/auth-context';\r\nimport { registerBreadcrumbStore } from '../../lib/breadcrumb-generator'; // ‚úÖ NEW\r\nimport { type SystemId } from '../../lib/id-types';\r\nimport { createInMemoryRepository } from '../../repositories/in-memory-repository';\r\nimport { \r\n  createHistoryEntry, \r\n  getCurrentUserInfo,\r\n  appendHistoryEntry \r\n} from '../../lib/activity-history-helper';\r\n\r\ntype EmployeePersistenceAdapter = {\r\n  create: (payload: Omit<Employee, 'systemId'>) => Promise<Employee>;\r\n  update: (systemId: SystemId, payload: Partial<Employee>) => Promise<Employee>;\r\n  softDelete: (systemId: SystemId) => Promise<void>;\r\n  restore: (systemId: SystemId) => Promise<Employee | undefined>;\r\n  hardDelete: (systemId: SystemId) => Promise<void>;\r\n};\r\n\r\nconst baseStore = createCrudStore<Employee>([], 'employees', {\r\n  businessIdField: 'id',\r\n  getCurrentUser: getCurrentUserSystemId, // ‚úÖ Track who creates/updates\r\n  apiEndpoint: '/api/employees',\r\n});\r\n\r\n// ‚úÖ Wrap add method to include activity history\r\nconst originalAdd = baseStore.getState().add;\r\nconst wrappedAdd = (item: Omit<Employee, 'systemId'>): Employee => {\r\n  const userInfo = getCurrentUserInfo();\r\n  const historyEntry = createHistoryEntry(\r\n    'created',\r\n    `${userInfo.name} ƒë√£ t·∫°o h·ªì s∆° nh√¢n vi√™n ${item.fullName} (${item.id})`,\r\n    userInfo\r\n  );\r\n  \r\n  const newEmployee = originalAdd({\r\n    ...item,\r\n    activityHistory: [historyEntry],\r\n  });\r\n  \r\n  return newEmployee;\r\n};\r\n\r\n// ‚úÖ Wrap update method to include activity history\r\nconst originalUpdate = baseStore.getState().update;\r\nconst wrappedUpdate = (systemId: SystemId, updates: Partial<Employee>): void => {\r\n  const currentEmployee = baseStore.getState().data.find(e => e.systemId === systemId);\r\n  if (!currentEmployee) return;\r\n  \r\n  const userInfo = getCurrentUserInfo();\r\n  const historyEntries: HistoryEntry[] = [];\r\n  \r\n  // Track important field changes\r\n  const trackedFields: { key: keyof Employee; label: string }[] = [\r\n    { key: 'fullName', label: 'h·ªç t√™n' },\r\n    { key: 'jobTitle', label: 'ch·ª©c danh' },\r\n    { key: 'department', label: 'ph√≤ng ban' },\r\n    { key: 'employmentStatus', label: 'tr·∫°ng th√°i l√†m vi·ªác' },\r\n    { key: 'employeeType', label: 'lo·∫°i nh√¢n vi√™n' },\r\n    { key: 'baseSalary', label: 'l∆∞∆°ng c∆° b·∫£n' },\r\n    { key: 'phone', label: 's·ªë ƒëi·ªán tho·∫°i' },\r\n    { key: 'workEmail', label: 'email c√¥ng vi·ªác' },\r\n    { key: 'role', label: 'vai tr√≤' },\r\n  ];\r\n  \r\n  trackedFields.forEach(({ key, label }) => {\r\n    if (updates[key] !== undefined && updates[key] !== currentEmployee[key]) {\r\n      const oldValue = currentEmployee[key];\r\n      const newValue = updates[key];\r\n      \r\n      // Format values for display\r\n      let oldDisplay = oldValue;\r\n      let newDisplay = newValue;\r\n      \r\n      if (key === 'baseSalary') {\r\n        oldDisplay = new Intl.NumberFormat('vi-VN').format(oldValue as number) + 'ƒë';\r\n        newDisplay = new Intl.NumberFormat('vi-VN').format(newValue as number) + 'ƒë';\r\n      }\r\n      \r\n      historyEntries.push(createHistoryEntry(\r\n        'updated',\r\n        `${userInfo.name} ƒë√£ c·∫≠p nh·∫≠t ${label}: \"${oldDisplay || '(tr·ªëng)'}\" ‚Üí \"${newDisplay}\"`,\r\n        userInfo,\r\n        { field: key, oldValue, newValue }\r\n      ));\r\n    }\r\n  });\r\n  \r\n  // If status changed specifically\r\n  if (updates.employmentStatus && updates.employmentStatus !== currentEmployee.employmentStatus) {\r\n    historyEntries.push(createHistoryEntry(\r\n      'status_changed',\r\n      `${userInfo.name} ƒë√£ thay ƒë·ªïi tr·∫°ng th√°i l√†m vi·ªác t·ª´ \"${currentEmployee.employmentStatus}\" th√†nh \"${updates.employmentStatus}\"`,\r\n      userInfo,\r\n      { field: 'employmentStatus', oldValue: currentEmployee.employmentStatus, newValue: updates.employmentStatus }\r\n    ));\r\n  }\r\n  \r\n  // If no specific changes tracked, add generic update entry\r\n  if (historyEntries.length === 0) {\r\n    historyEntries.push(createHistoryEntry(\r\n      'updated',\r\n      `${userInfo.name} ƒë√£ c·∫≠p nh·∫≠t th√¥ng tin nh√¢n vi√™n`,\r\n      userInfo\r\n    ));\r\n  }\r\n  \r\n  const updatedHistory = appendHistoryEntry(currentEmployee.activityHistory, ...historyEntries);\r\n  \r\n  originalUpdate(systemId, {\r\n    ...updates,\r\n    activityHistory: updatedHistory,\r\n  });\r\n};\r\n\r\n// ‚úÖ Override base store methods\r\nbaseStore.setState({\r\n  add: wrappedAdd,\r\n  update: wrappedUpdate,\r\n});\r\n\r\nexport const employeeRepository = createInMemoryRepository<Employee>(() => baseStore.getState());\r\n\r\n// ‚úÖ API-backed persistence adapter - syncs to PostgreSQL\r\nconst API_ENDPOINT = '/api/employees';\r\n\r\nconst persistence: EmployeePersistenceAdapter = {\r\n  create: async (payload) => {\r\n    // First create locally for immediate UI update\r\n    const localResult = await employeeRepository.create(payload);\r\n    \r\n    // Then sync to API (background)\r\n    try {\r\n      const response = await fetch(API_ENDPOINT, {\r\n        method: 'POST',\r\n        credentials: 'include',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({ ...payload, systemId: localResult.systemId }),\r\n      });\r\n      if (!response.ok) {\r\n        console.warn('[Employee API] Create sync failed, data saved locally');\r\n      } else {\r\n        console.log('[Employee API] Created:', localResult.systemId);\r\n      }\r\n    } catch (e) {\r\n      console.warn('[Employee API] Create sync error:', e);\r\n    }\r\n    \r\n    return localResult;\r\n  },\r\n  update: async (systemId, payload) => {\r\n    // First update locally\r\n    const localResult = await employeeRepository.update(systemId, payload);\r\n    \r\n    // Then sync to API\r\n    try {\r\n      const response = await fetch(`${API_ENDPOINT}/${systemId}`, {\r\n        method: 'PATCH',\r\n        credentials: 'include',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify(payload),\r\n      });\r\n      if (!response.ok) {\r\n        console.warn('[Employee API] Update sync failed');\r\n      } else {\r\n        console.log('[Employee API] Updated:', systemId);\r\n      }\r\n    } catch (e) {\r\n      console.warn('[Employee API] Update sync error:', e);\r\n    }\r\n    \r\n    return localResult;\r\n  },\r\n  softDelete: async (systemId) => {\r\n    // First delete locally\r\n    await employeeRepository.softDelete(systemId);\r\n    \r\n    // Then sync to API\r\n    try {\r\n      const response = await fetch(`${API_ENDPOINT}/${systemId}`, {\r\n        method: 'DELETE',\r\n        credentials: 'include',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({ hard: false }),\r\n      });\r\n      if (!response.ok) {\r\n        console.warn('[Employee API] Soft delete sync failed');\r\n      } else {\r\n        console.log('[Employee API] Soft deleted:', systemId);\r\n      }\r\n    } catch (e) {\r\n      console.warn('[Employee API] Soft delete sync error:', e);\r\n    }\r\n  },\r\n  restore: async (systemId) => {\r\n    // First restore locally\r\n    const localResult = await employeeRepository.restore(systemId);\r\n    \r\n    // Then sync to API\r\n    try {\r\n      const response = await fetch(`${API_ENDPOINT}/${systemId}/restore`, {\r\n        method: 'POST',\r\n        credentials: 'include',\r\n        headers: { 'Content-Type': 'application/json' },\r\n      });\r\n      if (!response.ok) {\r\n        console.warn('[Employee API] Restore sync failed');\r\n      } else {\r\n        console.log('[Employee API] Restored:', systemId);\r\n      }\r\n    } catch (e) {\r\n      console.warn('[Employee API] Restore sync error:', e);\r\n    }\r\n    \r\n    return localResult;\r\n  },\r\n  hardDelete: async (systemId) => {\r\n    // First delete locally\r\n    await employeeRepository.hardDelete(systemId);\r\n    \r\n    // Then sync to API\r\n    try {\r\n      const response = await fetch(`${API_ENDPOINT}/${systemId}`, {\r\n        method: 'DELETE',\r\n        credentials: 'include',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({ hard: true }),\r\n      });\r\n      if (!response.ok) {\r\n        console.warn('[Employee API] Hard delete sync failed');\r\n      } else {\r\n        console.log('[Employee API] Hard deleted:', systemId);\r\n      }\r\n    } catch (e) {\r\n      console.warn('[Employee API] Hard delete sync error:', e);\r\n    }\r\n  },\r\n};\r\n\r\n// ‚úÖ Register for breadcrumb auto-generation\r\nregisterBreadcrumbStore('employees', () => baseStore.getState());\r\n\r\n// Define enhanced interface\r\ninterface EmployeeStoreState extends CrudState<Employee> {\r\n  searchEmployees: (query: string, page: number, limit?: number) => Promise<{ items: { value: string; label: string }[], hasNextPage: boolean }>;\r\n  permanentDelete: (systemId: SystemId) => Promise<void>;\r\n  persistence: EmployeePersistenceAdapter;\r\n}\r\n\r\ntype EmployeeStoreHook = (() => EmployeeStoreState) & {\r\n  getState: () => EmployeeStoreState;\r\n  persistence: EmployeePersistenceAdapter;\r\n};\r\n\r\n// Augmented methods\r\nconst augmentedMethods = {\r\n    // FIX: Changed `page: number = 1` to `page: number` to make it a required parameter, matching Combobox prop type.\r\n    // ‚úÖ CRITICAL FIX: Create fresh Fuse instance on each search to avoid stale data\r\n    searchEmployees: async (query: string, page: number, limit: number = 20) => {\r\n        return new Promise<{ items: { value: string; label: string }[], hasNextPage: boolean }>(resolve => {\r\n            setTimeout(() => {\r\n                const allEmployees = baseStore.getState().data;\r\n                \r\n                // ‚úÖ Create fresh Fuse instance with current data\r\n                const fuse = new Fuse(allEmployees, {\r\n                    keys: ['fullName', 'id', 'phone', 'personalEmail', 'workEmail'],\r\n                    threshold: 0.3,\r\n                });\r\n                \r\n                const results = query ? fuse.search(query).map(r => r.item) : allEmployees;\r\n                \r\n                const start = (page - 1) * limit;\r\n                const end = start + limit;\r\n                const paginatedItems = results.slice(start, end);\r\n\r\n                resolve({\r\n                    items: paginatedItems.map(e => ({ value: e.systemId, label: e.fullName })),\r\n                    hasNextPage: end < results.length,\r\n                });\r\n            }, 300);\r\n        });\r\n    },\r\n    permanentDelete: async (systemId: SystemId) => {\r\n        await persistence.hardDelete(systemId);\r\n    }\r\n};\r\n\r\nconst useEmployeeStoreHook = (): EmployeeStoreState => {\r\n  const state = baseStore();\r\n  return {\r\n    ...state,\r\n    ...augmentedMethods, // This includes permanentDelete\r\n    persistence,\r\n  };\r\n};\r\n\r\nexport const useEmployeeStore = useEmployeeStoreHook as EmployeeStoreHook;\r\n\r\n// Export getState for non-hook usage\r\nuseEmployeeStore.getState = (): EmployeeStoreState => {\r\n  const state = baseStore.getState();\r\n  return {\r\n    ...state,\r\n    ...augmentedMethods,\r\n    persistence,\r\n  };\r\n};\r\n\r\nuseEmployeeStore.persistence = persistence;\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1309, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/stock-history/store.ts"],"sourcesContent":["import { create } from 'zustand';\r\nimport { formatDate, formatDateTime, formatDateTimeSeconds, formatDateCustom, parseDate, getCurrentDate } from '@/lib/date-utils';\r\nimport type { StockHistoryEntry } from './types';\r\nimport { asSystemId } from '../../lib/id-types';\r\nimport type { SystemId } from '../../lib/id-types';\r\n// REMOVED: import { data as initialData } from './data'; // Mock data no longer used - database is source of truth\r\n\r\n// API sync helpers\r\nasync function syncToAPI(action: 'create', data: any): Promise<boolean> {\r\n  try {\r\n    const response = await fetch('/api/inventory/stock-history', {\r\n      method: 'POST',\r\n      headers: { 'Content-Type': 'application/json' },\r\n      body: JSON.stringify(data),\r\n    });\r\n    \r\n    if (!response.ok) {\r\n      console.error(`[StockHistory API] ${action} failed:`, await response.text());\r\n      return false;\r\n    }\r\n    return true;\r\n  } catch (error) {\r\n    console.error(`[StockHistory API] ${action} error:`, error);\r\n    return false;\r\n  }\r\n}\r\n\r\n// ‚ú® Migration helper: Convert SKU to systemId for old data\r\nfunction migrateHistoryData(entries: StockHistoryEntry[]): StockHistoryEntry[] {\r\n  // Map SKU ‚Üí systemId from products\r\n  const skuToSystemId: Record<string, string> = {\r\n    'DV-WEB-01': 'SP00000001',\r\n    'DV-WEB-02': 'SP00000002',\r\n    'DV-WEB-03': 'SP00000003',\r\n    'DV-MKT-01': 'SP00000004',\r\n    'DV-MKT-02': 'SP00000005',\r\n    'DV-MKT-03': 'SP00000006',\r\n    'DV-SEO-01': 'SP00000007',\r\n    'DV-SEO-02': 'SP00000008',\r\n    'DV-IT-01': 'SP00000009',\r\n    'DV-DSN-01': 'SP00000010',\r\n    'SW-CRM-01': 'SP00000011',\r\n    'SW-ERP-01': 'SP00000012',\r\n    'SW-WIN-01': 'SP00000013',\r\n    'SW-OFF-01': 'SP00000014',\r\n    'SW-ADOBE-01': 'SP00000015',\r\n    'HW-SRV-01': 'SP00000016',\r\n    'HW-SRV-02': 'SP00000017',\r\n    'HW-PC-01': 'SP00000018',\r\n    'HW-PC-02': 'SP00000019',\r\n    'HW-LT-01': 'SP00000020',\r\n    'HW-NET-01': 'SP00000021',\r\n    'HW-NET-02': 'SP00000022',\r\n    'HW-CAM-01': 'SP00000023',\r\n    'MISC-HOST-01': 'SP00000024',\r\n    'MISC-HOST-02': 'SP00000025',\r\n    'MISC-SSL-01': 'SP00000026',\r\n    'MISC-DOMAIN-COM': 'SP00000027',\r\n    'MISC-DOMAIN-VN': 'SP00000028',\r\n    'MISC-PRINT-01': 'SP00000029',\r\n    'MISC-PRINT-02': 'SP00000030',\r\n  };\r\n  \r\n  return entries.map(entry => ({\r\n    ...entry,\r\n    productId: asSystemId(skuToSystemId[entry.productId as any] || entry.productId) // Convert or keep if already systemId\r\n  }));\r\n}\r\n\r\ninterface StockHistoryState {\r\n  entries: StockHistoryEntry[];\r\n  initialized: boolean;\r\n  addEntry: (entry: Omit<StockHistoryEntry, 'systemId'>) => void;\r\n  getHistoryForProduct: (productId: SystemId, branchSystemId?: 'all' | SystemId) => StockHistoryEntry[];\r\n  loadFromAPI: () => Promise<void>;\r\n}\r\n\r\nlet entryCounter = 0;\r\n\r\nexport const useStockHistoryStore = create<StockHistoryState>()(\r\n  (set, get) => ({\r\n      entries: [], // Database is source of truth\r\n      initialized: false,\r\n      \r\n      addEntry: (entry) => {\r\n        entryCounter++;\r\n        const newEntry: StockHistoryEntry = {\r\n            ...entry,\r\n            systemId: asSystemId(`HISTORY${String(Date.now()).slice(-6)}_${entryCounter}`),\r\n        };\r\n        set((state) => ({ entries: [...state.entries, newEntry] }));\r\n        // Sync to API\r\n        syncToAPI('create', newEntry).catch(console.error);\r\n      },\r\n      \r\n      getHistoryForProduct: (productId, branchSystemId = 'all') => {\r\n          const productHistory = get().entries.filter(e => e.productId === productId);\r\n          const sortedHistory = productHistory.sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime());\r\n\r\n          if (branchSystemId === 'all') {\r\n            return sortedHistory;\r\n          }\r\n          return sortedHistory.filter(e => e.branchSystemId === branchSystemId);\r\n        },\r\n      \r\n      loadFromAPI: async () => {\r\n        try {\r\n          // NOTE: Use React Query hooks for paginated data. This only loads initial batch.\r\n          const response = await fetch('/api/inventory/stock-history?limit=30');\r\n          if (!response.ok) return;\r\n          const json = await response.json();\r\n          const apiData = json.data || [];\r\n          if (apiData.length > 0) {\r\n            set({ entries: migrateHistoryData(apiData), initialized: true });\r\n          } else {\r\n            set({ initialized: true });\r\n          }\r\n        } catch (error) {\r\n          console.error('[StockHistory API] loadFromAPI error:', error);\r\n        }\r\n      },\r\n    })\r\n);\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1431, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/cashbook/store.ts"],"sourcesContent":["import { create } from 'zustand';\r\n// REMOVED: import { data as initialData } from './data'; // Mock data no longer used - database is source of truth\r\nimport type { CashAccount } from './types';\r\nimport { findNextAvailableBusinessId, generateSystemId, getMaxBusinessIdCounter, getMaxSystemIdCounter, type EntityType } from '../../lib/id-utils';\r\nimport { asBusinessId, asSystemId, type BusinessId, type SystemId } from '../../lib/id-types';\r\n\r\nconst CASH_ACCOUNT_ENTITY: EntityType = 'cash-accounts';\r\nconst SYSTEM_ID_PREFIX = 'ACCOUNT';\r\nconst BUSINESS_ID_PREFIX = 'TK';\r\nconst BUSINESS_ID_DIGITS = 6;\r\n\r\n// API sync helpers\r\nasync function syncToAPI(action: 'create' | 'update' | 'delete', data: any): Promise<boolean> {\r\n  try {\r\n    const endpoint = action === 'create' ? '/api/cash-accounts' : `/api/cash-accounts/${data.systemId}`;\r\n    const method = action === 'create' ? 'POST' : action === 'update' ? 'PATCH' : 'DELETE';\r\n    \r\n    const response = await fetch(endpoint, {\r\n      method,\r\n      headers: { 'Content-Type': 'application/json' },\r\n      body: action !== 'delete' ? JSON.stringify(data) : undefined,\r\n    });\r\n    \r\n    if (!response.ok) {\r\n      console.error(`[Cashbook API] ${action} failed:`, await response.text());\r\n      return false;\r\n    }\r\n    return true;\r\n  } catch (error) {\r\n    console.error(`[Cashbook API] ${action} error:`, error);\r\n    return false;\r\n  }\r\n}\r\n\r\nasync function fetchFromAPI(): Promise<CashAccount[]> {\r\n  try {\r\n    const response = await fetch('/api/cash-accounts?limit=50');\r\n    if (!response.ok) return [];\r\n    const json = await response.json();\r\n    return json.data || [];\r\n  } catch (error) {\r\n    console.error('[Cashbook API] fetch error:', error);\r\n    return [];\r\n  }\r\n}\r\n\r\ninterface CashbookState {\r\n  accounts: CashAccount[];\r\n  initialized: boolean;\r\n  getAccountById: (id: BusinessId) => CashAccount | undefined;\r\n  add: (item: Omit<CashAccount, 'systemId'>) => void;\r\n  update: (systemId: SystemId, item: CashAccount) => void;\r\n  remove: (systemId: SystemId) => void;\r\n  setDefault: (systemId: SystemId) => void;\r\n  loadFromAPI: () => Promise<void>;\r\n}\r\n\r\nconst getNextSystemId = (accounts: CashAccount[]): SystemId => {\r\n  const currentCounter = getMaxSystemIdCounter(accounts, SYSTEM_ID_PREFIX);\r\n  return asSystemId(generateSystemId(CASH_ACCOUNT_ENTITY, currentCounter + 1));\r\n};\r\n\r\nconst ensureBusinessId = (accounts: CashAccount[], provided?: BusinessId): BusinessId => {\r\n  if (provided && provided.trim()) {\r\n    return provided;\r\n  }\r\n\r\n  const existingIds = accounts.map(acc => acc.id as string);\r\n  const startCounter = getMaxBusinessIdCounter(accounts, BUSINESS_ID_PREFIX);\r\n  const { nextId } = findNextAvailableBusinessId(BUSINESS_ID_PREFIX, existingIds, startCounter, BUSINESS_ID_DIGITS);\r\n  return asBusinessId(nextId);\r\n};\r\n\r\nexport const useCashbookStore = create<CashbookState>()(\r\n  (set, get) => ({\r\n      accounts: [],\r\n      initialized: false,\r\n      getAccountById: (id) => get().accounts.find(a => a.id === id),\r\n      \r\n      add: (item) => {\r\n        const newAccount: CashAccount = {\r\n          ...item,\r\n          systemId: getNextSystemId(get().accounts),\r\n          id: ensureBusinessId(get().accounts, item.id),\r\n        };\r\n        set((state) => ({ accounts: [...state.accounts, newAccount] }));\r\n        // Sync to API\r\n        syncToAPI('create', newAccount).catch(console.error);\r\n      },\r\n      \r\n      update: (systemId, updatedItem) => {\r\n        set((state) => ({\r\n          accounts: state.accounts.map((acc) => (acc.systemId === systemId ? updatedItem : acc))\r\n        }));\r\n        // Sync to API\r\n        syncToAPI('update', updatedItem).catch(console.error);\r\n      },\r\n      \r\n      remove: (systemId) => {\r\n        set((state) => ({\r\n          accounts: state.accounts.filter(acc => acc.systemId !== systemId)\r\n        }));\r\n        // Sync to API\r\n        syncToAPI('delete', { systemId }).catch(console.error);\r\n      },\r\n      \r\n      setDefault: (systemId) => {\r\n        set((state) => {\r\n          const targetAccount = state.accounts.find(acc => acc.systemId === systemId);\r\n          if (!targetAccount) return state;\r\n\r\n          const updated = state.accounts.map(acc => ({\r\n            ...acc,\r\n            isDefault: (acc.type === targetAccount.type ? acc.systemId === systemId : acc.isDefault) ?? false\r\n          }));\r\n          \r\n          // Sync updated accounts to API\r\n          updated.forEach(acc => {\r\n            if (acc.type === targetAccount.type) {\r\n              syncToAPI('update', acc).catch(console.error);\r\n            }\r\n          });\r\n          \r\n          return { accounts: updated };\r\n        });\r\n      },\r\n      \r\n      loadFromAPI: async () => {\r\n        const apiData = await fetchFromAPI();\r\n        if (apiData.length > 0) {\r\n          set({ accounts: apiData, initialized: true });\r\n        } else {\r\n          set({ initialized: true });\r\n        }\r\n      },\r\n    })\r\n);\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1563, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/finance/document-lookups.ts"],"sourcesContent":["import { useTargetGroupStore } from '@/features/settings/target-groups/store';\r\nimport { usePaymentMethodStore } from '@/features/settings/payments/methods/store';\r\nimport { useCashbookStore } from '@/features/cashbook/store';\r\nimport { useReceiptTypeStore } from '@/features/settings/receipt-types/store';\r\nimport { usePaymentTypeStore } from '@/features/settings/payments/types/store';\r\nimport type { TargetGroup } from '@/features/settings/target-groups/types';\r\nimport type { PaymentMethod } from '@/features/settings/payments/methods/types';\r\nimport type { CashAccount } from '@/features/cashbook/types';\r\nimport type { ReceiptType } from '@/features/settings/receipt-types/types';\r\nimport type { PaymentType } from '@/features/settings/payments/types/types';\r\nimport type { SystemId } from '@/lib/id-types';\r\n\r\nconst normalizeName = (value?: string | null) => (value ?? '').trim().toLowerCase();\r\n\r\nexport const DEFAULT_CUSTOMER_GROUP = 'kh√°ch h√†ng';\r\n\r\nexport const pickTargetGroup = (options?: {\r\n  systemId?: SystemId | undefined;\r\n  name?: string | undefined;\r\n  fallbackName?: string | undefined;\r\n}): TargetGroup | null => {\r\n  const groups = useTargetGroupStore.getState().data ?? [];\r\n  if (groups.length === 0) {\r\n    return null;\r\n  }\r\n\r\n  if (options?.systemId) {\r\n    const match = groups.find(group => group.systemId === options.systemId);\r\n    if (match) {\r\n      return match;\r\n    }\r\n  }\r\n\r\n  const lookupNames = [options?.name, options?.fallbackName, DEFAULT_CUSTOMER_GROUP].filter(Boolean) as string[];\r\n  for (const candidate of lookupNames) {\r\n    const normalized = normalizeName(candidate);\r\n    const match = groups.find(group => normalizeName(group.name) === normalized);\r\n    if (match) {\r\n      return match;\r\n    }\r\n  }\r\n\r\n  return groups[0] ?? null;\r\n};\r\n\r\nexport const pickPaymentMethod = (options?: {\r\n  systemId?: SystemId | undefined;\r\n  name?: string | undefined;\r\n}): PaymentMethod | null => {\r\n  const methods = usePaymentMethodStore.getState().data ?? [];\r\n  if (methods.length === 0) {\r\n    return null;\r\n  }\r\n\r\n  if (options?.systemId) {\r\n    const match = methods.find(method => method.systemId === options.systemId);\r\n    if (match) {\r\n      return match;\r\n    }\r\n  }\r\n\r\n  if (options?.name) {\r\n    const normalized = normalizeName(options.name);\r\n    const match = methods.find(method => normalizeName(method.name) === normalized);\r\n    if (match) {\r\n      return match;\r\n    }\r\n  }\r\n\r\n  return methods.find(method => method.isDefault) ?? methods[0] ?? null;\r\n};\r\n\r\nexport const pickAccount = (options: {\r\n  accountSystemId?: SystemId | undefined;\r\n  preferredType?: 'cash' | 'bank' | undefined;\r\n  branchSystemId?: SystemId | undefined;\r\n  paymentMethodName?: string | undefined;\r\n}): CashAccount | null => {\r\n  const { accounts } = useCashbookStore.getState();\r\n  if (!accounts || accounts.length === 0) {\r\n    return null;\r\n  }\r\n\r\n  if (options.accountSystemId) {\r\n    const match = accounts.find(account => account.systemId === options.accountSystemId);\r\n    if (match) {\r\n      return match;\r\n    }\r\n  }\r\n\r\n  let preferredType = options.preferredType;\r\n  if (!preferredType && options.paymentMethodName) {\r\n    const normalizedMethod = normalizeName(options.paymentMethodName);\r\n    preferredType = normalizedMethod === 'ti·ªÅn m·∫∑t' ? 'cash' : normalizedMethod === 'chuy·ªÉn kho·∫£n' ? 'bank' : undefined;\r\n  }\r\n\r\n  const candidates = preferredType ? accounts.filter(account => account.type === preferredType) : accounts;\r\n\r\n  if (candidates.length === 0) {\r\n    return accounts[0];\r\n  }\r\n\r\n  return (\r\n    candidates.find(account => account.branchSystemId && options.branchSystemId && account.branchSystemId === options.branchSystemId) ??\r\n    candidates.find(account => account.isDefault) ??\r\n    candidates[0]\r\n  );\r\n};\r\n\r\nexport const pickReceiptType = (options?: {\r\n  systemId?: SystemId | undefined;\r\n  name?: string | undefined;\r\n}): ReceiptType | null => {\r\n  const types = useReceiptTypeStore.getState().data ?? [];\r\n  if (types.length === 0) {\r\n    return null;\r\n  }\r\n\r\n  if (options?.systemId) {\r\n    const match = types.find(type => type.systemId === options.systemId);\r\n    if (match) {\r\n      return match;\r\n    }\r\n  }\r\n\r\n  if (options?.name) {\r\n    const normalized = normalizeName(options.name);\r\n    const match = types.find(type => normalizeName(type.name) === normalized);\r\n    if (match) {\r\n      return match;\r\n    }\r\n  }\r\n\r\n  return types[0] ?? null;\r\n};\r\n\r\nexport const pickPaymentType = (options?: {\r\n  systemId?: SystemId | undefined;\r\n  name?: string | undefined;\r\n}): PaymentType | null => {\r\n  const types = usePaymentTypeStore.getState().data ?? [];\r\n  if (types.length === 0) {\r\n    return null;\r\n  }\r\n\r\n  if (options?.systemId) {\r\n    const match = types.find(type => type.systemId === options.systemId);\r\n    if (match) {\r\n      return match;\r\n    }\r\n  }\r\n\r\n  if (options?.name) {\r\n    const normalized = normalizeName(options.name);\r\n    const match = types.find(type => normalizeName(type.name) === normalized);\r\n    if (match) {\r\n      return match;\r\n    }\r\n  }\r\n\r\n  return types[0] ?? null;\r\n};\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1700, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/finance/document-helpers.ts"],"sourcesContent":["import { toISODateTime } from '@/lib/date-utils';\r\nimport { asBusinessId, type BusinessId, type SystemId } from '@/lib/id-types';\r\nimport { useReceiptStore, type ReceiptInput } from '@/features/receipts/store';\r\nimport type { Receipt } from '@/features/receipts/types';\r\nimport { usePaymentStore, type PaymentInput } from '@/features/payments/store';\r\nimport type { Payment } from '@/features/payments/types';\r\nimport { pickAccount, pickPaymentMethod, pickPaymentType, pickReceiptType, pickTargetGroup } from '@/features/finance/document-lookups';\r\n\r\nconst asBusinessIdOrUndefined = (value?: string | BusinessId | null) => {\r\n  if (!value) {\r\n    return undefined;\r\n  }\r\n  return typeof value === 'string' ? asBusinessId(value) : value;\r\n};\r\n\r\ninterface ReceiptDocumentOptions {\r\n  amount: number;\r\n  description: string;\r\n  customerName: string;\r\n  branchSystemId: SystemId;\r\n  branchName: string;\r\n  createdBy: SystemId;\r\n  customerSystemId?: SystemId;\r\n  paymentMethodSystemId?: SystemId;\r\n  paymentMethodName?: string;\r\n  accountSystemId?: SystemId;\r\n  accountPreference?: 'cash' | 'bank';\r\n  receiptTypeSystemId?: SystemId;\r\n  receiptTypeName?: string;\r\n  payerTargetGroupSystemId?: SystemId;\r\n  payerTargetGroupName?: string;\r\n  originalDocumentId?: string | BusinessId;\r\n  linkedOrderSystemId?: SystemId;\r\n  linkedSalesReturnSystemId?: SystemId;\r\n  linkedWarrantySystemId?: SystemId;\r\n  linkedComplaintSystemId?: SystemId;\r\n  category?: Receipt['category'];\r\n  affectsDebt?: boolean;\r\n  status?: Receipt['status'];\r\n  date?: string;\r\n}\r\n\r\ninterface PaymentDocumentOptions {\r\n  amount: number;\r\n  description: string;\r\n  recipientName: string;\r\n  branchSystemId: SystemId;\r\n  branchName: string;\r\n  createdBy: SystemId;\r\n  recipientSystemId?: SystemId;\r\n  customerSystemId?: SystemId;\r\n  customerName?: string;\r\n  paymentMethodSystemId?: SystemId;\r\n  paymentMethodName?: string;\r\n  accountSystemId?: SystemId;\r\n  accountPreference?: 'cash' | 'bank';\r\n  paymentTypeSystemId?: SystemId;\r\n  paymentTypeName?: string;\r\n  recipientTargetGroupSystemId?: SystemId;\r\n  recipientTargetGroupName?: string;\r\n  originalDocumentId?: string | BusinessId;\r\n  linkedOrderSystemId?: SystemId;\r\n  linkedSalesReturnSystemId?: SystemId;\r\n  linkedWarrantySystemId?: SystemId;\r\n  linkedComplaintSystemId?: SystemId;\r\n  category?: Payment['category'];\r\n  affectsDebt?: boolean;\r\n  status?: Payment['status'];\r\n  date?: string;\r\n}\r\n\r\nexport interface DocumentCreationResult<T> {\r\n  document: T | null;\r\n  error?: string;\r\n}\r\n\r\nexport const createReceiptDocument = (options: ReceiptDocumentOptions): DocumentCreationResult<Receipt> => {\r\n  if (!options.branchSystemId) {\r\n    return { document: null, error: 'Thi·∫øu m√£ chi nh√°nh khi t·∫°o phi·∫øu thu.' };\r\n  }\r\n\r\n  const targetGroup = pickTargetGroup({\r\n    systemId: options.payerTargetGroupSystemId,\r\n    name: options.payerTargetGroupName,\r\n  });\r\n  if (!targetGroup) {\r\n    return { document: null, error: 'Ch∆∞a c·∫•u h√¨nh nh√≥m ƒë·ªëi t∆∞·ª£ng (Target Group) cho phi·∫øu thu.' };\r\n  }\r\n\r\n  const paymentMethod = pickPaymentMethod({\r\n    systemId: options.paymentMethodSystemId,\r\n    name: options.paymentMethodName,\r\n  });\r\n  if (!paymentMethod) {\r\n    return { document: null, error: 'Ch∆∞a c·∫•u h√¨nh ph∆∞∆°ng th·ª©c thu ti·ªÅn.' };\r\n  }\r\n\r\n  const account = pickAccount({\r\n    accountSystemId: options.accountSystemId,\r\n    preferredType: options.accountPreference,\r\n    branchSystemId: options.branchSystemId,\r\n    paymentMethodName: paymentMethod.name,\r\n  });\r\n  if (!account) {\r\n    return { document: null, error: 'Ch∆∞a c·∫•u h√¨nh t√†i kho·∫£n qu·ªπ ph√π h·ª£p ƒë·ªÉ t·∫°o phi·∫øu thu.' };\r\n  }\r\n\r\n  const receiptType = pickReceiptType({\r\n    systemId: options.receiptTypeSystemId,\r\n    name: options.receiptTypeName,\r\n  });\r\n  if (!receiptType) {\r\n    return { document: null, error: 'Ch∆∞a c·∫•u h√¨nh lo·∫°i phi·∫øu thu.' };\r\n  }\r\n\r\n  const timestamp = options.date ?? toISODateTime(new Date());\r\n  const payload: ReceiptInput = {\r\n    date: timestamp,\r\n    amount: options.amount,\r\n    payerTypeSystemId: targetGroup.systemId,\r\n    payerTypeName: targetGroup.name,\r\n    payerName: options.customerName,\r\n    payerSystemId: options.customerSystemId,\r\n    description: options.description,\r\n    paymentMethodSystemId: paymentMethod.systemId,\r\n    paymentMethodName: paymentMethod.name,\r\n    accountSystemId: account.systemId,\r\n    paymentReceiptTypeSystemId: receiptType.systemId,\r\n    paymentReceiptTypeName: receiptType.name,\r\n    branchSystemId: options.branchSystemId,\r\n    branchName: options.branchName,\r\n    createdBy: options.createdBy,\r\n    createdAt: timestamp,\r\n    status: options.status ?? 'completed',\r\n    category: options.category,\r\n    originalDocumentId: asBusinessIdOrUndefined(options.originalDocumentId),\r\n    linkedOrderSystemId: options.linkedOrderSystemId,\r\n    linkedSalesReturnSystemId: options.linkedSalesReturnSystemId,\r\n    linkedWarrantySystemId: options.linkedWarrantySystemId,\r\n    linkedComplaintSystemId: options.linkedComplaintSystemId,\r\n    customerSystemId: options.customerSystemId,\r\n    customerName: options.customerName,\r\n    affectsDebt: options.affectsDebt ?? true,\r\n  };\r\n\r\n  const receipt = useReceiptStore.getState().add(payload);\r\n  return { document: receipt };\r\n};\r\n\r\nexport const createPaymentDocument = (options: PaymentDocumentOptions): DocumentCreationResult<Payment> => {\r\n  if (!options.branchSystemId) {\r\n    return { document: null, error: 'Thi·∫øu m√£ chi nh√°nh khi t·∫°o phi·∫øu chi.' };\r\n  }\r\n\r\n  const targetGroup = pickTargetGroup({\r\n    systemId: options.recipientTargetGroupSystemId,\r\n    name: options.recipientTargetGroupName,\r\n  });\r\n  if (!targetGroup) {\r\n    return { document: null, error: 'Ch∆∞a c·∫•u h√¨nh nh√≥m ƒë·ªëi t∆∞·ª£ng (Target Group) cho phi·∫øu chi.' };\r\n  }\r\n\r\n  const paymentMethod = pickPaymentMethod({\r\n    systemId: options.paymentMethodSystemId,\r\n    name: options.paymentMethodName,\r\n  });\r\n  if (!paymentMethod) {\r\n    return { document: null, error: 'Ch∆∞a c·∫•u h√¨nh ph∆∞∆°ng th·ª©c chi ti·ªÅn.' };\r\n  }\r\n\r\n  const account = pickAccount({\r\n    accountSystemId: options.accountSystemId,\r\n    preferredType: options.accountPreference,\r\n    branchSystemId: options.branchSystemId,\r\n    paymentMethodName: paymentMethod.name,\r\n  });\r\n  if (!account) {\r\n    return { document: null, error: 'Ch∆∞a c·∫•u h√¨nh t√†i kho·∫£n qu·ªπ ph√π h·ª£p ƒë·ªÉ t·∫°o phi·∫øu chi.' };\r\n  }\r\n\r\n  const paymentType = pickPaymentType({\r\n    systemId: options.paymentTypeSystemId,\r\n    name: options.paymentTypeName,\r\n  });\r\n  if (!paymentType) {\r\n    return { document: null, error: 'Ch∆∞a c·∫•u h√¨nh lo·∫°i phi·∫øu chi.' };\r\n  }\r\n\r\n  const timestamp = options.date ?? toISODateTime(new Date());\r\n  const payload: PaymentInput = {\r\n    date: timestamp,\r\n    amount: options.amount,\r\n    recipientTypeSystemId: targetGroup.systemId,\r\n    recipientTypeName: targetGroup.name,\r\n    recipientName: options.recipientName,\r\n    recipientSystemId: options.recipientSystemId,\r\n    description: options.description,\r\n    paymentMethodSystemId: paymentMethod.systemId,\r\n    paymentMethodName: paymentMethod.name,\r\n    accountSystemId: account.systemId,\r\n    paymentReceiptTypeSystemId: paymentType.systemId,\r\n    paymentReceiptTypeName: paymentType.name,\r\n    branchSystemId: options.branchSystemId,\r\n    branchName: options.branchName,\r\n    createdBy: options.createdBy,\r\n    createdAt: timestamp,\r\n    status: options.status ?? 'completed',\r\n    category: options.category,\r\n    originalDocumentId: asBusinessIdOrUndefined(options.originalDocumentId),\r\n    linkedOrderSystemId: options.linkedOrderSystemId,\r\n    linkedSalesReturnSystemId: options.linkedSalesReturnSystemId,\r\n    linkedWarrantySystemId: options.linkedWarrantySystemId,\r\n    linkedComplaintSystemId: options.linkedComplaintSystemId,\r\n    customerSystemId: options.customerSystemId,\r\n    customerName: options.customerName ?? options.recipientName,\r\n    affectsDebt: options.affectsDebt ?? true,\r\n  };\r\n\r\n  const payment = usePaymentStore.getState().add(payload);\r\n  return { document: payment };\r\n};\r\n"],"names":[],"mappings":";;;;;;AAAA;AACA;AACA;AAEA;AAEA;;;;;;AAEA,MAAM,0BAA0B,CAAC;IAC/B,IAAI,CAAC,OAAO;QACV,OAAO;IACT;IACA,OAAO,OAAO,UAAU,WAAW,IAAA,kIAAY,EAAC,SAAS;AAC3D;AA+DO,MAAM,wBAAwB,CAAC;IACpC,IAAI,CAAC,QAAQ,cAAc,EAAE;QAC3B,OAAO;YAAE,UAAU;YAAM,OAAO;QAAwC;IAC1E;IAEA,MAAM,cAAc,IAAA,6JAAe,EAAC;QAClC,UAAU,QAAQ,wBAAwB;QAC1C,MAAM,QAAQ,oBAAoB;IACpC;IACA,IAAI,CAAC,aAAa;QAChB,OAAO;YAAE,UAAU;YAAM,OAAO;QAA6D;IAC/F;IAEA,MAAM,gBAAgB,IAAA,+JAAiB,EAAC;QACtC,UAAU,QAAQ,qBAAqB;QACvC,MAAM,QAAQ,iBAAiB;IACjC;IACA,IAAI,CAAC,eAAe;QAClB,OAAO;YAAE,UAAU;YAAM,OAAO;QAAsC;IACxE;IAEA,MAAM,UAAU,IAAA,yJAAW,EAAC;QAC1B,iBAAiB,QAAQ,eAAe;QACxC,eAAe,QAAQ,iBAAiB;QACxC,gBAAgB,QAAQ,cAAc;QACtC,mBAAmB,cAAc,IAAI;IACvC;IACA,IAAI,CAAC,SAAS;QACZ,OAAO;YAAE,UAAU;YAAM,OAAO;QAAwD;IAC1F;IAEA,MAAM,cAAc,IAAA,6JAAe,EAAC;QAClC,UAAU,QAAQ,mBAAmB;QACrC,MAAM,QAAQ,eAAe;IAC/B;IACA,IAAI,CAAC,aAAa;QAChB,OAAO;YAAE,UAAU;YAAM,OAAO;QAAgC;IAClE;IAEA,MAAM,YAAY,QAAQ,IAAI,IAAI,IAAA,qIAAa,EAAC,IAAI;IACpD,MAAM,UAAwB;QAC5B,MAAM;QACN,QAAQ,QAAQ,MAAM;QACtB,mBAAmB,YAAY,QAAQ;QACvC,eAAe,YAAY,IAAI;QAC/B,WAAW,QAAQ,YAAY;QAC/B,eAAe,QAAQ,gBAAgB;QACvC,aAAa,QAAQ,WAAW;QAChC,uBAAuB,cAAc,QAAQ;QAC7C,mBAAmB,cAAc,IAAI;QACrC,iBAAiB,QAAQ,QAAQ;QACjC,4BAA4B,YAAY,QAAQ;QAChD,wBAAwB,YAAY,IAAI;QACxC,gBAAgB,QAAQ,cAAc;QACtC,YAAY,QAAQ,UAAU;QAC9B,WAAW,QAAQ,SAAS;QAC5B,WAAW;QACX,QAAQ,QAAQ,MAAM,IAAI;QAC1B,UAAU,QAAQ,QAAQ;QAC1B,oBAAoB,wBAAwB,QAAQ,kBAAkB;QACtE,qBAAqB,QAAQ,mBAAmB;QAChD,2BAA2B,QAAQ,yBAAyB;QAC5D,wBAAwB,QAAQ,sBAAsB;QACtD,yBAAyB,QAAQ,uBAAuB;QACxD,kBAAkB,QAAQ,gBAAgB;QAC1C,cAAc,QAAQ,YAAY;QAClC,aAAa,QAAQ,WAAW,IAAI;IACtC;IAEA,MAAM,UAAU,gJAAe,CAAC,QAAQ,GAAG,GAAG,CAAC;IAC/C,OAAO;QAAE,UAAU;IAAQ;AAC7B;AAEO,MAAM,wBAAwB,CAAC;IACpC,IAAI,CAAC,QAAQ,cAAc,EAAE;QAC3B,OAAO;YAAE,UAAU;YAAM,OAAO;QAAwC;IAC1E;IAEA,MAAM,cAAc,IAAA,6JAAe,EAAC;QAClC,UAAU,QAAQ,4BAA4B;QAC9C,MAAM,QAAQ,wBAAwB;IACxC;IACA,IAAI,CAAC,aAAa;QAChB,OAAO;YAAE,UAAU;YAAM,OAAO;QAA6D;IAC/F;IAEA,MAAM,gBAAgB,IAAA,+JAAiB,EAAC;QACtC,UAAU,QAAQ,qBAAqB;QACvC,MAAM,QAAQ,iBAAiB;IACjC;IACA,IAAI,CAAC,eAAe;QAClB,OAAO;YAAE,UAAU;YAAM,OAAO;QAAsC;IACxE;IAEA,MAAM,UAAU,IAAA,yJAAW,EAAC;QAC1B,iBAAiB,QAAQ,eAAe;QACxC,eAAe,QAAQ,iBAAiB;QACxC,gBAAgB,QAAQ,cAAc;QACtC,mBAAmB,cAAc,IAAI;IACvC;IACA,IAAI,CAAC,SAAS;QACZ,OAAO;YAAE,UAAU;YAAM,OAAO;QAAwD;IAC1F;IAEA,MAAM,cAAc,IAAA,6JAAe,EAAC;QAClC,UAAU,QAAQ,mBAAmB;QACrC,MAAM,QAAQ,eAAe;IAC/B;IACA,IAAI,CAAC,aAAa;QAChB,OAAO;YAAE,UAAU;YAAM,OAAO;QAAgC;IAClE;IAEA,MAAM,YAAY,QAAQ,IAAI,IAAI,IAAA,qIAAa,EAAC,IAAI;IACpD,MAAM,UAAwB;QAC5B,MAAM;QACN,QAAQ,QAAQ,MAAM;QACtB,uBAAuB,YAAY,QAAQ;QAC3C,mBAAmB,YAAY,IAAI;QACnC,eAAe,QAAQ,aAAa;QACpC,mBAAmB,QAAQ,iBAAiB;QAC5C,aAAa,QAAQ,WAAW;QAChC,uBAAuB,cAAc,QAAQ;QAC7C,mBAAmB,cAAc,IAAI;QACrC,iBAAiB,QAAQ,QAAQ;QACjC,4BAA4B,YAAY,QAAQ;QAChD,wBAAwB,YAAY,IAAI;QACxC,gBAAgB,QAAQ,cAAc;QACtC,YAAY,QAAQ,UAAU;QAC9B,WAAW,QAAQ,SAAS;QAC5B,WAAW;QACX,QAAQ,QAAQ,MAAM,IAAI;QAC1B,UAAU,QAAQ,QAAQ;QAC1B,oBAAoB,wBAAwB,QAAQ,kBAAkB;QACtE,qBAAqB,QAAQ,mBAAmB;QAChD,2BAA2B,QAAQ,yBAAyB;QAC5D,wBAAwB,QAAQ,sBAAsB;QACtD,yBAAyB,QAAQ,uBAAuB;QACxD,kBAAkB,QAAQ,gBAAgB;QAC1C,cAAc,QAAQ,YAAY,IAAI,QAAQ,aAAa;QAC3D,aAAa,QAAQ,WAAW,IAAI;IACtC;IAEA,MAAM,UAAU,gJAAe,CAAC,QAAQ,GAAG,GAAG,CAAC;IAC/C,OAAO;QAAE,UAAU;IAAQ;AAC7B"}},
    {"offset": {"line": 1892, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/receipts/store.ts"],"sourcesContent":["import { create } from 'zustand';\r\nimport { subscribeWithSelector } from 'zustand/middleware';\r\nimport type { Receipt } from './types';\r\nimport type { HistoryEntry } from '../../components/ActivityHistory';\r\nimport { \r\n  findNextAvailableBusinessId, \r\n  generateSystemId, \r\n  getMaxBusinessIdCounter, \r\n  getMaxSystemIdCounter,\r\n  extractCounterFromBusinessId,\r\n  type EntityType \r\n} from '@/lib/id-utils';\r\nimport { asSystemId, asBusinessId, type BusinessId, type SystemId } from '@/lib/id-types';\r\n// REMOVED: import { data as initialData } from './data'; // Mock data no longer used - database is source of truth\r\nimport { pickAccount, pickPaymentMethod, pickReceiptType, pickTargetGroup } from '@/features/finance/document-lookups';\r\nimport { useEmployeeStore } from '../employees/store';\r\nimport { getCurrentUserSystemId } from '../../contexts/auth-context';\r\n\r\n// API sync helpers\r\nasync function syncToAPI(action: 'create' | 'update' | 'delete', data: any): Promise<boolean> {\r\n  try {\r\n    const endpoint = action === 'create' ? '/api/receipts' : `/api/receipts/${data.systemId}`;\r\n    const method = action === 'create' ? 'POST' : action === 'update' ? 'PATCH' : 'DELETE';\r\n    \r\n    const response = await fetch(endpoint, {\r\n      method,\r\n      headers: { 'Content-Type': 'application/json' },\r\n      body: action !== 'delete' ? JSON.stringify(data) : undefined,\r\n    });\r\n    \r\n    if (!response.ok) {\r\n      console.error(`[Receipts API] ${action} failed:`, await response.text());\r\n      return false;\r\n    }\r\n    return true;\r\n  } catch (error) {\r\n    console.error(`[Receipts API] ${action} error:`, error);\r\n    return false;\r\n  }\r\n}\r\n\r\n// Helper to get current user info\r\nconst getCurrentUserInfo = () => {\r\n  const currentUserSystemId = getCurrentUserSystemId?.() || 'SYSTEM';\r\n  const employee = useEmployeeStore.getState().data.find(e => e.systemId === currentUserSystemId);\r\n  return {\r\n    systemId: currentUserSystemId,\r\n    name: employee?.fullName || 'H·ªá th·ªëng',\r\n    avatar: employee?.avatarUrl,\r\n  };\r\n};\r\n\r\n// Helper to create history entry\r\nconst createHistoryEntry = (\r\n  action: HistoryEntry['action'],\r\n  description: string,\r\n  metadata?: HistoryEntry['metadata']\r\n): HistoryEntry => ({\r\n  id: crypto.randomUUID(),\r\n  action,\r\n  timestamp: new Date(),\r\n  user: getCurrentUserInfo(),\r\n  description,\r\n  metadata,\r\n});\r\n\r\nconst SYSTEM_AUTHOR = asSystemId('SYSTEM');\r\nconst getCurrentReceiptAuthor = (): SystemId => {\r\n  const userId = getCurrentUserSystemId?.();\r\n  return userId ? asSystemId(userId) : SYSTEM_AUTHOR;\r\n};\r\n\r\nexport type ReceiptInput = Omit<Receipt, 'systemId' | 'id'> & { id?: BusinessId };\r\n\r\ninterface ReceiptStore {\r\n  data: Receipt[];\r\n  businessIdCounter: number;\r\n  systemIdCounter: number;\r\n  initialized: boolean;\r\n  add: (item: ReceiptInput) => Receipt;\r\n  addMultiple: (items: ReceiptInput[]) => void;\r\n  update: (systemId: SystemId, item: Receipt) => void;\r\n  remove: (systemId: SystemId) => void;\r\n  findById: (systemId: SystemId) => Receipt | undefined;\r\n  getActive: () => Receipt[];\r\n  cancel: (systemId: SystemId, reason?: string) => void;\r\n  loadFromAPI: () => Promise<void>;\r\n}\r\n\r\nconst RECEIPT_ENTITY: EntityType = 'receipts';\r\nconst SYSTEM_ID_PREFIX = 'RECEIPT';\r\nconst BUSINESS_ID_PREFIX = 'PT';\r\nconst BUSINESS_ID_DIGITS = 6;\r\n\r\nconst normalizeReceiptStatus = (status?: Receipt['status']): Receipt['status'] =>\r\n  status === 'cancelled' ? 'cancelled' : 'completed';\r\n\r\nconst ensureReceiptMetadata = (receipt: Receipt): Receipt => {\r\n  let mutated = false;\r\n  const updates: Partial<Receipt> = {};\r\n\r\n  const targetGroup = pickTargetGroup({\r\n    systemId: receipt.payerTypeSystemId,\r\n    name: receipt.payerTypeName,\r\n  });\r\n  if (targetGroup) {\r\n    if (receipt.payerTypeSystemId !== targetGroup.systemId) {\r\n      updates.payerTypeSystemId = targetGroup.systemId;\r\n      mutated = true;\r\n    }\r\n    if (receipt.payerTypeName !== targetGroup.name) {\r\n      updates.payerTypeName = targetGroup.name;\r\n      mutated = true;\r\n    }\r\n  }\r\n\r\n  const paymentMethod = pickPaymentMethod({\r\n    systemId: receipt.paymentMethodSystemId,\r\n    name: receipt.paymentMethodName,\r\n  });\r\n  if (paymentMethod) {\r\n    if (receipt.paymentMethodSystemId !== paymentMethod.systemId) {\r\n      updates.paymentMethodSystemId = paymentMethod.systemId;\r\n      mutated = true;\r\n    }\r\n    if (receipt.paymentMethodName !== paymentMethod.name) {\r\n      updates.paymentMethodName = paymentMethod.name;\r\n      mutated = true;\r\n    }\r\n  }\r\n\r\n  const account = pickAccount({\r\n    accountSystemId: receipt.accountSystemId,\r\n    branchSystemId: receipt.branchSystemId,\r\n    paymentMethodName: paymentMethod?.name ?? receipt.paymentMethodName,\r\n  });\r\n  if (account && receipt.accountSystemId !== account.systemId) {\r\n    updates.accountSystemId = account.systemId;\r\n    mutated = true;\r\n  }\r\n\r\n  const receiptType = pickReceiptType({\r\n    systemId: receipt.paymentReceiptTypeSystemId,\r\n    name: receipt.paymentReceiptTypeName,\r\n  });\r\n  if (receiptType) {\r\n    if (receipt.paymentReceiptTypeSystemId !== receiptType.systemId) {\r\n      updates.paymentReceiptTypeSystemId = receiptType.systemId;\r\n      mutated = true;\r\n    }\r\n    if (receipt.paymentReceiptTypeName !== receiptType.name) {\r\n      updates.paymentReceiptTypeName = receiptType.name;\r\n      mutated = true;\r\n    }\r\n  }\r\n\r\n  if (!receipt.customerName && receipt.payerName) {\r\n    updates.customerName = receipt.payerName;\r\n    mutated = true;\r\n  }\r\n\r\n  if (!receipt.customerSystemId && receipt.payerSystemId) {\r\n    updates.customerSystemId = receipt.payerSystemId;\r\n    mutated = true;\r\n  }\r\n\r\n  return mutated ? { ...receipt, ...updates } : receipt;\r\n};\r\n\r\nconst backfillReceiptMetadata = (receipts: Receipt[]): Receipt[] => {\r\n  let mutated = false;\r\n  const updated = receipts.map(receipt => {\r\n    const normalized = ensureReceiptMetadata(receipt);\r\n    if (normalized !== receipt) {\r\n      mutated = true;\r\n    }\r\n    return normalized;\r\n  });\r\n  return mutated ? updated : receipts;\r\n};\r\n\r\nconst initialReceipts: Receipt[] = []; // Database is source of truth\r\n\r\nlet systemIdCounter = getMaxSystemIdCounter(initialReceipts, SYSTEM_ID_PREFIX);\r\nlet businessIdCounter = getMaxBusinessIdCounter(initialReceipts, BUSINESS_ID_PREFIX);\r\n\r\nconst getNextSystemId = (): SystemId => {\r\n  systemIdCounter += 1;\r\n  return asSystemId(generateSystemId(RECEIPT_ENTITY, systemIdCounter));\r\n};\r\n\r\nconst ensureReceiptBusinessId = (receipts: Receipt[], provided?: BusinessId | string): BusinessId => {\r\n  if (provided && `${provided}`.trim().length > 0) {\r\n    const normalized = `${provided}`.trim().toUpperCase();\r\n    const parsedCounter = extractCounterFromBusinessId(normalized, BUSINESS_ID_PREFIX);\r\n    if (parsedCounter > businessIdCounter) {\r\n      businessIdCounter = parsedCounter;\r\n    }\r\n    return asBusinessId(normalized);\r\n  }\r\n\r\n  const existingIds = receipts.map(receipt => receipt.id as string).filter(Boolean);\r\n  const { nextId, updatedCounter } = findNextAvailableBusinessId(\r\n    BUSINESS_ID_PREFIX,\r\n    existingIds,\r\n    businessIdCounter,\r\n    BUSINESS_ID_DIGITS\r\n  );\r\n  businessIdCounter = updatedCounter;\r\n  return asBusinessId(nextId);\r\n};\r\n\r\nexport const useReceiptStore = create<ReceiptStore>()(\r\n  subscribeWithSelector(\r\n    (set, get) => ({\r\n      data: initialReceipts,\r\n      businessIdCounter,\r\n      systemIdCounter,\r\n      initialized: false,\r\n      \r\n      add: (item: ReceiptInput): Receipt => {\r\n        let createdReceipt: Receipt | null = null;\r\n        set(state => {\r\n          const systemId = getNextSystemId();\r\n          const id = ensureReceiptBusinessId(state.data, item.id);\r\n          const createdBy = item.createdBy ?? getCurrentReceiptAuthor();\r\n          \r\n          const newReceipt: Receipt = { \r\n            ...item, \r\n            systemId, \r\n            id,\r\n            createdBy,\r\n            createdAt: item.createdAt || new Date().toISOString(),\r\n            status: normalizeReceiptStatus(item.status),\r\n            orderAllocations: item.orderAllocations ?? [],\r\n          };\r\n\r\n          const normalizedReceipt = ensureReceiptMetadata(newReceipt);\r\n          createdReceipt = normalizedReceipt;\r\n\r\n          return { \r\n            data: [...state.data, normalizedReceipt],\r\n            businessIdCounter,\r\n            systemIdCounter\r\n          };\r\n        });\r\n        // Sync to API\r\n        if (createdReceipt) {\r\n          syncToAPI('create', createdReceipt).catch(console.error);\r\n        }\r\n        return createdReceipt!;\r\n      },\r\n      \r\n      addMultiple: (items: ReceiptInput[]) => {\r\n        const created: Receipt[] = [];\r\n        set(state => {\r\n          items.forEach(item => {\r\n            const context = [...state.data, ...created];\r\n            const systemId = getNextSystemId();\r\n            const id = ensureReceiptBusinessId(context, item.id);\r\n            const createdBy = item.createdBy ?? getCurrentReceiptAuthor();\r\n            \r\n            const newReceipt: Receipt = { \r\n              ...item, \r\n              systemId, \r\n              id,\r\n              createdBy,\r\n              createdAt: item.createdAt || new Date().toISOString(),\r\n              status: normalizeReceiptStatus(item.status),\r\n              orderAllocations: item.orderAllocations ?? [],\r\n            };\r\n            created.push(ensureReceiptMetadata(newReceipt));\r\n          });\r\n          \r\n          return { \r\n            data: [...state.data, ...created],\r\n            businessIdCounter,\r\n            systemIdCounter\r\n          };\r\n        });\r\n        // Sync all to API\r\n        created.forEach(receipt => {\r\n          syncToAPI('create', receipt).catch(console.error);\r\n        });\r\n      },\r\n      \r\n      update: (systemId: SystemId, item: Receipt) => {\r\n        const updated = { ...item, status: normalizeReceiptStatus(item.status), updatedAt: new Date().toISOString() };\r\n        set(state => ({\r\n          data: state.data.map(r => r.systemId === systemId ? updated : r),\r\n          businessIdCounter,\r\n          systemIdCounter\r\n        }));\r\n        // Sync to API\r\n        syncToAPI('update', updated).catch(console.error);\r\n      },\r\n      \r\n      remove: (systemId: SystemId) => {\r\n        set(state => ({\r\n          data: state.data.filter(r => r.systemId !== systemId),\r\n          businessIdCounter,\r\n          systemIdCounter\r\n        }));\r\n        // Sync to API\r\n        syncToAPI('delete', { systemId }).catch(console.error);\r\n      },\r\n      \r\n      findById: (systemId: SystemId) => {\r\n        return get().data.find(r => r.systemId === systemId);\r\n      },\r\n      \r\n      getActive: () => {\r\n        return get().data.filter(r => r.status !== 'cancelled');\r\n      },\r\n      \r\n      cancel: (systemId: SystemId, reason?: string) => {\r\n        const receipt = get().findById(systemId);\r\n        if (receipt && receipt.status !== 'cancelled') {\r\n          const historyEntry = createHistoryEntry(\r\n            'cancelled',\r\n            `ƒê√£ h·ªßy phi·∫øu thu${reason ? `: ${reason}` : ''}`,\r\n            { oldValue: 'Ho√†n th√†nh', newValue: 'ƒê√£ h·ªßy', note: reason }\r\n          );\r\n          \r\n          get().update(systemId, {\r\n            ...receipt,\r\n            status: 'cancelled',\r\n            cancelledAt: new Date().toISOString(),\r\n            activityHistory: [...(receipt.activityHistory || []), historyEntry],\r\n          });\r\n        }\r\n      },\r\n      \r\n      loadFromAPI: async () => {\r\n        try {\r\n          // NOTE: Use React Query hooks for paginated data. This only loads initial batch.\r\n          const response = await fetch('/api/receipts?limit=30');\r\n          if (!response.ok) return;\r\n          const json = await response.json();\r\n          const apiData = json.data || [];\r\n          if (apiData.length > 0) {\r\n            const normalized = backfillReceiptMetadata(apiData.map((receipt: Receipt) => ({\r\n              ...receipt,\r\n              status: normalizeReceiptStatus(receipt.status),\r\n            })));\r\n            const nextSystemCounter = getMaxSystemIdCounter(normalized, SYSTEM_ID_PREFIX);\r\n            const nextBusinessCounter = getMaxBusinessIdCounter(normalized, BUSINESS_ID_PREFIX);\r\n            systemIdCounter = nextSystemCounter;\r\n            businessIdCounter = nextBusinessCounter;\r\n            set({ \r\n              data: normalized, \r\n              systemIdCounter, \r\n              businessIdCounter,\r\n              initialized: true \r\n            });\r\n          } else {\r\n            set({ initialized: true });\r\n          }\r\n        } catch (error) {\r\n          console.error('[Receipts API] loadFromAPI error:', error);\r\n        }\r\n      },\r\n    })\r\n  )\r\n);\r\n"],"names":[],"mappings":";;;;AAAA;AACA;AAGA;AAQA;AACA,mHAAmH;AACnH;AACA;AACA;;;;;;;;AAEA,mBAAmB;AACnB,eAAe,UAAU,MAAsC,EAAE,IAAS;IACxE,IAAI;QACF,MAAM,WAAW,WAAW,WAAW,kBAAkB,CAAC,cAAc,EAAE,KAAK,QAAQ,EAAE;QACzF,MAAM,SAAS,WAAW,WAAW,SAAS,WAAW,WAAW,UAAU;QAE9E,MAAM,WAAW,MAAM,MAAM,UAAU;YACrC;YACA,SAAS;gBAAE,gBAAgB;YAAmB;YAC9C,MAAM,WAAW,WAAW,KAAK,SAAS,CAAC,QAAQ;QACrD;QAEA,IAAI,CAAC,SAAS,EAAE,EAAE;YAChB,QAAQ,KAAK,CAAC,CAAC,eAAe,EAAE,OAAO,QAAQ,CAAC,EAAE,MAAM,SAAS,IAAI;YACrE,OAAO;QACT;QACA,OAAO;IACT,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,CAAC,eAAe,EAAE,OAAO,OAAO,CAAC,EAAE;QACjD,OAAO;IACT;AACF;AAEA,kCAAkC;AAClC,MAAM,qBAAqB;IACzB,MAAM,sBAAsB,sJAAsB,QAAQ;IAC1D,MAAM,WAAW,kJAAgB,CAAC,QAAQ,GAAG,IAAI,CAAC,IAAI,CAAC,CAAA,IAAK,EAAE,QAAQ,KAAK;IAC3E,OAAO;QACL,UAAU;QACV,MAAM,UAAU,YAAY;QAC5B,QAAQ,UAAU;IACpB;AACF;AAEA,iCAAiC;AACjC,MAAM,qBAAqB,CACzB,QACA,aACA,WACiB,CAAC;QAClB,IAAI,OAAO,UAAU;QACrB;QACA,WAAW,IAAI;QACf,MAAM;QACN;QACA;IACF,CAAC;AAED,MAAM,gBAAgB,IAAA,gIAAU,EAAC;AACjC,MAAM,0BAA0B;IAC9B,MAAM,SAAS,sJAAsB;IACrC,OAAO,SAAS,IAAA,gIAAU,EAAC,UAAU;AACvC;AAmBA,MAAM,iBAA6B;AACnC,MAAM,mBAAmB;AACzB,MAAM,qBAAqB;AAC3B,MAAM,qBAAqB;AAE3B,MAAM,yBAAyB,CAAC,SAC9B,WAAW,cAAc,cAAc;AAEzC,MAAM,wBAAwB,CAAC;IAC7B,IAAI,UAAU;IACd,MAAM,UAA4B,CAAC;IAEnC,MAAM,cAAc,IAAA,6JAAe,EAAC;QAClC,UAAU,QAAQ,iBAAiB;QACnC,MAAM,QAAQ,aAAa;IAC7B;IACA,IAAI,aAAa;QACf,IAAI,QAAQ,iBAAiB,KAAK,YAAY,QAAQ,EAAE;YACtD,QAAQ,iBAAiB,GAAG,YAAY,QAAQ;YAChD,UAAU;QACZ;QACA,IAAI,QAAQ,aAAa,KAAK,YAAY,IAAI,EAAE;YAC9C,QAAQ,aAAa,GAAG,YAAY,IAAI;YACxC,UAAU;QACZ;IACF;IAEA,MAAM,gBAAgB,IAAA,+JAAiB,EAAC;QACtC,UAAU,QAAQ,qBAAqB;QACvC,MAAM,QAAQ,iBAAiB;IACjC;IACA,IAAI,eAAe;QACjB,IAAI,QAAQ,qBAAqB,KAAK,cAAc,QAAQ,EAAE;YAC5D,QAAQ,qBAAqB,GAAG,cAAc,QAAQ;YACtD,UAAU;QACZ;QACA,IAAI,QAAQ,iBAAiB,KAAK,cAAc,IAAI,EAAE;YACpD,QAAQ,iBAAiB,GAAG,cAAc,IAAI;YAC9C,UAAU;QACZ;IACF;IAEA,MAAM,UAAU,IAAA,yJAAW,EAAC;QAC1B,iBAAiB,QAAQ,eAAe;QACxC,gBAAgB,QAAQ,cAAc;QACtC,mBAAmB,eAAe,QAAQ,QAAQ,iBAAiB;IACrE;IACA,IAAI,WAAW,QAAQ,eAAe,KAAK,QAAQ,QAAQ,EAAE;QAC3D,QAAQ,eAAe,GAAG,QAAQ,QAAQ;QAC1C,UAAU;IACZ;IAEA,MAAM,cAAc,IAAA,6JAAe,EAAC;QAClC,UAAU,QAAQ,0BAA0B;QAC5C,MAAM,QAAQ,sBAAsB;IACtC;IACA,IAAI,aAAa;QACf,IAAI,QAAQ,0BAA0B,KAAK,YAAY,QAAQ,EAAE;YAC/D,QAAQ,0BAA0B,GAAG,YAAY,QAAQ;YACzD,UAAU;QACZ;QACA,IAAI,QAAQ,sBAAsB,KAAK,YAAY,IAAI,EAAE;YACvD,QAAQ,sBAAsB,GAAG,YAAY,IAAI;YACjD,UAAU;QACZ;IACF;IAEA,IAAI,CAAC,QAAQ,YAAY,IAAI,QAAQ,SAAS,EAAE;QAC9C,QAAQ,YAAY,GAAG,QAAQ,SAAS;QACxC,UAAU;IACZ;IAEA,IAAI,CAAC,QAAQ,gBAAgB,IAAI,QAAQ,aAAa,EAAE;QACtD,QAAQ,gBAAgB,GAAG,QAAQ,aAAa;QAChD,UAAU;IACZ;IAEA,OAAO,UAAU;QAAE,GAAG,OAAO;QAAE,GAAG,OAAO;IAAC,IAAI;AAChD;AAEA,MAAM,0BAA0B,CAAC;IAC/B,IAAI,UAAU;IACd,MAAM,UAAU,SAAS,GAAG,CAAC,CAAA;QAC3B,MAAM,aAAa,sBAAsB;QACzC,IAAI,eAAe,SAAS;YAC1B,UAAU;QACZ;QACA,OAAO;IACT;IACA,OAAO,UAAU,UAAU;AAC7B;AAEA,MAAM,kBAA6B,EAAE,EAAE,8BAA8B;AAErE,IAAI,kBAAkB,IAAA,2IAAqB,EAAC,iBAAiB;AAC7D,IAAI,oBAAoB,IAAA,6IAAuB,EAAC,iBAAiB;AAEjE,MAAM,kBAAkB;IACtB,mBAAmB;IACnB,OAAO,IAAA,gIAAU,EAAC,IAAA,sIAAgB,EAAC,gBAAgB;AACrD;AAEA,MAAM,0BAA0B,CAAC,UAAqB;IACpD,IAAI,YAAY,GAAG,UAAU,CAAC,IAAI,GAAG,MAAM,GAAG,GAAG;QAC/C,MAAM,aAAa,GAAG,UAAU,CAAC,IAAI,GAAG,WAAW;QACnD,MAAM,gBAAgB,IAAA,kJAA4B,EAAC,YAAY;QAC/D,IAAI,gBAAgB,mBAAmB;YACrC,oBAAoB;QACtB;QACA,OAAO,IAAA,kIAAY,EAAC;IACtB;IAEA,MAAM,cAAc,SAAS,GAAG,CAAC,CAAA,UAAW,QAAQ,EAAE,EAAY,MAAM,CAAC;IACzE,MAAM,EAAE,MAAM,EAAE,cAAc,EAAE,GAAG,IAAA,iJAA2B,EAC5D,oBACA,aACA,mBACA;IAEF,oBAAoB;IACpB,OAAO,IAAA,kIAAY,EAAC;AACtB;AAEO,MAAM,kBAAkB,IAAA,kJAAM,IACnC,IAAA,sKAAqB,EACnB,CAAC,KAAK,MAAQ,CAAC;QACb,MAAM;QACN;QACA;QACA,aAAa;QAEb,KAAK,CAAC;YACJ,IAAI,iBAAiC;YACrC,IAAI,CAAA;gBACF,MAAM,WAAW;gBACjB,MAAM,KAAK,wBAAwB,MAAM,IAAI,EAAE,KAAK,EAAE;gBACtD,MAAM,YAAY,KAAK,SAAS,IAAI;gBAEpC,MAAM,aAAsB;oBAC1B,GAAG,IAAI;oBACP;oBACA;oBACA;oBACA,WAAW,KAAK,SAAS,IAAI,IAAI,OAAO,WAAW;oBACnD,QAAQ,uBAAuB,KAAK,MAAM;oBAC1C,kBAAkB,KAAK,gBAAgB,IAAI,EAAE;gBAC/C;gBAEA,MAAM,oBAAoB,sBAAsB;gBAChD,iBAAiB;gBAEjB,OAAO;oBACL,MAAM;2BAAI,MAAM,IAAI;wBAAE;qBAAkB;oBACxC;oBACA;gBACF;YACF;YACA,cAAc;YACd,IAAI,gBAAgB;gBAClB,UAAU,UAAU,gBAAgB,KAAK,CAAC,QAAQ,KAAK;YACzD;YACA,OAAO;QACT;QAEA,aAAa,CAAC;YACZ,MAAM,UAAqB,EAAE;YAC7B,IAAI,CAAA;gBACF,MAAM,OAAO,CAAC,CAAA;oBACZ,MAAM,UAAU;2BAAI,MAAM,IAAI;2BAAK;qBAAQ;oBAC3C,MAAM,WAAW;oBACjB,MAAM,KAAK,wBAAwB,SAAS,KAAK,EAAE;oBACnD,MAAM,YAAY,KAAK,SAAS,IAAI;oBAEpC,MAAM,aAAsB;wBAC1B,GAAG,IAAI;wBACP;wBACA;wBACA;wBACA,WAAW,KAAK,SAAS,IAAI,IAAI,OAAO,WAAW;wBACnD,QAAQ,uBAAuB,KAAK,MAAM;wBAC1C,kBAAkB,KAAK,gBAAgB,IAAI,EAAE;oBAC/C;oBACA,QAAQ,IAAI,CAAC,sBAAsB;gBACrC;gBAEA,OAAO;oBACL,MAAM;2BAAI,MAAM,IAAI;2BAAK;qBAAQ;oBACjC;oBACA;gBACF;YACF;YACA,kBAAkB;YAClB,QAAQ,OAAO,CAAC,CAAA;gBACd,UAAU,UAAU,SAAS,KAAK,CAAC,QAAQ,KAAK;YAClD;QACF;QAEA,QAAQ,CAAC,UAAoB;YAC3B,MAAM,UAAU;gBAAE,GAAG,IAAI;gBAAE,QAAQ,uBAAuB,KAAK,MAAM;gBAAG,WAAW,IAAI,OAAO,WAAW;YAAG;YAC5G,IAAI,CAAA,QAAS,CAAC;oBACZ,MAAM,MAAM,IAAI,CAAC,GAAG,CAAC,CAAA,IAAK,EAAE,QAAQ,KAAK,WAAW,UAAU;oBAC9D;oBACA;gBACF,CAAC;YACD,cAAc;YACd,UAAU,UAAU,SAAS,KAAK,CAAC,QAAQ,KAAK;QAClD;QAEA,QAAQ,CAAC;YACP,IAAI,CAAA,QAAS,CAAC;oBACZ,MAAM,MAAM,IAAI,CAAC,MAAM,CAAC,CAAA,IAAK,EAAE,QAAQ,KAAK;oBAC5C;oBACA;gBACF,CAAC;YACD,cAAc;YACd,UAAU,UAAU;gBAAE;YAAS,GAAG,KAAK,CAAC,QAAQ,KAAK;QACvD;QAEA,UAAU,CAAC;YACT,OAAO,MAAM,IAAI,CAAC,IAAI,CAAC,CAAA,IAAK,EAAE,QAAQ,KAAK;QAC7C;QAEA,WAAW;YACT,OAAO,MAAM,IAAI,CAAC,MAAM,CAAC,CAAA,IAAK,EAAE,MAAM,KAAK;QAC7C;QAEA,QAAQ,CAAC,UAAoB;YAC3B,MAAM,UAAU,MAAM,QAAQ,CAAC;YAC/B,IAAI,WAAW,QAAQ,MAAM,KAAK,aAAa;gBAC7C,MAAM,eAAe,mBACnB,aACA,CAAC,gBAAgB,EAAE,SAAS,CAAC,EAAE,EAAE,QAAQ,GAAG,IAAI,EAChD;oBAAE,UAAU;oBAAc,UAAU;oBAAU,MAAM;gBAAO;gBAG7D,MAAM,MAAM,CAAC,UAAU;oBACrB,GAAG,OAAO;oBACV,QAAQ;oBACR,aAAa,IAAI,OAAO,WAAW;oBACnC,iBAAiB;2BAAK,QAAQ,eAAe,IAAI,EAAE;wBAAG;qBAAa;gBACrE;YACF;QACF;QAEA,aAAa;YACX,IAAI;gBACF,iFAAiF;gBACjF,MAAM,WAAW,MAAM,MAAM;gBAC7B,IAAI,CAAC,SAAS,EAAE,EAAE;gBAClB,MAAM,OAAO,MAAM,SAAS,IAAI;gBAChC,MAAM,UAAU,KAAK,IAAI,IAAI,EAAE;gBAC/B,IAAI,QAAQ,MAAM,GAAG,GAAG;oBACtB,MAAM,aAAa,wBAAwB,QAAQ,GAAG,CAAC,CAAC,UAAqB,CAAC;4BAC5E,GAAG,OAAO;4BACV,QAAQ,uBAAuB,QAAQ,MAAM;wBAC/C,CAAC;oBACD,MAAM,oBAAoB,IAAA,2IAAqB,EAAC,YAAY;oBAC5D,MAAM,sBAAsB,IAAA,6IAAuB,EAAC,YAAY;oBAChE,kBAAkB;oBAClB,oBAAoB;oBACpB,IAAI;wBACF,MAAM;wBACN;wBACA;wBACA,aAAa;oBACf;gBACF,OAAO;oBACL,IAAI;wBAAE,aAAa;oBAAK;gBAC1B;YACF,EAAE,OAAO,OAAO;gBACd,QAAQ,KAAK,CAAC,qCAAqC;YACrD;QACF;IACF,CAAC"}},
    {"offset": {"line": 2220, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/payments/store.ts"],"sourcesContent":["import { create } from 'zustand';\r\nimport type { Payment } from './types';\r\nimport type { HistoryEntry } from '../../components/ActivityHistory';\r\n// REMOVED: import { data as initialData } from './data'; // Mock data no longer used - database is source of truth\r\nimport {\r\n  extractCounterFromBusinessId,\r\n  findNextAvailableBusinessId,\r\n  generateSystemId,\r\n  getMaxBusinessIdCounter,\r\n  getMaxSystemIdCounter,\r\n  type EntityType,\r\n} from '../../lib/id-utils';\r\nimport { asBusinessId, asSystemId, type BusinessId, type SystemId } from '../../lib/id-types';\r\nimport { pickAccount, pickPaymentMethod, pickPaymentType, pickTargetGroup } from '@/features/finance/document-lookups';\r\nimport { useEmployeeStore } from '../employees/store';\r\nimport { getCurrentUserSystemId } from '../../contexts/auth-context';\r\n\r\n// API sync helpers\r\nasync function syncToAPI(action: 'create' | 'update' | 'delete', data: any): Promise<boolean> {\r\n  try {\r\n    const endpoint = action === 'create' ? '/api/payments' : `/api/payments/${data.systemId}`;\r\n    const method = action === 'create' ? 'POST' : action === 'update' ? 'PATCH' : 'DELETE';\r\n    \r\n    const response = await fetch(endpoint, {\r\n      method,\r\n      headers: { 'Content-Type': 'application/json' },\r\n      body: action !== 'delete' ? JSON.stringify(data) : undefined,\r\n    });\r\n    \r\n    if (!response.ok) {\r\n      console.error(`[Payments API] ${action} failed:`, await response.text());\r\n      return false;\r\n    }\r\n    return true;\r\n  } catch (error) {\r\n    console.error(`[Payments API] ${action} error:`, error);\r\n    return false;\r\n  }\r\n}\r\n\r\n// Helper to get current user info\r\nconst getCurrentUserInfo = () => {\r\n  const currentUserSystemId = getCurrentUserSystemId?.() || 'SYSTEM';\r\n  const employee = useEmployeeStore.getState().data.find(e => e.systemId === currentUserSystemId);\r\n  return {\r\n    systemId: currentUserSystemId,\r\n    name: employee?.fullName || 'H·ªá th·ªëng',\r\n    avatar: employee?.avatarUrl,\r\n  };\r\n};\r\n\r\n// Helper to create history entry\r\nconst createHistoryEntry = (\r\n  action: HistoryEntry['action'],\r\n  description: string,\r\n  metadata?: HistoryEntry['metadata']\r\n): HistoryEntry => ({\r\n  id: crypto.randomUUID(),\r\n  action,\r\n  timestamp: new Date(),\r\n  user: getCurrentUserInfo(),\r\n  description,\r\n  metadata,\r\n});\r\n\r\nexport type PaymentInput = Omit<Payment, 'systemId' | 'id'> & { id?: BusinessId | string };\r\n\r\ninterface PaymentStore {\r\n  data: Payment[];\r\n  businessIdCounter: number;\r\n  systemIdCounter: number;\r\n  initialized: boolean;\r\n  add: (item: PaymentInput) => Payment;\r\n  addMultiple: (items: PaymentInput[]) => void;\r\n  update: (systemId: SystemId, item: Payment) => void;\r\n  remove: (systemId: SystemId) => void;\r\n  findById: (systemId: SystemId) => Payment | undefined;\r\n  getActive: () => Payment[];\r\n  cancel: (systemId: SystemId, reason?: string) => void;\r\n  loadFromAPI: () => Promise<void>;\r\n}\r\n\r\nconst PAYMENT_ENTITY: EntityType = 'payments';\r\nconst SYSTEM_ID_PREFIX = 'PAYMENT';\r\nconst BUSINESS_ID_PREFIX = 'PC';\r\nconst BUSINESS_ID_DIGITS = 6;\r\nconst PURCHASE_ORDER_SYSTEM_PREFIX = 'PURCHASE';\r\nconst PURCHASE_ORDER_BUSINESS_PREFIX = 'PO';\r\n\r\nconst normalizePaymentStatus = (status?: Payment['status']): Payment['status'] =>\r\n  status === 'cancelled' ? 'cancelled' : 'completed';\r\n\r\nconst normalizePayment = (payment: Payment): Payment => ({\r\n  ...payment,\r\n  status: normalizePaymentStatus(payment.status),\r\n});\r\n\r\nconst ensurePaymentMetadata = (payment: Payment): Payment => {\r\n  let mutated = false;\r\n  const updates: Partial<Payment> = {};\r\n\r\n  const targetGroup = pickTargetGroup({\r\n    systemId: payment.recipientTypeSystemId,\r\n    name: payment.recipientTypeName,\r\n  });\r\n  if (targetGroup) {\r\n    if (payment.recipientTypeSystemId !== targetGroup.systemId) {\r\n      updates.recipientTypeSystemId = targetGroup.systemId;\r\n      mutated = true;\r\n    }\r\n    if (payment.recipientTypeName !== targetGroup.name) {\r\n      updates.recipientTypeName = targetGroup.name;\r\n      mutated = true;\r\n    }\r\n  }\r\n\r\n  const paymentMethod = pickPaymentMethod({\r\n    systemId: payment.paymentMethodSystemId,\r\n    name: payment.paymentMethodName,\r\n  });\r\n  if (paymentMethod) {\r\n    if (payment.paymentMethodSystemId !== paymentMethod.systemId) {\r\n      updates.paymentMethodSystemId = paymentMethod.systemId;\r\n      mutated = true;\r\n    }\r\n    if (payment.paymentMethodName !== paymentMethod.name) {\r\n      updates.paymentMethodName = paymentMethod.name;\r\n      mutated = true;\r\n    }\r\n  }\r\n\r\n  const account = pickAccount({\r\n    accountSystemId: payment.accountSystemId,\r\n    branchSystemId: payment.branchSystemId,\r\n    paymentMethodName: paymentMethod?.name ?? payment.paymentMethodName,\r\n  });\r\n  if (account && payment.accountSystemId !== account.systemId) {\r\n    updates.accountSystemId = account.systemId;\r\n    mutated = true;\r\n  }\r\n\r\n  const paymentType = pickPaymentType({\r\n    systemId: payment.paymentReceiptTypeSystemId,\r\n    name: payment.paymentReceiptTypeName,\r\n  });\r\n  if (paymentType) {\r\n    if (payment.paymentReceiptTypeSystemId !== paymentType.systemId) {\r\n      updates.paymentReceiptTypeSystemId = paymentType.systemId;\r\n      mutated = true;\r\n    }\r\n    if (payment.paymentReceiptTypeName !== paymentType.name) {\r\n      updates.paymentReceiptTypeName = paymentType.name;\r\n      mutated = true;\r\n    }\r\n  }\r\n\r\n  const normalizedGroupName = targetGroup?.name?.trim().toLowerCase();\r\n  if (normalizedGroupName === 'kh√°ch h√†ng') {\r\n    if (!payment.customerName && payment.recipientName) {\r\n      updates.customerName = payment.recipientName;\r\n      mutated = true;\r\n    }\r\n    if (!payment.customerSystemId && payment.recipientSystemId) {\r\n      updates.customerSystemId = payment.recipientSystemId;\r\n      mutated = true;\r\n    }\r\n  }\r\n\r\n  return mutated ? { ...payment, ...updates } : payment;\r\n};\r\n\r\nconst backfillPaymentMetadata = (payments: Payment[]): Payment[] => {\r\n  let mutated = false;\r\n  const updated = payments.map(payment => {\r\n    const normalized = ensurePaymentMetadata(payment);\r\n    if (normalized !== payment) {\r\n      mutated = true;\r\n    }\r\n    return normalized;\r\n  });\r\n  return mutated ? updated : payments;\r\n};\r\n\r\nconst initialPayments: Payment[] = []; // Database is source of truth\r\n\r\nlet systemIdCounter = getMaxSystemIdCounter(initialPayments, SYSTEM_ID_PREFIX);\r\nlet businessIdCounter = getMaxBusinessIdCounter(initialPayments, BUSINESS_ID_PREFIX);\r\n\r\nconst getNextSystemId = (): SystemId => {\r\n  systemIdCounter += 1;\r\n  return asSystemId(generateSystemId(PAYMENT_ENTITY, systemIdCounter));\r\n};\r\n\r\nconst ensurePaymentBusinessId = (payments: Payment[], provided?: BusinessId | string): BusinessId => {\r\n  if (provided && `${provided}`.trim().length > 0) {\r\n    const normalized = `${provided}`.trim().toUpperCase();\r\n    const parsedCounter = extractCounterFromBusinessId(normalized, BUSINESS_ID_PREFIX);\r\n    if (parsedCounter > businessIdCounter) {\r\n      businessIdCounter = parsedCounter;\r\n    }\r\n    return asBusinessId(normalized);\r\n  }\r\n\r\n  const existingIds = payments.map(payment => payment.id as string).filter(Boolean);\r\n  const { nextId, updatedCounter } = findNextAvailableBusinessId(\r\n    BUSINESS_ID_PREFIX,\r\n    existingIds,\r\n    businessIdCounter,\r\n    BUSINESS_ID_DIGITS\r\n  );\r\n  businessIdCounter = updatedCounter;\r\n  return asBusinessId(nextId);\r\n};\r\n\r\nconst reconcileLinkedDocuments = (payment: Payment): Payment => {\r\n  if (!payment.originalDocumentId) {\r\n    return payment;\r\n  }\r\n\r\n  const normalizedDocId = payment.originalDocumentId.toUpperCase();\r\n  const nextPayment = { ...payment };\r\n\r\n  if (!nextPayment.purchaseOrderSystemId && normalizedDocId.startsWith(PURCHASE_ORDER_SYSTEM_PREFIX)) {\r\n    nextPayment.purchaseOrderSystemId = asSystemId(payment.originalDocumentId);\r\n  }\r\n\r\n  if (!nextPayment.purchaseOrderId && normalizedDocId.startsWith(PURCHASE_ORDER_BUSINESS_PREFIX)) {\r\n    nextPayment.purchaseOrderId = asBusinessId(payment.originalDocumentId);\r\n  }\r\n\r\n  return nextPayment;\r\n};\r\n\r\nconst buildPayment = (input: PaymentInput, existingPayments: Payment[]): Payment => {\r\n  const systemId = getNextSystemId();\r\n  const id = ensurePaymentBusinessId(existingPayments, input.id);\r\n  const basePayment: Payment = {\r\n    ...input,\r\n    systemId,\r\n    id,\r\n    createdAt: input.createdAt || new Date().toISOString(),\r\n    status: normalizePaymentStatus(input.status),\r\n  };\r\n\r\n  return reconcileLinkedDocuments(basePayment);\r\n};\r\n\r\nexport const usePaymentStore = create<PaymentStore>()(\r\n  (set, get) => ({\r\n      data: initialPayments,\r\n      businessIdCounter,\r\n      systemIdCounter,\r\n      initialized: false,\r\n      \r\n      add: (item) => {\r\n        let createdPayment: Payment | null = null;\r\n        set(state => {\r\n          const newPayment = buildPayment(item, state.data);\r\n          createdPayment = newPayment;\r\n          return {\r\n            data: [...state.data, newPayment],\r\n            businessIdCounter,\r\n            systemIdCounter,\r\n          };\r\n        });\r\n        // Sync to API\r\n        if (createdPayment) {\r\n          syncToAPI('create', createdPayment).catch(console.error);\r\n        }\r\n        return createdPayment!;\r\n      },\r\n      \r\n      addMultiple: (items) => {\r\n        const created: Payment[] = [];\r\n        set(state => {\r\n          items.forEach(item => {\r\n            const context = [...state.data, ...created];\r\n            const payment = buildPayment(item, context);\r\n            created.push(payment);\r\n          });\r\n\r\n          return {\r\n            data: [...state.data, ...created],\r\n            businessIdCounter,\r\n            systemIdCounter,\r\n          };\r\n        });\r\n        // Sync all to API\r\n        created.forEach(payment => {\r\n          syncToAPI('create', payment).catch(console.error);\r\n        });\r\n      },\r\n      \r\n      update: (systemId, item) => {\r\n        const updated = reconcileLinkedDocuments({\r\n          ...item,\r\n          systemId,\r\n          status: normalizePaymentStatus(item.status),\r\n          updatedAt: new Date().toISOString(),\r\n        });\r\n        set(state => ({\r\n          data: state.data.map(payment =>\r\n            payment.systemId === systemId ? updated : payment\r\n          ),\r\n          businessIdCounter,\r\n          systemIdCounter,\r\n        }));\r\n        // Sync to API\r\n        syncToAPI('update', updated).catch(console.error);\r\n      },\r\n      \r\n      remove: (systemId) => {\r\n        set(state => ({\r\n          data: state.data.filter(payment => payment.systemId !== systemId),\r\n          businessIdCounter,\r\n          systemIdCounter,\r\n        }));\r\n        // Sync to API\r\n        syncToAPI('delete', { systemId }).catch(console.error);\r\n      },\r\n      \r\n      findById: (systemId) => {\r\n        return get().data.find(payment => payment.systemId === systemId);\r\n      },\r\n      \r\n      getActive: () => {\r\n        return get().data.filter(payment => payment.status !== 'cancelled');\r\n      },\r\n      \r\n      cancel: (systemId: SystemId, reason?: string) => {\r\n        const payment = get().findById(systemId);\r\n        if (payment && payment.status !== 'cancelled') {\r\n          const historyEntry = createHistoryEntry(\r\n            'cancelled',\r\n            `ƒê√£ h·ªßy phi·∫øu chi${reason ? `: ${reason}` : ''}`,\r\n            { oldValue: 'Ho√†n th√†nh', newValue: 'ƒê√£ h·ªßy', note: reason }\r\n          );\r\n          \r\n          get().update(systemId, {\r\n            ...payment,\r\n            status: 'cancelled',\r\n            cancelledAt: new Date().toISOString(),\r\n            activityHistory: [...(payment.activityHistory || []), historyEntry],\r\n          });\r\n        }\r\n      },\r\n      \r\n      loadFromAPI: async () => {\r\n        try {\r\n          // NOTE: Use React Query hooks for paginated data. This only loads initial batch.\r\n          const response = await fetch('/api/payments?limit=30');\r\n          if (!response.ok) return;\r\n          const json = await response.json();\r\n          const apiData = json.data || [];\r\n          if (apiData.length > 0) {\r\n            const normalized = backfillPaymentMetadata(apiData.map(normalizePayment));\r\n            const nextSystemCounter = getMaxSystemIdCounter(normalized, SYSTEM_ID_PREFIX);\r\n            const nextBusinessCounter = getMaxBusinessIdCounter(normalized, BUSINESS_ID_PREFIX);\r\n            systemIdCounter = nextSystemCounter;\r\n            businessIdCounter = nextBusinessCounter;\r\n            set({ \r\n              data: normalized, \r\n              systemIdCounter, \r\n              businessIdCounter,\r\n              initialized: true \r\n            });\r\n          } else {\r\n            set({ initialized: true });\r\n          }\r\n        } catch (error) {\r\n          console.error('[Payments API] loadFromAPI error:', error);\r\n        }\r\n      },\r\n    })\r\n);\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 2553, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/sales-returns/store.ts"],"sourcesContent":["import { formatDate, formatDateTime, formatDateTimeSeconds, formatDateCustom, parseDate, getCurrentDate } from '@/lib/date-utils';\r\nimport { createCrudStore } from '../../lib/store-factory';\r\nimport type { SalesReturn, ReturnLineItem } from './types';\r\n// REMOVED: import { data as initialData } from './data'; // Mock data no longer used - database is source of truth\r\nimport { GHTKService, type GHTKCreateOrderParams } from '../settings/shipping/integrations/ghtk-service';\r\nimport { loadShippingConfig } from '../../lib/utils/shipping-config-migration';\r\nimport { toast } from 'sonner';\r\n\r\n// Other stores\r\nimport { useOrderStore } from '../orders/store';\r\nimport { useProductStore } from '../products/store';\r\nimport { useStockHistoryStore } from '../stock-history/store';\r\nimport { useCustomerStore } from '../customers/store';\r\nimport { createPaymentDocument, createReceiptDocument } from '../finance/document-helpers';\r\nimport { useShippingPartnerStore } from '../settings/shipping/store';\r\nimport { asBusinessId, asSystemId, type SystemId } from '../../lib/id-types';\r\nimport { isComboProduct } from '../products/combo-utils';\r\nimport { generateSystemId, getMaxSystemIdCounter } from '../../lib/id-utils';\r\n\r\n/**\r\n * ‚úÖ Helper: Expand combo return items to child products\r\n * When a combo is returned, we need to add stock back to child products\r\n */\r\nconst getReturnStockItems = (returnItems: ReturnLineItem[]) => {\r\n    const { findById } = useProductStore.getState();\r\n    const expandedItems: { productSystemId: SystemId; productName: string; quantity: number }[] = [];\r\n    \r\n    returnItems.forEach(item => {\r\n        const product = findById(item.productSystemId);\r\n        if (product && isComboProduct(product) && product.comboItems) {\r\n            // Combo ‚Üí expand to child products\r\n            product.comboItems.forEach(comboItem => {\r\n                const childProduct = findById(comboItem.productSystemId);\r\n                expandedItems.push({\r\n                    productSystemId: comboItem.productSystemId,\r\n                    productName: childProduct?.name || 'SP kh√¥ng x√°c ƒë·ªãnh',\r\n                    quantity: comboItem.quantity * item.returnQuantity\r\n                });\r\n            });\r\n        } else {\r\n            // Regular product\r\n            expandedItems.push({\r\n                productSystemId: asSystemId(item.productSystemId),\r\n                productName: item.productName,\r\n                quantity: item.returnQuantity\r\n            });\r\n        }\r\n    });\r\n    return expandedItems;\r\n};\r\n\r\nconst baseStore = createCrudStore<SalesReturn>([], 'sales-returns', {\r\n  apiEndpoint: '/api/sales-returns',\r\n});\r\n\r\nconst originalAdd = baseStore.getState().add;\r\n\r\nconst augmentedMethods = {\r\n  addWithSideEffects: (item: Omit<SalesReturn, 'systemId' | 'id'> & { creatorId: string }) => {\r\n    const orderSystemId = asSystemId(item.orderSystemId);\r\n    const orderBusinessId = asBusinessId(item.orderId);\r\n    const customerSystemId = asSystemId(item.customerSystemId);\r\n    const branchSystemId = asSystemId(item.branchSystemId);\r\n    const creatorSystemId = asSystemId(item.creatorSystemId ?? item.creatorId ?? 'SYSTEM');\r\n    const exchangeOrderSystemId = item.exchangeOrderSystemId ? asSystemId(item.exchangeOrderSystemId) : undefined;\r\n    const accountSystemId = item.accountSystemId ? asSystemId(item.accountSystemId) : undefined;\r\n    const paymentVoucherSystemId = item.paymentVoucherSystemId ? asSystemId(item.paymentVoucherSystemId) : undefined;\r\n    const paymentVoucherSystemIds = item.paymentVoucherSystemIds?.map(asSystemId);\r\n    const receiptVoucherSystemIds = item.receiptVoucherSystemIds?.map(asSystemId);\r\n\r\n    const formattedItems = item.items.map(lineItem => ({\r\n      ...lineItem,\r\n      productSystemId: asSystemId(lineItem.productSystemId),\r\n      productId: asBusinessId(lineItem.productId),\r\n    }));\r\n\r\n    const formattedPayments = item.payments?.map(payment => ({\r\n      ...payment,\r\n      accountSystemId: asSystemId(payment.accountSystemId),\r\n    }));\r\n\r\n    const formattedRefunds = item.refunds?.map(refund => ({\r\n      ...refund,\r\n      accountSystemId: asSystemId(refund.accountSystemId),\r\n    }));\r\n\r\n    const newItemData: Omit<SalesReturn, 'systemId'> = {\r\n      id: asBusinessId(''),\r\n      orderSystemId,\r\n      orderId: orderBusinessId,\r\n      customerSystemId,\r\n      customerName: item.customerName,\r\n      branchSystemId,\r\n      branchName: item.branchName,\r\n      returnDate: item.returnDate,\r\n      reason: item.reason,\r\n      note: item.note,\r\n      notes: item.notes,\r\n      reference: item.reference,\r\n      items: formattedItems,\r\n      totalReturnValue: item.totalReturnValue,\r\n      isReceived: item.isReceived,\r\n      exchangeItems: item.exchangeItems ?? [],\r\n      exchangeOrderSystemId,\r\n      subtotalNew: item.subtotalNew,\r\n      shippingFeeNew: item.shippingFeeNew,\r\n      discountNew: item.discountNew,\r\n      discountNewType: item.discountNewType,\r\n      grandTotalNew: item.grandTotalNew,\r\n      deliveryMethod: item.deliveryMethod,\r\n      shippingPartnerId: item.shippingPartnerId,\r\n      shippingServiceId: item.shippingServiceId,\r\n      shippingAddress: item.shippingAddress,\r\n      packageInfo: item.packageInfo,\r\n      configuration: item.configuration,\r\n      finalAmount: item.finalAmount,\r\n      refundMethod: item.refundMethod,\r\n      refundAmount: item.refundAmount,\r\n      accountSystemId,\r\n      refunds: formattedRefunds,\r\n      payments: formattedPayments,\r\n      paymentVoucherSystemId,\r\n      paymentVoucherSystemIds,\r\n      receiptVoucherSystemIds,\r\n      creatorSystemId,\r\n      creatorName: item.creatorName,\r\n    };\r\n\r\n    // --- Side Effects ---\r\n    const { update: updateOrder, findById: findOrderById, add: addOrder } = useOrderStore.getState();\r\n    const { updateInventory } = useProductStore.getState();\r\n    const { addEntry: addStockHistory } = useStockHistoryStore.getState();\r\n    const { updateDebt, incrementReturnStats } = useCustomerStore.getState();\r\n    const order = findOrderById(newItemData.orderSystemId);\r\n    if (!order) return { newReturn: null, newOrderSystemId: null };\r\n\r\n    // ‚úÖ IMPORTANT: Create the return FIRST to get IDs for exchange order\r\n    const newReturn = originalAdd(newItemData);\r\n    if (!newReturn) return { newReturn: null, newOrderSystemId: null };\r\n\r\n    // ‚úÖ Update customer return stats\r\n    const totalReturnQty = newItemData.items.reduce((sum, item) => sum + item.returnQuantity, 0);\r\n    if (totalReturnQty > 0) {\r\n        incrementReturnStats(newItemData.customerSystemId, totalReturnQty);\r\n    }\r\n\r\n    let newOrderSystemId: SystemId | undefined;\r\n\r\n    // Create a new sales order for the exchange items\r\n    if (newItemData.exchangeItems && newItemData.exchangeItems.length > 0) {\r\n        console.log('üîÑ [Sales Return] Creating exchange order...', {\r\n        exchangeItems: newItemData.exchangeItems,\r\n        finalAmount: newItemData.finalAmount,\r\n        payments: newItemData.payments,\r\n        });\r\n        \r\n      // ‚úÖ Calculate payments for exchange order based on sales return logic\r\n      const exchangeOrderPayments =\r\n        newItemData.finalAmount > 0 && newItemData.payments\r\n        ? newItemData.payments.map(p => ({\r\n          method: p.method,\r\n          accountSystemId: p.accountSystemId,\r\n          amount: p.amount,\r\n          }))\r\n        : [];\r\n        // If company refunded customer (finalAmount < 0)\r\n        // The exchange order will have COD = grandTotal (shipper collects on delivery)\r\n        // No payments array needed - will be handled by COD in shipping\r\n        \r\n        // ‚úÖ Determine status and packagings based on delivery method\r\n        let finalMainStatus: 'ƒê·∫∑t h√†ng' | 'ƒêang giao d·ªãch' = 'ƒê·∫∑t h√†ng';\r\n        let finalDeliveryStatus: string = 'Ch·ªù ƒë√≥ng g√≥i';\r\n        const packagings: any[] = [];\r\n        const now = formatDateCustom(getCurrentDate(), 'yyyy-MM-dd HH:mm');\r\n        \r\n        // ‚úÖ Helper to get next packaging systemId\r\n        const PACKAGING_SYSTEM_ID_PREFIX = 'PACKAGE';\r\n        const allOrders = useOrderStore.getState().data;\r\n        const allPackagings = allOrders.flatMap(o => o.packagings || []);\r\n        const maxPackagingCounter = getMaxSystemIdCounter(allPackagings, PACKAGING_SYSTEM_ID_PREFIX);\r\n        let packagingCounter = maxPackagingCounter;\r\n        const getNextPackagingSystemId = () => {\r\n            packagingCounter++;\r\n            return asSystemId(generateSystemId('packaging', packagingCounter));\r\n        };\r\n        \r\n        // Check if using shipping partner or pickup\r\n      const isPickup = newItemData.deliveryMethod === 'pickup';\r\n      const isShippingPartner = newItemData.shippingPartnerId && newItemData.shippingServiceId;\r\n        \r\n        if (isPickup) {\r\n            // Nh·∫≠n t·∫°i c·ª≠a h√†ng - T·∫°o packaging request ngay\r\n            finalMainStatus = 'ƒêang giao d·ªãch';\r\n            finalDeliveryStatus = 'Ch·ªù ƒë√≥ng g√≥i';\r\n            packagings.push({\r\n                systemId: getNextPackagingSystemId(), // ‚úÖ Use proper format PACKAGE000001\r\n                id: '',\r\n                requestDate: now,\r\n          requestingEmployeeId: creatorSystemId,\r\n          requestingEmployeeName: newItemData.creatorName,\r\n                status: 'Ch·ªù ƒë√≥ng g√≥i',\r\n                printStatus: 'Ch∆∞a in',\r\n                deliveryStatus: 'Ch·ªù ƒë√≥ng g√≥i',\r\n            });\r\n        } else if (isShippingPartner) {\r\n            // ƒê·∫©y qua h√£ng v·∫≠n chuy·ªÉn - T·∫°o packaging ƒë√£ ƒë√≥ng g√≥i v·ªõi tracking\r\n            finalMainStatus = 'ƒêang giao d·ªãch';\r\n            finalDeliveryStatus = 'Ch·ªù l·∫•y h√†ng';\r\n            \r\n            // Get partner info\r\n            const { data: partners } = useShippingPartnerStore.getState();\r\n            const partner = partners.find(p => p.systemId === newItemData.shippingPartnerId);\r\n            const service = partner?.services.find(s => s.id === newItemData.shippingServiceId);\r\n            \r\n            packagings.push({\r\n                systemId: getNextPackagingSystemId(), // ‚úÖ Use proper format PACKAGE000001\r\n                id: '',\r\n                requestDate: now,\r\n                confirmDate: now,\r\n              requestingEmployeeId: creatorSystemId,\r\n              requestingEmployeeName: newItemData.creatorName,\r\n              confirmingEmployeeId: creatorSystemId,\r\n              confirmingEmployeeName: newItemData.creatorName,\r\n                status: 'ƒê√£ ƒë√≥ng g√≥i',\r\n                deliveryStatus: 'Ch·ªù l·∫•y h√†ng',\r\n                printStatus: 'Ch∆∞a in',\r\n                deliveryMethod: 'D·ªãch v·ª• giao h√†ng',\r\n                carrier: partner?.name,\r\n                service: service?.name,\r\n              trackingCode: newItemData.packageInfo?.trackingCode || `VC${Date.now()}`,\r\n              shippingFeeToPartner: newItemData.shippingFeeNew,\r\n                codAmount: 0, // Will be calculated based on payments\r\n                payer: 'Ng∆∞·ªùi nh·∫≠n',\r\n              weight: newItemData.packageInfo?.weight,\r\n              dimensions: newItemData.packageInfo?.dimensions,\r\n            });\r\n        }\r\n        // else: deliver-later ‚Üí keep default 'ƒê·∫∑t h√†ng', 'Ch·ªù ƒë√≥ng g√≥i', no packagings\r\n        \r\n        const newOrderPayload = {\r\n            id: '', // ‚úÖ Empty string triggers auto-generation of business ID (DH...)\r\n            customerSystemId: order.customerSystemId,\r\n            customerName: order.customerName,\r\n            branchSystemId: order.branchSystemId, // ‚úÖ Use systemId only\r\n            branchName: order.branchName,\r\n            salespersonId: creatorSystemId,\r\n            salesperson: newItemData.creatorName,\r\n            orderDate: formatDateCustom(getCurrentDate(), 'yyyy-MM-dd HH:mm'),\r\n            lineItems: newItemData.exchangeItems,\r\n            subtotal: newItemData.subtotalNew,\r\n            shippingFee: newItemData.shippingFeeNew,\r\n            tax: 0,\r\n            // ‚úÖ IMPORTANT: grandTotal should be NET amount (after subtracting return value)\r\n            // grandTotal = subtotalNew + shippingFee - totalReturnValue\r\n            grandTotal: newItemData.finalAmount > 0 ? newItemData.finalAmount : newItemData.grandTotalNew,\r\n            // ‚úÖ Store return value info for display\r\n            linkedSalesReturnId: newReturn.id, // ‚úÖ Fixed: Use newReturn.id (business ID)\r\n            linkedSalesReturnSystemId: newReturn.systemId, // ‚úÖ Add systemId for linking\r\n            linkedSalesReturnValue: newItemData.totalReturnValue, // Value of returned items\r\n            payments: exchangeOrderPayments, // ‚úÖ Set payments based on sales return scenario\r\n            notes: `ƒê∆°n h√†ng ƒë·ªïi t·ª´ phi·∫øu tr·∫£ ${newReturn.id} c·ªßa ƒë∆°n h√†ng ${order.id}`, // ‚úÖ Fixed: Use newReturn.id\r\n            sourceSalesReturnId: newReturn.id, // ‚úÖ Fixed: Use newReturn.id\r\n            // ‚úÖ Pass shipping info from form\r\n            deliveryMethod: newItemData.deliveryMethod === 'pickup' ? 'Nh·∫≠n t·∫°i c·ª≠a h√†ng' : 'D·ªãch v·ª• giao h√†ng',\r\n            shippingPartnerId: newItemData.shippingPartnerId,\r\n            shippingServiceId: newItemData.shippingServiceId,\r\n            shippingAddress: newItemData.shippingAddress,\r\n            packageInfo: newItemData.packageInfo,\r\n            configuration: newItemData.configuration,\r\n            // ‚úÖ Add required status fields based on delivery method\r\n            status: finalMainStatus,\r\n            paymentStatus: exchangeOrderPayments.length > 0 ? \r\n              (exchangeOrderPayments.reduce((sum, p) => sum + p.amount, 0) >= newItemData.grandTotalNew ? 'Thanh to√°n to√†n b·ªô' : 'Thanh to√°n 1 ph·∫ßn') \r\n                : 'Ch∆∞a thanh to√°n' as const,\r\n            deliveryStatus: finalDeliveryStatus,\r\n            printStatus: 'Ch∆∞a in' as const,\r\n            stockOutStatus: 'Ch∆∞a xu·∫•t kho' as const,\r\n            returnStatus: 'Ch∆∞a tr·∫£ h√†ng' as const,\r\n            codAmount: 0, // Will be calculated by ShippingIntegration based on payments\r\n            packagings: packagings,\r\n        };\r\n        \r\n        console.log('üì¶ [Sales Return] New order payload:', newOrderPayload);\r\n        \r\n        const newOrder = addOrder(newOrderPayload as any);\r\n        \r\n        console.log('‚úÖ [Sales Return] New order created:', newOrder);\r\n        \r\n        if (newOrder) {\r\n          newOrderSystemId = asSystemId(newOrder.systemId);\r\n          // ‚úÖ Save exchange order systemId to sales return\r\n          (newItemData as SalesReturn).exchangeOrderSystemId = newOrderSystemId;\r\n            \r\n            console.log('üéâ [Sales Return] Exchange order systemId:', newOrderSystemId);\r\n        } else {\r\n            console.error('‚ùå [Sales Return] Failed to create exchange order!');\r\n        }\r\n    }\r\n\r\n    // Adjust customer debt if needed\r\n    const creditAmount = newItemData.totalReturnValue - newItemData.grandTotalNew - (newItemData.refundAmount || 0);\r\n    if (creditAmount > 0) {\r\n      updateDebt(newItemData.customerSystemId, -creditAmount);\r\n    }\r\n    \r\n    // ‚úÖ newReturn already created above, use it directly\r\n    // ‚úÖ NOW create vouchers with correct originalDocumentId\r\n    // Handle Financials AFTER creating the return\r\n    const finalAmount = newItemData.finalAmount;\r\n\r\n    if (finalAmount < 0 && newItemData.refunds && newItemData.refunds.length > 0) {\r\n      const createdVoucherIds: SystemId[] = [];\r\n\r\n      newItemData.refunds.forEach(refund => {\r\n        if (!refund.amount || refund.amount <= 0) {\r\n          return;\r\n        }\r\n\r\n        const { document, error } = createPaymentDocument({\r\n          amount: refund.amount,\r\n          description: `Ho√†n ti·ªÅn ƒë·ªïi/tr·∫£ h√†ng t·ª´ ƒë∆°n ${order.id} (Phi·∫øu: ${newReturn.id}) qua ${refund.method}`,\r\n          recipientName: newItemData.customerName,\r\n          recipientSystemId: newItemData.customerSystemId,\r\n          customerSystemId: newItemData.customerSystemId,\r\n          customerName: newItemData.customerName,\r\n          paymentMethodName: refund.method,\r\n          accountSystemId: refund.accountSystemId,\r\n          paymentTypeName: 'Ho√†n ti·ªÅn kh√°ch h√†ng',\r\n          branchSystemId: newReturn.branchSystemId,\r\n          branchName: newReturn.branchName,\r\n          createdBy: creatorSystemId,\r\n          originalDocumentId: newReturn.id,\r\n          linkedSalesReturnSystemId: newReturn.systemId,\r\n          linkedOrderSystemId: newReturn.orderSystemId,\r\n          category: 'complaint_refund',\r\n          affectsDebt: true, // ‚úÖ Ho√†n ti·ªÅn kh√°ch h√†ng ·∫£nh h∆∞·ªüng c√¥ng n·ª£ (gi·∫£m c√¥ng n·ª£)\r\n        });\r\n\r\n        if (error) {\r\n          console.error('[Sales Return] Failed to create payment voucher:', error);\r\n          toast.error(`Kh√¥ng th·ªÉ t·∫°o phi·∫øu chi ho√†n ti·ªÅn: ${error}`);\r\n          return;\r\n        }\r\n\r\n        if (document) {\r\n          createdVoucherIds.push(asSystemId(document.systemId));\r\n        }\r\n      });\r\n\r\n      if (createdVoucherIds.length > 0) {\r\n        baseStore.getState().update(newReturn.systemId, {\r\n          ...newReturn,\r\n          paymentVoucherSystemIds: createdVoucherIds,\r\n        });\r\n      }\r\n    } else if (finalAmount > 0 && newItemData.payments && newItemData.payments.length > 0) {\r\n      const createdVoucherIds: SystemId[] = [];\r\n\r\n      newItemData.payments.forEach(payment => {\r\n        if (!payment.amount || payment.amount <= 0) {\r\n          return;\r\n        }\r\n\r\n        const { document, error } = createReceiptDocument({\r\n          amount: payment.amount,\r\n          description: `Thu ti·ªÅn ch√™nh l·ªách ƒë·ªïi h√†ng t·ª´ ƒë∆°n ${order.id} (Phi·∫øu: ${newReturn.id})`,\r\n          customerName: newReturn.customerName,\r\n          customerSystemId: newItemData.customerSystemId,\r\n          paymentMethodName: payment.method,\r\n          accountSystemId: payment.accountSystemId,\r\n          receiptTypeName: 'Thanh to√°n cho ƒë∆°n h√†ng',\r\n          branchSystemId: newReturn.branchSystemId,\r\n          branchName: newReturn.branchName,\r\n          createdBy: creatorSystemId,\r\n          originalDocumentId: newReturn.id,\r\n          linkedSalesReturnSystemId: newReturn.systemId,\r\n          linkedOrderSystemId: newReturn.orderSystemId,\r\n          category: 'sale',\r\n          affectsDebt: false,\r\n        });\r\n\r\n        if (error) {\r\n          console.error('[Sales Return] Failed to create receipt voucher:', error);\r\n          toast.error(`Kh√¥ng th·ªÉ t·∫°o phi·∫øu thu ƒë·ªïi h√†ng: ${error}`);\r\n          return;\r\n        }\r\n\r\n        if (document) {\r\n          createdVoucherIds.push(asSystemId(document.systemId));\r\n        }\r\n      });\r\n\r\n      if (createdVoucherIds.length > 0) {\r\n        baseStore.getState().update(newReturn.systemId, {\r\n          ...newReturn,\r\n          receiptVoucherSystemIds: createdVoucherIds,\r\n        });\r\n      }\r\n    }\r\n\r\n    // ‚úÖ Update inventory for returned items ONLY if isReceived = true\r\n    // ‚úÖ For combo products, add stock to child products instead\r\n    if (newReturn.isReceived) {\r\n        console.log('‚úÖ [Sales Return] Updating inventory - items received');\r\n        \r\n        // Expand combo items to child products\r\n        const stockItems = getReturnStockItems(newReturn.items);\r\n        \r\n        stockItems.forEach(item => {\r\n          if (item.quantity > 0) {\r\n            const product = useProductStore.getState().findById(item.productSystemId);\r\n            const oldStock = product?.inventoryByBranch[newReturn.branchSystemId] || 0;\r\n            updateInventory(item.productSystemId, newReturn.branchSystemId, item.quantity); // Add stock back\r\n            addStockHistory({\r\n              productId: item.productSystemId,\r\n              date: getCurrentDate().toISOString(),\r\n              employeeName: newReturn.creatorName,\r\n              action: 'Nh·∫≠p h√†ng t·ª´ kh√°ch tr·∫£',\r\n              quantityChange: item.quantity,\r\n              newStockLevel: oldStock + item.quantity,\r\n              documentId: newReturn.id, // ‚úÖ Use business ID for document reference\r\n              branchSystemId: newReturn.branchSystemId,\r\n              branch: newReturn.branchName,\r\n            });\r\n          }\r\n        });\r\n    } else {\r\n        console.log('‚è∏Ô∏è [Sales Return] Inventory NOT updated - waiting for receipt confirmation');\r\n    }\r\n\r\n    // Update original order's return status\r\n    const previousReturnsForOrder = baseStore.getState().data.filter(r => r.orderSystemId === order.systemId);\r\n    const totalReturnedQty = previousReturnsForOrder.flatMap(r => r.items).reduce((sum, item) => sum + item.returnQuantity, 0);\r\n    const totalOrderedQty = order.lineItems.reduce((sum, item) => sum + item.quantity, 0);\r\n    const newReturnStatus = totalReturnedQty >= totalOrderedQty ? 'Tr·∫£ h√†ng to√†n b·ªô' : 'Tr·∫£ h√†ng m·ªôt ph·∫ßn';\r\n    updateOrder(order.systemId, { ...order, returnStatus: newReturnStatus });\r\n    \r\n    return { newReturn, newOrderSystemId };\r\n  },\r\n  \r\n  /**\r\n   * ‚úÖ Confirm receipt of returned items and update inventory\r\n   * Use this when isReceived was false initially and items are now received\r\n   * ‚úÖ For combo products, add stock to child products instead\r\n   */\r\n  confirmReceipt: (returnSystemId: SystemId) => {\r\n    const salesReturn = baseStore.getState().findById(returnSystemId);\r\n    if (!salesReturn) {\r\n      console.error('‚ùå [Sales Return] Return not found:', returnSystemId);\r\n      return { success: false, message: 'Kh√¥ng t√¨m th·∫•y phi·∫øu tr·∫£ h√†ng' };\r\n    }\r\n    \r\n    if (salesReturn.isReceived) {\r\n      console.warn('‚ö†Ô∏è [Sales Return] Already received:', returnSystemId);\r\n      return { success: false, message: 'H√†ng ƒë√£ ƒë∆∞·ª£c nh·∫≠n tr∆∞·ªõc ƒë√≥' };\r\n    }\r\n    \r\n    const { updateInventory } = useProductStore.getState();\r\n    const { addEntry: addStockHistory } = useStockHistoryStore.getState();\r\n    \r\n    // ‚úÖ Expand combo items to child products\r\n    const stockItems = getReturnStockItems(salesReturn.items);\r\n    \r\n    // Update inventory for all returned items (including expanded combo children)\r\n    stockItems.forEach(item => {\r\n      if (item.quantity > 0) {\r\n        const product = useProductStore.getState().findById(item.productSystemId);\r\n        const oldStock = product?.inventoryByBranch[salesReturn.branchSystemId] || 0;\r\n        updateInventory(item.productSystemId, salesReturn.branchSystemId, item.quantity);\r\n        addStockHistory({\r\n          productId: item.productSystemId,\r\n          date: getCurrentDate().toISOString(),\r\n          employeeName: salesReturn.creatorName,\r\n          action: 'Nh·∫≠p h√†ng t·ª´ kh√°ch tr·∫£ (x√°c nh·∫≠n)',\r\n          quantityChange: item.quantity,\r\n          newStockLevel: oldStock + item.quantity,\r\n          documentId: salesReturn.id,\r\n          branchSystemId: salesReturn.branchSystemId,\r\n          branch: salesReturn.branchName,\r\n        });\r\n      }\r\n    });\r\n    \r\n    // Update the return record\r\n    baseStore.getState().update(returnSystemId, {\r\n      ...salesReturn,\r\n      isReceived: true,\r\n    });\r\n    \r\n    console.log('‚úÖ [Sales Return] Receipt confirmed and inventory updated:', returnSystemId);\r\n    return { success: true, message: 'ƒê√£ x√°c nh·∫≠n nh·∫≠n h√†ng v√† c·∫≠p nh·∫≠t t·ªìn kho' };\r\n  },\r\n};\r\n\r\n// Export typed hook\r\nexport const useSalesReturnStore = (): any => {\r\n  const state = baseStore();\r\n  return {\r\n    ...state,\r\n    ...augmentedMethods,\r\n  };\r\n};\r\n\r\n// Export getState for non-hook usage\r\nuseSalesReturnStore.getState = (): any => {\r\n  const state = baseStore.getState();\r\n  return {\r\n    ...state,\r\n    ...augmentedMethods,\r\n  };\r\n};\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 3038, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/shipments/store.ts"],"sourcesContent":["/**\r\n * Shipment Store - Entity ri√™ng cho v·∫≠n ƒë∆°n\r\n * \r\n * ‚ö†Ô∏è ID Format theo ID-GOVERNANCE.md:\r\n * - SystemId: SHIPMENT000001\r\n * - BusinessId: VC000001\r\n * \r\n * Relationship: Shipment 1:1 Packaging (via packagingSystemId)\r\n */\r\n\r\nimport { create } from 'zustand';\r\nimport type { SystemId, BusinessId } from '../../lib/id-types';\r\nimport { asSystemId, asBusinessId } from '../../lib/id-types';\r\nimport { generateSystemId, generateBusinessId, getMaxSystemIdCounter, getMaxBusinessIdCounter } from '../../lib/id-utils';\r\nimport type { Shipment } from './types';\r\n\r\n// ========================================\r\n// CONSTANTS\r\n// ========================================\r\n\r\nconst SHIPMENT_SYSTEM_ID_PREFIX = 'SHIPMENT';\r\nconst SHIPMENT_BUSINESS_ID_PREFIX = 'VC';\r\n\r\n// ========================================\r\n// INITIAL SEED DATA\r\n// ========================================\r\n\r\nconst initialData: Shipment[] = [\r\n    {\r\n        systemId: asSystemId('SHIPMENT000001'),\r\n        id: asBusinessId('VC000001'),\r\n        packagingSystemId: asSystemId('PACKAGE000001'),\r\n        orderSystemId: asSystemId('ORDER000001'),\r\n        orderId: asBusinessId('DH000001'),\r\n        trackingCode: 'GHN000001',\r\n        carrier: 'GHN',\r\n        service: 'Chu·∫©n',\r\n        deliveryStatus: 'ƒê√£ giao h√†ng',\r\n        printStatus: 'ƒê√£ in',\r\n        reconciliationStatus: 'ƒê√£ ƒë·ªëi so√°t',\r\n        shippingFeeToPartner: 25000,\r\n        codAmount: 0,\r\n        payer: 'Ng∆∞·ªùi g·ª≠i',\r\n        createdAt: '2025-11-01 08:30',\r\n        dispatchedAt: '2025-11-02 08:00',\r\n        deliveredAt: '2025-11-05 15:30',\r\n    },\r\n    {\r\n        systemId: asSystemId('SHIPMENT000002'),\r\n        id: asBusinessId('VC000002'),\r\n        packagingSystemId: asSystemId('PACKAGE000002'),\r\n        orderSystemId: asSystemId('ORDER000002'),\r\n        orderId: asBusinessId('DH000002'),\r\n        trackingCode: 'JT000245',\r\n        carrier: 'J&T Express',\r\n        service: 'G√≥i chu·∫©n',\r\n        deliveryStatus: 'ƒêang giao h√†ng',\r\n        printStatus: 'ƒê√£ in',\r\n        reconciliationStatus: 'Ch∆∞a ƒë·ªëi so√°t',\r\n        shippingFeeToPartner: 30000,\r\n        codAmount: 5000000,\r\n        payer: 'Ng∆∞·ªùi nh·∫≠n',\r\n        createdAt: '2025-11-03 16:00',\r\n        dispatchedAt: '2025-11-04 09:00',\r\n    },\r\n    // Th√™m d·ªØ li·ªáu m·∫´u m·ªõi\r\n    {\r\n        systemId: asSystemId('SHIPMENT000003'),\r\n        id: asBusinessId('VC000003'),\r\n        packagingSystemId: asSystemId('PACKAGE000005'),\r\n        orderSystemId: asSystemId('ORDER000005'),\r\n        orderId: asBusinessId('DH000005'),\r\n        trackingCode: 'GHTK123456',\r\n        carrier: 'GHTK',\r\n        service: 'Nhanh',\r\n        deliveryStatus: 'ƒê√£ giao h√†ng',\r\n        printStatus: 'ƒê√£ in',\r\n        reconciliationStatus: 'Ch∆∞a ƒë·ªëi so√°t',\r\n        shippingFeeToPartner: 35000,\r\n        codAmount: 12500000,\r\n        payer: 'Ng∆∞·ªùi nh·∫≠n',\r\n        createdAt: '2025-11-08 10:00',\r\n        dispatchedAt: '2025-11-08 14:00',\r\n        deliveredAt: '2025-11-10 11:30',\r\n    },\r\n    {\r\n        systemId: asSystemId('SHIPMENT000004'),\r\n        id: asBusinessId('VC000004'),\r\n        packagingSystemId: asSystemId('PACKAGE000006'),\r\n        orderSystemId: asSystemId('ORDER000006'),\r\n        orderId: asBusinessId('DH000006'),\r\n        trackingCode: 'VTP789012',\r\n        carrier: 'Viettel Post',\r\n        service: 'Ti√™u chu·∫©n',\r\n        deliveryStatus: 'ƒêang giao h√†ng',\r\n        printStatus: 'ƒê√£ in',\r\n        reconciliationStatus: 'Ch∆∞a ƒë·ªëi so√°t',\r\n        shippingFeeToPartner: 28000,\r\n        codAmount: 8900000,\r\n        payer: 'Ng∆∞·ªùi nh·∫≠n',\r\n        createdAt: '2025-11-09 09:15',\r\n        dispatchedAt: '2025-11-09 15:30',\r\n    },\r\n    {\r\n        systemId: asSystemId('SHIPMENT000005'),\r\n        id: asBusinessId('VC000005'),\r\n        packagingSystemId: asSystemId('PACKAGE000007'),\r\n        orderSystemId: asSystemId('ORDER000007'),\r\n        orderId: asBusinessId('DH000007'),\r\n        trackingCode: 'GHN345678',\r\n        carrier: 'GHN',\r\n        service: 'Express',\r\n        deliveryStatus: 'ƒê√£ giao h√†ng',\r\n        printStatus: 'ƒê√£ in',\r\n        reconciliationStatus: 'Ch∆∞a ƒë·ªëi so√°t',\r\n        shippingFeeToPartner: 45000,\r\n        codAmount: 23800000,\r\n        payer: 'Ng∆∞·ªùi nh·∫≠n',\r\n        createdAt: '2025-11-07 08:00',\r\n        dispatchedAt: '2025-11-07 10:00',\r\n        deliveredAt: '2025-11-08 09:30',\r\n    },\r\n    {\r\n        systemId: asSystemId('SHIPMENT000006'),\r\n        id: asBusinessId('VC000006'),\r\n        packagingSystemId: asSystemId('PACKAGE000008'),\r\n        orderSystemId: asSystemId('ORDER000008'),\r\n        orderId: asBusinessId('DH000008'),\r\n        trackingCode: 'BEST567890',\r\n        carrier: 'Best Express',\r\n        service: 'Ti·∫øt ki·ªám',\r\n        deliveryStatus: 'Ch·ªù l·∫•y h√†ng',\r\n        printStatus: 'ƒê√£ in',\r\n        reconciliationStatus: 'Ch∆∞a ƒë·ªëi so√°t',\r\n        shippingFeeToPartner: 22000,\r\n        codAmount: 4500000,\r\n        payer: 'Ng∆∞·ªùi nh·∫≠n',\r\n        createdAt: '2025-11-10 07:30',\r\n    },\r\n    {\r\n        systemId: asSystemId('SHIPMENT000007'),\r\n        id: asBusinessId('VC000007'),\r\n        packagingSystemId: asSystemId('PACKAGE000009'),\r\n        orderSystemId: asSystemId('ORDER000009'),\r\n        orderId: asBusinessId('DH000009'),\r\n        trackingCode: 'NJV901234',\r\n        carrier: 'Ninja Van',\r\n        service: 'Standard',\r\n        deliveryStatus: 'ƒê√£ giao h√†ng',\r\n        printStatus: 'ƒê√£ in',\r\n        reconciliationStatus: 'ƒê√£ ƒë·ªëi so√°t',\r\n        shippingFeeToPartner: 32000,\r\n        codAmount: 15600000,\r\n        payer: 'Ng∆∞·ªùi g·ª≠i',\r\n        createdAt: '2025-11-05 11:00',\r\n        dispatchedAt: '2025-11-05 16:00',\r\n        deliveredAt: '2025-11-07 14:30',\r\n    },\r\n    {\r\n        systemId: asSystemId('SHIPMENT000008'),\r\n        id: asBusinessId('VC000008'),\r\n        packagingSystemId: asSystemId('PACKAGE000010'),\r\n        orderSystemId: asSystemId('ORDER000010'),\r\n        orderId: asBusinessId('DH000010'),\r\n        trackingCode: 'JT567891',\r\n        carrier: 'J&T Express',\r\n        service: 'Si√™u t·ªëc',\r\n        deliveryStatus: 'ƒêang giao h√†ng',\r\n        printStatus: 'ƒê√£ in',\r\n        reconciliationStatus: 'Ch∆∞a ƒë·ªëi so√°t',\r\n        shippingFeeToPartner: 55000,\r\n        codAmount: 31200000,\r\n        payer: 'Ng∆∞·ªùi nh·∫≠n',\r\n        createdAt: '2025-11-10 14:00',\r\n        dispatchedAt: '2025-11-10 16:30',\r\n    },\r\n];\r\n\r\n// ========================================\r\n// STORE INTERFACE\r\n// ========================================\r\n\r\nexport interface ShipmentStoreState {\r\n    data: Shipment[];\r\n    \r\n    // CRUD\r\n    findById: (systemId: string) => Shipment | undefined;\r\n    findByPackagingSystemId: (packagingSystemId: string) => Shipment | undefined;\r\n    findByTrackingCode: (trackingCode: string) => Shipment | undefined;\r\n    \r\n    // Actions\r\n    createShipment: (data: Omit<Shipment, 'systemId' | 'id'>) => Shipment;\r\n    updateShipment: (systemId: SystemId, updates: Partial<Shipment>) => void;\r\n    deleteShipment: (systemId: SystemId) => void;\r\n    \r\n    // Counters\r\n    getNextSystemId: () => SystemId;\r\n    getNextBusinessId: () => BusinessId;\r\n}\r\n\r\n// ========================================\r\n// HELPER FUNCTIONS\r\n// ========================================\r\n\r\nlet shipmentSystemIdCounter = 0;\r\nlet shipmentBusinessIdCounter = 0;\r\n\r\nfunction initCounters(shipments: Shipment[]) {\r\n    shipmentSystemIdCounter = getMaxSystemIdCounter(shipments, SHIPMENT_SYSTEM_ID_PREFIX);\r\n    shipmentBusinessIdCounter = getMaxBusinessIdCounter(shipments, SHIPMENT_BUSINESS_ID_PREFIX);\r\n}\r\n\r\nfunction getNextShipmentSystemId(): SystemId {\r\n    shipmentSystemIdCounter++;\r\n    return generateSystemId('shipments', shipmentSystemIdCounter) as SystemId;\r\n}\r\n\r\nfunction getNextShipmentBusinessId(): BusinessId {\r\n    shipmentBusinessIdCounter++;\r\n    return generateBusinessId('shipments', shipmentBusinessIdCounter) as BusinessId;\r\n}\r\n\r\n// Initialize counters\r\ninitCounters(initialData);\r\n\r\n// ========================================\r\n// STORE CREATION\r\n// ========================================\r\n\r\nexport const useShipmentStore = create<ShipmentStoreState>()(\r\n    (set, get) => ({\r\n            data: initialData,\r\n            \r\n            findById: (systemId: string) => {\r\n                return get().data.find(s => s.systemId === systemId);\r\n            },\r\n            \r\n            findByPackagingSystemId: (packagingSystemId: string) => {\r\n                return get().data.find(s => s.packagingSystemId === packagingSystemId);\r\n            },\r\n            \r\n            findByTrackingCode: (trackingCode: string) => {\r\n                return get().data.find(s => s.trackingCode === trackingCode);\r\n            },\r\n            \r\n            createShipment: (data: Omit<Shipment, 'systemId' | 'id'>) => {\r\n                const newShipment: Shipment = {\r\n                    systemId: getNextShipmentSystemId(),\r\n                    id: getNextShipmentBusinessId(),\r\n                    ...data,\r\n                };\r\n                \r\n                set(state => ({\r\n                    data: [...state.data, newShipment]\r\n                }));\r\n                \r\n                return newShipment;\r\n            },\r\n            \r\n            updateShipment: (systemId: SystemId, updates: Partial<Shipment>) => {\r\n                set(state => ({\r\n                    data: state.data.map(s => \r\n                        s.systemId === systemId \r\n                            ? { ...s, ...updates }\r\n                            : s\r\n                    )\r\n                }));\r\n            },\r\n            \r\n            deleteShipment: (systemId: SystemId) => {\r\n                set(state => ({\r\n                    data: state.data.filter(s => s.systemId !== systemId)\r\n                }));\r\n            },\r\n            \r\n            getNextSystemId: () => getNextShipmentSystemId(),\r\n            getNextBusinessId: () => getNextShipmentBusinessId(),\r\n        })\r\n);\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 3278, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/orders/store.ts"],"sourcesContent":["import { create } from 'zustand';\r\n// persist middleware removed - database is now source of truth\r\nimport { formatDate, formatDateCustom, toISODate, toISODateTime } from '../../lib/date-utils';\r\nimport { getApiUrl } from '../../lib/api-config';\r\nimport { createCrudStore } from '../../lib/store-factory';\r\n// REMOVED: import { data as initialDataOmit } from './data'; // Mock data no longer used - database is source of truth\r\nimport type { Order, OrderPayment, Packaging, OrderMainStatus, OrderDeliveryStatus, PackagingStatus, OrderPaymentStatus, OrderDeliveryMethod } from './types';\r\nimport type { SystemId, BusinessId } from '../../lib/id-types';\r\nimport { asSystemId, asBusinessId } from '../../lib/id-types';\r\nimport { generateSystemId, getMaxSystemIdCounter } from '../../lib/id-utils';\r\n\r\nimport { useEmployeeStore } from '../employees/store';\r\n// REMOVED: Voucher store no longer exists - using Payment/Receipt stores instead\r\nimport { useProductStore } from '../products/store';\r\nimport { isComboProduct } from '../products/combo-utils';\r\nimport { useStockHistoryStore } from '../stock-history/store';\r\nimport { useCustomerStore } from '../customers/store';\r\nimport { useReceiptTypeStore } from '../settings/receipt-types/store';\r\n// REMOVED: import type { Voucher } from '../vouchers/types';\r\nimport { useCashbookStore } from '../cashbook/store';\r\nimport { useReceiptStore } from '../receipts/store';\r\nimport type { Receipt, ReceiptOrderAllocation } from '../receipts/types';\r\nimport { useSalesReturnStore } from '../sales-returns/store';\r\nimport { createPaymentDocument, createReceiptDocument } from '../finance/document-helpers';\r\nimport { useShipmentStore } from '../shipments/store';\r\nimport type { Shipment } from '../shipments/types';\r\n\r\nimport { getCurrentUserSystemId } from '../../contexts/auth-context';\r\n\r\nimport { useSalesManagementSettingsStore } from '../settings/sales/sales-management-store';\r\nimport {\r\n  getCurrentUserInfo,\r\n  createCreatedEntry,\r\n  createHistoryEntry,\r\n  appendHistoryEntry,\r\n  type HistoryEntry\r\n} from '../../lib/activity-history-helper';\r\n\r\n// ‚úÖ Helper to get branch systemId\r\nconst getBranchId = (order: Order) => order.branchSystemId;\r\n\r\nconst deliveryStatusesBlockedForCancellation: OrderDeliveryStatus[] = [\r\n    'ƒêang giao h√†ng',\r\n    'ƒê√£ giao h√†ng',\r\n    'Ch·ªù giao l·∫°i',\r\n];\r\n\r\nconst IN_STORE_PICKUP_PREFIX = 'INSTORE';\r\n\r\nconst PACKAGING_CODE_PREFIX = 'DG';\r\nconst PACKAGING_SYSTEM_ID_PREFIX = 'PACKAGE';\r\n\r\n// ‚úÖ Track packaging systemId counter globally\r\nlet packagingSystemIdCounter = 0;\r\n\r\n// ‚úÖ Initialize counter from all existing packagings across all orders\r\nconst initPackagingCounter = (orders: Order[]): void => {\r\n    const allPackagings = orders.flatMap(o => o.packagings || []);\r\n    packagingSystemIdCounter = getMaxSystemIdCounter(allPackagings, PACKAGING_SYSTEM_ID_PREFIX);\r\n};\r\n\r\n// ‚úÖ Generate next packaging systemId\r\nconst getNextPackagingSystemId = (): SystemId => {\r\n    packagingSystemIdCounter++;\r\n    return asSystemId(generateSystemId('packaging', packagingSystemIdCounter));\r\n};\r\n\r\nconst getPackagingSuffixFromOrderId = (orderId?: BusinessId) => {\r\n    if (!orderId) return '';\r\n    const rawValue = `${orderId}`;\r\n    const suffix = rawValue.replace(/^[A-Z-]+/, '');\r\n    return suffix || rawValue;\r\n};\r\n\r\n// Count only active packagings (not cancelled) for numbering\r\nconst getActivePackagingCount = (packagings: Packaging[]): number => {\r\n    return packagings.filter(p => p.status !== 'H·ªßy ƒë√≥ng g√≥i').length;\r\n};\r\n\r\nconst buildPackagingBusinessId = (orderId: BusinessId, activeIndex: number, activeCount: number): BusinessId => {\r\n    const suffix = getPackagingSuffixFromOrderId(orderId);\r\n    const baseCode = `${PACKAGING_CODE_PREFIX}${suffix || '000000'}`;\r\n    // Only add suffix if there are multiple active packagings\r\n    if (activeCount > 1 && activeIndex > 0) {\r\n        const paddedIndex = String(activeIndex + 1).padStart(2, '0');\r\n        return asBusinessId(`${baseCode}-${paddedIndex}`);\r\n    }\r\n    return asBusinessId(baseCode);\r\n};\r\n\r\nconst getReturnedValueForOrder = (orderSystemId: SystemId): number => {\r\n    return useSalesReturnStore.getState().data\r\n        .filter(sr => sr.orderSystemId === orderSystemId)\r\n        .reduce((sum, sr) => sum + sr.totalReturnValue, 0);\r\n};\r\n\r\nconst calculateActualDebt = (order: Order): number => {\r\n    const totalReturnedValue = getReturnedValueForOrder(order.systemId);\r\n    return Math.max(order.grandTotal - totalReturnedValue, 0);\r\n};\r\n\r\nconst calculateTotalPaid = (payments: OrderPayment[]): number => {\r\n    return payments.reduce((sum, payment) => sum + payment.amount, 0);\r\n};\r\n\r\nconst getOrderOutstandingAmount = (order: Order): number => {\r\n    const actualDebt = calculateActualDebt(order);\r\n    const totalPaid = calculateTotalPaid(order.payments ?? []);\r\n    return Math.max(actualDebt - totalPaid, 0);\r\n};\r\n\r\nconst applyPaymentToOrder = (order: Order, payment: OrderPayment): Order => {\r\n    const updatedPayments = [...(order.payments ?? []), payment];\r\n    const totalPaid = calculateTotalPaid(updatedPayments);\r\n    const actualDebt = calculateActualDebt(order);\r\n\r\n    let newPaymentStatus: OrderPaymentStatus = 'Ch∆∞a thanh to√°n';\r\n    if (totalPaid >= actualDebt) {\r\n        newPaymentStatus = 'Thanh to√°n to√†n b·ªô';\r\n    } else if (totalPaid > 0) {\r\n        newPaymentStatus = 'Thanh to√°n 1 ph·∫ßn';\r\n    }\r\n\r\n    const wasCompleted = order.status === 'Ho√†n th√†nh';\r\n    let newStatus = order.status;\r\n    let newCompletedDate = order.completedDate;\r\n\r\n    if (newPaymentStatus === 'Thanh to√°n to√†n b·ªô' && order.deliveryStatus === 'ƒê√£ giao h√†ng') {\r\n        newStatus = 'Ho√†n th√†nh';\r\n        newCompletedDate = toISODateTime(new Date());\r\n        if (!wasCompleted) {\r\n            const { incrementOrderStats } = useCustomerStore.getState();\r\n            incrementOrderStats(order.customerSystemId, order.grandTotal);\r\n        }\r\n    }\r\n\r\n    const { updateDebtTransactionPayment } = useCustomerStore.getState();\r\n    updateDebtTransactionPayment(order.customerSystemId, order.id, payment.amount);\r\n\r\n    return {\r\n        ...order,\r\n        payments: updatedPayments,\r\n        paymentStatus: newPaymentStatus,\r\n        status: newStatus,\r\n        completedDate: newCompletedDate,\r\n        paidAmount: totalPaid,\r\n    };\r\n};\r\n\r\nconst shouldAutoAllocateReceipt = (receipt: Receipt): boolean => {\r\n    return (\r\n        receipt.status === 'completed' &&\r\n        receipt.affectsDebt &&\r\n        !!receipt.customerSystemId &&\r\n        !receipt.linkedOrderSystemId\r\n    );\r\n};\r\n\r\nconst getAllocatedAmount = (receipt: Receipt): number => {\r\n    return receipt.orderAllocations?.reduce((sum, allocation) => sum + allocation.amount, 0) ?? 0;\r\n};\r\n\r\nconst autoAllocateReceiptToOrders = (receipt: Receipt) => {\r\n    if (!shouldAutoAllocateReceipt(receipt)) {\r\n        return;\r\n    }\r\n\r\n    const remainingAmount = receipt.amount - getAllocatedAmount(receipt);\r\n    if (remainingAmount <= 0) {\r\n        return;\r\n    }\r\n\r\n    const candidateOrders = baseStore.getState().data\r\n        .filter(order => order.customerSystemId === receipt.customerSystemId && order.status !== 'ƒê√£ h·ªßy')\r\n        .map(order => ({ order, outstanding: getOrderOutstandingAmount(order) }))\r\n        .filter(entry => entry.outstanding > 0)\r\n        .sort((a, b) => {\r\n            const aTime = a.order.orderDate ? new Date(a.order.orderDate).getTime() : 0;\r\n            const bTime = b.order.orderDate ? new Date(b.order.orderDate).getTime() : 0;\r\n            return aTime - bTime;\r\n        });\r\n\r\n    if (!candidateOrders.length) {\r\n        return;\r\n    }\r\n\r\n    let amountToDistribute = remainingAmount;\r\n    const updatedOrders = new Map<SystemId, Order>();\r\n    const allocationEntries: ReceiptOrderAllocation[] = [];\r\n\r\n    for (const { order } of candidateOrders) {\r\n        if (amountToDistribute <= 0) {\r\n            break;\r\n        }\r\n\r\n        const currentOrderState = updatedOrders.get(order.systemId) ?? order;\r\n        const outstanding = getOrderOutstandingAmount(currentOrderState);\r\n        if (outstanding <= 0) {\r\n            continue;\r\n        }\r\n\r\n        const allocationAmount = Math.min(outstanding, amountToDistribute);\r\n        if (allocationAmount <= 0) {\r\n            continue;\r\n        }\r\n\r\n        const paymentEntry: OrderPayment = {\r\n            systemId: receipt.systemId,\r\n            id: receipt.id,\r\n            date: receipt.date,\r\n            amount: allocationAmount,\r\n            method: receipt.paymentMethodName,\r\n            createdBy: asSystemId(receipt.createdBy),\r\n            description: receipt.description ?? `Thanh to√°n t·ª´ phi·∫øu thu ${receipt.id}`,\r\n        };\r\n\r\n        const updatedOrder = applyPaymentToOrder(currentOrderState, paymentEntry);\r\n        updatedOrders.set(order.systemId, updatedOrder);\r\n        allocationEntries.push({\r\n            orderSystemId: order.systemId,\r\n            orderId: order.id,\r\n            amount: allocationAmount,\r\n        });\r\n\r\n        amountToDistribute -= allocationAmount;\r\n    }\r\n\r\n    if (!allocationEntries.length) {\r\n        return;\r\n    }\r\n\r\n    baseStore.setState(state => {\r\n        const data = state.data.map(order => updatedOrders.get(order.systemId) ?? order);\r\n        return { data };\r\n    });\r\n\r\n    const receiptStore = useReceiptStore.getState();\r\n    const latestReceipt = receiptStore.findById(receipt.systemId);\r\n    if (!latestReceipt) {\r\n        return;\r\n    }\r\n\r\n    receiptStore.update(receipt.systemId, {\r\n        ...latestReceipt,\r\n        orderAllocations: [...(latestReceipt.orderAllocations ?? []), ...allocationEntries],\r\n    });\r\n};\r\n\r\nconst ensureOrderPackagingIdentifiers = (order: Order): Order | null => {\r\n    if (!order.packagings || order.packagings.length === 0) {\r\n        return null;\r\n    }\r\n\r\n    // Count only active packagings for proper numbering\r\n    const activePackagings = order.packagings.filter(p => p.status !== 'H·ªßy ƒë√≥ng g√≥i');\r\n    const activeCount = activePackagings.length;\r\n    let changed = false;\r\n    let activeIndex = 0;\r\n\r\n    const updatedPackagings = order.packagings.map((pkg, idx) => {\r\n        const isCancelled = pkg.status === 'H·ªßy ƒë√≥ng g√≥i';\r\n        const hasId = typeof pkg.id === 'string' && pkg.id.trim().length > 0;\r\n        // ‚úÖ Check for temp systemId or old format (PKG_)\r\n        const hasTempOrOldSystemId = pkg.systemId?.startsWith('PKG_TEMP_') || pkg.systemId?.startsWith('PKG_');\r\n        const hasValidSystemId = pkg.systemId?.startsWith(PACKAGING_SYSTEM_ID_PREFIX);\r\n        const shouldFixTracking = pkg.deliveryMethod === 'Nh·∫≠n t·∫°i c·ª≠a h√†ng' && pkg.trackingCode === `${IN_STORE_PICKUP_PREFIX}-`;\r\n\r\n        // For cancelled packagings, keep existing ID\r\n        if (isCancelled) {\r\n            if (!hasId || (hasTempOrOldSystemId && !hasValidSystemId)) {\r\n                // Still need to assign an ID if missing\r\n                const nextPkg = { ...pkg };\r\n                if (!hasId) {\r\n                    nextPkg.id = buildPackagingBusinessId(order.id, 0, 1);\r\n                }\r\n                if (hasTempOrOldSystemId && !hasValidSystemId) {\r\n                    nextPkg.systemId = getNextPackagingSystemId();\r\n                }\r\n                changed = true;\r\n                return nextPkg;\r\n            }\r\n            return pkg;\r\n        }\r\n\r\n        // For active packagings, use activeIndex for numbering\r\n        const currentActiveIndex = activeIndex;\r\n        activeIndex++;\r\n\r\n        if (hasId && !shouldFixTracking && hasValidSystemId) {\r\n            return pkg;\r\n        }\r\n\r\n        const nextPkg = { ...pkg };\r\n        if (!hasId) {\r\n            nextPkg.id = buildPackagingBusinessId(order.id, currentActiveIndex, activeCount);\r\n            changed = true;\r\n        }\r\n        \r\n        // ‚úÖ Fix temporary/old systemId to proper format PACKAGE000001\r\n        if (hasTempOrOldSystemId && !hasValidSystemId) {\r\n            nextPkg.systemId = getNextPackagingSystemId();\r\n            changed = true;\r\n        }\r\n\r\n        if (shouldFixTracking) {\r\n            const resolvedId = nextPkg.id ?? buildPackagingBusinessId(order.id, currentActiveIndex, activeCount);\r\n            nextPkg.trackingCode = `${IN_STORE_PICKUP_PREFIX}-${resolvedId}`;\r\n            changed = true;\r\n        }\r\n\r\n        return nextPkg;\r\n    });\r\n\r\n    return changed ? { ...order, packagings: updatedPackagings } : null;\r\n};\r\n\r\nconst ensureCancellationAllowed = (order: Order | undefined, actionLabel: string) => {\r\n    if (!order) return false;\r\n\r\n    const { allowCancelAfterExport } = useSalesManagementSettingsStore.getState();\r\n    if (allowCancelAfterExport) {\r\n        return true;\r\n    }\r\n\r\n    const hasLeftWarehouse =\r\n        order.stockOutStatus === 'Xu·∫•t kho to√†n b·ªô' ||\r\n        deliveryStatusesBlockedForCancellation.includes(order.deliveryStatus);\r\n\r\n    if (hasLeftWarehouse) {\r\n        alert(\r\n            `Kh√¥ng th·ªÉ ${actionLabel} v√¨ ƒë∆°n h√†ng ƒë√£ xu·∫•t kho. V√†o C·∫•u h√¨nh b√°n h√†ng -> Thi·∫øt l·∫≠p qu·∫£n l√Ω b√°n h√†ng v√† b·∫≠t \"Cho ph√©p h·ªßy ƒë∆°n h√†ng sau khi xu·∫•t kho\".`,\r\n        );\r\n        return false;\r\n    }\r\n\r\n    return true;\r\n};\r\n\r\n/**\r\n * ‚úÖ Helper ƒë·ªÉ x·ª≠ l√Ω stock cho combo ho·∫∑c s·∫£n ph·∫©m th∆∞·ªùng\r\n * Combo kh√¥ng c√≥ t·ªìn kho th·ª±c t·∫ø - thao t√°c tr√™n SP con\r\n */\r\ntype StockOperation = 'commit' | 'uncommit' | 'dispatch' | 'complete' | 'return';\r\n\r\nconst processLineItemStock = (\r\n    lineItem: { productSystemId: string; quantity: number },\r\n    branchSystemId: string,\r\n    operation: StockOperation,\r\n    orderQuantity: number = 1 // S·ªë l∆∞·ª£ng ƒë·∫∑t c·ªßa line item\r\n) => {\r\n    const { \r\n        findById: findProductById, \r\n        commitStock, \r\n        uncommitStock, \r\n        dispatchStock, \r\n        completeDelivery, \r\n        returnStockFromTransit \r\n    } = useProductStore.getState();\r\n    \r\n    const product = findProductById(asSystemId(lineItem.productSystemId));\r\n    \r\n    // X√°c ƒë·ªãnh danh s√°ch items c·∫ßn x·ª≠ l√Ω (SP con n·∫øu combo, ho·∫∑c ch√≠nh SP n·∫øu th∆∞·ªùng)\r\n    const itemsToProcess: { productSystemId: SystemId; quantity: number }[] = [];\r\n    \r\n    if (product && isComboProduct(product) && product.comboItems) {\r\n        // Combo: x·ª≠ l√Ω t·∫•t c·∫£ SP con\r\n        product.comboItems.forEach(comboItem => {\r\n            itemsToProcess.push({\r\n                productSystemId: asSystemId(comboItem.productSystemId),\r\n                quantity: orderQuantity * comboItem.quantity, // S·ªë l∆∞·ª£ng combo √ó s·ªë l∆∞·ª£ng SP con\r\n            });\r\n        });\r\n    } else {\r\n        // S·∫£n ph·∫©m th∆∞·ªùng\r\n        itemsToProcess.push({\r\n            productSystemId: asSystemId(lineItem.productSystemId),\r\n            quantity: orderQuantity,\r\n        });\r\n    }\r\n    \r\n    // Th·ª±c hi·ªán operation cho t·ª´ng item\r\n    itemsToProcess.forEach(item => {\r\n        const branchId = asSystemId(branchSystemId);\r\n        switch (operation) {\r\n            case 'commit':\r\n                commitStock(item.productSystemId, branchId, item.quantity);\r\n                break;\r\n            case 'uncommit':\r\n                uncommitStock(item.productSystemId, branchId, item.quantity);\r\n                break;\r\n            case 'dispatch':\r\n                dispatchStock(item.productSystemId, branchId, item.quantity);\r\n                break;\r\n            case 'complete':\r\n                completeDelivery(item.productSystemId, branchId, item.quantity);\r\n                break;\r\n            case 'return':\r\n                returnStockFromTransit(item.productSystemId, branchId, item.quantity);\r\n                break;\r\n        }\r\n    });\r\n    \r\n    return itemsToProcess; // Return ƒë·ªÉ c√≥ th·ªÉ d√πng cho stock history\r\n};\r\n\r\n/**\r\n * ‚úÖ Helper ƒë·ªÉ l·∫•y danh s√°ch stock items t·ª´ line items (m·ªü r·ªông combo th√†nh SP con)\r\n * D√πng trong webhook GHTK ho·∫∑c c√°c thao t√°c batch\r\n */\r\nconst getComboStockItems = (lineItems: { productSystemId: string; quantity: number }[]): { productSystemId: SystemId; quantity: number }[] => {\r\n    const { findById: findProductById } = useProductStore.getState();\r\n    const stockItems: { productSystemId: SystemId; quantity: number }[] = [];\r\n    \r\n    lineItems.forEach(item => {\r\n        const product = findProductById(asSystemId(item.productSystemId));\r\n        \r\n        if (product && isComboProduct(product) && product.comboItems) {\r\n            // Combo: m·ªü r·ªông th√†nh SP con\r\n            product.comboItems.forEach(comboItem => {\r\n                stockItems.push({\r\n                    productSystemId: asSystemId(comboItem.productSystemId),\r\n                    quantity: item.quantity * comboItem.quantity,\r\n                });\r\n            });\r\n        } else {\r\n            // S·∫£n ph·∫©m th∆∞·ªùng\r\n            stockItems.push({\r\n                productSystemId: asSystemId(item.productSystemId),\r\n                quantity: item.quantity,\r\n            });\r\n        }\r\n    });\r\n    \r\n    return stockItems;\r\n};\r\n\r\nconst createOrderRefundVoucher = (order: Order, amount: number, employeeId: SystemId) => {\r\n    const lastPositivePayment = [...(order.payments ?? [])].reverse().find(p => p.amount > 0);\r\n    const { document, error } = createPaymentDocument({\r\n        amount,\r\n        description: `Ho√†n ti·ªÅn do h·ªßy ƒë∆°n ${order.id}`,\r\n        recipientName: order.customerName,\r\n        recipientSystemId: order.customerSystemId,\r\n        customerSystemId: order.customerSystemId,\r\n        customerName: order.customerName,\r\n        branchSystemId: order.branchSystemId,\r\n        branchName: order.branchName,\r\n        createdBy: employeeId,\r\n        paymentMethodName: lastPositivePayment?.method || 'Ti·ªÅn m·∫∑t',\r\n        paymentTypeName: 'Ho√†n ti·ªÅn kh√°ch h√†ng',\r\n        originalDocumentId: order.id,\r\n        linkedOrderSystemId: order.systemId,\r\n        affectsDebt: true,\r\n        category: 'other',\r\n    });\r\n\r\n    if (!document) {\r\n        console.error('[cancelOrder] Kh√¥ng th·ªÉ t·∫°o phi·∫øu chi ho√†n ti·ªÅn', error);\r\n        return null;\r\n    }\r\n\r\n    return document;\r\n};\r\n\r\n// REMOVED: initialDataOmit transformation - database is source of truth\r\nconst initialData: Order[] = [];\r\n\r\nconst baseStore = createCrudStore<Order>([], 'orders', {\r\n  businessIdField: 'id',\r\n  apiEndpoint: '/api/orders',\r\n  getCurrentUser: () => {\r\n    return asSystemId(getCurrentUserSystemId());\r\n  }\r\n});\r\n\r\n// ‚úÖ API Sync helpers\r\nconst API_ENDPOINT = '/api/orders';\r\n\r\nconst syncToApi = {\r\n  create: async (order: Order) => {\r\n    try {\r\n      const response = await fetch(API_ENDPOINT, {\r\n        method: 'POST',\r\n        credentials: 'include',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify(order),\r\n      });\r\n      if (!response.ok) console.warn('[Order API] Create sync failed');\r\n      else console.log('[Order API] Created:', order.systemId);\r\n    } catch (e) {\r\n      console.warn('[Order API] Create sync error:', e);\r\n    }\r\n  },\r\n  update: async (systemId: SystemId, updates: Partial<Order>) => {\r\n    try {\r\n      const response = await fetch(`${API_ENDPOINT}/${systemId}`, {\r\n        method: 'PATCH',\r\n        credentials: 'include',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify(updates),\r\n      });\r\n      if (!response.ok) console.warn('[Order API] Update sync failed');\r\n      else console.log('[Order API] Updated:', systemId);\r\n    } catch (e) {\r\n      console.warn('[Order API] Update sync error:', e);\r\n    }\r\n  },\r\n  delete: async (systemId: SystemId, hard = false) => {\r\n    try {\r\n      const response = await fetch(`${API_ENDPOINT}/${systemId}`, {\r\n        method: 'DELETE',\r\n        credentials: 'include',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({ hard }),\r\n      });\r\n      if (!response.ok) console.warn('[Order API] Delete sync failed');\r\n      else console.log('[Order API] Deleted:', systemId);\r\n    } catch (e) {\r\n      console.warn('[Order API] Delete sync error:', e);\r\n    }\r\n  },\r\n  restore: async (systemId: SystemId) => {\r\n    try {\r\n      const response = await fetch(`${API_ENDPOINT}/${systemId}/restore`, {\r\n        method: 'POST',\r\n        credentials: 'include',\r\n        headers: { 'Content-Type': 'application/json' },\r\n      });\r\n      if (!response.ok) console.warn('[Order API] Restore sync failed');\r\n      else console.log('[Order API] Restored:', systemId);\r\n    } catch (e) {\r\n      console.warn('[Order API] Restore sync error:', e);\r\n    }\r\n  },\r\n};\r\n\r\n// ‚úÖ Wrap base store methods with API sync\r\nconst originalAdd = baseStore.getState().add;\r\nconst originalUpdate = baseStore.getState().update;\r\nconst originalRemove = baseStore.getState().remove;\r\nconst originalHardDelete = baseStore.getState().hardDelete;\r\nconst originalRestore = baseStore.getState().restore;\r\n\r\nbaseStore.setState({\r\n  add: (item: Omit<Order, 'systemId'>) => {\r\n    const result = originalAdd(item);\r\n    syncToApi.create(result);\r\n    return result;\r\n  },\r\n  update: (systemId: SystemId, updates: Partial<Order>) => {\r\n    originalUpdate(systemId, updates);\r\n    syncToApi.update(systemId, updates);\r\n  },\r\n  remove: (systemId: SystemId) => {\r\n    originalRemove(systemId);\r\n    syncToApi.delete(systemId, false);\r\n  },\r\n  hardDelete: (systemId: SystemId) => {\r\n    originalHardDelete(systemId);\r\n    syncToApi.delete(systemId, true);\r\n  },\r\n  restore: (systemId: SystemId) => {\r\n    originalRestore(systemId);\r\n    syncToApi.restore(systemId);\r\n  },\r\n});\r\n\r\n// ‚úÖ MIGRATION: Ensure all orders have paidAmount field (backward compatibility)\r\nbaseStore.setState(state => ({\r\n  data: state.data.map(order => ({\r\n    ...order,\r\n    paidAmount: order.paidAmount ?? 0, // Default to 0 if undefined\r\n  }))\r\n}));\r\n\r\n// ‚úÖ MIGRATION: Merge seed data - add new orders from initialData if not exist in persisted store\r\nbaseStore.setState(state => {\r\n  const existingIds = new Set(state.data.map(o => o.systemId));\r\n  const newOrders = initialData.filter(o => !existingIds.has(o.systemId));\r\n  if (newOrders.length > 0) {\r\n    return { data: [...state.data, ...newOrders] };\r\n  }\r\n  return state;\r\n});\r\n\r\n// ‚úÖ MIGRATION: Fix order status - orders with full payment and delivery should be \"Ho√†n th√†nh\"\r\nbaseStore.setState(state => ({\r\n  data: state.data.map(order => {\r\n    // If order is already completed or cancelled, skip\r\n    if (order.status === 'Ho√†n th√†nh' || order.status === 'ƒê√£ h·ªßy') {\r\n      return order;\r\n    }\r\n    \r\n    // Check if all active packagings are delivered\r\n    const activePackagings = order.packagings.filter(p => p.status !== 'H·ªßy ƒë√≥ng g√≥i');\r\n    const isAllDelivered = activePackagings.length > 0 && activePackagings.every(p => p.deliveryStatus === 'ƒê√£ giao h√†ng');\r\n    \r\n    // If fully paid and fully delivered, update status to \"Ho√†n th√†nh\"\r\n    if (order.paymentStatus === 'Thanh to√°n to√†n b·ªô' && (isAllDelivered || order.deliveryStatus === 'ƒê√£ giao h√†ng')) {\r\n      return {\r\n        ...order,\r\n        status: 'Ho√†n th√†nh' as OrderMainStatus,\r\n        completedDate: order.completedDate || toISODateTime(new Date()),\r\n      };\r\n    }\r\n    \r\n    return order;\r\n  })\r\n}));\r\n\r\nconst originalAddWithStock = baseStore.getState().add;\r\n\r\nbaseStore.setState({\r\n    add: (item) => {\r\n        const { commitStock, findById: findProductById } = useProductStore.getState();\r\n        const userInfo = getCurrentUserInfo();\r\n        const newItem = originalAddWithStock(item);\r\n        if (newItem) {\r\n            const hydratedPackagings = ensureOrderPackagingIdentifiers(newItem);\r\n            if (hydratedPackagings) {\r\n                Object.assign(newItem, hydratedPackagings);\r\n                baseStore.setState(state => ({\r\n                    data: state.data.map(order => order.systemId === hydratedPackagings.systemId ? hydratedPackagings : order),\r\n                }));\r\n            }\r\n            newItem.lineItems.forEach(li => {\r\n                const product = findProductById(asSystemId(li.productSystemId));\r\n                \r\n                // ‚úÖ X·ª≠ l√Ω combo: commit stock c·ªßa SP con thay v√¨ combo\r\n                if (product && isComboProduct(product) && product.comboItems) {\r\n                    product.comboItems.forEach(comboItem => {\r\n                        // Commit stock = s·ªë l∆∞·ª£ng combo √ó s·ªë l∆∞·ª£ng SP con trong combo\r\n                        const totalQuantity = li.quantity * comboItem.quantity;\r\n                        commitStock(asSystemId(comboItem.productSystemId), asSystemId(newItem.branchSystemId), totalQuantity);\r\n                    });\r\n                } else {\r\n                    // S·∫£n ph·∫©m th∆∞·ªùng: commit stock nh∆∞ b√¨nh th∆∞·ªùng\r\n                    commitStock(asSystemId(li.productSystemId), asSystemId(newItem.branchSystemId), li.quantity);\r\n                }\r\n            });\r\n            \r\n            // ‚úÖ C·∫≠p nh·∫≠t lastPurchaseDate khi t·∫°o ƒë∆°n m·ªõi (ƒë·ªÉ SLA/churn risk ho·∫°t ƒë·ªông ƒë√∫ng)\r\n            if (newItem.customerSystemId) {\r\n                const { update: updateCustomer, findById: findCustomer } = useCustomerStore.getState();\r\n                const customer = findCustomer(newItem.customerSystemId);\r\n                if (customer) {\r\n                    updateCustomer(newItem.customerSystemId, {\r\n                        lastPurchaseDate: new Date().toISOString().split('T')[0],\r\n                    });\r\n                }\r\n            }\r\n            \r\n            // ‚úÖ Add activity history entry\r\n            const historyEntry = createCreatedEntry(\r\n                userInfo,\r\n                `${userInfo.name} ƒë√£ t·∫°o ƒë∆°n h√†ng ${newItem.id} cho kh√°ch h√†ng ${newItem.customerName} (T·ªïng: ${newItem.grandTotal.toLocaleString('vi-VN')}ƒë)`\r\n            );\r\n            baseStore.setState(state => ({\r\n                data: state.data.map(order => order.systemId === newItem.systemId ? { ...order, activityHistory: [historyEntry] } : order),\r\n            }));\r\n        }\r\n        return newItem;\r\n    },\r\n});\r\n\r\nconst backfillPackagingIdentifiers = () => {\r\n    const currentState = baseStore.getState();\r\n    let changed = false;\r\n    const updatedData = currentState.data.map(order => {\r\n        const updatedOrder = ensureOrderPackagingIdentifiers(order);\r\n        if (updatedOrder) {\r\n            changed = true;\r\n            return updatedOrder;\r\n        }\r\n        return order;\r\n    });\r\n\r\n    if (changed) {\r\n        baseStore.setState({ data: updatedData });\r\n    }\r\n};\r\n\r\nbackfillPackagingIdentifiers();\r\n\r\nconst augmentedMethods = {\r\n    cancelOrder: (\r\n        systemId: SystemId,\r\n        employeeId: SystemId,\r\n        options?: { reason?: string; restock?: boolean }\r\n    ) => {\r\n        const { reason, restock = true } = options ?? {};\r\n        const currentOrder = baseStore.getState().data.find(o => o.systemId === systemId);\r\n        if (!ensureCancellationAllowed(currentOrder, 'h·ªßy ƒë∆°n h√†ng')) {\r\n            return;\r\n        }\r\n\r\n        baseStore.setState(state => {\r\n            const orderToCancel = state.data.find(o => o.systemId === systemId);\r\n            if (!orderToCancel || orderToCancel.status === 'ƒê√£ h·ªßy') {\r\n                return state;\r\n            }\r\n\r\n            const employee = useEmployeeStore.getState().findById(employeeId as SystemId);\r\n            const now = toISODateTime(new Date());\r\n            const cancellationReason = (reason && reason.trim().length > 0)\r\n                ? reason.trim()\r\n                : orderToCancel.cancellationReason || `H·ªßy b·ªüi ${employee?.fullName || 'H·ªá th·ªëng'}`;\r\n\r\n            // ‚úÖ Uncommit stock (h·ªó tr·ª£ combo)\r\n            if (restock) {\r\n                orderToCancel.lineItems.forEach(item => {\r\n                    processLineItemStock(item, orderToCancel.branchSystemId, 'uncommit', item.quantity);\r\n                });\r\n            }\r\n\r\n            const hasDispatchedStock = orderToCancel.stockOutStatus === 'Xu·∫•t kho to√†n b·ªô'\r\n                || ['Ch·ªù l·∫•y h√†ng', 'ƒêang giao h√†ng', 'ƒê√£ giao h√†ng', 'Ch·ªù giao l·∫°i'].includes(orderToCancel.deliveryStatus);\r\n\r\n            // ‚úÖ Return stock from transit (h·ªó tr·ª£ combo)\r\n            if (restock && hasDispatchedStock) {\r\n                orderToCancel.lineItems.forEach(item => {\r\n                    processLineItemStock(item, orderToCancel.branchSystemId, 'return', item.quantity);\r\n                });\r\n            }\r\n\r\n            const existingPayments = orderToCancel.payments ?? [];\r\n            const netCollected = existingPayments.reduce((sum, payment) => sum + payment.amount, 0);\r\n            let refundPaymentEntry: OrderPayment | null = null;\r\n            const refundAmount = netCollected > 0 ? netCollected : 0;\r\n\r\n            if (refundAmount > 0) {\r\n                const refundVoucher = createOrderRefundVoucher(orderToCancel, refundAmount, employeeId);\r\n                if (!refundVoucher) {\r\n                    alert('Kh√¥ng th·ªÉ t·∫°o phi·∫øu chi ho√†n ti·ªÅn. Vui l√≤ng ki·ªÉm tra c·∫•u h√¨nh t√†i ch√≠nh tr∆∞·ªõc khi h·ªßy ƒë∆°n.');\r\n                    return state;\r\n                }\r\n\r\n                refundPaymentEntry = {\r\n                    systemId: refundVoucher.systemId,\r\n                    id: refundVoucher.id,\r\n                    date: refundVoucher.date,\r\n                    amount: -refundAmount,\r\n                    method: refundVoucher.paymentMethodName,\r\n                    createdBy: employeeId,\r\n                    description: `Ho√†n ti·ªÅn khi h·ªßy ƒë∆°n ${orderToCancel.id}`,\r\n                };\r\n            }\r\n\r\n            const updatedPayments = refundPaymentEntry ? [...existingPayments, refundPaymentEntry] : existingPayments;\r\n            const updatedPaidAmount = Math.max(0, (orderToCancel.paidAmount ?? 0) - refundAmount);\r\n            const updatedPackagings = orderToCancel.packagings.map(pkg => {\r\n                if (pkg.status === 'H·ªßy ƒë√≥ng g√≥i' && pkg.deliveryStatus === 'ƒê√£ h·ªßy') {\r\n                    return pkg;\r\n                }\r\n                return {\r\n                    ...pkg,\r\n                    status: 'H·ªßy ƒë√≥ng g√≥i' as PackagingStatus,\r\n                    deliveryStatus: 'ƒê√£ h·ªßy' as OrderDeliveryStatus,\r\n                    cancelDate: now,\r\n                    cancelReason: pkg.cancelReason ?? cancellationReason,\r\n                    cancelingEmployeeId: employeeId,\r\n                    cancelingEmployeeName: employee?.fullName || 'H·ªá th·ªëng',\r\n                };\r\n            });\r\n\r\n            const updatedOrder = {\r\n                ...orderToCancel,\r\n                status: 'ƒê√£ h·ªßy' as OrderMainStatus,\r\n                cancelledDate: now,\r\n                cancellationReason,\r\n                deliveryStatus: 'ƒê√£ h·ªßy' as OrderDeliveryStatus,\r\n                stockOutStatus: restock ? 'Ch∆∞a xu·∫•t kho' as const : orderToCancel.stockOutStatus,\r\n                payments: updatedPayments,\r\n                paidAmount: updatedPaidAmount,\r\n                paymentStatus: refundPaymentEntry ? 'Ch∆∞a thanh to√°n' as OrderPaymentStatus : orderToCancel.paymentStatus,\r\n                packagings: updatedPackagings,\r\n                cancellationMetadata: {\r\n                    restockItems: restock,\r\n                    notifyCustomer: false,\r\n                    emailNotifiedAt: undefined,\r\n                },\r\n                activityHistory: appendHistoryEntry(\r\n                    orderToCancel.activityHistory,\r\n                    createHistoryEntry(\r\n                        'cancelled',\r\n                        getCurrentUserInfo(),\r\n                        `${employee?.fullName || 'H·ªá th·ªëng'} ƒë√£ h·ªßy ƒë∆°n h√†ng. L√Ω do: ${cancellationReason}${refundAmount > 0 ? `. Ho√†n ti·ªÅn: ${refundAmount.toLocaleString('vi-VN')}ƒë` : ''}`\r\n                    )\r\n                ),\r\n            };\r\n\r\n            // ‚úÖ Remove debt transaction from customer\r\n            useCustomerStore.getState().removeDebtTransaction(orderToCancel.customerSystemId, orderToCancel.id);\r\n\r\n            return { data: state.data.map(o => (o.systemId === systemId ? updatedOrder : o)) };\r\n        });\r\n    },\r\n\r\n    addPayment: (orderSystemId: SystemId, paymentData: { amount: number; method: string }, employeeId: SystemId) => {\r\n        // --- Side effects must happen outside setState ---\r\n        const order = baseStore.getState().findById(orderSystemId as SystemId);\r\n        const employee = useEmployeeStore.getState().findById(employeeId as SystemId);\r\n\r\n        if (!order || !employee) {\r\n            console.error(\"Order or employee not found for payment.\");\r\n            return;\r\n        }\r\n\r\n        const { document: createdReceipt, error } = createReceiptDocument({\r\n            amount: paymentData.amount,\r\n            description: `Thanh to√°n cho ƒë∆°n h√†ng ${order.id}`,\r\n            customerName: order.customerName,\r\n            customerSystemId: order.customerSystemId,\r\n            branchSystemId: order.branchSystemId,\r\n            branchName: order.branchName,\r\n            createdBy: employeeId,\r\n            paymentMethodName: paymentData.method,\r\n            receiptTypeName: 'Thanh to√°n cho ƒë∆°n h√†ng',\r\n            originalDocumentId: order.id,\r\n            linkedOrderSystemId: order.systemId,\r\n            affectsDebt: true,\r\n        });\r\n\r\n        if (!createdReceipt) {\r\n            console.error('Failed to create receipt', error);\r\n            alert('Kh√¥ng th·ªÉ t·∫°o phi·∫øu thu cho ƒë∆°n h√†ng. Vui l√≤ng ki·ªÉm tra c·∫•u h√¨nh ch·ª©ng t·ª´.');\r\n            return;\r\n        }\r\n\r\n        // 2. Now, update the order state with the created receipt info\r\n        baseStore.setState(state => {\r\n            const orderIndex = state.data.findIndex(o => o.systemId === orderSystemId);\r\n            if (orderIndex === -1) return state;\r\n\r\n            const orderToUpdate = state.data[orderIndex];\r\n            const newPayment: OrderPayment = {\r\n                systemId: createdReceipt.systemId,\r\n                id: createdReceipt.id,\r\n                date: createdReceipt.date,\r\n                amount: createdReceipt.amount,\r\n                method: createdReceipt.paymentMethodName,\r\n                createdBy: asSystemId(createdReceipt.createdBy),\r\n                description: createdReceipt.description,\r\n            };\r\n\r\n            const updatedOrder = applyPaymentToOrder(orderToUpdate, newPayment);\r\n            \r\n            // ‚úÖ Add activity history entry\r\n            updatedOrder.activityHistory = appendHistoryEntry(\r\n                orderToUpdate.activityHistory,\r\n                createHistoryEntry(\r\n                    'payment_made',\r\n                    getCurrentUserInfo(),\r\n                    `${employee?.fullName || 'Nh√¢n vi√™n'} ƒë√£ thanh to√°n ${paymentData.amount.toLocaleString('vi-VN')}ƒë b·∫±ng ${paymentData.method}`\r\n                )\r\n            );\r\n            \r\n            const newData = [...state.data];\r\n            newData[orderIndex] = updatedOrder;\r\n\r\n            return { data: newData };\r\n        });\r\n    },\r\n\r\n    requestPackaging: (orderSystemId: SystemId, employeeId: SystemId, assignedEmployeeId?: SystemId) => {\r\n        baseStore.setState(state => {\r\n            const order = state.data.find(o => o.systemId === orderSystemId);\r\n            if (!order) return state;\r\n            const employee = useEmployeeStore.getState().findById(employeeId as SystemId);\r\n            const assignedEmployee = assignedEmployeeId ? useEmployeeStore.getState().findById(assignedEmployeeId as SystemId) : null;\r\n            \r\n            // Count only active packagings for proper numbering\r\n            const activePackagings = order.packagings.filter(p => p.status !== 'H·ªßy ƒë√≥ng g√≥i');\r\n            const activeCountAfterInsert = activePackagings.length + 1;\r\n            const newActiveIndex = activePackagings.length; // This will be the index in active packagings\r\n            \r\n            const newPackaging: Packaging = {\r\n                systemId: getNextPackagingSystemId(), // ‚úÖ Use proper format PACKAGE000001\r\n                id: buildPackagingBusinessId(order.id, newActiveIndex, activeCountAfterInsert),\r\n                requestDate: toISODateTime(new Date()),\r\n                requestingEmployeeId: employeeId,\r\n                requestingEmployeeName: employee?.fullName || 'N/A',\r\n                assignedEmployeeId,\r\n                assignedEmployeeName: assignedEmployee?.fullName,\r\n                status: 'Ch·ªù ƒë√≥ng g√≥i',\r\n                printStatus: 'Ch∆∞a in',\r\n            };\r\n\r\n            const updatedOrder = { ...order, packagings: [...order.packagings, newPackaging], deliveryStatus: 'Ch·ªù ƒë√≥ng g√≥i' as OrderDeliveryStatus };\r\n            return { data: state.data.map(o => o.systemId === orderSystemId ? updatedOrder : o) };\r\n        });\r\n    },\r\n\r\n    confirmPackaging: (orderSystemId: SystemId, packagingSystemId: SystemId, employeeId: SystemId) => {\r\n        // ‚úÖ Check negative packing setting\r\n        const { allowNegativePacking } = useSalesManagementSettingsStore.getState();\r\n        if (!allowNegativePacking) {\r\n            const order = baseStore.getState().data.find(o => o.systemId === orderSystemId);\r\n            if (order) {\r\n                const { findById: findProductById } = useProductStore.getState();\r\n                for (const item of order.lineItems) {\r\n                    const product = findProductById(asSystemId(item.productSystemId));\r\n                    \r\n                    if (product && isComboProduct(product) && product.comboItems) {\r\n                        for (const comboItem of product.comboItems) {\r\n                            const childProduct = findProductById(asSystemId(comboItem.productSystemId));\r\n                            const requiredQty = item.quantity * comboItem.quantity;\r\n                            const currentStock = childProduct?.inventoryByBranch?.[order.branchSystemId] || 0;\r\n                            if (currentStock < requiredQty) {\r\n                                alert(`Kh√¥ng th·ªÉ ƒë√≥ng g√≥i: S·∫£n ph·∫©m \"${childProduct?.name}\" kh√¥ng ƒë·ªß t·ªìn kho (C√≥: ${currentStock}, C·∫ßn: ${requiredQty})`);\r\n                                return baseStore.getState();\r\n                            }\r\n                        }\r\n                    } else {\r\n                        const currentStock = product?.inventoryByBranch?.[order.branchSystemId] || 0;\r\n                        if (currentStock < item.quantity) {\r\n                            alert(`Kh√¥ng th·ªÉ ƒë√≥ng g√≥i: S·∫£n ph·∫©m \"${item.productName}\" kh√¥ng ƒë·ªß t·ªìn kho (C√≥: ${currentStock}, C·∫ßn: ${item.quantity})`);\r\n                            return baseStore.getState();\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        }\r\n\r\n        baseStore.setState(state => {\r\n            const dataCopy = [...state.data];\r\n            const orderIndex = dataCopy.findIndex(o => o.systemId === orderSystemId);\r\n            if (orderIndex === -1) return state;\r\n    \r\n        const orderCopy = { ...dataCopy[orderIndex] };\r\n            const packagingIndex = orderCopy.packagings.findIndex(p => p.systemId === packagingSystemId);\r\n            if (packagingIndex === -1) return state;\r\n            \r\n            const employee = useEmployeeStore.getState().findById(employeeId as SystemId);\r\n    \r\n        const packagingsCopy = [...orderCopy.packagings];\r\n            packagingsCopy[packagingIndex] = {\r\n                ...packagingsCopy[packagingIndex],\r\n                status: 'ƒê√£ ƒë√≥ng g√≥i' as PackagingStatus,\r\n                confirmDate: toISODateTime(new Date()),\r\n                confirmingEmployeeId: employeeId,\r\n                confirmingEmployeeName: employee?.fullName || 'N/A',\r\n            };\r\n    \r\n        orderCopy.packagings = packagingsCopy;\r\n        orderCopy.deliveryStatus = 'ƒê√£ ƒë√≥ng g√≥i' as OrderDeliveryStatus;\r\n            \r\n            dataCopy[orderIndex] = orderCopy;\r\n    \r\n        return { data: dataCopy };\r\n        });\r\n    },\r\n\r\n    cancelPackagingRequest: (orderSystemId: SystemId, packagingSystemId: SystemId, employeeId: SystemId, reason: string) => {\r\n        baseStore.setState(state => {\r\n             const order = state.data.find(o => o.systemId === orderSystemId);\r\n            if (!order) return state;\r\n            const employee = useEmployeeStore.getState().findById(employeeId as SystemId);\r\n\r\n            const updatedPackagings = order.packagings.map(p => {\r\n                if (p.systemId === packagingSystemId) {\r\n                    return {\r\n                        ...p,\r\n                        status: 'H·ªßy ƒë√≥ng g√≥i' as PackagingStatus,\r\n                        cancelDate: toISODateTime(new Date()),\r\n                        cancelingEmployeeId: employeeId,\r\n                        cancelingEmployeeName: employee?.fullName || 'N/A',\r\n                        cancelReason: reason,\r\n                    };\r\n                }\r\n                return p;\r\n            });\r\n            const isAnyActivePackaging = updatedPackagings.some(p => p.status !== 'H·ªßy ƒë√≥ng g√≥i');\r\n            const updatedOrder = { ...order, packagings: updatedPackagings, deliveryStatus: isAnyActivePackaging ? order.deliveryStatus : 'Ch·ªù ƒë√≥ng g√≥i' as OrderDeliveryStatus };\r\n            return { data: state.data.map(o => o.systemId === orderSystemId ? updatedOrder : o) };\r\n        });\r\n    },\r\n    \r\n    processInStorePickup: (orderSystemId: SystemId, packagingSystemId: SystemId) => {\r\n        baseStore.setState(state => {\r\n            const order = state.data.find(o => o.systemId === orderSystemId);\r\n            if (!order) return state;\r\n    \r\n            const totalCount = order.packagings.length;\r\n            const updatedPackagings = order.packagings.map((p, index) => {\r\n                if (p.systemId === packagingSystemId) {\r\n                    const hasId = typeof p.id === 'string' && p.id.trim().length > 0;\r\n                    const resolvedId = hasId ? p.id : buildPackagingBusinessId(order.id, index, totalCount);\r\n                    return {\r\n                        ...p,\r\n                        id: resolvedId,\r\n                        deliveryMethod: 'Nh·∫≠n t·∫°i c·ª≠a h√†ng' as OrderDeliveryMethod,\r\n                        deliveryStatus: 'ƒê√£ ƒë√≥ng g√≥i' as OrderDeliveryStatus,\r\n                        // trackingCode will be set when shipment is created in confirmInStorePickup\r\n                    };\r\n                }\r\n                return p;\r\n            });\r\n            \r\n            const updatedOrder = { \r\n                ...order, \r\n                packagings: updatedPackagings, \r\n                deliveryStatus: 'ƒê√£ ƒë√≥ng g√≥i' as OrderDeliveryStatus \r\n            };\r\n    \r\n            return { data: state.data.map(o => o.systemId === orderSystemId ? updatedOrder : o) };\r\n        });\r\n    },\r\n    \r\n    confirmInStorePickup: (orderSystemId: SystemId, packagingSystemId: SystemId, employeeId: SystemId) => {\r\n        console.log('üü¢ [confirmInStorePickup] Called with:', { orderSystemId, packagingSystemId, employeeId });\r\n        \r\n        // ‚úÖ Check negative stock out setting\r\n        const { allowNegativeStockOut } = useSalesManagementSettingsStore.getState();\r\n        if (!allowNegativeStockOut) {\r\n            const order = baseStore.getState().data.find(o => o.systemId === orderSystemId);\r\n            if (order) {\r\n                const { findById: findProductById } = useProductStore.getState();\r\n                for (const item of order.lineItems) {\r\n                    const product = findProductById(asSystemId(item.productSystemId));\r\n                    \r\n                    if (product && isComboProduct(product) && product.comboItems) {\r\n                        for (const comboItem of product.comboItems) {\r\n                            const childProduct = findProductById(asSystemId(comboItem.productSystemId));\r\n                            const requiredQty = item.quantity * comboItem.quantity;\r\n                            const currentStock = childProduct?.inventoryByBranch?.[order.branchSystemId] || 0;\r\n                            if (currentStock < requiredQty) {\r\n                                alert(`Kh√¥ng th·ªÉ xu·∫•t kho: S·∫£n ph·∫©m \"${childProduct?.name}\" kh√¥ng ƒë·ªß t·ªìn kho (C√≥: ${currentStock}, C·∫ßn: ${requiredQty})`);\r\n                                return baseStore.getState();\r\n                            }\r\n                        }\r\n                    } else {\r\n                        const currentStock = product?.inventoryByBranch?.[order.branchSystemId] || 0;\r\n                        if (currentStock < item.quantity) {\r\n                            alert(`Kh√¥ng th·ªÉ xu·∫•t kho: S·∫£n ph·∫©m \"${item.productName}\" kh√¥ng ƒë·ªß t·ªìn kho (C√≥: ${currentStock}, C·∫ßn: ${item.quantity})`);\r\n                            return baseStore.getState();\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        }\r\n\r\n        baseStore.setState(state => {\r\n            const order = state.data.find(o => o.systemId === orderSystemId);\r\n            if (!order) {\r\n                console.error('‚ùå [confirmInStorePickup] Order not found:', orderSystemId);\r\n                return state;\r\n            }\r\n    \r\n            console.log('üìã [confirmInStorePickup] Order found:', order.id);\r\n            console.log('üìã [confirmInStorePickup] Line items:', order.lineItems.length);\r\n            \r\n            // Stock logic\r\n            const { addEntry: addStockHistory } = useStockHistoryStore.getState();\r\n            const employeeData = useEmployeeStore.getState().findById(employeeId as SystemId);\r\n            const now = toISODateTime(new Date());\r\n    \r\n            order.lineItems.forEach((item, index) => {\r\n                console.log(`üì¶ [confirmInStorePickup] Dispatching item ${index + 1}:`, {\r\n                    productSystemId: item.productSystemId,\r\n                    productName: item.productName,\r\n                    quantity: item.quantity,\r\n                    branchSystemId: getBranchId(order)\r\n                });\r\n                \r\n                // ‚úÖ Dispatch stock (h·ªó tr·ª£ combo - s·∫Ω dispatch SP con)\r\n                const processedItems = processLineItemStock(item, getBranchId(order), 'dispatch', item.quantity);\r\n                \r\n                // ‚úÖ Add stock history entry for each processed item (SP con n·∫øu combo)\r\n                processedItems.forEach(processedItem => {\r\n                    const product = useProductStore.getState().findById(processedItem.productSystemId);\r\n                    const currentStock = product?.inventoryByBranch?.[getBranchId(order)] || 0;\r\n                    \r\n                    addStockHistory({\r\n                        date: now,\r\n                        productId: processedItem.productSystemId,\r\n                        action: 'Xu·∫•t kho (ƒê∆°n h√†ng)',\r\n                        quantityChange: -processedItem.quantity,\r\n                        newStockLevel: currentStock, // After dispatch\r\n                        documentId: order.id,\r\n                        branchSystemId: getBranchId(order),\r\n                        branch: order.branchName,\r\n                        employeeName: employeeData?.fullName || 'H·ªá th·ªëng',\r\n                    });\r\n                });\r\n            });\r\n    \r\n            // Status update logic - will be updated with trackingCode after shipment creation\r\n            let updatedPackagings = order.packagings.map(p => {\r\n                if (p.systemId === packagingSystemId) {\r\n                    return { \r\n                        ...p, \r\n                        deliveryStatus: 'ƒê√£ giao h√†ng' as OrderDeliveryStatus, \r\n                        deliveredDate: toISODateTime(new Date()) \r\n                    };\r\n                }\r\n                return p;\r\n            });\r\n    \r\n            const isAllDelivered = updatedPackagings.every(p => p.status === 'H·ªßy ƒë√≥ng g√≥i' || p.deliveryStatus === 'ƒê√£ giao h√†ng');\r\n            \r\n            let newStatus = order.status === 'ƒê·∫∑t h√†ng' ? 'ƒêang giao d·ªãch' : order.status;\r\n            let newCompletedDate = order.completedDate;\r\n            if (isAllDelivered && order.paymentStatus === 'Thanh to√°n to√†n b·ªô') {\r\n                newStatus = 'Ho√†n th√†nh';\r\n                newCompletedDate = toISODateTime(new Date());\r\n            }\r\n    \r\n            \r\n            const employee = useEmployeeStore.getState().findById(employeeId as SystemId);\r\n            \r\n            // ‚úÖ Create shipment record for INSTORE pickup\r\n            const packaging = order.packagings.find(p => p.systemId === packagingSystemId);\r\n            let newShipment: Shipment | null = null;\r\n            if (packaging) {\r\n                const { createShipment, updateShipment } = useShipmentStore.getState();\r\n                newShipment = createShipment({\r\n                    packagingSystemId: packagingSystemId,\r\n                    orderSystemId: orderSystemId,\r\n                    orderId: order.id,\r\n                    trackingCode: '', // Will be set to shipment business ID below\r\n                    carrier: 'Nh·∫≠n t·∫°i c·ª≠a h√†ng',\r\n                    service: 'Nh·∫≠n t·∫°i c·ª≠a h√†ng',\r\n                    deliveryStatus: 'ƒê√£ giao h√†ng',\r\n                    printStatus: 'Ch∆∞a in',\r\n                    reconciliationStatus: 'Ch∆∞a ƒë·ªëi so√°t',\r\n                    shippingFeeToPartner: 0,\r\n                    codAmount: 0,\r\n                    payer: 'Ng∆∞·ªùi g·ª≠i',\r\n                    createdAt: now,\r\n                    dispatchedAt: now,\r\n                    deliveredAt: now,\r\n                });\r\n                // Update shipment trackingCode to use its own business ID\r\n                if (newShipment) {\r\n                    updateShipment(newShipment.systemId, {\r\n                        trackingCode: newShipment.id, // Use shipment business ID (VC000XXX)\r\n                    });\r\n                    // Update packaging with shipment trackingCode\r\n                    updatedPackagings = updatedPackagings.map(p => {\r\n                        if (p.systemId === packagingSystemId) {\r\n                            return { ...p, trackingCode: newShipment!.id };\r\n                        }\r\n                        return p;\r\n                    });\r\n                }\r\n                console.log('‚úÖ [confirmInStorePickup] Shipment created:', newShipment?.id);\r\n            }\r\n            \r\n            const updatedOrder = { \r\n                ...order, \r\n                packagings: updatedPackagings, \r\n                deliveryStatus: 'ƒê√£ giao h√†ng' as OrderDeliveryStatus,\r\n                status: newStatus,\r\n                completedDate: newCompletedDate,\r\n                stockOutStatus: 'Xu·∫•t kho to√†n b·ªô' as const,\r\n                dispatchedDate: toISODateTime(new Date()),\r\n                dispatchedByEmployeeId: employeeId,\r\n                dispatchedByEmployeeName: employee?.fullName,\r\n            };\r\n    \r\n            console.log('‚úÖ [confirmInStorePickup] Stock dispatched successfully');\r\n            return { data: state.data.map(o => o.systemId === orderSystemId ? updatedOrder : o) };\r\n        });\r\n    },    \r\n    confirmPartnerShipment: async (orderSystemId: SystemId, packagingSystemId: SystemId, shipmentData: any): Promise<{ success: boolean; message: string }> => {\r\n        try {\r\n            const order = baseStore.getState().data.find(o => o.systemId === orderSystemId);\r\n            if (!order) {\r\n                return { success: false, message: 'Kh√¥ng t√¨m th·∫•y ƒë∆°n h√†ng' };\r\n            }\r\n\r\n            // ‚úÖ Check negative packing setting (covers creating shipment)\r\n            const { allowNegativePacking } = useSalesManagementSettingsStore.getState();\r\n            if (!allowNegativePacking) {\r\n                const { findById: findProductById } = useProductStore.getState();\r\n                for (const item of order.lineItems) {\r\n                    const product = findProductById(asSystemId(item.productSystemId));\r\n                    \r\n                    if (product && isComboProduct(product) && product.comboItems) {\r\n                        for (const comboItem of product.comboItems) {\r\n                            const childProduct = findProductById(asSystemId(comboItem.productSystemId));\r\n                            const requiredQty = item.quantity * comboItem.quantity;\r\n                            const currentStock = childProduct?.inventoryByBranch?.[order.branchSystemId] || 0;\r\n                            if (currentStock < requiredQty) {\r\n                                return { success: false, message: `Kh√¥ng th·ªÉ t·∫°o v·∫≠n ƒë∆°n: S·∫£n ph·∫©m \"${childProduct?.name}\" kh√¥ng ƒë·ªß t·ªìn kho` };\r\n                            }\r\n                        }\r\n                    } else {\r\n                        const currentStock = product?.inventoryByBranch?.[order.branchSystemId] || 0;\r\n                        if (currentStock < item.quantity) {\r\n                            return { success: false, message: `Kh√¥ng th·ªÉ t·∫°o v·∫≠n ƒë∆°n: S·∫£n ph·∫©m \"${item.productName}\" kh√¥ng ƒë·ªß t·ªìn kho` };\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n\r\n            // ‚úÖ Get GHTK preview params from window (set by ShippingIntegration)\r\n            const ghtkParams = (window as any).__ghtkPreviewParams;\r\n            \r\n            if (!ghtkParams) {\r\n                return { success: false, message: 'Thi·∫øu th√¥ng tin v·∫≠n chuy·ªÉn. Vui l√≤ng ch·ªçn d·ªãch v·ª• v·∫≠n chuy·ªÉn.' };\r\n            }\r\n\r\n            // ‚úÖ Import GHTK service dynamically\r\n            const { GHTKService } = await import('../settings/shipping/integrations/ghtk-service');\r\n            const { getGHTKCredentials } = await import('../../lib/utils/get-shipping-credentials');\r\n            \r\n            const { apiToken, partnerCode } = getGHTKCredentials();\r\n            const ghtkService = new GHTKService(apiToken, partnerCode);\r\n\r\n            console.log('üì§ [confirmPartnerShipment] Calling GHTK API with params:', ghtkParams);\r\n\r\n            // ‚úÖ Call real GHTK API\r\n            const result = await ghtkService.createOrder(ghtkParams);\r\n\r\n            if (!result.success || !result.order) {\r\n                throw new Error(result.message || 'Kh√¥ng th·ªÉ t·∫°o ƒë∆°n v·∫≠n chuy·ªÉn');\r\n            }\r\n\r\n            // ‚úÖ Update order with real tracking code from GHTK\r\n            const trackingCode = result.order.label;\r\n            const ghtkTrackingId = result.order.tracking_id;\r\n            const estimatedPickTime = result.order.estimated_pick_time;\r\n            const estimatedDeliverTime = result.order.estimated_deliver_time;\r\n\r\n            baseStore.setState(state => {\r\n                const updatedPackagings = order.packagings.map(p => {\r\n                    if (p.systemId === packagingSystemId) {\r\n                        return {\r\n                            ...p,\r\n                            deliveryMethod: 'D·ªãch v·ª• giao h√†ng' as OrderDeliveryMethod,\r\n                            deliveryStatus: 'Ch·ªù l·∫•y h√†ng' as OrderDeliveryStatus,\r\n                            carrier: 'GHTK',\r\n                            service: result.order?.fee ? `${result.order.fee}ƒë` : 'Standard',\r\n                            trackingCode: trackingCode,\r\n                            shippingFeeToPartner: parseInt(result.order?.fee || '0') || 0,\r\n                            codAmount: ghtkParams.pick_money || 0,\r\n                            payer: (ghtkParams.is_freeship === 1 ? 'Ng∆∞·ªùi g·ª≠i' : 'Ng∆∞·ªùi nh·∫≠n') as 'Ng∆∞·ªùi g·ª≠i' | 'Ng∆∞·ªùi nh·∫≠n',\r\n                            noteToShipper: ghtkParams.note || '',\r\n                            weight: ghtkParams.weight,\r\n                            dimensions: `${ghtkParams.products?.[0]?.length || 10}√ó${ghtkParams.products?.[0]?.width || 10}√ó${ghtkParams.products?.[0]?.height || 10}`,\r\n                            // ‚úÖ Store GHTK specific data\r\n                            ghtkTrackingId: String(ghtkTrackingId),\r\n                            estimatedPickTime: estimatedPickTime,\r\n                            estimatedDeliverTime: estimatedDeliverTime,\r\n                        };\r\n                    }\r\n                    return p;\r\n                });\r\n                \r\n                const updatedOrder = { \r\n                    ...order, \r\n                    packagings: updatedPackagings, \r\n                    deliveryStatus: 'Ch·ªù l·∫•y h√†ng' as OrderDeliveryStatus, \r\n                    status: 'ƒêang giao d·ªãch' as OrderMainStatus \r\n                };\r\n                \r\n                return { data: state.data.map(o => o.systemId === orderSystemId ? updatedOrder : o) };\r\n            });\r\n\r\n            console.log('‚úÖ [confirmPartnerShipment] GHTK order created successfully:', {\r\n                trackingCode,\r\n                ghtkTrackingId,\r\n                estimatedPickTime,\r\n                estimatedDeliverTime\r\n            });\r\n\r\n            return { \r\n                success: true, \r\n                message: `T·∫°o v·∫≠n ƒë∆°n th√†nh c√¥ng! M√£ v·∫≠n ƒë∆°n: ${trackingCode}` \r\n            };\r\n\r\n        } catch (error) {\r\n            console.error('‚ùå [confirmPartnerShipment] Error:', error);\r\n            \r\n            let errorMessage = 'Vui l√≤ng th·ª≠ l·∫°i';\r\n            if (error instanceof Error) {\r\n                errorMessage = error.message;\r\n            }\r\n            \r\n            return { \r\n                success: false, \r\n                message: `L·ªói t·∫°o ƒë∆°n v·∫≠n chuy·ªÉn: ${errorMessage}` \r\n            };\r\n        }\r\n    },\r\n\r\n    dispatchFromWarehouse: (orderSystemId: SystemId, packagingSystemId: SystemId, employeeId: SystemId) => {\r\n        // ‚úÖ Check negative stock out setting\r\n        const { allowNegativeStockOut } = useSalesManagementSettingsStore.getState();\r\n        if (!allowNegativeStockOut) {\r\n            const order = baseStore.getState().data.find(o => o.systemId === orderSystemId);\r\n            if (order) {\r\n                const { findById: findProductById } = useProductStore.getState();\r\n                for (const item of order.lineItems) {\r\n                    const product = findProductById(asSystemId(item.productSystemId));\r\n                    \r\n                    if (product && isComboProduct(product) && product.comboItems) {\r\n                        for (const comboItem of product.comboItems) {\r\n                            const childProduct = findProductById(asSystemId(comboItem.productSystemId));\r\n                            const requiredQty = item.quantity * comboItem.quantity;\r\n                            const currentStock = childProduct?.inventoryByBranch?.[order.branchSystemId] || 0;\r\n                            if (currentStock < requiredQty) {\r\n                                alert(`Kh√¥ng th·ªÉ xu·∫•t kho: S·∫£n ph·∫©m \"${childProduct?.name}\" kh√¥ng ƒë·ªß t·ªìn kho (C√≥: ${currentStock}, C·∫ßn: ${requiredQty})`);\r\n                                return baseStore.getState();\r\n                            }\r\n                        }\r\n                    } else {\r\n                        const currentStock = product?.inventoryByBranch?.[order.branchSystemId] || 0;\r\n                        if (currentStock < item.quantity) {\r\n                            alert(`Kh√¥ng th·ªÉ xu·∫•t kho: S·∫£n ph·∫©m \"${item.productName}\" kh√¥ng ƒë·ªß t·ªìn kho (C√≥: ${currentStock}, C·∫ßn: ${item.quantity})`);\r\n                            return baseStore.getState();\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        }\r\n\r\n        baseStore.setState(state => {\r\n            const order = state.data.find(o => o.systemId === orderSystemId);\r\n            if (!order) return state;\r\n\r\n            const { addEntry: addStockHistory } = useStockHistoryStore.getState();\r\n            const employeeData = useEmployeeStore.getState().findById(employeeId as SystemId);\r\n            const now = toISODateTime(new Date());\r\n            \r\n            order.lineItems.forEach(item => {\r\n                // ‚úÖ Dispatch stock (h·ªó tr·ª£ combo - s·∫Ω dispatch SP con)\r\n                const processedItems = processLineItemStock(item, getBranchId(order), 'dispatch', item.quantity);\r\n                \r\n                // ‚úÖ Add stock history entry for each processed item\r\n                processedItems.forEach(processedItem => {\r\n                    const product = useProductStore.getState().findById(processedItem.productSystemId);\r\n                    const currentStock = product?.inventoryByBranch?.[getBranchId(order)] || 0;\r\n                    \r\n                    addStockHistory({\r\n                        date: now,\r\n                        productId: processedItem.productSystemId,\r\n                        action: 'Xu·∫•t kho (ƒê∆°n h√†ng)',\r\n                        quantityChange: -processedItem.quantity,\r\n                        newStockLevel: currentStock,\r\n                        documentId: order.id,\r\n                        branchSystemId: getBranchId(order),\r\n                        branch: order.branchName,\r\n                        employeeName: employeeData?.fullName || 'H·ªá th·ªëng',\r\n                    });\r\n                });\r\n            });\r\n            \r\n            const now2 = toISODateTime(new Date());\r\n            \r\n            const updatedPackagings = order.packagings.map(p => \r\n                p.systemId === packagingSystemId ? { ...p, deliveryStatus: 'ƒêang giao h√†ng' as OrderDeliveryStatus } : p\r\n            );\r\n\r\n            const updatedOrder = {\r\n                ...order,\r\n                packagings: updatedPackagings,\r\n                deliveryStatus: 'ƒêang giao h√†ng' as OrderDeliveryStatus,\r\n                stockOutStatus: 'Xu·∫•t kho to√†n b·ªô' as const,\r\n                dispatchedDate: now2,\r\n                dispatchedByEmployeeId: employeeId,\r\n                dispatchedByEmployeeName: employeeData?.fullName,\r\n                status: order.status === 'ƒê·∫∑t h√†ng' ? 'ƒêang giao d·ªãch' : order.status,\r\n            };\r\n            return { data: state.data.map(o => o.systemId === orderSystemId ? updatedOrder : o) };\r\n        });\r\n    },\r\n\r\n    completeDelivery: (orderSystemId: SystemId, packagingSystemId: SystemId, employeeId: SystemId) => {\r\n        baseStore.setState(state => {\r\n            const order = state.data.find(o => o.systemId === orderSystemId);\r\n            if (!order) return state;\r\n            \r\n            // ‚úÖ Complete delivery (h·ªó tr·ª£ combo - s·∫Ω complete SP con)\r\n            order.lineItems.forEach(item => {\r\n                processLineItemStock(item, getBranchId(order), 'complete', item.quantity);\r\n            });\r\n\r\n            const updatedPackagings = order.packagings.map(p => \r\n                p.systemId === packagingSystemId ? { ...p, deliveryStatus: 'ƒê√£ giao h√†ng' as OrderDeliveryStatus, deliveredDate: toISODateTime(new Date()) } : p\r\n            );\r\n            \r\n            const isAllDelivered = updatedPackagings.every(p => p.status === 'H·ªßy ƒë√≥ng g√≥i' || p.deliveryStatus === 'ƒê√£ giao h√†ng');\r\n            let newStatus = order.status;\r\n            let newCompletedDate = order.completedDate;\r\n            \r\n            // ‚úÖ Khi t·∫•t c·∫£ ƒë∆°n ƒë√£ giao ‚Üí t·∫°o c√¥ng n·ª£ (n·∫øu c√≥) v√† c·∫≠p nh·∫≠t stats\r\n            if (isAllDelivered && order.status !== 'Ho√†n th√†nh') {\r\n                // T√≠nh c√¥ng n·ª£ c√≤n l·∫°i\r\n                const totalPaid = (order.payments || []).reduce((sum, p) => sum + p.amount, 0);\r\n                const debtAmount = Math.max(0, order.grandTotal - totalPaid);\r\n                \r\n                // ‚úÖ T·∫°o c√¥ng n·ª£ CH·ªà KHI giao h√†ng th√†nh c√¥ng\r\n                if (debtAmount > 0) {\r\n                    const { addDebtTransaction } = useCustomerStore.getState();\r\n                    const dueDate = new Date();\r\n                    dueDate.setDate(dueDate.getDate() + 30);\r\n                    addDebtTransaction(order.customerSystemId, {\r\n                        systemId: asSystemId(`DEBT_${order.systemId}`),\r\n                        orderId: order.id,\r\n                        orderDate: order.orderDate.split('T')[0],\r\n                        amount: debtAmount,\r\n                        dueDate: dueDate.toISOString().split('T')[0],\r\n                        isPaid: false,\r\n                        remainingAmount: debtAmount,\r\n                        notes: 'C√¥ng n·ª£ t·ª´ ƒë∆°n h√†ng ƒë√£ giao th√†nh c√¥ng',\r\n                    });\r\n                }\r\n                \r\n                // Update customer stats\r\n                const { incrementOrderStats } = useCustomerStore.getState();\r\n                incrementOrderStats(order.customerSystemId, order.grandTotal);\r\n            }\r\n            \r\n            // Check if order is fully complete (delivered + fully paid)\r\n            if (isAllDelivered && order.paymentStatus === 'Thanh to√°n to√†n b·ªô') {\r\n                newStatus = 'Ho√†n th√†nh';\r\n                newCompletedDate = toISODateTime(new Date());\r\n            }\r\n\r\n            const employee = useEmployeeStore.getState().findById(employeeId as SystemId);\r\n            const updatedOrder = { \r\n                ...order, \r\n                packagings: updatedPackagings, \r\n                deliveryStatus: 'ƒê√£ giao h√†ng' as OrderDeliveryStatus, \r\n                status: newStatus, \r\n                completedDate: newCompletedDate,\r\n                activityHistory: appendHistoryEntry(\r\n                    order.activityHistory,\r\n                    createHistoryEntry(\r\n                        'status_changed',\r\n                        getCurrentUserInfo(),\r\n                        `${employee?.fullName || 'Nh√¢n vi√™n'} ƒë√£ x√°c nh·∫≠n giao h√†ng th√†nh c√¥ng${newStatus === 'Ho√†n th√†nh' ? '. ƒê∆°n h√†ng ho√†n th√†nh' : ''}`\r\n                    )\r\n                ),\r\n            };\r\n            return { data: state.data.map(o => o.systemId === orderSystemId ? updatedOrder : o) };\r\n        });\r\n    },\r\n\r\n    failDelivery: (orderSystemId: SystemId, packagingSystemId: SystemId, employeeId: SystemId, reason: string) => {\r\n        baseStore.setState(state => {\r\n            const order = state.data.find(o => o.systemId === orderSystemId);\r\n            if (!order) return state;\r\n            const { incrementFailedDeliveryStats } = useCustomerStore.getState();\r\n            \r\n            // ‚úÖ Return stock from transit (h·ªó tr·ª£ combo - s·∫Ω return SP con)\r\n            order.lineItems.forEach(item => {\r\n                processLineItemStock(item, getBranchId(order), 'return', item.quantity);\r\n            });\r\n\r\n            // ‚úÖ Update customer failed delivery stats\r\n            incrementFailedDeliveryStats(order.customerSystemId);\r\n\r\n            const updatedPackagings = order.packagings.map(p => \r\n                p.systemId === packagingSystemId ? { ...p, deliveryStatus: 'Ch·ªù giao l·∫°i' as OrderDeliveryStatus, notes: `Giao th·∫•t b·∫°i: ${reason}` } : p\r\n            );\r\n            \r\n            const updatedOrder = { ...order, packagings: updatedPackagings, deliveryStatus: 'Ch·ªù giao l·∫°i' as OrderDeliveryStatus };\r\n            return { data: state.data.map(o => o.systemId === orderSystemId ? updatedOrder : o) };\r\n         });\r\n    },\r\n\r\n    // ‚úÖ H·ªßy giao h√†ng - KH√îNG tr·∫£ h√†ng v·ªÅ kho (h√†ng b·ªã th·∫•t tung/shipper gi·ªØ)\r\n    cancelDeliveryOnly: (orderSystemId: SystemId, packagingSystemId: SystemId, employeeId: SystemId, reason: string) => {\r\n        const currentOrder = baseStore.getState().data.find(o => o.systemId === orderSystemId);\r\n        if (!ensureCancellationAllowed(currentOrder, 'h·ªßy giao h√†ng')) {\r\n            return;\r\n        }\r\n\r\n        baseStore.setState(state => {\r\n            const order = state.data.find(o => o.systemId === orderSystemId);\r\n            if (!order) return state;\r\n\r\n            // ‚úÖ Get employee info for canceller\r\n            const employeeData = useEmployeeStore.getState().findById(employeeId as SystemId);\r\n\r\n            const updatedPackagings = order.packagings.map(p => \r\n                p.systemId === packagingSystemId ? { \r\n                    ...p, \r\n                    status: 'H·ªßy ƒë√≥ng g√≥i' as PackagingStatus,\r\n                    deliveryStatus: 'ƒê√£ h·ªßy' as OrderDeliveryStatus,\r\n                    cancelReason: `H·ªßy giao h√†ng: ${reason}`, \r\n                    cancelDate: toISODateTime(new Date()),\r\n                    cancelingEmployeeId: employeeId,\r\n                    cancelingEmployeeName: employeeData?.fullName || 'H·ªá th·ªëng',\r\n                } : p\r\n            );\r\n            \r\n            // ‚úÖ Check if all packagings are cancelled, update order status accordingly\r\n            const allCancelled = updatedPackagings.every(p => p.deliveryStatus === 'ƒê√£ h·ªßy' || p.status === 'H·ªßy ƒë√≥ng g√≥i');\r\n            const hasAnyActive = updatedPackagings.some(p => p.deliveryStatus && p.deliveryStatus !== 'ƒê√£ h·ªßy' && p.status !== 'H·ªßy ƒë√≥ng g√≥i');\r\n            \r\n            let newOrderStatus = order.status;\r\n            let newDeliveryStatus = order.deliveryStatus;\r\n            \r\n            if (allCancelled) {\r\n                // All packagings cancelled ‚Üí order goes back to pending state\r\n                newOrderStatus = 'ƒêang giao d·ªãch' as OrderMainStatus;\r\n                newDeliveryStatus = 'Ch∆∞a giao h√†ng' as OrderDeliveryStatus;\r\n            } else if (hasAnyActive) {\r\n                // Some packagings still active ‚Üí keep current delivery status of remaining active packaging\r\n                const activePackaging = updatedPackagings.find(p => p.deliveryStatus && p.deliveryStatus !== 'ƒê√£ h·ªßy');\r\n                if (activePackaging?.deliveryStatus) {\r\n                    newDeliveryStatus = activePackaging.deliveryStatus;\r\n                }\r\n            }\r\n            \r\n            const updatedOrder = { \r\n                ...order, \r\n                packagings: updatedPackagings,\r\n                status: newOrderStatus,\r\n                deliveryStatus: newDeliveryStatus\r\n            };\r\n            return { data: state.data.map(o => o.systemId === orderSystemId ? updatedOrder : o) };\r\n         });\r\n    },\r\n\r\n    // ‚úÖ H·ªßy giao v√† nh·∫≠n l·∫°i h√†ng - TR·∫¢ h√†ng v·ªÅ kho (ƒë√£ nh·∫≠n l·∫°i t·ª´ shipper)\r\n    cancelDelivery: (orderSystemId: SystemId, packagingSystemId: SystemId, employeeId: SystemId, reason: string) => {\r\n        const currentOrder = baseStore.getState().data.find(o => o.systemId === orderSystemId);\r\n        if (!ensureCancellationAllowed(currentOrder, 'h·ªßy giao h√†ng')) {\r\n            return;\r\n        }\r\n\r\n         baseStore.setState(state => {\r\n            const order = state.data.find(o => o.systemId === orderSystemId);\r\n            if (!order) return state;\r\n            \r\n            // ‚úÖ TR·∫¢ h√†ng t·ª´ \"ƒëang giao\" v·ªÅ \"t·ªìn kho\" (h·ªó tr·ª£ combo - s·∫Ω return SP con)\r\n            order.lineItems.forEach(item => {\r\n                processLineItemStock(item, getBranchId(order), 'return', item.quantity);\r\n            });\r\n\r\n            // ‚úÖ Get employee info for canceller\r\n            const employeeData = useEmployeeStore.getState().findById(employeeId as SystemId);\r\n\r\n            const updatedPackagings = order.packagings.map(p => \r\n                p.systemId === packagingSystemId ? { \r\n                    ...p, \r\n                    status: 'H·ªßy ƒë√≥ng g√≥i' as PackagingStatus,\r\n                    deliveryStatus: 'ƒê√£ h·ªßy' as OrderDeliveryStatus,\r\n                    cancelReason: `H·ªßy giao h√†ng: ${reason}`, \r\n                    cancelDate: toISODateTime(new Date()),\r\n                    cancelingEmployeeId: employeeId,\r\n                    cancelingEmployeeName: employeeData?.fullName || 'H·ªá th·ªëng',\r\n                } : p\r\n            );\r\n            \r\n            // ‚úÖ Check if all packagings are cancelled, update order status accordingly\r\n            const allCancelled = updatedPackagings.every(p => p.deliveryStatus === 'ƒê√£ h·ªßy' || p.status === 'H·ªßy ƒë√≥ng g√≥i');\r\n            const hasAnyActive = updatedPackagings.some(p => p.deliveryStatus && p.deliveryStatus !== 'ƒê√£ h·ªßy' && p.status !== 'H·ªßy ƒë√≥ng g√≥i');\r\n            \r\n            let newOrderStatus = order.status;\r\n            let newDeliveryStatus = order.deliveryStatus;\r\n            \r\n            if (allCancelled) {\r\n                // All packagings cancelled ‚Üí order goes back to pending state\r\n                newOrderStatus = 'ƒêang giao d·ªãch' as OrderMainStatus;\r\n                newDeliveryStatus = 'Ch∆∞a giao h√†ng' as OrderDeliveryStatus;\r\n            } else if (hasAnyActive) {\r\n                // Some packagings still active ‚Üí keep current delivery status of remaining active packaging\r\n                const activePackaging = updatedPackagings.find(p => p.deliveryStatus && p.deliveryStatus !== 'ƒê√£ h·ªßy');\r\n                if (activePackaging?.deliveryStatus) {\r\n                    newDeliveryStatus = activePackaging.deliveryStatus;\r\n                }\r\n            }\r\n            \r\n            const updatedOrder = { \r\n                ...order, \r\n                packagings: updatedPackagings,\r\n                status: newOrderStatus,\r\n                deliveryStatus: newDeliveryStatus\r\n            };\r\n            return { data: state.data.map(o => o.systemId === orderSystemId ? updatedOrder : o) };\r\n         });\r\n    },\r\n\r\n    confirmCodReconciliation: (shipments: (Packaging & { orderSystemId: SystemId })[], employeeId: SystemId) => {\r\n        const { add: addReceipt } = useReceiptStore.getState();\r\n        const { accounts } = useCashbookStore.getState();\r\n        const { data: receiptTypes } = useReceiptTypeStore.getState();\r\n        const employee = useEmployeeStore.getState().findById(employeeId as SystemId);\r\n        const allOrders = baseStore.getState().data;\r\n    \r\n        const totalByPartnerAndBranch: Record<string, { total: number; ids: string[]; branchSystemId: string; branchName: string; partnerName: string; shipmentSystemIds: string[] }> = {};\r\n    \r\n        shipments.forEach(shipment => {\r\n            const order = allOrders.find(o => o.systemId === shipment.orderSystemId);\r\n            if (!order || !shipment.carrier) return;\r\n    \r\n            const key = `${shipment.carrier}-${getBranchId(order)}`;\r\n            if (!totalByPartnerAndBranch[key]) {\r\n                totalByPartnerAndBranch[key] = { total: 0, ids: [], branchSystemId: getBranchId(order), branchName: order.branchName, partnerName: shipment.carrier, shipmentSystemIds: [] };\r\n            }\r\n            totalByPartnerAndBranch[key].total += shipment.codAmount || 0;\r\n            totalByPartnerAndBranch[key].ids.push(shipment.trackingCode || shipment.id);\r\n            totalByPartnerAndBranch[key].shipmentSystemIds.push(shipment.systemId);\r\n        });\r\n    \r\n        const createdReceipts: (any & { shipmentSystemIds: string[] })[] = [];\r\n    \r\n        Object.values(totalByPartnerAndBranch).forEach(group => {\r\n            const account = accounts.find(acc => acc.type === 'bank' && acc.branchSystemId === group.branchSystemId) || accounts.find(acc => acc.type === 'bank');\r\n            const category = receiptTypes.find(c => c.id === 'DOISOATCOD');\r\n            if (account && category) {\r\n                const newReceiptData = {\r\n                    id: '',\r\n                    date: toISODateTime(new Date()),\r\n                    amount: group.total,\r\n                    payerType: 'ƒê·ªëi t√°c v·∫≠n chuy·ªÉn',\r\n                    payerName: group.partnerName,\r\n                    description: `ƒê·ªëi so√°t COD cho c√°c v·∫≠n ƒë∆°n: ${group.ids.join(', ')}`,\r\n                    paymentMethod: 'Chuy·ªÉn kho·∫£n',\r\n                    accountSystemId: account.systemId,\r\n                    originalDocumentId: group.ids.join(', '),\r\n                    createdBy: employee?.fullName || 'N/A',\r\n                    branchSystemId: group.branchSystemId,\r\n                    branchName: group.branchName,\r\n                    paymentReceiptTypeSystemId: category.systemId,\r\n                    paymentReceiptTypeName: category.name,\r\n                    status: 'completed' as const,\r\n                    createdAt: toISODateTime(new Date()),\r\n                    updatedAt: toISODateTime(new Date()),\r\n                    affectsDebt: false,\r\n                };\r\n                const newReceipt = addReceipt(newReceiptData as any);\r\n                if (newReceipt) {\r\n                    createdReceipts.push({ ...newReceipt, shipmentSystemIds: group.shipmentSystemIds });\r\n                }\r\n            }\r\n        });\r\n    \r\n        baseStore.setState(state => {\r\n            const updates = new Map<string, { newPayments: OrderPayment[]; reconciledShipmentIds: string[] }>();\r\n    \r\n            shipments.forEach(shipment => {\r\n                const receiptForShipment = createdReceipts.find(v => v.shipmentSystemIds.includes(shipment.systemId));\r\n                if (!receiptForShipment || !shipment.codAmount || shipment.codAmount <= 0) return;\r\n    \r\n                const orderSystemId = shipment.orderSystemId;\r\n                const orderUpdates = updates.get(orderSystemId) || { newPayments: [], reconciledShipmentIds: [] };\r\n    \r\n                const newPayment: OrderPayment = {\r\n                    systemId: receiptForShipment.systemId,\r\n                    id: receiptForShipment.id,\r\n                    date: receiptForShipment.date,\r\n                    method: 'ƒê·ªëi so√°t COD',\r\n                    amount: shipment.codAmount || 0,\r\n                    createdBy: asSystemId('SYSTEM'),\r\n                    description: `Thanh to√°n COD cho v·∫≠n ƒë∆°n ${shipment.trackingCode || shipment.id}`,\r\n                };\r\n                orderUpdates.newPayments.push(newPayment);\r\n                orderUpdates.reconciledShipmentIds.push(shipment.systemId);\r\n                updates.set(orderSystemId, orderUpdates);\r\n            });\r\n    \r\n            if (updates.size === 0) return state;\r\n    \r\n            const newData = state.data.map(order => {\r\n                if (updates.has(order.systemId)) {\r\n                    const orderUpdates = updates.get(order.systemId)!;\r\n                    let updatedOrder = { ...order };\r\n\r\n                    updatedOrder.packagings = updatedOrder.packagings.map(p =>\r\n                        orderUpdates.reconciledShipmentIds.includes(p.systemId)\r\n                            ? { ...p, reconciliationStatus: 'ƒê√£ ƒë·ªëi so√°t' as const }\r\n                            : p\r\n                    );\r\n\r\n                    for (const payment of orderUpdates.newPayments) {\r\n                        updatedOrder = applyPaymentToOrder(updatedOrder, payment);\r\n                    }\r\n    \r\n                    return updatedOrder;\r\n                }\r\n                return order;\r\n            });\r\n    \r\n            return { data: newData };\r\n        });\r\n    },\r\n\r\n    // ============================================\r\n    // GHTK INTEGRATION METHODS\r\n    // ============================================\r\n\r\n    /**\r\n     * Process GHTK webhook update\r\n     * Called when GHTK pushes status update or from tracking API\r\n     */\r\n    processGHTKWebhook: (webhookData: import('./types').GHTKWebhookPayload) => {\r\n        baseStore.setState(state => {\r\n            // Find order by tracking code or partner_id\r\n            const order = state.data.find(o => \r\n                o.packagings.some(p => \r\n                    p.trackingCode === webhookData.label_id || \r\n                    p.systemId === webhookData.partner_id ||\r\n                    o.systemId === webhookData.partner_id\r\n                )\r\n            );\r\n            \r\n            if (!order) {\r\n                console.warn('[GHTK Webhook] Order not found for:', {\r\n                    label_id: webhookData.label_id,\r\n                    partner_id: webhookData.partner_id\r\n                });\r\n                return state;\r\n            }\r\n            \r\n            // Import status mapping\r\n            const { getGHTKStatusInfo, getGHTKReasonText } = require('../../lib/ghtk-constants');\r\n            \r\n            const statusMapping = getGHTKStatusInfo(webhookData.status_id);\r\n            if (!statusMapping) {\r\n                console.warn('[GHTK Webhook] Unknown status:', webhookData.status_id);\r\n                return state;\r\n            }\r\n            \r\n            console.log('[GHTK Webhook] Processing update:', {\r\n                order: order.id,\r\n                trackingCode: webhookData.label_id,\r\n                statusId: webhookData.status_id,\r\n                statusText: statusMapping.statusText,\r\n                deliveryStatus: statusMapping.deliveryStatus\r\n            });\r\n            \r\n            // Update packaging with new status\r\n            const updatedPackagings = order.packagings.map(p => {\r\n                if (p.trackingCode !== webhookData.label_id && \r\n                    p.systemId !== webhookData.partner_id) {\r\n                    return p;\r\n                }\r\n                \r\n                return {\r\n                    ...p,\r\n                    deliveryStatus: statusMapping.deliveryStatus,\r\n                    partnerStatus: statusMapping.statusText,\r\n                    ghtkStatusId: webhookData.status_id,\r\n                    ghtkReasonCode: webhookData.reason_code,\r\n                    ghtkReasonText: webhookData.reason \r\n                        ? webhookData.reason \r\n                        : (webhookData.reason_code ? getGHTKReasonText(webhookData.reason_code) : undefined),\r\n                    actualWeight: webhookData.weight,\r\n                    actualFee: webhookData.fee,\r\n                    lastSyncedAt: toISODateTime(new Date()),\r\n                    // Update reconciliation status if status = 6 (ƒê√£ ƒë·ªëi so√°t)\r\n                    reconciliationStatus: webhookData.status_id === 6 \r\n                        ? 'ƒê√£ ƒë·ªëi so√°t' as const \r\n                        : p.reconciliationStatus,\r\n                    // Update delivered date if status = 5 or 6\r\n                    deliveredDate: [5, 6].includes(webhookData.status_id) && !p.deliveredDate\r\n                        ? toISODateTime(new Date())\r\n                        : p.deliveredDate,\r\n                };\r\n            });\r\n            \r\n            // Handle stock updates based on status\r\n            if (statusMapping.shouldUpdateStock && statusMapping.stockAction) {\r\n                const { dispatchStock, completeDelivery: productCompleteDelivery, returnStockFromTransit } = useProductStore.getState();\r\n                const { incrementFailedDeliveryStats } = useCustomerStore.getState();\r\n                \r\n                // ‚úÖ Expand combo items to child products\r\n                const stockItems = getComboStockItems(order.lineItems);\r\n                \r\n                stockItems.forEach(item => {\r\n                    switch (statusMapping.stockAction) {\r\n                        case 'dispatch':\r\n                            // Status 3: ƒê√£ l·∫•y h√†ng -> Move to transit\r\n                            dispatchStock(item.productSystemId, asSystemId(getBranchId(order)), item.quantity);\r\n                            break;\r\n                        case 'complete':\r\n                            // Status 5: ƒê√£ giao h√†ng -> Complete delivery\r\n                            productCompleteDelivery(item.productSystemId, asSystemId(getBranchId(order)), item.quantity);\r\n                            break;\r\n                        case 'return':\r\n                            // Status -1, 7, 9, 13, 20: Failed/Returned -> Return stock\r\n                            returnStockFromTransit(item.productSystemId, asSystemId(getBranchId(order)), item.quantity);\r\n                            break;\r\n                    }\r\n                });\r\n                \r\n                // ‚úÖ Increment failed delivery stats for customer if return (moved outside loop)\r\n                if (statusMapping.stockAction === 'return') {\r\n                    const failureStatuses = [7, 9, 13, 20, 21];\r\n                    const currentPackaging = order.packagings.find(p => p.trackingCode === webhookData.label_id);\r\n                    const previousStatusId = currentPackaging?.ghtkStatusId;\r\n                    \r\n                    if (failureStatuses.includes(webhookData.status_id) && (!previousStatusId || !failureStatuses.includes(previousStatusId))) {\r\n                        incrementFailedDeliveryStats(order.customerSystemId);\r\n                    }\r\n                }\r\n                \r\n                console.log('[GHTK Webhook] Stock updated:', {\r\n                    action: statusMapping.stockAction,\r\n                    items: stockItems.length\r\n                });\r\n            }\r\n            \r\n            // Determine order-level delivery status\r\n            const allPackagingsDelivered = updatedPackagings.every(p => \r\n                p.status === 'H·ªßy ƒë√≥ng g√≥i' || \r\n                p.deliveryStatus === 'ƒê√£ giao h√†ng'\r\n            );\r\n            \r\n            let newOrderDeliveryStatus = order.deliveryStatus;\r\n            let newOrderStatus = order.status;\r\n            let newCompletedDate = order.completedDate;\r\n            let newStockOutStatus = order.stockOutStatus;\r\n            \r\n            // Update order delivery status\r\n            if (allPackagingsDelivered) {\r\n                newOrderDeliveryStatus = 'ƒê√£ giao h√†ng';\r\n                \r\n                // Auto-complete order if delivered + paid\r\n                if (order.paymentStatus === 'Thanh to√°n to√†n b·ªô' && order.status !== 'Ho√†n th√†nh') {\r\n                    newOrderStatus = 'Ho√†n th√†nh';\r\n                    newCompletedDate = toISODateTime(new Date());\r\n                    \r\n                    // Update customer stats\r\n                    const { incrementOrderStats } = useCustomerStore.getState();\r\n                    incrementOrderStats(order.customerSystemId, order.grandTotal);\r\n                    \r\n                    console.log('[GHTK Webhook] Order completed:', order.id);\r\n                }\r\n            } else if (statusMapping.statusId === 3) {\r\n                // Status 3: ƒê√£ l·∫•y h√†ng\r\n                newOrderDeliveryStatus = 'ƒêang giao h√†ng';\r\n                newStockOutStatus = 'Xu·∫•t kho to√†n b·ªô';\r\n            } else if ([4, 10].includes(statusMapping.statusId)) {\r\n                // Status 4, 10: ƒêang giao\r\n                newOrderDeliveryStatus = 'ƒêang giao h√†ng';\r\n            }\r\n            \r\n            const updatedOrder = {\r\n                ...order,\r\n                packagings: updatedPackagings,\r\n                deliveryStatus: newOrderDeliveryStatus,\r\n                status: newOrderStatus,\r\n                completedDate: newCompletedDate,\r\n                stockOutStatus: newStockOutStatus,\r\n            };\r\n            \r\n            return {\r\n                data: state.data.map(o => o.systemId === order.systemId ? updatedOrder : o)\r\n            };\r\n        });\r\n    },\r\n\r\n    /**\r\n     * Cancel GHTK shipment\r\n     * ‚ö†Ô∏è Ch·ªâ h·ªßy ƒë∆∞·ª£c khi ƒë∆°n ·ªü tr·∫°ng th√°i: 1, 2, 12 (Ch∆∞a ti·∫øp nh·∫≠n, ƒê√£ ti·∫øp nh·∫≠n, ƒêang l·∫•y h√†ng)\r\n     */\r\n    cancelGHTKShipment: async (orderSystemId: SystemId, packagingSystemId: SystemId, trackingCode: string) => {\r\n        try {\r\n            console.log('[GHTK] Cancelling shipment:', trackingCode);\r\n            \r\n            // ‚úÖ L·∫•y credentials t·ª´ shipping_partners_config\r\n            const { getGHTKCredentials } = await import('../../lib/utils/get-shipping-credentials');\r\n            let credentials;\r\n            \r\n            try {\r\n                credentials = getGHTKCredentials();\r\n            } catch (error: any) {\r\n                return {\r\n                    success: false,\r\n                    message: error.message || 'Ch∆∞a c·∫•u h√¨nh GHTK. Vui l√≤ng v√†o C√†i ƒë·∫∑t ‚Üí ƒê·ªëi t√°c v·∫≠n chuy·ªÉn.'\r\n                };\r\n            }\r\n            \r\n            const response = await fetch(getApiUrl('/shipping/ghtk/cancel-order'), {\r\n                method: 'POST',\r\n                headers: {\r\n                    'Content-Type': 'application/json',\r\n                },\r\n                body: JSON.stringify({\r\n                    trackingCode,\r\n                    apiToken: credentials.apiToken,\r\n                    partnerCode: credentials.partnerCode,\r\n                }),\r\n            });\r\n            \r\n            const data = await response.json();\r\n            \r\n            // ‚úÖ Ki·ªÉm tra response t·ª´ GHTK\r\n            if (!response.ok) {\r\n                throw new Error(data.message || data.error || 'Failed to cancel GHTK shipment');\r\n            }\r\n            \r\n            // ‚úÖ GHTK tr·∫£ success: false khi kh√¥ng th·ªÉ h·ªßy (ƒë√£ l·∫•y h√†ng)\r\n            if (data.success === false) {\r\n                console.log('[GHTK] Cannot cancel:', data.message);\r\n                return { \r\n                    success: false, \r\n                    message: data.message || 'Kh√¥ng th·ªÉ h·ªßy ƒë∆°n h√†ng' \r\n                };\r\n            }\r\n            \r\n            console.log('[GHTK] Cancellation successful:', data.message);\r\n            \r\n            // ‚úÖ CH·ªà update state khi GHTK x√°c nh·∫≠n h·ªßy th√†nh c√¥ng\r\n            baseStore.setState(state => {\r\n                const order = state.data.find(o => o.systemId === orderSystemId);\r\n                if (!order) return state;\r\n                \r\n                const updatedPackagings = order.packagings.map(p => {\r\n                    if (p.systemId !== packagingSystemId) return p;\r\n                    \r\n                    return {\r\n                        ...p,\r\n                        status: 'H·ªßy ƒë√≥ng g√≥i' as PackagingStatus,\r\n                        deliveryStatus: 'ƒê√£ h·ªßy' as OrderDeliveryStatus,\r\n                        cancelDate: toISODateTime(new Date()),\r\n                        cancelReason: 'H·ªßy v·∫≠n ƒë∆°n GHTK',\r\n                        ghtkStatusId: -1,\r\n                        partnerStatus: 'H·ªßy ƒë∆°n h√†ng',\r\n                    };\r\n                });\r\n                \r\n                // ‚úÖ KH√îNG rollback stock - ƒë·ªÉ user t·ª± quy·∫øt ƒë·ªãnh (n√∫t \"H·ªßy giao v√† nh·∫≠n l·∫°i h√†ng\")\r\n                \r\n                const updatedOrder = {\r\n                    ...order,\r\n                    packagings: updatedPackagings,\r\n                };\r\n                \r\n                return {\r\n                    data: state.data.map(o => o.systemId === orderSystemId ? updatedOrder : o)\r\n                };\r\n            });\r\n            \r\n            return { \r\n                success: true, \r\n                message: data.message || 'ƒê√£ h·ªßy v·∫≠n ƒë∆°n GHTK th√†nh c√¥ng' \r\n            };\r\n            \r\n        } catch (error: any) {\r\n            console.error('[GHTK] Cancel error:', error);\r\n            return { \r\n                success: false, \r\n                message: error.message || 'L·ªói khi h·ªßy v·∫≠n ƒë∆°n GHTK' \r\n            };\r\n        }\r\n    },\r\n};\r\n\r\n// Auto-allocate historical receipts on startup\r\nuseReceiptStore.getState().data.forEach(receipt => {\r\n    autoAllocateReceiptToOrders(receipt);\r\n});\r\n\r\n// React to newly created receipts\r\nuseReceiptStore.subscribe(\r\n    state => state.data,\r\n    (currentReceipts, previousReceipts) => {\r\n        const previousIds = new Set((previousReceipts ?? []).map(r => r.systemId));\r\n        currentReceipts.forEach(receipt => {\r\n            if (!previousIds.has(receipt.systemId)) {\r\n                autoAllocateReceiptToOrders(receipt);\r\n            }\r\n        });\r\n    }\r\n);\r\n\r\n\r\n// Export typed hook with all augmented methods\r\nexport const useOrderStore = (): any => {\r\n  const state = baseStore();\r\n  return {\r\n    ...state,\r\n    ...augmentedMethods,\r\n  };\r\n};\r\n\r\n// Export getState for non-hook usage\r\nuseOrderStore.getState = (): any => {\r\n  const state = baseStore.getState();\r\n  return {\r\n    ...state,\r\n    ...augmentedMethods,\r\n  };\r\n};\r\n"],"names":[],"mappings":"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"}}]
}