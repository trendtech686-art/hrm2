{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/orders/order-detail-page.tsx"],"sourcesContent":["'use client'\r\n\r\nimport * as React from 'react';\r\nimport { useRouter, useParams } from 'next/navigation';\r\nimport Link from 'next/link';\r\nimport { formatDate, formatDateTime, formatDateTimeSeconds, formatDateCustom, parseDate, getCurrentDate, getDaysDiff } from '../../lib/date-utils';\r\nimport { useForm, FormProvider } from 'react-hook-form';\r\nimport { useAllOrders, useOrderFinder } from './hooks/use-all-orders';\r\nimport { useOrderMutations } from './hooks/use-order-mutations';\r\nimport { useOrderActions } from './hooks/use-order-actions';\r\n// ⚠️ Still needed for complex order action methods (cancelOrder, addPayment, packaging, shipment, etc.)\r\n// TODO: Migrate these to API endpoints and React Query mutations\r\nimport { useOrderStore } from './store';\r\nimport type { Order, OrderMainStatus, OrderPayment, Packaging, PackagingStatus, OrderDeliveryStatus } from './types';\r\nimport { formatOrderAddress } from './address-utils';\r\nimport { toast } from 'sonner';\r\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle, CardFooter } from '../../components/ui/card';\r\nimport { Button } from '../../components/ui/button';\r\nimport { Badge } from '../../components/ui/badge';\r\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow, TableFooter } from '../../components/ui/table';\r\nimport { Separator } from '../../components/ui/separator';\r\nimport { useAllCustomers, useCustomerFinder } from '../customers/hooks/use-all-customers';\r\nimport { \r\n  useAllCustomerTypes, useCustomerTypeFinder, \r\n  useAllCustomerGroups, useCustomerGroupFinder,\r\n  useAllCustomerSources, useCustomerSourceFinder \r\n} from '../settings/customers/hooks/use-all-customer-settings';\r\nimport { ArrowLeft, Edit, Printer, Check, Copy, Settings, ChevronDown, Users, Truck, CheckCircle2, FileWarning, PackageSearch, Package, PackageCheck, MoreHorizontal, Ban, File, Calendar, User, Info, MessageSquare, Banknote, PlusCircle, ThumbsUp, PackageX, ChevronRight, Undo2, Store, Clock, Eye, StickyNote, ArrowDownLeft } from 'lucide-react';\r\nimport { cn } from '../../lib/utils';\r\nimport { useAllEmployees, useEmployeeFinder, useEmployeeSearcher } from '../employees/hooks/use-all-employees';\r\nimport { AlertDialog, AlertDialogAction, AlertDialogCancel, AlertDialogContent, AlertDialogDescription, AlertDialogFooter, AlertDialogHeader, AlertDialogTitle } from '../../components/ui/alert-dialog';\r\nimport { Alert, AlertDescription, AlertTitle } from '../../components/ui/alert';\r\nimport { Dialog, DialogContent, DialogFooter, DialogHeader, DialogTitle, DialogDescription } from '../../components/ui/dialog';\r\nimport { Form, FormControl, FormField, FormItem, FormLabel, FormMessage } from '../../components/ui/form';\r\nimport { Input } from '../../components/ui/input';\r\nimport { Label } from '../../components/ui/label';\r\nimport { Checkbox } from '../../components/ui/checkbox';\r\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '../../components/ui/select';\r\nimport { CurrencyInput } from '../../components/ui/currency-input';\r\nimport { DropdownMenu, DropdownMenuContent, DropdownMenuItem, DropdownMenuTrigger } from '../../components/ui/dropdown-menu';\r\nimport { DetailField } from '../../components/ui/detail-field';\r\nimport { ImagePreviewDialog } from '../../components/ui/image-preview-dialog';\r\nimport { Textarea } from '../../components/ui/textarea';\r\nimport { useAllShippingPartners } from '../settings/shipping/hooks/use-all-shipping-partners';\r\nimport { useAllProducts, useProductFinder } from '../products/hooks/use-all-products';\r\nimport { ProductImage, useProductImage } from '../products/components/product-image';\r\nimport { useAllWarranties } from '../warranty/hooks/use-all-warranties';\r\nimport { useAllComplaints } from '../complaints/hooks/use-all-complaints';\r\nimport { Spinner } from '../../components/ui/spinner';\r\nimport { usePageHeader } from '../../contexts/page-header-context';\r\nimport { useAllPaymentMethods } from '../settings/payments/hooks/use-all-payment-methods';\r\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from '../../components/ui/tabs';\r\nimport { Timeline, TimelineItem } from '../../components/ui/timeline';\r\nimport { Combobox, type ComboboxOption } from '../../components/ui/combobox';\r\nimport { PackagingInfo } from './components/packaging-info';\r\nimport { CancelShipmentDialog } from './components/cancel-shipment-dialog';\r\nimport { CancelPackagingDialog } from './components/cancel-packaging-dialog';\r\nimport { DeliveryFailureDialog } from './components/delivery-failure-dialog';\r\nimport { PaymentInfo } from './components/payment-info';\r\n\r\nimport { ShippingTrackingTab } from './components/shipping-tracking-tab';\r\nimport { Collapsible, CollapsibleContent, CollapsibleTrigger } from '../../components/ui/collapsible';\r\nimport { useAllSalesReturns } from '../sales-returns/hooks/use-all-sales-returns';\r\nimport type { SalesReturn } from '../sales-returns/types';\r\nimport { useAllReceipts } from '../receipts/hooks/use-all-receipts';\r\nimport { useAllPayments } from '../payments/hooks/use-all-payments';\r\nimport type { Receipt } from '../receipts/types';\r\nimport type { Payment } from '../payments/types';\r\nimport { PartnerShipmentForm } from './components/partner-shipment-form';\r\nimport { ShippingIntegration } from './components/shipping-integration';\r\nimport type { OrderFormValues } from './order-form-page';\r\nimport { useAuth } from '../../contexts/auth-context';\r\nimport { asSystemId, type SystemId } from '../../lib/id-types';\r\nimport { OrderWorkflowCard } from './components/order-workflow-card';\r\nimport { getWorkflowTemplates } from '../settings/printer/workflow-templates-page';\r\nimport { ActivityHistory, type HistoryEntry } from '../../components/ActivityHistory';\r\nimport { DatabaseComments } from '../../components/DatabaseComments';\r\n\r\nimport { useAllProductTypes, useProductTypeFinder } from '../settings/inventory/hooks/use-all-product-types';\r\nimport { useAllPricingPolicies, useDefaultSellingPolicy } from '../settings/pricing/hooks/use-all-pricing-policies';\r\nimport { useCustomerSlaEvaluation } from '../customers/sla/hooks';\r\nimport { ReadOnlyProductsTable } from '../../components/shared/read-only-products-table';\r\nimport { OrderPrintButton } from './components/order-print-button';\r\nimport { useAllBranches, useBranchFinder } from '../settings/branches/hooks/use-all-branches';\r\nimport { useBranding, getFullLogoUrl } from '../../hooks/use-branding';\r\nimport { mapSalesReturnToPrintData, SalesReturnForPrint } from '../../lib/print-mappers/sales-return.mapper';\r\nimport { mapPaymentToPrintData, PaymentForPrint } from '../../lib/print-mappers/payment.mapper';\r\nimport { useStoreInfo } from '../settings/store-info/hooks/use-store-info';\r\nimport { usePrint } from '../../lib/use-print';\r\nimport { StoreSettings, numberToWords, formatTime } from '../../lib/print-service';\r\n\r\n// Component hiển thị ảnh sản phẩm với preview - sử dụng server image priority\r\n// Nhận product trực tiếp từ parent để tránh re-call useProductStore trong mỗi row\r\nconst ProductThumbnailCell = ({ \r\n    productSystemId, \r\n    product,\r\n    productName, \r\n    size = 'md',\r\n    onPreview \r\n}: { \r\n    productSystemId: string; \r\n    product?: { thumbnailImage?: string; galleryImages?: string[]; images?: string[]; name?: string } | null;\r\n    productName: string;\r\n    size?: 'sm' | 'md';\r\n    onPreview?: (image: string, title: string) => void;\r\n}) => {\r\n    const imageUrl = useProductImage(productSystemId, product);\r\n    \r\n    const sizeClasses = size === 'sm' \r\n        ? 'w-10 h-9' \r\n        : 'w-12 h-10';\r\n    const iconSize = size === 'sm' ? 'h-4 w-4' : 'h-4 w-4';\r\n    \r\n    if (imageUrl) {\r\n        return (\r\n            <div\r\n                className={`group/thumbnail relative ${sizeClasses} rounded border overflow-hidden bg-muted ${onPreview ? 'cursor-pointer' : ''}`}\r\n                onClick={() => onPreview?.(imageUrl, productName)}\r\n            >\r\n                <img src={imageUrl} alt={productName} className=\"w-full h-full object-cover transition-all group-hover/thumbnail:brightness-75\" />\r\n                {onPreview && (\r\n                    <div className=\"absolute inset-0 flex items-center justify-center opacity-0 group-hover/thumbnail:opacity-100 transition-opacity\">\r\n                        <Eye className=\"w-4 h-4 text-white drop-shadow-md\" />\r\n                    </div>\r\n                )}\r\n            </div>\r\n        );\r\n    }\r\n    \r\n    return (\r\n        <div className={`${sizeClasses} bg-muted rounded flex items-center justify-center`}>\r\n            <Package className={`${iconSize} text-muted-foreground`} />\r\n        </div>\r\n    );\r\n};\r\n\r\nconst normalizeCurrencyValue = (value?: number) => {\r\n    if (typeof value !== 'number' || Number.isNaN(value)) return 0;\r\n    return Math.abs(value) < 0.005 ? 0 : value;\r\n};\r\n\r\nconst formatCurrency = (value?: number) => {\r\n    const normalized = normalizeCurrencyValue(value);\r\n    return new Intl.NumberFormat('vi-VN').format(normalized);\r\n};\r\n\r\nconst formatNumber = (value?: number) => {\r\n    if (typeof value !== 'number' || isNaN(value)) return '0';\r\n    return new Intl.NumberFormat('vi-VN').format(value);\r\n};\r\n\r\n\r\n\r\nconst formatAddress = (street?: string, ward?: string, province?: string) => {\r\n    return [street, ward, province].filter(Boolean).join(', ');\r\n};\r\n\r\nconst getCustomerAddress = (customer: any, type: 'shipping' | 'billing'): string => {\r\n    if (!customer?.addresses || customer.addresses.length === 0) return '';\r\n    \r\n    // Find address by type, or use default if type not found\r\n    let address = customer.addresses.find((addr: any) => addr.type === type);\r\n    \r\n    // Fallback to default address if specific type not found\r\n    if (!address) {\r\n        address = customer.addresses.find((addr: any) => addr.isDefault);\r\n    }\r\n    \r\n    // Fallback to first address\r\n    if (!address) {\r\n        address = customer.addresses[0];\r\n    }\r\n    \r\n    if (!address) return '';\r\n    \r\n    // Format: street, ward, district, province\r\n    return [\r\n        address.street,\r\n        address.ward,\r\n        address.district,\r\n        address.province\r\n    ].filter(Boolean).join(', ');\r\n};\r\n\r\n// ✅ Helper to format address object or string\r\nconst formatAddressObject = (address: any): string => formatOrderAddress(address);\r\n\r\nconst statusVariants: Record<OrderMainStatus, \"success\" | \"default\" | \"secondary\" | \"warning\" | \"destructive\"> = {\r\n    \"Đặt hàng\": \"secondary\",\r\n    \"Đang giao dịch\": \"warning\",\r\n    \"Hoàn thành\": \"success\",\r\n    \"Đã hủy\": \"destructive\",\r\n};\r\n\r\nconst productTypeFallbackLabels: Record<string, string> = {\r\n    physical: 'Hàng hóa',\r\n    service: 'Dịch vụ',\r\n    digital: 'Sản phẩm số',\r\n    combo: 'Combo',\r\n};\r\n\r\n// A simple deterministic hash function to generate stable mock prices\r\nfunction simpleHash(str: string): number {\r\n  let hash = 0;\r\n  for (let i = 0; i < str.length; i++) {\r\n    const char = str.charCodeAt(i);\r\n    hash = (hash << 5) - hash + char;\r\n    hash |= 0; // Convert to 32bit integer\r\n  }\r\n  return Math.abs(hash);\r\n}\r\n\r\n\r\nconst StatusStepper = ({ order }: { order: Order }) => {\r\n    const isPackaged = order.packagings.some(p => p.status === 'Đã đóng gói');\r\n    const steps = [\r\n        { name: 'Đặt hàng', date: order.orderDate },\r\n        { name: 'Duyệt', date: order.approvedDate },\r\n        { name: 'Đóng gói', date: isPackaged ? order.packagings.find(p=>p.status === 'Đã đóng gói')?.confirmDate : undefined },\r\n        { name: 'Xuất kho', date: order.dispatchedDate },\r\n        { name: 'Hoàn thành', date: order.completedDate }\r\n    ];\r\n\r\n    let currentStepIndex = 0; // Default to 'Đặt hàng'\r\n    if (order.status === 'Hoàn thành') {\r\n        currentStepIndex = 5; // All 5 steps (0-4) are completed.\r\n    } else if (order.dispatchedDate || ['Đang giao hàng', 'Đã giao hàng'].includes(order.deliveryStatus)) {\r\n        currentStepIndex = 4; // Current step is 'Hoàn thành' (index 4)\r\n    } else if (isPackaged || order.deliveryStatus === 'Đã đóng gói') {\r\n        currentStepIndex = 3; // Current step is 'Xuất kho' (index 3)\r\n    } else if (order.approvedDate) {\r\n        currentStepIndex = 2; // Current step is 'Đóng gói' (index 2)\r\n    } else if (order.orderDate) {\r\n        currentStepIndex = 1; // Current step is 'Duyệt' (index 1)\r\n    }\r\n\r\n    if (order.status === 'Đã hủy') {\r\n        let lastValidStep = -1;\r\n        if (order.dispatchedDate) lastValidStep = 3;\r\n        else if (isPackaged) lastValidStep = 2;\r\n        else if (order.approvedDate) lastValidStep = 1;\r\n        else if (order.orderDate) lastValidStep = 0;\r\n        currentStepIndex = lastValidStep;\r\n    }\r\n\r\n    return (\r\n        <div className=\"flex items-start justify-between w-full px-4 pt-4\">\r\n            {steps.map((step, index) => {\r\n                const isCompleted = index < currentStepIndex;\r\n                const isCurrent = index === currentStepIndex;\r\n                const isCancelled = order.status === 'Đã hủy' && isCurrent;\r\n                const Icon = Check;\r\n\r\n                return (\r\n                    <React.Fragment key={step.name}>\r\n                        <div className=\"flex flex-col items-center text-center w-24\">\r\n                            <div className={cn(\r\n                                \"flex items-center justify-center w-8 h-8 rounded-full border-2 font-semibold text-body-sm\",\r\n                                isCancelled ? \"bg-red-100 border-red-500 text-red-500\" :\r\n                                isCompleted ? \"bg-primary border-primary text-primary-foreground\" :\r\n                                isCurrent ? \"border-primary text-primary\" :\r\n                                \"border-gray-300 bg-gray-100 text-gray-400\"\r\n                            )}>\r\n                                {isCompleted ? <Icon className=\"h-4 w-4\" /> : index + 1}\r\n                            </div>\r\n                            <p className={cn(\"text-body-sm mt-2 font-medium\", isCompleted || isCurrent ? \"text-foreground\" : \"text-foreground\")}>{step.name}</p>\r\n                            <p className=\"text-body-xs text-foreground mt-1\">{step.date ? formatDateTime(step.date) : '-'}</p>\r\n                        </div>\r\n                        {index < steps.length - 1 && (\r\n                            <div className={cn(\r\n                                \"flex-1 mt-4 h-0.5\",\r\n                                index < currentStepIndex ? \"bg-primary\" : \"bg-gray-300\",\r\n                            )} />\r\n                        )}\r\n                    </React.Fragment>\r\n                );\r\n            })}\r\n        </div>\r\n    );\r\n};\r\n\r\ntype PaymentFormValues = {\r\n  method: string;\r\n  amount: number;\r\n  reference?: string;\r\n  accountNumber?: string;\r\n  accountName?: string;\r\n  bankName?: string;\r\n};\r\n\r\nfunction PaymentDialog({\r\n  isOpen,\r\n  onOpenChange,\r\n  amountDue,\r\n  onSubmit,\r\n}: {\r\n  isOpen: boolean;\r\n  onOpenChange: (open: boolean) => void;\r\n  amountDue: number;\r\n  onSubmit: (data: PaymentFormValues) => void;\r\n}) {\r\n  const { data: paymentMethods } = useAllPaymentMethods();\r\n  const defaultPaymentMethod = React.useMemo(\r\n    () => paymentMethods.find(pm => pm.isDefault),\r\n    [paymentMethods]\r\n  );\r\n  \r\n  const form = useForm<PaymentFormValues>({\r\n    defaultValues: {\r\n      method: 'Tiền mặt',\r\n      amount: amountDue,\r\n      reference: '',\r\n      accountNumber: '',\r\n      accountName: '',\r\n      bankName: '',\r\n    },\r\n  });\r\n\r\n  const selectedMethod = form.watch('method');\r\n\r\n  React.useEffect(() => {\r\n    if (isOpen) {\r\n      form.reset({\r\n        method: 'Tiền mặt',\r\n        amount: amountDue > 0 ? amountDue : 0,\r\n        reference: '',\r\n        accountNumber: '',\r\n        accountName: '',\r\n        bankName: '',\r\n      });\r\n    }\r\n  }, [isOpen, amountDue, form]);\r\n\r\n  // Auto-fill bank account info when selecting \"Chuyển khoản\"\r\n  React.useEffect(() => {\r\n    if (selectedMethod === 'Chuyển khoản' && defaultPaymentMethod) {\r\n      form.setValue('accountNumber', defaultPaymentMethod.accountNumber || '');\r\n      form.setValue('accountName', defaultPaymentMethod.accountName || '');\r\n      form.setValue('bankName', defaultPaymentMethod.bankName || '');\r\n    }\r\n  }, [selectedMethod, defaultPaymentMethod, form]);\r\n\r\n  return (\r\n    <Dialog open={isOpen} onOpenChange={onOpenChange}>\r\n      <DialogContent>\r\n        <DialogHeader>\r\n          <DialogTitle>Thanh toán đơn hàng</DialogTitle>\r\n        </DialogHeader>\r\n        <Form {...form}>\r\n          <form id=\"payment-form\" onSubmit={form.handleSubmit(onSubmit)} className=\"space-y-4 pt-4\">\r\n            <FormField control={form.control} name=\"method\" render={({ field }) => (\r\n                <FormItem>\r\n                    <FormLabel>Phương thức</FormLabel>\r\n                    <Select onValueChange={field.onChange} value={field.value}>\r\n                        <FormControl><SelectTrigger><SelectValue /></SelectTrigger></FormControl>\r\n                        <SelectContent><SelectItem value=\"Tiền mặt\">Tiền mặt</SelectItem><SelectItem value=\"Chuyển khoản\">Chuyển khoản</SelectItem><SelectItem value=\"Quẹt thẻ\">Quẹt thẻ</SelectItem></SelectContent>\r\n                    </Select>\r\n                </FormItem>\r\n            )} />\r\n            <FormField \r\n                control={form.control} \r\n                name=\"amount\" \r\n                rules={{\r\n                    required: 'Vui lòng nhập số tiền',\r\n                    min: { value: 1, message: 'Số tiền phải lớn hơn 0' },\r\n                    max: { value: amountDue, message: `Số tiền không được vượt quá ${new Intl.NumberFormat('vi-VN').format(amountDue)} ₫` }\r\n                }}\r\n                render={({ field, fieldState }) => (\r\n                <FormItem>\r\n                    <FormLabel>Số tiền</FormLabel>\r\n                    <FormControl>\r\n                        <CurrencyInput \r\n                            value={field.value as number} \r\n                            onChange={field.onChange}\r\n                            onBlur={field.onBlur}\r\n                            name={field.name}\r\n                            className={fieldState.error ? 'border-destructive' : ''}\r\n                        />\r\n                    </FormControl>\r\n                    {fieldState.error && (\r\n                        <p className=\"text-body-sm text-destructive\">{fieldState.error.message}</p>\r\n                    )}\r\n                </FormItem>\r\n            )} />\r\n            <FormField control={form.control} name=\"reference\" render={({ field }) => (\r\n                <FormItem>\r\n                    <FormLabel>Tham chiếu</FormLabel>\r\n                    <FormControl><Input {...field} placeholder=\"VD: Mã giao dịch ngân hàng\" /></FormControl>\r\n                </FormItem>\r\n            )} />\r\n            \r\n            {/* Bank account info - only show when method is \"Chuyển khoản\" */}\r\n            {selectedMethod === 'Chuyển khoản' && (\r\n              <div className=\"space-y-4 p-4 border rounded-lg bg-muted/30\">\r\n                <p className=\"text-body-sm font-medium\">Thông tin tài khoản nhận</p>\r\n                <FormField control={form.control} name=\"accountNumber\" render={({ field }) => (\r\n                  <FormItem>\r\n                    <FormLabel>Số tài khoản</FormLabel>\r\n                    <FormControl><Input {...field} placeholder=\"VD: 1234567890\" /></FormControl>\r\n                  </FormItem>\r\n                )} />\r\n                <FormField control={form.control} name=\"accountName\" render={({ field }) => (\r\n                  <FormItem>\r\n                    <FormLabel>Tên chủ tài khoản</FormLabel>\r\n                    <FormControl><Input {...field} placeholder=\"VD: NGUYEN VAN A\" /></FormControl>\r\n                  </FormItem>\r\n                )} />\r\n                <FormField control={form.control} name=\"bankName\" render={({ field }) => (\r\n                  <FormItem>\r\n                    <FormLabel>Ngân hàng</FormLabel>\r\n                    <FormControl><Input {...field} placeholder=\"VD: Vietcombank - CN HCM\" /></FormControl>\r\n                  </FormItem>\r\n                )} />\r\n              </div>\r\n            )}\r\n          </form>\r\n        </Form>\r\n        <DialogFooter>\r\n          <Button variant=\"outline\" onClick={() => onOpenChange(false)}>Hủy</Button>\r\n          <Button type=\"submit\" form=\"payment-form\">Xác nhận thanh toán</Button>\r\n        </DialogFooter>\r\n      </DialogContent>\r\n    </Dialog>\r\n  );\r\n}\r\n\r\nfunction CreateShipmentDialog({\r\n    isOpen, onOpenChange, \r\n    onSubmit, \r\n    order,\r\n    customer,\r\n}: { \r\n    isOpen: boolean; \r\n    onOpenChange: (open: boolean) => void; \r\n    onSubmit: (data: Partial<OrderFormValues>) => Promise<any>;\r\n    order: Order | null;\r\n    customer: any;\r\n}) {\r\n    const [isLoading, setIsLoading] = React.useState(false);\r\n    const form = useForm<OrderFormValues>();\r\n    const { handleSubmit, reset } = form;\r\n\r\n    React.useEffect(() => {\r\n        if (isOpen && order && customer) {\r\n            reset({\r\n                customer: customer,\r\n                lineItems: order.lineItems,\r\n                grandTotal: order.grandTotal,\r\n                payments: order.payments,\r\n                branchSystemId: order.branchSystemId, // ✅ Use systemId only\r\n                deliveryMethod: 'shipping-partner', // ✅ Force shipping-partner mode\r\n            });\r\n        }\r\n    }, [isOpen, order, customer, reset]);\r\n\r\n    const handleFormSubmit = async (data: Partial<OrderFormValues>) => {\r\n        if (!order) return;\r\n        setIsLoading(true);\r\n        try {\r\n            const result = await onSubmit(data);\r\n            if (result && result.success) {\r\n                toast.success('Thành công', { description: result.message });\r\n                onOpenChange(false);\r\n            } else {\r\n                toast.error('Lỗi', { description: result?.message || 'Không thể tạo đơn vận chuyển' });\r\n            }\r\n        } catch (error) {\r\n            console.error('[CreateShipmentDialog] Error:', error);\r\n            toast.error('Lỗi', { description: 'Có lỗi xảy ra khi tạo đơn vận chuyển' });\r\n        } finally {\r\n            setIsLoading(false);\r\n        }\r\n    };\r\n\r\n    return (\r\n        <Dialog open={isOpen} onOpenChange={onOpenChange}>\r\n            <DialogContent className=\"max-w-6xl h-[90vh] flex flex-col\">\r\n                <DialogHeader>\r\n                    <DialogTitle>Đẩy qua hãng vận chuyển</DialogTitle>\r\n                    <DialogDescription>Cấu hình và tạo đơn vận chuyển qua đối tác.</DialogDescription>\r\n                </DialogHeader>\r\n                <FormProvider {...form}>\r\n                    <form id=\"create-shipping-form-dialog\" onSubmit={handleSubmit(handleFormSubmit)} className=\"flex-grow overflow-hidden flex flex-col\">\r\n                        <div className=\"flex-grow overflow-auto p-1\">\r\n                          {/* ✅ Use ShippingIntegration with hideTabs - same component, different rendering */}\r\n                          <ShippingIntegration hideTabs />\r\n                        </div>\r\n                         <DialogFooter className=\"mt-4 flex-shrink-0\">\r\n                            <Button variant=\"outline\" onClick={() => onOpenChange(false)} disabled={isLoading}>Hủy</Button>\r\n                            <Button type=\"submit\" disabled={isLoading}>\r\n                                {isLoading && <Spinner className=\"mr-2 h-4 w-4\" />}\r\n                                Tạo đơn vận chuyển\r\n                            </Button>\r\n                        </DialogFooter>\r\n                    </form>\r\n                </FormProvider>\r\n            </DialogContent>\r\n        </Dialog>\r\n    );\r\n}\r\n\r\nfunction PackerSelectionDialog({\r\n    isOpen,\r\n    onOpenChange,\r\n    onSubmit,\r\n    existingPackerSystemId,\r\n}: {\r\n    isOpen: boolean;\r\n    onOpenChange: (open: boolean) => void;\r\n    onSubmit: (packerId?: SystemId) => void;\r\n    existingPackerSystemId?: SystemId;\r\n}) {\r\n  const { searchEmployees } = useEmployeeSearcher();\r\n  const [selectedEmployee, setSelectedEmployee] = React.useState<ComboboxOption | null>(null);\r\n\r\n    const handleSubmit = () => {\r\n        onSubmit(selectedEmployee ? asSystemId(selectedEmployee.value) : undefined);\r\n    onOpenChange(false);\r\n  };\r\n\r\n  // Preload existing packer if set in order\r\n  React.useEffect(() => {\r\n      if (isOpen && existingPackerSystemId) {\r\n          // Find employee and set as selected\r\n          searchEmployees('', 0, 100).then(result => {\r\n              const existing = result.items.find(e => e.value === existingPackerSystemId);\r\n              if (existing) {\r\n                  setSelectedEmployee(existing);\r\n              }\r\n          });\r\n      } else if (isOpen) {\r\n          setSelectedEmployee(null);\r\n      }\r\n  }, [isOpen, existingPackerSystemId, searchEmployees]);\r\n\r\n  return (\r\n    <Dialog open={isOpen} onOpenChange={onOpenChange}>\r\n      <DialogContent>\r\n        <DialogHeader>\r\n          <DialogTitle>Chọn nhân viên đóng gói</DialogTitle>\r\n          <DialogDescription>\r\n            Chỉ định một nhân viên để thực hiện đóng gói cho đơn hàng này. Bạn có thể bỏ qua để yêu cầu chung.\r\n          </DialogDescription>\r\n        </DialogHeader>\r\n        <div className=\"pt-4\">\r\n          <Combobox\r\n            value={selectedEmployee}\r\n            onChange={setSelectedEmployee}\r\n            onSearch={searchEmployees as any}\r\n            placeholder=\"Tìm nhân viên...\"\r\n            searchPlaceholder=\"Tìm kiếm...\"\r\n            emptyPlaceholder=\"Không tìm thấy nhân viên.\"\r\n          />\r\n        </div>\r\n        <DialogFooter>\r\n          <Button variant=\"outline\" onClick={() => onOpenChange(false)}>\r\n            Hủy\r\n          </Button>\r\n          <Button onClick={handleSubmit}>Yêu cầu đóng gói</Button>\r\n        </DialogFooter>\r\n      </DialogContent>\r\n    </Dialog>\r\n  );\r\n}\r\n\r\nconst OrderHistoryTab = ({ order, salesReturnsForOrder }: { order: Order; salesReturnsForOrder: SalesReturn[] }) => {\r\n    const { data: receipts } = useAllReceipts();\r\n    const { data: payments } = useAllPayments();\r\n    const { data: warranties } = useAllWarranties();\r\n    const { findById: findEmployeeById } = useEmployeeFinder();\r\n    const allTransactions = React.useMemo(() => [...receipts, ...payments], [receipts, payments]);\r\n\r\n    const parseTimestamp = React.useCallback((value?: string) => {\r\n        if (!value) return undefined;\r\n        return new Date(value.includes('T') ? value : value.replace(' ', 'T'));\r\n    }, []);\r\n\r\n    const buildUser = React.useCallback((systemId?: SystemId | string, fallbackName?: string) => {\r\n        if (systemId && typeof systemId === 'string') {\r\n            const employee = findEmployeeById(asSystemId(systemId));\r\n            if (employee) {\r\n                return { systemId: employee.systemId, name: employee.fullName };\r\n            }\r\n        }\r\n\r\n        if (fallbackName) {\r\n            return { systemId: typeof systemId === 'string' ? systemId : 'SYSTEM', name: fallbackName };\r\n        }\r\n\r\n        return { systemId: typeof systemId === 'string' ? systemId : 'SYSTEM', name: 'Hệ thống' };\r\n    }, [findEmployeeById]);\r\n\r\n    const historyEntries = React.useMemo<HistoryEntry[]>(() => {\r\n        if (!order) return [];\r\n        const entries: HistoryEntry[] = [];\r\n\r\n        const pushEntry = (entry: HistoryEntry | null | undefined) => {\r\n            if (entry && entry.timestamp) {\r\n                entries.push(entry);\r\n            }\r\n        };\r\n\r\n        const createdAt = parseTimestamp(order.orderDate);\r\n        if (createdAt) {\r\n            pushEntry({\r\n                id: `${order.systemId}-created`,\r\n                action: 'created',\r\n                timestamp: createdAt,\r\n                user: buildUser(order.salespersonSystemId, order.salesperson),\r\n                description: `Tạo đơn hàng ${order.id}`,\r\n            });\r\n        }\r\n\r\n        const approvedAt = parseTimestamp(order.approvedDate);\r\n        if (approvedAt) {\r\n            pushEntry({\r\n                id: `${order.systemId}-approved`,\r\n                action: 'status_changed',\r\n                timestamp: approvedAt,\r\n                user: buildUser(undefined, 'Hệ thống'),\r\n                description: 'Đã duyệt đơn hàng',\r\n            });\r\n        }\r\n\r\n        const dispatchedAt = parseTimestamp(order.dispatchedDate);\r\n        if (dispatchedAt) {\r\n            pushEntry({\r\n                id: `${order.systemId}-dispatched`,\r\n                action: 'status_changed',\r\n                timestamp: dispatchedAt,\r\n                user: buildUser(order.dispatchedByEmployeeId, order.dispatchedByEmployeeName),\r\n                description: 'Xuất kho cho đơn hàng',\r\n            });\r\n        }\r\n\r\n        const completedAt = parseTimestamp(order.completedDate);\r\n        if (completedAt) {\r\n            pushEntry({\r\n                id: `${order.systemId}-completed`,\r\n                action: 'status_changed',\r\n                timestamp: completedAt,\r\n                user: buildUser(undefined, 'Hệ thống'),\r\n                description: 'Hoàn thành đơn hàng',\r\n            });\r\n        }\r\n\r\n        const cancelledAt = parseTimestamp(order.cancelledDate);\r\n        if (cancelledAt) {\r\n            pushEntry({\r\n                id: `${order.systemId}-cancelled`,\r\n                action: 'cancelled',\r\n                timestamp: cancelledAt,\r\n                user: buildUser(undefined, 'Hệ thống'),\r\n                description: 'Hủy đơn hàng',\r\n                content: (\r\n                    <div className=\"text-body-sm\">\r\n                        <span>Lý do: </span>\r\n                        <span className=\"font-medium\">{order.cancellationReason || 'Không rõ'}</span>\r\n                        {order.cancellationMetadata && (\r\n                            <p className=\"mt-1 text-body-xs text-muted-foreground\">\r\n                                {order.cancellationMetadata.restockItems ? 'Đã hoàn kho' : 'Không hoàn kho'} ·{' '}\r\n                                {order.cancellationMetadata.notifyCustomer ? 'Đã gửi email cho khách' : 'Không gửi email cho khách'}\r\n                            </p>\r\n                        )}\r\n                    </div>\r\n                ),\r\n            });\r\n        }\r\n\r\n        order.payments.forEach(payment => {\r\n            const timestamp = parseTimestamp(payment.date);\r\n            if (!timestamp) return;\r\n            const isRefund = payment.amount < 0;\r\n            const absAmount = formatCurrency(Math.abs(payment.amount));\r\n            const voucherPath = isRefund ? 'payments' : 'receipts';\r\n            const paymentLink = (\r\n                <Link href={`/${voucherPath}/${payment.systemId}`} className=\"font-semibold text-primary hover:underline\">\r\n                    {payment.id}\r\n                </Link>\r\n            );\r\n            const warrantyLink = payment.linkedWarrantySystemId ? (\r\n                <>\r\n                    {' '}từ bảo hành{' '}\r\n                    <Link\r\n                        href={`/warranty/${payment.linkedWarrantySystemId}`}\r\n                        className=\"font-semibold text-primary hover:underline\"\r\n                    >\r\n                        {warranties.find(w => w.systemId === payment.linkedWarrantySystemId)?.id || 'N/A'}\r\n                    </Link>\r\n                </>\r\n            ) : null;\r\n\r\n            pushEntry({\r\n                id: `${order.systemId}-payment-${payment.systemId}`,\r\n                action: 'payment_made',\r\n                timestamp,\r\n                user: buildUser(payment.createdBy),\r\n                description: `${isRefund ? 'Hoàn tiền' : 'Thanh toán'} ${absAmount} qua ${payment.method}`,\r\n                content: (\r\n                    <>\r\n                        {isRefund ? 'Hoàn tiền' : 'Thanh toán'}{' '}\r\n                        <span className=\"font-semibold\">{absAmount}</span> qua {payment.method} ({paymentLink}){warrantyLink}.\r\n                    </>\r\n                ),\r\n            });\r\n        });\r\n\r\n        order.packagings.forEach(pkg => {\r\n            const requestDate = parseTimestamp(pkg.requestDate);\r\n            if (requestDate) {\r\n                pushEntry({\r\n                    id: `${pkg.systemId}-request`,\r\n                    action: 'product_added',\r\n                    timestamp: requestDate,\r\n                    user: buildUser(pkg.requestingEmployeeId, pkg.requestingEmployeeName),\r\n                    description: 'Yêu cầu đóng gói',\r\n                    content: (\r\n                        <>\r\n                            Yêu cầu đóng gói{' '}\r\n                            <Link href={`/packaging/${pkg.systemId}`} className=\"text-primary hover:underline\">\r\n                                {pkg.id}\r\n                            </Link>\r\n                            .\r\n                        </>\r\n                    ),\r\n                });\r\n            }\r\n\r\n            const confirmDate = parseTimestamp(pkg.confirmDate);\r\n            if (confirmDate) {\r\n                pushEntry({\r\n                    id: `${pkg.systemId}-confirm`,\r\n                    action: 'status_changed',\r\n                    timestamp: confirmDate,\r\n                    user: buildUser(pkg.confirmingEmployeeId, pkg.confirmingEmployeeName),\r\n                    description: 'Xác nhận đóng gói',\r\n                    content: (\r\n                        <>\r\n                            Xác nhận đóng gói{' '}\r\n                            <Link href={`/packaging/${pkg.systemId}`} className=\"text-primary hover:underline\">\r\n                                {pkg.id}\r\n                            </Link>\r\n                            .\r\n                        </>\r\n                    ),\r\n                });\r\n            }\r\n\r\n            const cancelDate = parseTimestamp(pkg.cancelDate);\r\n            if (cancelDate) {\r\n                pushEntry({\r\n                    id: `${pkg.systemId}-cancel`,\r\n                    action: 'cancelled',\r\n                    timestamp: cancelDate,\r\n                    user: buildUser(pkg.cancelingEmployeeId, pkg.cancelingEmployeeName),\r\n                    description: 'Hủy yêu cầu đóng gói',\r\n                    content: (\r\n                        <>\r\n                            Hủy đóng gói{' '}\r\n                            <Link href={`/packaging/${pkg.systemId}`} className=\"text-primary hover:underline\">\r\n                                {pkg.id}\r\n                            </Link>\r\n                            . Lý do: <span className=\"italic\">{pkg.cancelReason || 'Không rõ'}</span>\r\n                        </>\r\n                    ),\r\n                });\r\n            }\r\n        });\r\n\r\n        salesReturnsForOrder.forEach(returnSlip => {\r\n            const timestamp = parseTimestamp(returnSlip.returnDate);\r\n            if (!timestamp) return;\r\n            const transactionSystemId = returnSlip.paymentVoucherSystemId || returnSlip.receiptVoucherSystemIds?.[0];\r\n            const transaction = transactionSystemId ? allTransactions.find(t => t.systemId === transactionSystemId) : null;\r\n            const transactionLink = transaction ? (\r\n                <>\r\n                    {' '}và chứng từ{' '}\r\n                    <Link\r\n                        href={`/${returnSlip.paymentVoucherSystemId ? 'payments' : 'receipts'}/${transaction.systemId}`}\r\n                        className=\"font-semibold text-primary hover:underline\"\r\n                    >\r\n                        {transaction.id}\r\n                    </Link>\r\n                </>\r\n            ) : null;\r\n            const exchangeOrderLink = returnSlip.exchangeOrderSystemId ? (\r\n                <>\r\n                    {' '}và tạo đơn đổi{' '}\r\n                    <Link href={`/orders/${returnSlip.exchangeOrderSystemId}`} className=\"font-semibold text-primary hover:underline\">\r\n                        Xem đơn đổi\r\n                    </Link>\r\n                </>\r\n            ) : null;\r\n\r\n            pushEntry({\r\n                id: `${order.systemId}-return-${returnSlip.systemId}`,\r\n                action: 'custom',\r\n                timestamp,\r\n                user: buildUser(returnSlip.creatorSystemId, returnSlip.creatorName),\r\n                description: `Tạo phiếu trả hàng ${returnSlip.id}`,\r\n                content: (\r\n                    <>\r\n                        Tạo phiếu trả hàng{' '}\r\n                        <Link href={`/returns/${returnSlip.systemId}`} className=\"font-semibold text-primary hover:underline\">\r\n                            {returnSlip.id}\r\n                        </Link>\r\n                        {transactionLink}\r\n                        {exchangeOrderLink}.\r\n                    </>\r\n                ),\r\n            });\r\n        });\r\n\r\n        if (order.notes && createdAt) {\r\n            pushEntry({\r\n                id: `${order.systemId}-note`,\r\n                action: 'comment_added',\r\n                timestamp: createdAt,\r\n                user: buildUser(order.salespersonSystemId, order.salesperson),\r\n                description: 'Thêm ghi chú đơn hàng',\r\n                content: (\r\n                    <>\r\n                        Ghi chú: <span className=\"italic\">{order.notes}</span>\r\n                    </>\r\n                ),\r\n            });\r\n        }\r\n\r\n        // NOTE: Comments are displayed in separate Comments section, not in history\r\n        \r\n        return entries.sort((a, b) => b.timestamp.getTime() - a.timestamp.getTime());\r\n    }, [order, salesReturnsForOrder, allTransactions, warranties, buildUser, parseTimestamp]);\r\n\r\n    return (\r\n        <ActivityHistory\r\n            history={historyEntries}\r\n            title=\"Lịch sử & Ghi chú\"\r\n            showFilters={false}\r\n            showMetadata={false}\r\n        />\r\n    );\r\n};\r\n\r\nconst ProductInfoCard = ({ order, costOfGoods, profit, totalDiscount, salesReturns, getProductTypeLabel }: { order: Order; costOfGoods: number; profit: number; totalDiscount: number; salesReturns: SalesReturn[]; getProductTypeLabel: (productSystemId: SystemId) => string; }) => {\r\n    // Calculate warranty payments (negative amounts linked to warranty)\r\n    const warrantyPayments = (order?.payments || []).filter(p => p.amount < 0 && (p as any).linkedWarrantySystemId);\r\n    const totalWarrantyDeduction = warrantyPayments.reduce((sum, p) => sum + Math.abs(p.amount), 0);\r\n    \r\n    // Check if any line item has tax\r\n    const hasTax = order.lineItems.some(item => item.tax && item.tax > 0);\r\n    \r\n    // Convert order lineItems to ReadOnlyProductsTable format\r\n    const lineItems = order.lineItems.map(item => {\r\n        // Calculate line total with tax\r\n        const lineGross = item.unitPrice * item.quantity;\r\n        const taxAmount = item.tax ? lineGross * (item.tax / 100) : 0;\r\n        let discountValue = 0;\r\n        if (item.discount && item.discount > 0) {\r\n            discountValue = item.discountType === 'fixed' ? item.discount : (lineGross + taxAmount) * (item.discount / 100);\r\n        }\r\n        const lineTotal = lineGross + taxAmount - discountValue;\r\n        \r\n        return {\r\n            productSystemId: item.productSystemId,\r\n            productId: item.productId,\r\n            productName: item.productName,\r\n            quantity: item.quantity,\r\n            unitPrice: item.unitPrice,\r\n            discount: item.discount,\r\n            discountType: item.discountType,\r\n            tax: item.tax, // Tax rate (%)\r\n            taxId: item.taxId, // Tax systemId\r\n            total: lineTotal,\r\n            note: item.note,\r\n        };\r\n    });\r\n    \r\n    return (\r\n        <Card>\r\n            <CardHeader>\r\n                <CardTitle className=\"text-h4\">Thông tin sản phẩm</CardTitle>\r\n            </CardHeader>\r\n            <CardContent>\r\n                <ReadOnlyProductsTable\r\n                    lineItems={lineItems}\r\n                    showStorageLocation={false}\r\n                    showUnit={false}\r\n                    showDiscount={true}\r\n                    showTax={hasTax}\r\n                />\r\n                <div className=\"flex justify-end mt-4\">\r\n                    <div className=\"w-full max-w-sm space-y-2 text-body-sm\">\r\n                        <div className=\"flex justify-between\"><span className=\"text-muted-foreground\">Tổng tiền ({order.lineItems.length} sản phẩm)</span> <span>{formatCurrency(order.subtotal)}</span></div>\r\n                        <div className=\"flex justify-between\"><span className=\"text-muted-foreground\">Giá vốn</span> <span>{formatCurrency(costOfGoods)}</span></div>\r\n                        <div className=\"flex justify-between font-semibold\"><span>Lợi nhuận tạm tính</span> <span>{formatCurrency(profit)}</span></div>\r\n                        <Separator className=\"!my-2\" />\r\n                        <div className=\"flex justify-between\"><span className=\"text-muted-foreground\">Chiết khấu</span> <span>{formatCurrency(-totalDiscount)}</span></div>\r\n                        {hasTax && order.tax > 0 && (\r\n                            <div className=\"flex justify-between\"><span className=\"text-muted-foreground\">Thuế (VAT)</span> <span>{formatCurrency(order.tax)}</span></div>\r\n                        )}\r\n                        <div className=\"flex justify-between\"><span className=\"text-muted-foreground\">Phí giao hàng</span> <span>{formatCurrency(order.shippingFee)}</span></div>\r\n                        <div className=\"flex justify-between\"><span className=\"text-muted-foreground\">Mã giảm giá</span> <span>{formatCurrency(0)}</span></div>\r\n                        {/* ✅ Show linked sales return value if this is an exchange order */}\r\n                        {order.linkedSalesReturnValue && order.linkedSalesReturnValue > 0 && (\r\n                            <div className=\"flex justify-between\">\r\n                                <span className=\"text-muted-foreground\">\r\n                                    Giá trị trả hàng {order.linkedSalesReturnSystemId && (\r\n                                        <Link href={`/returns/${order.linkedSalesReturnSystemId}`} className=\"text-primary hover:underline\">\r\n                                            ({salesReturns.find(r => r.systemId === order.linkedSalesReturnSystemId)?.id || 'N/A'})\r\n                                        </Link>\r\n                                    )}\r\n                                </span>\r\n                                <span className=\"text-red-600\">{formatCurrency(-(order.linkedSalesReturnValue ?? 0))}</span>\r\n                            </div>\r\n                        )}\r\n                        {totalWarrantyDeduction > 0 && (\r\n                            <div className=\"flex justify-between\">\r\n                                <span className=\"text-muted-foreground\">\r\n                                    Trừ tiền bảo hành\r\n                                    {warrantyPayments.map((payment, idx) => (\r\n                                        <React.Fragment key={payment.systemId}>\r\n                                            {idx === 0 && ' ('}\r\n                                            <Link \r\n                                                href={`/payments/${payment.systemId}`} \r\n                                                className=\"text-primary hover:underline font-medium\"\r\n                                                onClick={(e) => e.stopPropagation()}\r\n                                            >\r\n                                                {payment.id}\r\n                                            </Link>\r\n                                            {idx < warrantyPayments.length - 1 ? ', ' : ')'}\r\n                                        </React.Fragment>\r\n                                    ))}:\r\n                                </span>\r\n                                <span className=\"text-red-600\">{formatCurrency(-totalWarrantyDeduction)}</span>\r\n                            </div>\r\n                        )}\r\n                        <Separator className=\"!my-2\" />\r\n                        <div className=\"flex justify-between font-bold text-h4\"><span>Khách phải trả</span> <span>{formatCurrency(order.grandTotal)}</span></div>\r\n                    </div>\r\n                </div>\r\n            </CardContent>\r\n        </Card>\r\n    )\r\n}\r\n\r\nconst getFinancialResolutionText = (returnSlip: SalesReturn, allTransactions: (Receipt | Payment)[]) => {\r\n    const transactionSystemId = returnSlip.paymentVoucherSystemId || returnSlip.receiptVoucherSystemIds?.[0];\r\n    const transaction = transactionSystemId ? allTransactions.find(t => t.systemId === transactionSystemId) : null;\r\n    const transactionLink = transaction ? (\r\n      <Link href={`/${returnSlip.paymentVoucherSystemId ? 'payments' : 'receipts'}/${transaction.systemId}`} onClick={(e) => e.stopPropagation()} className=\"ml-1 font-medium text-primary hover:underline\">({transaction.id})</Link>\r\n    ) : null;\r\n\r\n    if (returnSlip.finalAmount < 0) {\r\n        return <>{`Hoàn tiền ${formatCurrency(Math.abs(returnSlip.finalAmount))} (${returnSlip.refundMethod})`} {transactionLink}</>;\r\n    }\r\n    if (returnSlip.finalAmount > 0) {\r\n        return <>{`Khách trả thêm ${formatCurrency(returnSlip.finalAmount)}`} {transactionLink}</>;\r\n    }\r\n    if (returnSlip.totalReturnValue > 0 && returnSlip.grandTotalNew === 0) {\r\n        return `Cấn trừ công nợ: ${formatCurrency(returnSlip.totalReturnValue)}`;\r\n    }\r\n    if (returnSlip.totalReturnValue > 0 && returnSlip.finalAmount === 0) {\r\n        return `Đổi ngang giá`;\r\n    }\r\n    return 'Không thay đổi tài chính';\r\n};\r\n\r\nconst ReturnHistoryTab = ({ order, salesReturnsForOrder, getProductTypeLabel, onPreview }: { \r\n    order: Order, \r\n    salesReturnsForOrder: SalesReturn[],\r\n    getProductTypeLabel?: (productSystemId: string) => string,\r\n    onPreview?: (image: string, title: string) => void \r\n}) => {\r\n    const [expandedReturnId, setExpandedReturnId] = React.useState<string | null>(null);\r\n    const [expandedCombos, setExpandedCombos] = React.useState<Record<string, boolean>>({});\r\n    const { data: orders } = useAllOrders();\r\n    const { data: allProducts } = useAllProducts();\r\n    const { findById: findBranchById } = useBranchFinder();\r\n    const { data: storeInfo } = useStoreInfo();\r\n    const { print } = usePrint(order.branchSystemId);\r\n    const { findById: findCustomerById } = useCustomerFinder();\r\n\r\n    const toggleComboRow = React.useCallback((key: string) => {\r\n        setExpandedCombos(prev => ({ ...prev, [key]: !prev[key] }));\r\n    }, []);\r\n\r\n    const handlePrintReturn = React.useCallback((e: React.MouseEvent, salesReturn: SalesReturn) => {\r\n        e.stopPropagation();\r\n        if (!salesReturn) return;\r\n\r\n        const branch = findBranchById(salesReturn.branchSystemId);\r\n        const customer = findCustomerById(salesReturn.customerSystemId);\r\n        const storeSettings: StoreSettings = {\r\n            name: storeInfo?.brandName || storeInfo?.companyName,\r\n            address: storeInfo?.headquartersAddress,\r\n            phone: storeInfo?.hotline,\r\n            email: storeInfo?.email,\r\n            province: storeInfo?.province,\r\n        };\r\n\r\n        const printData: SalesReturnForPrint = {\r\n            code: salesReturn.id,\r\n            orderCode: salesReturn.orderId,\r\n            createdAt: salesReturn.returnDate,\r\n            createdBy: salesReturn.creatorName,\r\n            \r\n            // Customer\r\n            customerName: salesReturn.customerName,\r\n            customerPhone: customer?.phone,\r\n            shippingAddress: customer?.addresses?.[0] ? \r\n                [customer.addresses[0].street, customer.addresses[0].ward, customer.addresses[0].district, customer.addresses[0].province].filter(Boolean).join(', ') \r\n                : undefined,\r\n            \r\n            // Branch\r\n            location: branch ? {\r\n                name: branch.name,\r\n                address: branch.address,\r\n                province: branch.province\r\n            } : undefined,\r\n\r\n            // Items (Exchange items - kept for reference in mapper)\r\n            items: salesReturn.exchangeItems.map(item => ({\r\n                productName: item.productName,\r\n                quantity: item.quantity,\r\n                price: item.unitPrice,\r\n                amount: item.quantity * item.unitPrice,\r\n                unit: 'Cái', // Default\r\n            })),\r\n            \r\n            returnItems: salesReturn.items.map(item => ({\r\n                productName: item.productName,\r\n                quantity: item.returnQuantity,\r\n                price: item.unitPrice,\r\n                amount: item.totalValue,\r\n                unit: 'Cái', // Default\r\n            })),\r\n            \r\n            // Totals\r\n            total: salesReturn.grandTotalNew, // Tổng giá trị hàng đổi\r\n            returnTotalAmount: salesReturn.totalReturnValue, // Tổng giá trị hàng trả\r\n            totalAmount: Math.abs(salesReturn.finalAmount), // Số tiền chênh lệch\r\n            \r\n            note: salesReturn.note,\r\n        };\r\n\r\n        const mappedData = mapSalesReturnToPrintData(printData, storeSettings);\r\n        \r\n        // Inject missing fields based on user feedback/template\r\n        mappedData['{reason_return}'] = salesReturn.reason || '';\r\n        mappedData['{reason}'] = salesReturn.reason || '';\r\n        mappedData['{note}'] = salesReturn.note || '';\r\n        \r\n        // Calculate refund status\r\n        let refundStatus = 'Chưa hoàn tiền';\r\n        const totalRefunded = (salesReturn.refunds || []).reduce((sum, r) => sum + (r.amount || 0), 0) || salesReturn.refundAmount || 0;\r\n        const totalPaid = (salesReturn.payments || []).reduce((sum, p) => sum + (p.amount || 0), 0);\r\n        \r\n        if (salesReturn.finalAmount < 0) { // Company needs to refund\r\n             if (totalRefunded >= Math.abs(salesReturn.finalAmount)) {\r\n                 refundStatus = 'Đã hoàn tiền';\r\n             } else if (totalRefunded > 0) {\r\n                 refundStatus = 'Hoàn tiền một phần';\r\n             }\r\n        } else if (salesReturn.finalAmount > 0) { // Customer needs to pay\r\n             if (totalPaid >= salesReturn.finalAmount) {\r\n                 refundStatus = 'Đã thanh toán';\r\n             } else if (totalPaid > 0) {\r\n                 refundStatus = 'Thanh toán một phần';\r\n             } else {\r\n                 refundStatus = 'Chưa thanh toán';\r\n             }\r\n        } else {\r\n            refundStatus = 'Đã hoàn thành';\r\n        }\r\n        mappedData['refund_status'] = refundStatus;\r\n\r\n        // Map return items for the main table (since template shows \"SL Trả\")\r\n        const lineItems = salesReturn.items.map((item, index) => ({\r\n            '{line_stt}': (index + 1).toString(),\r\n            '{line_product_name}': item.productName,\r\n            '{line_variant_code}': item.productId, // Map SKU/ID to variant code\r\n            '{line_variant}': '', // Variant name not available in return items, leave empty to remove placeholder\r\n            '{line_unit}': 'Cái',\r\n            '{line_quantity}': item.returnQuantity.toString(),\r\n            '{line_price}': formatCurrency(item.unitPrice),\r\n            '{line_total}': formatCurrency(item.totalValue), // Matches {line_total} in screenshot\r\n            '{line_amount}': formatCurrency(item.totalValue), // Standard fallback\r\n        }));\r\n\r\n        print('sales-return', {\r\n            data: mappedData,\r\n            lineItems: lineItems\r\n        });\r\n    }, [findBranchById, storeInfo, print, findCustomerById]);\r\n\r\n    return (\r\n        <Card>\r\n            <CardContent className=\"p-0\">\r\n                <Table>\r\n                    <TableHeader>\r\n                        <TableRow>\r\n                            <TableHead className=\"w-12\"></TableHead>\r\n                            <TableHead>Mã đơn trả hàng</TableHead>\r\n                            <TableHead>Trạng thái</TableHead>\r\n                            <TableHead>Ngày trả hàng</TableHead>\r\n                            <TableHead className=\"text-center\">Số lượng hàng trả</TableHead>\r\n                            <TableHead className=\"text-right\">Giá trị hàng trả</TableHead>\r\n                            <TableHead>Mã đơn đổi</TableHead>\r\n                            <TableHead className=\"text-center\">Số lượng hàng đổi</TableHead>\r\n                            <TableHead className=\"text-right\">Giá trị hàng đổi</TableHead>\r\n                            <TableHead className=\"text-right\">Chênh lệch</TableHead>\r\n                            <TableHead className=\"w-10\"></TableHead>\r\n                        </TableRow>\r\n                    </TableHeader>\r\n                    <TableBody>\r\n                        {salesReturnsForOrder.map(returnSlip => {\r\n                            const isExpanded = expandedReturnId === returnSlip.systemId;\r\n                            const totalReturnQty = returnSlip.items.reduce((sum, item) => sum + item.returnQuantity, 0);\r\n                            const totalExchangeQty = returnSlip.exchangeItems?.reduce((sum, item) => sum + item.quantity, 0) || 0;\r\n                            const exchangeOrder = returnSlip.exchangeOrderSystemId ? orders.find(o => o.systemId === returnSlip.exchangeOrderSystemId) : null;\r\n\r\n                            return (\r\n                                <React.Fragment key={returnSlip.systemId}>\r\n                                    <TableRow onClick={() => setExpandedReturnId(isExpanded ? null : returnSlip.systemId)} className=\"cursor-pointer hover:bg-muted/50\">\r\n                                        <TableCell>\r\n                                            <Button variant=\"ghost\" size=\"icon\" className=\"h-8 w-8\">\r\n                                                {isExpanded ? <ChevronDown className=\"h-4 w-4\" /> : <ChevronRight className=\"h-4 w-4\" />}\r\n                                            </Button>\r\n                                        </TableCell>\r\n                                        <TableCell>\r\n                                            <Link \r\n                                                href={`/returns/${returnSlip.systemId}`} \r\n                                                onClick={e => e.stopPropagation()} \r\n                                                className=\"font-medium text-primary hover:underline\"\r\n                                            >\r\n                                                {returnSlip.id}\r\n                                            </Link>\r\n                                        </TableCell>\r\n                                        <TableCell>\r\n                                            <span className={`inline-flex items-center px-2.5 py-0.5 rounded-full text-body-xs font-medium ${\r\n                                                returnSlip.isReceived \r\n                                                    ? 'bg-green-100 text-green-800' \r\n                                                    : 'bg-amber-100 text-amber-800'\r\n                                            }`}>\r\n                                                {returnSlip.isReceived ? 'Đã nhận' : 'Chưa nhận'}\r\n                                            </span>\r\n                                        </TableCell>\r\n                                        <TableCell>{formatDate(returnSlip.returnDate)}</TableCell>\r\n                                        <TableCell className=\"text-center\">{totalReturnQty}</TableCell>\r\n                                        <TableCell className=\"text-right font-medium\">{formatCurrency(returnSlip.totalReturnValue)}</TableCell>\r\n                                        <TableCell>\r\n                                            {exchangeOrder ? (\r\n                                                <Link \r\n                                                    href={`/orders/${exchangeOrder.systemId}`} \r\n                                                    onClick={e => e.stopPropagation()} \r\n                                                    className=\"text-primary hover:underline\"\r\n                                                >\r\n                                                    {exchangeOrder.id}\r\n                                                </Link>\r\n                                            ) : (\r\n                                                <span className=\"text-muted-foreground\">-</span>\r\n                                            )}\r\n                                        </TableCell>\r\n                                        <TableCell className=\"text-center\">\r\n                                            {totalExchangeQty > 0 ? totalExchangeQty : <span className=\"text-muted-foreground\">-</span>}\r\n                                        </TableCell>\r\n                                        <TableCell className=\"text-right font-medium\">\r\n                                            {returnSlip.grandTotalNew > 0 ? formatCurrency(returnSlip.grandTotalNew) : <span className=\"text-muted-foreground\">-</span>}\r\n                                        </TableCell>\r\n                                        <TableCell className=\"text-right font-semibold\">\r\n                                            {(() => {\r\n                                                // Tính số tiền thực tế đã hoàn/thu\r\n                                                const totalRefunded = (returnSlip.refunds || []).reduce((sum, r) => sum + (r.amount || 0), 0) || returnSlip.refundAmount || 0;\r\n                                                const totalPaid = (returnSlip.payments || []).reduce((sum, p) => sum + (p.amount || 0), 0);\r\n                                                const actualAmount = totalPaid - totalRefunded;\r\n                                                \r\n                                                // Nếu không có hoàn tiền và không có thanh toán → hiển thị dấu \"-\"\r\n                                                if (totalRefunded === 0 && totalPaid === 0) {\r\n                                                    return <span className=\"text-muted-foreground\">-</span>;\r\n                                                }\r\n                                                \r\n                                                // Có hoàn tiền → hiển thị số âm (màu xanh)\r\n                                                if (totalRefunded > 0) {\r\n                                                    return <span className=\"text-green-600\">-{formatCurrency(totalRefunded)}</span>;\r\n                                                }\r\n                                                \r\n                                                // Có thanh toán từ khách → hiển thị số dương (màu vàng)\r\n                                                if (totalPaid > 0) {\r\n                                                    return <span className=\"text-amber-600\">{formatCurrency(totalPaid)}</span>;\r\n                                                }\r\n                                                \r\n                                                return <span className=\"text-muted-foreground\">-</span>;\r\n                                            })()}\r\n                                        </TableCell>\r\n                                        <TableCell>\r\n                                            <Button \r\n                                                variant=\"ghost\" \r\n                                                size=\"icon\" \r\n                                                className=\"h-8 w-8\"\r\n                                                onClick={(e) => handlePrintReturn(e, returnSlip)}\r\n                                                title=\"In phiếu trả hàng\"\r\n                                            >\r\n                                                <Printer className=\"h-4 w-4\" />\r\n                                            </Button>\r\n                                        </TableCell>\r\n                                    </TableRow>\r\n                                    {isExpanded && (\r\n                                        <TableRow className=\"bg-muted/50 hover:bg-muted/50\">\r\n                                            <TableCell colSpan={11} className=\"p-4\">\r\n                                                <div className=\"space-y-4\">\r\n                                                    <div>\r\n                                                        <h4 className=\"font-semibold mb-2\">Chi tiết hàng trả</h4>\r\n                                                        <div className=\"border rounded-md bg-background\">\r\n                                                            <Table>\r\n                                                                <TableHeader>\r\n                                                                    <TableRow>\r\n                                                                        <TableHead className=\"w-12\">STT</TableHead>\r\n                                                                        <TableHead className=\"w-16 text-center\">Ảnh</TableHead>\r\n                                                                        <TableHead>Tên sản phẩm</TableHead>\r\n                                                                        <TableHead className=\"text-center\">Số lượng</TableHead>\r\n                                                                        <TableHead className=\"text-right\">Đơn giá trả</TableHead>\r\n                                                                        <TableHead className=\"text-right\">Thành tiền</TableHead>\r\n                                                                    </TableRow>\r\n                                                                </TableHeader>\r\n                                                                <TableBody>\r\n                                                                    {returnSlip.items.map((item: any, index: number) => {\r\n                                                                        const product = allProducts.find((p: any) => p.systemId === item.productSystemId);\r\n                                                                        const productType = getProductTypeLabel?.(item.productSystemId) || '---';\r\n                                                                        const isCombo = product?.type === 'combo';\r\n                                                                        const comboKey = `return-${returnSlip.systemId}-${item.productSystemId}`;\r\n                                                                        const isComboExpanded = expandedCombos[comboKey] ?? false;\r\n                                                                        const comboChildren = isCombo && product?.comboItems ? product.comboItems : [];\r\n                                                                        \r\n                                                                        return (\r\n                                                                            <React.Fragment key={item.productSystemId}>\r\n                                                                                <TableRow>\r\n                                                                                    <TableCell className=\"text-center text-muted-foreground\">\r\n                                                                                        <div className=\"flex items-center justify-center gap-1\">\r\n                                                                                            {isCombo && (\r\n                                                                                                <Button\r\n                                                                                                    type=\"button\"\r\n                                                                                                    variant=\"ghost\"\r\n                                                                                                    size=\"icon\"\r\n                                                                                                    className=\"h-6 w-6 p-0\"\r\n                                                                                                    onClick={(e) => {\r\n                                                                                                        e.stopPropagation();\r\n                                                                                                        toggleComboRow(comboKey);\r\n                                                                                                    }}\r\n                                                                                                >\r\n                                                                                                    {isComboExpanded ? (\r\n                                                                                                        <ChevronDown className=\"h-4 w-4 text-muted-foreground\" />\r\n                                                                                                    ) : (\r\n                                                                                                        <ChevronRight className=\"h-4 w-4 text-muted-foreground\" />\r\n                                                                                                    )}\r\n                                                                                                </Button>\r\n                                                                                            )}\r\n                                                                                            <span>{index + 1}</span>\r\n                                                                                        </div>\r\n                                                                                    </TableCell>\r\n                                                                                    <TableCell>\r\n                                                                                        <ProductThumbnailCell \r\n                                                                                            productSystemId={item.productSystemId} \r\n                                                                                            product={product}\r\n                                                                                            productName={item.productName} \r\n                                                                                            size=\"sm\"\r\n                                                                                            onPreview={onPreview}\r\n                                                                                        />\r\n                                                                                    </TableCell>\r\n                                                                                    <TableCell>\r\n                                                                                        <div className=\"flex flex-col gap-0.5\">\r\n                                                                                            <div className=\"flex items-center gap-2\">\r\n                                                                                                <Link \r\n                                                                                                    href={`/products/${item.productSystemId}`}\r\n                                                                                                    className=\"font-medium text-primary hover:underline\"\r\n                                                                                                >\r\n                                                                                                    {item.productName}\r\n                                                                                                </Link>\r\n                                                                                                {isCombo && (\r\n                                                                                                    <span className=\"text-[10px] px-1.5 py-0.5 rounded bg-secondary text-secondary-foreground font-semibold\">\r\n                                                                                                        COMBO\r\n                                                                                                    </span>\r\n                                                                                                )}n                                                                                            </div>\r\n                                                                                            <div className=\"flex items-center gap-1 text-body-xs text-muted-foreground flex-wrap\">\r\n                                                                                                <span>{productType}</span>\r\n                                                                                                <span>-</span>\r\n                                                                                                <Link \r\n                                                                                                    href={`/products/${item.productSystemId}`}\r\n                                                                                                    className=\"text-primary hover:underline\"\r\n                                                                                                >\r\n                                                                                                    {item.productId}\r\n                                                                                                </Link>\r\n                                                                                                {item.note && (\r\n                                                                                                    <>\r\n                                                                                                        <StickyNote className=\"h-3 w-3 text-amber-600 ml-1\" />\r\n                                                                                                        <span className=\"text-amber-600 italic\">{item.note}</span>\r\n                                                                                                    </>\r\n                                                                                                )}\r\n                                                                                            </div>\r\n                                                                                        </div>\r\n                                                                                    </TableCell>\r\n                                                                                    <TableCell className=\"text-center\">{item.returnQuantity}</TableCell>\r\n                                                                                    <TableCell className=\"text-right\">{formatCurrency(item.unitPrice)}</TableCell>\r\n                                                                                    <TableCell className=\"text-right font-medium\">{formatCurrency(item.totalValue)}</TableCell>\r\n                                                                                </TableRow>\r\n                                                                                {/* Combo children rows */}\r\n                                                                                {isCombo && isComboExpanded && comboChildren.map((comboItem: any, childIndex: number) => {\r\n                                                                                    const childProduct = allProducts.find((p: any) => p.systemId === comboItem.productSystemId);\r\n                                                                                    return (\r\n                                                                                        <TableRow key={`${comboKey}-child-${childIndex}`} className=\"bg-muted/40\">\r\n                                                                                            <TableCell className=\"text-center text-muted-foreground pl-8\">\r\n                                                                                                <span className=\"text-muted-foreground/60\">└</span>\r\n                                                                                            </TableCell>\r\n                                                                                            <TableCell>\r\n                                                                                                <ProductThumbnailCell \r\n                                                                                                    productSystemId={comboItem.productSystemId}\r\n                                                                                                    product={childProduct}\r\n                                                                                                    productName={childProduct?.name || comboItem.productName || 'Sản phẩm'}\r\n                                                                                                    size=\"sm\"\r\n                                                                                                    onPreview={onPreview}\r\n                                                                                                />\r\n                                                                                            </TableCell>\r\n                                                                                            <TableCell>\r\n                                                                                                <div className=\"flex flex-col gap-0.5\">\r\n                                                                                                    <span className=\"font-medium text-foreground\">\r\n                                                                                                        {childProduct?.name || 'Sản phẩm không tồn tại'}\r\n                                                                                                    </span>\r\n                                                                                                    {childProduct && (\r\n                                                                                                        <Link\r\n                                                                                                            href={`/products/${childProduct.systemId}`}\r\n                                                                                                            className=\"text-body-xs text-primary hover:underline\"\r\n                                                                                                        >\r\n                                                                                                            {childProduct.id}\r\n                                                                                                        </Link>\r\n                                                                                                    )}\r\n                                                                                                </div>\r\n                                                                                            </TableCell>\r\n                                                                                            <TableCell className=\"text-center text-muted-foreground\">\r\n                                                                                                x{comboItem.quantity * item.returnQuantity}\r\n                                                                                            </TableCell>\r\n                                                                                            <TableCell className=\"text-right text-muted-foreground\">-</TableCell>\r\n                                                                                            <TableCell className=\"text-right text-muted-foreground\">-</TableCell>\r\n                                                                                        </TableRow>\r\n                                                                                    );\r\n                                                                                })}\r\n                                                                            </React.Fragment>\r\n                                                                        );\r\n                                                                    })}\r\n                                                                </TableBody>\r\n                                                                <TableFooter>\r\n                                                                    <TableRow>\r\n                                                                        <TableCell colSpan={5} className=\"text-right font-semibold\">Tổng cộng</TableCell>\r\n                                                                        <TableCell className=\"text-right font-bold\">{formatCurrency(returnSlip.totalReturnValue)}</TableCell>\r\n                                                                    </TableRow>\r\n                                                                </TableFooter>\r\n                                                            </Table>\r\n                                                        </div>\r\n                                                    </div>\r\n                                                    \r\n                                                    {returnSlip.exchangeItems && returnSlip.exchangeItems.length > 0 && (\r\n                                                        <div>\r\n                                                            <h4 className=\"font-semibold mb-2\">Chi tiết hàng đổi</h4>\r\n                                                            <div className=\"border rounded-md bg-background\">\r\n                                                                <Table>\r\n                                                                    <TableHeader>\r\n                                                                        <TableRow>\r\n                                                                            <TableHead className=\"w-12\">STT</TableHead>\r\n                                                                            <TableHead className=\"w-16 text-center\">Ảnh</TableHead>\r\n                                                                            <TableHead>Tên sản phẩm</TableHead>\r\n                                                                            <TableHead className=\"text-center\">Số lượng</TableHead>\r\n                                                                            <TableHead className=\"text-right\">Đơn giá</TableHead>\r\n                                                                            <TableHead className=\"text-right\">Thành tiền</TableHead>\r\n                                                                        </TableRow>\r\n                                                                    </TableHeader>\r\n                                                                    <TableBody>\r\n                                                                        {returnSlip.exchangeItems.map((item: any, index: number) => {\r\n                                                                            const lineTotal = item.quantity * item.unitPrice - (item.discountType === 'percentage' ? (item.quantity * item.unitPrice * item.discount / 100) : item.discount);\r\n                                                                            const product = allProducts.find((p: any) => p.systemId === item.productSystemId);\r\n                                                                            const productType = getProductTypeLabel?.(item.productSystemId) || '---';\r\n                                                                            const isCombo = product?.type === 'combo';\r\n                                                                            const comboKey = `exchange-${returnSlip.systemId}-${item.productSystemId}`;\r\n                                                                            const isComboExpanded = expandedCombos[comboKey] ?? false;\r\n                                                                            const comboChildren = isCombo && product?.comboItems ? product.comboItems : [];\r\n                                                                            \r\n                                                                            return (\r\n                                                                                <React.Fragment key={item.productSystemId}>\r\n                                                                                    <TableRow>\r\n                                                                                        <TableCell className=\"text-center text-muted-foreground\">\r\n                                                                                            <div className=\"flex items-center justify-center gap-1\">\r\n                                                                                                {isCombo && (\r\n                                                                                                    <Button\r\n                                                                                                        type=\"button\"\r\n                                                                                                        variant=\"ghost\"\r\n                                                                                                        size=\"icon\"\r\n                                                                                                        className=\"h-6 w-6 p-0\"\r\n                                                                                                        onClick={(e) => {\r\n                                                                                                            e.stopPropagation();\r\n                                                                                                            toggleComboRow(comboKey);\r\n                                                                                                        }}\r\n                                                                                                    >\r\n                                                                                                        {isComboExpanded ? (\r\n                                                                                                            <ChevronDown className=\"h-4 w-4 text-muted-foreground\" />\r\n                                                                                                        ) : (\r\n                                                                                                            <ChevronRight className=\"h-4 w-4 text-muted-foreground\" />\r\n                                                                                                        )}\r\n                                                                                                    </Button>\r\n                                                                                                )}\r\n                                                                                                <span>{index + 1}</span>\r\n                                                                                            </div>\r\n                                                                                        </TableCell>\r\n                                                                                        <TableCell>\r\n                                                                                            <ProductThumbnailCell \r\n                                                                                                productSystemId={item.productSystemId} \r\n                                                                                                product={product}\r\n                                                                                                productName={item.productName} \r\n                                                                                                size=\"sm\"\r\n                                                                                                onPreview={onPreview}\r\n                                                                                            />\r\n                                                                                        </TableCell>\r\n                                                                                        <TableCell>\r\n                                                                                            <div className=\"flex flex-col gap-0.5\">\r\n                                                                                                <div className=\"flex items-center gap-2\">\r\n                                                                                                    <Link \r\n                                                                                                        href={`/products/${item.productSystemId}`}\r\n                                                                                                        className=\"font-medium text-primary hover:underline\"\r\n                                                                                                    >\r\n                                                                                                        {item.productName}\r\n                                                                                                    </Link>\r\n                                                                                                    {isCombo && (\r\n                                                                                                        <span className=\"text-[10px] px-1.5 py-0.5 rounded bg-secondary text-secondary-foreground font-semibold\">\r\n                                                                                                            COMBO\r\n                                                                                                        </span>\r\n                                                                                                    )}\r\n                                                                                                </div>\r\n                                                                                                <div className=\"flex items-center gap-1 text-body-xs text-muted-foreground flex-wrap\">\r\n                                                                                                    <span>{productType}</span>\r\n                                                                                                    <span>-</span>\r\n                                                                                                    <Link \r\n                                                                                                        href={`/products/${item.productSystemId}`}\r\n                                                                                                        className=\"text-primary hover:underline\"\r\n                                                                                                    >\r\n                                                                                                        {item.productId}\r\n                                                                                                    </Link>\r\n                                                                                                    {item.note && (\r\n                                                                                                        <>\r\n                                                                                                            <StickyNote className=\"h-3 w-3 text-amber-600 ml-1\" />\r\n                                                                                                            <span className=\"text-amber-600 italic\">{item.note}</span>\r\n                                                                                                        </>\r\n                                                                                                    )}\r\n                                                                                                </div>\r\n                                                                                            </div>\r\n                                                                                        </TableCell>\r\n                                                                                        <TableCell className=\"text-center\">{item.quantity}</TableCell>\r\n                                                                                        <TableCell className=\"text-right\">{formatCurrency(item.unitPrice)}</TableCell>\r\n                                                                                        <TableCell className=\"text-right font-medium\">{formatCurrency(lineTotal)}</TableCell>\r\n                                                                                    </TableRow>\r\n                                                                                    {/* Combo children rows */}\r\n                                                                                    {isCombo && isComboExpanded && comboChildren.map((comboItem: any, childIndex: number) => {\r\n                                                                                        const childProduct = allProducts.find((p: any) => p.systemId === comboItem.productSystemId);\r\n                                                                                        return (\r\n                                                                                            <TableRow key={`${comboKey}-child-${childIndex}`} className=\"bg-muted/40\">\r\n                                                                                                <TableCell className=\"text-center text-muted-foreground pl-8\">\r\n                                                                                                    <span className=\"text-muted-foreground/60\">└</span>\r\n                                                                                                </TableCell>\r\n                                                                                                <TableCell>\r\n                                                                                                    <ProductThumbnailCell \r\n                                                                                                        productSystemId={comboItem.productSystemId}\r\n                                                                                                        product={childProduct}\r\n                                                                                                        productName={childProduct?.name || comboItem.productName || 'Sản phẩm'}\r\n                                                                                                        size=\"sm\"\r\n                                                                                                        onPreview={onPreview}\r\n                                                                                                    />\r\n                                                                                                </TableCell>\r\n                                                                                                <TableCell>\r\n                                                                                                    <div className=\"flex flex-col gap-0.5\">\r\n                                                                                                        <span className=\"font-medium text-foreground\">\r\n                                                                                                            {childProduct?.name || 'Sản phẩm không tồn tại'}\r\n                                                                                                        </span>\r\n                                                                                                        {childProduct && (\r\n                                                                                                            <Link\r\n                                                                                                                href={`/products/${childProduct.systemId}`}\r\n                                                                                                                className=\"text-body-xs text-primary hover:underline\"\r\n                                                                                                            >\r\n                                                                                                                {childProduct.id}\r\n                                                                                                            </Link>\r\n                                                                                                        )}\r\n                                                                                                    </div>\r\n                                                                                                </TableCell>\r\n                                                                                                <TableCell className=\"text-center text-muted-foreground\">\r\n                                                                                                    x{comboItem.quantity * item.quantity}\r\n                                                                                                </TableCell>\r\n                                                                                                <TableCell className=\"text-right text-muted-foreground\">-</TableCell>\r\n                                                                                                <TableCell className=\"text-right text-muted-foreground\">-</TableCell>\r\n                                                                                            </TableRow>\r\n                                                                                        );\r\n                                                                                    })}\r\n                                                                                </React.Fragment>\r\n                                                                            );\r\n                                                                        })}\r\n                                                                    </TableBody>\r\n                                                                    <TableFooter>\r\n                                                                        <TableRow>\r\n                                                                            <TableCell colSpan={5} className=\"text-right font-semibold\">Tổng cộng</TableCell>\r\n                                                                            <TableCell className=\"text-right font-bold\">{formatCurrency(returnSlip.grandTotalNew)}</TableCell>\r\n                                                                        </TableRow>\r\n                                                                    </TableFooter>\r\n                                                                </Table>\r\n                                                            </div>\r\n                                                        </div>\r\n                                                    )}\r\n                                                </div>\r\n                                            </TableCell>\r\n                                        </TableRow>\r\n                                    )}\r\n                                </React.Fragment>\r\n                            )\r\n                        })}\r\n                    </TableBody>\r\n                </Table>\r\n            </CardContent>\r\n        </Card>\r\n    )\r\n};\r\n\r\n\r\nexport function OrderDetailPage() {\r\n    const params = useParams<{ systemId?: string; id?: string }>();\r\n    const router = useRouter();\r\n\r\n    // React Query hooks for data fetching\r\n    const { data: orders = [] } = useAllOrders();\r\n    const { findById: findOrderById, findByBusinessId: findOrderByBusinessId } = useOrderFinder();\r\n    const { update: updateOrder } = useOrderMutations();\r\n    const orderActions = useOrderActions();\r\n    \r\n    // ⚠️ Zustand store for complex order action methods - to be migrated to APIs\r\n    const orderStore = useOrderStore();\r\n    const { \r\n        cancelOrder, addPayment, requestPackaging, confirmPackaging, cancelPackagingRequest, \r\n        processInStorePickup, confirmPartnerShipment, dispatchFromWarehouse, completeDelivery, \r\n        failDelivery, cancelDelivery, cancelDeliveryOnly, confirmInStorePickup, cancelGHTKShipment \r\n    } = orderStore;\r\n    \r\n    const order = React.useMemo(() => {\r\n        if (params.systemId) {\r\n            const systemIdParam = asSystemId(params.systemId);\r\n            const bySystemId = findOrderById(systemIdParam);\r\n            if (bySystemId) {\r\n                return bySystemId;\r\n            }\r\n        }\r\n\r\n        if (params.id) {\r\n            return findOrderByBusinessId(params.id) ?? null;\r\n        }\r\n\r\n        return null;\r\n    }, [findOrderById, findOrderByBusinessId, params.id, params.systemId]);\r\n\r\n    console.log('🔍 [OrderDetail] lookup param:', params.systemId || params.id, 'foundOrder:', !!order, order ? { systemId: order.systemId, id: order.id } : null);\r\n    const { findById: findProductById } = useProductFinder();\r\n    const { findById: findProductTypeById } = useProductTypeFinder();\r\n    const { data: allSalesReturns } = useAllSalesReturns();\r\n    const { data: pricingPolicies } = useAllPricingPolicies();\r\n    const defaultPricingPolicy = React.useMemo(\r\n        () => (pricingPolicies ?? []).find(policy => policy.type === 'Bán hàng' && policy.isDefault),\r\n        [pricingPolicies]\r\n    );\r\n    const { data: warranties } = useAllWarranties();\r\n    const { data: allReceipts } = useAllReceipts();\r\n    const { data: allPayments } = useAllPayments();\r\n    const { data: complaints } = useAllComplaints();\r\n    const slaEngine = useCustomerSlaEvaluation();\r\n    const { data: branches } = useAllBranches();\r\n    const { findById: findBranchById } = useBranchFinder();\r\n    const { data: storeInfo } = useStoreInfo();\r\n    const { print } = usePrint();\r\n    \r\n    const { data: customers } = useAllCustomers();\r\n    const customer = order ? customers.find(c => c.systemId === order.customerSystemId) : null;\r\n    const orderBranch = order ? findBranchById?.(order.branchSystemId) : null;\r\n    const { employee: authEmployee } = useAuth();\r\n    const currentEmployeeSystemId: SystemId = authEmployee?.systemId ?? asSystemId('SYSTEM');\r\n    const [isCopying, setIsCopying] = React.useState(false);\r\n\r\n    // State for image preview in ReturnHistoryTab\r\n    const [returnHistoryPreviewState, setReturnHistoryPreviewState] = React.useState<{ open: boolean; image: string; title: string }>({\r\n        open: false,\r\n        image: '',\r\n        title: ''\r\n    });\r\n    const handlePreview = React.useCallback((image: string, title: string) => {\r\n        setReturnHistoryPreviewState({ open: true, image, title });\r\n    }, []);\r\n\r\n    const customerOrders = React.useMemo(() => {\r\n        if (!customer) return [];\r\n        return orders.filter(o => o.customerSystemId === customer.systemId);\r\n    }, [customer?.systemId, orders]);\r\n    // Orders that create debt: status='Hoàn thành' OR deliveryStatus='Đã giao hàng' OR stockOutStatus='Xuất kho toàn bộ'\r\n    const deliveredCustomerOrders = React.useMemo(\r\n        () => customerOrders.filter(o => \r\n            o.status !== 'Đã hủy' &&\r\n            (o.status === 'Hoàn thành' || \r\n             o.deliveryStatus === 'Đã giao hàng' || \r\n             o.stockOutStatus === 'Xuất kho toàn bộ')\r\n        ),\r\n        [customerOrders]\r\n    );\r\n\r\n    const customerOrderStats = React.useMemo(() => {\r\n        if (!customer) {\r\n            return {\r\n                totalSpent: order?.grandTotal || 0,\r\n                totalOrders: order ? 1 : 0,\r\n                lastOrderDate: order?.orderDate ?? null,\r\n            };\r\n        }\r\n\r\n        if (!customerOrders.length) {\r\n            return {\r\n                totalSpent: customer.totalSpent ?? 0,\r\n                totalOrders: customer.totalOrders ?? 0,\r\n                lastOrderDate: customer.lastPurchaseDate ?? order?.orderDate ?? null,\r\n            };\r\n        }\r\n\r\n        let totalSpent = 0;\r\n        let lastOrderDate: string | null = null;\r\n\r\n        deliveredCustomerOrders.forEach(o => {\r\n            totalSpent += o.grandTotal || 0;\r\n        });\r\n\r\n        const recencySource = deliveredCustomerOrders.length ? deliveredCustomerOrders : customerOrders;\r\n\r\n        recencySource.forEach(o => {\r\n            if (!lastOrderDate || new Date(o.orderDate).getTime() > new Date(lastOrderDate).getTime()) {\r\n                lastOrderDate = o.orderDate;\r\n            }\r\n        });\r\n\r\n        return {\r\n            totalSpent,\r\n            totalOrders: customerOrders.length,\r\n            lastOrderDate: lastOrderDate ?? customer.lastPurchaseDate ?? order?.orderDate ?? null,\r\n        };\r\n    }, [customer, customerOrders, deliveredCustomerOrders, order?.grandTotal, order?.orderDate]);\r\n\r\n    const customerDebtBalance = React.useMemo(() => {\r\n        if (!customer) return 0;\r\n\r\n        const transactions: Array<{ date: string; change: number }> = [];\r\n\r\n        deliveredCustomerOrders.forEach(o => {\r\n            // ✅ Use grandTotal (không trừ paidAmount) vì phiếu thu đã được tính riêng\r\n            transactions.push({ date: o.orderDate, change: o.grandTotal || 0 });\r\n        });\r\n\r\n        allReceipts\r\n            .filter(r => r.payerTypeName === 'Khách hàng' && r.payerName === customer.name)\r\n            .forEach(receipt => {\r\n                transactions.push({ date: receipt.date, change: -receipt.amount });\r\n            });\r\n\r\n        allPayments\r\n            .filter(p => p.recipientTypeName === 'Khách hàng' && p.recipientName === customer.name)\r\n            .forEach(payment => {\r\n                transactions.push({ date: payment.date, change: payment.amount });\r\n            });\r\n\r\n        if (!transactions.length) {\r\n            return customer.currentDebt ?? 0;\r\n        }\r\n\r\n        transactions.sort((a, b) => new Date(a.date).getTime() - new Date(b.date).getTime());\r\n\r\n        let balance = 0;\r\n        transactions.forEach(entry => {\r\n            balance += entry.change;\r\n        });\r\n\r\n        return balance;\r\n    }, [customer, deliveredCustomerOrders, allReceipts, allPayments]);\r\n\r\n    const customerWarranties = React.useMemo(() => {\r\n        if (!customer) return [];\r\n        return warranties.filter(ticket => ticket.customerPhone === customer.phone);\r\n    }, [customer?.phone, warranties]);\r\n\r\n    const customerWarrantyCount = customerWarranties.length;\r\n\r\n    const activeWarrantyCount = React.useMemo(() => {\r\n        return customerWarranties.filter(ticket => !['returned', 'completed', 'cancelled'].includes(ticket.status)).length;\r\n    }, [customerWarranties]);\r\n\r\n    const customerComplaints = React.useMemo(() => {\r\n        if (!customer) return [];\r\n        return complaints.filter(complaint => complaint.customerSystemId === customer.systemId);\r\n    }, [customer?.systemId, complaints]);\r\n\r\n    const customerComplaintCount = customerComplaints.length;\r\n\r\n    const activeComplaintCount = React.useMemo(() => {\r\n        return customerComplaints.filter(complaint => complaint.status === 'pending' || complaint.status === 'investigating').length;\r\n    }, [customerComplaints]);\r\n\r\n    const slaDisplay = React.useMemo(() => {\r\n        if (!customer) {\r\n            return {\r\n                title: 'Đúng hạn',\r\n                detail: 'Chưa có dữ liệu SLA',\r\n                tone: 'secondary' as const,\r\n            };\r\n        }\r\n\r\n        const entry = slaEngine.index?.entries?.[customer.systemId];\r\n        const alerts = entry?.alerts ?? [];\r\n        if (!alerts.length) {\r\n            return {\r\n                title: 'Đúng hạn',\r\n                detail: 'Không có cảnh báo',\r\n                tone: 'success' as const,\r\n            };\r\n        }\r\n\r\n        const sortedAlerts = [...alerts].sort((a, b) => new Date(a.targetDate).getTime() - new Date(b.targetDate).getTime());\r\n        const nextAlert = sortedAlerts[0];\r\n        const remaining = nextAlert.daysRemaining;\r\n        const timeText = remaining === 0\r\n            ? 'Hôm nay'\r\n            : remaining > 0\r\n                ? `Còn ${remaining} ngày`\r\n                : `Trễ ${Math.abs(remaining)} ngày`;\r\n        const tone = remaining < 0\r\n            ? 'destructive'\r\n            : nextAlert.alertLevel === 'warning'\r\n                ? 'warning'\r\n                : 'secondary';\r\n\r\n        return {\r\n            title: nextAlert.slaName,\r\n            detail: `${timeText}${nextAlert.targetDate ? ` • hạn ${formatDate(nextAlert.targetDate)}` : ''}`,\r\n            tone,\r\n        } as const;\r\n    }, [customer, slaEngine.index]);\r\n\r\n    // Order breakdown by status\r\n    const orderBreakdown = React.useMemo(() => {\r\n        const pending = customerOrders.filter(o => o.status === 'Đặt hàng').length;\r\n        const inProgress = customerOrders.filter(o => o.status === 'Đang giao dịch').length;\r\n        const completed = customerOrders.filter(o => o.status === 'Hoàn thành').length;\r\n        const cancelled = customerOrders.filter(o => o.status === 'Đã hủy').length;\r\n        return { pending, inProgress, completed, cancelled };\r\n    }, [customerOrders]);\r\n\r\n    const customerMetrics = React.useMemo(() => {\r\n        const lastOrderDate = customerOrderStats.lastOrderDate;\r\n        return [\r\n            {\r\n                key: 'orders',\r\n                label: 'Tổng số đơn đặt',\r\n                value: formatNumber(customerOrderStats.totalOrders),\r\n                subValue: `${orderBreakdown.pending} đặt hàng, ${orderBreakdown.inProgress} đang giao dịch, ${orderBreakdown.completed} hoàn thành, ${orderBreakdown.cancelled} đã hủy`,\r\n            },\r\n            {\r\n                key: 'warranty',\r\n                label: 'Tổng số lần bảo hành',\r\n                value: formatNumber(customerWarrantyCount),\r\n                badge: activeWarrantyCount > 0 ? { label: `${activeWarrantyCount} chưa trả`, tone: 'warning' as const } : undefined,\r\n                link: customer ? `/warranty?customer=${encodeURIComponent(customer.systemId)}` : undefined,\r\n            },\r\n            {\r\n                key: 'complaints',\r\n                label: 'Tổng số lần khiếu nại',\r\n                value: formatNumber(customerComplaintCount),\r\n                badge: activeComplaintCount > 0 ? { label: `${activeComplaintCount} chưa xử lý`, tone: 'destructive' as const } : undefined,\r\n                link: customer ? `/complaints?customer=${encodeURIComponent(customer.systemId)}` : undefined,\r\n            },\r\n            {\r\n                key: 'last-order',\r\n                label: 'Lần đặt đơn gần nhất',\r\n                value: lastOrderDate ? formatDate(lastOrderDate) : '---',\r\n            },\r\n            {\r\n                key: 'failed-delivery',\r\n                label: 'Giao hàng thất bại',\r\n                value: formatNumber(customer?.failedDeliveries ?? 0),\r\n            },\r\n            {\r\n                key: 'sla',\r\n                label: 'SLA',\r\n                value: slaDisplay.title,\r\n                subValue: slaDisplay.detail,\r\n                tone: slaDisplay.tone,\r\n            },\r\n        ];\r\n    }, [customerOrderStats.totalOrders, customerOrderStats.lastOrderDate, customer, orderBreakdown, customerWarrantyCount, customerComplaintCount, activeWarrantyCount, activeComplaintCount, slaDisplay]);\r\n\r\n    const handleCopyOrder = React.useCallback(() => {\r\n        if (!order || isCopying) {\r\n            return;\r\n        }\r\n\r\n        setIsCopying(true);\r\n        try {\r\n            router.push(`/orders/new?copy=${order.systemId}`);\r\n        } finally {\r\n            // Component will unmount after navigation, but keep defensive reset to be safe when navigation fails\r\n            setTimeout(() => setIsCopying(false), 300);\r\n        }\r\n    }, [order, isCopying, router]);\r\n\r\n    // Customer Settings - React Query hooks\r\n    const { findById: findCustomerTypeById } = useCustomerTypeFinder();\r\n    const { findById: findCustomerGroupById } = useCustomerGroupFinder();\r\n    const { findById: findCustomerSourceById } = useCustomerSourceFinder();\r\n    const { findById: findEmployeeById } = useEmployeeFinder();\r\n\r\n    // Branding for print\r\n    const { logoUrl } = useBranding();\r\n\r\n    const getTypeName = (id?: string) => id ? findCustomerTypeById(id)?.name : undefined;\r\n    const getGroupName = (id?: string) => id ? findCustomerGroupById(id)?.name : undefined;\r\n    const getSourceName = (id?: string) => id ? findCustomerSourceById(id)?.name : undefined;\r\n    const getEmployeeName = (id?: string) => id ? findEmployeeById(asSystemId(id))?.fullName : undefined;\r\n\r\n    // Get salesperson employee for print\r\n    const salespersonEmployee = React.useMemo(() => {\r\n        if (!order?.salespersonSystemId) return null;\r\n        return findEmployeeById(asSystemId(order.salespersonSystemId));\r\n    }, [order?.salespersonSystemId, findEmployeeById]);\r\n\r\n    const [isCancelAlertOpen, setIsCancelAlertOpen] = React.useState(false);\r\n    const [cancelReasonText, setCancelReasonText] = React.useState('');\r\n    const [restockItems, setRestockItems] = React.useState(true);\r\n    const [isPaymentDialogOpen, setIsPaymentDialogOpen] = React.useState(false);\r\n    const [isCreateShipmentDialogOpen, setIsCreateShipmentDialogOpen] = React.useState(false);\r\n    const [isPackerSelectionOpen, setIsPackerSelectionOpen] = React.useState(false);\r\n    const [cancelPackagingState, setCancelPackagingState] = React.useState<{ packagingSystemId: SystemId } | null>(null);\r\n    const [cancelShipmentState, setCancelShipmentState] = React.useState<{ packagingSystemId: SystemId; type: 'fail' | 'cancel' } | null>(null);\r\n    const [hasOrderWorkflowTemplate, setHasOrderWorkflowTemplate] = React.useState(true);\r\n\r\n    React.useEffect(() => {\r\n        if (typeof window === 'undefined') return;\r\n        try {\r\n            const templates = getWorkflowTemplates();\r\n            const orderTemplates = templates.filter(t => t.name === 'orders');\r\n            setHasOrderWorkflowTemplate(orderTemplates.length > 0);\r\n        } catch (error) {\r\n            console.error('[OrderDetail] Failed to load workflow templates', error);\r\n            setHasOrderWorkflowTemplate(true);\r\n        }\r\n    }, []);\r\n\r\n    const resetCancelForm = React.useCallback(() => {\r\n        setCancelReasonText('');\r\n        setRestockItems(true);\r\n    }, []);\r\n\r\n    React.useEffect(() => {\r\n        if (!isCancelAlertOpen) {\r\n            resetCancelForm();\r\n        }\r\n    }, [isCancelAlertOpen, resetCancelForm]);\r\n\r\n    const salesReturnsForOrder = React.useMemo(() => {\r\n        if (!order) return [];\r\n        return allSalesReturns.filter(sr => sr.orderSystemId === order.systemId);\r\n    }, [order, allSalesReturns]);\r\n    \r\n    const totalReturnedValue = React.useMemo(() => \r\n        salesReturnsForOrder.reduce((sum, sr) => sum + sr.totalReturnValue, 0),\r\n    [salesReturnsForOrder]);\r\n\r\n    // Tính tổng số tiền đã hoàn cho khách từ các phiếu trả hàng\r\n    const totalRefundedFromReturns = React.useMemo(() => \r\n        salesReturnsForOrder.reduce((sum, sr) => {\r\n            const refundFromArray = (sr.refunds || []).reduce((s, r) => s + (r.amount || 0), 0);\r\n            return sum + (refundFromArray || sr.refundAmount || 0);\r\n        }, 0),\r\n    [salesReturnsForOrder]);\r\n\r\n    // Lấy các phiếu chi hoàn tiền liên quan đến đơn hàng này (từ sales returns)\r\n    const refundPaymentsForOrder = React.useMemo(() => {\r\n        if (!order) return [];\r\n        return allPayments.filter(p => \r\n            p.status !== 'cancelled' &&\r\n            (p.linkedOrderSystemId === order.systemId || \r\n             salesReturnsForOrder.some(sr => sr.paymentVoucherSystemIds?.includes(p.systemId)))\r\n        );\r\n    }, [order, allPayments, salesReturnsForOrder]);\r\n\r\n    const totalPaid = React.useMemo(() => (order?.payments || []).reduce((sum, p) => sum + p.amount, 0), [order?.payments]);\r\n    // totalPaid: số tiền khách đã thanh toán\r\n    // totalRefundedFromReturns: số tiền đã hoàn lại cho khách (từ sales returns)\r\n    // netGrandTotal: công nợ thực tế sau khi trừ hàng trả\r\n    // amountRemaining = netGrandTotal - totalPaid + totalRefundedFromReturns\r\n    const netGrandTotal = Math.max(0, (order?.grandTotal || 0) - totalReturnedValue);\r\n    const amountRemaining = netGrandTotal - totalPaid + totalRefundedFromReturns;\r\n\r\n    const totalLineQuantity = React.useMemo(() => {\r\n        if (!order) return 0;\r\n        return order.lineItems.reduce((sum, item) => sum + item.quantity, 0);\r\n    }, [order]);\r\n\r\n    const codPayments = React.useMemo(() => (order?.payments || []).filter(p => p.method === 'Đối soát COD'), [order?.payments]);\r\n    const directPayments = React.useMemo(() => (order?.payments || []).filter(p => p.method !== 'Đối soát COD'), [order?.payments]);\r\n\r\n    const totalActiveCod = React.useMemo(() => {\r\n        if (!order?.packagings) return 0;\r\n    \r\n        return order.packagings.reduce((sum, pkg) => {\r\n            const activeCodStatuses: OrderDeliveryStatus[] = ['Chờ lấy hàng', 'Đang giao hàng', 'Đã giao hàng'];\r\n            if (pkg.status !== 'Hủy đóng gói' && pkg.reconciliationStatus !== 'Đã đối soát' && pkg.deliveryStatus && activeCodStatuses.includes(pkg.deliveryStatus)) {\r\n                return sum + (pkg.codAmount || 0);\r\n            }\r\n            return sum;\r\n        }, 0);\r\n    }, [order]);\r\n    \r\n    const totalCodAmount = totalActiveCod + codPayments.reduce((s, p) => s + p.amount, 0);\r\n    const payableAmount = Math.max(0, amountRemaining);\r\n\r\n    const getProductTypeLabel = React.useCallback((productSystemId: SystemId) => {\r\n        const product = findProductById(productSystemId);\r\n        if (!product) return '---';\r\n\r\n        if (product.productTypeSystemId) {\r\n            const productType = findProductTypeById(product.productTypeSystemId);\r\n            if (productType?.name) {\r\n                return productType.name;\r\n            }\r\n        }\r\n\r\n        if (product.type && productTypeFallbackLabels[product.type]) {\r\n            return productTypeFallbackLabels[product.type];\r\n        }\r\n\r\n        return 'Hàng hóa';\r\n    }, [findProductById, findProductTypeById]);\r\n    \r\n    const { costOfGoods, profit, totalDiscount } = React.useMemo(() => {\r\n        if (!order) return { costOfGoods: 0, profit: 0, totalDiscount: 0 };\r\n        const cost = order.lineItems.reduce((sum, item) => {\r\n            const product = findProductById(item.productSystemId);\r\n            return sum + ((product?.costPrice || 0) * item.quantity);\r\n        }, 0);\r\n        const discount = order.lineItems.reduce((sum, item) => {\r\n            const lineGross = item.unitPrice * item.quantity;\r\n            const discountAmount = item.discountType === 'percentage' ? lineGross * (item.discount / 100) : item.discount;\r\n            return sum + (discountAmount * item.quantity);\r\n        }, 0);\r\n        const profit = order.subtotal - cost;\r\n        return { costOfGoods: cost, profit: profit, totalDiscount: discount };\r\n    }, [order, findProductById]);\r\n    \r\n    const isActionable = order?.status !== 'Hoàn thành' && order?.status !== 'Đã hủy';\r\n\r\n    const activePackaging = React.useMemo(() => {\r\n        if (!order || !order.packagings || order.packagings.length === 0) {\r\n            return null;\r\n        }\r\n        return [...order.packagings].reverse().find(p => p.status !== 'Hủy đóng gói') || null;\r\n    }, [order]);\r\n\r\n    const existingPackerSystemId = React.useMemo<SystemId | undefined>(() => {\r\n        if (!order) {\r\n            return undefined;\r\n        }\r\n\r\n        const explicitPacker = order.assignedPackerSystemId || (order as any).assignedPackerSystemId || (order as any).packerId;\r\n        if (explicitPacker) {\r\n            return asSystemId(explicitPacker);\r\n        }\r\n\r\n        if (activePackaging?.assignedEmployeeId) {\r\n            return activePackaging.assignedEmployeeId;\r\n        }\r\n\r\n        const fallbackPackaging = [...(order.packagings ?? [])]\r\n            .reverse()\r\n            .find(pkg => pkg.assignedEmployeeId);\r\n\r\n        return fallbackPackaging?.assignedEmployeeId;\r\n    }, [order, activePackaging]);\r\n\r\n    // Auto-sync GHTK status on page load\r\n    const [isSyncing, setIsSyncing] = React.useState(false);\r\n    React.useEffect(() => {\r\n        if (!order) return;\r\n        \r\n        const ghtkPackagings = order.packagings.filter(\r\n            p => p.carrier === 'GHTK' && p.trackingCode\r\n        );\r\n        \r\n        if (ghtkPackagings.length === 0) return;\r\n        \r\n        setIsSyncing(true);\r\n        \r\n        // Dynamically import to avoid circular dependencies\r\n        import('../../lib/ghtk-sync-service').then(({ ghtkSyncService }) => {\r\n            ghtkSyncService.syncOrder(order.systemId)\r\n                .catch(error => {\r\n                    console.error('[Order Detail] GHTK sync failed:', error);\r\n                })\r\n                .finally(() => {\r\n                    setIsSyncing(false);\r\n                });\r\n        });\r\n    }, [order?.systemId]);\r\n\r\n    const handleConfirmCancel = async () => { \r\n        if (!order) return;\r\n        const finalReason = cancelReasonText.trim();\r\n        if (!finalReason) {\r\n            toast.error('Vui lòng nhập lý do hủy đơn hàng.');\r\n            return;\r\n        }\r\n        const cancelOptions = {\r\n            reason: finalReason,\r\n            restock: restockItems,\r\n        };\r\n        \r\n        // Check if order has active GHTK shipment that needs to be cancelled\r\n        const ghtkPackaging = order.packagings.find(p => \r\n            p.carrier === 'GHTK' && \r\n            p.trackingCode && \r\n            p.status !== 'Hủy đóng gói' &&\r\n            p.deliveryStatus !== 'Đã giao hàng' &&\r\n            p.deliveryStatus !== 'Đã hủy'\r\n        );\r\n        \r\n        if (ghtkPackaging && ghtkPackaging.trackingCode) {\r\n            try {\r\n                console.log('[Cancel Order] Attempting to cancel GHTK shipment first:', ghtkPackaging.trackingCode);\r\n                const { cancelGHTKShipment } = useOrderStore.getState();\r\n                const result = await cancelGHTKShipment(\r\n                    order.systemId, \r\n                    ghtkPackaging.systemId, \r\n                    ghtkPackaging.trackingCode\r\n                );\r\n                \r\n                if (!result.success) {\r\n                    // GHTK cancel failed, show toast with action to continue\r\n                    toast.error(\r\n                        `Không thể hủy vận đơn GHTK: ${result.message}`,\r\n                        {\r\n                            description: 'Bạn có muốn tiếp tục hủy đơn hàng không?',\r\n                            action: {\r\n                                label: 'Tiếp tục',\r\n                                onClick: () => {\r\n                                    cancelOrder(order.systemId, currentEmployeeSystemId, cancelOptions);\r\n                                    resetCancelForm();\r\n                                    setIsCancelAlertOpen(false);\r\n                                }\r\n                            },\r\n                            cancel: {\r\n                                label: 'Hủy bỏ',\r\n                                onClick: () => {\r\n                                    setIsCancelAlertOpen(false);\r\n                                }\r\n                            }\r\n                        }\r\n                    );\r\n                    return;\r\n                }\r\n            } catch (error: any) {\r\n                console.error('[Cancel Order] GHTK cancel error:', error);\r\n                toast.error(\r\n                    `Lỗi khi hủy vận đơn GHTK: ${error.message}`,\r\n                    {\r\n                        description: 'Bạn có muốn tiếp tục hủy đơn hàng không?',\r\n                        action: {\r\n                            label: 'Tiếp tục',\r\n                            onClick: () => {\r\n                                cancelOrder(order.systemId, currentEmployeeSystemId, cancelOptions);\r\n                                resetCancelForm();\r\n                                setIsCancelAlertOpen(false);\r\n                            }\r\n                        },\r\n                        cancel: {\r\n                            label: 'Hủy bỏ',\r\n                            onClick: () => {\r\n                                setIsCancelAlertOpen(false);\r\n                            }\r\n                        }\r\n                    }\r\n                );\r\n                return;\r\n            }\r\n        }\r\n        \r\n        // Proceed with order cancellation\r\n        cancelOrder(order.systemId, currentEmployeeSystemId, cancelOptions); \r\n        resetCancelForm();\r\n        setIsCancelAlertOpen(false); \r\n    };\r\n    const handleAddPayment = (paymentData: PaymentFormValues) => { if (order) { addPayment(order.systemId, paymentData, currentEmployeeSystemId); setIsPaymentDialogOpen(false); } };\r\n    const handleRequestPackaging = React.useCallback((assignedEmployeeId?: SystemId) => {\r\n        if (order) {\r\n            requestPackaging(order.systemId, currentEmployeeSystemId, assignedEmployeeId);\r\n        }\r\n    }, [order, requestPackaging, currentEmployeeSystemId]);\r\n    const handleConfirmPackaging = (packagingSystemId: SystemId) => { if (order) { confirmPackaging(order.systemId, packagingSystemId, currentEmployeeSystemId); } };\r\n    const handleCancelPackagingSubmit = (reason: string) => { if (order && cancelPackagingState) { cancelPackagingRequest(order.systemId, cancelPackagingState.packagingSystemId, currentEmployeeSystemId, reason); setCancelPackagingState(null); }};\r\n    const handleInStorePickup = (packagingSystemId: SystemId) => { if (order) { processInStorePickup(order.systemId, packagingSystemId); } };\r\n    const handleShippingSubmit = (data: any) => { if (order && activePackaging) { return confirmPartnerShipment(order.systemId, activePackaging.systemId, data); } return Promise.resolve({success: false, message: 'Đơn hàng không hợp lệ'}); };\r\n    \r\n    const handleDispatch = (packagingSystemId: SystemId) => { \r\n        if (order) { \r\n            const pkg = order.packagings.find(p => p.systemId === packagingSystemId);\r\n            if (pkg?.deliveryMethod === 'Nhận tại cửa hàng') {\r\n                confirmInStorePickup(order.systemId, packagingSystemId, currentEmployeeSystemId);\r\n            } else {\r\n                dispatchFromWarehouse(order.systemId, packagingSystemId, currentEmployeeSystemId); \r\n            }\r\n        } \r\n    };\r\n\r\n    const handleCompleteDelivery = (packagingSystemId: SystemId) => { if (order) { completeDelivery(order.systemId, packagingSystemId, currentEmployeeSystemId); }};\r\n    const handleFailDeliverySubmit = (reason: string) => { if (order && cancelShipmentState) { failDelivery(order.systemId, cancelShipmentState.packagingSystemId, currentEmployeeSystemId, reason); setCancelShipmentState(null); }};\r\n    \r\n    // ✅ Hủy giao hàng - KHÔNG trả hàng về kho (hàng bị thất tung/shipper giữ)\r\n    const handleCancelDeliveryOnly = async () => { \r\n        if (order && cancelShipmentState) { \r\n            const packaging = order.packagings.find(p => p.systemId === cancelShipmentState.packagingSystemId);\r\n            const trackingCode = packaging?.trackingCode;\r\n            \r\n            // Nếu có tracking code GHTK, gọi API hủy trước\r\n            if (trackingCode && trackingCode.startsWith('S')) {\r\n                try {\r\n                    const result = await cancelGHTKShipment(order.systemId, cancelShipmentState.packagingSystemId, trackingCode);\r\n                    \r\n                    if (!result.success) {\r\n                        toast.error(`⚠️ Không thể hủy vận đơn GHTK: ${result.message}\\n\\nVui lòng hủy trên hệ thống đối tác.`);\r\n                        setCancelShipmentState(null);\r\n                        return;\r\n                    }\r\n                } catch (error: any) {\r\n                    toast.error(`⚠️ Lỗi khi hủy vận đơn GHTK: ${error.message || 'Không rõ lỗi'}\\n\\nVui lòng hủy trên hệ thống đối tác.`);\r\n                    setCancelShipmentState(null);\r\n                    return;\r\n                }\r\n            }\r\n            \r\n            // ✅ Chỉ update trạng thái, KHÔNG trả hàng về kho\r\n            cancelDeliveryOnly(order.systemId, cancelShipmentState.packagingSystemId, currentEmployeeSystemId, \"Hủy giao hàng\"); \r\n            setCancelShipmentState(null); \r\n        }\r\n    };\r\n    \r\n    // ✅ Hủy giao và nhận lại hàng - TRẢ hàng về kho (đã nhận lại từ shipper)\r\n    const handleCancelDeliveryAndRestock = async () => { \r\n        if (order && cancelShipmentState) { \r\n            const packaging = order.packagings.find(p => p.systemId === cancelShipmentState.packagingSystemId);\r\n            const trackingCode = packaging?.trackingCode;\r\n            \r\n            // Nếu có tracking code GHTK, gọi API hủy trước\r\n            if (trackingCode && trackingCode.startsWith('S')) {\r\n                try {\r\n                    const result = await cancelGHTKShipment(order.systemId, cancelShipmentState.packagingSystemId, trackingCode);\r\n                    \r\n                    if (!result.success) {\r\n                        toast.error(`⚠️ Không thể hủy vận đơn GHTK: ${result.message}\\n\\nVui lòng hủy trên hệ thống đối tác.`);\r\n                        setCancelShipmentState(null);\r\n                        return;\r\n                    }\r\n                } catch (error: any) {\r\n                    toast.error(`⚠️ Lỗi khi hủy vận đơn GHTK: ${error.message || 'Không rõ lỗi'}\\n\\nVui lòng hủy trên hệ thống đối tác.`);\r\n                    setCancelShipmentState(null);\r\n                    return;\r\n                }\r\n            }\r\n            \r\n            // ✅ Update trạng thái + TRẢ hàng về kho\r\n            cancelDelivery(order.systemId, cancelShipmentState.packagingSystemId, currentEmployeeSystemId, \"Hủy giao và nhận lại hàng\"); \r\n            setCancelShipmentState(null); \r\n        }\r\n    };\r\n    \r\n    const handleCancelGHTKShipment = async (packagingSystemId: SystemId, trackingCode: string) => {\r\n        if (!order) return;\r\n        \r\n        toast.info('Đang hủy vận đơn GHTK...', { description: 'Lưu ý: Chỉ có thể hủy khi đơn chưa được lấy hàng.' });\r\n        \r\n        try {\r\n            const result = await cancelGHTKShipment(order.systemId, packagingSystemId, trackingCode);\r\n            \r\n            if (result.success) {\r\n                toast.success('Đã hủy vận đơn GHTK thành công!');\r\n            } else {\r\n                toast.error(`Lỗi: ${result.message}`);\r\n            }\r\n        } catch (error: any) {\r\n            toast.error(`Lỗi: ${error.message || 'Không thể hủy vận đơn'}`);\r\n        }\r\n    };\r\n\r\n\r\n    const handleRequestPackagingClick = React.useCallback(() => {\r\n        if (existingPackerSystemId) {\r\n            handleRequestPackaging(existingPackerSystemId);\r\n            return;\r\n        }\r\n        setIsPackerSelectionOpen(true);\r\n    }, [existingPackerSystemId, handleRequestPackaging, setIsPackerSelectionOpen]);\r\n\r\n    const headerActions = React.useMemo(() => {\r\n        if (!order) {\r\n            return [];\r\n        }\r\n\r\n        const canReturn = order.status !== 'Đã hủy' && \r\n            order.returnStatus !== 'Trả hàng toàn bộ' &&\r\n            order.stockOutStatus !== 'Chưa xuất kho';\r\n        \r\n        const canRequestPackaging = isActionable && (!activePackaging || activePackaging.deliveryStatus === 'Chờ giao lại');\r\n        const canConfirmPackaging = activePackaging?.status === 'Chờ đóng gói';\r\n        const canShip = activePackaging?.status === 'Đã đóng gói' && \r\n                        activePackaging?.deliveryStatus === 'Chờ lấy hàng' &&\r\n                        order.stockOutStatus !== 'Chưa xuất kho';\r\n        \r\n        // ✅ Chỉ hiện nút Xuất kho khi đã đóng gói xong VÀ đã chọn hình thức giao hàng (theo yêu cầu user)\r\n        const canStockOut = order.stockOutStatus === 'Chưa xuất kho' && \r\n                            order.status !== 'Đã hủy' && \r\n                            activePackaging?.status === 'Đã đóng gói' &&\r\n                            !!activePackaging?.deliveryMethod;\r\n\r\n        const actions: React.ReactNode[] = [];\r\n\r\n        if (canStockOut) {\r\n            actions.push(\r\n                <Button \r\n                    key=\"stockout\" \r\n                    size=\"sm\" \r\n                    className=\"h-9\" \r\n                    onClick={() => {\r\n                        if (activePackaging) {\r\n                            handleDispatch(activePackaging.systemId);\r\n                        } else {\r\n                            toast.error('Vui lòng tạo yêu cầu đóng gói trước khi xuất kho');\r\n                        }\r\n                    }}\r\n                >\r\n                    Xác nhận xuất kho\r\n                </Button>\r\n            );\r\n        }\r\n\r\n        if (canRequestPackaging) {\r\n            actions.push(\r\n                <Button key=\"request-packaging\" size=\"sm\" className=\"h-9\" onClick={handleRequestPackagingClick}>\r\n                    Yêu cầu đóng gói\r\n                </Button>\r\n            );\r\n        }\r\n\r\n        if (canConfirmPackaging) {\r\n            actions.push(\r\n                <Button \r\n                    key=\"confirm-packaging\" \r\n                    size=\"sm\" \r\n                    className=\"h-9\" \r\n                    onClick={() => {\r\n                        if (activePackaging) {\r\n                            handleConfirmPackaging(activePackaging.systemId);\r\n                        } else {\r\n                            toast.error('Không tìm thấy gói hàng cần đóng gói');\r\n                        }\r\n                    }}\r\n                >\r\n                    Xác nhận đóng gói\r\n                </Button>\r\n            );\r\n        }\r\n\r\n        if (canShip) {\r\n            actions.push(\r\n                <Button \r\n                    key=\"ship\" \r\n                    size=\"sm\" \r\n                    className=\"h-9\" \r\n                    onClick={() => {\r\n                        if (activePackaging) {\r\n                            handleDispatch(activePackaging.systemId);\r\n                        } else {\r\n                            toast.error('Không tìm thấy gói hàng để giao');\r\n                        }\r\n                    }}\r\n                >\r\n                    Giao hàng\r\n                </Button>\r\n            );\r\n        }\r\n\r\n        if (canReturn) {\r\n            actions.push(\r\n                <Button\r\n                    key=\"return\"\r\n                    variant=\"outline\"\r\n                    size=\"sm\"\r\n                    className=\"h-9\"\r\n                    onClick={() => router.push(`/orders/${order.systemId}/return`)}\r\n                >\r\n                    Hoàn trả hàng\r\n                </Button>\r\n            );\r\n        }\r\n\r\n        // Cho phép hủy đơn nếu:\r\n        // - Chưa hủy\r\n        // - Chưa có phiếu trả hàng (nếu đã trả hàng thì không được hủy vì sẽ gây rối stock và công nợ)\r\n        const canCancelOrder = order.status !== 'Đã hủy' && \r\n            (!order.returnStatus || order.returnStatus === 'Chưa trả hàng');\r\n        \r\n        if (canCancelOrder) {\r\n            actions.push(\r\n                <Button\r\n                    key=\"cancel\"\r\n                    variant=\"outline\"\r\n                    size=\"sm\"\r\n                    className=\"h-9 border-destructive text-destructive hover:bg-destructive hover:text-destructive-foreground\"\r\n                    onClick={() => setIsCancelAlertOpen(true)}\r\n                >\r\n                    Hủy đơn hàng\r\n                </Button>\r\n            );\r\n        }\r\n\r\n        if (order.status !== 'Đã hủy') {\r\n            actions.push(\r\n                <Button\r\n                    key=\"edit\"\r\n                    variant=\"outline\"\r\n                    size=\"sm\"\r\n                    className=\"h-9\"\r\n                    onClick={() => router.push(`/orders/${order.systemId}/edit`)}\r\n                >\r\n                    Sửa\r\n                </Button>\r\n            );\r\n        }\r\n\r\n        return actions;\r\n    }, [order, isActionable, router, setIsCancelAlertOpen, activePackaging, handleRequestPackagingClick]);\r\n\r\n    const displayStatus = React.useMemo(() => {\r\n        if (!order) return undefined;\r\n        // Fix for existing orders that are stuck in 'Đặt hàng' but have been dispatched\r\n        if (order.status === 'Đặt hàng' && (order.stockOutStatus === 'Xuất kho toàn bộ' || order.deliveryStatus === 'Đang giao hàng' || order.deliveryStatus === 'Đã giao hàng')) {\r\n            return 'Đang giao dịch';\r\n        }\r\n        return order.status;\r\n    }, [order]);\r\n\r\n    const headerBadge = React.useMemo(() => {\r\n        if (!order || !displayStatus) {\r\n            return undefined;\r\n        }\r\n        return (\r\n            <div className=\"flex items-center gap-2\">\r\n                <OrderPrintButton\r\n                    order={order}\r\n                    customer={customer}\r\n                    branch={orderBranch}\r\n                    createdByEmployee={salespersonEmployee}\r\n                    logoUrl={getFullLogoUrl(logoUrl)}\r\n                />\r\n                <Button\r\n                    variant=\"outline\"\r\n                    size=\"sm\"\r\n                    className=\"h-7\"\r\n                    onClick={handleCopyOrder}\r\n                    disabled={isCopying}\r\n                >\r\n                    {isCopying ? (\r\n                        <Spinner className=\"mr-2 h-4 w-4\" />\r\n                    ) : (\r\n                        <Copy className=\"mr-2 h-4 w-4\" />\r\n                    )}\r\n                    Sao chép\r\n                </Button>\r\n                <Badge variant={statusVariants[displayStatus]} className=\"uppercase tracking-wide\">\r\n                    {displayStatus}\r\n                </Badge>\r\n                {order.returnStatus === 'Trả hàng một phần' && (\r\n                    <Badge variant=\"outline\" className=\"border-orange-500 text-orange-600 bg-orange-50\">\r\n                        Trả hàng một phần\r\n                    </Badge>\r\n                )}\r\n                {order.returnStatus === 'Trả hàng toàn bộ' && (\r\n                    <Badge variant=\"outline\" className=\"border-red-500 text-red-600 bg-red-50\">\r\n                        Trả hàng toàn bộ\r\n                    </Badge>\r\n                )}\r\n            </div>\r\n        );\r\n    }, [order, displayStatus, handleCopyOrder, isCopying, customer, orderBranch, salespersonEmployee, logoUrl]);\r\n\r\n    const breadcrumb = React.useMemo(() => ([\r\n        { label: 'Trang chủ', href: '/', isCurrent: false },\r\n        { label: 'Đơn hàng', href: '/orders', isCurrent: false },\r\n        { label: order?.id ? `Đơn ${order.id}` : 'Chi tiết', href: order ? `/orders/${order.systemId}` : '/orders', isCurrent: true },\r\n    ]), [order]);\r\n\r\n    usePageHeader({ \r\n        title: order ? `Đơn hàng ${order.id}` : 'Chi tiết đơn hàng',\r\n        breadcrumb,\r\n        badge: headerBadge,\r\n        actions: headerActions,\r\n    });\r\n\r\n    if (!order) {\r\n        return (\r\n            <div className=\"flex h-full items-center justify-center\">\r\n                <div className=\"text-center\">\r\n                    <h2 className=\"text-2xl font-bold\">Không tìm thấy đơn hàng.</h2>\r\n                    <Button onClick={() => router.push('/orders')} className=\"mt-4\">\r\n                        <ArrowLeft className=\"mr-2 h-4 w-4\" />\r\n                        Quay về danh sách đơn hàng\r\n                    </Button>\r\n                </div>\r\n            </div>\r\n        );\r\n    }\r\n    \r\n    // ✅ Ưu tiên địa chỉ đã lưu trong đơn hàng, fallback về địa chỉ mặc định của khách hàng\r\n    const shippingAddress = formatAddressObject(order.shippingAddress) || (customer ? getCustomerAddress(customer, 'shipping') : '');\r\n    const billingAddress = formatAddressObject(order.billingAddress) || (customer ? getCustomerAddress(customer, 'billing') : '');\r\n    const isBillingSameAsShipping = shippingAddress === billingAddress || !billingAddress;\r\n\r\n\r\n    const renderMainPackagingActionButtons = () => {\r\n        if (!isActionable) return null;\r\n    \r\n        const canRequestPackaging = !activePackaging || activePackaging.deliveryStatus === 'Chờ giao lại';\r\n        \r\n        if (canRequestPackaging) {\r\n            return <Button size=\"sm\" onClick={handleRequestPackagingClick}>Yêu cầu đóng gói</Button>;\r\n        }\r\n        \r\n        return null;\r\n    };\r\n    \r\n    return (\r\n        <>\r\n            <div className=\"space-y-4 md:space-y-6\">\r\n                {/* GHTK Sync Indicator */}\r\n                {isSyncing && (\r\n                    <Card className=\"border-blue-200 bg-blue-50\">\r\n                        <CardContent className=\"p-3\">\r\n                            <div className=\"flex items-center gap-2 text-sm\">\r\n                                <Spinner className=\"h-4 w-4 text-blue-600\" />\r\n                                <span className=\"text-blue-900\">Đang đồng bộ trạng thái vận chuyển GHTK...</span>\r\n                            </div>\r\n                        </CardContent>\r\n                    </Card>\r\n                )}\r\n                \r\n                {/* Status Card - Full width */}\r\n                <Card>\r\n                    <CardContent className=\"p-4\">\r\n                        <StatusStepper order={order} />\r\n                    </CardContent>\r\n                </Card>\r\n\r\n                {/* Row 1: Thông tin khách hàng (40%) + Quy trình xử lý (30%) + Thông tin đơn hàng (30%) */}\r\n                <div className=\"grid grid-cols-1 lg:grid-cols-10 gap-4\">\r\n                    {/* Thông tin khách hàng - 40% width on desktop */}\r\n                    <Card className=\"lg:col-span-4 flex flex-col\">\r\n                        <CardHeader className=\"flex-shrink-0\">\r\n                            <CardTitle className=\"text-base font-semibold\">Thông tin khách hàng</CardTitle>\r\n                        </CardHeader>\r\n                        <CardContent className=\"flex-1\">\r\n                            <div className=\"space-y-3\">\r\n                                {/* Tên và thông tin liên hệ */}\r\n                                <div>\r\n                                    <p className=\"font-semibold text-primary cursor-pointer hover:underline text-lg\" onClick={() => router.push(`/customers/${customer?.systemId}`)}>{order.customerName}</p>\r\n                                    <div className=\"flex flex-wrap gap-x-4 gap-y-1 text-sm text-muted-foreground mt-1\">\r\n                                        {customer?.phone && (\r\n                                            <span className=\"font-medium text-foreground inline-flex items-center gap-1\">\r\n                                                {customer.phone}\r\n                                                <Copy \r\n                                                    className=\"h-3 w-3 cursor-pointer text-muted-foreground hover:text-foreground\" \r\n                                                    onClick={() => { navigator.clipboard.writeText(customer.phone); toast.success('Đã sao chép số điện thoại'); }}\r\n                                                />\r\n                                            </span>\r\n                                        )}\r\n                                        {customer?.email && (\r\n                                            <span className=\"inline-flex items-center gap-1\">\r\n                                                {customer.email}\r\n                                                <Copy \r\n                                                    className=\"h-3 w-3 cursor-pointer text-muted-foreground hover:text-foreground\" \r\n                                                    onClick={() => { navigator.clipboard.writeText(customer.email!); toast.success('Đã sao chép email'); }}\r\n                                                />\r\n                                            </span>\r\n                                        )}\r\n                                        {customer?.taxCode && (\r\n                                            <span className=\"inline-flex items-center gap-1\">\r\n                                                MST: {customer.taxCode}\r\n                                                <Copy \r\n                                                    className=\"h-3 w-3 cursor-pointer text-muted-foreground hover:text-foreground\" \r\n                                                    onClick={() => { navigator.clipboard.writeText(customer.taxCode!); toast.success('Đã sao chép mã số thuế'); }}\r\n                                                />\r\n                                            </span>\r\n                                        )}\r\n                                    </div>\r\n                                </div>\r\n                                \r\n                                {/* Địa chỉ giao hàng - 1 hàng */}\r\n                                <div>\r\n                                    <p className=\"text-xs font-semibold text-muted-foreground uppercase tracking-wider mb-1\">Địa chỉ giao hàng</p>\r\n                                    <div className=\"flex items-start gap-1\">\r\n                                        <p className=\"text-sm flex-1\">{shippingAddress || 'Chưa có thông tin giao hàng'}</p>\r\n                                        {shippingAddress && (\r\n                                            <Copy \r\n                                                className=\"h-3 w-3 cursor-pointer text-muted-foreground hover:text-foreground flex-shrink-0 mt-0.5\" \r\n                                                onClick={() => { navigator.clipboard.writeText(shippingAddress); toast.success('Đã sao chép địa chỉ giao hàng'); }}\r\n                                            />\r\n                                        )}\r\n                                    </div>\r\n                                </div>\r\n                                \r\n                                {/* Địa chỉ nhận hóa đơn - 1 hàng */}\r\n                                <div>\r\n                                    <p className=\"text-xs font-semibold text-muted-foreground uppercase tracking-wider mb-1\">Địa chỉ nhận hóa đơn</p>\r\n                                    <div className=\"flex items-start gap-1\">\r\n                                        <p className=\"text-sm flex-1\">{billingAddress || '-'}</p>\r\n                                        {billingAddress && (\r\n                                            <Copy \r\n                                                className=\"h-3 w-3 cursor-pointer text-muted-foreground hover:text-foreground flex-shrink-0 mt-0.5\" \r\n                                                onClick={() => { navigator.clipboard.writeText(billingAddress); toast.success('Đã sao chép địa chỉ hóa đơn'); }}\r\n                                            />\r\n                                        )}\r\n                                    </div>\r\n                                </div>\r\n                                \r\n                                {/* Tags */}\r\n                                {customer?.tags && customer.tags.length > 0 && (\r\n                                    <div>\r\n                                        <p className=\"text-xs font-semibold text-muted-foreground uppercase tracking-wider mb-1\">Tags</p>\r\n                                        <div className=\"flex flex-wrap gap-1\">\r\n                                            {customer.tags.map((tag, idx) => (\r\n                                                <Badge key={idx} variant=\"outline\" className=\"text-xs font-normal\">{tag}</Badge>\r\n                                            ))}\r\n                                        </div>\r\n                                    </div>\r\n                                )}\r\n                                \r\n                                {/* Thống kê khách hàng */}\r\n                                <div className=\"text-sm space-y-1.5 border-t border-border pt-3\">\r\n                                    <div className=\"flex justify-between\">\r\n                                        <span className=\"text-muted-foreground\">Nhóm KH:</span>\r\n                                        <span className=\"font-medium\">{getGroupName(customer?.customerGroup) || '---'}</span>\r\n                                    </div>\r\n                                    <div className=\"flex justify-between\">\r\n                                        <span className=\"text-muted-foreground\">NV phụ trách:</span>\r\n                                        <span className=\"font-medium\">{getEmployeeName(customer?.accountManagerId) || '---'}</span>\r\n                                    </div>\r\n                                    <div className=\"flex justify-between\">\r\n                                        <span className=\"text-muted-foreground\">Công nợ/Hạn mức:</span>\r\n                                        <div className=\"text-right\">\r\n                                            <Link \r\n                                                href={`/customers/${customer?.systemId}?tab=debt`} \r\n                                                className=\"font-medium text-red-500 hover:underline cursor-pointer\"\r\n                                            >\r\n                                                {formatCurrency(customerDebtBalance)}\r\n                                            </Link>\r\n                                            <span className=\"text-muted-foreground mx-1\">/</span>\r\n                                            <span className=\"font-medium\">{formatCurrency(customer?.maxDebt)}</span>\r\n                                        </div>\r\n                                    </div>\r\n                                    <div className=\"flex justify-between\">\r\n                                        <span className=\"text-muted-foreground\">Tổng chi tiêu:</span>\r\n                                        <span className=\"font-medium\">{formatCurrency(customerOrderStats.totalSpent)}</span>\r\n                                    </div>\r\n                                    <div className=\"border-t border-dashed my-2\" />\r\n                                    {customerMetrics.map(metric => {\r\n                                        const toneClass = metric.tone === 'destructive'\r\n                                            ? 'text-red-600'\r\n                                            : metric.tone === 'warning'\r\n                                                ? 'text-amber-600'\r\n                                                : metric.tone === 'success'\r\n                                                    ? 'text-green-600'\r\n                                                    : 'text-foreground';\r\n                                        const ValueContent = (\r\n                                            <div className=\"flex items-center gap-2 justify-end\">\r\n                                                <span className={cn('font-medium', toneClass, metric.link && 'hover:underline cursor-pointer')}>{metric.value}</span>\r\n                                                {metric.badge && (\r\n                                                    <Badge\r\n                                                        variant=\"secondary\"\r\n                                                        className={cn(\r\n                                                            'text-[11px] uppercase tracking-tight',\r\n                                                            metric.badge.tone === 'destructive'\r\n                                                                ? 'bg-red-100 text-red-700 border-red-200'\r\n                                                                : 'bg-amber-100 text-amber-700 border-amber-200'\r\n                                                        )}\r\n                                                    >\r\n                                                        {metric.badge.label}\r\n                                                    </Badge>\r\n                                                )}\r\n                                            </div>\r\n                                        );\r\n                                        return (\r\n                                            <div key={metric.key} className=\"flex flex-col gap-0.5 sm:flex-row sm:items-center sm:justify-between\">\r\n                                                <span className=\"text-muted-foreground\">{metric.label}:</span>\r\n                                                <div className=\"text-right space-y-0.5\">\r\n                                                    {metric.link ? (\r\n                                                        <Link href={metric.link} className=\"block\">\r\n                                                            {ValueContent}\r\n                                                        </Link>\r\n                                                    ) : (\r\n                                                        ValueContent\r\n                                                    )}\r\n                                                    {metric.subValue && (\r\n                                                        <p className=\"text-xs text-muted-foreground\">{metric.subValue}</p>\r\n                                                    )}\r\n                                                </div>\r\n                                            </div>\r\n                                        );\r\n                                    })}\r\n                                </div>\r\n                            </div>\r\n                        </CardContent>\r\n                    </Card>\r\n\r\n                    {/* Quy trình xử lý - 30% width on desktop */}\r\n                    <div className=\"lg:col-span-3 space-y-3\">\r\n                        {!hasOrderWorkflowTemplate && (\r\n                            <Alert className=\"border-amber-200 bg-amber-50 text-amber-900\">\r\n                                <Info className=\"h-4 w-4 text-amber-600\" />\r\n                                <AlertTitle>Chưa cấu hình quy trình xử lý đơn hàng</AlertTitle>\r\n                                <AlertDescription>\r\n                                    Thiết lập quy trình mặc định tại{' '}\r\n                                    <Link href=\"/settings/workflow-templates\" className=\"font-semibold text-primary underline\">\r\n                                        Cài đặt &gt; Quy trình\r\n                                    </Link>{' '}\r\n                                    để đội vận hành có checklist thống nhất.\r\n                                </AlertDescription>\r\n                            </Alert>\r\n                        )}\r\n                        <OrderWorkflowCard \r\n                            order={order} \r\n                            onUpdateOrder={(systemId, updates) => {\r\n                                orderStore.update(asSystemId(systemId), updates);\r\n                            }} \r\n                        />\r\n                    </div>\r\n\r\n                    {/* Thông tin đơn hàng - 30% width on desktop */}\r\n                    <Card className=\"lg:col-span-3 flex flex-col h-full lg:h-auto\">\r\n                        <CardHeader className=\"flex-shrink-0\">\r\n                            <CardTitle className=\"text-base font-semibold\">Thông tin đơn hàng</CardTitle>\r\n                        </CardHeader>\r\n                        <CardContent className=\"text-sm space-y-3 overflow-y-auto flex-1 max-h-[400px] lg:max-h-none\"\r\n                            style={{ \r\n                                scrollbarWidth: 'thin',\r\n                                scrollbarColor: 'rgb(203 213 225) transparent'\r\n                            }}\r\n                        >\r\n                            <DetailField label=\"Chính sách giá\" value={defaultPricingPolicy?.name || 'Giá bán lẻ'} />\r\n                            <DetailField label=\"Bán tại\" value={order.branchName} />\r\n                            <div className=\"flex\">\r\n                                <span className=\"text-muted-foreground min-w-[140px]\">Bán bởi:</span>\r\n                                <Link href={`/employees/${order.salespersonSystemId}`} className=\"text-primary hover:underline font-medium\">\r\n                                    {order.salesperson}\r\n                                </Link>\r\n                            </div>\r\n                            <DetailField label=\"Hẹn giao hàng\" value={order.expectedDeliveryDate || '---'} />\r\n                            <DetailField label=\"Nguồn\" value={order.source || '---'} />\r\n                            <DetailField label=\"Kênh bán hàng\" value=\"Khác\" />\r\n                            <DetailField label=\"Ngày bán\" value={formatDate(order.orderDate)} />\r\n                            {order.expectedPaymentMethod && (\r\n                                <DetailField label=\"Hình thức thanh toán\" value={order.expectedPaymentMethod} />\r\n                            )}\r\n                            {order.referenceUrl && (\r\n                                <div>\r\n                                    <span className=\"text-muted-foreground\">Link đơn hàng:</span>{' '}\r\n                                    <a href={order.referenceUrl} target=\"_blank\" rel=\"noopener noreferrer\" className=\"text-blue-600 hover:underline\">\r\n                                        {order.referenceUrl}\r\n                                    </a>\r\n                                </div>\r\n                            )}\r\n                            {order.externalReference && (\r\n                                <DetailField label=\"Mã tham chiếu\" value={order.externalReference} />\r\n                            )}\r\n                            {order.tags && order.tags.length > 0 && (\r\n                                <div>\r\n                                    <span className=\"text-muted-foreground\">Tags:</span>{' '}\r\n                                    <div className=\"flex flex-wrap gap-1 mt-1\">\r\n                                        {order.tags.map((tag, idx) => (\r\n                                            <Badge key={idx} variant=\"secondary\" className=\"text-xs\">{tag}</Badge>\r\n                                        ))}\r\n                                    </div>\r\n                                </div>\r\n                            )}\r\n                            {order.serviceFees && order.serviceFees.length > 0 && (\r\n                                <div>\r\n                                    <span className=\"text-muted-foreground\">Phí dịch vụ:</span>\r\n                                    {order.serviceFees.map((fee) => (\r\n                                        <div key={fee.id} className=\"ml-4 text-sm\">\r\n                                            {fee.name}: {fee.amount.toLocaleString()}đ\r\n                                        </div>\r\n                                    ))}\r\n                                </div>\r\n                            )}\r\n                            {order.notes && (\r\n                                <div>\r\n                                    <span className=\"text-muted-foreground\">Ghi chú:</span>\r\n                                    <p className=\"mt-1 text-sm whitespace-pre-wrap\">{order.notes}</p>\r\n                                </div>\r\n                            )}\r\n                            <Button \r\n                                variant=\"link\" \r\n                                className=\"p-0 h-auto text-sm\" \r\n                                onClick={() => {\r\n                                    const historyTab = document.querySelector('[value=\"history\"]');\r\n                                    if (historyTab) {\r\n                                        (historyTab as HTMLElement).click();\r\n                                        setTimeout(() => {\r\n                                            historyTab.scrollIntoView({ behavior: 'smooth', block: 'start' });\r\n                                        }, 100);\r\n                                    }\r\n                                }}\r\n                            >\r\n                                <Link href={`/customers/${customer?.systemId}`} className=\"hover:underline\">\r\n                                    Xem lịch sử đơn hàng\r\n                                </Link>\r\n                            </Button>\r\n                        </CardContent>\r\n                    </Card>\r\n                </div>\r\n\r\n                {/* Row 2: Đơn hàng chờ thanh toán - Full width */}\r\n                <Card>\r\n                    <CardHeader>\r\n                        <div className=\"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3\">\r\n                            <div className=\"flex items-center gap-2\">\r\n                                {order.paymentStatus === 'Thanh toán toàn bộ' ? (\r\n                                    <CheckCircle2 className=\"h-5 w-5 text-green-500 flex-shrink-0\" />\r\n                                ) : (\r\n                                    <FileWarning className=\"h-5 w-5 text-amber-500 flex-shrink-0\" />\r\n                                )}\r\n                                <CardTitle className=\"text-base font-semibold\">\r\n                                    {order.paymentStatus === 'Chưa thanh toán' \r\n                                        ? 'Đơn hàng chờ thanh toán' \r\n                                        : `Đơn hàng thanh toán ${order.paymentStatus.toLowerCase()}`}\r\n                                </CardTitle>\r\n                            </div>\r\n                            {isActionable && payableAmount > 0 && (\r\n                                <Button size=\"sm\" onClick={() => setIsPaymentDialogOpen(true)}>\r\n                                    Thanh toán\r\n                                </Button>\r\n                            )}\r\n                        </div>\r\n                    </CardHeader>\r\n                    <CardContent className=\"space-y-3\">\r\n                        <div className=\"grid grid-cols-1 gap-2 bg-muted/50 p-3 sm:p-4 rounded-md text-sm\">\r\n                            <div className=\"flex justify-between\">\r\n                                <span className=\"text-muted-foreground\">Tổng tiền ĐH:</span>\r\n                                <span className=\"font-medium\">{formatCurrency(order.grandTotal)}</span>\r\n                            </div>\r\n                            {totalReturnedValue > 0 && (\r\n                                <div className=\"flex justify-between\">\r\n                                    <span className=\"text-muted-foreground\">Giá trị hàng bị trả lại:</span>\r\n                                    <span className=\"font-medium text-amber-600\">-{formatCurrency(totalReturnedValue)}</span>\r\n                                </div>\r\n                            )}\r\n                            {totalReturnedValue > 0 && (\r\n                                <div className=\"flex justify-between\">\r\n                                    <span className=\"text-muted-foreground font-semibold\">Công nợ thực tế:</span>\r\n                                    <span className=\"font-semibold\">{formatCurrency(netGrandTotal)}</span>\r\n                                </div>\r\n                            )}\r\n                            <div className=\"flex justify-between\">\r\n                                <span className=\"text-muted-foreground\">Đã trả:</span>\r\n                                <span className=\"font-medium\">{totalPaid > 0 ? formatCurrency(totalPaid) : '0'}</span>\r\n                            </div>\r\n                            {totalRefundedFromReturns > 0 && (\r\n                                <div className=\"flex justify-between\">\r\n                                    <span className=\"text-muted-foreground\">Đã hoàn tiền (trả hàng):</span>\r\n                                    <span className=\"font-medium text-green-600\">-{formatCurrency(totalRefundedFromReturns)}</span>\r\n                                </div>\r\n                            )}\r\n                            \r\n                            {totalCodAmount > 0 && (\r\n                                <div className=\"flex justify-between\">\r\n                                    <span className=\"text-muted-foreground\">Thu hộ COD:</span>\r\n                                    <span className=\"font-medium text-blue-600\">\r\n                                        {formatCurrency(totalCodAmount)}\r\n                                    </span>\r\n                                </div>\r\n                            )}\r\n                            \r\n                            <div className=\"border-t border-border my-1\" />\r\n                            \r\n                            <div className=\"flex justify-between\">\r\n                                <span className=\"text-muted-foreground font-bold\">Còn phải trả:</span>\r\n                                <span className={cn(\r\n                                    \"font-bold text-lg\",\r\n                                    amountRemaining > 0 ? 'text-red-500' : amountRemaining < 0 ? 'text-green-600' : 'text-foreground'\r\n                                )}>{amountRemaining >= 0 ? formatCurrency(amountRemaining) : formatCurrency(0)}</span>\r\n                            </div>\r\n                            {amountRemaining < 0 && (\r\n                                <div className=\"flex justify-between text-green-600\">\r\n                                    <span className=\"font-medium\">Thừa tiền (cần hoàn thêm):</span>\r\n                                    <span className=\"font-bold\">{formatCurrency(Math.abs(amountRemaining))}</span>\r\n                                </div>\r\n                            )}\r\n                        </div>\r\n\r\n                        {directPayments.length > 0 && (\r\n                            <div className=\"space-y-2 pt-2\">\r\n                                {[...directPayments].reverse().map((payment, index) => (\r\n                                    <React.Fragment key={`direct-${payment.systemId}-${index}`}>\r\n                                        <PaymentInfo payment={payment} order={order} />\r\n                                    </React.Fragment>\r\n                                ))}\r\n                            </div>\r\n                        )}\r\n                        \r\n                        {(totalActiveCod > 0 || codPayments.length > 0) && (\r\n                            <div className=\"space-y-2 pt-2\">\r\n                                {codPayments.length > 0 && [...codPayments].reverse().map((payment, index) => (\r\n                                    <React.Fragment key={`cod-${payment.systemId}-${index}`}>\r\n                                        <PaymentInfo payment={payment} order={order} />\r\n                                    </React.Fragment>\r\n                                ))}\r\n                                {totalActiveCod > 0 && (\r\n                                    <div className=\"border rounded-md bg-background text-sm p-3 flex items-center justify-between\">\r\n                                        <div>\r\n                                            <p className=\"font-medium\">Chờ đối soát</p>\r\n                                            <p className=\"text-muted-foreground text-xs\">Đối tác vận chuyển sẽ hoàn tiền sau khi đối soát</p>\r\n                                        </div>\r\n                                        <div className=\"font-semibold\">{formatCurrency(totalActiveCod)}</div>\r\n                                    </div>\r\n                                )}\r\n                            </div>\r\n                        )}\r\n\r\n                        {/* Phiếu chi hoàn tiền từ trả hàng */}\r\n                        {refundPaymentsForOrder.length > 0 && (\r\n                            <div className=\"space-y-2 pt-2 border-t\">\r\n                                <p className=\"text-sm font-medium text-muted-foreground pt-2\">Phiếu chi hoàn tiền</p>\r\n                                {[...refundPaymentsForOrder].reverse().map((refund, index) => (\r\n                                    <div key={`refund-${refund.systemId}-${index}`} className=\"border rounded-md text-sm\">\r\n                                        <Collapsible>\r\n                                            <CollapsibleTrigger asChild>\r\n                                                <div className=\"w-full p-3 flex items-center justify-between hover:bg-muted/50 rounded-md transition-colors cursor-pointer\">\r\n                                                <div className=\"flex items-center gap-2\">\r\n                                                    <ArrowDownLeft className=\"h-4 w-4 text-green-600\" />\r\n                                                    <Link \r\n                                                        href={`/payments/${refund.systemId}`} \r\n                                                        onClick={(e) => e.stopPropagation()}\r\n                                                        className=\"font-medium text-primary hover:underline\"\r\n                                                    >\r\n                                                        {refund.id}\r\n                                                    </Link>\r\n                                                </div>\r\n                                                <div className=\"flex items-center gap-3\">\r\n                                                    <span className=\"text-muted-foreground\">{formatDate(refund.date)}</span>\r\n                                                    <span className=\"font-semibold text-green-600\">-{formatCurrency(refund.amount)}</span>\r\n                                                    <Button \r\n                                                        variant=\"ghost\" \r\n                                                        size=\"icon\" \r\n                                                        className=\"h-6 w-6\"\r\n                                                        onClick={(e) => {\r\n                                                            e.stopPropagation();\r\n                                                            // Reuse handlePrintTransaction logic or similar\r\n                                                            // Since we don't have handlePrintTransaction here, we need to implement it or pass it\r\n                                                            // But wait, we are inside OrderDetailPage, we can access print function\r\n                                                            // Let's implement inline or call a helper\r\n                                                            \r\n                                                            const branch = findBranchById(order.branchSystemId);\r\n                                                            const storeSettings: StoreSettings = {\r\n                                                                name: storeInfo?.brandName || storeInfo?.companyName,\r\n                                                                address: storeInfo?.headquartersAddress,\r\n                                                                phone: storeInfo?.hotline,\r\n                                                                email: storeInfo?.email,\r\n                                                                province: storeInfo?.province,\r\n                                                            };\r\n                                                            \r\n                                                            const paymentData: PaymentForPrint = {\r\n                                                                code: refund.id,\r\n                                                                createdAt: refund.date,\r\n                                                                issuedAt: refund.date,\r\n                                                                createdBy: findEmployeeById(refund.createdBy)?.fullName || refund.createdBy,\r\n                                                                recipientName: order.customerName,\r\n                                                                recipientPhone: typeof order.shippingAddress === 'object' ? order.shippingAddress?.phone : undefined,\r\n                                                                recipientAddress: typeof order.shippingAddress === 'string' ? order.shippingAddress : order.shippingAddress?.formattedAddress,\r\n                                                                recipientType: 'Khách hàng',\r\n                                                                amount: refund.amount,\r\n                                                                description: refund.description,\r\n                                                                paymentMethod: refund.paymentMethodName,\r\n                                                                documentRootCode: order.id,\r\n                                                                note: refund.description,\r\n                                                                location: branch ? {\r\n                                                                    name: branch.name,\r\n                                                                    address: branch.address,\r\n                                                                    province: branch.province\r\n                                                                } : undefined\r\n                                                            };\r\n                                                            \r\n                                                            const printData = mapPaymentToPrintData(paymentData, storeSettings);\r\n                                                            printData['amount_text'] = numberToWords(refund.amount);\r\n                                                            printData['print_date'] = formatDateTime(new Date());\r\n                                                            printData['print_time'] = formatTime(new Date());\r\n                                                            \r\n                                                            print('payment', { data: printData });\r\n                                                        }}\r\n                                                        title=\"In phiếu\"\r\n                                                    >\r\n                                                        <Printer className=\"h-4 w-4\" />\r\n                                                    </Button>\r\n                                                    <ChevronDown className=\"h-4 w-4 text-muted-foreground\" />\r\n                                                </div>\r\n                                                </div>\r\n                                            </CollapsibleTrigger>\r\n                                            <CollapsibleContent className=\"px-3 pb-3\">\r\n                                                <div className=\"grid grid-cols-2 gap-x-4 gap-y-2 text-sm pt-2 border-t\">\r\n                                                    <div>\r\n                                                        <span className=\"text-muted-foreground\">Phương thức</span>\r\n                                                        <p className=\"font-medium\">{refund.paymentMethodName}</p>\r\n                                                    </div>\r\n                                                    <div>\r\n                                                        <span className=\"text-muted-foreground\">Người tạo</span>\r\n                                                        <p className=\"font-medium\">{findEmployeeById(refund.createdBy)?.fullName || refund.createdBy}</p>\r\n                                                    </div>\r\n                                                    <div className=\"col-span-2\">\r\n                                                        <span className=\"text-muted-foreground\">Diễn giải</span>\r\n                                                        <p className=\"font-medium\">{refund.description}</p>\r\n                                                    </div>\r\n                                                </div>\r\n                                            </CollapsibleContent>\r\n                                        </Collapsible>\r\n                                    </div>\r\n                                ))}\r\n                            </div>\r\n                        )}\r\n                    </CardContent>\r\n                </Card>\r\n\r\n                {/* Row 3: Đóng gói và Giao hàng - Full width */}\r\n                <Card>\r\n                    <CardHeader>\r\n                        <div className=\"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3\">\r\n                            <div className=\"flex items-center gap-2\">\r\n                                <Package className=\"h-5 w-5 text-muted-foreground flex-shrink-0\" />\r\n                                <CardTitle className=\"text-base font-semibold\">Đóng gói và Giao hàng</CardTitle>\r\n                            </div>\r\n                            {renderMainPackagingActionButtons()}\r\n                        </div>\r\n                    </CardHeader>\r\n                    <CardContent className=\"space-y-4\">\r\n                        {order.packagings.length === 0 && (\r\n                            <div className=\"text-center text-muted-foreground py-4\">\r\n                                Chưa có yêu cầu đóng gói.\r\n                            </div>\r\n                        )}\r\n                        {[...order.packagings].reverse().map(pkg => (\r\n                            <React.Fragment key={pkg.systemId}>\r\n                                <PackagingInfo\r\n                                    order={order}\r\n                                    packaging={pkg}\r\n                                    isActionable={isActionable}\r\n                                    onConfirmPackaging={() => handleConfirmPackaging(pkg.systemId)}\r\n                                    onCancelPackaging={() => setCancelPackagingState({ packagingSystemId: pkg.systemId })}\r\n                                    onDispatch={() => handleDispatch(pkg.systemId)}\r\n                                    onCompleteDelivery={() => handleCompleteDelivery(pkg.systemId)}\r\n                                    onOpenShipmentDialog={() => setIsCreateShipmentDialogOpen(true)}\r\n                                    onFailDelivery={() => setCancelShipmentState({ packagingSystemId: pkg.systemId, type: 'fail'})}\r\n                                    onCancelDelivery={() => setCancelShipmentState({ packagingSystemId: pkg.systemId, type: 'cancel' })}\r\n                                    onInStorePickup={() => handleInStorePickup(pkg.systemId)}\r\n                                    onCancelGHTKShipment={pkg.trackingCode ? () => handleCancelGHTKShipment(pkg.systemId, pkg.trackingCode!) : undefined}\r\n                                />\r\n                            </React.Fragment>\r\n                        ))}\r\n                    </CardContent>\r\n                </Card>\r\n\r\n                {/* Product Info Card - Always visible */}\r\n                <ProductInfoCard \r\n                    order={order} \r\n                    costOfGoods={costOfGoods} \r\n                    profit={profit} \r\n                    totalDiscount={totalDiscount} \r\n                    salesReturns={allSalesReturns} \r\n                    getProductTypeLabel={getProductTypeLabel}\r\n                />\r\n                \r\n                {/* Return History Card - Show only if there are returns */}\r\n                {salesReturnsForOrder.length > 0 && (\r\n                    <Card>\r\n                        <CardHeader>\r\n                            <CardTitle className=\"text-base font-semibold\">\r\n                                Lịch sử trả hàng ({salesReturnsForOrder.length})\r\n                            </CardTitle>\r\n                        </CardHeader>\r\n                        <CardContent>\r\n                            <ReturnHistoryTab \r\n                                order={order} \r\n                                salesReturnsForOrder={salesReturnsForOrder}\r\n                                getProductTypeLabel={getProductTypeLabel}\r\n                                onPreview={handlePreview}\r\n                            />\r\n                        </CardContent>\r\n                    </Card>\r\n                )}\r\n\r\n                <DatabaseComments\r\n                    entityType=\"order\"\r\n                    entityId={order.systemId}\r\n                />\r\n                \r\n                {/* Order History & Notes */}\r\n                <OrderHistoryTab order={order} salesReturnsForOrder={salesReturnsForOrder} />\r\n\r\n                {/* Shipping Tracking - Show if order has shipping partner delivery */}\r\n                {order.packagings.some(p => p.deliveryMethod === 'Dịch vụ giao hàng' && p.status !== 'Hủy đóng gói') && (\r\n                    <ShippingTrackingTab order={order} />\r\n                )}\r\n            </div>\r\n\r\n            <AlertDialog open={isCancelAlertOpen} onOpenChange={setIsCancelAlertOpen}>\r\n                <AlertDialogContent>\r\n                    <AlertDialogHeader>\r\n                        <AlertDialogTitle>Xác nhận hủy đơn hàng</AlertDialogTitle>\r\n                        <AlertDialogDescription className=\"space-y-4\">\r\n                            <div className=\"space-y-3\">\r\n                                <p>Bạn có chắc chắn muốn hủy đơn hàng này không?</p>\r\n                                <p className=\"text-sm\">Khi hủy đơn hàng, hệ thống sẽ thực hiện các thay đổi sau:</p>\r\n                                <ul className=\"text-sm space-y-1 ml-4 list-disc\">\r\n                                    <li>Trả hàng về kho và cập nhật số lượng tồn kho</li>\r\n                                    <li>Hủy các vận đơn liên quan (nếu có)</li>\r\n                                    <li>Hủy các phiếu thu thanh toán đơn hàng</li>\r\n                                    <li>Hủy các phiếu thu đặt cọc shipper (nếu có)</li>\r\n                                    <li>Cập nhật công nợ khách hàng</li>\r\n                                    <li>Cập nhật công nợ đối tác vận chuyển</li>\r\n                                    <li>Hoàn lại khuyến mại và điểm tích lũy (nếu có)</li>\r\n                                </ul>\r\n                                {order && order.payments && order.payments.length > 0 && (\r\n                                    <p className=\"text-amber-600 font-medium\">\r\n                                        Lưu ý: Đơn hàng đã có thanh toán. Một phiếu chi hoàn tiền sẽ được tạo tự động.\r\n                                    </p>\r\n                                )}\r\n                                <p className=\"font-semibold text-destructive\">Hành động này không thể hoàn tác!</p>\r\n                            </div>\r\n\r\n                            <div className=\"space-y-2\">\r\n                                <Label htmlFor=\"cancel-reason-textarea\" className=\"text-sm font-semibold\">\r\n                                    Lý do hủy đơn hàng\r\n                                </Label>\r\n                                <Textarea\r\n                                    id=\"cancel-reason-textarea\"\r\n                                    value={cancelReasonText}\r\n                                    onChange={(event) => setCancelReasonText(event.target.value)}\r\n                                    placeholder=\"Nhập rõ lý do hủy để đội vận hành nắm được...\"\r\n                                    rows={3}\r\n                                />\r\n                            </div>\r\n\r\n                            <div className=\"space-y-3\">\r\n                                <Label className=\"text-sm font-semibold\">Tùy chọn bổ sung</Label>\r\n                                <div className=\"space-y-2\">\r\n                                    <div className=\"flex items-start gap-3 rounded-md border p-3\">\r\n                                        <Checkbox\r\n                                            id=\"cancel-restock-option\"\r\n                                            checked={restockItems}\r\n                                            onCheckedChange={(checked) => setRestockItems(checked === true)}\r\n                                        />\r\n                                        <div className=\"space-y-1\">\r\n                                            <Label htmlFor=\"cancel-restock-option\" className=\"text-sm font-medium\">\r\n                                                Hoàn kho {totalLineQuantity} sản phẩm\r\n                                            </Label>\r\n                                            <p className=\"text-xs text-muted-foreground\">\r\n                                                Giữ tồn kho và số liệu chi phí chính xác sau khi hủy.\r\n                                            </p>\r\n                                        </div>\r\n                                    </div>\r\n                                </div>\r\n                            </div>\r\n                        </AlertDialogDescription>\r\n                    </AlertDialogHeader>\r\n                    <AlertDialogFooter>\r\n                        <AlertDialogCancel>Không, giữ đơn hàng</AlertDialogCancel>\r\n                        <AlertDialogAction onClick={handleConfirmCancel} className=\"border-destructive text-destructive hover:bg-destructive hover:text-destructive-foreground\">\r\n                            Có, hủy đơn hàng\r\n                        </AlertDialogAction>\r\n                    </AlertDialogFooter>\r\n                </AlertDialogContent>\r\n            </AlertDialog>\r\n\r\n             <PaymentDialog \r\n                isOpen={isPaymentDialogOpen}\r\n                onOpenChange={setIsPaymentDialogOpen}\r\n                onSubmit={handleAddPayment}\r\n                amountDue={payableAmount}\r\n            />\r\n            \r\n            <CreateShipmentDialog\r\n                isOpen={isCreateShipmentDialogOpen}\r\n                onOpenChange={setIsCreateShipmentDialogOpen}\r\n                onSubmit={handleShippingSubmit}\r\n                order={order}\r\n                customer={customer}\r\n            />\r\n\r\n            <PackerSelectionDialog\r\n                isOpen={isPackerSelectionOpen}\r\n                onOpenChange={setIsPackerSelectionOpen}\r\n                onSubmit={handleRequestPackaging}\r\n                {...(existingPackerSystemId ? { existingPackerSystemId } : {})}\r\n            />\r\n            \r\n            <CancelPackagingDialog\r\n                isOpen={!!cancelPackagingState}\r\n                onOpenChange={(open) => !open && setCancelPackagingState(null)}\r\n                onConfirm={handleCancelPackagingSubmit}\r\n            />\r\n\r\n            {cancelShipmentState?.type === 'fail' && (\r\n                <DeliveryFailureDialog\r\n                    isOpen={true}\r\n                    onOpenChange={(open) => !open && setCancelShipmentState(null)}\r\n                    onConfirm={handleFailDeliverySubmit}\r\n                />\r\n            )}\r\n            {cancelShipmentState?.type === 'cancel' && (\r\n                <CancelShipmentDialog\r\n                    isOpen={true}\r\n                    onOpenChange={(open) => !open && setCancelShipmentState(null)}\r\n                    onCancelShipment={handleCancelDeliveryOnly}\r\n                    onCancelAndRestock={handleCancelDeliveryAndRestock}\r\n                />\r\n            )}\r\n\r\n            {/* Image Preview Dialog for ReturnHistoryTab */}\r\n            <ImagePreviewDialog \r\n                open={returnHistoryPreviewState.open} \r\n                onOpenChange={(open) => setReturnHistoryPreviewState(prev => ({ ...prev, open }))} \r\n                images={[returnHistoryPreviewState.image]} \r\n                title={returnHistoryPreviewState.title}\r\n            />\r\n        </>\r\n    );\r\n}\r\n"],"names":[],"mappings":"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"}}]
}