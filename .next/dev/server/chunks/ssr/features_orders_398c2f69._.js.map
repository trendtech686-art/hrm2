{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/orders/api/orders-api.ts"],"sourcesContent":["/**\r\n * Orders API - Isolated API functions\r\n * \r\n * ⚠️ IMPORTANT: This file should ONLY contain:\r\n * - Fetch functions\r\n * - Type imports from ../types\r\n * - NO store imports\r\n * - NO cross-feature imports\r\n */\r\n\r\nimport type { Order } from '../types';\r\n\r\nconst API_BASE = '/api/orders';\r\n\r\nexport interface OrdersParams {\r\n  page?: number;\r\n  limit?: number;\r\n  search?: string;\r\n  status?: string;\r\n  customerId?: string;\r\n  startDate?: string;\r\n  endDate?: string;\r\n  sortBy?: string;\r\n  sortOrder?: 'asc' | 'desc';\r\n}\r\n\r\nexport interface PaginatedResponse<T> {\r\n  data: T[];\r\n  pagination: {\r\n    page: number;\r\n    limit: number;\r\n    total: number;\r\n    totalPages: number;\r\n  };\r\n}\r\n\r\nexport interface CreateOrderInput {\r\n  // Required fields\r\n  customerSystemId: string;\r\n  customerName: string;\r\n  branchSystemId: string;\r\n  branchName: string;\r\n  salespersonSystemId: string;\r\n  salesperson: string;\r\n  lineItems: Array<{\r\n    productSystemId: string;\r\n    productId: string;\r\n    productName: string;\r\n    quantity: number;\r\n    unitPrice: number;\r\n    discount?: number;\r\n    discountType?: 'percentage' | 'fixed';\r\n    tax?: number;\r\n    note?: string;\r\n  }>;\r\n  orderDate: string;\r\n  \r\n  // Optional fields\r\n  shippingAddress?: string | Record<string, unknown>;\r\n  billingAddress?: string | Record<string, unknown>;\r\n  notes?: string;\r\n  tags?: string[];\r\n  status?: string;\r\n  paymentStatus?: string;\r\n  deliveryStatus?: string;\r\n  stockOutStatus?: string;\r\n  returnStatus?: string;\r\n  deliveryMethod?: string;\r\n  subtotal?: number;\r\n  shippingFee?: number;\r\n  tax?: number;\r\n  grandTotal?: number;\r\n  paidAmount?: number;\r\n  codAmount?: number;\r\n  packagings?: unknown[];\r\n  payments?: unknown[];\r\n  completedDate?: string | null;\r\n  createdAt?: string;\r\n}\r\n\r\nexport interface UpdateOrderInput {\r\n  id: string;\r\n  // Allow partial update of any Order field\r\n  [key: string]: unknown;\r\n}\r\n\r\n/**\r\n * Fetch paginated orders list\r\n */\r\nexport async function fetchOrders(params: OrdersParams = {}): Promise<PaginatedResponse<Order>> {\r\n  const { page = 1, limit = 50, ...rest } = params;\r\n  \r\n  const searchParams = new URLSearchParams({\r\n    page: String(page),\r\n    limit: String(limit),\r\n  });\r\n  \r\n  // Add optional params\r\n  Object.entries(rest).forEach(([key, value]) => {\r\n    if (value != null && value !== '') {\r\n      searchParams.set(key, String(value));\r\n    }\r\n  });\r\n  \r\n  const res = await fetch(`${API_BASE}?${searchParams}`);\r\n  if (!res.ok) {\r\n    throw new Error(`Failed to fetch orders: ${res.statusText}`);\r\n  }\r\n  \r\n  return res.json();\r\n}\r\n\r\n/**\r\n * Fetch single order by ID\r\n */\r\nexport async function fetchOrder(id: string): Promise<Order> {\r\n  const res = await fetch(`${API_BASE}/${id}`);\r\n  if (!res.ok) {\r\n    throw new Error(`Failed to fetch order ${id}: ${res.statusText}`);\r\n  }\r\n  return res.json();\r\n}\r\n\r\n/**\r\n * Create new order\r\n */\r\nexport async function createOrder(data: CreateOrderInput): Promise<Order> {\r\n  const res = await fetch(API_BASE, {\r\n    method: 'POST',\r\n    headers: { 'Content-Type': 'application/json' },\r\n    body: JSON.stringify(data),\r\n  });\r\n  \r\n  if (!res.ok) {\r\n    const error = await res.json().catch(() => ({}));\r\n    throw new Error(error.message || `Failed to create order: ${res.statusText}`);\r\n  }\r\n  \r\n  return res.json();\r\n}\r\n\r\n/**\r\n * Update existing order\r\n */\r\nexport async function updateOrder({ id, ...data }: UpdateOrderInput): Promise<Order> {\r\n  const res = await fetch(`${API_BASE}/${id}`, {\r\n    method: 'PUT',\r\n    headers: { 'Content-Type': 'application/json' },\r\n    body: JSON.stringify(data),\r\n  });\r\n  \r\n  if (!res.ok) {\r\n    const error = await res.json().catch(() => ({}));\r\n    throw new Error(error.message || `Failed to update order: ${res.statusText}`);\r\n  }\r\n  \r\n  return res.json();\r\n}\r\n\r\n/**\r\n * Delete order\r\n */\r\nexport async function deleteOrder(id: string): Promise<void> {\r\n  const res = await fetch(`${API_BASE}/${id}`, {\r\n    method: 'DELETE',\r\n  });\r\n  \r\n  if (!res.ok) {\r\n    const error = await res.json().catch(() => ({}));\r\n    throw new Error(error.message || `Failed to delete order: ${res.statusText}`);\r\n  }\r\n}\r\n\r\n/**\r\n * Fetch order stats (for dashboard)\r\n */\r\nexport async function fetchOrderStats(): Promise<{\r\n  totalOrders: number;\r\n  totalRevenue: number;\r\n  pendingOrders: number;\r\n  todayOrders: number;\r\n}> {\r\n  const res = await fetch(`${API_BASE}/stats`);\r\n  if (!res.ok) {\r\n    throw new Error(`Failed to fetch order stats: ${res.statusText}`);\r\n  }\r\n  return res.json();\r\n}\r\n"],"names":[],"mappings":"AAAA;;;;;;;;CAQC;;;;;;;;;;;;;;AAID,MAAM,WAAW;AA6EV,eAAe,YAAY,SAAuB,CAAC,CAAC;IACzD,MAAM,EAAE,OAAO,CAAC,EAAE,QAAQ,EAAE,EAAE,GAAG,MAAM,GAAG;IAE1C,MAAM,eAAe,IAAI,gBAAgB;QACvC,MAAM,OAAO;QACb,OAAO,OAAO;IAChB;IAEA,sBAAsB;IACtB,OAAO,OAAO,CAAC,MAAM,OAAO,CAAC,CAAC,CAAC,KAAK,MAAM;QACxC,IAAI,SAAS,QAAQ,UAAU,IAAI;YACjC,aAAa,GAAG,CAAC,KAAK,OAAO;QAC/B;IACF;IAEA,MAAM,MAAM,MAAM,MAAM,GAAG,SAAS,CAAC,EAAE,cAAc;IACrD,IAAI,CAAC,IAAI,EAAE,EAAE;QACX,MAAM,IAAI,MAAM,CAAC,wBAAwB,EAAE,IAAI,UAAU,EAAE;IAC7D;IAEA,OAAO,IAAI,IAAI;AACjB;AAKO,eAAe,WAAW,EAAU;IACzC,MAAM,MAAM,MAAM,MAAM,GAAG,SAAS,CAAC,EAAE,IAAI;IAC3C,IAAI,CAAC,IAAI,EAAE,EAAE;QACX,MAAM,IAAI,MAAM,CAAC,sBAAsB,EAAE,GAAG,EAAE,EAAE,IAAI,UAAU,EAAE;IAClE;IACA,OAAO,IAAI,IAAI;AACjB;AAKO,eAAe,YAAY,IAAsB;IACtD,MAAM,MAAM,MAAM,MAAM,UAAU;QAChC,QAAQ;QACR,SAAS;YAAE,gBAAgB;QAAmB;QAC9C,MAAM,KAAK,SAAS,CAAC;IACvB;IAEA,IAAI,CAAC,IAAI,EAAE,EAAE;QACX,MAAM,QAAQ,MAAM,IAAI,IAAI,GAAG,KAAK,CAAC,IAAM,CAAC,CAAC,CAAC;QAC9C,MAAM,IAAI,MAAM,MAAM,OAAO,IAAI,CAAC,wBAAwB,EAAE,IAAI,UAAU,EAAE;IAC9E;IAEA,OAAO,IAAI,IAAI;AACjB;AAKO,eAAe,YAAY,EAAE,EAAE,EAAE,GAAG,MAAwB;IACjE,MAAM,MAAM,MAAM,MAAM,GAAG,SAAS,CAAC,EAAE,IAAI,EAAE;QAC3C,QAAQ;QACR,SAAS;YAAE,gBAAgB;QAAmB;QAC9C,MAAM,KAAK,SAAS,CAAC;IACvB;IAEA,IAAI,CAAC,IAAI,EAAE,EAAE;QACX,MAAM,QAAQ,MAAM,IAAI,IAAI,GAAG,KAAK,CAAC,IAAM,CAAC,CAAC,CAAC;QAC9C,MAAM,IAAI,MAAM,MAAM,OAAO,IAAI,CAAC,wBAAwB,EAAE,IAAI,UAAU,EAAE;IAC9E;IAEA,OAAO,IAAI,IAAI;AACjB;AAKO,eAAe,YAAY,EAAU;IAC1C,MAAM,MAAM,MAAM,MAAM,GAAG,SAAS,CAAC,EAAE,IAAI,EAAE;QAC3C,QAAQ;IACV;IAEA,IAAI,CAAC,IAAI,EAAE,EAAE;QACX,MAAM,QAAQ,MAAM,IAAI,IAAI,GAAG,KAAK,CAAC,IAAM,CAAC,CAAC,CAAC;QAC9C,MAAM,IAAI,MAAM,MAAM,OAAO,IAAI,CAAC,wBAAwB,EAAE,IAAI,UAAU,EAAE;IAC9E;AACF;AAKO,eAAe;IAMpB,MAAM,MAAM,MAAM,MAAM,GAAG,SAAS,MAAM,CAAC;IAC3C,IAAI,CAAC,IAAI,EAAE,EAAE;QACX,MAAM,IAAI,MAAM,CAAC,6BAA6B,EAAE,IAAI,UAAU,EAAE;IAClE;IACA,OAAO,IAAI,IAAI;AACjB"}},
    {"offset": {"line": 100, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/orders/hooks/use-orders.ts"],"sourcesContent":["/**\r\n * useOrders - React Query hook for orders list\r\n * \r\n * ⚠️ IMPORTANT: Direct import pattern\r\n * - Import this file directly: import { useOrders } from '@/features/orders/hooks/use-orders'\r\n * - NEVER import from '@/features/orders' or '@/features/orders/store'\r\n * \r\n * This hook is ISOLATED - it only depends on:\r\n * - @tanstack/react-query\r\n * - Local API functions\r\n * - Local types\r\n */\r\n\r\nimport { useQuery, keepPreviousData } from '@tanstack/react-query';\r\nimport { fetchOrders, fetchOrder, fetchOrderStats, type OrdersParams } from '../api/orders-api';\r\n\r\n// Query keys - exported for invalidation\r\nexport const orderKeys = {\r\n  all: ['orders'] as const,\r\n  lists: () => [...orderKeys.all, 'list'] as const,\r\n  list: (params: OrdersParams) => [...orderKeys.lists(), params] as const,\r\n  details: () => [...orderKeys.all, 'detail'] as const,\r\n  detail: (id: string) => [...orderKeys.details(), id] as const,\r\n  stats: () => [...orderKeys.all, 'stats'] as const,\r\n};\r\n\r\n/**\r\n * Hook for fetching paginated orders list\r\n * \r\n * @example\r\n * ```tsx\r\n * function OrdersPage() {\r\n *   const [page, setPage] = useState(1);\r\n *   const { data, isLoading, error } = useOrders({ page, limit: 50 });\r\n *   \r\n *   if (isLoading) return <Skeleton />;\r\n *   if (error) return <ErrorMessage error={error} />;\r\n *   \r\n *   return (\r\n *     <DataTable \r\n *       data={data.data} \r\n *       pagination={data.pagination}\r\n *       onPageChange={setPage}\r\n *     />\r\n *   );\r\n * }\r\n * ```\r\n */\r\nexport function useOrders(params: OrdersParams = {}) {\r\n  return useQuery({\r\n    queryKey: orderKeys.list(params),\r\n    queryFn: () => fetchOrders(params),\r\n    staleTime: 30_000, // 30 seconds\r\n    gcTime: 5 * 60 * 1000, // 5 minutes (formerly cacheTime)\r\n    placeholderData: keepPreviousData, // Keep old data while fetching new page\r\n  });\r\n}\r\n\r\n/**\r\n * Hook for fetching single order by ID\r\n * \r\n * @example\r\n * ```tsx\r\n * function OrderDetail({ orderId }: { orderId: string }) {\r\n *   const { data: order, isLoading } = useOrder(orderId);\r\n *   // ...\r\n * }\r\n * ```\r\n */\r\nexport function useOrder(id: string | null | undefined) {\r\n  return useQuery({\r\n    queryKey: orderKeys.detail(id!),\r\n    queryFn: () => fetchOrder(id!),\r\n    enabled: !!id, // Only fetch if id is provided\r\n    staleTime: 60_000, // 1 minute for detail view\r\n    gcTime: 10 * 60 * 1000, // 10 minutes\r\n  });\r\n}\r\n\r\n/**\r\n * Hook for fetching order statistics (dashboard)\r\n */\r\nexport function useOrderStats() {\r\n  return useQuery({\r\n    queryKey: orderKeys.stats(),\r\n    queryFn: fetchOrderStats,\r\n    staleTime: 60_000, // 1 minute\r\n    gcTime: 5 * 60 * 1000,\r\n  });\r\n}\r\n\r\n/**\r\n * Hook for searching orders with debounce\r\n * \r\n * @example\r\n * ```tsx\r\n * function OrderSearch() {\r\n *   const [search, setSearch] = useState('');\r\n *   const debouncedSearch = useDebounce(search, 300);\r\n *   const { data } = useOrderSearch(debouncedSearch);\r\n *   // ...\r\n * }\r\n * ```\r\n */\r\nexport function useOrderSearch(search: string, limit = 20) {\r\n  return useQuery({\r\n    queryKey: orderKeys.list({ search, limit }),\r\n    queryFn: () => fetchOrders({ search, limit }),\r\n    enabled: search.length >= 2, // Only search with 2+ chars\r\n    staleTime: 30_000,\r\n  });\r\n}\r\n\r\n// Re-export from use-all-orders for backward compatibility\r\nexport { useAllOrders, useOrderFinder } from './use-all-orders';\r\n"],"names":[],"mappings":";;;;;;;;;;;;AAAA;;;;;;;;;;;CAWC,GAED;AAAA;AACA;AAmGA,2DAA2D;AAC3D;;;AAjGO,MAAM,YAAY;IACvB,KAAK;QAAC;KAAS;IACf,OAAO,IAAM;eAAI,UAAU,GAAG;YAAE;SAAO;IACvC,MAAM,CAAC,SAAyB;eAAI,UAAU,KAAK;YAAI;SAAO;IAC9D,SAAS,IAAM;eAAI,UAAU,GAAG;YAAE;SAAS;IAC3C,QAAQ,CAAC,KAAe;eAAI,UAAU,OAAO;YAAI;SAAG;IACpD,OAAO,IAAM;eAAI,UAAU,GAAG;YAAE;SAAQ;AAC1C;AAwBO,SAAS,UAAU,SAAuB,CAAC,CAAC;IACjD,OAAO,IAAA,uLAAQ,EAAC;QACd,UAAU,UAAU,IAAI,CAAC;QACzB,SAAS,IAAM,IAAA,yJAAW,EAAC;QAC3B,WAAW;QACX,QAAQ,IAAI,KAAK;QACjB,iBAAiB,2LAAgB;IACnC;AACF;AAaO,SAAS,SAAS,EAA6B;IACpD,OAAO,IAAA,uLAAQ,EAAC;QACd,UAAU,UAAU,MAAM,CAAC;QAC3B,SAAS,IAAM,IAAA,wJAAU,EAAC;QAC1B,SAAS,CAAC,CAAC;QACX,WAAW;QACX,QAAQ,KAAK,KAAK;IACpB;AACF;AAKO,SAAS;IACd,OAAO,IAAA,uLAAQ,EAAC;QACd,UAAU,UAAU,KAAK;QACzB,SAAS,6JAAe;QACxB,WAAW;QACX,QAAQ,IAAI,KAAK;IACnB;AACF;AAeO,SAAS,eAAe,MAAc,EAAE,QAAQ,EAAE;IACvD,OAAO,IAAA,uLAAQ,EAAC;QACd,UAAU,UAAU,IAAI,CAAC;YAAE;YAAQ;QAAM;QACzC,SAAS,IAAM,IAAA,yJAAW,EAAC;gBAAE;gBAAQ;YAAM;QAC3C,SAAS,OAAO,MAAM,IAAI;QAC1B,WAAW;IACb;AACF"}},
    {"offset": {"line": 200, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/orders/hooks/use-all-orders.ts"],"sourcesContent":["/**\r\n * useAllOrders - Convenience hook for components needing all orders as flat array\r\n */\r\n\r\nimport * as React from 'react';\r\nimport { useOrders } from './use-orders';\r\nimport type { Order } from '../types';\r\nimport type { SystemId } from '@/lib/id-types';\r\n\r\nexport function useAllOrders() {\r\n  const query = useOrders({ limit: 30 });\r\n  \r\n  return {\r\n    data: query.data?.data || [],\r\n    isLoading: query.isLoading,\r\n    isError: query.isError,\r\n    error: query.error,\r\n  };\r\n}\r\n\r\n/**\r\n * Hook for finding order by systemId or business id from cached data\r\n * Replaces legacy store.findById() method\r\n */\r\nexport function useOrderFinder() {\r\n  const { data } = useAllOrders();\r\n  \r\n  const findById = React.useCallback(\r\n    (systemId: SystemId | string | undefined): Order | undefined => {\r\n      if (!systemId) return undefined;\r\n      return data.find(o => o.systemId === systemId);\r\n    },\r\n    [data]\r\n  );\r\n  \r\n  const findByBusinessId = React.useCallback(\r\n    (businessId: string | undefined): Order | undefined => {\r\n      if (!businessId) return undefined;\r\n      return data.find(o => o.id === businessId);\r\n    },\r\n    [data]\r\n  );\r\n  \r\n  return { findById, findByBusinessId };\r\n}\r\n"],"names":[],"mappings":";;;;;;AAAA;;CAEC,GAED;AACA;;;AAIO,SAAS;IACd,MAAM,QAAQ,IAAA,yKAAS,EAAC;QAAE,OAAO;IAAG;IAEpC,OAAO;QACL,MAAM,MAAM,IAAI,EAAE,QAAQ,EAAE;QAC5B,WAAW,MAAM,SAAS;QAC1B,SAAS,MAAM,OAAO;QACtB,OAAO,MAAM,KAAK;IACpB;AACF;AAMO,SAAS;IACd,MAAM,EAAE,IAAI,EAAE,GAAG;IAEjB,MAAM,WAAW,oNAAiB,CAChC,CAAC;QACC,IAAI,CAAC,UAAU,OAAO;QACtB,OAAO,KAAK,IAAI,CAAC,CAAA,IAAK,EAAE,QAAQ,KAAK;IACvC,GACA;QAAC;KAAK;IAGR,MAAM,mBAAmB,oNAAiB,CACxC,CAAC;QACC,IAAI,CAAC,YAAY,OAAO;QACxB,OAAO,KAAK,IAAI,CAAC,CAAA,IAAK,EAAE,EAAE,KAAK;IACjC,GACA;QAAC;KAAK;IAGR,OAAO;QAAE;QAAU;IAAiB;AACtC"}},
    {"offset": {"line": 246, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/orders/store.ts"],"sourcesContent":["import { create } from 'zustand';\r\n// persist middleware removed - database is now source of truth\r\nimport { formatDate, formatDateCustom, toISODate, toISODateTime } from '../../lib/date-utils';\r\nimport { getApiUrl } from '../../lib/api-config';\r\nimport { createCrudStore } from '../../lib/store-factory';\r\n// REMOVED: import { data as initialDataOmit } from './data'; // Mock data no longer used - database is source of truth\r\nimport type { Order, OrderPayment, Packaging, OrderMainStatus, OrderDeliveryStatus, PackagingStatus, OrderPaymentStatus, OrderDeliveryMethod } from './types';\r\nimport type { SystemId, BusinessId } from '../../lib/id-types';\r\nimport { asSystemId, asBusinessId } from '../../lib/id-types';\r\nimport { generateSystemId, getMaxSystemIdCounter } from '../../lib/id-utils';\r\n\r\nimport { useEmployeeStore } from '../employees/store';\r\n// REMOVED: Voucher store no longer exists - using Payment/Receipt stores instead\r\nimport { useProductStore } from '../products/store';\r\nimport { isComboProduct } from '../products/combo-utils';\r\nimport { useStockHistoryStore } from '../stock-history/store';\r\nimport { useCustomerStore } from '../customers/store';\r\nimport { useReceiptTypeStore } from '../settings/receipt-types/store';\r\n// REMOVED: import type { Voucher } from '../vouchers/types';\r\nimport { useCashbookStore } from '../cashbook/store';\r\nimport { useReceiptStore } from '../receipts/store';\r\nimport type { Receipt, ReceiptOrderAllocation } from '../receipts/types';\r\nimport { useSalesReturnStore } from '../sales-returns/store';\r\nimport { createPaymentDocument, createReceiptDocument } from '../finance/document-helpers';\r\nimport { useShipmentStore } from '../shipments/store';\r\nimport type { Shipment } from '../shipments/types';\r\n\r\nimport { getCurrentUserSystemId } from '../../contexts/auth-context';\r\n\r\nimport { useSalesManagementSettingsStore } from '../settings/sales/sales-management-store';\r\nimport {\r\n  getCurrentUserInfo,\r\n  createCreatedEntry,\r\n  createHistoryEntry,\r\n  appendHistoryEntry,\r\n  type HistoryEntry\r\n} from '../../lib/activity-history-helper';\r\n\r\n// ✅ Helper to get branch systemId\r\nconst getBranchId = (order: Order) => order.branchSystemId;\r\n\r\nconst deliveryStatusesBlockedForCancellation: OrderDeliveryStatus[] = [\r\n    'Đang giao hàng',\r\n    'Đã giao hàng',\r\n    'Chờ giao lại',\r\n];\r\n\r\nconst IN_STORE_PICKUP_PREFIX = 'INSTORE';\r\n\r\nconst PACKAGING_CODE_PREFIX = 'DG';\r\nconst PACKAGING_SYSTEM_ID_PREFIX = 'PACKAGE';\r\n\r\n// ✅ Track packaging systemId counter globally\r\nlet packagingSystemIdCounter = 0;\r\n\r\n// ✅ Initialize counter from all existing packagings across all orders\r\nconst initPackagingCounter = (orders: Order[]): void => {\r\n    const allPackagings = orders.flatMap(o => o.packagings || []);\r\n    packagingSystemIdCounter = getMaxSystemIdCounter(allPackagings, PACKAGING_SYSTEM_ID_PREFIX);\r\n};\r\n\r\n// ✅ Generate next packaging systemId\r\nconst getNextPackagingSystemId = (): SystemId => {\r\n    packagingSystemIdCounter++;\r\n    return asSystemId(generateSystemId('packaging', packagingSystemIdCounter));\r\n};\r\n\r\nconst getPackagingSuffixFromOrderId = (orderId?: BusinessId) => {\r\n    if (!orderId) return '';\r\n    const rawValue = `${orderId}`;\r\n    const suffix = rawValue.replace(/^[A-Z-]+/, '');\r\n    return suffix || rawValue;\r\n};\r\n\r\n// Count only active packagings (not cancelled) for numbering\r\nconst getActivePackagingCount = (packagings: Packaging[]): number => {\r\n    return packagings.filter(p => p.status !== 'Hủy đóng gói').length;\r\n};\r\n\r\nconst buildPackagingBusinessId = (orderId: BusinessId, activeIndex: number, activeCount: number): BusinessId => {\r\n    const suffix = getPackagingSuffixFromOrderId(orderId);\r\n    const baseCode = `${PACKAGING_CODE_PREFIX}${suffix || '000000'}`;\r\n    // Only add suffix if there are multiple active packagings\r\n    if (activeCount > 1 && activeIndex > 0) {\r\n        const paddedIndex = String(activeIndex + 1).padStart(2, '0');\r\n        return asBusinessId(`${baseCode}-${paddedIndex}`);\r\n    }\r\n    return asBusinessId(baseCode);\r\n};\r\n\r\nconst getReturnedValueForOrder = (orderSystemId: SystemId): number => {\r\n    return useSalesReturnStore.getState().data\r\n        .filter(sr => sr.orderSystemId === orderSystemId)\r\n        .reduce((sum, sr) => sum + sr.totalReturnValue, 0);\r\n};\r\n\r\nconst calculateActualDebt = (order: Order): number => {\r\n    const totalReturnedValue = getReturnedValueForOrder(order.systemId);\r\n    return Math.max(order.grandTotal - totalReturnedValue, 0);\r\n};\r\n\r\nconst calculateTotalPaid = (payments: OrderPayment[]): number => {\r\n    return payments.reduce((sum, payment) => sum + payment.amount, 0);\r\n};\r\n\r\nconst getOrderOutstandingAmount = (order: Order): number => {\r\n    const actualDebt = calculateActualDebt(order);\r\n    const totalPaid = calculateTotalPaid(order.payments ?? []);\r\n    return Math.max(actualDebt - totalPaid, 0);\r\n};\r\n\r\nconst applyPaymentToOrder = (order: Order, payment: OrderPayment): Order => {\r\n    const updatedPayments = [...(order.payments ?? []), payment];\r\n    const totalPaid = calculateTotalPaid(updatedPayments);\r\n    const actualDebt = calculateActualDebt(order);\r\n\r\n    let newPaymentStatus: OrderPaymentStatus = 'Chưa thanh toán';\r\n    if (totalPaid >= actualDebt) {\r\n        newPaymentStatus = 'Thanh toán toàn bộ';\r\n    } else if (totalPaid > 0) {\r\n        newPaymentStatus = 'Thanh toán 1 phần';\r\n    }\r\n\r\n    const wasCompleted = order.status === 'Hoàn thành';\r\n    let newStatus = order.status;\r\n    let newCompletedDate = order.completedDate;\r\n\r\n    if (newPaymentStatus === 'Thanh toán toàn bộ' && order.deliveryStatus === 'Đã giao hàng') {\r\n        newStatus = 'Hoàn thành';\r\n        newCompletedDate = toISODateTime(new Date());\r\n        if (!wasCompleted) {\r\n            const { incrementOrderStats } = useCustomerStore.getState();\r\n            incrementOrderStats(order.customerSystemId, order.grandTotal);\r\n        }\r\n    }\r\n\r\n    const { updateDebtTransactionPayment } = useCustomerStore.getState();\r\n    updateDebtTransactionPayment(order.customerSystemId, order.id, payment.amount);\r\n\r\n    return {\r\n        ...order,\r\n        payments: updatedPayments,\r\n        paymentStatus: newPaymentStatus,\r\n        status: newStatus,\r\n        completedDate: newCompletedDate,\r\n        paidAmount: totalPaid,\r\n    };\r\n};\r\n\r\nconst shouldAutoAllocateReceipt = (receipt: Receipt): boolean => {\r\n    return (\r\n        receipt.status === 'completed' &&\r\n        receipt.affectsDebt &&\r\n        !!receipt.customerSystemId &&\r\n        !receipt.linkedOrderSystemId\r\n    );\r\n};\r\n\r\nconst getAllocatedAmount = (receipt: Receipt): number => {\r\n    return receipt.orderAllocations?.reduce((sum, allocation) => sum + allocation.amount, 0) ?? 0;\r\n};\r\n\r\nconst autoAllocateReceiptToOrders = (receipt: Receipt) => {\r\n    if (!shouldAutoAllocateReceipt(receipt)) {\r\n        return;\r\n    }\r\n\r\n    const remainingAmount = receipt.amount - getAllocatedAmount(receipt);\r\n    if (remainingAmount <= 0) {\r\n        return;\r\n    }\r\n\r\n    const candidateOrders = baseStore.getState().data\r\n        .filter(order => order.customerSystemId === receipt.customerSystemId && order.status !== 'Đã hủy')\r\n        .map(order => ({ order, outstanding: getOrderOutstandingAmount(order) }))\r\n        .filter(entry => entry.outstanding > 0)\r\n        .sort((a, b) => {\r\n            const aTime = a.order.orderDate ? new Date(a.order.orderDate).getTime() : 0;\r\n            const bTime = b.order.orderDate ? new Date(b.order.orderDate).getTime() : 0;\r\n            return aTime - bTime;\r\n        });\r\n\r\n    if (!candidateOrders.length) {\r\n        return;\r\n    }\r\n\r\n    let amountToDistribute = remainingAmount;\r\n    const updatedOrders = new Map<SystemId, Order>();\r\n    const allocationEntries: ReceiptOrderAllocation[] = [];\r\n\r\n    for (const { order } of candidateOrders) {\r\n        if (amountToDistribute <= 0) {\r\n            break;\r\n        }\r\n\r\n        const currentOrderState = updatedOrders.get(order.systemId) ?? order;\r\n        const outstanding = getOrderOutstandingAmount(currentOrderState);\r\n        if (outstanding <= 0) {\r\n            continue;\r\n        }\r\n\r\n        const allocationAmount = Math.min(outstanding, amountToDistribute);\r\n        if (allocationAmount <= 0) {\r\n            continue;\r\n        }\r\n\r\n        const paymentEntry: OrderPayment = {\r\n            systemId: receipt.systemId,\r\n            id: receipt.id,\r\n            date: receipt.date,\r\n            amount: allocationAmount,\r\n            method: receipt.paymentMethodName,\r\n            createdBy: asSystemId(receipt.createdBy),\r\n            description: receipt.description ?? `Thanh toán từ phiếu thu ${receipt.id}`,\r\n        };\r\n\r\n        const updatedOrder = applyPaymentToOrder(currentOrderState, paymentEntry);\r\n        updatedOrders.set(order.systemId, updatedOrder);\r\n        allocationEntries.push({\r\n            orderSystemId: order.systemId,\r\n            orderId: order.id,\r\n            amount: allocationAmount,\r\n        });\r\n\r\n        amountToDistribute -= allocationAmount;\r\n    }\r\n\r\n    if (!allocationEntries.length) {\r\n        return;\r\n    }\r\n\r\n    baseStore.setState(state => {\r\n        const data = state.data.map(order => updatedOrders.get(order.systemId) ?? order);\r\n        return { data };\r\n    });\r\n\r\n    const receiptStore = useReceiptStore.getState();\r\n    const latestReceipt = receiptStore.findById(receipt.systemId);\r\n    if (!latestReceipt) {\r\n        return;\r\n    }\r\n\r\n    receiptStore.update(receipt.systemId, {\r\n        ...latestReceipt,\r\n        orderAllocations: [...(latestReceipt.orderAllocations ?? []), ...allocationEntries],\r\n    });\r\n};\r\n\r\nconst ensureOrderPackagingIdentifiers = (order: Order): Order | null => {\r\n    if (!order.packagings || order.packagings.length === 0) {\r\n        return null;\r\n    }\r\n\r\n    // Count only active packagings for proper numbering\r\n    const activePackagings = order.packagings.filter(p => p.status !== 'Hủy đóng gói');\r\n    const activeCount = activePackagings.length;\r\n    let changed = false;\r\n    let activeIndex = 0;\r\n\r\n    const updatedPackagings = order.packagings.map((pkg, idx) => {\r\n        const isCancelled = pkg.status === 'Hủy đóng gói';\r\n        const hasId = typeof pkg.id === 'string' && pkg.id.trim().length > 0;\r\n        // ✅ Check for temp systemId or old format (PKG_)\r\n        const hasTempOrOldSystemId = pkg.systemId?.startsWith('PKG_TEMP_') || pkg.systemId?.startsWith('PKG_');\r\n        const hasValidSystemId = pkg.systemId?.startsWith(PACKAGING_SYSTEM_ID_PREFIX);\r\n        const shouldFixTracking = pkg.deliveryMethod === 'Nhận tại cửa hàng' && pkg.trackingCode === `${IN_STORE_PICKUP_PREFIX}-`;\r\n\r\n        // For cancelled packagings, keep existing ID\r\n        if (isCancelled) {\r\n            if (!hasId || (hasTempOrOldSystemId && !hasValidSystemId)) {\r\n                // Still need to assign an ID if missing\r\n                const nextPkg = { ...pkg };\r\n                if (!hasId) {\r\n                    nextPkg.id = buildPackagingBusinessId(order.id, 0, 1);\r\n                }\r\n                if (hasTempOrOldSystemId && !hasValidSystemId) {\r\n                    nextPkg.systemId = getNextPackagingSystemId();\r\n                }\r\n                changed = true;\r\n                return nextPkg;\r\n            }\r\n            return pkg;\r\n        }\r\n\r\n        // For active packagings, use activeIndex for numbering\r\n        const currentActiveIndex = activeIndex;\r\n        activeIndex++;\r\n\r\n        if (hasId && !shouldFixTracking && hasValidSystemId) {\r\n            return pkg;\r\n        }\r\n\r\n        const nextPkg = { ...pkg };\r\n        if (!hasId) {\r\n            nextPkg.id = buildPackagingBusinessId(order.id, currentActiveIndex, activeCount);\r\n            changed = true;\r\n        }\r\n        \r\n        // ✅ Fix temporary/old systemId to proper format PACKAGE000001\r\n        if (hasTempOrOldSystemId && !hasValidSystemId) {\r\n            nextPkg.systemId = getNextPackagingSystemId();\r\n            changed = true;\r\n        }\r\n\r\n        if (shouldFixTracking) {\r\n            const resolvedId = nextPkg.id ?? buildPackagingBusinessId(order.id, currentActiveIndex, activeCount);\r\n            nextPkg.trackingCode = `${IN_STORE_PICKUP_PREFIX}-${resolvedId}`;\r\n            changed = true;\r\n        }\r\n\r\n        return nextPkg;\r\n    });\r\n\r\n    return changed ? { ...order, packagings: updatedPackagings } : null;\r\n};\r\n\r\nconst ensureCancellationAllowed = (order: Order | undefined, actionLabel: string) => {\r\n    if (!order) return false;\r\n\r\n    const { allowCancelAfterExport } = useSalesManagementSettingsStore.getState();\r\n    if (allowCancelAfterExport) {\r\n        return true;\r\n    }\r\n\r\n    const hasLeftWarehouse =\r\n        order.stockOutStatus === 'Xuất kho toàn bộ' ||\r\n        deliveryStatusesBlockedForCancellation.includes(order.deliveryStatus);\r\n\r\n    if (hasLeftWarehouse) {\r\n        alert(\r\n            `Không thể ${actionLabel} vì đơn hàng đã xuất kho. Vào Cấu hình bán hàng -> Thiết lập quản lý bán hàng và bật \"Cho phép hủy đơn hàng sau khi xuất kho\".`,\r\n        );\r\n        return false;\r\n    }\r\n\r\n    return true;\r\n};\r\n\r\n/**\r\n * ✅ Helper để xử lý stock cho combo hoặc sản phẩm thường\r\n * Combo không có tồn kho thực tế - thao tác trên SP con\r\n */\r\ntype StockOperation = 'commit' | 'uncommit' | 'dispatch' | 'complete' | 'return';\r\n\r\nconst processLineItemStock = (\r\n    lineItem: { productSystemId: string; quantity: number },\r\n    branchSystemId: string,\r\n    operation: StockOperation,\r\n    orderQuantity: number = 1 // Số lượng đặt của line item\r\n) => {\r\n    const { \r\n        findById: findProductById, \r\n        commitStock, \r\n        uncommitStock, \r\n        dispatchStock, \r\n        completeDelivery, \r\n        returnStockFromTransit \r\n    } = useProductStore.getState();\r\n    \r\n    const product = findProductById(asSystemId(lineItem.productSystemId));\r\n    \r\n    // Xác định danh sách items cần xử lý (SP con nếu combo, hoặc chính SP nếu thường)\r\n    const itemsToProcess: { productSystemId: SystemId; quantity: number }[] = [];\r\n    \r\n    if (product && isComboProduct(product) && product.comboItems) {\r\n        // Combo: xử lý tất cả SP con\r\n        product.comboItems.forEach(comboItem => {\r\n            itemsToProcess.push({\r\n                productSystemId: asSystemId(comboItem.productSystemId),\r\n                quantity: orderQuantity * comboItem.quantity, // Số lượng combo × số lượng SP con\r\n            });\r\n        });\r\n    } else {\r\n        // Sản phẩm thường\r\n        itemsToProcess.push({\r\n            productSystemId: asSystemId(lineItem.productSystemId),\r\n            quantity: orderQuantity,\r\n        });\r\n    }\r\n    \r\n    // Thực hiện operation cho từng item\r\n    itemsToProcess.forEach(item => {\r\n        const branchId = asSystemId(branchSystemId);\r\n        switch (operation) {\r\n            case 'commit':\r\n                commitStock(item.productSystemId, branchId, item.quantity);\r\n                break;\r\n            case 'uncommit':\r\n                uncommitStock(item.productSystemId, branchId, item.quantity);\r\n                break;\r\n            case 'dispatch':\r\n                dispatchStock(item.productSystemId, branchId, item.quantity);\r\n                break;\r\n            case 'complete':\r\n                completeDelivery(item.productSystemId, branchId, item.quantity);\r\n                break;\r\n            case 'return':\r\n                returnStockFromTransit(item.productSystemId, branchId, item.quantity);\r\n                break;\r\n        }\r\n    });\r\n    \r\n    return itemsToProcess; // Return để có thể dùng cho stock history\r\n};\r\n\r\n/**\r\n * ✅ Helper để lấy danh sách stock items từ line items (mở rộng combo thành SP con)\r\n * Dùng trong webhook GHTK hoặc các thao tác batch\r\n */\r\nconst getComboStockItems = (lineItems: { productSystemId: string; quantity: number }[]): { productSystemId: SystemId; quantity: number }[] => {\r\n    const { findById: findProductById } = useProductStore.getState();\r\n    const stockItems: { productSystemId: SystemId; quantity: number }[] = [];\r\n    \r\n    lineItems.forEach(item => {\r\n        const product = findProductById(asSystemId(item.productSystemId));\r\n        \r\n        if (product && isComboProduct(product) && product.comboItems) {\r\n            // Combo: mở rộng thành SP con\r\n            product.comboItems.forEach(comboItem => {\r\n                stockItems.push({\r\n                    productSystemId: asSystemId(comboItem.productSystemId),\r\n                    quantity: item.quantity * comboItem.quantity,\r\n                });\r\n            });\r\n        } else {\r\n            // Sản phẩm thường\r\n            stockItems.push({\r\n                productSystemId: asSystemId(item.productSystemId),\r\n                quantity: item.quantity,\r\n            });\r\n        }\r\n    });\r\n    \r\n    return stockItems;\r\n};\r\n\r\nconst createOrderRefundVoucher = (order: Order, amount: number, employeeId: SystemId) => {\r\n    const lastPositivePayment = [...(order.payments ?? [])].reverse().find(p => p.amount > 0);\r\n    const { document, error } = createPaymentDocument({\r\n        amount,\r\n        description: `Hoàn tiền do hủy đơn ${order.id}`,\r\n        recipientName: order.customerName,\r\n        recipientSystemId: order.customerSystemId,\r\n        customerSystemId: order.customerSystemId,\r\n        customerName: order.customerName,\r\n        branchSystemId: order.branchSystemId,\r\n        branchName: order.branchName,\r\n        createdBy: employeeId,\r\n        paymentMethodName: lastPositivePayment?.method || 'Tiền mặt',\r\n        paymentTypeName: 'Hoàn tiền khách hàng',\r\n        originalDocumentId: order.id,\r\n        linkedOrderSystemId: order.systemId,\r\n        affectsDebt: true,\r\n        category: 'other',\r\n    });\r\n\r\n    if (!document) {\r\n        console.error('[cancelOrder] Không thể tạo phiếu chi hoàn tiền', error);\r\n        return null;\r\n    }\r\n\r\n    return document;\r\n};\r\n\r\n// REMOVED: initialDataOmit transformation - database is source of truth\r\nconst initialData: Order[] = [];\r\n\r\nconst baseStore = createCrudStore<Order>([], 'orders', {\r\n  businessIdField: 'id',\r\n  apiEndpoint: '/api/orders',\r\n  getCurrentUser: () => {\r\n    return asSystemId(getCurrentUserSystemId());\r\n  }\r\n});\r\n\r\n// ✅ API Sync helpers\r\nconst API_ENDPOINT = '/api/orders';\r\n\r\nconst syncToApi = {\r\n  create: async (order: Order) => {\r\n    try {\r\n      const response = await fetch(API_ENDPOINT, {\r\n        method: 'POST',\r\n        credentials: 'include',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify(order),\r\n      });\r\n      if (!response.ok) console.warn('[Order API] Create sync failed');\r\n      else console.log('[Order API] Created:', order.systemId);\r\n    } catch (e) {\r\n      console.warn('[Order API] Create sync error:', e);\r\n    }\r\n  },\r\n  update: async (systemId: SystemId, updates: Partial<Order>) => {\r\n    try {\r\n      const response = await fetch(`${API_ENDPOINT}/${systemId}`, {\r\n        method: 'PATCH',\r\n        credentials: 'include',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify(updates),\r\n      });\r\n      if (!response.ok) console.warn('[Order API] Update sync failed');\r\n      else console.log('[Order API] Updated:', systemId);\r\n    } catch (e) {\r\n      console.warn('[Order API] Update sync error:', e);\r\n    }\r\n  },\r\n  delete: async (systemId: SystemId, hard = false) => {\r\n    try {\r\n      const response = await fetch(`${API_ENDPOINT}/${systemId}`, {\r\n        method: 'DELETE',\r\n        credentials: 'include',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({ hard }),\r\n      });\r\n      if (!response.ok) console.warn('[Order API] Delete sync failed');\r\n      else console.log('[Order API] Deleted:', systemId);\r\n    } catch (e) {\r\n      console.warn('[Order API] Delete sync error:', e);\r\n    }\r\n  },\r\n  restore: async (systemId: SystemId) => {\r\n    try {\r\n      const response = await fetch(`${API_ENDPOINT}/${systemId}/restore`, {\r\n        method: 'POST',\r\n        credentials: 'include',\r\n        headers: { 'Content-Type': 'application/json' },\r\n      });\r\n      if (!response.ok) console.warn('[Order API] Restore sync failed');\r\n      else console.log('[Order API] Restored:', systemId);\r\n    } catch (e) {\r\n      console.warn('[Order API] Restore sync error:', e);\r\n    }\r\n  },\r\n};\r\n\r\n// ✅ Wrap base store methods with API sync\r\nconst originalAdd = baseStore.getState().add;\r\nconst originalUpdate = baseStore.getState().update;\r\nconst originalRemove = baseStore.getState().remove;\r\nconst originalHardDelete = baseStore.getState().hardDelete;\r\nconst originalRestore = baseStore.getState().restore;\r\n\r\nbaseStore.setState({\r\n  add: (item: Omit<Order, 'systemId'>) => {\r\n    const result = originalAdd(item);\r\n    syncToApi.create(result);\r\n    return result;\r\n  },\r\n  update: (systemId: SystemId, updates: Partial<Order>) => {\r\n    originalUpdate(systemId, updates);\r\n    syncToApi.update(systemId, updates);\r\n  },\r\n  remove: (systemId: SystemId) => {\r\n    originalRemove(systemId);\r\n    syncToApi.delete(systemId, false);\r\n  },\r\n  hardDelete: (systemId: SystemId) => {\r\n    originalHardDelete(systemId);\r\n    syncToApi.delete(systemId, true);\r\n  },\r\n  restore: (systemId: SystemId) => {\r\n    originalRestore(systemId);\r\n    syncToApi.restore(systemId);\r\n  },\r\n});\r\n\r\n// ✅ MIGRATION: Ensure all orders have paidAmount field (backward compatibility)\r\nbaseStore.setState(state => ({\r\n  data: state.data.map(order => ({\r\n    ...order,\r\n    paidAmount: order.paidAmount ?? 0, // Default to 0 if undefined\r\n  }))\r\n}));\r\n\r\n// ✅ MIGRATION: Merge seed data - add new orders from initialData if not exist in persisted store\r\nbaseStore.setState(state => {\r\n  const existingIds = new Set(state.data.map(o => o.systemId));\r\n  const newOrders = initialData.filter(o => !existingIds.has(o.systemId));\r\n  if (newOrders.length > 0) {\r\n    return { data: [...state.data, ...newOrders] };\r\n  }\r\n  return state;\r\n});\r\n\r\n// ✅ MIGRATION: Fix order status - orders with full payment and delivery should be \"Hoàn thành\"\r\nbaseStore.setState(state => ({\r\n  data: state.data.map(order => {\r\n    // If order is already completed or cancelled, skip\r\n    if (order.status === 'Hoàn thành' || order.status === 'Đã hủy') {\r\n      return order;\r\n    }\r\n    \r\n    // Check if all active packagings are delivered\r\n    const activePackagings = order.packagings.filter(p => p.status !== 'Hủy đóng gói');\r\n    const isAllDelivered = activePackagings.length > 0 && activePackagings.every(p => p.deliveryStatus === 'Đã giao hàng');\r\n    \r\n    // If fully paid and fully delivered, update status to \"Hoàn thành\"\r\n    if (order.paymentStatus === 'Thanh toán toàn bộ' && (isAllDelivered || order.deliveryStatus === 'Đã giao hàng')) {\r\n      return {\r\n        ...order,\r\n        status: 'Hoàn thành' as OrderMainStatus,\r\n        completedDate: order.completedDate || toISODateTime(new Date()),\r\n      };\r\n    }\r\n    \r\n    return order;\r\n  })\r\n}));\r\n\r\nconst originalAddWithStock = baseStore.getState().add;\r\n\r\nbaseStore.setState({\r\n    add: (item) => {\r\n        const { commitStock, findById: findProductById } = useProductStore.getState();\r\n        const userInfo = getCurrentUserInfo();\r\n        const newItem = originalAddWithStock(item);\r\n        if (newItem) {\r\n            const hydratedPackagings = ensureOrderPackagingIdentifiers(newItem);\r\n            if (hydratedPackagings) {\r\n                Object.assign(newItem, hydratedPackagings);\r\n                baseStore.setState(state => ({\r\n                    data: state.data.map(order => order.systemId === hydratedPackagings.systemId ? hydratedPackagings : order),\r\n                }));\r\n            }\r\n            newItem.lineItems.forEach(li => {\r\n                const product = findProductById(asSystemId(li.productSystemId));\r\n                \r\n                // ✅ Xử lý combo: commit stock của SP con thay vì combo\r\n                if (product && isComboProduct(product) && product.comboItems) {\r\n                    product.comboItems.forEach(comboItem => {\r\n                        // Commit stock = số lượng combo × số lượng SP con trong combo\r\n                        const totalQuantity = li.quantity * comboItem.quantity;\r\n                        commitStock(asSystemId(comboItem.productSystemId), asSystemId(newItem.branchSystemId), totalQuantity);\r\n                    });\r\n                } else {\r\n                    // Sản phẩm thường: commit stock như bình thường\r\n                    commitStock(asSystemId(li.productSystemId), asSystemId(newItem.branchSystemId), li.quantity);\r\n                }\r\n            });\r\n            \r\n            // ✅ Cập nhật lastPurchaseDate khi tạo đơn mới (để SLA/churn risk hoạt động đúng)\r\n            if (newItem.customerSystemId) {\r\n                const { update: updateCustomer, findById: findCustomer } = useCustomerStore.getState();\r\n                const customer = findCustomer(newItem.customerSystemId);\r\n                if (customer) {\r\n                    updateCustomer(newItem.customerSystemId, {\r\n                        lastPurchaseDate: new Date().toISOString().split('T')[0],\r\n                    });\r\n                }\r\n            }\r\n            \r\n            // ✅ Add activity history entry\r\n            const historyEntry = createCreatedEntry(\r\n                userInfo,\r\n                `${userInfo.name} đã tạo đơn hàng ${newItem.id} cho khách hàng ${newItem.customerName} (Tổng: ${newItem.grandTotal.toLocaleString('vi-VN')}đ)`\r\n            );\r\n            baseStore.setState(state => ({\r\n                data: state.data.map(order => order.systemId === newItem.systemId ? { ...order, activityHistory: [historyEntry] } : order),\r\n            }));\r\n        }\r\n        return newItem;\r\n    },\r\n});\r\n\r\nconst backfillPackagingIdentifiers = () => {\r\n    const currentState = baseStore.getState();\r\n    let changed = false;\r\n    const updatedData = currentState.data.map(order => {\r\n        const updatedOrder = ensureOrderPackagingIdentifiers(order);\r\n        if (updatedOrder) {\r\n            changed = true;\r\n            return updatedOrder;\r\n        }\r\n        return order;\r\n    });\r\n\r\n    if (changed) {\r\n        baseStore.setState({ data: updatedData });\r\n    }\r\n};\r\n\r\nbackfillPackagingIdentifiers();\r\n\r\nconst augmentedMethods = {\r\n    cancelOrder: (\r\n        systemId: SystemId,\r\n        employeeId: SystemId,\r\n        options?: { reason?: string; restock?: boolean }\r\n    ) => {\r\n        const { reason, restock = true } = options ?? {};\r\n        const currentOrder = baseStore.getState().data.find(o => o.systemId === systemId);\r\n        if (!ensureCancellationAllowed(currentOrder, 'hủy đơn hàng')) {\r\n            return;\r\n        }\r\n\r\n        baseStore.setState(state => {\r\n            const orderToCancel = state.data.find(o => o.systemId === systemId);\r\n            if (!orderToCancel || orderToCancel.status === 'Đã hủy') {\r\n                return state;\r\n            }\r\n\r\n            const employee = useEmployeeStore.getState().findById(employeeId as SystemId);\r\n            const now = toISODateTime(new Date());\r\n            const cancellationReason = (reason && reason.trim().length > 0)\r\n                ? reason.trim()\r\n                : orderToCancel.cancellationReason || `Hủy bởi ${employee?.fullName || 'Hệ thống'}`;\r\n\r\n            // ✅ Uncommit stock (hỗ trợ combo)\r\n            if (restock) {\r\n                orderToCancel.lineItems.forEach(item => {\r\n                    processLineItemStock(item, orderToCancel.branchSystemId, 'uncommit', item.quantity);\r\n                });\r\n            }\r\n\r\n            const hasDispatchedStock = orderToCancel.stockOutStatus === 'Xuất kho toàn bộ'\r\n                || ['Chờ lấy hàng', 'Đang giao hàng', 'Đã giao hàng', 'Chờ giao lại'].includes(orderToCancel.deliveryStatus);\r\n\r\n            // ✅ Return stock from transit (hỗ trợ combo)\r\n            if (restock && hasDispatchedStock) {\r\n                orderToCancel.lineItems.forEach(item => {\r\n                    processLineItemStock(item, orderToCancel.branchSystemId, 'return', item.quantity);\r\n                });\r\n            }\r\n\r\n            const existingPayments = orderToCancel.payments ?? [];\r\n            const netCollected = existingPayments.reduce((sum, payment) => sum + payment.amount, 0);\r\n            let refundPaymentEntry: OrderPayment | null = null;\r\n            const refundAmount = netCollected > 0 ? netCollected : 0;\r\n\r\n            if (refundAmount > 0) {\r\n                const refundVoucher = createOrderRefundVoucher(orderToCancel, refundAmount, employeeId);\r\n                if (!refundVoucher) {\r\n                    alert('Không thể tạo phiếu chi hoàn tiền. Vui lòng kiểm tra cấu hình tài chính trước khi hủy đơn.');\r\n                    return state;\r\n                }\r\n\r\n                refundPaymentEntry = {\r\n                    systemId: refundVoucher.systemId,\r\n                    id: refundVoucher.id,\r\n                    date: refundVoucher.date,\r\n                    amount: -refundAmount,\r\n                    method: refundVoucher.paymentMethodName,\r\n                    createdBy: employeeId,\r\n                    description: `Hoàn tiền khi hủy đơn ${orderToCancel.id}`,\r\n                };\r\n            }\r\n\r\n            const updatedPayments = refundPaymentEntry ? [...existingPayments, refundPaymentEntry] : existingPayments;\r\n            const updatedPaidAmount = Math.max(0, (orderToCancel.paidAmount ?? 0) - refundAmount);\r\n            const updatedPackagings = orderToCancel.packagings.map(pkg => {\r\n                if (pkg.status === 'Hủy đóng gói' && pkg.deliveryStatus === 'Đã hủy') {\r\n                    return pkg;\r\n                }\r\n                return {\r\n                    ...pkg,\r\n                    status: 'Hủy đóng gói' as PackagingStatus,\r\n                    deliveryStatus: 'Đã hủy' as OrderDeliveryStatus,\r\n                    cancelDate: now,\r\n                    cancelReason: pkg.cancelReason ?? cancellationReason,\r\n                    cancelingEmployeeId: employeeId,\r\n                    cancelingEmployeeName: employee?.fullName || 'Hệ thống',\r\n                };\r\n            });\r\n\r\n            const updatedOrder = {\r\n                ...orderToCancel,\r\n                status: 'Đã hủy' as OrderMainStatus,\r\n                cancelledDate: now,\r\n                cancellationReason,\r\n                deliveryStatus: 'Đã hủy' as OrderDeliveryStatus,\r\n                stockOutStatus: restock ? 'Chưa xuất kho' as const : orderToCancel.stockOutStatus,\r\n                payments: updatedPayments,\r\n                paidAmount: updatedPaidAmount,\r\n                paymentStatus: refundPaymentEntry ? 'Chưa thanh toán' as OrderPaymentStatus : orderToCancel.paymentStatus,\r\n                packagings: updatedPackagings,\r\n                cancellationMetadata: {\r\n                    restockItems: restock,\r\n                    notifyCustomer: false,\r\n                    emailNotifiedAt: undefined,\r\n                },\r\n                activityHistory: appendHistoryEntry(\r\n                    orderToCancel.activityHistory,\r\n                    createHistoryEntry(\r\n                        'cancelled',\r\n                        getCurrentUserInfo(),\r\n                        `${employee?.fullName || 'Hệ thống'} đã hủy đơn hàng. Lý do: ${cancellationReason}${refundAmount > 0 ? `. Hoàn tiền: ${refundAmount.toLocaleString('vi-VN')}đ` : ''}`\r\n                    )\r\n                ),\r\n            };\r\n\r\n            // ✅ Remove debt transaction from customer\r\n            useCustomerStore.getState().removeDebtTransaction(orderToCancel.customerSystemId, orderToCancel.id);\r\n\r\n            return { data: state.data.map(o => (o.systemId === systemId ? updatedOrder : o)) };\r\n        });\r\n    },\r\n\r\n    addPayment: (orderSystemId: SystemId, paymentData: { amount: number; method: string }, employeeId: SystemId) => {\r\n        // --- Side effects must happen outside setState ---\r\n        const order = baseStore.getState().findById(orderSystemId as SystemId);\r\n        const employee = useEmployeeStore.getState().findById(employeeId as SystemId);\r\n\r\n        if (!order || !employee) {\r\n            console.error(\"Order or employee not found for payment.\");\r\n            return;\r\n        }\r\n\r\n        const { document: createdReceipt, error } = createReceiptDocument({\r\n            amount: paymentData.amount,\r\n            description: `Thanh toán cho đơn hàng ${order.id}`,\r\n            customerName: order.customerName,\r\n            customerSystemId: order.customerSystemId,\r\n            branchSystemId: order.branchSystemId,\r\n            branchName: order.branchName,\r\n            createdBy: employeeId,\r\n            paymentMethodName: paymentData.method,\r\n            receiptTypeName: 'Thanh toán cho đơn hàng',\r\n            originalDocumentId: order.id,\r\n            linkedOrderSystemId: order.systemId,\r\n            affectsDebt: true,\r\n        });\r\n\r\n        if (!createdReceipt) {\r\n            console.error('Failed to create receipt', error);\r\n            alert('Không thể tạo phiếu thu cho đơn hàng. Vui lòng kiểm tra cấu hình chứng từ.');\r\n            return;\r\n        }\r\n\r\n        // 2. Now, update the order state with the created receipt info\r\n        baseStore.setState(state => {\r\n            const orderIndex = state.data.findIndex(o => o.systemId === orderSystemId);\r\n            if (orderIndex === -1) return state;\r\n\r\n            const orderToUpdate = state.data[orderIndex];\r\n            const newPayment: OrderPayment = {\r\n                systemId: createdReceipt.systemId,\r\n                id: createdReceipt.id,\r\n                date: createdReceipt.date,\r\n                amount: createdReceipt.amount,\r\n                method: createdReceipt.paymentMethodName,\r\n                createdBy: asSystemId(createdReceipt.createdBy),\r\n                description: createdReceipt.description,\r\n            };\r\n\r\n            const updatedOrder = applyPaymentToOrder(orderToUpdate, newPayment);\r\n            \r\n            // ✅ Add activity history entry\r\n            updatedOrder.activityHistory = appendHistoryEntry(\r\n                orderToUpdate.activityHistory,\r\n                createHistoryEntry(\r\n                    'payment_made',\r\n                    getCurrentUserInfo(),\r\n                    `${employee?.fullName || 'Nhân viên'} đã thanh toán ${paymentData.amount.toLocaleString('vi-VN')}đ bằng ${paymentData.method}`\r\n                )\r\n            );\r\n            \r\n            const newData = [...state.data];\r\n            newData[orderIndex] = updatedOrder;\r\n\r\n            return { data: newData };\r\n        });\r\n    },\r\n\r\n    requestPackaging: (orderSystemId: SystemId, employeeId: SystemId, assignedEmployeeId?: SystemId) => {\r\n        baseStore.setState(state => {\r\n            const order = state.data.find(o => o.systemId === orderSystemId);\r\n            if (!order) return state;\r\n            const employee = useEmployeeStore.getState().findById(employeeId as SystemId);\r\n            const assignedEmployee = assignedEmployeeId ? useEmployeeStore.getState().findById(assignedEmployeeId as SystemId) : null;\r\n            \r\n            // Count only active packagings for proper numbering\r\n            const activePackagings = order.packagings.filter(p => p.status !== 'Hủy đóng gói');\r\n            const activeCountAfterInsert = activePackagings.length + 1;\r\n            const newActiveIndex = activePackagings.length; // This will be the index in active packagings\r\n            \r\n            const newPackaging: Packaging = {\r\n                systemId: getNextPackagingSystemId(), // ✅ Use proper format PACKAGE000001\r\n                id: buildPackagingBusinessId(order.id, newActiveIndex, activeCountAfterInsert),\r\n                requestDate: toISODateTime(new Date()),\r\n                requestingEmployeeId: employeeId,\r\n                requestingEmployeeName: employee?.fullName || 'N/A',\r\n                assignedEmployeeId,\r\n                assignedEmployeeName: assignedEmployee?.fullName,\r\n                status: 'Chờ đóng gói',\r\n                printStatus: 'Chưa in',\r\n            };\r\n\r\n            const updatedOrder = { ...order, packagings: [...order.packagings, newPackaging], deliveryStatus: 'Chờ đóng gói' as OrderDeliveryStatus };\r\n            return { data: state.data.map(o => o.systemId === orderSystemId ? updatedOrder : o) };\r\n        });\r\n    },\r\n\r\n    confirmPackaging: (orderSystemId: SystemId, packagingSystemId: SystemId, employeeId: SystemId) => {\r\n        // ✅ Check negative packing setting\r\n        const { allowNegativePacking } = useSalesManagementSettingsStore.getState();\r\n        if (!allowNegativePacking) {\r\n            const order = baseStore.getState().data.find(o => o.systemId === orderSystemId);\r\n            if (order) {\r\n                const { findById: findProductById } = useProductStore.getState();\r\n                for (const item of order.lineItems) {\r\n                    const product = findProductById(asSystemId(item.productSystemId));\r\n                    \r\n                    if (product && isComboProduct(product) && product.comboItems) {\r\n                        for (const comboItem of product.comboItems) {\r\n                            const childProduct = findProductById(asSystemId(comboItem.productSystemId));\r\n                            const requiredQty = item.quantity * comboItem.quantity;\r\n                            const currentStock = childProduct?.inventoryByBranch?.[order.branchSystemId] || 0;\r\n                            if (currentStock < requiredQty) {\r\n                                alert(`Không thể đóng gói: Sản phẩm \"${childProduct?.name}\" không đủ tồn kho (Có: ${currentStock}, Cần: ${requiredQty})`);\r\n                                return baseStore.getState();\r\n                            }\r\n                        }\r\n                    } else {\r\n                        const currentStock = product?.inventoryByBranch?.[order.branchSystemId] || 0;\r\n                        if (currentStock < item.quantity) {\r\n                            alert(`Không thể đóng gói: Sản phẩm \"${item.productName}\" không đủ tồn kho (Có: ${currentStock}, Cần: ${item.quantity})`);\r\n                            return baseStore.getState();\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        }\r\n\r\n        baseStore.setState(state => {\r\n            const dataCopy = [...state.data];\r\n            const orderIndex = dataCopy.findIndex(o => o.systemId === orderSystemId);\r\n            if (orderIndex === -1) return state;\r\n    \r\n        const orderCopy = { ...dataCopy[orderIndex] };\r\n            const packagingIndex = orderCopy.packagings.findIndex(p => p.systemId === packagingSystemId);\r\n            if (packagingIndex === -1) return state;\r\n            \r\n            const employee = useEmployeeStore.getState().findById(employeeId as SystemId);\r\n    \r\n        const packagingsCopy = [...orderCopy.packagings];\r\n            packagingsCopy[packagingIndex] = {\r\n                ...packagingsCopy[packagingIndex],\r\n                status: 'Đã đóng gói' as PackagingStatus,\r\n                confirmDate: toISODateTime(new Date()),\r\n                confirmingEmployeeId: employeeId,\r\n                confirmingEmployeeName: employee?.fullName || 'N/A',\r\n            };\r\n    \r\n        orderCopy.packagings = packagingsCopy;\r\n        orderCopy.deliveryStatus = 'Đã đóng gói' as OrderDeliveryStatus;\r\n            \r\n            dataCopy[orderIndex] = orderCopy;\r\n    \r\n        return { data: dataCopy };\r\n        });\r\n    },\r\n\r\n    cancelPackagingRequest: (orderSystemId: SystemId, packagingSystemId: SystemId, employeeId: SystemId, reason: string) => {\r\n        baseStore.setState(state => {\r\n             const order = state.data.find(o => o.systemId === orderSystemId);\r\n            if (!order) return state;\r\n            const employee = useEmployeeStore.getState().findById(employeeId as SystemId);\r\n\r\n            const updatedPackagings = order.packagings.map(p => {\r\n                if (p.systemId === packagingSystemId) {\r\n                    return {\r\n                        ...p,\r\n                        status: 'Hủy đóng gói' as PackagingStatus,\r\n                        cancelDate: toISODateTime(new Date()),\r\n                        cancelingEmployeeId: employeeId,\r\n                        cancelingEmployeeName: employee?.fullName || 'N/A',\r\n                        cancelReason: reason,\r\n                    };\r\n                }\r\n                return p;\r\n            });\r\n            const isAnyActivePackaging = updatedPackagings.some(p => p.status !== 'Hủy đóng gói');\r\n            const updatedOrder = { ...order, packagings: updatedPackagings, deliveryStatus: isAnyActivePackaging ? order.deliveryStatus : 'Chờ đóng gói' as OrderDeliveryStatus };\r\n            return { data: state.data.map(o => o.systemId === orderSystemId ? updatedOrder : o) };\r\n        });\r\n    },\r\n    \r\n    processInStorePickup: (orderSystemId: SystemId, packagingSystemId: SystemId) => {\r\n        baseStore.setState(state => {\r\n            const order = state.data.find(o => o.systemId === orderSystemId);\r\n            if (!order) return state;\r\n    \r\n            const totalCount = order.packagings.length;\r\n            const updatedPackagings = order.packagings.map((p, index) => {\r\n                if (p.systemId === packagingSystemId) {\r\n                    const hasId = typeof p.id === 'string' && p.id.trim().length > 0;\r\n                    const resolvedId = hasId ? p.id : buildPackagingBusinessId(order.id, index, totalCount);\r\n                    return {\r\n                        ...p,\r\n                        id: resolvedId,\r\n                        deliveryMethod: 'Nhận tại cửa hàng' as OrderDeliveryMethod,\r\n                        deliveryStatus: 'Đã đóng gói' as OrderDeliveryStatus,\r\n                        // trackingCode will be set when shipment is created in confirmInStorePickup\r\n                    };\r\n                }\r\n                return p;\r\n            });\r\n            \r\n            const updatedOrder = { \r\n                ...order, \r\n                packagings: updatedPackagings, \r\n                deliveryStatus: 'Đã đóng gói' as OrderDeliveryStatus \r\n            };\r\n    \r\n            return { data: state.data.map(o => o.systemId === orderSystemId ? updatedOrder : o) };\r\n        });\r\n    },\r\n    \r\n    confirmInStorePickup: (orderSystemId: SystemId, packagingSystemId: SystemId, employeeId: SystemId) => {\r\n        console.log('🟢 [confirmInStorePickup] Called with:', { orderSystemId, packagingSystemId, employeeId });\r\n        \r\n        // ✅ Check negative stock out setting\r\n        const { allowNegativeStockOut } = useSalesManagementSettingsStore.getState();\r\n        if (!allowNegativeStockOut) {\r\n            const order = baseStore.getState().data.find(o => o.systemId === orderSystemId);\r\n            if (order) {\r\n                const { findById: findProductById } = useProductStore.getState();\r\n                for (const item of order.lineItems) {\r\n                    const product = findProductById(asSystemId(item.productSystemId));\r\n                    \r\n                    if (product && isComboProduct(product) && product.comboItems) {\r\n                        for (const comboItem of product.comboItems) {\r\n                            const childProduct = findProductById(asSystemId(comboItem.productSystemId));\r\n                            const requiredQty = item.quantity * comboItem.quantity;\r\n                            const currentStock = childProduct?.inventoryByBranch?.[order.branchSystemId] || 0;\r\n                            if (currentStock < requiredQty) {\r\n                                alert(`Không thể xuất kho: Sản phẩm \"${childProduct?.name}\" không đủ tồn kho (Có: ${currentStock}, Cần: ${requiredQty})`);\r\n                                return baseStore.getState();\r\n                            }\r\n                        }\r\n                    } else {\r\n                        const currentStock = product?.inventoryByBranch?.[order.branchSystemId] || 0;\r\n                        if (currentStock < item.quantity) {\r\n                            alert(`Không thể xuất kho: Sản phẩm \"${item.productName}\" không đủ tồn kho (Có: ${currentStock}, Cần: ${item.quantity})`);\r\n                            return baseStore.getState();\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        }\r\n\r\n        baseStore.setState(state => {\r\n            const order = state.data.find(o => o.systemId === orderSystemId);\r\n            if (!order) {\r\n                console.error('❌ [confirmInStorePickup] Order not found:', orderSystemId);\r\n                return state;\r\n            }\r\n    \r\n            console.log('📋 [confirmInStorePickup] Order found:', order.id);\r\n            console.log('📋 [confirmInStorePickup] Line items:', order.lineItems.length);\r\n            \r\n            // Stock logic\r\n            const { addEntry: addStockHistory } = useStockHistoryStore.getState();\r\n            const employeeData = useEmployeeStore.getState().findById(employeeId as SystemId);\r\n            const now = toISODateTime(new Date());\r\n    \r\n            order.lineItems.forEach((item, index) => {\r\n                console.log(`📦 [confirmInStorePickup] Dispatching item ${index + 1}:`, {\r\n                    productSystemId: item.productSystemId,\r\n                    productName: item.productName,\r\n                    quantity: item.quantity,\r\n                    branchSystemId: getBranchId(order)\r\n                });\r\n                \r\n                // ✅ Dispatch stock (hỗ trợ combo - sẽ dispatch SP con)\r\n                const processedItems = processLineItemStock(item, getBranchId(order), 'dispatch', item.quantity);\r\n                \r\n                // ✅ Add stock history entry for each processed item (SP con nếu combo)\r\n                processedItems.forEach(processedItem => {\r\n                    const product = useProductStore.getState().findById(processedItem.productSystemId);\r\n                    const currentStock = product?.inventoryByBranch?.[getBranchId(order)] || 0;\r\n                    \r\n                    addStockHistory({\r\n                        date: now,\r\n                        productId: processedItem.productSystemId,\r\n                        action: 'Xuất kho (Đơn hàng)',\r\n                        quantityChange: -processedItem.quantity,\r\n                        newStockLevel: currentStock, // After dispatch\r\n                        documentId: order.id,\r\n                        branchSystemId: getBranchId(order),\r\n                        branch: order.branchName,\r\n                        employeeName: employeeData?.fullName || 'Hệ thống',\r\n                    });\r\n                });\r\n            });\r\n    \r\n            // Status update logic - will be updated with trackingCode after shipment creation\r\n            let updatedPackagings = order.packagings.map(p => {\r\n                if (p.systemId === packagingSystemId) {\r\n                    return { \r\n                        ...p, \r\n                        deliveryStatus: 'Đã giao hàng' as OrderDeliveryStatus, \r\n                        deliveredDate: toISODateTime(new Date()) \r\n                    };\r\n                }\r\n                return p;\r\n            });\r\n    \r\n            const isAllDelivered = updatedPackagings.every(p => p.status === 'Hủy đóng gói' || p.deliveryStatus === 'Đã giao hàng');\r\n            \r\n            let newStatus = order.status === 'Đặt hàng' ? 'Đang giao dịch' : order.status;\r\n            let newCompletedDate = order.completedDate;\r\n            if (isAllDelivered && order.paymentStatus === 'Thanh toán toàn bộ') {\r\n                newStatus = 'Hoàn thành';\r\n                newCompletedDate = toISODateTime(new Date());\r\n            }\r\n    \r\n            \r\n            const employee = useEmployeeStore.getState().findById(employeeId as SystemId);\r\n            \r\n            // ✅ Create shipment record for INSTORE pickup\r\n            const packaging = order.packagings.find(p => p.systemId === packagingSystemId);\r\n            let newShipment: Shipment | null = null;\r\n            if (packaging) {\r\n                const { createShipment, updateShipment } = useShipmentStore.getState();\r\n                newShipment = createShipment({\r\n                    packagingSystemId: packagingSystemId,\r\n                    orderSystemId: orderSystemId,\r\n                    orderId: order.id,\r\n                    trackingCode: '', // Will be set to shipment business ID below\r\n                    carrier: 'Nhận tại cửa hàng',\r\n                    service: 'Nhận tại cửa hàng',\r\n                    deliveryStatus: 'Đã giao hàng',\r\n                    printStatus: 'Chưa in',\r\n                    reconciliationStatus: 'Chưa đối soát',\r\n                    shippingFeeToPartner: 0,\r\n                    codAmount: 0,\r\n                    payer: 'Người gửi',\r\n                    createdAt: now,\r\n                    dispatchedAt: now,\r\n                    deliveredAt: now,\r\n                });\r\n                // Update shipment trackingCode to use its own business ID\r\n                if (newShipment) {\r\n                    updateShipment(newShipment.systemId, {\r\n                        trackingCode: newShipment.id, // Use shipment business ID (VC000XXX)\r\n                    });\r\n                    // Update packaging with shipment trackingCode\r\n                    updatedPackagings = updatedPackagings.map(p => {\r\n                        if (p.systemId === packagingSystemId) {\r\n                            return { ...p, trackingCode: newShipment!.id };\r\n                        }\r\n                        return p;\r\n                    });\r\n                }\r\n                console.log('✅ [confirmInStorePickup] Shipment created:', newShipment?.id);\r\n            }\r\n            \r\n            const updatedOrder = { \r\n                ...order, \r\n                packagings: updatedPackagings, \r\n                deliveryStatus: 'Đã giao hàng' as OrderDeliveryStatus,\r\n                status: newStatus,\r\n                completedDate: newCompletedDate,\r\n                stockOutStatus: 'Xuất kho toàn bộ' as const,\r\n                dispatchedDate: toISODateTime(new Date()),\r\n                dispatchedByEmployeeId: employeeId,\r\n                dispatchedByEmployeeName: employee?.fullName,\r\n            };\r\n    \r\n            console.log('✅ [confirmInStorePickup] Stock dispatched successfully');\r\n            return { data: state.data.map(o => o.systemId === orderSystemId ? updatedOrder : o) };\r\n        });\r\n    },    \r\n    confirmPartnerShipment: async (orderSystemId: SystemId, packagingSystemId: SystemId, shipmentData: any): Promise<{ success: boolean; message: string }> => {\r\n        try {\r\n            const order = baseStore.getState().data.find(o => o.systemId === orderSystemId);\r\n            if (!order) {\r\n                return { success: false, message: 'Không tìm thấy đơn hàng' };\r\n            }\r\n\r\n            // ✅ Check negative packing setting (covers creating shipment)\r\n            const { allowNegativePacking } = useSalesManagementSettingsStore.getState();\r\n            if (!allowNegativePacking) {\r\n                const { findById: findProductById } = useProductStore.getState();\r\n                for (const item of order.lineItems) {\r\n                    const product = findProductById(asSystemId(item.productSystemId));\r\n                    \r\n                    if (product && isComboProduct(product) && product.comboItems) {\r\n                        for (const comboItem of product.comboItems) {\r\n                            const childProduct = findProductById(asSystemId(comboItem.productSystemId));\r\n                            const requiredQty = item.quantity * comboItem.quantity;\r\n                            const currentStock = childProduct?.inventoryByBranch?.[order.branchSystemId] || 0;\r\n                            if (currentStock < requiredQty) {\r\n                                return { success: false, message: `Không thể tạo vận đơn: Sản phẩm \"${childProduct?.name}\" không đủ tồn kho` };\r\n                            }\r\n                        }\r\n                    } else {\r\n                        const currentStock = product?.inventoryByBranch?.[order.branchSystemId] || 0;\r\n                        if (currentStock < item.quantity) {\r\n                            return { success: false, message: `Không thể tạo vận đơn: Sản phẩm \"${item.productName}\" không đủ tồn kho` };\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n\r\n            // ✅ Get GHTK preview params from window (set by ShippingIntegration)\r\n            const ghtkParams = (window as any).__ghtkPreviewParams;\r\n            \r\n            if (!ghtkParams) {\r\n                return { success: false, message: 'Thiếu thông tin vận chuyển. Vui lòng chọn dịch vụ vận chuyển.' };\r\n            }\r\n\r\n            // ✅ Import GHTK service dynamically\r\n            const { GHTKService } = await import('../settings/shipping/integrations/ghtk-service');\r\n            const { getGHTKCredentials } = await import('../../lib/utils/get-shipping-credentials');\r\n            \r\n            const { apiToken, partnerCode } = getGHTKCredentials();\r\n            const ghtkService = new GHTKService(apiToken, partnerCode);\r\n\r\n            console.log('📤 [confirmPartnerShipment] Calling GHTK API with params:', ghtkParams);\r\n\r\n            // ✅ Call real GHTK API\r\n            const result = await ghtkService.createOrder(ghtkParams);\r\n\r\n            if (!result.success || !result.order) {\r\n                throw new Error(result.message || 'Không thể tạo đơn vận chuyển');\r\n            }\r\n\r\n            // ✅ Update order with real tracking code from GHTK\r\n            const trackingCode = result.order.label;\r\n            const ghtkTrackingId = result.order.tracking_id;\r\n            const estimatedPickTime = result.order.estimated_pick_time;\r\n            const estimatedDeliverTime = result.order.estimated_deliver_time;\r\n\r\n            baseStore.setState(state => {\r\n                const updatedPackagings = order.packagings.map(p => {\r\n                    if (p.systemId === packagingSystemId) {\r\n                        return {\r\n                            ...p,\r\n                            deliveryMethod: 'Dịch vụ giao hàng' as OrderDeliveryMethod,\r\n                            deliveryStatus: 'Chờ lấy hàng' as OrderDeliveryStatus,\r\n                            carrier: 'GHTK',\r\n                            service: result.order?.fee ? `${result.order.fee}đ` : 'Standard',\r\n                            trackingCode: trackingCode,\r\n                            shippingFeeToPartner: parseInt(result.order?.fee || '0') || 0,\r\n                            codAmount: ghtkParams.pick_money || 0,\r\n                            payer: (ghtkParams.is_freeship === 1 ? 'Người gửi' : 'Người nhận') as 'Người gửi' | 'Người nhận',\r\n                            noteToShipper: ghtkParams.note || '',\r\n                            weight: ghtkParams.weight,\r\n                            dimensions: `${ghtkParams.products?.[0]?.length || 10}×${ghtkParams.products?.[0]?.width || 10}×${ghtkParams.products?.[0]?.height || 10}`,\r\n                            // ✅ Store GHTK specific data\r\n                            ghtkTrackingId: String(ghtkTrackingId),\r\n                            estimatedPickTime: estimatedPickTime,\r\n                            estimatedDeliverTime: estimatedDeliverTime,\r\n                        };\r\n                    }\r\n                    return p;\r\n                });\r\n                \r\n                const updatedOrder = { \r\n                    ...order, \r\n                    packagings: updatedPackagings, \r\n                    deliveryStatus: 'Chờ lấy hàng' as OrderDeliveryStatus, \r\n                    status: 'Đang giao dịch' as OrderMainStatus \r\n                };\r\n                \r\n                return { data: state.data.map(o => o.systemId === orderSystemId ? updatedOrder : o) };\r\n            });\r\n\r\n            console.log('✅ [confirmPartnerShipment] GHTK order created successfully:', {\r\n                trackingCode,\r\n                ghtkTrackingId,\r\n                estimatedPickTime,\r\n                estimatedDeliverTime\r\n            });\r\n\r\n            return { \r\n                success: true, \r\n                message: `Tạo vận đơn thành công! Mã vận đơn: ${trackingCode}` \r\n            };\r\n\r\n        } catch (error) {\r\n            console.error('❌ [confirmPartnerShipment] Error:', error);\r\n            \r\n            let errorMessage = 'Vui lòng thử lại';\r\n            if (error instanceof Error) {\r\n                errorMessage = error.message;\r\n            }\r\n            \r\n            return { \r\n                success: false, \r\n                message: `Lỗi tạo đơn vận chuyển: ${errorMessage}` \r\n            };\r\n        }\r\n    },\r\n\r\n    dispatchFromWarehouse: (orderSystemId: SystemId, packagingSystemId: SystemId, employeeId: SystemId) => {\r\n        // ✅ Check negative stock out setting\r\n        const { allowNegativeStockOut } = useSalesManagementSettingsStore.getState();\r\n        if (!allowNegativeStockOut) {\r\n            const order = baseStore.getState().data.find(o => o.systemId === orderSystemId);\r\n            if (order) {\r\n                const { findById: findProductById } = useProductStore.getState();\r\n                for (const item of order.lineItems) {\r\n                    const product = findProductById(asSystemId(item.productSystemId));\r\n                    \r\n                    if (product && isComboProduct(product) && product.comboItems) {\r\n                        for (const comboItem of product.comboItems) {\r\n                            const childProduct = findProductById(asSystemId(comboItem.productSystemId));\r\n                            const requiredQty = item.quantity * comboItem.quantity;\r\n                            const currentStock = childProduct?.inventoryByBranch?.[order.branchSystemId] || 0;\r\n                            if (currentStock < requiredQty) {\r\n                                alert(`Không thể xuất kho: Sản phẩm \"${childProduct?.name}\" không đủ tồn kho (Có: ${currentStock}, Cần: ${requiredQty})`);\r\n                                return baseStore.getState();\r\n                            }\r\n                        }\r\n                    } else {\r\n                        const currentStock = product?.inventoryByBranch?.[order.branchSystemId] || 0;\r\n                        if (currentStock < item.quantity) {\r\n                            alert(`Không thể xuất kho: Sản phẩm \"${item.productName}\" không đủ tồn kho (Có: ${currentStock}, Cần: ${item.quantity})`);\r\n                            return baseStore.getState();\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        }\r\n\r\n        baseStore.setState(state => {\r\n            const order = state.data.find(o => o.systemId === orderSystemId);\r\n            if (!order) return state;\r\n\r\n            const { addEntry: addStockHistory } = useStockHistoryStore.getState();\r\n            const employeeData = useEmployeeStore.getState().findById(employeeId as SystemId);\r\n            const now = toISODateTime(new Date());\r\n            \r\n            order.lineItems.forEach(item => {\r\n                // ✅ Dispatch stock (hỗ trợ combo - sẽ dispatch SP con)\r\n                const processedItems = processLineItemStock(item, getBranchId(order), 'dispatch', item.quantity);\r\n                \r\n                // ✅ Add stock history entry for each processed item\r\n                processedItems.forEach(processedItem => {\r\n                    const product = useProductStore.getState().findById(processedItem.productSystemId);\r\n                    const currentStock = product?.inventoryByBranch?.[getBranchId(order)] || 0;\r\n                    \r\n                    addStockHistory({\r\n                        date: now,\r\n                        productId: processedItem.productSystemId,\r\n                        action: 'Xuất kho (Đơn hàng)',\r\n                        quantityChange: -processedItem.quantity,\r\n                        newStockLevel: currentStock,\r\n                        documentId: order.id,\r\n                        branchSystemId: getBranchId(order),\r\n                        branch: order.branchName,\r\n                        employeeName: employeeData?.fullName || 'Hệ thống',\r\n                    });\r\n                });\r\n            });\r\n            \r\n            const now2 = toISODateTime(new Date());\r\n            \r\n            const updatedPackagings = order.packagings.map(p => \r\n                p.systemId === packagingSystemId ? { ...p, deliveryStatus: 'Đang giao hàng' as OrderDeliveryStatus } : p\r\n            );\r\n\r\n            const updatedOrder = {\r\n                ...order,\r\n                packagings: updatedPackagings,\r\n                deliveryStatus: 'Đang giao hàng' as OrderDeliveryStatus,\r\n                stockOutStatus: 'Xuất kho toàn bộ' as const,\r\n                dispatchedDate: now2,\r\n                dispatchedByEmployeeId: employeeId,\r\n                dispatchedByEmployeeName: employeeData?.fullName,\r\n                status: order.status === 'Đặt hàng' ? 'Đang giao dịch' : order.status,\r\n            };\r\n            return { data: state.data.map(o => o.systemId === orderSystemId ? updatedOrder : o) };\r\n        });\r\n    },\r\n\r\n    completeDelivery: (orderSystemId: SystemId, packagingSystemId: SystemId, employeeId: SystemId) => {\r\n        baseStore.setState(state => {\r\n            const order = state.data.find(o => o.systemId === orderSystemId);\r\n            if (!order) return state;\r\n            \r\n            // ✅ Complete delivery (hỗ trợ combo - sẽ complete SP con)\r\n            order.lineItems.forEach(item => {\r\n                processLineItemStock(item, getBranchId(order), 'complete', item.quantity);\r\n            });\r\n\r\n            const updatedPackagings = order.packagings.map(p => \r\n                p.systemId === packagingSystemId ? { ...p, deliveryStatus: 'Đã giao hàng' as OrderDeliveryStatus, deliveredDate: toISODateTime(new Date()) } : p\r\n            );\r\n            \r\n            const isAllDelivered = updatedPackagings.every(p => p.status === 'Hủy đóng gói' || p.deliveryStatus === 'Đã giao hàng');\r\n            let newStatus = order.status;\r\n            let newCompletedDate = order.completedDate;\r\n            \r\n            // ✅ Khi tất cả đơn đã giao → tạo công nợ (nếu có) và cập nhật stats\r\n            if (isAllDelivered && order.status !== 'Hoàn thành') {\r\n                // Tính công nợ còn lại\r\n                const totalPaid = (order.payments || []).reduce((sum, p) => sum + p.amount, 0);\r\n                const debtAmount = Math.max(0, order.grandTotal - totalPaid);\r\n                \r\n                // ✅ Tạo công nợ CHỈ KHI giao hàng thành công\r\n                if (debtAmount > 0) {\r\n                    const { addDebtTransaction } = useCustomerStore.getState();\r\n                    const dueDate = new Date();\r\n                    dueDate.setDate(dueDate.getDate() + 30);\r\n                    addDebtTransaction(order.customerSystemId, {\r\n                        systemId: asSystemId(`DEBT_${order.systemId}`),\r\n                        orderId: order.id,\r\n                        orderDate: order.orderDate.split('T')[0],\r\n                        amount: debtAmount,\r\n                        dueDate: dueDate.toISOString().split('T')[0],\r\n                        isPaid: false,\r\n                        remainingAmount: debtAmount,\r\n                        notes: 'Công nợ từ đơn hàng đã giao thành công',\r\n                    });\r\n                }\r\n                \r\n                // Update customer stats\r\n                const { incrementOrderStats } = useCustomerStore.getState();\r\n                incrementOrderStats(order.customerSystemId, order.grandTotal);\r\n            }\r\n            \r\n            // Check if order is fully complete (delivered + fully paid)\r\n            if (isAllDelivered && order.paymentStatus === 'Thanh toán toàn bộ') {\r\n                newStatus = 'Hoàn thành';\r\n                newCompletedDate = toISODateTime(new Date());\r\n            }\r\n\r\n            const employee = useEmployeeStore.getState().findById(employeeId as SystemId);\r\n            const updatedOrder = { \r\n                ...order, \r\n                packagings: updatedPackagings, \r\n                deliveryStatus: 'Đã giao hàng' as OrderDeliveryStatus, \r\n                status: newStatus, \r\n                completedDate: newCompletedDate,\r\n                activityHistory: appendHistoryEntry(\r\n                    order.activityHistory,\r\n                    createHistoryEntry(\r\n                        'status_changed',\r\n                        getCurrentUserInfo(),\r\n                        `${employee?.fullName || 'Nhân viên'} đã xác nhận giao hàng thành công${newStatus === 'Hoàn thành' ? '. Đơn hàng hoàn thành' : ''}`\r\n                    )\r\n                ),\r\n            };\r\n            return { data: state.data.map(o => o.systemId === orderSystemId ? updatedOrder : o) };\r\n        });\r\n    },\r\n\r\n    failDelivery: (orderSystemId: SystemId, packagingSystemId: SystemId, employeeId: SystemId, reason: string) => {\r\n        baseStore.setState(state => {\r\n            const order = state.data.find(o => o.systemId === orderSystemId);\r\n            if (!order) return state;\r\n            const { incrementFailedDeliveryStats } = useCustomerStore.getState();\r\n            \r\n            // ✅ Return stock from transit (hỗ trợ combo - sẽ return SP con)\r\n            order.lineItems.forEach(item => {\r\n                processLineItemStock(item, getBranchId(order), 'return', item.quantity);\r\n            });\r\n\r\n            // ✅ Update customer failed delivery stats\r\n            incrementFailedDeliveryStats(order.customerSystemId);\r\n\r\n            const updatedPackagings = order.packagings.map(p => \r\n                p.systemId === packagingSystemId ? { ...p, deliveryStatus: 'Chờ giao lại' as OrderDeliveryStatus, notes: `Giao thất bại: ${reason}` } : p\r\n            );\r\n            \r\n            const updatedOrder = { ...order, packagings: updatedPackagings, deliveryStatus: 'Chờ giao lại' as OrderDeliveryStatus };\r\n            return { data: state.data.map(o => o.systemId === orderSystemId ? updatedOrder : o) };\r\n         });\r\n    },\r\n\r\n    // ✅ Hủy giao hàng - KHÔNG trả hàng về kho (hàng bị thất tung/shipper giữ)\r\n    cancelDeliveryOnly: (orderSystemId: SystemId, packagingSystemId: SystemId, employeeId: SystemId, reason: string) => {\r\n        const currentOrder = baseStore.getState().data.find(o => o.systemId === orderSystemId);\r\n        if (!ensureCancellationAllowed(currentOrder, 'hủy giao hàng')) {\r\n            return;\r\n        }\r\n\r\n        baseStore.setState(state => {\r\n            const order = state.data.find(o => o.systemId === orderSystemId);\r\n            if (!order) return state;\r\n\r\n            // ✅ Get employee info for canceller\r\n            const employeeData = useEmployeeStore.getState().findById(employeeId as SystemId);\r\n\r\n            const updatedPackagings = order.packagings.map(p => \r\n                p.systemId === packagingSystemId ? { \r\n                    ...p, \r\n                    status: 'Hủy đóng gói' as PackagingStatus,\r\n                    deliveryStatus: 'Đã hủy' as OrderDeliveryStatus,\r\n                    cancelReason: `Hủy giao hàng: ${reason}`, \r\n                    cancelDate: toISODateTime(new Date()),\r\n                    cancelingEmployeeId: employeeId,\r\n                    cancelingEmployeeName: employeeData?.fullName || 'Hệ thống',\r\n                } : p\r\n            );\r\n            \r\n            // ✅ Check if all packagings are cancelled, update order status accordingly\r\n            const allCancelled = updatedPackagings.every(p => p.deliveryStatus === 'Đã hủy' || p.status === 'Hủy đóng gói');\r\n            const hasAnyActive = updatedPackagings.some(p => p.deliveryStatus && p.deliveryStatus !== 'Đã hủy' && p.status !== 'Hủy đóng gói');\r\n            \r\n            let newOrderStatus = order.status;\r\n            let newDeliveryStatus = order.deliveryStatus;\r\n            \r\n            if (allCancelled) {\r\n                // All packagings cancelled → order goes back to pending state\r\n                newOrderStatus = 'Đang giao dịch' as OrderMainStatus;\r\n                newDeliveryStatus = 'Chưa giao hàng' as OrderDeliveryStatus;\r\n            } else if (hasAnyActive) {\r\n                // Some packagings still active → keep current delivery status of remaining active packaging\r\n                const activePackaging = updatedPackagings.find(p => p.deliveryStatus && p.deliveryStatus !== 'Đã hủy');\r\n                if (activePackaging?.deliveryStatus) {\r\n                    newDeliveryStatus = activePackaging.deliveryStatus;\r\n                }\r\n            }\r\n            \r\n            const updatedOrder = { \r\n                ...order, \r\n                packagings: updatedPackagings,\r\n                status: newOrderStatus,\r\n                deliveryStatus: newDeliveryStatus\r\n            };\r\n            return { data: state.data.map(o => o.systemId === orderSystemId ? updatedOrder : o) };\r\n         });\r\n    },\r\n\r\n    // ✅ Hủy giao và nhận lại hàng - TRẢ hàng về kho (đã nhận lại từ shipper)\r\n    cancelDelivery: (orderSystemId: SystemId, packagingSystemId: SystemId, employeeId: SystemId, reason: string) => {\r\n        const currentOrder = baseStore.getState().data.find(o => o.systemId === orderSystemId);\r\n        if (!ensureCancellationAllowed(currentOrder, 'hủy giao hàng')) {\r\n            return;\r\n        }\r\n\r\n         baseStore.setState(state => {\r\n            const order = state.data.find(o => o.systemId === orderSystemId);\r\n            if (!order) return state;\r\n            \r\n            // ✅ TRẢ hàng từ \"đang giao\" về \"tồn kho\" (hỗ trợ combo - sẽ return SP con)\r\n            order.lineItems.forEach(item => {\r\n                processLineItemStock(item, getBranchId(order), 'return', item.quantity);\r\n            });\r\n\r\n            // ✅ Get employee info for canceller\r\n            const employeeData = useEmployeeStore.getState().findById(employeeId as SystemId);\r\n\r\n            const updatedPackagings = order.packagings.map(p => \r\n                p.systemId === packagingSystemId ? { \r\n                    ...p, \r\n                    status: 'Hủy đóng gói' as PackagingStatus,\r\n                    deliveryStatus: 'Đã hủy' as OrderDeliveryStatus,\r\n                    cancelReason: `Hủy giao hàng: ${reason}`, \r\n                    cancelDate: toISODateTime(new Date()),\r\n                    cancelingEmployeeId: employeeId,\r\n                    cancelingEmployeeName: employeeData?.fullName || 'Hệ thống',\r\n                } : p\r\n            );\r\n            \r\n            // ✅ Check if all packagings are cancelled, update order status accordingly\r\n            const allCancelled = updatedPackagings.every(p => p.deliveryStatus === 'Đã hủy' || p.status === 'Hủy đóng gói');\r\n            const hasAnyActive = updatedPackagings.some(p => p.deliveryStatus && p.deliveryStatus !== 'Đã hủy' && p.status !== 'Hủy đóng gói');\r\n            \r\n            let newOrderStatus = order.status;\r\n            let newDeliveryStatus = order.deliveryStatus;\r\n            \r\n            if (allCancelled) {\r\n                // All packagings cancelled → order goes back to pending state\r\n                newOrderStatus = 'Đang giao dịch' as OrderMainStatus;\r\n                newDeliveryStatus = 'Chưa giao hàng' as OrderDeliveryStatus;\r\n            } else if (hasAnyActive) {\r\n                // Some packagings still active → keep current delivery status of remaining active packaging\r\n                const activePackaging = updatedPackagings.find(p => p.deliveryStatus && p.deliveryStatus !== 'Đã hủy');\r\n                if (activePackaging?.deliveryStatus) {\r\n                    newDeliveryStatus = activePackaging.deliveryStatus;\r\n                }\r\n            }\r\n            \r\n            const updatedOrder = { \r\n                ...order, \r\n                packagings: updatedPackagings,\r\n                status: newOrderStatus,\r\n                deliveryStatus: newDeliveryStatus\r\n            };\r\n            return { data: state.data.map(o => o.systemId === orderSystemId ? updatedOrder : o) };\r\n         });\r\n    },\r\n\r\n    confirmCodReconciliation: (shipments: (Packaging & { orderSystemId: SystemId })[], employeeId: SystemId) => {\r\n        const { add: addReceipt } = useReceiptStore.getState();\r\n        const { accounts } = useCashbookStore.getState();\r\n        const { data: receiptTypes } = useReceiptTypeStore.getState();\r\n        const employee = useEmployeeStore.getState().findById(employeeId as SystemId);\r\n        const allOrders = baseStore.getState().data;\r\n    \r\n        const totalByPartnerAndBranch: Record<string, { total: number; ids: string[]; branchSystemId: string; branchName: string; partnerName: string; shipmentSystemIds: string[] }> = {};\r\n    \r\n        shipments.forEach(shipment => {\r\n            const order = allOrders.find(o => o.systemId === shipment.orderSystemId);\r\n            if (!order || !shipment.carrier) return;\r\n    \r\n            const key = `${shipment.carrier}-${getBranchId(order)}`;\r\n            if (!totalByPartnerAndBranch[key]) {\r\n                totalByPartnerAndBranch[key] = { total: 0, ids: [], branchSystemId: getBranchId(order), branchName: order.branchName, partnerName: shipment.carrier, shipmentSystemIds: [] };\r\n            }\r\n            totalByPartnerAndBranch[key].total += shipment.codAmount || 0;\r\n            totalByPartnerAndBranch[key].ids.push(shipment.trackingCode || shipment.id);\r\n            totalByPartnerAndBranch[key].shipmentSystemIds.push(shipment.systemId);\r\n        });\r\n    \r\n        const createdReceipts: (any & { shipmentSystemIds: string[] })[] = [];\r\n    \r\n        Object.values(totalByPartnerAndBranch).forEach(group => {\r\n            const account = accounts.find(acc => acc.type === 'bank' && acc.branchSystemId === group.branchSystemId) || accounts.find(acc => acc.type === 'bank');\r\n            const category = receiptTypes.find(c => c.id === 'DOISOATCOD');\r\n            if (account && category) {\r\n                const newReceiptData = {\r\n                    id: '',\r\n                    date: toISODateTime(new Date()),\r\n                    amount: group.total,\r\n                    payerType: 'Đối tác vận chuyển',\r\n                    payerName: group.partnerName,\r\n                    description: `Đối soát COD cho các vận đơn: ${group.ids.join(', ')}`,\r\n                    paymentMethod: 'Chuyển khoản',\r\n                    accountSystemId: account.systemId,\r\n                    originalDocumentId: group.ids.join(', '),\r\n                    createdBy: employee?.fullName || 'N/A',\r\n                    branchSystemId: group.branchSystemId,\r\n                    branchName: group.branchName,\r\n                    paymentReceiptTypeSystemId: category.systemId,\r\n                    paymentReceiptTypeName: category.name,\r\n                    status: 'completed' as const,\r\n                    createdAt: toISODateTime(new Date()),\r\n                    updatedAt: toISODateTime(new Date()),\r\n                    affectsDebt: false,\r\n                };\r\n                const newReceipt = addReceipt(newReceiptData as any);\r\n                if (newReceipt) {\r\n                    createdReceipts.push({ ...newReceipt, shipmentSystemIds: group.shipmentSystemIds });\r\n                }\r\n            }\r\n        });\r\n    \r\n        baseStore.setState(state => {\r\n            const updates = new Map<string, { newPayments: OrderPayment[]; reconciledShipmentIds: string[] }>();\r\n    \r\n            shipments.forEach(shipment => {\r\n                const receiptForShipment = createdReceipts.find(v => v.shipmentSystemIds.includes(shipment.systemId));\r\n                if (!receiptForShipment || !shipment.codAmount || shipment.codAmount <= 0) return;\r\n    \r\n                const orderSystemId = shipment.orderSystemId;\r\n                const orderUpdates = updates.get(orderSystemId) || { newPayments: [], reconciledShipmentIds: [] };\r\n    \r\n                const newPayment: OrderPayment = {\r\n                    systemId: receiptForShipment.systemId,\r\n                    id: receiptForShipment.id,\r\n                    date: receiptForShipment.date,\r\n                    method: 'Đối soát COD',\r\n                    amount: shipment.codAmount || 0,\r\n                    createdBy: asSystemId('SYSTEM'),\r\n                    description: `Thanh toán COD cho vận đơn ${shipment.trackingCode || shipment.id}`,\r\n                };\r\n                orderUpdates.newPayments.push(newPayment);\r\n                orderUpdates.reconciledShipmentIds.push(shipment.systemId);\r\n                updates.set(orderSystemId, orderUpdates);\r\n            });\r\n    \r\n            if (updates.size === 0) return state;\r\n    \r\n            const newData = state.data.map(order => {\r\n                if (updates.has(order.systemId)) {\r\n                    const orderUpdates = updates.get(order.systemId)!;\r\n                    let updatedOrder = { ...order };\r\n\r\n                    updatedOrder.packagings = updatedOrder.packagings.map(p =>\r\n                        orderUpdates.reconciledShipmentIds.includes(p.systemId)\r\n                            ? { ...p, reconciliationStatus: 'Đã đối soát' as const }\r\n                            : p\r\n                    );\r\n\r\n                    for (const payment of orderUpdates.newPayments) {\r\n                        updatedOrder = applyPaymentToOrder(updatedOrder, payment);\r\n                    }\r\n    \r\n                    return updatedOrder;\r\n                }\r\n                return order;\r\n            });\r\n    \r\n            return { data: newData };\r\n        });\r\n    },\r\n\r\n    // ============================================\r\n    // GHTK INTEGRATION METHODS\r\n    // ============================================\r\n\r\n    /**\r\n     * Process GHTK webhook update\r\n     * Called when GHTK pushes status update or from tracking API\r\n     */\r\n    processGHTKWebhook: (webhookData: import('./types').GHTKWebhookPayload) => {\r\n        baseStore.setState(state => {\r\n            // Find order by tracking code or partner_id\r\n            const order = state.data.find(o => \r\n                o.packagings.some(p => \r\n                    p.trackingCode === webhookData.label_id || \r\n                    p.systemId === webhookData.partner_id ||\r\n                    o.systemId === webhookData.partner_id\r\n                )\r\n            );\r\n            \r\n            if (!order) {\r\n                console.warn('[GHTK Webhook] Order not found for:', {\r\n                    label_id: webhookData.label_id,\r\n                    partner_id: webhookData.partner_id\r\n                });\r\n                return state;\r\n            }\r\n            \r\n            // Import status mapping\r\n            const { getGHTKStatusInfo, getGHTKReasonText } = require('../../lib/ghtk-constants');\r\n            \r\n            const statusMapping = getGHTKStatusInfo(webhookData.status_id);\r\n            if (!statusMapping) {\r\n                console.warn('[GHTK Webhook] Unknown status:', webhookData.status_id);\r\n                return state;\r\n            }\r\n            \r\n            console.log('[GHTK Webhook] Processing update:', {\r\n                order: order.id,\r\n                trackingCode: webhookData.label_id,\r\n                statusId: webhookData.status_id,\r\n                statusText: statusMapping.statusText,\r\n                deliveryStatus: statusMapping.deliveryStatus\r\n            });\r\n            \r\n            // Update packaging with new status\r\n            const updatedPackagings = order.packagings.map(p => {\r\n                if (p.trackingCode !== webhookData.label_id && \r\n                    p.systemId !== webhookData.partner_id) {\r\n                    return p;\r\n                }\r\n                \r\n                return {\r\n                    ...p,\r\n                    deliveryStatus: statusMapping.deliveryStatus,\r\n                    partnerStatus: statusMapping.statusText,\r\n                    ghtkStatusId: webhookData.status_id,\r\n                    ghtkReasonCode: webhookData.reason_code,\r\n                    ghtkReasonText: webhookData.reason \r\n                        ? webhookData.reason \r\n                        : (webhookData.reason_code ? getGHTKReasonText(webhookData.reason_code) : undefined),\r\n                    actualWeight: webhookData.weight,\r\n                    actualFee: webhookData.fee,\r\n                    lastSyncedAt: toISODateTime(new Date()),\r\n                    // Update reconciliation status if status = 6 (Đã đối soát)\r\n                    reconciliationStatus: webhookData.status_id === 6 \r\n                        ? 'Đã đối soát' as const \r\n                        : p.reconciliationStatus,\r\n                    // Update delivered date if status = 5 or 6\r\n                    deliveredDate: [5, 6].includes(webhookData.status_id) && !p.deliveredDate\r\n                        ? toISODateTime(new Date())\r\n                        : p.deliveredDate,\r\n                };\r\n            });\r\n            \r\n            // Handle stock updates based on status\r\n            if (statusMapping.shouldUpdateStock && statusMapping.stockAction) {\r\n                const { dispatchStock, completeDelivery: productCompleteDelivery, returnStockFromTransit } = useProductStore.getState();\r\n                const { incrementFailedDeliveryStats } = useCustomerStore.getState();\r\n                \r\n                // ✅ Expand combo items to child products\r\n                const stockItems = getComboStockItems(order.lineItems);\r\n                \r\n                stockItems.forEach(item => {\r\n                    switch (statusMapping.stockAction) {\r\n                        case 'dispatch':\r\n                            // Status 3: Đã lấy hàng -> Move to transit\r\n                            dispatchStock(item.productSystemId, asSystemId(getBranchId(order)), item.quantity);\r\n                            break;\r\n                        case 'complete':\r\n                            // Status 5: Đã giao hàng -> Complete delivery\r\n                            productCompleteDelivery(item.productSystemId, asSystemId(getBranchId(order)), item.quantity);\r\n                            break;\r\n                        case 'return':\r\n                            // Status -1, 7, 9, 13, 20: Failed/Returned -> Return stock\r\n                            returnStockFromTransit(item.productSystemId, asSystemId(getBranchId(order)), item.quantity);\r\n                            break;\r\n                    }\r\n                });\r\n                \r\n                // ✅ Increment failed delivery stats for customer if return (moved outside loop)\r\n                if (statusMapping.stockAction === 'return') {\r\n                    const failureStatuses = [7, 9, 13, 20, 21];\r\n                    const currentPackaging = order.packagings.find(p => p.trackingCode === webhookData.label_id);\r\n                    const previousStatusId = currentPackaging?.ghtkStatusId;\r\n                    \r\n                    if (failureStatuses.includes(webhookData.status_id) && (!previousStatusId || !failureStatuses.includes(previousStatusId))) {\r\n                        incrementFailedDeliveryStats(order.customerSystemId);\r\n                    }\r\n                }\r\n                \r\n                console.log('[GHTK Webhook] Stock updated:', {\r\n                    action: statusMapping.stockAction,\r\n                    items: stockItems.length\r\n                });\r\n            }\r\n            \r\n            // Determine order-level delivery status\r\n            const allPackagingsDelivered = updatedPackagings.every(p => \r\n                p.status === 'Hủy đóng gói' || \r\n                p.deliveryStatus === 'Đã giao hàng'\r\n            );\r\n            \r\n            let newOrderDeliveryStatus = order.deliveryStatus;\r\n            let newOrderStatus = order.status;\r\n            let newCompletedDate = order.completedDate;\r\n            let newStockOutStatus = order.stockOutStatus;\r\n            \r\n            // Update order delivery status\r\n            if (allPackagingsDelivered) {\r\n                newOrderDeliveryStatus = 'Đã giao hàng';\r\n                \r\n                // Auto-complete order if delivered + paid\r\n                if (order.paymentStatus === 'Thanh toán toàn bộ' && order.status !== 'Hoàn thành') {\r\n                    newOrderStatus = 'Hoàn thành';\r\n                    newCompletedDate = toISODateTime(new Date());\r\n                    \r\n                    // Update customer stats\r\n                    const { incrementOrderStats } = useCustomerStore.getState();\r\n                    incrementOrderStats(order.customerSystemId, order.grandTotal);\r\n                    \r\n                    console.log('[GHTK Webhook] Order completed:', order.id);\r\n                }\r\n            } else if (statusMapping.statusId === 3) {\r\n                // Status 3: Đã lấy hàng\r\n                newOrderDeliveryStatus = 'Đang giao hàng';\r\n                newStockOutStatus = 'Xuất kho toàn bộ';\r\n            } else if ([4, 10].includes(statusMapping.statusId)) {\r\n                // Status 4, 10: Đang giao\r\n                newOrderDeliveryStatus = 'Đang giao hàng';\r\n            }\r\n            \r\n            const updatedOrder = {\r\n                ...order,\r\n                packagings: updatedPackagings,\r\n                deliveryStatus: newOrderDeliveryStatus,\r\n                status: newOrderStatus,\r\n                completedDate: newCompletedDate,\r\n                stockOutStatus: newStockOutStatus,\r\n            };\r\n            \r\n            return {\r\n                data: state.data.map(o => o.systemId === order.systemId ? updatedOrder : o)\r\n            };\r\n        });\r\n    },\r\n\r\n    /**\r\n     * Cancel GHTK shipment\r\n     * ⚠️ Chỉ hủy được khi đơn ở trạng thái: 1, 2, 12 (Chưa tiếp nhận, Đã tiếp nhận, Đang lấy hàng)\r\n     */\r\n    cancelGHTKShipment: async (orderSystemId: SystemId, packagingSystemId: SystemId, trackingCode: string) => {\r\n        try {\r\n            console.log('[GHTK] Cancelling shipment:', trackingCode);\r\n            \r\n            // ✅ Lấy credentials từ shipping_partners_config\r\n            const { getGHTKCredentials } = await import('../../lib/utils/get-shipping-credentials');\r\n            let credentials;\r\n            \r\n            try {\r\n                credentials = getGHTKCredentials();\r\n            } catch (error: any) {\r\n                return {\r\n                    success: false,\r\n                    message: error.message || 'Chưa cấu hình GHTK. Vui lòng vào Cài đặt → Đối tác vận chuyển.'\r\n                };\r\n            }\r\n            \r\n            const response = await fetch(getApiUrl('/shipping/ghtk/cancel-order'), {\r\n                method: 'POST',\r\n                headers: {\r\n                    'Content-Type': 'application/json',\r\n                },\r\n                body: JSON.stringify({\r\n                    trackingCode,\r\n                    apiToken: credentials.apiToken,\r\n                    partnerCode: credentials.partnerCode,\r\n                }),\r\n            });\r\n            \r\n            const data = await response.json();\r\n            \r\n            // ✅ Kiểm tra response từ GHTK\r\n            if (!response.ok) {\r\n                throw new Error(data.message || data.error || 'Failed to cancel GHTK shipment');\r\n            }\r\n            \r\n            // ✅ GHTK trả success: false khi không thể hủy (đã lấy hàng)\r\n            if (data.success === false) {\r\n                console.log('[GHTK] Cannot cancel:', data.message);\r\n                return { \r\n                    success: false, \r\n                    message: data.message || 'Không thể hủy đơn hàng' \r\n                };\r\n            }\r\n            \r\n            console.log('[GHTK] Cancellation successful:', data.message);\r\n            \r\n            // ✅ CHỈ update state khi GHTK xác nhận hủy thành công\r\n            baseStore.setState(state => {\r\n                const order = state.data.find(o => o.systemId === orderSystemId);\r\n                if (!order) return state;\r\n                \r\n                const updatedPackagings = order.packagings.map(p => {\r\n                    if (p.systemId !== packagingSystemId) return p;\r\n                    \r\n                    return {\r\n                        ...p,\r\n                        status: 'Hủy đóng gói' as PackagingStatus,\r\n                        deliveryStatus: 'Đã hủy' as OrderDeliveryStatus,\r\n                        cancelDate: toISODateTime(new Date()),\r\n                        cancelReason: 'Hủy vận đơn GHTK',\r\n                        ghtkStatusId: -1,\r\n                        partnerStatus: 'Hủy đơn hàng',\r\n                    };\r\n                });\r\n                \r\n                // ✅ KHÔNG rollback stock - để user tự quyết định (nút \"Hủy giao và nhận lại hàng\")\r\n                \r\n                const updatedOrder = {\r\n                    ...order,\r\n                    packagings: updatedPackagings,\r\n                };\r\n                \r\n                return {\r\n                    data: state.data.map(o => o.systemId === orderSystemId ? updatedOrder : o)\r\n                };\r\n            });\r\n            \r\n            return { \r\n                success: true, \r\n                message: data.message || 'Đã hủy vận đơn GHTK thành công' \r\n            };\r\n            \r\n        } catch (error: any) {\r\n            console.error('[GHTK] Cancel error:', error);\r\n            return { \r\n                success: false, \r\n                message: error.message || 'Lỗi khi hủy vận đơn GHTK' \r\n            };\r\n        }\r\n    },\r\n};\r\n\r\n// Auto-allocate historical receipts on startup\r\nuseReceiptStore.getState().data.forEach(receipt => {\r\n    autoAllocateReceiptToOrders(receipt);\r\n});\r\n\r\n// React to newly created receipts\r\nuseReceiptStore.subscribe(\r\n    state => state.data,\r\n    (currentReceipts, previousReceipts) => {\r\n        const previousIds = new Set((previousReceipts ?? []).map(r => r.systemId));\r\n        currentReceipts.forEach(receipt => {\r\n            if (!previousIds.has(receipt.systemId)) {\r\n                autoAllocateReceiptToOrders(receipt);\r\n            }\r\n        });\r\n    }\r\n);\r\n\r\n\r\n// Export typed hook with all augmented methods\r\nexport const useOrderStore = (): any => {\r\n  const state = baseStore();\r\n  return {\r\n    ...state,\r\n    ...augmentedMethods,\r\n  };\r\n};\r\n\r\n// Export getState for non-hook usage\r\nuseOrderStore.getState = (): any => {\r\n  const state = baseStore.getState();\r\n  return {\r\n    ...state,\r\n    ...augmentedMethods,\r\n  };\r\n};\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 2038, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/orders/address-utils.ts"],"sourcesContent":["import type { OrderAddress } from './types';\r\n\r\nexport const formatOrderAddress = (address?: string | OrderAddress | null): string => {\r\n    if (!address) return '';\r\n    if (typeof address === 'string') {\r\n        return address;\r\n    }\r\n\r\n    if (address.formattedAddress) {\r\n        return address.formattedAddress;\r\n    }\r\n\r\n    return [\r\n        address.street,\r\n        address.ward,\r\n        address.district,\r\n        address.province\r\n    ].filter(Boolean).join(', ');\r\n};\r\n\r\nconst hasAddressValue = (value?: string | null) => typeof value === 'string' && value.trim().length > 0;\r\n\r\nexport const cloneOrderAddress = (address?: any | null): OrderAddress | undefined => {\r\n    if (!address) return undefined;\r\n\r\n    if (typeof address === 'string') {\r\n        const normalized = address.trim();\r\n        return normalized ? { street: normalized, formattedAddress: normalized } : undefined;\r\n    }\r\n\r\n    if (typeof address !== 'object') {\r\n        return undefined;\r\n    }\r\n\r\n    const snapshot: OrderAddress = {\r\n        street: address.street,\r\n        ward: address.ward,\r\n        district: address.district,\r\n        province: address.province,\r\n        contactName: address.contactName,\r\n        company: address.company,\r\n        note: address.note ?? address.notes,\r\n        id: address.id,\r\n        label: address.label,\r\n        provinceId: address.provinceId,\r\n        districtId: address.districtId,\r\n        wardId: address.wardId,\r\n    };\r\n\r\n    const phoneValue = address.phone ?? address.contactPhone;\r\n    if (hasAddressValue(phoneValue)) {\r\n        snapshot.phone = phoneValue;\r\n        snapshot.contactPhone = phoneValue;\r\n    }\r\n\r\n    const formatted = formatOrderAddress(snapshot);\r\n    if (hasAddressValue(formatted)) {\r\n        snapshot.formattedAddress = formatted;\r\n    } else if (hasAddressValue(address.formattedAddress)) {\r\n        snapshot.formattedAddress = address.formattedAddress;\r\n    }\r\n\r\n    return snapshot;\r\n};\r\n"],"names":[],"mappings":";;;;;;AAEO,MAAM,qBAAqB,CAAC;IAC/B,IAAI,CAAC,SAAS,OAAO;IACrB,IAAI,OAAO,YAAY,UAAU;QAC7B,OAAO;IACX;IAEA,IAAI,QAAQ,gBAAgB,EAAE;QAC1B,OAAO,QAAQ,gBAAgB;IACnC;IAEA,OAAO;QACH,QAAQ,MAAM;QACd,QAAQ,IAAI;QACZ,QAAQ,QAAQ;QAChB,QAAQ,QAAQ;KACnB,CAAC,MAAM,CAAC,SAAS,IAAI,CAAC;AAC3B;AAEA,MAAM,kBAAkB,CAAC,QAA0B,OAAO,UAAU,YAAY,MAAM,IAAI,GAAG,MAAM,GAAG;AAE/F,MAAM,oBAAoB,CAAC;IAC9B,IAAI,CAAC,SAAS,OAAO;IAErB,IAAI,OAAO,YAAY,UAAU;QAC7B,MAAM,aAAa,QAAQ,IAAI;QAC/B,OAAO,aAAa;YAAE,QAAQ;YAAY,kBAAkB;QAAW,IAAI;IAC/E;IAEA,IAAI,OAAO,YAAY,UAAU;QAC7B,OAAO;IACX;IAEA,MAAM,WAAyB;QAC3B,QAAQ,QAAQ,MAAM;QACtB,MAAM,QAAQ,IAAI;QAClB,UAAU,QAAQ,QAAQ;QAC1B,UAAU,QAAQ,QAAQ;QAC1B,aAAa,QAAQ,WAAW;QAChC,SAAS,QAAQ,OAAO;QACxB,MAAM,QAAQ,IAAI,IAAI,QAAQ,KAAK;QACnC,IAAI,QAAQ,EAAE;QACd,OAAO,QAAQ,KAAK;QACpB,YAAY,QAAQ,UAAU;QAC9B,YAAY,QAAQ,UAAU;QAC9B,QAAQ,QAAQ,MAAM;IAC1B;IAEA,MAAM,aAAa,QAAQ,KAAK,IAAI,QAAQ,YAAY;IACxD,IAAI,gBAAgB,aAAa;QAC7B,SAAS,KAAK,GAAG;QACjB,SAAS,YAAY,GAAG;IAC5B;IAEA,MAAM,YAAY,mBAAmB;IACrC,IAAI,gBAAgB,YAAY;QAC5B,SAAS,gBAAgB,GAAG;IAChC,OAAO,IAAI,gBAAgB,QAAQ,gBAAgB,GAAG;QAClD,SAAS,gBAAgB,GAAG,QAAQ,gBAAgB;IACxD;IAEA,OAAO;AACX"}},
    {"offset": {"line": 2103, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/orders/order-search-api.ts"],"sourcesContent":["/**\r\n * Order Search API\r\n * Server-side search for orders to handle large datasets\r\n */\r\n\r\nimport type { Order } from './types';\r\nimport { formatOrderAddress } from './address-utils';\r\n\r\nexport interface OrderSearchResult {\r\n  value: string;      // systemId\r\n  label: string;      // Display text (e.g., \"DH000001 - Nguyễn Văn A\")\r\n  subtitle?: string;  // Additional info (e.g., \"1,500,000 đ - 0901234567\")\r\n}\r\n\r\nexport interface OrderSearchParams {\r\n  query: string;\r\n  limit?: number | undefined;\r\n  branchSystemId?: string | undefined;  // Filter by branch\r\n  status?: string | undefined;          // Filter by status\r\n}\r\n\r\n/**\r\n * Search orders with server-side filtering\r\n * This simulates an API call but uses Zustand store for now\r\n * TODO: Replace with actual API endpoint when backend is ready\r\n */\r\nexport async function searchOrders(\r\n  params: OrderSearchParams,\r\n  ordersData: Order[]\r\n): Promise<OrderSearchResult[]> {\r\n  const { query, limit = 50, branchSystemId, status } = params;\r\n  \r\n  // Simulate API delay (remove in production)\r\n  await new Promise(resolve => setTimeout(resolve, 300));\r\n  \r\n  const queryLower = query.toLowerCase().trim();\r\n  \r\n  let filtered = ordersData;\r\n  \r\n  // Filter by branch if specified\r\n  if (branchSystemId) {\r\n    filtered = filtered.filter(o => o.branchSystemId === branchSystemId);\r\n  }\r\n  \r\n  // Filter by status if specified\r\n  if (status) {\r\n    filtered = filtered.filter(o => o.status === status);\r\n  }\r\n  \r\n  // If no query, return most recent orders\r\n  if (!queryLower) {\r\n    return filtered\r\n      .slice(-limit)\r\n      .reverse()\r\n      .map(orderToSearchResult);\r\n  }\r\n  \r\n  // Search by ID, customer name, or shipping address\r\n  const results = filtered.filter(order => {\r\n    const shippingAddressText = formatOrderAddress(order.shippingAddress);\r\n    return (\r\n      order.id.toLowerCase().includes(queryLower) ||\r\n      order.customerName.toLowerCase().includes(queryLower) ||\r\n      (shippingAddressText && shippingAddressText.toLowerCase().includes(queryLower))\r\n    );\r\n  });\r\n  \r\n  // Sort by relevance (exact match first, then partial)\r\n  results.sort((a, b) => {\r\n    const aExact = a.id.toLowerCase() === queryLower ? 1 : 0;\r\n    const bExact = b.id.toLowerCase() === queryLower ? 1 : 0;\r\n    return bExact - aExact;\r\n  });\r\n  \r\n  return results\r\n    .slice(0, limit)\r\n    .map(orderToSearchResult);\r\n}\r\n\r\n/**\r\n * Convert Order to SearchResult format\r\n */\r\nfunction orderToSearchResult(order: Order): OrderSearchResult {\r\n  const amount = order.grandTotal || 0;\r\n  \r\n  return {\r\n    value: order.systemId,\r\n    label: `${order.id} - ${order.customerName}`,\r\n    subtitle: `${amount.toLocaleString('vi-VN')} đ - ${order.orderDate}`\r\n  };\r\n}\r\n\r\n/**\r\n * Get order by systemId\r\n */\r\nexport function getOrderById(systemId: string, ordersData: Order[]): Order | undefined {\r\n  return ordersData.find(o => o.systemId === systemId);\r\n}\r\n"],"names":[],"mappings":"AAAA;;;CAGC;;;;;;AAGD;;AAoBO,eAAe,aACpB,MAAyB,EACzB,UAAmB;IAEnB,MAAM,EAAE,KAAK,EAAE,QAAQ,EAAE,EAAE,cAAc,EAAE,MAAM,EAAE,GAAG;IAEtD,4CAA4C;IAC5C,MAAM,IAAI,QAAQ,CAAA,UAAW,WAAW,SAAS;IAEjD,MAAM,aAAa,MAAM,WAAW,GAAG,IAAI;IAE3C,IAAI,WAAW;IAEf,gCAAgC;IAChC,IAAI,gBAAgB;QAClB,WAAW,SAAS,MAAM,CAAC,CAAA,IAAK,EAAE,cAAc,KAAK;IACvD;IAEA,gCAAgC;IAChC,IAAI,QAAQ;QACV,WAAW,SAAS,MAAM,CAAC,CAAA,IAAK,EAAE,MAAM,KAAK;IAC/C;IAEA,yCAAyC;IACzC,IAAI,CAAC,YAAY;QACf,OAAO,SACJ,KAAK,CAAC,CAAC,OACP,OAAO,GACP,GAAG,CAAC;IACT;IAEA,mDAAmD;IACnD,MAAM,UAAU,SAAS,MAAM,CAAC,CAAA;QAC9B,MAAM,sBAAsB,IAAA,4JAAkB,EAAC,MAAM,eAAe;QACpE,OACE,MAAM,EAAE,CAAC,WAAW,GAAG,QAAQ,CAAC,eAChC,MAAM,YAAY,CAAC,WAAW,GAAG,QAAQ,CAAC,eACzC,uBAAuB,oBAAoB,WAAW,GAAG,QAAQ,CAAC;IAEvE;IAEA,sDAAsD;IACtD,QAAQ,IAAI,CAAC,CAAC,GAAG;QACf,MAAM,SAAS,EAAE,EAAE,CAAC,WAAW,OAAO,aAAa,IAAI;QACvD,MAAM,SAAS,EAAE,EAAE,CAAC,WAAW,OAAO,aAAa,IAAI;QACvD,OAAO,SAAS;IAClB;IAEA,OAAO,QACJ,KAAK,CAAC,GAAG,OACT,GAAG,CAAC;AACT;AAEA;;CAEC,GACD,SAAS,oBAAoB,KAAY;IACvC,MAAM,SAAS,MAAM,UAAU,IAAI;IAEnC,OAAO;QACL,OAAO,MAAM,QAAQ;QACrB,OAAO,GAAG,MAAM,EAAE,CAAC,GAAG,EAAE,MAAM,YAAY,EAAE;QAC5C,UAAU,GAAG,OAAO,cAAc,CAAC,SAAS,KAAK,EAAE,MAAM,SAAS,EAAE;IACtE;AACF;AAKO,SAAS,aAAa,QAAgB,EAAE,UAAmB;IAChE,OAAO,WAAW,IAAI,CAAC,CAAA,IAAK,EAAE,QAAQ,KAAK;AAC7C"}}]
}