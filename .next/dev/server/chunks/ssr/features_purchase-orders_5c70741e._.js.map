{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/purchase-orders/api/purchase-orders-api.ts"],"sourcesContent":["/**\r\n * Purchase Orders API - Isolated API functions\r\n */\r\n\r\nimport type { PurchaseOrder } from '../types';\r\n\r\nconst API_BASE = '/api/purchase-orders';\r\n\r\nexport interface PurchaseOrdersParams {\r\n  page?: number;\r\n  limit?: number;\r\n  search?: string;\r\n  status?: string;\r\n  supplierId?: string;\r\n  branchId?: string;\r\n  startDate?: string;\r\n  endDate?: string;\r\n  sortBy?: string;\r\n  sortOrder?: 'asc' | 'desc';\r\n}\r\n\r\nexport interface PaginatedResponse<T> {\r\n  data: T[];\r\n  pagination: {\r\n    page: number;\r\n    limit: number;\r\n    total: number;\r\n    totalPages: number;\r\n  };\r\n}\r\n\r\nexport async function fetchPurchaseOrders(params: PurchaseOrdersParams = {}): Promise<PaginatedResponse<PurchaseOrder>> {\r\n  const { page = 1, limit = 50, ...rest } = params;\r\n  \r\n  const searchParams = new URLSearchParams({\r\n    page: String(page),\r\n    limit: String(limit),\r\n  });\r\n  \r\n  Object.entries(rest).forEach(([key, value]) => {\r\n    if (value != null && value !== '') {\r\n      searchParams.set(key, String(value));\r\n    }\r\n  });\r\n  \r\n  const res = await fetch(`${API_BASE}?${searchParams}`, { credentials: 'include' });\r\n  if (!res.ok) throw new Error(`Failed to fetch purchase orders: ${res.statusText}`);\r\n  return res.json();\r\n}\r\n\r\nexport async function fetchPurchaseOrder(id: string): Promise<PurchaseOrder> {\r\n  const res = await fetch(`${API_BASE}/${id}`, { credentials: 'include' });\r\n  if (!res.ok) throw new Error(`Failed to fetch purchase order: ${res.statusText}`);\r\n  return res.json();\r\n}\r\n\r\nexport async function createPurchaseOrder(data: Partial<PurchaseOrder>): Promise<PurchaseOrder> {\r\n  const res = await fetch(API_BASE, {\r\n    method: 'POST',\r\n    headers: { 'Content-Type': 'application/json' },\r\n    credentials: 'include',\r\n    body: JSON.stringify(data),\r\n  });\r\n  if (!res.ok) {\r\n    const error = await res.json().catch(() => ({}));\r\n    throw new Error(error.message || `Failed to create purchase order`);\r\n  }\r\n  return res.json();\r\n}\r\n\r\nexport async function updatePurchaseOrder(systemId: string, data: Partial<PurchaseOrder>): Promise<PurchaseOrder> {\r\n  const res = await fetch(`${API_BASE}/${systemId}`, {\r\n    method: 'PATCH',\r\n    headers: { 'Content-Type': 'application/json' },\r\n    credentials: 'include',\r\n    body: JSON.stringify(data),\r\n  });\r\n  if (!res.ok) {\r\n    const error = await res.json().catch(() => ({}));\r\n    throw new Error(error.message || `Failed to update purchase order`);\r\n  }\r\n  return res.json();\r\n}\r\n\r\nexport async function deletePurchaseOrder(id: string): Promise<void> {\r\n  const res = await fetch(`${API_BASE}/${id}`, { method: 'DELETE', credentials: 'include' });\r\n  if (!res.ok) throw new Error(`Failed to delete purchase order`);\r\n}\r\n\r\nexport async function searchPurchaseOrders(query: string, limit = 20): Promise<PurchaseOrder[]> {\r\n  const res = await fetch(`${API_BASE}?search=${encodeURIComponent(query)}&limit=${limit}`, { credentials: 'include' });\r\n  if (!res.ok) throw new Error(`Failed to search purchase orders`);\r\n  const json = await res.json();\r\n  return json.data || [];\r\n}\r\n"],"names":[],"mappings":"AAAA;;CAEC;;;;;;;;;;;;;;AAID,MAAM,WAAW;AAyBV,eAAe,oBAAoB,SAA+B,CAAC,CAAC;IACzE,MAAM,EAAE,OAAO,CAAC,EAAE,QAAQ,EAAE,EAAE,GAAG,MAAM,GAAG;IAE1C,MAAM,eAAe,IAAI,gBAAgB;QACvC,MAAM,OAAO;QACb,OAAO,OAAO;IAChB;IAEA,OAAO,OAAO,CAAC,MAAM,OAAO,CAAC,CAAC,CAAC,KAAK,MAAM;QACxC,IAAI,SAAS,QAAQ,UAAU,IAAI;YACjC,aAAa,GAAG,CAAC,KAAK,OAAO;QAC/B;IACF;IAEA,MAAM,MAAM,MAAM,MAAM,GAAG,SAAS,CAAC,EAAE,cAAc,EAAE;QAAE,aAAa;IAAU;IAChF,IAAI,CAAC,IAAI,EAAE,EAAE,MAAM,IAAI,MAAM,CAAC,iCAAiC,EAAE,IAAI,UAAU,EAAE;IACjF,OAAO,IAAI,IAAI;AACjB;AAEO,eAAe,mBAAmB,EAAU;IACjD,MAAM,MAAM,MAAM,MAAM,GAAG,SAAS,CAAC,EAAE,IAAI,EAAE;QAAE,aAAa;IAAU;IACtE,IAAI,CAAC,IAAI,EAAE,EAAE,MAAM,IAAI,MAAM,CAAC,gCAAgC,EAAE,IAAI,UAAU,EAAE;IAChF,OAAO,IAAI,IAAI;AACjB;AAEO,eAAe,oBAAoB,IAA4B;IACpE,MAAM,MAAM,MAAM,MAAM,UAAU;QAChC,QAAQ;QACR,SAAS;YAAE,gBAAgB;QAAmB;QAC9C,aAAa;QACb,MAAM,KAAK,SAAS,CAAC;IACvB;IACA,IAAI,CAAC,IAAI,EAAE,EAAE;QACX,MAAM,QAAQ,MAAM,IAAI,IAAI,GAAG,KAAK,CAAC,IAAM,CAAC,CAAC,CAAC;QAC9C,MAAM,IAAI,MAAM,MAAM,OAAO,IAAI,CAAC,+BAA+B,CAAC;IACpE;IACA,OAAO,IAAI,IAAI;AACjB;AAEO,eAAe,oBAAoB,QAAgB,EAAE,IAA4B;IACtF,MAAM,MAAM,MAAM,MAAM,GAAG,SAAS,CAAC,EAAE,UAAU,EAAE;QACjD,QAAQ;QACR,SAAS;YAAE,gBAAgB;QAAmB;QAC9C,aAAa;QACb,MAAM,KAAK,SAAS,CAAC;IACvB;IACA,IAAI,CAAC,IAAI,EAAE,EAAE;QACX,MAAM,QAAQ,MAAM,IAAI,IAAI,GAAG,KAAK,CAAC,IAAM,CAAC,CAAC,CAAC;QAC9C,MAAM,IAAI,MAAM,MAAM,OAAO,IAAI,CAAC,+BAA+B,CAAC;IACpE;IACA,OAAO,IAAI,IAAI;AACjB;AAEO,eAAe,oBAAoB,EAAU;IAClD,MAAM,MAAM,MAAM,MAAM,GAAG,SAAS,CAAC,EAAE,IAAI,EAAE;QAAE,QAAQ;QAAU,aAAa;IAAU;IACxF,IAAI,CAAC,IAAI,EAAE,EAAE,MAAM,IAAI,MAAM,CAAC,+BAA+B,CAAC;AAChE;AAEO,eAAe,qBAAqB,KAAa,EAAE,QAAQ,EAAE;IAClE,MAAM,MAAM,MAAM,MAAM,GAAG,SAAS,QAAQ,EAAE,mBAAmB,OAAO,OAAO,EAAE,OAAO,EAAE;QAAE,aAAa;IAAU;IACnH,IAAI,CAAC,IAAI,EAAE,EAAE,MAAM,IAAI,MAAM,CAAC,gCAAgC,CAAC;IAC/D,MAAM,OAAO,MAAM,IAAI,IAAI;IAC3B,OAAO,KAAK,IAAI,IAAI,EAAE;AACxB"}},
    {"offset": {"line": 94, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/purchase-orders/hooks/use-purchase-orders.ts"],"sourcesContent":["/**\r\n * usePurchaseOrders - React Query hooks\r\n * \r\n * ⚠️ Direct import: import { usePurchaseOrders } from '@/features/purchase-orders/hooks/use-purchase-orders'\r\n */\r\n\r\nimport { useQuery, useMutation, useQueryClient, keepPreviousData } from '@tanstack/react-query';\r\nimport {\r\n  fetchPurchaseOrders,\r\n  fetchPurchaseOrder,\r\n  createPurchaseOrder,\r\n  updatePurchaseOrder,\r\n  deletePurchaseOrder,\r\n  type PurchaseOrdersParams,\r\n} from '../api/purchase-orders-api';\r\nimport type { PurchaseOrder } from '../types';\r\n\r\nexport const purchaseOrderKeys = {\r\n  all: ['purchase-orders'] as const,\r\n  lists: () => [...purchaseOrderKeys.all, 'list'] as const,\r\n  list: (params: PurchaseOrdersParams) => [...purchaseOrderKeys.lists(), params] as const,\r\n  details: () => [...purchaseOrderKeys.all, 'detail'] as const,\r\n  detail: (id: string) => [...purchaseOrderKeys.details(), id] as const,\r\n};\r\n\r\nexport function usePurchaseOrders(params: PurchaseOrdersParams = {}) {\r\n  return useQuery({\r\n    queryKey: purchaseOrderKeys.list(params),\r\n    queryFn: () => fetchPurchaseOrders(params),\r\n    staleTime: 30_000,\r\n    gcTime: 5 * 60 * 1000,\r\n    placeholderData: keepPreviousData,\r\n  });\r\n}\r\n\r\nexport function usePurchaseOrder(id: string | null | undefined) {\r\n  return useQuery({\r\n    queryKey: purchaseOrderKeys.detail(id!),\r\n    queryFn: () => fetchPurchaseOrder(id!),\r\n    enabled: !!id,\r\n    staleTime: 60_000,\r\n  });\r\n}\r\n\r\ninterface UsePurchaseOrderMutationsOptions {\r\n  onCreateSuccess?: (po: PurchaseOrder) => void;\r\n  onUpdateSuccess?: (po: PurchaseOrder) => void;\r\n  onDeleteSuccess?: () => void;\r\n  onError?: (error: Error) => void;\r\n}\r\n\r\nexport function usePurchaseOrderMutations(options: UsePurchaseOrderMutationsOptions = {}) {\r\n  const queryClient = useQueryClient();\r\n  \r\n  const create = useMutation({\r\n    mutationFn: createPurchaseOrder,\r\n    onSuccess: (data) => {\r\n      queryClient.invalidateQueries({ queryKey: purchaseOrderKeys.lists() });\r\n      options.onCreateSuccess?.(data);\r\n    },\r\n    onError: options.onError,\r\n  });\r\n  \r\n  const update = useMutation({\r\n    mutationFn: ({ systemId, data }: { systemId: string; data: Partial<PurchaseOrder> }) => \r\n      updatePurchaseOrder(systemId, data),\r\n    onSuccess: (data, variables) => {\r\n      queryClient.invalidateQueries({ queryKey: purchaseOrderKeys.detail(variables.systemId) });\r\n      queryClient.invalidateQueries({ queryKey: purchaseOrderKeys.lists() });\r\n      options.onUpdateSuccess?.(data);\r\n    },\r\n    onError: options.onError,\r\n  });\r\n  \r\n  const remove = useMutation({\r\n    mutationFn: deletePurchaseOrder,\r\n    onSuccess: () => {\r\n      queryClient.invalidateQueries({ queryKey: purchaseOrderKeys.all });\r\n      options.onDeleteSuccess?.();\r\n    },\r\n    onError: options.onError,\r\n  });\r\n  \r\n  return { create, update, remove };\r\n}\r\n\r\nexport function usePurchaseOrdersBySupplier(supplierId: string | null | undefined) {\r\n  return usePurchaseOrders({ supplierId: supplierId || undefined, limit: 100 });\r\n}\r\n"],"names":[],"mappings":";;;;;;;;;;;;AAAA;;;;CAIC,GAED;AAAA;AAAA;AAAA;AACA;;;AAUO,MAAM,oBAAoB;IAC/B,KAAK;QAAC;KAAkB;IACxB,OAAO,IAAM;eAAI,kBAAkB,GAAG;YAAE;SAAO;IAC/C,MAAM,CAAC,SAAiC;eAAI,kBAAkB,KAAK;YAAI;SAAO;IAC9E,SAAS,IAAM;eAAI,kBAAkB,GAAG;YAAE;SAAS;IACnD,QAAQ,CAAC,KAAe;eAAI,kBAAkB,OAAO;YAAI;SAAG;AAC9D;AAEO,SAAS,kBAAkB,SAA+B,CAAC,CAAC;IACjE,OAAO,IAAA,uLAAQ,EAAC;QACd,UAAU,kBAAkB,IAAI,CAAC;QACjC,SAAS,IAAM,IAAA,yLAAmB,EAAC;QACnC,WAAW;QACX,QAAQ,IAAI,KAAK;QACjB,iBAAiB,2LAAgB;IACnC;AACF;AAEO,SAAS,iBAAiB,EAA6B;IAC5D,OAAO,IAAA,uLAAQ,EAAC;QACd,UAAU,kBAAkB,MAAM,CAAC;QACnC,SAAS,IAAM,IAAA,wLAAkB,EAAC;QAClC,SAAS,CAAC,CAAC;QACX,WAAW;IACb;AACF;AASO,SAAS,0BAA0B,UAA4C,CAAC,CAAC;IACtF,MAAM,cAAc,IAAA,wMAAc;IAElC,MAAM,SAAS,IAAA,6LAAW,EAAC;QACzB,YAAY,yLAAmB;QAC/B,WAAW,CAAC;YACV,YAAY,iBAAiB,CAAC;gBAAE,UAAU,kBAAkB,KAAK;YAAG;YACpE,QAAQ,eAAe,GAAG;QAC5B;QACA,SAAS,QAAQ,OAAO;IAC1B;IAEA,MAAM,SAAS,IAAA,6LAAW,EAAC;QACzB,YAAY,CAAC,EAAE,QAAQ,EAAE,IAAI,EAAsD,GACjF,IAAA,yLAAmB,EAAC,UAAU;QAChC,WAAW,CAAC,MAAM;YAChB,YAAY,iBAAiB,CAAC;gBAAE,UAAU,kBAAkB,MAAM,CAAC,UAAU,QAAQ;YAAE;YACvF,YAAY,iBAAiB,CAAC;gBAAE,UAAU,kBAAkB,KAAK;YAAG;YACpE,QAAQ,eAAe,GAAG;QAC5B;QACA,SAAS,QAAQ,OAAO;IAC1B;IAEA,MAAM,SAAS,IAAA,6LAAW,EAAC;QACzB,YAAY,yLAAmB;QAC/B,WAAW;YACT,YAAY,iBAAiB,CAAC;gBAAE,UAAU,kBAAkB,GAAG;YAAC;YAChE,QAAQ,eAAe;QACzB;QACA,SAAS,QAAQ,OAAO;IAC1B;IAEA,OAAO;QAAE;QAAQ;QAAQ;IAAO;AAClC;AAEO,SAAS,4BAA4B,UAAqC;IAC/E,OAAO,kBAAkB;QAAE,YAAY,cAAc;QAAW,OAAO;IAAI;AAC7E"}},
    {"offset": {"line": 206, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/purchase-orders/payment-utils.ts"],"sourcesContent":["import type { Payment } from '../payments/types';\r\nimport type { Receipt } from '../receipts/types';\r\nimport type { PurchaseOrder } from './types';\r\n\r\nconst SUPPLIER_TARGET_IDS = ['NHACUNGCAP', 'supplier'];\r\nconst SUPPLIER_TARGET_LABELS = ['Nhà cung cấp'];\r\n\r\nexport const isPaymentLinkedToPurchaseOrder = (payment: Payment, purchaseOrder: PurchaseOrder): boolean => {\r\n  if (!payment || !purchaseOrder) {\r\n    return false;\r\n  }\r\n\r\n  if (payment.purchaseOrderSystemId) {\r\n    return payment.purchaseOrderSystemId === purchaseOrder.systemId;\r\n  }\r\n\r\n  if (payment.originalDocumentId) {\r\n    return (\r\n      payment.originalDocumentId === purchaseOrder.systemId ||\r\n      payment.originalDocumentId === purchaseOrder.id\r\n    );\r\n  }\r\n\r\n  const isSupplierTarget =\r\n    (payment.recipientTypeSystemId && SUPPLIER_TARGET_IDS.includes(payment.recipientTypeSystemId)) ||\r\n    (payment.recipientTypeName && SUPPLIER_TARGET_LABELS.includes(payment.recipientTypeName));\r\n\r\n  if (isSupplierTarget && payment.recipientSystemId && payment.recipientSystemId === purchaseOrder.supplierSystemId) {\r\n    return true;\r\n  }\r\n\r\n  return false;\r\n};\r\n\r\nexport const getPaymentsForPurchaseOrder = (payments: Payment[], purchaseOrder: PurchaseOrder): Payment[] => {\r\n  if (!Array.isArray(payments) || !purchaseOrder) {\r\n    return [];\r\n  }\r\n  return payments.filter(payment => isPaymentLinkedToPurchaseOrder(payment, purchaseOrder));\r\n};\r\n\r\nexport const sumPaymentsForPurchaseOrder = (payments: Payment[], purchaseOrder: PurchaseOrder): number => {\r\n  return getPaymentsForPurchaseOrder(payments, purchaseOrder).reduce((sum, payment) => sum + (payment.amount || 0), 0);\r\n};\r\n\r\nexport const isReceiptLinkedToPurchaseOrder = (receipt: Receipt, purchaseOrder: PurchaseOrder): boolean => {\r\n  if (!receipt || !purchaseOrder) {\r\n    return false;\r\n  }\r\n\r\n  if (receipt.purchaseOrderSystemId) {\r\n    return receipt.purchaseOrderSystemId === purchaseOrder.systemId;\r\n  }\r\n\r\n  if (receipt.originalDocumentId) {\r\n    return (\r\n      receipt.originalDocumentId === purchaseOrder.systemId ||\r\n      receipt.originalDocumentId === purchaseOrder.id\r\n    );\r\n  }\r\n\r\n  const isSupplierTarget =\r\n    (receipt.payerTypeSystemId && SUPPLIER_TARGET_IDS.includes(receipt.payerTypeSystemId)) ||\r\n    (receipt.payerTypeName && SUPPLIER_TARGET_LABELS.includes(receipt.payerTypeName));\r\n\r\n  if (isSupplierTarget && receipt.payerSystemId && receipt.payerSystemId === purchaseOrder.supplierSystemId) {\r\n    return true;\r\n  }\r\n\r\n  return false;\r\n};\r\n\r\nexport const getReceiptsForPurchaseOrder = (receipts: Receipt[], purchaseOrder: PurchaseOrder): Receipt[] => {\r\n  if (!Array.isArray(receipts) || !purchaseOrder) {\r\n    return [];\r\n  }\r\n  return receipts.filter(receipt => isReceiptLinkedToPurchaseOrder(receipt, purchaseOrder));\r\n};\r\n"],"names":[],"mappings":";;;;;;;;;;;;AAIA,MAAM,sBAAsB;IAAC;IAAc;CAAW;AACtD,MAAM,yBAAyB;IAAC;CAAe;AAExC,MAAM,iCAAiC,CAAC,SAAkB;IAC/D,IAAI,CAAC,WAAW,CAAC,eAAe;QAC9B,OAAO;IACT;IAEA,IAAI,QAAQ,qBAAqB,EAAE;QACjC,OAAO,QAAQ,qBAAqB,KAAK,cAAc,QAAQ;IACjE;IAEA,IAAI,QAAQ,kBAAkB,EAAE;QAC9B,OACE,QAAQ,kBAAkB,KAAK,cAAc,QAAQ,IACrD,QAAQ,kBAAkB,KAAK,cAAc,EAAE;IAEnD;IAEA,MAAM,mBACJ,AAAC,QAAQ,qBAAqB,IAAI,oBAAoB,QAAQ,CAAC,QAAQ,qBAAqB,KAC3F,QAAQ,iBAAiB,IAAI,uBAAuB,QAAQ,CAAC,QAAQ,iBAAiB;IAEzF,IAAI,oBAAoB,QAAQ,iBAAiB,IAAI,QAAQ,iBAAiB,KAAK,cAAc,gBAAgB,EAAE;QACjH,OAAO;IACT;IAEA,OAAO;AACT;AAEO,MAAM,8BAA8B,CAAC,UAAqB;IAC/D,IAAI,CAAC,MAAM,OAAO,CAAC,aAAa,CAAC,eAAe;QAC9C,OAAO,EAAE;IACX;IACA,OAAO,SAAS,MAAM,CAAC,CAAA,UAAW,+BAA+B,SAAS;AAC5E;AAEO,MAAM,8BAA8B,CAAC,UAAqB;IAC/D,OAAO,4BAA4B,UAAU,eAAe,MAAM,CAAC,CAAC,KAAK,UAAY,MAAM,CAAC,QAAQ,MAAM,IAAI,CAAC,GAAG;AACpH;AAEO,MAAM,iCAAiC,CAAC,SAAkB;IAC/D,IAAI,CAAC,WAAW,CAAC,eAAe;QAC9B,OAAO;IACT;IAEA,IAAI,QAAQ,qBAAqB,EAAE;QACjC,OAAO,QAAQ,qBAAqB,KAAK,cAAc,QAAQ;IACjE;IAEA,IAAI,QAAQ,kBAAkB,EAAE;QAC9B,OACE,QAAQ,kBAAkB,KAAK,cAAc,QAAQ,IACrD,QAAQ,kBAAkB,KAAK,cAAc,EAAE;IAEnD;IAEA,MAAM,mBACJ,AAAC,QAAQ,iBAAiB,IAAI,oBAAoB,QAAQ,CAAC,QAAQ,iBAAiB,KACnF,QAAQ,aAAa,IAAI,uBAAuB,QAAQ,CAAC,QAAQ,aAAa;IAEjF,IAAI,oBAAoB,QAAQ,aAAa,IAAI,QAAQ,aAAa,KAAK,cAAc,gBAAgB,EAAE;QACzG,OAAO;IACT;IAEA,OAAO;AACT;AAEO,MAAM,8BAA8B,CAAC,UAAqB;IAC/D,IAAI,CAAC,MAAM,OAAO,CAAC,aAAa,CAAC,eAAe;QAC9C,OAAO,EAAE;IACX;IACA,OAAO,SAAS,MAAM,CAAC,CAAA,UAAW,+BAA+B,SAAS;AAC5E"}},
    {"offset": {"line": 276, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/purchase-orders/columns.tsx"],"sourcesContent":["import * as React from \"react\";\r\nimport Link from 'next/link';\r\nimport { formatDate, formatDateTime, formatDateTimeSeconds, formatDateCustom, parseDate, getCurrentDate } from '@/lib/date-utils';\r\nimport type { PurchaseOrder, PurchaseOrderStatus } from './types'\r\nimport type { Branch } from '../settings/branches/types';\r\nimport { Checkbox } from \"../../components/ui/checkbox\"\r\nimport { Badge } from \"../../components/ui/badge\"\r\nimport type { ColumnDef } from '../../components/data-table/types';\r\nimport { Button } from \"../../components/ui/button\";\r\nimport { DropdownMenu, DropdownMenuContent, DropdownMenuItem, DropdownMenuTrigger, DropdownMenuSeparator } from \"../../components/ui/dropdown-menu\";\r\nimport { MoreHorizontal, Printer, CreditCard, PackageCheck, XCircle } from \"lucide-react\";\r\nconst formatCurrency = (value?: number) => {\r\n    if (typeof value !== 'number' || isNaN(value)) return '0 ₫';\r\n    return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(value);\r\n};\r\n\r\n\r\n\r\nconst statusVariants: Record<PurchaseOrderStatus, \"success\" | \"default\" | \"secondary\" | \"warning\" | \"destructive\"> = {\r\n    \"Đặt hàng\": \"secondary\",\r\n    \"Đang giao dịch\": \"warning\",\r\n    \"Hoàn thành\": \"success\",\r\n    \"Đã hủy\": \"destructive\",\r\n    \"Kết thúc\": \"default\",\r\n    \"Đã trả hàng\": \"destructive\",\r\n};\r\n\r\nexport const getColumns = (\r\n  onCancel: (purchaseOrder: PurchaseOrder) => void,\r\n  onPrint: (purchaseOrder: PurchaseOrder) => void,\r\n  onPayment: (purchaseOrder: PurchaseOrder) => void,\r\n  onReceiveGoods: (purchaseOrder: PurchaseOrder) => void,\r\n  branches: Branch[]\r\n): ColumnDef<PurchaseOrder>[] => [\r\n  {\r\n    id: \"select\",\r\n    header: ({ isAllPageRowsSelected, isSomePageRowsSelected, onToggleAll }) => (\r\n       <div className=\"flex items-center justify-center\">\r\n        <Checkbox\r\n          checked={isAllPageRowsSelected ? true : isSomePageRowsSelected ? \"indeterminate\" : false}\r\n          onCheckedChange={(value) => onToggleAll?.(!!value)}\r\n          aria-label=\"Select all\"\r\n        />\r\n      </div>\r\n    ),\r\n    cell: ({ isSelected, onToggleSelect }) => (\r\n       <div className=\"flex items-center justify-center\">\r\n        <Checkbox\r\n          checked={isSelected}\r\n          onCheckedChange={onToggleSelect}\r\n          aria-label=\"Select row\"\r\n        />\r\n      </div>\r\n    ),\r\n    size: 48,\r\n    meta: {\r\n      displayName: \"Select\",\r\n      sticky: \"left\",\r\n    },\r\n  },\r\n  {\r\n    id: \"id\",\r\n    accessorKey: \"id\",\r\n    header: \"Mã đơn nhập hàng\",\r\n    cell: ({ row }) => <div className=\"text-body-sm font-medium text-primary hover:underline\"><Link href={`/purchase-orders/${row.systemId}`}>{row.id}</Link></div>,\r\n    meta: { displayName: \"Mã đơn nhập hàng\" },\r\n    size: 150,\r\n  },\r\n  {\r\n    id: \"supplierName\",\r\n    accessorKey: \"supplierName\",\r\n    header: \"Tên Nhà cung cấp\",\r\n    cell: ({ row }) => row.supplierName,\r\n    meta: { displayName: \"Tên Nhà cung cấp\" },\r\n  },\r\n  {\r\n    id: \"branchName\",\r\n    accessorKey: \"branchName\",\r\n    header: \"Chi nhánh\",\r\n    cell: ({ row }) => row.branchName,\r\n    meta: { displayName: \"Chi nhánh\" },\r\n  },\r\n  {\r\n    id: \"buyer\",\r\n    accessorKey: \"buyer\",\r\n    header: \"Nhân viên\",\r\n    cell: ({ row }) => row.buyer,\r\n    meta: { displayName: \"Nhân viên\" },\r\n  },\r\n  {\r\n    id: \"orderDate\",\r\n    accessorKey: \"orderDate\",\r\n    header: \"Ngày đặt hàng\",\r\n    cell: ({ row }) => formatDate(row.orderDate),\r\n    meta: { displayName: \"Ngày đặt hàng\" },\r\n  },\r\n  {\r\n    id: \"deliveryDate\",\r\n    accessorKey: \"deliveryDate\",\r\n    header: \"Ngày giao\",\r\n    cell: ({ row }) => formatDateCustom(parseDate(row.deliveryDate ?? \"\"), 'dd/MM/yyyy'),\r\n    meta: { displayName: \"Ngày giao\" },\r\n  },\r\n  {\r\n    id: \"shippingFee\",\r\n    accessorKey: \"shippingFee\",\r\n    header: \"Phí vận chuyển\",\r\n    cell: ({ row }) => formatCurrency(row.shippingFee || 0),\r\n    meta: { displayName: \"Phí vận chuyển\" },\r\n  },\r\n  {\r\n    id: \"tax\",\r\n    accessorKey: \"tax\",\r\n    header: \"Thuế\",\r\n    cell: ({ row }) => formatCurrency(row.tax || 0),\r\n    meta: { displayName: \"Thuế\" },\r\n  },\r\n  {\r\n    id: \"discount\",\r\n    accessorKey: \"discount\",\r\n    header: \"Giảm giá\",\r\n    cell: ({ row }) => formatCurrency(row.discount || 0),\r\n    meta: { displayName: \"Giảm giá\" },\r\n  },\r\n  {\r\n    id: \"notes\",\r\n    accessorKey: \"notes\",\r\n    header: \"Ghi chú\",\r\n    cell: ({ row }) => row.notes || '-',\r\n    meta: { displayName: \"Ghi chú\" },\r\n  },\r\n  {\r\n    id: \"creatorName\",\r\n    accessorKey: \"creatorName\",\r\n    header: \"Người tạo\",\r\n    cell: ({ row }) => row.creatorName || '-',\r\n    meta: { displayName: \"Người tạo\" },\r\n  },\r\n  {\r\n    id: \"grandTotal\",\r\n    accessorKey: \"grandTotal\",\r\n    header: \"Tổng tiền\",\r\n    cell: ({ row }) => {\r\n      // Tính lại từ lineItems nếu grandTotal = 0\r\n      let total = row.grandTotal;\r\n      if (total === 0 && row.lineItems && row.lineItems.length > 0) {\r\n        const itemsTotal = row.lineItems.reduce((sum, item) => {\r\n          const lineGross = item.quantity * item.unitPrice;\r\n          const discountAmount = item.discountType === 'percentage'\r\n            ? lineGross * (item.discount / 100)\r\n            : item.discount;\r\n          return sum + (lineGross - discountAmount);\r\n        }, 0);\r\n        total = itemsTotal + (row.shippingFee || 0) + (row.tax || 0);\r\n      }\r\n      return <span className=\"text-body-sm font-semibold\">{formatCurrency(total)}</span>;\r\n    },\r\n    meta: { displayName: \"Tổng tiền\" },\r\n  },\r\n  {\r\n    id: \"status\",\r\n    accessorKey: \"status\",\r\n    header: \"Trạng thái ĐH\",\r\n    cell: ({ row }) => <Badge variant={statusVariants[row.status] as any}>{row.status}</Badge>,\r\n    meta: { displayName: \"Trạng thái ĐH\" },\r\n  },\r\n  {\r\n    id: \"deliveryStatus\",\r\n    accessorKey: \"deliveryStatus\",\r\n    header: \"Trạng thái Nhận hàng\",\r\n    cell: ({ row }) => <Badge variant=\"outline\">{row.deliveryStatus}</Badge>,\r\n    meta: { displayName: \"Trạng thái Nhận hàng\" },\r\n  },\r\n   {\r\n    id: \"paymentStatus\",\r\n    accessorKey: \"paymentStatus\",\r\n    header: \"Trạng thái Thanh toán\",\r\n    cell: ({ row }) => <Badge variant={row.paymentStatus === 'Đã thanh toán' ? 'success' : 'warning' as any}>{row.paymentStatus}</Badge>,\r\n    meta: { displayName: \"Trạng thái Thanh toán\" },\r\n  },\r\n  {\r\n    id: \"returnStatus\",\r\n    accessorKey: \"returnStatus\",\r\n    header: \"Trạng thái Trả hàng\",\r\n    cell: ({ row }) => <Badge variant=\"outline\">{row.returnStatus || 'Chưa hoàn trả'}</Badge>,\r\n    meta: { displayName: \"Trạng thái Trả hàng\" },\r\n  },\r\n  {\r\n    id: \"refundStatus\",\r\n    accessorKey: \"refundStatus\",\r\n    header: \"Trạng thái Hoàn tiền\",\r\n    cell: ({ row }) => <Badge variant=\"outline\">{row.refundStatus || 'Chưa hoàn tiền'}</Badge>,\r\n    meta: { displayName: \"Trạng thái Hoàn tiền\" },\r\n  },\r\n   {\r\n    id: \"actions\",\r\n    header: () => <div className=\"text-center\">Hành động</div>,\r\n    cell: ({ row }) => {\r\n       const isActionable = row.status !== 'Hoàn thành' && row.status !== 'Đã hủy' && row.status !== 'Kết thúc';\r\n       return (\r\n       <div className=\"flex items-center justify-center\">\r\n         <DropdownMenu>\r\n           <DropdownMenuTrigger asChild>\r\n             <Button variant=\"ghost\" className=\"h-8 w-8 p-0\">\r\n               <span className=\"sr-only\">Mở menu</span>\r\n               <MoreHorizontal className=\"h-4 w-4\" />\r\n             </Button>\r\n           </DropdownMenuTrigger>\r\n           <DropdownMenuContent align=\"end\">\r\n             <DropdownMenuItem onClick={(e) => { e.stopPropagation(); onPrint(row); }}>\r\n               <Printer className=\"mr-2 h-4 w-4\" />\r\n               In đơn nhập hàng\r\n             </DropdownMenuItem>\r\n             <DropdownMenuItem \r\n               onClick={(e) => { e.stopPropagation(); onPayment(row); }}\r\n               disabled={row.paymentStatus === 'Đã thanh toán'}\r\n             >\r\n               <CreditCard className=\"mr-2 h-4 w-4\" />\r\n               Thanh toán\r\n             </DropdownMenuItem>\r\n             <DropdownMenuItem \r\n               onClick={(e) => { e.stopPropagation(); onReceiveGoods(row); }}\r\n               disabled={row.deliveryStatus === 'Đã nhập'}\r\n             >\r\n               <PackageCheck className=\"mr-2 h-4 w-4\" />\r\n               Nhập hàng\r\n             </DropdownMenuItem>\r\n             <DropdownMenuSeparator />\r\n             <DropdownMenuItem \r\n               onClick={(e) => { e.stopPropagation(); onCancel(row); }} \r\n               disabled={!isActionable}\r\n               className=\"text-destructive\"\r\n             >\r\n               <XCircle className=\"mr-2 h-4 w-4\" />\r\n               Hủy đơn\r\n             </DropdownMenuItem>\r\n           </DropdownMenuContent>\r\n         </DropdownMenu>\r\n       </div>\r\n    )},\r\n    meta: {\r\n      displayName: \"Hành động\",\r\n      sticky: \"right\",\r\n    },\r\n    size: 90,\r\n  },\r\n];\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 747, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/purchase-orders/purchase-order-card.tsx"],"sourcesContent":["import * as React from \"react\";\r\nimport { Card, CardContent } from \"../../components/ui/card\";\r\nimport { Badge } from \"../../components/ui/badge\";\r\nimport { DropdownMenu, DropdownMenuContent, DropdownMenuItem, DropdownMenuTrigger } from \"../../components/ui/dropdown-menu\";\r\nimport { TouchButton } from \"../../components/mobile/touch-button\";\r\nimport { Building2, Calendar, DollarSign, MoreHorizontal, Package, Printer, XCircle, CreditCard, PackageCheck } from \"lucide-react\";\r\nimport type { PurchaseOrder } from \"./types\";\r\nimport { formatDate } from \"../../lib/date-utils\";\r\n\r\nconst formatCurrency = (value?: number) => {\r\n  if (typeof value !== 'number' || isNaN(value)) return '0 ₫';\r\n  return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(value);\r\n};\r\n\r\ninterface PurchaseOrderCardProps {\r\n  purchaseOrder: PurchaseOrder;\r\n  onCancel: (po: PurchaseOrder) => void;\r\n  onPrint: (po: PurchaseOrder) => void;\r\n  onPayment: (po: PurchaseOrder) => void;\r\n  onReceiveGoods: (po: PurchaseOrder) => void;\r\n  onClick: (po: PurchaseOrder) => void;\r\n}\r\n\r\nexport function PurchaseOrderCard({ \r\n  purchaseOrder: po, \r\n  onCancel, \r\n  onPrint, \r\n  onPayment, \r\n  onReceiveGoods,\r\n  onClick \r\n}: PurchaseOrderCardProps) {\r\n  const getStatusVariant = (status: string): \"default\" | \"secondary\" | \"destructive\" | \"outline\" => {\r\n    const map: Record<string, \"default\" | \"secondary\" | \"destructive\" | \"outline\"> = {\r\n      'Đặt hàng': 'secondary',\r\n      'Đang giao dịch': 'default',\r\n      'Hoàn thành': 'default',\r\n      'Đã hủy': 'destructive',\r\n      'Kết thúc': 'outline'\r\n    };\r\n    return map[status] || 'default';\r\n  };\r\n\r\n  const getDeliveryStatusVariant = (status: string): \"default\" | \"secondary\" | \"destructive\" | \"outline\" => {\r\n    const map: Record<string, \"default\" | \"secondary\" | \"destructive\" | \"outline\"> = {\r\n      'Chưa nhập': 'secondary',\r\n      'Nhập một phần': 'default',\r\n      'Đã nhập': 'default'\r\n    };\r\n    return map[status] || 'default';\r\n  };\r\n\r\n  const getPaymentStatusVariant = (status: string): \"default\" | \"secondary\" | \"destructive\" | \"outline\" => {\r\n    const map: Record<string, \"default\" | \"secondary\" | \"destructive\" | \"outline\"> = {\r\n      'Chưa thanh toán': 'secondary',\r\n      'Thanh toán một phần': 'default',\r\n      'Đã thanh toán': 'default'\r\n    };\r\n    return map[status] || 'default';\r\n  };\r\n\r\n  return (\r\n    <Card \r\n      className=\"hover:shadow-md transition-shadow cursor-pointer\"\r\n      onClick={() => onClick(po)}\r\n    >\r\n      <CardContent className=\"p-4\">\r\n        {/* Header: Code + Status + Menu */}\r\n        <div className=\"flex items-center justify-between mb-2\">\r\n          <div className=\"flex items-center gap-2 flex-1 min-w-0\">\r\n            <div className=\"flex items-center gap-2 flex-wrap\">\r\n              <span className=\"text-body-sm font-medium font-mono\">{po.id}</span>\r\n              <Badge variant={getStatusVariant(po.status)} className=\"text-body-xs\">\r\n                {po.status}\r\n              </Badge>\r\n            </div>\r\n          </div>\r\n          <DropdownMenu>\r\n            <DropdownMenuTrigger asChild>\r\n              <TouchButton\r\n                variant=\"ghost\"\r\n                size=\"sm\"\r\n                className=\"h-8 w-8 p-0 flex-shrink-0\"\r\n                onClick={(e) => e.stopPropagation()}\r\n              >\r\n                <MoreHorizontal className=\"h-4 w-4\" />\r\n              </TouchButton>\r\n            </DropdownMenuTrigger>\r\n            <DropdownMenuContent align=\"end\">\r\n              <DropdownMenuItem \r\n                onClick={(e) => { \r\n                  e.stopPropagation(); \r\n                  onPrint(po); \r\n                }}\r\n              >\r\n                <Printer className=\"mr-2 h-4 w-4\" />\r\n                In đơn hàng\r\n              </DropdownMenuItem>\r\n              {po.status !== 'Đã hủy' && po.status !== 'Kết thúc' && (\r\n                <>\r\n                  {po.paymentStatus !== 'Đã thanh toán' && (\r\n                    <DropdownMenuItem \r\n                      onClick={(e) => { \r\n                        e.stopPropagation(); \r\n                        onPayment(po); \r\n                      }}\r\n                    >\r\n                      <CreditCard className=\"mr-2 h-4 w-4\" />\r\n                      Thanh toán\r\n                    </DropdownMenuItem>\r\n                  )}\r\n                  {po.deliveryStatus !== 'Đã nhập' && (\r\n                    <DropdownMenuItem \r\n                      onClick={(e) => { \r\n                        e.stopPropagation(); \r\n                        onReceiveGoods(po); \r\n                      }}\r\n                    >\r\n                      <PackageCheck className=\"mr-2 h-4 w-4\" />\r\n                      Nhập hàng\r\n                    </DropdownMenuItem>\r\n                  )}\r\n                  <DropdownMenuItem \r\n                    onClick={(e) => { \r\n                      e.stopPropagation(); \r\n                      onCancel(po); \r\n                    }}\r\n                    className=\"text-destructive\"\r\n                  >\r\n                    <XCircle className=\"mr-2 h-4 w-4\" />\r\n                    Hủy đơn\r\n                  </DropdownMenuItem>\r\n                </>\r\n              )}\r\n            </DropdownMenuContent>\r\n          </DropdownMenu>\r\n        </div>\r\n\r\n        {/* Supplier + Branch */}\r\n        <div className=\"text-body-sm font-medium mb-1\">{po.supplierName}</div>\r\n        <div className=\"text-body-xs text-muted-foreground mb-3 flex items-center\">\r\n          <Building2 className=\"h-3 w-3 mr-1.5 flex-shrink-0\" />\r\n          <span className=\"truncate\">{po.branchName}</span>\r\n        </div>\r\n\r\n        {/* Divider */}\r\n        <div className=\"border-t mb-3\" />\r\n\r\n        {/* Date Info */}\r\n        <div className=\"space-y-2 mb-3\">\r\n          <div className=\"flex items-center text-body-xs text-muted-foreground\">\r\n            <Calendar className=\"h-3 w-3 mr-1.5 flex-shrink-0\" />\r\n            <span>Đặt hàng: {formatDate(po.orderDate)}</span>\r\n          </div>\r\n          {po.deliveryDate && (\r\n            <div className=\"flex items-center text-body-xs text-muted-foreground\">\r\n              <Package className=\"h-3 w-3 mr-1.5 flex-shrink-0\" />\r\n              <span>Dự kiến: {formatDate(po.deliveryDate)}</span>\r\n            </div>\r\n          )}\r\n        </div>\r\n\r\n        {/* Delivery & Payment Status */}\r\n        <div className=\"flex flex-wrap gap-1.5 mb-3\">\r\n          <Badge variant={getDeliveryStatusVariant(po.deliveryStatus)} className=\"text-body-xs\">\r\n            {po.deliveryStatus}\r\n          </Badge>\r\n          <Badge variant={getPaymentStatusVariant(po.paymentStatus)} className=\"text-body-xs\">\r\n            {po.paymentStatus}\r\n          </Badge>\r\n        </div>\r\n\r\n        {/* Divider */}\r\n        <div className=\"border-t mb-3\" />\r\n\r\n        {/* Amount */}\r\n        <div className=\"flex items-center justify-between\">\r\n          <span className=\"text-body-xs text-muted-foreground\">Tổng tiền:</span>\r\n          <div className=\"flex items-center gap-1\">\r\n            <DollarSign className=\"h-3 w-3 text-muted-foreground\" />\r\n            <span className=\"text-body-sm font-semibold\">{formatCurrency(po.grandTotal)}</span>\r\n          </div>\r\n        </div>\r\n      </CardContent>\r\n    </Card>\r\n  );\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1172, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/purchase-orders/store.ts"],"sourcesContent":["import { create } from 'zustand';\r\n// REMOVED: import { data as initialDataOmit } from './data'; // Mock data no longer used - database is source of truth\r\nimport type { PurchaseOrder, PurchaseOrderPayment, PurchaseOrderStatus, DeliveryStatus, PaymentStatus, PurchaseOrderReturnStatus, PurchaseOrderRefundStatus } from './types';\r\nimport type { HistoryEntry } from '../../components/ActivityHistory';\r\n// REMOVED: Voucher store no longer exists\r\n// import { useVoucherStore } from '../vouchers/store';\r\nimport { useInventoryReceiptStore, syncInventoryReceiptsWithPurchaseOrders } from '../inventory-receipts/store';\r\nimport { usePaymentStore } from '../payments/store';\r\nimport type { Payment } from '../payments/types';\r\nimport { useReceiptStore } from '../receipts/store';\r\nimport type { Receipt } from '../receipts/types';\r\nimport { useEmployeeStore } from '../employees/store';\r\nimport { usePurchaseReturnStore } from '../purchase-returns/store';\r\nimport { formatDate, formatDateCustom, toISODate, toISODateTime } from '../../lib/date-utils';\r\nimport { useCashbookStore } from '../cashbook/store';\r\nimport { useReceiptTypeStore } from '../settings/receipt-types/store';\r\nimport { usePaymentTypeStore } from '../settings/payments/types/store';\r\nimport { createCrudStore } from '../../lib/store-factory';\r\nimport { sumPaymentsForPurchaseOrder } from './payment-utils';\r\nimport { useProductStore } from '../products/store';\r\nimport { asSystemId } from '@/lib/id-types';\r\n\r\n// REMOVED: initialDataOmit transformation - database is source of truth\r\nconst initialData: PurchaseOrder[] = [];\r\n\r\nconst baseStore = createCrudStore<any>([], 'purchase-orders', {\r\n  businessIdField: 'id',\r\n  apiEndpoint: '/api/purchase-orders',\r\n});\r\n\r\nconst runInventoryReceiptBackfill = () => {\r\n  syncInventoryReceiptsWithPurchaseOrders({\r\n    purchaseOrders: baseStore.getState().data,\r\n    products: useProductStore.getState().data,\r\n  });\r\n};\r\n\r\nrunInventoryReceiptBackfill();\r\n\r\n// Re-run backfill whenever purchase orders or products hydrate/update\r\n(baseStore as typeof baseStore & { subscribe?: (listener: () => void) => () => void }).subscribe?.(() => {\r\n  runInventoryReceiptBackfill();\r\n});\r\n\r\n(useProductStore as typeof useProductStore & { subscribe?: (listener: () => void) => () => void }).subscribe?.(() => {\r\n  runInventoryReceiptBackfill();\r\n});\r\n\r\n// Helper functions for ActivityHistory\r\nconst getCurrentUserInfo = () => {\r\n  const employees = useEmployeeStore.getState().data;\r\n  // Fallback to system user\r\n  return { systemId: 'SYSTEM', name: 'Hệ thống' };\r\n};\r\n\r\nconst createHistoryEntry = (\r\n  action: HistoryEntry['action'],\r\n  description: string,\r\n  user: { systemId: string; name: string },\r\n  metadata?: HistoryEntry['metadata']\r\n): HistoryEntry => ({\r\n  id: crypto.randomUUID(),\r\n  action,\r\n  timestamp: new Date(),\r\n  user: { systemId: user.systemId, name: user.name },\r\n  description,\r\n  metadata,\r\n});\r\n\r\nconst augmentedMethods = {\r\n  addPayment: (purchaseOrderId: string, payment: Omit<PurchaseOrderPayment, 'id'>) => baseStore.setState(state => {\r\n    const { data: allReturns } = usePurchaseReturnStore.getState();\r\n    const newData = state.data.map(po => {\r\n      if (po.systemId === purchaseOrderId) {\r\n        const poSystemId = asSystemId(po.systemId);\r\n        const newPayment: PurchaseOrderPayment = {\r\n          ...payment,\r\n          id: `PAY_${po.id}_${(po.payments || []).length + 1}`\r\n        };\r\n        const updatedPayments = [...(po.payments || []), newPayment];\r\n        const totalPaid = updatedPayments.reduce((sum, p) => sum + p.amount, 0);\r\n\r\n        const totalReturnedValue = allReturns\r\n          .filter(r => r.purchaseOrderSystemId === poSystemId)\r\n          .reduce((sum, r) => sum + r.totalReturnValue, 0);\r\n        const actualDebt = po.grandTotal - totalReturnedValue;\r\n        \r\n        let newPaymentStatus: PurchaseOrder['paymentStatus'];\r\n        if (totalPaid >= actualDebt) {\r\n          newPaymentStatus = 'Đã thanh toán';\r\n        } else if (totalPaid > 0) {\r\n          newPaymentStatus = 'Thanh toán một phần';\r\n        } else {\r\n          newPaymentStatus = 'Chưa thanh toán';\r\n        }\r\n\r\n        let newStatus: PurchaseOrderStatus = po.status;\r\n        if (po.status !== 'Đã hủy' && po.status !== 'Kết thúc') {\r\n          // Hoàn thành: đã nhập hết + đã thanh toán hết\r\n          if (po.deliveryStatus === 'Đã nhập' && newPaymentStatus === 'Đã thanh toán') {\r\n            newStatus = 'Hoàn thành';\r\n          }\r\n          // Đặt hàng: chưa nhập + chưa thanh toán\r\n          else if (po.deliveryStatus === 'Chưa nhập' && newPaymentStatus === 'Chưa thanh toán') {\r\n            newStatus = 'Đặt hàng';\r\n          }\r\n          // Đang giao dịch: tất cả trường hợp khác\r\n          else {\r\n            newStatus = 'Đang giao dịch';\r\n          }\r\n        }\r\n        \r\n        return { ...po, payments: updatedPayments, paymentStatus: newPaymentStatus, status: newStatus };\r\n      }\r\n      return po;\r\n    });\r\n    return { data: newData };\r\n  }),\r\n  updatePaymentStatusForPoIds: (poIds: string[]) => {\r\n    baseStore.setState(state => {\r\n        const { data: allPayments } = usePaymentStore.getState();\r\n        const { data: allReturns } = usePurchaseReturnStore.getState();\r\n        const uniquePoIds = [...new Set(poIds)];\r\n    \r\n        const newData = [...state.data];\r\n        let changed = false;\r\n\r\n        uniquePoIds.forEach(poId => {\r\n            const poIndex = newData.findIndex(p => p.id === poId);\r\n            if (poIndex === -1) return;\r\n\r\n            const po = newData[poIndex] as PurchaseOrder;\r\n            const poSystemId = asSystemId(po.systemId);\r\n            \r\n            const totalPaid = sumPaymentsForPurchaseOrder(allPayments, po);\r\n            \r\n            const totalReturnedValue = allReturns\r\n              .filter(r => r.purchaseOrderSystemId === poSystemId)\r\n                .reduce((sum, r) => sum + r.totalReturnValue, 0);\r\n            const actualDebt = po.grandTotal - totalReturnedValue;\r\n\r\n            let newPaymentStatus: PaymentStatus;\r\n            if (totalPaid >= actualDebt) {\r\n                newPaymentStatus = 'Đã thanh toán';\r\n            } else if (totalPaid > 0) {\r\n                newPaymentStatus = 'Thanh toán một phần';\r\n            } else {\r\n                newPaymentStatus = 'Chưa thanh toán';\r\n            }\r\n            \r\n            let newStatus: PurchaseOrderStatus = po.status;\r\n            if (po.status !== 'Đã hủy' && po.status !== 'Kết thúc') {\r\n              // Hoàn thành: đã nhập hết + đã thanh toán hết\r\n              if (po.deliveryStatus === 'Đã nhập' && newPaymentStatus === 'Đã thanh toán') {\r\n                newStatus = 'Hoàn thành';\r\n              }\r\n              // Đặt hàng: chưa nhập + chưa thanh toán\r\n              else if (po.deliveryStatus === 'Chưa nhập' && newPaymentStatus === 'Chưa thanh toán') {\r\n                newStatus = 'Đặt hàng';\r\n              }\r\n              // Đang giao dịch: tất cả trường hợp khác\r\n              else {\r\n                newStatus = 'Đang giao dịch';\r\n              }\r\n            }\r\n\r\n            if (po.paymentStatus !== newPaymentStatus || po.status !== newStatus) {\r\n                newData[poIndex] = { ...po, paymentStatus: newPaymentStatus, status: newStatus };\r\n                changed = true;\r\n            }\r\n        });\r\n\r\n        return changed ? { data: newData } : state;\r\n    });\r\n  },\r\n  processInventoryReceipt: (purchaseOrderSystemId: string) => {\r\n    baseStore.setState(state => {\r\n      const { data: allReceipts } = useInventoryReceiptStore.getState();\r\n      const poIndex = state.data.findIndex(p => p.systemId === purchaseOrderSystemId);\r\n      if (poIndex === -1) return state;\r\n\r\n      const po = state.data[poIndex] as PurchaseOrder;\r\n      const poReceipts = allReceipts.filter(r => r.purchaseOrderSystemId === purchaseOrderSystemId);\r\n      const totalReceivedByProduct = po.lineItems.reduce((acc, lineItem) => {\r\n        const totalReceived = poReceipts.reduce((sum, receipt) => {\r\n          const item = receipt.items.find(i => i.productSystemId === lineItem.productSystemId);\r\n          return sum + (item ? Number(item.receivedQuantity) : 0);\r\n        }, 0);\r\n        acc[lineItem.productSystemId] = totalReceived;\r\n        return acc;\r\n      }, {} as Record<string, number>);\r\n\r\n      const allItemsFullyReceived = po.lineItems.every(item => (totalReceivedByProduct[item.productSystemId] || 0) >= item.quantity);\r\n      const anyItemReceived = Object.values(totalReceivedByProduct).some(qty => qty > 0);\r\n\r\n      let newDeliveryStatus: DeliveryStatus;\r\n      if (allItemsFullyReceived) {\r\n        newDeliveryStatus = 'Đã nhập';\r\n      } else if (anyItemReceived) {\r\n        newDeliveryStatus = 'Đã nhập một phần';\r\n      } else {\r\n        newDeliveryStatus = 'Chưa nhập';\r\n      }\r\n      \r\n      let newStatus: PurchaseOrderStatus = po.status;\r\n      // Chỉ tự động cập nhật status nếu KHÔNG phải trạng thái terminal\r\n      if (po.status !== 'Đã hủy' && po.status !== 'Kết thúc') {\r\n          // Hoàn thành: đã nhập hết + đã thanh toán hết\r\n          if (newDeliveryStatus === 'Đã nhập' && po.paymentStatus === 'Đã thanh toán') {\r\n            newStatus = 'Hoàn thành';\r\n          }\r\n          // Đặt hàng: chưa nhập + chưa thanh toán\r\n          else if (newDeliveryStatus === 'Chưa nhập' && po.paymentStatus === 'Chưa thanh toán') {\r\n            newStatus = 'Đặt hàng';\r\n          }\r\n          // Đang giao dịch: tất cả trường hợp khác\r\n          else {\r\n            newStatus = 'Đang giao dịch';\r\n          }\r\n      }\r\n\r\n      if (po.deliveryStatus !== newDeliveryStatus || po.status !== newStatus) {\r\n        const newData = [...state.data];\r\n        const updatedPO: PurchaseOrder = { ...po, deliveryStatus: newDeliveryStatus, status: newStatus };\r\n\r\n        if (po.deliveryStatus === 'Chưa nhập' && newDeliveryStatus !== 'Chưa nhập') {\r\n          const latestReceipt = poReceipts.sort((a,b) => new Date(b.receivedDate).getTime() - new Date(a.receivedDate).getTime())[0];\r\n          if (latestReceipt) {\r\n            updatedPO.deliveryDate = latestReceipt.receivedDate;\r\n          }\r\n        }\r\n\r\n        newData[poIndex] = updatedPO;\r\n\r\n        const latestReceipt = poReceipts.sort((a,b) => new Date(b.receivedDate).getTime() - new Date(a.receivedDate).getTime())[0];\r\n        const receiptReceiverName = latestReceipt?.receiverName || 'Hệ thống';\r\n        const user = latestReceipt?.receiverSystemId\r\n          ? useEmployeeStore.getState().data.find(e => e.systemId === latestReceipt.receiverSystemId)\r\n          : useEmployeeStore.getState().data.find(e => e.fullName === receiptReceiverName);\r\n\r\n        // Add to activityHistory\r\n        const historyEntry = createHistoryEntry(\r\n          'status_changed',\r\n          `Cập nhật trạng thái giao hàng thành \"${newDeliveryStatus}\" thông qua phiếu nhập kho ${latestReceipt.id}.`,\r\n          { systemId: user?.systemId || 'SYSTEM', name: receiptReceiverName },\r\n          { oldValue: po.deliveryStatus, newValue: newDeliveryStatus, field: 'deliveryStatus' }\r\n        );\r\n        newData[poIndex] = {\r\n          ...updatedPO,\r\n          activityHistory: [...(updatedPO.activityHistory || []), historyEntry],\r\n        };\r\n\r\n        return { data: newData };\r\n      }\r\n\r\n      return state;\r\n    });\r\n  },\r\n  processReturn: (purchaseOrderId, isFullReturn, newRefundStatus, returnId, creatorName) => baseStore.setState(state => {\r\n        const poIndex = state.data.findIndex(p => p.id === purchaseOrderId);\r\n        if (poIndex === -1) return state;\r\n\r\n        const po = state.data[poIndex] as PurchaseOrder;\r\n\r\n        let newReturnStatus: PurchaseOrderReturnStatus = 'Hoàn hàng một phần';\r\n        if (isFullReturn) {\r\n            newReturnStatus = 'Hoàn hàng toàn bộ';\r\n        }\r\n        \r\n        // QUAN TRỌNG: Không đè status thành \"Đã trả hàng\"\r\n        // Chỉ cập nhật returnStatus, giữ nguyên status chính (Hoàn thành, Đang giao dịch, etc.)\r\n        // Logic tự động sẽ xử lý status dựa trên deliveryStatus + paymentStatus\r\n        \r\n        const updatedPO = { \r\n            ...po, \r\n            returnStatus: newReturnStatus,\r\n            // Bỏ dòng: status: newStatus,  \r\n            ...(newRefundStatus && { refundStatus: newRefundStatus })\r\n        };\r\n        \r\n        if (returnId && creatorName) {\r\n            const user = useEmployeeStore.getState().data.find(e => e.fullName === creatorName);\r\n            // Add to activityHistory\r\n            const historyEntry = createHistoryEntry(\r\n              'status_changed',\r\n              `Tạo phiếu hoàn trả ${returnId}, cập nhật trạng thái hoàn trả đơn hàng.`,\r\n              { systemId: user?.systemId || 'SYSTEM', name: creatorName },\r\n              { oldValue: po.returnStatus || 'Chưa hoàn trả', newValue: newReturnStatus, field: 'returnStatus' }\r\n            );\r\n            updatedPO.activityHistory = [...(updatedPO.activityHistory || []), historyEntry];\r\n        }\r\n        \r\n        const newData = [...state.data];\r\n        newData[poIndex] = updatedPO;\r\n\r\n        return { data: newData };\r\n    }),\r\n  syncAllPurchaseOrderStatuses: () => baseStore.setState(state => {\r\n      const { data: allPayments } = usePaymentStore.getState();\r\n      const { data: allReturns } = usePurchaseReturnStore.getState();\r\n      const newData = state.data.map((po_untyped) => {\r\n        const po = po_untyped as PurchaseOrder;\r\n        const poSystemId = asSystemId(po.systemId);\r\n        const totalPaid = sumPaymentsForPurchaseOrder(allPayments, po);\r\n        \r\n        const totalReturnedValue = allReturns\r\n          .filter(r => r.purchaseOrderSystemId === poSystemId)\r\n          .reduce((sum, r) => sum + r.totalReturnValue, 0);\r\n        const actualDebt = po.grandTotal - totalReturnedValue;\r\n        \r\n        let newPaymentStatus: PaymentStatus;\r\n        if (totalPaid >= actualDebt) {\r\n          newPaymentStatus = 'Đã thanh toán';\r\n        } else if (totalPaid > 0) {\r\n          newPaymentStatus = 'Thanh toán một phần';\r\n        } else {\r\n          newPaymentStatus = 'Chưa thanh toán';\r\n        }\r\n        \r\n        let newStatus: PurchaseOrderStatus = po.status;\r\n        // Chỉ tự động cập nhật status nếu KHÔNG phải trạng thái terminal (Đã hủy, Kết thúc)\r\n        // Bỏ check \"Đã trả hàng\" vì đây không còn là status chính nữa\r\n        if (po.status !== 'Đã hủy' && po.status !== 'Kết thúc') {\r\n          // Hoàn thành: đã nhập hết + đã thanh toán hết\r\n          if (po.deliveryStatus === 'Đã nhập' && newPaymentStatus === 'Đã thanh toán') {\r\n            newStatus = 'Hoàn thành';\r\n          }\r\n          // Đặt hàng: chưa nhập + chưa thanh toán\r\n          else if (po.deliveryStatus === 'Chưa nhập' && newPaymentStatus === 'Chưa thanh toán') {\r\n            newStatus = 'Đặt hàng';\r\n          }\r\n          // Đang giao dịch: tất cả trường hợp khác (đã có hoạt động nhập hoặc thanh toán)\r\n          else {\r\n            newStatus = 'Đang giao dịch';\r\n          }\r\n        }\r\n        \r\n        if (po.paymentStatus !== newPaymentStatus || po.status !== newStatus) {\r\n            return { ...po, paymentStatus: newPaymentStatus, status: newStatus };\r\n        }\r\n        return po;\r\n      });\r\n\r\n      const hasChanged = newData.some((po, index) => po !== state.data[index]);\r\n      return hasChanged ? { data: newData } : state;\r\n    }),\r\n  finishOrder: (systemId: string, userId: string, userName: string) => baseStore.setState(state => {\r\n    const poIndex = state.data.findIndex(p => p.systemId === systemId);\r\n    if (poIndex === -1) return state;\r\n\r\n    const po = state.data[poIndex];\r\n    if (po.status === 'Kết thúc' || po.status === 'Đã hủy') return state;\r\n\r\n    // Add to activityHistory\r\n    const historyEntry = createHistoryEntry(\r\n      'ended',\r\n      `Đã kết thúc đơn hàng.`,\r\n      { systemId: userId, name: userName },\r\n      { oldValue: po.status, newValue: 'Kết thúc', field: 'status' }\r\n    );\r\n    const updatedPO = { \r\n      ...po, \r\n      status: 'Kết thúc' as PurchaseOrderStatus,\r\n      activityHistory: [...(po.activityHistory || []), historyEntry],\r\n    };\r\n    \r\n    const newData = [...state.data];\r\n    newData[poIndex] = updatedPO;\r\n    return { data: newData };\r\n  }),\r\n  cancelOrder: (systemId: string, userId: string, userName: string) => baseStore.setState((state) => {\r\n    const po = state.data.find(p => p.systemId === systemId);\r\n\r\n    if (!po || ['Hoàn thành', 'Đã hủy', 'Kết thúc'].includes(po.status)) {\r\n        console.warn(`Attempted to cancel an order with status: ${po?.status}`);\r\n        return state;\r\n    }\r\n\r\n    const { data: allPayments } = usePaymentStore.getState();\r\n    const totalPaid = sumPaymentsForPurchaseOrder(allPayments, po);\r\n\r\n    if (totalPaid > 0) {\r\n        const { accounts } = useCashbookStore.getState();\r\n        const { data: receiptTypes } = useReceiptTypeStore.getState();\r\n        const { add: addReceipt } = useReceiptStore.getState();\r\n        const refundCategory = receiptTypes.find(rt => rt.name === 'Nhà cung cấp hoàn tiền');\r\n        const targetAccount = accounts.find(acc => acc.type === 'cash' && acc.branchSystemId === po.branchSystemId) || accounts.find(acc => acc.type === 'cash');\r\n\r\n        if (refundCategory && targetAccount) {\r\n           const newReceipt: Omit<Receipt, 'systemId'> = {\r\n            id: '' as any, // Let receipt store generate PT-XXXXXX\r\n            date: toISODateTime(new Date()),\r\n            amount: totalPaid,\r\n            payerType: 'Nhà cung cấp',\r\n            payerTypeSystemId: 'NHACUNGCAP',\r\n            payerTypeName: 'Nhà cung cấp',\r\n            payerName: po.supplierName,\r\n            payerSystemId: po.supplierSystemId,\r\n            description: `Nhận hoàn tiền từ NCC cho đơn hàng ${po.id} bị hủy.`,\r\n            paymentMethod: 'Tiền mặt',\r\n            paymentMethodSystemId: 'CASH',\r\n            paymentMethodName: 'Tiền mặt',\r\n            accountSystemId: targetAccount.systemId,\r\n            paymentReceiptTypeSystemId: refundCategory.systemId,\r\n            paymentReceiptTypeName: refundCategory.name,\r\n            branchSystemId: po.branchSystemId,\r\n            branchName: po.branchName,\r\n            createdBy: userName,\r\n            createdAt: toISODateTime(new Date()),\r\n            status: 'completed',\r\n            category: 'other',\r\n            affectsDebt: true,\r\n            purchaseOrderSystemId: po.systemId,\r\n            purchaseOrderId: po.id,\r\n            originalDocumentId: po.id,\r\n          } as any;\r\n          addReceipt(newReceipt);\r\n        } else {\r\n            console.error(\"Không thể tạo phiếu thu hoàn tiền: Thiếu loại phiếu 'Nhà cung cấp hoàn tiền' hoặc tài khoản quỹ tiền mặt.\");\r\n        }\r\n    }\r\n    \r\n    // Add to activityHistory\r\n    const historyEntry = createHistoryEntry(\r\n      'cancelled',\r\n      `Đã hủy đơn hàng.`,\r\n      { systemId: userId, name: userName },\r\n      { oldValue: po.status, newValue: 'Đã hủy', field: 'status' }\r\n    );\r\n    const updatedPO = { \r\n      ...po, \r\n      status: 'Đã hủy' as const,\r\n      activityHistory: [...(po.activityHistory || []), historyEntry],\r\n    };\r\n    \r\n    return { data: state.data.map(item => item.systemId === systemId ? updatedPO : item) };\r\n  }),\r\n  \r\n  bulkCancel: (systemIds: string[], userId: string, userName: string) => {\r\n    systemIds.forEach(systemId => {\r\n      augmentedMethods.cancelOrder(systemId, userId, userName);\r\n    });\r\n  },\r\n  \r\n  printPurchaseOrders: (systemIds: string[]) => {\r\n    // Placeholder for print functionality\r\n    console.log('Printing purchase orders:', systemIds);\r\n    // TODO: Implement actual print logic\r\n  },\r\n};\r\n\r\n// Define the enhanced store interface\r\nexport interface PurchaseOrderStoreState {\r\n  data: PurchaseOrder[];\r\n  add: (item: Omit<PurchaseOrder, 'systemId'>) => PurchaseOrder;\r\n  addMultiple: (items: Omit<PurchaseOrder, 'systemId'>[]) => void;\r\n  update: (systemId: string, item: PurchaseOrder) => void;\r\n  remove: (systemId: string) => void;\r\n  findById: (systemId: string) => PurchaseOrder | undefined;\r\n  addPayment: (purchaseOrderId: string, payment: Omit<PurchaseOrderPayment, 'id'>) => void;\r\n  updatePaymentStatusForPoIds: (poIds: string[]) => void;\r\n  processInventoryReceipt: (purchaseOrderSystemId: string) => void;\r\n  processReturn: (purchaseOrderId: string, isFullReturn: boolean, newRefundStatus: PurchaseOrderRefundStatus | undefined, returnId: string, creatorName: string) => void;\r\n  syncAllPurchaseOrderStatuses: () => void;\r\n  finishOrder: (systemId: string, userId: string, userName: string) => void;\r\n  cancelOrder: (systemId: string, userId: string, userName: string) => void;\r\n  bulkCancel: (systemIds: string[], userId: string, userName: string) => void;\r\n  printPurchaseOrders: (systemIds: string[]) => void;\r\n}\r\n\r\n// Export typed hook\r\nexport const usePurchaseOrderStore = (): PurchaseOrderStoreState => {\r\n  const state = baseStore();\r\n  return {\r\n    ...state,\r\n    ...augmentedMethods,\r\n  };\r\n};\r\n\r\n// Export getState for non-hook usage\r\nusePurchaseOrderStore.getState = () => {\r\n  const state = baseStore.getState();\r\n  return {\r\n    ...state,\r\n    ...augmentedMethods,\r\n  };\r\n};\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1641, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/purchase-orders/page.tsx"],"sourcesContent":["'use client'\r\n\r\nimport * as React from \"react\"\r\nimport { useRouter } from 'next/navigation';\r\nimport { ROUTES } from '../../lib/router';\r\nimport { formatDate, formatDateTime, formatDateTimeSeconds, formatDateCustom, parseDate, getCurrentDate, toISODate } from '../../lib/date-utils';\r\nimport { usePurchaseOrders, usePurchaseOrderMutations } from \"./hooks/use-purchase-orders\"\r\nimport { sumPaymentsForPurchaseOrder } from \"./payment-utils\"\r\nimport { useAllBranches } from '../settings/branches/hooks/use-branches';\r\nimport { getColumns } from \"./columns\"\r\nimport { ResponsiveDataTable } from \"../../components/data-table/responsive-data-table\"\r\nimport { DataTableFacetedFilter } from \"../../components/data-table/data-table-faceted-filter\"\r\nimport { DataTableColumnCustomizer } from \"../../components/data-table/data-table-column-toggle\";\r\nimport { PageToolbar } from \"../../components/layout/page-toolbar\"\r\nimport { PageFilters } from \"../../components/layout/page-filters\"\r\nimport { Input } from \"../../components/ui/input\"\r\nimport { PurchaseOrderCard } from \"./purchase-order-card\"\r\nimport { useBreakpoint } from \"../../contexts/breakpoint-context\";\r\nimport { Card, CardContent } from \"../../components/ui/card\"\r\nimport {\r\n  AlertDialog,\r\n  AlertDialogAction,\r\n  AlertDialogCancel,\r\n  AlertDialogContent,\r\n  AlertDialogDescription,\r\n  AlertDialogFooter,\r\n  AlertDialogHeader,\r\n  AlertDialogTitle,\r\n} from \"../../components/ui/alert-dialog\"\r\nimport { Button } from \"../../components/ui/button\"\r\nimport { PlusCircle, Printer, XCircle, CreditCard, PackageCheck } from \"lucide-react\"\r\nimport Fuse from \"fuse.js\"\r\nimport { usePageHeader } from \"../../contexts/page-header-context\";\r\nimport type { PurchaseOrder } from \"./types\";\r\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"../../components/ui/select\";\r\nimport { usePayments, usePaymentMutations } from '../payments/hooks/use-payments';\r\nimport type { Payment } from '../payments/types';\r\nimport { useAllSuppliers } from '../suppliers/hooks/use-suppliers';\r\nimport { useInventoryReceipts, useInventoryReceiptMutations } from '../inventory-receipts/hooks/use-inventory-receipts';\r\nimport { useProducts, useProductMutations } from '../products/hooks/use-products';\r\nimport { useStockHistoryStore } from '../stock-history/store'; // Keep for now - no RQ hook\r\nimport { useCashbookAccounts } from '../cashbook/hooks/use-cashbook';\r\nimport { usePaymentTypes } from '../settings/payments/types/hooks/use-payment-types';\r\nimport { usePurchaseReturnStore } from \"../purchase-returns/store\"; // Keep for now - no RQ hook\r\nimport { usePurchaseOrderStore } from \"./store\"; // For processInventoryReceipt\r\nimport type { PurchaseReturnLineItem } from \"../purchase-returns/types\";\r\nimport { toast } from 'sonner';\r\nimport { useAuth } from \"../../contexts/auth-context\";\r\nimport { Dialog, DialogContent, DialogDescription, DialogFooter, DialogHeader, DialogTitle } from \"../../components/ui/dialog\";\r\nimport { Label } from \"../../components/ui/label\";\r\nimport { Textarea } from \"../../components/ui/textarea\";\r\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from \"../../components/ui/table\";\r\nimport { asBusinessId, asSystemId } from \"@/lib/id-types\";\r\nimport type { SystemId } from \"@/lib/id-types\";\r\nimport { useStoreInfo } from '../settings/store-info/hooks/use-store-info';\r\nimport { usePrint } from '../../lib/use-print';\r\nimport { \r\n  convertPurchaseOrderForPrint,\r\n  mapPurchaseOrderToPrintData,\r\n  mapPurchaseOrderLineItems,\r\n  createStoreSettings,\r\n} from '../../lib/print/purchase-order-print-helper';\r\nimport { SimplePrintOptionsDialog, SimplePrintOptionsResult } from '../../components/shared/simple-print-options-dialog';\r\nimport { GenericImportDialogV2 } from \"../../components/shared/generic-import-dialog-v2\";\r\nimport { GenericExportDialogV2 } from \"../../components/shared/generic-export-dialog-v2\";\r\nimport { purchaseOrderImportExportConfig, flattenPurchaseOrdersForExport } from \"../../lib/import-export/configs/purchase-order.config\";\r\nimport { FileSpreadsheet, Download } from \"lucide-react\";\r\nimport { useColumnVisibility } from '../../hooks/use-column-visibility';\r\n\r\nconst formatCurrency = (value?: number) => {\r\n    if (typeof value !== 'number' || isNaN(value)) return '0 ₫';\r\n    return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(value);\r\n};\r\n\r\ntype ReceiveLineItemForm = {\r\n  productSystemId: SystemId;\r\n  productId: string;\r\n  productName: string;\r\n  orderedQuantity: number;\r\n  remainingQuantity: number;\r\n  receiveQuantity: number;\r\n  unitPrice: number;\r\n};\r\n\r\ntype ReceiveDialogState = {\r\n  isOpen: boolean;\r\n  purchaseOrder: PurchaseOrder | null;\r\n  receivedDate: string;\r\n  targetBranchSystemId: SystemId | null;\r\n  targetBranchName: string;\r\n  warehouseName: string;\r\n  documentCode: string;\r\n  notes: string;\r\n  items: ReceiveLineItemForm[];\r\n};\r\n\r\nexport function PurchaseOrdersPage() {\r\n  // React Query hooks\r\n  const { data: purchaseOrdersData } = usePurchaseOrders();\r\n  const purchaseOrders = purchaseOrdersData?.data || [];\r\n  const { update: updatePurchaseOrderMutation } = usePurchaseOrderMutations();\r\n  \r\n  const { data: branchesData } = useAllBranches();\r\n  const branches = branchesData?.data || [];\r\n  const { data: suppliersData } = useAllSuppliers();\r\n  const suppliers = suppliersData || [];\r\n  const { data: storeInfoData } = useStoreInfo();\r\n  const storeInfo = storeInfoData || null;\r\n  \r\n  // Helper functions\r\n  const findBranchById = React.useCallback((systemId: string) => {\r\n    return branches.find(b => b.systemId === systemId);\r\n  }, [branches]);\r\n  \r\n  const findSupplierById = React.useCallback((systemId: string) => {\r\n    return suppliers.find(s => s.systemId === systemId);\r\n  }, [suppliers]);\r\n  \r\n  // Legacy functions - create wrappers\r\n  const cancelOrder = React.useCallback((systemId: string, reason?: string) => {\r\n    updatePurchaseOrderMutation.mutate({\r\n      systemId,\r\n      data: { status: 'Đã hủy', notes: reason }\r\n    });\r\n  }, [updatePurchaseOrderMutation]);\r\n  \r\n  const bulkCancel = React.useCallback((systemIds: string[], reason?: string) => {\r\n    systemIds.forEach(id => cancelOrder(id, reason));\r\n  }, [cancelOrder]);\r\n  \r\n  // Sync not needed with React Query - data updates automatically\r\n  const syncAllPurchaseOrderStatuses = React.useCallback(() => {\r\n    // No-op - React Query handles data freshness\r\n  }, []);\r\n  \r\n  const { print } = usePrint();\r\n  const router = useRouter();\r\n  const { isMobile } = useBreakpoint();\r\n  \r\n  // Sync payment statuses when component mounts hoặc khi vouchers thay đổi\r\n  React.useEffect(() => {\r\n    syncAllPurchaseOrderStatuses();\r\n  }, [syncAllPurchaseOrderStatuses]);\r\n  \r\n  const headerActions = React.useMemo(() => [\r\n    <Button\r\n      key=\"add\"\r\n      className=\"h-9\"\r\n      size=\"sm\"\r\n      onClick={() => router.push(ROUTES.PROCUREMENT.PURCHASE_ORDER_NEW)}\r\n    >\r\n      <PlusCircle className=\"mr-2 h-4 w-4\" />\r\n      Tạo đơn nhập hàng\r\n    </Button>\r\n  ], [router]);\r\n\r\n  usePageHeader({\r\n    title: \"Đơn nhập hàng\",\r\n    breadcrumb: [\r\n      { label: 'Trang chủ', href: '/', isCurrent: false },\r\n      { label: 'Đơn nhập hàng', href: ROUTES.PROCUREMENT.PURCHASE_ORDERS, isCurrent: true }\r\n    ],\r\n    actions: headerActions,\r\n    showBackButton: false\r\n  });\r\n  \r\n  // Data stores for actions\r\n  const { data: paymentsData } = usePayments();\r\n  const allPayments = paymentsData?.data || [];\r\n  const { create: addPaymentMutation } = usePaymentMutations();\r\n  \r\n  const { data: receiptsData } = useInventoryReceipts();\r\n  const allReceipts = receiptsData?.data || [];\r\n  const { create: addReceiptMutation } = useInventoryReceiptMutations();\r\n  const addInventoryReceipt = React.useCallback((data: any) => {\r\n    return addReceiptMutation.mutateAsync(data);\r\n  }, [addReceiptMutation]);\r\n  \r\n  const { data: productsData } = useProducts();\r\n  const allProducts = productsData?.data || [];\r\n  const { update: updateProductMutation } = useProductMutations();\r\n  const findProductById = React.useCallback((systemId: string) => {\r\n    return allProducts.find(p => p.systemId === systemId);\r\n  }, [allProducts]);\r\n  const updateInventory = React.useCallback((systemId: string, branchSystemId: string, quantityChange: number) => {\r\n    const product = findProductById(systemId);\r\n    if (product) {\r\n      const currentInventory = product.inventoryByBranch || {};\r\n      const currentQuantity = (currentInventory as any)[branchSystemId] || 0;\r\n      updateProductMutation.mutate({\r\n        systemId,\r\n        inventoryByBranch: {\r\n          ...currentInventory,\r\n          [branchSystemId]: currentQuantity + quantityChange\r\n        }\r\n      });\r\n    }\r\n  }, [findProductById, updateProductMutation]);\r\n  \r\n  const { addEntry: addStockHistoryEntry } = useStockHistoryStore();\r\n  const { processInventoryReceipt } = usePurchaseOrderStore();\r\n  const { data: cashbookData } = useCashbookAccounts();\r\n  const accounts = cashbookData || [];\r\n  const { data: paymentTypesData } = usePaymentTypes();\r\n  const paymentTypes = paymentTypesData?.data || [];\r\n  const { employee: loggedInUser } = useAuth();\r\n  const { add: addPurchaseReturn, data: allPurchaseReturns } = usePurchaseReturnStore();\r\n  const currentUserSystemId = loggedInUser?.systemId ?? 'SYSTEM';\r\n  const currentUserName = loggedInUser?.fullName ?? 'Hệ thống';\r\n\r\n\r\n  const [rowSelection, setRowSelection] = React.useState<Record<string, boolean>>({})\r\n  const [cancelDialogState, setCancelDialogState] = React.useState<{\r\n    isOpen: boolean;\r\n    po: PurchaseOrder | null;\r\n    willCreateReturn?: boolean;\r\n    totalPaid?: number;\r\n  }>({ isOpen: false, po: null });\r\n\r\n  const [isBulkPayAlertOpen, setIsBulkPayAlertOpen] = React.useState(false);\r\n  const [showImportDialog, setShowImportDialog] = React.useState(false);\r\n  const [showExportDialog, setShowExportDialog] = React.useState(false);\r\n  const [receiveDialogState, setReceiveDialogState] = React.useState<ReceiveDialogState>({\r\n    isOpen: false,\r\n    purchaseOrder: null,\r\n    receivedDate: '',\r\n    targetBranchSystemId: null,\r\n    targetBranchName: '',\r\n    warehouseName: '',\r\n    documentCode: '',\r\n    notes: '',\r\n    items: [],\r\n  });\r\n  const [pendingReceiveQueue, setPendingReceiveQueue] = React.useState<PurchaseOrder[]>([]);\r\n  const [isSubmittingReceive, setIsSubmittingReceive] = React.useState(false);\r\n  \r\n  const [sorting, setSorting] = React.useState<{ id: string, desc: boolean }>({ id: 'createdAt', desc: true });\r\n  const [globalFilter, setGlobalFilter] = React.useState('');\r\n  const [branchFilter, setBranchFilter] = React.useState('all');\r\n  const [statusFilter, setStatusFilter] = React.useState('all');\r\n  const [paymentStatusFilter, setPaymentStatusFilter] = React.useState('all');\r\n  const [pagination, setPagination] = React.useState({ pageIndex: 0, pageSize: 10 });\r\n  \r\n  // Get initial column visibility from columns\r\n  const cols = React.useMemo(() => getColumns(() => {}, () => {}, () => {}, () => {}, []), []);\r\n  const defaultVisibility = React.useMemo(() => {\r\n    const initial: Record<string, boolean> = {};\r\n    cols.forEach(c => { if (c.id) initial[c.id] = true; });\r\n    return initial;\r\n  }, [cols]);\r\n  \r\n  // Use hook for column visibility (database-backed)\r\n  const [columnVisibility, setColumnVisibility] = useColumnVisibility('purchase-orders', defaultVisibility);\r\n  \r\n  const [columnOrder, setColumnOrder] = React.useState<string[]>([]);\r\n  const [pinnedColumns, setPinnedColumns] = React.useState<string[]>([]);\r\n\r\n  // Mobile infinite scroll state\r\n  const [mobileLoadedCount, setMobileLoadedCount] = React.useState(20);\r\n\r\n  // Reset mobile loaded count when filters change\r\n  React.useEffect(() => {\r\n    setMobileLoadedCount(20);\r\n  }, [globalFilter, branchFilter, statusFilter, paymentStatusFilter]);\r\n\r\n  const handleCancelRequest = React.useCallback((po: PurchaseOrder) => {\r\n    const totalPaid = sumPaymentsForPurchaseOrder(allPayments, po);\r\n\r\n    const hasBeenDelivered = po.deliveryStatus !== 'Chưa nhập';\r\n\r\n    setCancelDialogState({ \r\n        isOpen: true, \r\n        po: po, \r\n        totalPaid: totalPaid,\r\n        willCreateReturn: hasBeenDelivered \r\n    });\r\n  }, [allPayments]);\r\n\r\n  const confirmCancel = () => {\r\n    if (!cancelDialogState.po) return;\r\n    const po = cancelDialogState.po;\r\n\r\n    if (cancelDialogState.willCreateReturn) {\r\n        const poSystemId = asSystemId(po.systemId);\r\n        const receiptsForPO = allReceipts.filter(r => r.purchaseOrderSystemId === poSystemId);\r\n        const returnsForPO = allPurchaseReturns.filter(pr => pr.purchaseOrderSystemId === poSystemId);\r\n\r\n        const returnItems = po.lineItems\r\n          .map<PurchaseReturnLineItem | null>(item => {\r\n            const totalReceived = receiptsForPO.reduce((sum, receipt) => {\r\n              const receiptItem = receipt.items.find(i => i.productSystemId === item.productSystemId);\r\n              return sum + (receiptItem ? Number(receiptItem.receivedQuantity) : 0);\r\n            }, 0);\r\n            const totalReturned = returnsForPO.reduce((sum, pr) => {\r\n              const returnItem = pr.items.find(i => i.productSystemId === item.productSystemId);\r\n              return sum + (returnItem ? returnItem.returnQuantity : 0);\r\n            }, 0);\r\n            const returnableQuantity = totalReceived - totalReturned;\r\n\r\n            if (returnableQuantity <= 0) {\r\n              return null;\r\n            }\r\n\r\n            return {\r\n              productSystemId: asSystemId(item.productSystemId),\r\n              productId: asBusinessId(item.productId),\r\n              productName: item.productName,\r\n              orderedQuantity: item.quantity,\r\n              returnQuantity: returnableQuantity,\r\n              unitPrice: item.unitPrice,\r\n            } satisfies PurchaseReturnLineItem;\r\n          })\r\n          .filter((item): item is PurchaseReturnLineItem => Boolean(item));\r\n\r\n        if (returnItems.length > 0) {\r\n          const totalReturnValue = returnItems.reduce((sum, item) => sum + (item.returnQuantity * item.unitPrice), 0);\r\n\r\n          addPurchaseReturn({\r\n            id: asBusinessId(''),\r\n            purchaseOrderSystemId: asSystemId(po.systemId),\r\n            purchaseOrderId: asBusinessId(po.id),\r\n            supplierSystemId: asSystemId(po.supplierSystemId),\r\n            supplierName: po.supplierName,\r\n            branchSystemId: asSystemId(po.branchSystemId),\r\n            branchName: po.branchName,\r\n            returnDate: toISODate(getCurrentDate()),\r\n            reason: `Tự động tạo khi hủy đơn nhập hàng ${po.id}`,\r\n            items: returnItems,\r\n            totalReturnValue,\r\n            refundAmount: 0,\r\n            refundMethod: '',\r\n            creatorName: currentUserName,\r\n          });\r\n        }\r\n    }\r\n\r\n    cancelOrder(po.systemId, `Hủy bởi ${currentUserName}`);\r\n    setCancelDialogState({ isOpen: false, po: null });\r\n  };\r\n\r\n  const requireLoggedInEmployee = React.useCallback(() => {\r\n    if (!loggedInUser) {\r\n      toast.error('Chưa xác định người nhận', {\r\n        description: 'Vui lòng đăng nhập để ghi nhận người nhập hàng.',\r\n      });\r\n      return false;\r\n    }\r\n    return true;\r\n  }, [loggedInUser, toast]);\r\n\r\n  const computeReceivableItems = React.useCallback((po: PurchaseOrder): ReceiveLineItemForm[] => {\r\n    const relatedReceipts = allReceipts.filter(r => r.purchaseOrderSystemId === asSystemId(po.systemId));\r\n    return po.lineItems\r\n      .map(item => {\r\n        const receivedQty = relatedReceipts.reduce((sum, receipt) => {\r\n          const receiptItem = receipt.items.find(i => i.productSystemId === item.productSystemId);\r\n          return sum + (receiptItem ? Number(receiptItem.receivedQuantity) : 0);\r\n        }, 0);\r\n        const remaining = Math.max(item.quantity - receivedQty, 0);\r\n        return {\r\n          productSystemId: asSystemId(item.productSystemId),\r\n          productId: item.productId,\r\n          productName: item.productName,\r\n          orderedQuantity: item.quantity,\r\n          remainingQuantity: remaining,\r\n          receiveQuantity: remaining,\r\n          unitPrice: item.unitPrice,\r\n        };\r\n      })\r\n      .filter(item => item.remainingQuantity > 0);\r\n  }, [allReceipts]);\r\n\r\n  const openReceiveDialogForOrder = React.useCallback((po: PurchaseOrder, presetItems?: ReceiveLineItemForm[]) => {\r\n    const computedItems = presetItems ?? computeReceivableItems(po);\r\n    if (computedItems.length === 0) {\r\n      toast.error('Đơn đã nhận đủ', {\r\n        description: `Đơn ${po.id} không còn số lượng cần nhập`,\r\n      });\r\n      return false;\r\n    }\r\n    const branchMatch = branches.find(b => b.systemId === po.branchSystemId);\r\n    const fallbackBranch = branchMatch ?? branches[0];\r\n    const targetBranchId: SystemId | null =\r\n      fallbackBranch?.systemId ? asSystemId(fallbackBranch.systemId) : (po.branchSystemId ? asSystemId(po.branchSystemId) : null);\r\n    const targetBranchName = fallbackBranch?.name || po.branchName || 'Chưa xác định';\r\n\r\n    setReceiveDialogState({\r\n      isOpen: true,\r\n      purchaseOrder: po,\r\n      receivedDate: formatDateCustom(new Date(), \"yyyy-MM-dd'T'HH:mm\"),\r\n      targetBranchSystemId: targetBranchId,\r\n      targetBranchName,\r\n      warehouseName: po.branchName ? `Kho ${po.branchName}` : '',\r\n      documentCode: '',\r\n      notes: '',\r\n      items: computedItems,\r\n    });\r\n    return true;\r\n  }, [branches, computeReceivableItems, toast]);\r\n\r\n  const closeReceiveDialog = React.useCallback(() => {\r\n    setReceiveDialogState({\r\n      isOpen: false,\r\n      purchaseOrder: null,\r\n      receivedDate: '',\r\n      targetBranchSystemId: null,\r\n      targetBranchName: '',\r\n      warehouseName: '',\r\n      documentCode: '',\r\n      notes: '',\r\n      items: [],\r\n    });\r\n    setPendingReceiveQueue([]);\r\n  }, []);\r\n\r\n  const beginReceiveFlow = React.useCallback((orders: PurchaseOrder[]) => {\r\n    if (!requireLoggedInEmployee()) return;\r\n    const receivableEntries = orders\r\n      .map(po => ({ po, items: computeReceivableItems(po) }))\r\n      .filter(entry => entry.items.length > 0);\r\n\r\n    if (receivableEntries.length === 0) {\r\n      toast('Không có đơn hợp lệ', {\r\n        description: 'Các đơn đã chọn đều đã nhập đủ hàng.',\r\n      });\r\n      return;\r\n    }\r\n\r\n    const [firstEntry, ...restEntries] = receivableEntries;\r\n    setPendingReceiveQueue(restEntries.map(entry => entry.po));\r\n    openReceiveDialogForOrder(firstEntry.po, firstEntry.items);\r\n  }, [computeReceivableItems, openReceiveDialogForOrder, requireLoggedInEmployee, toast]);\r\n\r\n  const handleReceiveQuantityChange = React.useCallback((productSystemId: SystemId, value: number) => {\r\n    setReceiveDialogState(prev => ({\r\n      ...prev,\r\n      items: prev.items.map(item =>\r\n        item.productSystemId === productSystemId\r\n          ? { ...item, receiveQuantity: Math.min(Math.max(value, 0), item.remainingQuantity) }\r\n          : item\r\n      )\r\n    }));\r\n  }, []);\r\n\r\n  const handleReceiveFieldChange = React.useCallback((field: 'documentCode' | 'receivedDate' | 'warehouseName' | 'notes', value: string) => {\r\n    setReceiveDialogState(prev => ({\r\n      ...prev,\r\n      [field]: value,\r\n    }));\r\n  }, []);\r\n\r\n  const handleReceiveBranchChange = React.useCallback((branchSystemId: string) => {\r\n    const branch = branches.find(b => b.systemId === branchSystemId);\r\n    const nextSystemId: SystemId | null = branch?.systemId ? asSystemId(branch.systemId) : (branchSystemId ? asSystemId(branchSystemId) : null);\r\n    setReceiveDialogState(prev => ({\r\n      ...prev,\r\n      targetBranchSystemId: nextSystemId,\r\n      targetBranchName: branch?.name || prev.targetBranchName,\r\n    }));\r\n  }, [branches]);\r\n\r\n  const handleSubmitReceiveDialog = React.useCallback(async () => {\r\n    if (!receiveDialogState.purchaseOrder || !requireLoggedInEmployee()) {\r\n      return;\r\n    }\r\n\r\n    if (!receiveDialogState.targetBranchSystemId) {\r\n      toast.error('Chưa chọn chi nhánh', {\r\n        description: 'Vui lòng chọn chi nhánh nhận hàng trước khi lưu phiếu.',\r\n      });\r\n      return;\r\n    }\r\n\r\n    const itemsToReceive = receiveDialogState.items\r\n      .filter(item => item.receiveQuantity > 0)\r\n      .map(item => ({\r\n        productSystemId: item.productSystemId,\r\n        productId: item.productId,\r\n        productName: item.productName,\r\n        orderedQuantity: item.orderedQuantity,\r\n        receivedQuantity: item.receiveQuantity,\r\n        unitPrice: item.unitPrice,\r\n      }));\r\n\r\n    if (itemsToReceive.length === 0) {\r\n      toast.error('Chưa chọn số lượng', {\r\n        description: 'Vui lòng nhập số lượng thực nhận cho ít nhất một sản phẩm.',\r\n      });\r\n      return;\r\n    }\r\n\r\n    setIsSubmittingReceive(true);\r\n    try {\r\n      const normalizedDate = receiveDialogState.receivedDate\r\n        ? receiveDialogState.receivedDate.replace('T', ' ')\r\n        : formatDateCustom(new Date(), 'yyyy-MM-dd HH:mm');\r\n\r\n        const branchSystemId = receiveDialogState.targetBranchSystemId;\r\n        const receiptPayload = {\r\n          id: asBusinessId(receiveDialogState.documentCode?.trim() || ''),\r\n          purchaseOrderSystemId: asSystemId(receiveDialogState.purchaseOrder.systemId),\r\n          purchaseOrderId: asBusinessId(\r\n            receiveDialogState.purchaseOrder.id || receiveDialogState.purchaseOrder.systemId,\r\n          ),\r\n          supplierSystemId: asSystemId(receiveDialogState.purchaseOrder.supplierSystemId),\r\n          supplierName: receiveDialogState.purchaseOrder.supplierName,\r\n          receivedDate: normalizedDate,\r\n          receiverSystemId: asSystemId(currentUserSystemId),\r\n          receiverName: currentUserName,\r\n          notes: receiveDialogState.notes,\r\n          branchSystemId,\r\n          branchName: receiveDialogState.targetBranchName,\r\n          warehouseName: receiveDialogState.warehouseName,\r\n          items: itemsToReceive.map(item => ({\r\n            productSystemId: item.productSystemId,\r\n            productId: asBusinessId(item.productId || ''),\r\n            productName: item.productName,\r\n            orderedQuantity: item.orderedQuantity,\r\n            receivedQuantity: item.receivedQuantity,\r\n            unitPrice: item.unitPrice,\r\n          })),\r\n        };\r\n\r\n          const createdReceipt = await addInventoryReceipt(receiptPayload);\r\n\r\n          itemsToReceive.forEach(item => {\r\n            const productBeforeUpdate = findProductById(item.productSystemId);\r\n            const oldStock = productBeforeUpdate?.inventoryByBranch?.[branchSystemId] || 0;\r\n\r\n            updateInventory(item.productSystemId, branchSystemId, item.receivedQuantity);\r\n\r\n        addStockHistoryEntry({\r\n          productId: item.productSystemId,\r\n          date: new Date().toISOString(),\r\n          employeeName: currentUserName,\r\n          action: `Nhập hàng từ NCC (${receiveDialogState.purchaseOrder?.id})`,\r\n          quantityChange: item.receivedQuantity,\r\n          newStockLevel: oldStock + item.receivedQuantity,\r\n          documentId: createdReceipt.id,\r\n          branch: receiveDialogState.targetBranchName,\r\n              branchSystemId,\r\n        });\r\n      });\r\n\r\n      processInventoryReceipt(receiveDialogState.purchaseOrder.systemId);\r\n      toast.success('Đã lưu phiếu nhập', {\r\n        description: `Hoàn tất nhập hàng cho đơn ${receiveDialogState.purchaseOrder.id}.`,\r\n      });\r\n\r\n      if (pendingReceiveQueue.length > 0) {\r\n        const [next, ...rest] = pendingReceiveQueue;\r\n        setPendingReceiveQueue(rest);\r\n        openReceiveDialogForOrder(next);\r\n      } else {\r\n        closeReceiveDialog();\r\n      }\r\n    } finally {\r\n      setIsSubmittingReceive(false);\r\n    }\r\n  }, [receiveDialogState, requireLoggedInEmployee, currentUserSystemId, currentUserName, addInventoryReceipt, findProductById, updateInventory, addStockHistoryEntry, processInventoryReceipt, toast, pendingReceiveQueue, openReceiveDialogForOrder, closeReceiveDialog]);\r\n\r\n  const handlePrint = React.useCallback((po: PurchaseOrder) => {\r\n    // Use helper to prepare print data\r\n    const branch = findBranchById(po.branchSystemId);\r\n    const supplier = findSupplierById(po.supplierSystemId);\r\n    const storeSettings = branch \r\n      ? createStoreSettings(branch)\r\n      : createStoreSettings(storeInfo);\r\n    const poData = convertPurchaseOrderForPrint(po, { branch, supplier });\r\n    \r\n    print('purchase-order', {\r\n      data: mapPurchaseOrderToPrintData(poData, storeSettings),\r\n      lineItems: mapPurchaseOrderLineItems(poData.items),\r\n    });\r\n    toast(`Đang in đơn nhập hàng ${po.id}`);\r\n  }, [findBranchById, findSupplierById, storeInfo, print]);\r\n\r\n  const handlePayment = React.useCallback((po: PurchaseOrder) => {\r\n    // TODO: Implement payment dialog/modal\r\n    router.push(`/purchase-orders/${po.systemId}`);\r\n    toast(`Mở trang thanh toán cho đơn ${po.id}`);\r\n  }, [router, toast]);\r\n\r\n  const handleReceiveGoods = React.useCallback((po: PurchaseOrder) => {\r\n    beginReceiveFlow([po]);\r\n  }, [beginReceiveFlow]);\r\n\r\n  // Print dialog state\r\n  const [isPrintDialogOpen, setIsPrintDialogOpen] = React.useState(false);\r\n  const [pendingPrintPOs, setPendingPrintPOs] = React.useState<PurchaseOrder[]>([]);\r\n  const { printMultiple } = usePrint();\r\n\r\n  // Bulk actions - open print dialog\r\n  const handleBulkPrint = () => {\r\n    const selectedIds = Object.keys(rowSelection).filter(id => rowSelection[id]);\r\n    if (selectedIds.length === 0) {\r\n      toast.error('Chưa chọn đơn hàng', {\r\n        description: 'Vui lòng chọn ít nhất một đơn hàng',\r\n      });\r\n      return;\r\n    }\r\n    const selectedPOs = purchaseOrders.filter(p => selectedIds.includes(p.systemId));\r\n    setPendingPrintPOs(selectedPOs);\r\n    setIsPrintDialogOpen(true);\r\n  };\r\n\r\n  // Handle print confirm from dialog\r\n  const handlePrintConfirm = React.useCallback((options: SimplePrintOptionsResult) => {\r\n    const { branchSystemId, paperSize } = options;\r\n    \r\n    const printOptionsList = pendingPrintPOs.map(po => {\r\n      const branch = branchSystemId \r\n        ? findBranchById(branchSystemId)\r\n        : findBranchById(po.branchSystemId);\r\n      const supplier = findSupplierById(po.supplierSystemId);\r\n      const storeSettings = branch \r\n        ? createStoreSettings(branch)\r\n        : createStoreSettings(storeInfo);\r\n      const poData = convertPurchaseOrderForPrint(po, { branch, supplier });\r\n      \r\n      return {\r\n        data: mapPurchaseOrderToPrintData(poData, storeSettings),\r\n        lineItems: mapPurchaseOrderLineItems(poData.items),\r\n        paperSize,\r\n      };\r\n    });\r\n    \r\n    printMultiple('purchase-order', printOptionsList);\r\n    \r\n    toast.success('Đã gửi lệnh in', {\r\n      description: pendingPrintPOs.map(p => p.id).join(', ')\r\n    });\r\n    setRowSelection({});\r\n    setPendingPrintPOs([]);\r\n  }, [pendingPrintPOs, findBranchById, findSupplierById, storeInfo, printMultiple]);\r\n\r\n  const handleBulkCancel = () => {\r\n    const selectedIds = Object.keys(rowSelection).filter(id => rowSelection[id]);\r\n    if (selectedIds.length === 0) {\r\n      toast.error('Chưa chọn đơn hàng', {\r\n        description: 'Vui lòng chọn ít nhất một đơn hàng',\r\n      });\r\n      return;\r\n    }\r\n    bulkCancel(selectedIds, `Hủy bởi ${currentUserName}`);\r\n    toast.success('Đã hủy', {\r\n      description: `Đã hủy ${selectedIds.length} đơn nhập hàng`,\r\n    });\r\n    setRowSelection({});\r\n  };\r\n\r\n  const allSelectedRows = React.useMemo(() => \r\n    purchaseOrders.filter(po => rowSelection[po.systemId]),\r\n  [purchaseOrders, rowSelection]);\r\n\r\n  const selectedOrders = React.useMemo(() => {\r\n    return purchaseOrders.filter(o => rowSelection[o.systemId]);\r\n  }, [purchaseOrders, rowSelection]);\r\n\r\n  const numSelected = Object.keys(rowSelection).length;\r\n\r\n  const confirmBulkPay = () => {\r\n    const paymentCategory = paymentTypes.find(pt => pt.name === 'Thanh toán cho đơn nhập hàng');\r\n    const paymentMethodName = 'Chuyển khoản';\r\n    const paymentMethodSystemId = 'BANK_TRANSFER';\r\n    let totalPaymentsCreated = 0;\r\n    \r\n    allSelectedRows.forEach(po => {\r\n        const totalPaid = sumPaymentsForPurchaseOrder(allPayments, po);\r\n        const totalReturnValue = allPurchaseReturns\r\n          .filter(r => r.purchaseOrderSystemId === asSystemId(po.systemId))\r\n          .reduce((sum, r) => sum + r.totalReturnValue, 0);\r\n        const actualDebt = Math.max(po.grandTotal - totalReturnValue, 0);\r\n        const amountRemaining = actualDebt - totalPaid;\r\n\r\n        if (amountRemaining > 0) {\r\n            const account = accounts.find(acc => acc.type === 'bank' && acc.branchSystemId === po.branchSystemId) || accounts.find(acc => acc.type === 'bank');\r\n            if (!account) {\r\n                console.error(`Không tìm thấy tài khoản ngân hàng cho chi nhánh ${po.branchName}`);\r\n                return;\r\n            }\r\n\r\n            const now = formatDateCustom(getCurrentDate(), 'yyyy-MM-dd HH:mm');\r\n            const newPayment: Omit<Payment, 'systemId'> = {\r\n              id: '' as any,\r\n                date: now,\r\n                amount: amountRemaining,\r\n                recipientTypeSystemId: 'NHACUNGCAP',\r\n                recipientTypeName: 'Nhà cung cấp',\r\n                recipientName: po.supplierName,\r\n                recipientSystemId: po.supplierSystemId,\r\n                description: `Thanh toán toàn bộ cho đơn nhập hàng ${po.id}`,\r\n                paymentMethodSystemId,\r\n                paymentMethodName,\r\n                accountSystemId: account.systemId,\r\n                paymentReceiptTypeSystemId: paymentCategory?.systemId || '',\r\n                paymentReceiptTypeName: paymentCategory?.name || 'Thanh toán cho đơn nhập hàng',\r\n                branchSystemId: po.branchSystemId,\r\n                branchName: po.branchName,\r\n                createdBy: currentUserName,\r\n                createdAt: now,\r\n                status: 'completed',\r\n                category: 'supplier_payment',\r\n                affectsDebt: true,\r\n                purchaseOrderSystemId: po.systemId,\r\n                purchaseOrderId: po.id,\r\n                originalDocumentId: po.id,\r\n            } as any;\r\n            addPaymentMutation.mutate(newPayment as any);\r\n            totalPaymentsCreated += 1;\r\n        }\r\n    });\r\n\r\n    if (totalPaymentsCreated > 0) {\r\n      syncAllPurchaseOrderStatuses();\r\n      toast.success('Đã tạo phiếu chi', {\r\n        description: `Hoàn tất ${totalPaymentsCreated} phiếu chi cho đơn nhập hàng đã chọn.`,\r\n      });\r\n    }\r\n\r\n    setRowSelection({});\r\n    setIsBulkPayAlertOpen(false);\r\n  };\r\n\r\n  // Import handler\r\n  const handleImport = React.useCallback(async (\r\n    importedOrders: Partial<PurchaseOrder>[],\r\n    mode: 'insert-only' | 'update-only' | 'upsert',\r\n    _branchId?: string\r\n  ) => {\r\n    let addedCount = 0;\r\n    let updatedCount = 0;\r\n    let skippedCount = 0;\r\n    const errors: Array<{ row: number; message: string }> = [];\r\n    \r\n    for (const [index, order] of importedOrders.entries()) {\r\n      try {\r\n        const existing = purchaseOrders.find(o => \r\n          o.id.toLowerCase() === (order.id || '').toLowerCase()\r\n        );\r\n        \r\n        if (existing) {\r\n          if (mode === 'update-only' || mode === 'upsert') {\r\n            await updatePurchaseOrderMutation.mutateAsync({ \r\n              systemId: existing.systemId, \r\n              data: { ...existing, ...order, systemId: existing.systemId } as PurchaseOrder \r\n            });\r\n            updatedCount++;\r\n          } else {\r\n            skippedCount++;\r\n          }\r\n        } else {\r\n          if (mode === 'insert-only' || mode === 'upsert') {\r\n            // Use add mutation when available\r\n            skippedCount++; // For now, skip adding as we need add mutation\r\n          } else {\r\n            skippedCount++;\r\n          }\r\n        }\r\n      } catch (error) {\r\n        errors.push({ row: index + 1, message: (error as Error).message });\r\n      }\r\n    }\r\n    \r\n    if (addedCount > 0 || updatedCount > 0) {\r\n      const messages = [];\r\n      if (addedCount > 0) messages.push(`${addedCount} đơn nhập hàng mới`);\r\n      if (updatedCount > 0) messages.push(`${updatedCount} đơn cập nhật`);\r\n      toast.success(`Đã import: ${messages.join(', ')}`);\r\n    }\r\n    \r\n    return {\r\n      success: addedCount + updatedCount,\r\n      failed: errors.length,\r\n      inserted: addedCount,\r\n      updated: updatedCount,\r\n      skipped: skippedCount,\r\n      errors,\r\n    };\r\n  }, [purchaseOrders, updatePurchaseOrderMutation]);\r\n\r\n  const handleBulkReceiveStart = React.useCallback(() => {\r\n    if (allSelectedRows.length === 0) {\r\n      toast.error('Chưa chọn đơn hàng', {\r\n        description: 'Vui lòng chọn ít nhất một đơn nhập hàng cần nhập kho.',\r\n      });\r\n      return;\r\n    }\r\n\r\n    const targetOrders = allSelectedRows.filter(po => po.deliveryStatus !== 'Đã nhập');\r\n    if (targetOrders.length === 0) {\r\n      toast('Tất cả đơn đã nhập', {\r\n        description: 'Các đơn đã chọn đều đã hoàn tất nhập kho.',\r\n      });\r\n      return;\r\n    }\r\n\r\n    setRowSelection({});\r\n    beginReceiveFlow(targetOrders);\r\n  }, [allSelectedRows, beginReceiveFlow, toast]);\r\n\r\n  const columns = React.useMemo(() => getColumns(handleCancelRequest, handlePrint, handlePayment, handleReceiveGoods, branches as any), [handleCancelRequest, handlePrint, handlePayment, handleReceiveGoods, branches]);\r\n  \r\n  // Track if we've initialized column visibility to prevent infinite loops\r\n  const hasInitializedVisibility = React.useRef(false);\r\n  \r\n  React.useEffect(() => {\r\n    // Only initialize once\r\n    if (hasInitializedVisibility.current) return;\r\n    hasInitializedVisibility.current = true;\r\n    \r\n    const defaultVisibleColumns = [\r\n      'id', 'supplierName', 'branchName', 'buyer', 'orderDate', 'deliveryDate', \r\n      'shippingFee', 'tax', 'discount', 'notes', 'creatorName', 'grandTotal',\r\n      'status', 'deliveryStatus', 'paymentStatus', 'returnStatus', 'refundStatus'\r\n    ];\r\n    const initialVisibility: Record<string, boolean> = {};\r\n    columns.forEach(c => {\r\n      if (c.id === 'select' || c.id === 'actions') {\r\n        initialVisibility[c.id!] = true;\r\n      } else {\r\n        initialVisibility[c.id!] = defaultVisibleColumns.includes(c.id!);\r\n      }\r\n    });\r\n    setColumnVisibility(initialVisibility);\r\n    setColumnOrder(columns.map(c => c.id).filter(Boolean) as string[]);\r\n  }, [columns]);\r\n  \r\n  const fuse = React.useMemo(() => new Fuse(purchaseOrders, { keys: [\"id\", \"supplierName\", \"status\"] }), [purchaseOrders]);\r\n  \r\n  const filteredData = React.useMemo(() => {\r\n    let data = purchaseOrders;\r\n    if (branchFilter !== 'all') {\r\n      data = data.filter(po => po.branchSystemId === branchFilter);\r\n    }\r\n    if (statusFilter !== 'all') {\r\n      data = data.filter(po => po.status === statusFilter);\r\n    }\r\n    if (paymentStatusFilter !== 'all') {\r\n      data = data.filter(po => po.paymentStatus === paymentStatusFilter);\r\n    }\r\n    if (globalFilter) {\r\n        data = fuse.search(globalFilter, { limit: data.length }).map(result => result.item);\r\n    }\r\n    return data;\r\n  }, [purchaseOrders, globalFilter, fuse, branchFilter, statusFilter, paymentStatusFilter]);\r\n  \r\n  const sortedData = React.useMemo(() => {\r\n    const sorted = [...filteredData];\r\n    if (sorting.id) {\r\n      sorted.sort((a, b) => {\r\n        const aValue = (a as any)[sorting.id];\r\n        const bValue = (b as any)[sorting.id];\r\n        // Special handling for date columns\r\n        if (sorting.id === 'createdAt' || sorting.id === 'orderDate') {\r\n          const aTime = aValue ? new Date(aValue).getTime() : 0;\r\n          const bTime = bValue ? new Date(bValue).getTime() : 0;\r\n          return sorting.desc ? bTime - aTime : aTime - bTime;\r\n        }\r\n        if (aValue < bValue) return sorting.desc ? 1 : -1;\r\n        if (aValue > bValue) return sorting.desc ? -1 : 1;\r\n        return 0;\r\n      });\r\n    }\r\n    return sorted;\r\n  }, [filteredData, sorting]);\r\n\r\n  const pageCount = Math.ceil(sortedData.length / pagination.pageSize);\r\n  const paginatedData = React.useMemo(() => {\r\n    const start = pagination.pageIndex * pagination.pageSize;\r\n    const end = start + pagination.pageSize;\r\n    return sortedData.slice(start, end);\r\n  }, [sortedData, pagination]);\r\n\r\n  // Mobile infinite scroll listener\r\n  React.useEffect(() => {\r\n    if (!isMobile) return;\r\n\r\n    const handleScroll = () => {\r\n      const scrollPosition = window.scrollY + window.innerHeight;\r\n      const documentHeight = document.documentElement.scrollHeight;\r\n      const scrollPercentage = (scrollPosition / documentHeight) * 100;\r\n\r\n      // Load more when scroll 80%\r\n      if (scrollPercentage > 80 && mobileLoadedCount < sortedData.length) {\r\n        setMobileLoadedCount(prev => Math.min(prev + 20, sortedData.length));\r\n      }\r\n    };\r\n\r\n    window.addEventListener('scroll', handleScroll);\r\n    return () => window.removeEventListener('scroll', handleScroll);\r\n  }, [isMobile, mobileLoadedCount, sortedData.length]);\r\n\r\n  // Display data: mobile uses infinite scroll, desktop uses pagination\r\n  const displayData = isMobile \r\n    ? sortedData.slice(0, mobileLoadedCount)\r\n    : paginatedData;\r\n\r\n  const hasValidReceiveQuantity = React.useMemo(\r\n    () => receiveDialogState.items.some(item => item.receiveQuantity > 0),\r\n    [receiveDialogState.items]\r\n  );\r\n\r\n  const bulkActions = [\r\n    {\r\n      label: \"In đơn nhập hàng\",\r\n      onSelect: handleBulkPrint\r\n    },\r\n    {\r\n      label: \"Thanh toán\",\r\n      onSelect: () => setIsBulkPayAlertOpen(true)\r\n    },\r\n    {\r\n      label: \"Nhập hàng\",\r\n      onSelect: handleBulkReceiveStart\r\n    },\r\n    {\r\n      label: \"Hủy đơn\",\r\n      onSelect: handleBulkCancel\r\n    }\r\n  ];\r\n\r\n  const handleRowClick = (row: PurchaseOrder) => {\r\n    router.push(`/purchase-orders/${row.systemId}`);\r\n  };\r\n\r\n  // Calculate statistics for POs with receipts and returns\r\n  const poStats = React.useMemo(() => {\r\n    const stats = new Map<string, { \r\n      totalOrdered: number; \r\n      totalReceived: number; \r\n      totalReturned: number;\r\n      variance: number;\r\n    }>();\r\n\r\n    // Collect all PO IDs\r\n    purchaseOrders.forEach(po => {\r\n      const totalOrdered = po.lineItems.reduce((sum, item) => sum + item.quantity, 0);\r\n      stats.set(po.id, { totalOrdered, totalReceived: 0, totalReturned: 0, variance: totalOrdered });\r\n    });\r\n\r\n    // Add received quantities\r\n    allReceipts.forEach(receipt => {\r\n      if (receipt.purchaseOrderId && stats.has(receipt.purchaseOrderId)) {\r\n        const totalReceived = receipt.items.reduce((sum, item) => sum + item.receivedQuantity, 0);\r\n        const current = stats.get(receipt.purchaseOrderId)!;\r\n        current.totalReceived += totalReceived;\r\n        current.variance = current.totalOrdered - current.totalReceived + current.totalReturned;\r\n      }\r\n    });\r\n\r\n    // Add returned quantities\r\n    allPurchaseReturns.forEach(ret => {\r\n      if (ret.purchaseOrderId && stats.has(ret.purchaseOrderId)) {\r\n        const totalReturned = ret.items.reduce((sum, item) => sum + item.returnQuantity, 0);\r\n        const current = stats.get(ret.purchaseOrderId)!;\r\n        current.totalReturned += totalReturned;\r\n        current.variance = current.totalOrdered - current.totalReceived + current.totalReturned;\r\n      }\r\n    });\r\n\r\n    // Calculate totals\r\n    let totalOrdered = 0;\r\n    let totalReceived = 0;\r\n    let totalReturned = 0;\r\n    stats.forEach(stat => {\r\n      totalOrdered += stat.totalOrdered;\r\n      totalReceived += stat.totalReceived;\r\n      totalReturned += stat.totalReturned;\r\n    });\r\n\r\n    return { \r\n      totalOrdered, \r\n      totalReceived, \r\n      totalReturned,\r\n      netInStock: totalReceived - totalReturned,\r\n      receivedRate: totalOrdered > 0 ? ((totalReceived / totalOrdered) * 100).toFixed(1) : '0',\r\n      returnedRate: totalReceived > 0 ? ((totalReturned / totalReceived) * 100).toFixed(1) : '0'\r\n    };\r\n  }, [purchaseOrders, allReceipts, allPurchaseReturns]);\r\n\r\n  return (\r\n    <div className=\"space-y-4\">\r\n      {/* Statistics Cards */}\r\n      <div className=\"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4\">\r\n        <Card>\r\n          <CardContent className=\"p-4\">\r\n            <p className=\"text-body-sm text-muted-foreground\">Tổng đặt hàng</p>\r\n            <p className=\"text-h3\">{poStats.totalOrdered} SP</p>\r\n          </CardContent>\r\n        </Card>\r\n        <Card>\r\n          <CardContent className=\"p-4\">\r\n            <p className=\"text-body-sm text-muted-foreground\">Đã nhận</p>\r\n            <p className=\"text-h3 text-green-600\">\r\n              {poStats.totalReceived} SP\r\n              <span className=\"text-body-sm text-muted-foreground ml-2\">({poStats.receivedRate}%)</span>\r\n            </p>\r\n          </CardContent>\r\n        </Card>\r\n        <Card>\r\n          <CardContent className=\"p-4\">\r\n            <p className=\"text-body-sm text-muted-foreground\">Đã trả lại</p>\r\n            <p className=\"text-h3 text-orange-600\">\r\n              {poStats.totalReturned} SP\r\n              <span className=\"text-body-sm text-muted-foreground ml-2\">({poStats.returnedRate}%)</span>\r\n            </p>\r\n          </CardContent>\r\n        </Card>\r\n        <Card>\r\n          <CardContent className=\"p-4\">\r\n            <p className=\"text-body-sm text-muted-foreground\">Tồn kho thực</p>\r\n            <p className={`text-h3 ${poStats.netInStock >= 0 ? 'text-blue-600' : 'text-red-600'}`}>\r\n              {poStats.netInStock > 0 ? '+' : ''}{poStats.netInStock} SP\r\n            </p>\r\n          </CardContent>\r\n        </Card>\r\n      </div>\r\n\r\n      {/* PageToolbar - Desktop only */}\r\n      {!isMobile && (\r\n        <PageToolbar\r\n          rightActions={\r\n            <>\r\n              <Button variant=\"outline\" size=\"sm\" onClick={() => setShowImportDialog(true)}>\r\n                <FileSpreadsheet className=\"mr-2 h-4 w-4\" />\r\n                Nhập file\r\n              </Button>\r\n              <Button variant=\"outline\" size=\"sm\" onClick={() => setShowExportDialog(true)}>\r\n                <Download className=\"mr-2 h-4 w-4\" />\r\n                Xuất Excel\r\n              </Button>\r\n              <DataTableColumnCustomizer\r\n                columns={columns}\r\n                columnVisibility={columnVisibility}\r\n                setColumnVisibility={setColumnVisibility}\r\n                columnOrder={columnOrder}\r\n                setColumnOrder={setColumnOrder}\r\n                pinnedColumns={pinnedColumns}\r\n                setPinnedColumns={setPinnedColumns}\r\n              />\r\n            </>\r\n          }\r\n        />\r\n      )}\r\n\r\n      {/* PageFilters */}\r\n      <PageFilters\r\n        searchValue={globalFilter}\r\n        onSearchChange={setGlobalFilter}\r\n        searchPlaceholder=\"Tìm kiếm đơn nhập hàng...\"\r\n      >\r\n        <Select value={branchFilter} onValueChange={setBranchFilter}>\r\n          <SelectTrigger className=\"h-9 w-full sm:w-[180px]\">\r\n            <SelectValue placeholder=\"Chi nhánh\" />\r\n          </SelectTrigger>\r\n          <SelectContent>\r\n            <SelectItem value=\"all\">Tất cả chi nhánh</SelectItem>\r\n            {branches.map(b => <SelectItem key={b.systemId} value={b.systemId}>{b.name}</SelectItem>)}\r\n          </SelectContent>\r\n        </Select>\r\n        <Select value={statusFilter} onValueChange={setStatusFilter}>\r\n          <SelectTrigger className=\"h-9 w-full sm:w-[180px]\">\r\n            <SelectValue placeholder=\"Trạng thái\" />\r\n          </SelectTrigger>\r\n          <SelectContent>\r\n            <SelectItem value=\"all\">Tất cả trạng thái</SelectItem>\r\n            <SelectItem value=\"Đặt hàng\">Đặt hàng</SelectItem>\r\n            <SelectItem value=\"Đang giao dịch\">Đang giao dịch</SelectItem>\r\n            <SelectItem value=\"Hoàn thành\">Hoàn thành</SelectItem>\r\n            <SelectItem value=\"Đã hủy\">Đã hủy</SelectItem>\r\n            <SelectItem value=\"Kết thúc\">Kết thúc</SelectItem>\r\n          </SelectContent>\r\n        </Select>\r\n        <Select value={paymentStatusFilter} onValueChange={setPaymentStatusFilter}>\r\n          <SelectTrigger className=\"h-9 w-full sm:w-[180px]\">\r\n            <SelectValue placeholder=\"Thanh toán\" />\r\n          </SelectTrigger>\r\n          <SelectContent>\r\n            <SelectItem value=\"all\">Tất cả</SelectItem>\r\n            <SelectItem value=\"Chưa thanh toán\">Chưa thanh toán</SelectItem>\r\n            <SelectItem value=\"Thanh toán một phần\">Thanh toán một phần</SelectItem>\r\n            <SelectItem value=\"Đã thanh toán\">Đã thanh toán</SelectItem>\r\n          </SelectContent>\r\n        </Select>\r\n      </PageFilters>\r\n      \r\n      {/* Responsive Data Table */}\r\n      <ResponsiveDataTable \r\n        columns={columns}\r\n        data={displayData}\r\n        renderMobileCard={(po) => (\r\n          <PurchaseOrderCard \r\n            purchaseOrder={po}\r\n            onCancel={handleCancelRequest}\r\n            onPrint={handlePrint}\r\n            onPayment={handlePayment}\r\n            onReceiveGoods={handleReceiveGoods}\r\n            onClick={handleRowClick}\r\n          />\r\n        )}\r\n        pageCount={pageCount}\r\n        pagination={pagination}\r\n        setPagination={setPagination}\r\n        rowCount={filteredData.length}\r\n        rowSelection={rowSelection}\r\n        setRowSelection={setRowSelection}\r\n        sorting={sorting}\r\n        setSorting={setSorting}\r\n        onRowClick={handleRowClick}\r\n        showBulkDeleteButton={false}\r\n        bulkActions={bulkActions}\r\n        allSelectedRows={allSelectedRows}\r\n        expanded={{}}\r\n        setExpanded={() => {}}\r\n        columnVisibility={columnVisibility}\r\n        setColumnVisibility={setColumnVisibility}\r\n        columnOrder={columnOrder}\r\n        setColumnOrder={setColumnOrder}\r\n        pinnedColumns={pinnedColumns}\r\n        setPinnedColumns={setPinnedColumns}\r\n      />\r\n\r\n      {/* Mobile Loading Indicator */}\r\n      {isMobile && (\r\n        <div className=\"py-6 text-center\">\r\n          {mobileLoadedCount < sortedData.length ? (\r\n            <div className=\"flex items-center justify-center gap-2 text-muted-foreground\">\r\n              <div className=\"h-4 w-4 animate-spin rounded-full border-2 border-primary border-t-transparent\" />\r\n              <span className=\"text-body-sm\">Đang tải thêm...</span>\r\n            </div>\r\n          ) : sortedData.length > 20 ? (\r\n            <p className=\"text-body-sm text-muted-foreground\">\r\n              Đã hiển thị tất cả {sortedData.length} kết quả\r\n            </p>\r\n          ) : null}\r\n        </div>\r\n      )}\r\n      \r\n      <AlertDialog open={cancelDialogState.isOpen} onOpenChange={(open) => setCancelDialogState(s => ({ ...s, isOpen: open }))}>\r\n        <AlertDialogContent>\r\n          <AlertDialogHeader>\r\n            <AlertDialogTitle>Bạn có chắc chắn muốn hủy đơn hàng này?</AlertDialogTitle>\r\n            <AlertDialogDescription>\r\n              {cancelDialogState.willCreateReturn ? (\r\n                <>\r\n                  Đơn hàng này đã có sản phẩm được nhập kho. Hủy đơn sẽ tự động tạo một <strong>Phiếu Xuất trả hàng</strong> cho các sản phẩm đã nhận.\r\n                  {cancelDialogState.totalPaid && cancelDialogState.totalPaid > 0 ? (\r\n                    ` Đồng thời, một Phiếu Thu hoàn tiền ${formatCurrency(cancelDialogState.totalPaid)} sẽ được tạo.`\r\n                  ) : ''}\r\n                  {' '}Hành động này không thể hoàn tác.\r\n                </>\r\n              ) : cancelDialogState.totalPaid && cancelDialogState.totalPaid > 0 ? (\r\n                <>\r\n                  Đơn hàng này đã được thanh toán <strong>{formatCurrency(cancelDialogState.totalPaid)}</strong>. \r\n                  Việc hủy đơn sẽ tự động tạo một <strong>Phiếu Thu</strong> ghi nhận khoản tiền này là \"Nhà cung cấp cần hoàn lại\". \r\n                  Hành động này không thể hoàn tác.\r\n                </>\r\n              ) : (\r\n                'Hành động này sẽ chuyển trạng thái đơn hàng thành \"Đã hủy\" và không thể hoàn tác.'\r\n              )}\r\n            </AlertDialogDescription>\r\n          </AlertDialogHeader>\r\n          <AlertDialogFooter>\r\n            <AlertDialogCancel className=\"h-9\" onClick={() => setCancelDialogState({ isOpen: false, po: null })}>Thoát</AlertDialogCancel>\r\n            <AlertDialogAction className=\"h-9\" onClick={confirmCancel}>Xác nhận hủy</AlertDialogAction>\r\n          </AlertDialogFooter>\r\n        </AlertDialogContent>\r\n      </AlertDialog>\r\n\r\n      <AlertDialog open={isBulkPayAlertOpen} onOpenChange={setIsBulkPayAlertOpen}>\r\n        <AlertDialogContent>\r\n          <AlertDialogHeader>\r\n            <AlertDialogTitle>Xác nhận thanh toán?</AlertDialogTitle>\r\n            <AlertDialogDescription>\r\n              Bạn có chắc chắn muốn thanh toán toàn bộ cho {numSelected} đơn hàng đã chọn không?\r\n            </AlertDialogDescription>\r\n          </AlertDialogHeader>\r\n          <AlertDialogFooter>\r\n            <AlertDialogCancel className=\"h-9\">Hủy</AlertDialogCancel>\r\n            <AlertDialogAction className=\"h-9\" onClick={confirmBulkPay}>Xác nhận</AlertDialogAction>\r\n          </AlertDialogFooter>\r\n        </AlertDialogContent>\r\n      </AlertDialog>\r\n      <Dialog open={receiveDialogState.isOpen} onOpenChange={(open) => {\r\n        if (!open) {\r\n          closeReceiveDialog();\r\n        }\r\n      }}>\r\n        <DialogContent className=\"max-w-4xl\">\r\n          <DialogHeader>\r\n            <DialogTitle>Nhập hàng cho {receiveDialogState.purchaseOrder?.id || 'đơn hàng'}</DialogTitle>\r\n            <DialogDescription>\r\n              Chọn chi nhánh, kho nhận và nhập số lượng thực nhận cho từng sản phẩm theo guideline dual ID.\r\n            </DialogDescription>\r\n          </DialogHeader>\r\n          <div className=\"space-y-4\">\r\n            {pendingReceiveQueue.length > 0 && (\r\n              <div className=\"rounded-md bg-blue-50 px-3 py-2 text-body-sm text-blue-700 dark:bg-blue-950/50 dark:text-blue-300\">\r\n                Còn {pendingReceiveQueue.length} đơn trong hàng đợi sẽ được mở tiếp sau khi lưu phiếu này.\r\n              </div>\r\n            )}\r\n            <div className=\"grid gap-4 md:grid-cols-2\">\r\n              <div className=\"space-y-2\">\r\n                <Label>Mã phiếu nhập</Label>\r\n                <Input\r\n                  placeholder=\"Ví dụ: PNK000123\"\r\n                  className=\"h-9\"\r\n                  value={receiveDialogState.documentCode}\r\n                  onChange={(event) => handleReceiveFieldChange('documentCode', event.target.value)}\r\n                />\r\n              </div>\r\n              <div className=\"space-y-2\">\r\n                <Label>Ngày nhận hàng</Label>\r\n                <Input\r\n                  type=\"datetime-local\"\r\n                  className=\"h-9\"\r\n                  value={receiveDialogState.receivedDate}\r\n                  onChange={(event) => handleReceiveFieldChange('receivedDate', event.target.value)}\r\n                />\r\n              </div>\r\n              <div className=\"space-y-2\">\r\n                <Label>Chi nhánh nhận</Label>\r\n                <Select value={receiveDialogState.targetBranchSystemId || undefined} onValueChange={handleReceiveBranchChange}>\r\n                  <SelectTrigger className=\"h-9\">\r\n                    <SelectValue placeholder=\"Chọn chi nhánh\" />\r\n                  </SelectTrigger>\r\n                  <SelectContent>\r\n                    {branches.map(branch => (\r\n                      <SelectItem key={branch.systemId} value={branch.systemId}>\r\n                        {branch.name}\r\n                      </SelectItem>\r\n                    ))}\r\n                  </SelectContent>\r\n                </Select>\r\n              </div>\r\n              <div className=\"space-y-2\">\r\n                <Label>Kho nhận</Label>\r\n                <Input\r\n                  placeholder=\"Kho chính, Kho lẻ...\"\r\n                  className=\"h-9\"\r\n                  value={receiveDialogState.warehouseName}\r\n                  onChange={(event) => handleReceiveFieldChange('warehouseName', event.target.value)}\r\n                />\r\n              </div>\r\n            </div>\r\n            <div className=\"space-y-2\">\r\n              <Label>Ghi chú</Label>\r\n              <Textarea\r\n                placeholder=\"Ví dụ: Nhập đợt 1, bao gồm phiếu vận chuyển số...\"\r\n                value={receiveDialogState.notes}\r\n                onChange={(event) => handleReceiveFieldChange('notes', event.target.value)}\r\n              />\r\n            </div>\r\n            <div className=\"rounded-lg border\">\r\n              <Table>\r\n                <TableHeader>\r\n                  <TableRow>\r\n                    <TableHead>Sản phẩm</TableHead>\r\n                    <TableHead>Số lượng đặt</TableHead>\r\n                    <TableHead>Còn lại</TableHead>\r\n                    <TableHead className=\"w-48\">Nhập lần này</TableHead>\r\n                  </TableRow>\r\n                </TableHeader>\r\n                <TableBody>\r\n                  {receiveDialogState.items.map(item => (\r\n                    <TableRow key={item.productSystemId}>\r\n                      <TableCell>\r\n                        <div className=\"flex flex-col\">\r\n                          <span className=\"text-body-sm font-medium\">{item.productName}</span>\r\n                          <span className=\"text-body-xs text-muted-foreground\">{item.productId}</span>\r\n                        </div>\r\n                      </TableCell>\r\n                      <TableCell>{item.orderedQuantity}</TableCell>\r\n                      <TableCell>{item.remainingQuantity}</TableCell>\r\n                      <TableCell>\r\n                        <Input\r\n                          type=\"number\"\r\n                          min={0}\r\n                          max={item.remainingQuantity}\r\n                          className=\"h-9\"\r\n                          value={item.receiveQuantity}\r\n                          onChange={(event) => handleReceiveQuantityChange(item.productSystemId, Number(event.target.value))}\r\n                        />\r\n                      </TableCell>\r\n                    </TableRow>\r\n                  ))}\r\n                </TableBody>\r\n              </Table>\r\n              {receiveDialogState.items.length === 0 && (\r\n                <p className=\"p-4 text-body-sm text-muted-foreground\">Tất cả sản phẩm trong đơn này đã được nhập đủ.</p>\r\n              )}\r\n            </div>\r\n          </div>\r\n          <DialogFooter className=\"gap-2\">\r\n            <Button type=\"button\" variant=\"outline\" className=\"h-9\" onClick={closeReceiveDialog} disabled={isSubmittingReceive}>\r\n              Hủy\r\n            </Button>\r\n            <Button\r\n              type=\"button\"\r\n              className=\"h-9\"\r\n              onClick={handleSubmitReceiveDialog}\r\n              disabled={isSubmittingReceive || !hasValidReceiveQuantity || !receiveDialogState.targetBranchSystemId}\r\n            >\r\n              {isSubmittingReceive\r\n                ? 'Đang lưu...'\r\n                : pendingReceiveQueue.length > 0\r\n                  ? 'Lưu & chuyển đơn tiếp theo'\r\n                  : 'Lưu phiếu nhập'}\r\n            </Button>\r\n          </DialogFooter>\r\n        </DialogContent>\r\n      </Dialog>\r\n\r\n      {/* Print Options Dialog */}\r\n      <SimplePrintOptionsDialog\r\n        open={isPrintDialogOpen}\r\n        onOpenChange={setIsPrintDialogOpen}\r\n        onConfirm={handlePrintConfirm}\r\n        selectedCount={pendingPrintPOs.length}\r\n        title=\"In đơn nhập hàng\"\r\n      />\r\n\r\n      {/* Import Dialog */}\r\n      <GenericImportDialogV2<PurchaseOrder>\r\n        open={showImportDialog}\r\n        onOpenChange={setShowImportDialog}\r\n        config={purchaseOrderImportExportConfig}\r\n        branches={branches.map(b => ({ systemId: b.systemId, name: b.name }))}\r\n        existingData={purchaseOrders}\r\n        onImport={handleImport}\r\n        currentUser={{\r\n          name: loggedInUser?.fullName || 'Hệ thống',\r\n          systemId: loggedInUser?.systemId || asSystemId('SYSTEM'),\r\n        }}\r\n      />\r\n\r\n      {/* Export Dialog */}\r\n      <GenericExportDialogV2<PurchaseOrder>\r\n        open={showExportDialog}\r\n        onOpenChange={setShowExportDialog}\r\n        config={purchaseOrderImportExportConfig}\r\n        allData={purchaseOrders}\r\n        filteredData={sortedData}\r\n        currentPageData={paginatedData}\r\n        selectedData={selectedOrders}\r\n        currentUser={{\r\n          name: loggedInUser?.fullName || 'Hệ thống', \r\n          systemId: loggedInUser?.systemId || asSystemId('SYSTEM'),\r\n        }}\r\n      />\r\n      \r\n    </div>\r\n  )\r\n}\r\n"],"names":[],"mappings":"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"}}]
}