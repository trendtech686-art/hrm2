{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/employees/store.ts"],"sourcesContent":["import { createCrudStore, CrudState } from '../../lib/store-factory';\r\n// REMOVED: import { data as initialData } from './data'; // Mock data no longer used - database is source of truth\r\nimport type { Employee } from './types';\r\nimport type { HistoryEntry } from '../../components/ActivityHistory';\r\nimport Fuse from 'fuse.js';\r\nimport { getCurrentUserSystemId } from '../../contexts/auth-context';\r\nimport { registerBreadcrumbStore } from '../../lib/breadcrumb-generator'; // ‚úÖ NEW\r\nimport { type SystemId } from '../../lib/id-types';\r\nimport { createInMemoryRepository } from '../../repositories/in-memory-repository';\r\nimport { \r\n  createHistoryEntry, \r\n  getCurrentUserInfo,\r\n  appendHistoryEntry \r\n} from '../../lib/activity-history-helper';\r\n\r\ntype EmployeePersistenceAdapter = {\r\n  create: (payload: Omit<Employee, 'systemId'>) => Promise<Employee>;\r\n  update: (systemId: SystemId, payload: Partial<Employee>) => Promise<Employee>;\r\n  softDelete: (systemId: SystemId) => Promise<void>;\r\n  restore: (systemId: SystemId) => Promise<Employee | undefined>;\r\n  hardDelete: (systemId: SystemId) => Promise<void>;\r\n};\r\n\r\nconst baseStore = createCrudStore<Employee>([], 'employees', {\r\n  businessIdField: 'id',\r\n  getCurrentUser: getCurrentUserSystemId, // ‚úÖ Track who creates/updates\r\n  apiEndpoint: '/api/employees',\r\n});\r\n\r\n// ‚úÖ Wrap add method to include activity history\r\nconst originalAdd = baseStore.getState().add;\r\nconst wrappedAdd = (item: Omit<Employee, 'systemId'>): Employee => {\r\n  const userInfo = getCurrentUserInfo();\r\n  const historyEntry = createHistoryEntry(\r\n    'created',\r\n    `${userInfo.name} ƒë√£ t·∫°o h·ªì s∆° nh√¢n vi√™n ${item.fullName} (${item.id})`,\r\n    userInfo\r\n  );\r\n  \r\n  const newEmployee = originalAdd({\r\n    ...item,\r\n    activityHistory: [historyEntry],\r\n  });\r\n  \r\n  return newEmployee;\r\n};\r\n\r\n// ‚úÖ Wrap update method to include activity history\r\nconst originalUpdate = baseStore.getState().update;\r\nconst wrappedUpdate = (systemId: SystemId, updates: Partial<Employee>): void => {\r\n  const currentEmployee = baseStore.getState().data.find(e => e.systemId === systemId);\r\n  if (!currentEmployee) return;\r\n  \r\n  const userInfo = getCurrentUserInfo();\r\n  const historyEntries: HistoryEntry[] = [];\r\n  \r\n  // Track important field changes\r\n  const trackedFields: { key: keyof Employee; label: string }[] = [\r\n    { key: 'fullName', label: 'h·ªç t√™n' },\r\n    { key: 'jobTitle', label: 'ch·ª©c danh' },\r\n    { key: 'department', label: 'ph√≤ng ban' },\r\n    { key: 'employmentStatus', label: 'tr·∫°ng th√°i l√†m vi·ªác' },\r\n    { key: 'employeeType', label: 'lo·∫°i nh√¢n vi√™n' },\r\n    { key: 'baseSalary', label: 'l∆∞∆°ng c∆° b·∫£n' },\r\n    { key: 'phone', label: 's·ªë ƒëi·ªán tho·∫°i' },\r\n    { key: 'workEmail', label: 'email c√¥ng vi·ªác' },\r\n    { key: 'role', label: 'vai tr√≤' },\r\n  ];\r\n  \r\n  trackedFields.forEach(({ key, label }) => {\r\n    if (updates[key] !== undefined && updates[key] !== currentEmployee[key]) {\r\n      const oldValue = currentEmployee[key];\r\n      const newValue = updates[key];\r\n      \r\n      // Format values for display\r\n      let oldDisplay = oldValue;\r\n      let newDisplay = newValue;\r\n      \r\n      if (key === 'baseSalary') {\r\n        oldDisplay = new Intl.NumberFormat('vi-VN').format(oldValue as number) + 'ƒë';\r\n        newDisplay = new Intl.NumberFormat('vi-VN').format(newValue as number) + 'ƒë';\r\n      }\r\n      \r\n      historyEntries.push(createHistoryEntry(\r\n        'updated',\r\n        `${userInfo.name} ƒë√£ c·∫≠p nh·∫≠t ${label}: \"${oldDisplay || '(tr·ªëng)'}\" ‚Üí \"${newDisplay}\"`,\r\n        userInfo,\r\n        { field: key, oldValue, newValue }\r\n      ));\r\n    }\r\n  });\r\n  \r\n  // If status changed specifically\r\n  if (updates.employmentStatus && updates.employmentStatus !== currentEmployee.employmentStatus) {\r\n    historyEntries.push(createHistoryEntry(\r\n      'status_changed',\r\n      `${userInfo.name} ƒë√£ thay ƒë·ªïi tr·∫°ng th√°i l√†m vi·ªác t·ª´ \"${currentEmployee.employmentStatus}\" th√†nh \"${updates.employmentStatus}\"`,\r\n      userInfo,\r\n      { field: 'employmentStatus', oldValue: currentEmployee.employmentStatus, newValue: updates.employmentStatus }\r\n    ));\r\n  }\r\n  \r\n  // If no specific changes tracked, add generic update entry\r\n  if (historyEntries.length === 0) {\r\n    historyEntries.push(createHistoryEntry(\r\n      'updated',\r\n      `${userInfo.name} ƒë√£ c·∫≠p nh·∫≠t th√¥ng tin nh√¢n vi√™n`,\r\n      userInfo\r\n    ));\r\n  }\r\n  \r\n  const updatedHistory = appendHistoryEntry(currentEmployee.activityHistory, ...historyEntries);\r\n  \r\n  originalUpdate(systemId, {\r\n    ...updates,\r\n    activityHistory: updatedHistory,\r\n  });\r\n};\r\n\r\n// ‚úÖ Override base store methods\r\nbaseStore.setState({\r\n  add: wrappedAdd,\r\n  update: wrappedUpdate,\r\n});\r\n\r\nexport const employeeRepository = createInMemoryRepository<Employee>(() => baseStore.getState());\r\n\r\n// ‚úÖ API-backed persistence adapter - syncs to PostgreSQL\r\nconst API_ENDPOINT = '/api/employees';\r\n\r\nconst persistence: EmployeePersistenceAdapter = {\r\n  create: async (payload) => {\r\n    // First create locally for immediate UI update\r\n    const localResult = await employeeRepository.create(payload);\r\n    \r\n    // Then sync to API (background)\r\n    try {\r\n      const response = await fetch(API_ENDPOINT, {\r\n        method: 'POST',\r\n        credentials: 'include',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({ ...payload, systemId: localResult.systemId }),\r\n      });\r\n      if (!response.ok) {\r\n        console.warn('[Employee API] Create sync failed, data saved locally');\r\n      } else {\r\n        console.log('[Employee API] Created:', localResult.systemId);\r\n      }\r\n    } catch (e) {\r\n      console.warn('[Employee API] Create sync error:', e);\r\n    }\r\n    \r\n    return localResult;\r\n  },\r\n  update: async (systemId, payload) => {\r\n    // First update locally\r\n    const localResult = await employeeRepository.update(systemId, payload);\r\n    \r\n    // Then sync to API\r\n    try {\r\n      const response = await fetch(`${API_ENDPOINT}/${systemId}`, {\r\n        method: 'PATCH',\r\n        credentials: 'include',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify(payload),\r\n      });\r\n      if (!response.ok) {\r\n        console.warn('[Employee API] Update sync failed');\r\n      } else {\r\n        console.log('[Employee API] Updated:', systemId);\r\n      }\r\n    } catch (e) {\r\n      console.warn('[Employee API] Update sync error:', e);\r\n    }\r\n    \r\n    return localResult;\r\n  },\r\n  softDelete: async (systemId) => {\r\n    // First delete locally\r\n    await employeeRepository.softDelete(systemId);\r\n    \r\n    // Then sync to API\r\n    try {\r\n      const response = await fetch(`${API_ENDPOINT}/${systemId}`, {\r\n        method: 'DELETE',\r\n        credentials: 'include',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({ hard: false }),\r\n      });\r\n      if (!response.ok) {\r\n        console.warn('[Employee API] Soft delete sync failed');\r\n      } else {\r\n        console.log('[Employee API] Soft deleted:', systemId);\r\n      }\r\n    } catch (e) {\r\n      console.warn('[Employee API] Soft delete sync error:', e);\r\n    }\r\n  },\r\n  restore: async (systemId) => {\r\n    // First restore locally\r\n    const localResult = await employeeRepository.restore(systemId);\r\n    \r\n    // Then sync to API\r\n    try {\r\n      const response = await fetch(`${API_ENDPOINT}/${systemId}/restore`, {\r\n        method: 'POST',\r\n        credentials: 'include',\r\n        headers: { 'Content-Type': 'application/json' },\r\n      });\r\n      if (!response.ok) {\r\n        console.warn('[Employee API] Restore sync failed');\r\n      } else {\r\n        console.log('[Employee API] Restored:', systemId);\r\n      }\r\n    } catch (e) {\r\n      console.warn('[Employee API] Restore sync error:', e);\r\n    }\r\n    \r\n    return localResult;\r\n  },\r\n  hardDelete: async (systemId) => {\r\n    // First delete locally\r\n    await employeeRepository.hardDelete(systemId);\r\n    \r\n    // Then sync to API\r\n    try {\r\n      const response = await fetch(`${API_ENDPOINT}/${systemId}`, {\r\n        method: 'DELETE',\r\n        credentials: 'include',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({ hard: true }),\r\n      });\r\n      if (!response.ok) {\r\n        console.warn('[Employee API] Hard delete sync failed');\r\n      } else {\r\n        console.log('[Employee API] Hard deleted:', systemId);\r\n      }\r\n    } catch (e) {\r\n      console.warn('[Employee API] Hard delete sync error:', e);\r\n    }\r\n  },\r\n};\r\n\r\n// ‚úÖ Register for breadcrumb auto-generation\r\nregisterBreadcrumbStore('employees', () => baseStore.getState());\r\n\r\n// Define enhanced interface\r\ninterface EmployeeStoreState extends CrudState<Employee> {\r\n  searchEmployees: (query: string, page: number, limit?: number) => Promise<{ items: { value: string; label: string }[], hasNextPage: boolean }>;\r\n  permanentDelete: (systemId: SystemId) => Promise<void>;\r\n  persistence: EmployeePersistenceAdapter;\r\n}\r\n\r\ntype EmployeeStoreHook = (() => EmployeeStoreState) & {\r\n  getState: () => EmployeeStoreState;\r\n  persistence: EmployeePersistenceAdapter;\r\n};\r\n\r\n// Augmented methods\r\nconst augmentedMethods = {\r\n    // FIX: Changed `page: number = 1` to `page: number` to make it a required parameter, matching Combobox prop type.\r\n    // ‚úÖ CRITICAL FIX: Create fresh Fuse instance on each search to avoid stale data\r\n    searchEmployees: async (query: string, page: number, limit: number = 20) => {\r\n        return new Promise<{ items: { value: string; label: string }[], hasNextPage: boolean }>(resolve => {\r\n            setTimeout(() => {\r\n                const allEmployees = baseStore.getState().data;\r\n                \r\n                // ‚úÖ Create fresh Fuse instance with current data\r\n                const fuse = new Fuse(allEmployees, {\r\n                    keys: ['fullName', 'id', 'phone', 'personalEmail', 'workEmail'],\r\n                    threshold: 0.3,\r\n                });\r\n                \r\n                const results = query ? fuse.search(query).map(r => r.item) : allEmployees;\r\n                \r\n                const start = (page - 1) * limit;\r\n                const end = start + limit;\r\n                const paginatedItems = results.slice(start, end);\r\n\r\n                resolve({\r\n                    items: paginatedItems.map(e => ({ value: e.systemId, label: e.fullName })),\r\n                    hasNextPage: end < results.length,\r\n                });\r\n            }, 300);\r\n        });\r\n    },\r\n    permanentDelete: async (systemId: SystemId) => {\r\n        await persistence.hardDelete(systemId);\r\n    }\r\n};\r\n\r\nconst useEmployeeStoreHook = (): EmployeeStoreState => {\r\n  const state = baseStore();\r\n  return {\r\n    ...state,\r\n    ...augmentedMethods, // This includes permanentDelete\r\n    persistence,\r\n  };\r\n};\r\n\r\nexport const useEmployeeStore = useEmployeeStoreHook as EmployeeStoreHook;\r\n\r\n// Export getState for non-hook usage\r\nuseEmployeeStore.getState = (): EmployeeStoreState => {\r\n  const state = baseStore.getState();\r\n  return {\r\n    ...state,\r\n    ...augmentedMethods,\r\n    persistence,\r\n  };\r\n};\r\n\r\nuseEmployeeStore.persistence = persistence;\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 313, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/products/store.ts"],"sourcesContent":["import { createCrudStore, CrudState } from '../../lib/store-factory';\r\n// REMOVED: import { data as initialData } from './data'; // Mock data no longer used - database is source of truth\r\nimport type { Product } from './types';\r\nimport { type SystemId } from '@/lib/id-types';\r\nimport { asSystemId, asBusinessId } from '../../lib/id-types';\r\nimport { getCurrentUserSystemId } from '../../contexts/auth-context';\r\nimport Fuse from 'fuse.js';\r\nimport {\r\n  getCurrentUserInfo,\r\n  createCreatedEntry,\r\n  createUpdatedEntry,\r\n  createStatusChangedEntry,\r\n  appendHistoryEntry,\r\n  type HistoryEntry\r\n} from '../../lib/activity-history-helper';\r\n\r\nconst baseStore = createCrudStore<Product>([], 'products', {\r\n  businessIdField: 'id',\r\n  getCurrentUser: getCurrentUserSystemId, // ‚úÖ Track who creates/updates\r\n  apiEndpoint: '/api/products',\r\n});\r\n\r\n// ‚úÖ API Sync helpers\r\nconst API_ENDPOINT = '/api/products';\r\n\r\nconst syncToApi = {\r\n  create: async (product: Product) => {\r\n    try {\r\n      const response = await fetch(API_ENDPOINT, {\r\n        method: 'POST',\r\n        credentials: 'include',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify(product),\r\n      });\r\n      if (!response.ok) console.warn('[Product API] Create sync failed');\r\n      else console.log('[Product API] Created:', product.systemId);\r\n    } catch (e) {\r\n      console.warn('[Product API] Create sync error:', e);\r\n    }\r\n  },\r\n  update: async (systemId: SystemId, updates: Partial<Product>) => {\r\n    try {\r\n      const response = await fetch(`${API_ENDPOINT}/${systemId}`, {\r\n        method: 'PATCH',\r\n        credentials: 'include',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify(updates),\r\n      });\r\n      if (!response.ok) console.warn('[Product API] Update sync failed');\r\n      else console.log('[Product API] Updated:', systemId);\r\n    } catch (e) {\r\n      console.warn('[Product API] Update sync error:', e);\r\n    }\r\n  },\r\n  delete: async (systemId: SystemId, hard = false) => {\r\n    try {\r\n      const response = await fetch(`${API_ENDPOINT}/${systemId}`, {\r\n        method: 'DELETE',\r\n        credentials: 'include',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({ hard }),\r\n      });\r\n      if (!response.ok) console.warn('[Product API] Delete sync failed');\r\n      else console.log('[Product API] Deleted:', systemId);\r\n    } catch (e) {\r\n      console.warn('[Product API] Delete sync error:', e);\r\n    }\r\n  },\r\n  restore: async (systemId: SystemId) => {\r\n    try {\r\n      const response = await fetch(`${API_ENDPOINT}/${systemId}/restore`, {\r\n        method: 'POST',\r\n        credentials: 'include',\r\n        headers: { 'Content-Type': 'application/json' },\r\n      });\r\n      if (!response.ok) console.warn('[Product API] Restore sync failed');\r\n      else console.log('[Product API] Restored:', systemId);\r\n    } catch (e) {\r\n      console.warn('[Product API] Restore sync error:', e);\r\n    }\r\n  },\r\n};\r\n\r\n// ‚úÖ Wrap base store methods with API sync\r\nconst originalAdd = baseStore.getState().add;\r\nconst originalUpdate = baseStore.getState().update;\r\nconst originalRemove = baseStore.getState().remove;\r\nconst originalHardDelete = baseStore.getState().hardDelete;\r\nconst originalRestore = baseStore.getState().restore;\r\n\r\nbaseStore.setState({\r\n  add: (item: Omit<Product, 'systemId'>) => {\r\n    const result = originalAdd(item);\r\n    syncToApi.create(result);\r\n    return result;\r\n  },\r\n  update: (systemId: SystemId, updates: Partial<Product>) => {\r\n    originalUpdate(systemId, updates);\r\n    syncToApi.update(systemId, updates);\r\n  },\r\n  remove: (systemId: SystemId) => {\r\n    originalRemove(systemId);\r\n    syncToApi.delete(systemId, false);\r\n  },\r\n  hardDelete: (systemId: SystemId) => {\r\n    originalHardDelete(systemId);\r\n    syncToApi.delete(systemId, true);\r\n  },\r\n  restore: (systemId: SystemId) => {\r\n    originalRestore(systemId);\r\n    syncToApi.restore(systemId);\r\n  },\r\n});\r\n\r\n// Define extended store interface\r\nexport interface ProductStoreState extends CrudState<Product> {\r\n  updateInventory: (productSystemId: SystemId, branchSystemId: SystemId, quantityChange: number) => void;\r\n  commitStock: (productSystemId: SystemId, branchSystemId: SystemId, quantity: number) => void;\r\n  uncommitStock: (productSystemId: SystemId, branchSystemId: SystemId, quantity: number) => void;\r\n  dispatchStock: (productSystemId: SystemId, branchSystemId: SystemId, quantity: number) => void;\r\n  completeDelivery: (productSystemId: SystemId, branchSystemId: SystemId, quantity: number) => void;\r\n  returnStockFromTransit: (productSystemId: SystemId, branchSystemId: SystemId, quantity: number) => void;\r\n  updateLastPurchasePrice: (productSystemId: SystemId, price: number, date: string) => void;\r\n  searchProducts: (query: string, page: number, limit?: number) => Promise<{ items: { value: SystemId; label: string }[], hasNextPage: boolean }>;\r\n}\r\n\r\n// Helper to check if product tracks stock\r\nconst canModifyStock = (product: Product | undefined): boolean => {\r\n  if (!product) return false;\r\n  // Services, digital products, and combos don't track stock directly\r\n  if (product.type === 'service' || product.type === 'digital' || product.type === 'combo') return false;\r\n  // Explicitly disabled stock tracking\r\n  if (product.isStockTracked === false) return false;\r\n  return true;\r\n};\r\n\r\n// Define custom methods\r\nconst updateInventory = (productSystemId: SystemId, branchSystemId: SystemId, quantityChange: number) => {\r\n  baseStore.setState(state => {\r\n    const product = state.data.find(p => p.systemId === productSystemId);\r\n    if (!product) return state;\r\n    \r\n    // Skip if product doesn't track stock\r\n    if (!canModifyStock(product)) {\r\n      console.warn(`[updateInventory] Skipped: Product ${productSystemId} does not track stock`);\r\n      return state;\r\n    }\r\n    \r\n    const oldQuantity = product.inventoryByBranch?.[branchSystemId] || 0;\r\n    const newQuantity = oldQuantity + quantityChange;\r\n    \r\n    // ‚úÖ Removed COMPLAINT_ADJUSTMENT stock history creation\r\n    // Stock history will be created by inventory check balance instead\r\n    \r\n    return {\r\n      data: state.data.map(p => {\r\n        if (p.systemId === productSystemId) {\r\n          const newInventoryByBranch = { ...p.inventoryByBranch };\r\n          newInventoryByBranch[branchSystemId] = newQuantity;\r\n          return {\r\n            ...p,\r\n            inventoryByBranch: newInventoryByBranch,\r\n          };\r\n        }\r\n        return p;\r\n      }),\r\n    };\r\n  });\r\n};\r\n\r\nconst commitStock = (productSystemId: SystemId, branchSystemId: SystemId, quantity: number) => {\r\n  baseStore.setState(state => {\r\n    const product = state.data.find(p => p.systemId === productSystemId);\r\n    if (!canModifyStock(product)) {\r\n      console.warn(`[commitStock] Skipped: Product ${productSystemId} does not track stock`);\r\n      return state;\r\n    }\r\n    return {\r\n      data: state.data.map(p => {\r\n        if (p.systemId === productSystemId) {\r\n          const newCommitted = { ...p.committedByBranch };\r\n          newCommitted[branchSystemId] = (newCommitted[branchSystemId] || 0) + quantity;\r\n          return { ...p, committedByBranch: newCommitted };\r\n        }\r\n        return p;\r\n      }),\r\n    };\r\n  });\r\n};\r\n\r\nconst uncommitStock = (productSystemId: SystemId, branchSystemId: SystemId, quantity: number) => {\r\n  baseStore.setState(state => {\r\n    const product = state.data.find(p => p.systemId === productSystemId);\r\n    if (!canModifyStock(product)) {\r\n      console.warn(`[uncommitStock] Skipped: Product ${productSystemId} does not track stock`);\r\n      return state;\r\n    }\r\n    return {\r\n      data: state.data.map(p => {\r\n        if (p.systemId === productSystemId) {\r\n          const newCommitted = { ...p.committedByBranch };\r\n          newCommitted[branchSystemId] = Math.max(0, (newCommitted[branchSystemId] || 0) - quantity);\r\n          return { ...p, committedByBranch: newCommitted };\r\n        }\r\n        return p;\r\n      }),\r\n    };\r\n  });\r\n};\r\n\r\nconst dispatchStock = (productSystemId: SystemId, branchSystemId: SystemId, quantity: number) => {\r\n  console.log('üî¥ [dispatchStock] Called with:', { productSystemId, branchSystemId, quantity });\r\n  \r\n  baseStore.setState(state => {\r\n    const product = state.data.find(p => p.systemId === productSystemId);\r\n    if (!product) {\r\n      console.error('‚ùå [dispatchStock] Product not found:', productSystemId);\r\n      return state;\r\n    }\r\n    \r\n    // Skip if product doesn't track stock\r\n    if (!canModifyStock(product)) {\r\n      console.warn(`[dispatchStock] Skipped: Product ${productSystemId} does not track stock`);\r\n      return state;\r\n    }\r\n    \r\n    console.log('üì¶ [dispatchStock] Current inventory:', product.inventoryByBranch);\r\n    console.log('üì¶ [dispatchStock] Current committed:', product.committedByBranch);\r\n    \r\n    return {\r\n      data: state.data.map(product => {\r\n        if (product.systemId === productSystemId) {\r\n          const newInventory = { ...product.inventoryByBranch };\r\n          const oldInventory = newInventory[branchSystemId] || 0;\r\n          newInventory[branchSystemId] = oldInventory - quantity;\r\n          \r\n          const newCommitted = { ...product.committedByBranch };\r\n          newCommitted[branchSystemId] = Math.max(0, (newCommitted[branchSystemId] || 0) - quantity);\r\n\r\n          const newInTransit = { ...product.inTransitByBranch };\r\n          newInTransit[branchSystemId] = (newInTransit[branchSystemId] || 0) + quantity;\r\n          \r\n          console.log('‚úÖ [dispatchStock] Updated inventory:', {\r\n            old: oldInventory,\r\n            new: newInventory[branchSystemId],\r\n            change: -quantity\r\n          });\r\n          \r\n          return { \r\n            ...product, \r\n            inventoryByBranch: newInventory,\r\n            committedByBranch: newCommitted,\r\n            inTransitByBranch: newInTransit,\r\n          };\r\n        }\r\n        return product;\r\n      }),\r\n    };\r\n  });\r\n  \r\n  console.log('‚úÖ [dispatchStock] Completed');\r\n};\r\n\r\nconst completeDelivery = (productSystemId: SystemId, branchSystemId: SystemId, quantity: number) => {\r\n  baseStore.setState(state => {\r\n    const product = state.data.find(p => p.systemId === productSystemId);\r\n    if (!canModifyStock(product)) {\r\n      return state;\r\n    }\r\n    return {\r\n      data: state.data.map(p => {\r\n        if (p.systemId === productSystemId) {\r\n          const newInTransit = { ...p.inTransitByBranch };\r\n          newInTransit[branchSystemId] = Math.max(0, (newInTransit[branchSystemId] || 0) - quantity);\r\n          return { ...p, inTransitByBranch: newInTransit };\r\n        }\r\n        return p;\r\n      }),\r\n    };\r\n  });\r\n};\r\n\r\nconst returnStockFromTransit = (productSystemId: SystemId, branchSystemId: SystemId, quantity: number) => {\r\n  baseStore.setState(state => {\r\n    const product = state.data.find(p => p.systemId === productSystemId);\r\n    if (!canModifyStock(product)) {\r\n      return state;\r\n    }\r\n    return {\r\n      data: state.data.map(p => {\r\n        if (p.systemId === productSystemId) {\r\n          const newInTransit = { ...p.inTransitByBranch };\r\n          newInTransit[branchSystemId] = Math.max(0, (newInTransit[branchSystemId] || 0) - quantity);\r\n          const newInventory = { ...p.inventoryByBranch };\r\n          newInventory[branchSystemId] = (newInventory[branchSystemId] || 0) + quantity;\r\n          return { ...p, inventoryByBranch: newInventory, inTransitByBranch: newInTransit };\r\n        }\r\n        return p;\r\n      }),\r\n    };\r\n  });\r\n};\r\n\r\nconst updateLastPurchasePrice = (productSystemId: SystemId, price: number, date: string) => {\r\n  baseStore.setState(state => ({\r\n    data: state.data.map(product => {\r\n      if (product.systemId === productSystemId) {\r\n        // Only update if the new date is newer or equal to the existing lastPurchaseDate\r\n        const existingDate = product.lastPurchaseDate ? new Date(product.lastPurchaseDate).getTime() : 0;\r\n        const newDateTs = new Date(date).getTime();\r\n        \r\n        if (newDateTs >= existingDate) {\r\n          return {\r\n            ...product,\r\n            lastPurchasePrice: price,\r\n            lastPurchaseDate: date,\r\n          };\r\n        }\r\n      }\r\n      return product;\r\n    }),\r\n  }));\r\n};\r\n\r\nconst searchProducts = async (query: string, page: number = 1, limit: number = 10): Promise<{ items: { value: SystemId; label: string }[], hasNextPage: boolean }> => {\r\n  const allProducts = baseStore.getState().data;\r\n  \r\n  // ‚úÖ Create fresh Fuse instance with current data (avoid stale data)\r\n  const fuse = new Fuse(allProducts, {\r\n    keys: ['name', 'id', 'sku', 'barcode'],\r\n    threshold: 0.3,\r\n  });\r\n  \r\n  const results = fuse.search(query);\r\n  const startIndex = (page - 1) * limit;\r\n  const endIndex = startIndex + limit;\r\n  const paginatedResults = results.slice(startIndex, endIndex);\r\n\r\n  return {\r\n    items: paginatedResults.map(result => ({\r\n      value: asSystemId(result.item.systemId),\r\n      label: `${result.item.name} (${result.item.id})`,\r\n    })),\r\n    hasNextPage: endIndex < results.length,\r\n  };\r\n};\r\n\r\n// Wrapped add method with activity history logging\r\nconst addProduct = (product: Omit<Product, 'systemId'>) => {\r\n  const userInfo = getCurrentUserInfo();\r\n  const newProduct = baseStore.getState().add(product);\r\n  \r\n  // Add activity history entry\r\n  const historyEntry = createCreatedEntry(\r\n    userInfo,\r\n    `${userInfo.name} ƒë√£ t·∫°o s·∫£n ph·∫©m ${newProduct.name} (${newProduct.id})`\r\n  );\r\n  baseStore.getState().update(newProduct.systemId, {\r\n    ...newProduct,\r\n    activityHistory: [historyEntry]\r\n  });\r\n  \r\n  return newProduct;\r\n};\r\n\r\n// Wrapped update method with activity history logging\r\nconst updateProduct = (systemId: SystemId, updatedProduct: Product) => {\r\n  const userInfo = getCurrentUserInfo();\r\n  const existingProduct = baseStore.getState().data.find(p => p.systemId === systemId);\r\n  const historyEntries: HistoryEntry[] = [];\r\n  \r\n  if (existingProduct) {\r\n    // Track status changes\r\n    if (existingProduct.status !== updatedProduct.status) {\r\n      const statusLabels: Record<string, string> = {\r\n        'active': 'ƒêang kinh doanh',\r\n        'inactive': 'Ng·ª´ng kinh doanh',\r\n        'discontinued': 'Ng·ª´ng s·∫£n xu·∫•t'\r\n      };\r\n      historyEntries.push(createStatusChangedEntry(\r\n        userInfo,\r\n        statusLabels[existingProduct.status || 'active'],\r\n        statusLabels[updatedProduct.status || 'active'],\r\n        `${userInfo.name} ƒë√£ ƒë·ªïi tr·∫°ng th√°i t·ª´ \"${statusLabels[existingProduct.status || 'active']}\" sang \"${statusLabels[updatedProduct.status || 'active']}\"`\r\n      ));\r\n    }\r\n    \r\n    // Track field changes\r\n    const fieldsToTrack: Array<{ key: keyof Product; label: string }> = [\r\n      { key: 'name', label: 'T√™n s·∫£n ph·∫©m' },\r\n      { key: 'id', label: 'M√£ SKU' },\r\n      { key: 'description', label: 'M√¥ t·∫£' },\r\n      { key: 'shortDescription', label: 'M√¥ t·∫£ ng·∫Øn' },\r\n      { key: 'type', label: 'Lo·∫°i s·∫£n ph·∫©m' },\r\n      { key: 'categorySystemId', label: 'Danh m·ª•c' },\r\n      { key: 'brandSystemId', label: 'Th∆∞∆°ng hi·ªáu' },\r\n      { key: 'unit', label: 'ƒê∆°n v·ªã t√≠nh' },\r\n      { key: 'costPrice', label: 'Gi√° v·ªën' },\r\n      { key: 'minPrice', label: 'Gi√° t·ªëi thi·ªÉu' },\r\n      { key: 'barcode', label: 'M√£ v·∫°ch' },\r\n      { key: 'primarySupplierSystemId', label: 'Nh√† cung c·∫•p ch√≠nh' },\r\n      { key: 'warrantyPeriodMonths', label: 'Th·ªùi h·∫°n b·∫£o h√†nh' },\r\n      { key: 'reorderLevel', label: 'M·ª©c ƒë·∫∑t h√†ng l·∫°i' },\r\n      { key: 'safetyStock', label: 'T·ªìn kho an to√†n' },\r\n      { key: 'maxStock', label: 'T·ªìn kho t·ªëi ƒëa' },\r\n    ];\r\n    \r\n    const changes: string[] = [];\r\n    for (const field of fieldsToTrack) {\r\n      const oldVal = existingProduct[field.key];\r\n      const newVal = updatedProduct[field.key];\r\n      if (oldVal !== newVal && !(oldVal === undefined && newVal === undefined)) {\r\n        if (field.key === 'status') continue;\r\n        const oldDisplay = oldVal !== undefined && oldVal !== null && oldVal !== '' ? String(oldVal) : '(tr·ªëng)';\r\n        const newDisplay = newVal !== undefined && newVal !== null && newVal !== '' ? String(newVal) : '(tr·ªëng)';\r\n        changes.push(`${field.label}: ${oldDisplay} ‚Üí ${newDisplay}`);\r\n      }\r\n    }\r\n    \r\n    // Track price changes separately\r\n    if (existingProduct.costPrice !== updatedProduct.costPrice) {\r\n      changes.push(`Gi√° v·ªën: ${existingProduct.costPrice?.toLocaleString('vi-VN')} ‚Üí ${updatedProduct.costPrice?.toLocaleString('vi-VN')}`);\r\n    }\r\n    \r\n    if (changes.length > 0) {\r\n      historyEntries.push(createUpdatedEntry(\r\n        userInfo,\r\n        `${userInfo.name} ƒë√£ c·∫≠p nh·∫≠t: ${changes.join(', ')}`\r\n      ));\r\n    }\r\n  }\r\n  \r\n  const productWithHistory = {\r\n    ...updatedProduct,\r\n    activityHistory: appendHistoryEntry(existingProduct?.activityHistory, ...historyEntries)\r\n  };\r\n  \r\n  baseStore.getState().update(systemId, productWithHistory);\r\n};\r\n\r\n// Export typed hook that includes both base and custom methods\r\nexport const useProductStore = (): ProductStoreState => {\r\n  const state = baseStore();\r\n  return {\r\n    ...state,\r\n    add: addProduct,\r\n    update: updateProduct,\r\n    updateInventory,\r\n    commitStock,\r\n    uncommitStock,\r\n    dispatchStock,\r\n    completeDelivery,\r\n    returnStockFromTransit,\r\n    updateLastPurchasePrice,\r\n    searchProducts,\r\n  };\r\n};\r\n\r\n// Export getState method for non-hook usage\r\nuseProductStore.getState = () => {\r\n  const state = baseStore.getState();\r\n  return {\r\n    ...state,\r\n    add: addProduct,\r\n    update: updateProduct,\r\n    updateInventory,\r\n    commitStock,\r\n    uncommitStock,\r\n    dispatchStock,\r\n    completeDelivery,\r\n    returnStockFromTransit,\r\n    updateLastPurchasePrice,\r\n    searchProducts,\r\n  };\r\n};\r\n\r\n(useProductStore as typeof useProductStore & { subscribe?: typeof baseStore.subscribe }).subscribe = baseStore.subscribe;\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 824, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/products/combo-utils.ts"],"sourcesContent":["/**\r\n * Combo Product Utilities\r\n * ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\r\n * Tham kh·∫£o: Sapo Combo\r\n * - Combo kh√¥ng c√≥ t·ªìn kho ri√™ng\r\n * - T·ªìn kho combo = MIN(t·ªìn kho SP con / s·ªë l∆∞·ª£ng trong combo)\r\n * - T·ªëi ƒëa 20 s·∫£n ph·∫©m con\r\n * - Kh√¥ng cho ph√©p combo l·ªìng combo\r\n * ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\r\n */\r\n\r\nimport type { Product, ComboItem, ComboPricingType } from './types';\r\nimport type { SystemId } from '@/lib/id-types';\r\n\r\n// Constants\r\nexport const MAX_COMBO_ITEMS = 20;\r\nexport const MIN_COMBO_ITEMS = 2;\r\n\r\n/**\r\n * Check if product is a combo\r\n */\r\nexport function isComboProduct(product: Product): boolean {\r\n  return product.type === 'combo';\r\n}\r\n\r\n/**\r\n * Check if a product can be added to combo\r\n * - Kh√¥ng cho ph√©p th√™m combo v√†o combo (no nested combo)\r\n * - S·∫£n ph·∫©m ph·∫£i active\r\n */\r\nexport function canAddToCombo(product: Product): boolean {\r\n  if (product.type === 'combo') return false;\r\n  if (product.status === 'discontinued') return false;\r\n  if (product.isDeleted) return false;\r\n  return true;\r\n}\r\n\r\n/**\r\n * Validate combo items\r\n * Returns error message or null if valid\r\n */\r\nexport function validateComboItems(\r\n  comboItems: ComboItem[],\r\n  allProducts: Product[]\r\n): string | null {\r\n  // Check minimum items\r\n  if (comboItems.length < MIN_COMBO_ITEMS) {\r\n    return `Combo ph·∫£i c√≥ √≠t nh·∫•t ${MIN_COMBO_ITEMS} s·∫£n ph·∫©m`;\r\n  }\r\n  \r\n  // Check maximum items\r\n  if (comboItems.length > MAX_COMBO_ITEMS) {\r\n    return `Combo ch·ªâ ƒë∆∞·ª£c t·ªëi ƒëa ${MAX_COMBO_ITEMS} s·∫£n ph·∫©m`;\r\n  }\r\n  \r\n  // Check for duplicate products\r\n  const productIds = comboItems.map(item => item.productSystemId);\r\n  const uniqueIds = new Set(productIds);\r\n  if (uniqueIds.size !== productIds.length) {\r\n    return 'Combo kh√¥ng ƒë∆∞·ª£c ch·ª©a s·∫£n ph·∫©m tr√πng l·∫∑p';\r\n  }\r\n  \r\n  // Check each item\r\n  for (const item of comboItems) {\r\n    // Check quantity\r\n    if (item.quantity < 1) {\r\n      return 'S·ªë l∆∞·ª£ng s·∫£n ph·∫©m trong combo ph·∫£i >= 1';\r\n    }\r\n    \r\n    if (!Number.isInteger(item.quantity)) {\r\n      return 'S·ªë l∆∞·ª£ng s·∫£n ph·∫©m trong combo ph·∫£i l√† s·ªë nguy√™n';\r\n    }\r\n    \r\n    // Check product exists and is valid\r\n    const product = allProducts.find(p => p.systemId === item.productSystemId);\r\n    if (!product) {\r\n      return 'S·∫£n ph·∫©m trong combo kh√¥ng t·ªìn t·∫°i';\r\n    }\r\n    \r\n    if (!canAddToCombo(product)) {\r\n      return `S·∫£n ph·∫©m \"${product.name}\" kh√¥ng th·ªÉ th√™m v√†o combo`;\r\n    }\r\n  }\r\n  \r\n  return null;\r\n}\r\n\r\n/**\r\n * Calculate combo available stock for a specific branch\r\n * Formula: MIN(child_product_available / quantity_in_combo)\r\n * \r\n * @param comboItems - List of combo items\r\n * @param allProducts - All products to lookup\r\n * @param branchSystemId - Branch to calculate stock for\r\n * @returns Available combo quantity (floored to integer)\r\n */\r\nexport function calculateComboStock(\r\n  comboItems: ComboItem[],\r\n  allProducts: Product[],\r\n  branchSystemId: SystemId\r\n): number {\r\n  if (!comboItems || comboItems.length === 0) return 0;\r\n  \r\n  let minComboQuantity = Infinity;\r\n  \r\n  for (const item of comboItems) {\r\n    const product = allProducts.find(p => p.systemId === item.productSystemId);\r\n    if (!product) return 0; // If any product not found, combo unavailable\r\n    \r\n    // Available = On-hand - Committed\r\n    const onHand = product.inventoryByBranch?.[branchSystemId] || 0;\r\n    const committed = product.committedByBranch?.[branchSystemId] || 0;\r\n    const available = onHand - committed;\r\n    \r\n    // How many combos can we make from this product?\r\n    const comboQuantityFromThisProduct = Math.floor(available / item.quantity);\r\n    \r\n    minComboQuantity = Math.min(minComboQuantity, comboQuantityFromThisProduct);\r\n  }\r\n  \r\n  return minComboQuantity === Infinity ? 0 : Math.max(0, minComboQuantity);\r\n}\r\n\r\n/**\r\n * Calculate combo stock across all branches\r\n * Returns a map of branchSystemId -> available combo quantity\r\n */\r\nexport function calculateComboStockAllBranches(\r\n  comboItems: ComboItem[],\r\n  allProducts: Product[]\r\n): Record<SystemId, number> {\r\n  if (!comboItems || comboItems.length === 0) return {};\r\n  \r\n  // Collect all branch IDs from child products\r\n  const allBranchIds = new Set<SystemId>();\r\n  for (const item of comboItems) {\r\n    const product = allProducts.find(p => p.systemId === item.productSystemId);\r\n    if (product?.inventoryByBranch) {\r\n      Object.keys(product.inventoryByBranch).forEach(branchId => {\r\n        allBranchIds.add(branchId as SystemId);\r\n      });\r\n    }\r\n  }\r\n  \r\n  // Calculate stock for each branch\r\n  const result: Record<SystemId, number> = {};\r\n  for (const branchId of allBranchIds) {\r\n    result[branchId] = calculateComboStock(comboItems, allProducts, branchId);\r\n  }\r\n  \r\n  return result;\r\n}\r\n\r\n/**\r\n * Calculate combo price based on pricing type\r\n * \r\n * @param comboItems - List of combo items\r\n * @param allProducts - All products to lookup prices\r\n * @param pricingPolicySystemId - Which pricing policy to use\r\n * @param comboPricingType - How to calculate price\r\n * @param comboDiscount - Discount value (% or fixed amount)\r\n * @returns Calculated combo price\r\n */\r\nexport function calculateComboPrice(\r\n  comboItems: ComboItem[],\r\n  allProducts: Product[],\r\n  pricingPolicySystemId: SystemId,\r\n  comboPricingType: ComboPricingType,\r\n  comboDiscount: number = 0\r\n): number {\r\n  if (comboPricingType === 'fixed') {\r\n    // Fixed price is stored directly, not calculated\r\n    return comboDiscount; // In fixed mode, comboDiscount IS the price\r\n  }\r\n  \r\n  // Calculate sum of child products' prices\r\n  let sumPrice = 0;\r\n  for (const item of comboItems) {\r\n    const product = allProducts.find(p => p.systemId === item.productSystemId);\r\n    if (!product) continue;\r\n    \r\n    const unitPrice = product.prices?.[pricingPolicySystemId] || 0;\r\n    sumPrice += unitPrice * item.quantity;\r\n  }\r\n  \r\n  // Apply discount\r\n  if (comboPricingType === 'sum_discount_percent') {\r\n    const discountAmount = sumPrice * (comboDiscount / 100);\r\n    return Math.round(sumPrice - discountAmount);\r\n  }\r\n  \r\n  if (comboPricingType === 'sum_discount_amount') {\r\n    return Math.max(0, sumPrice - comboDiscount);\r\n  }\r\n  \r\n  return sumPrice;\r\n}\r\n\r\n/**\r\n * Calculate combo cost price (sum of child products' cost prices)\r\n */\r\ntype ComboCostOptions = {\r\n  /**\r\n   * Optional pricing policy to use when we have to fall back to selling price data.\r\n   * Ensures cost previews stay in sync with the price policy that users actually see.\r\n   */\r\n  fallbackPricingPolicyId?: SystemId;\r\n  /**\r\n   * Allow falling back to selling price data if cost/last purchase/min price are missing.\r\n   * Defaults to true to avoid showing zero cost when data is incomplete.\r\n   */\r\n  allowPriceFallback?: boolean;\r\n};\r\n\r\nconst isNumber = (value: unknown): value is number => typeof value === 'number' && Number.isFinite(value);\r\n\r\nexport function calculateComboCostPrice(\r\n  comboItems: ComboItem[],\r\n  allProducts: Product[],\r\n  options: ComboCostOptions = {}\r\n): number {\r\n  const { fallbackPricingPolicyId, allowPriceFallback = true } = options;\r\n  let totalCost = 0;\r\n  \r\n  for (const item of comboItems) {\r\n    const product = allProducts.find(p => p.systemId === item.productSystemId);\r\n    if (!product) continue;\r\n\r\n    let unitCost = product.costPrice;\r\n\r\n    if (!isNumber(unitCost) && isNumber(product.lastPurchasePrice)) {\r\n      unitCost = product.lastPurchasePrice;\r\n    }\r\n\r\n    if (!isNumber(unitCost) && allowPriceFallback) {\r\n      if (fallbackPricingPolicyId && isNumber(product.prices?.[fallbackPricingPolicyId])) {\r\n        unitCost = product.prices![fallbackPricingPolicyId];\r\n      }\r\n\r\n      if (!isNumber(unitCost)) {\r\n        const firstPrice = Object.values(product.prices || {}).find((price): price is number => isNumber(price));\r\n        if (isNumber(firstPrice)) {\r\n          unitCost = firstPrice;\r\n        }\r\n      }\r\n    }\r\n\r\n    if (!isNumber(unitCost) && isNumber(product.minPrice)) {\r\n      unitCost = product.minPrice;\r\n    }\r\n    \r\n    totalCost += (unitCost || 0) * item.quantity;\r\n  }\r\n  \r\n  return totalCost;\r\n}\r\n\r\n/**\r\n * Calculate combo last purchase price (sum of child products' last purchase prices)\r\n */\r\nexport function calculateComboLastPurchasePrice(\r\n  comboItems: ComboItem[],\r\n  allProducts: Product[]\r\n): number {\r\n  let total = 0;\r\n  \r\n  for (const item of comboItems) {\r\n    const product = allProducts.find(p => p.systemId === item.productSystemId);\r\n    if (!product) continue;\r\n    \r\n    total += (product.lastPurchasePrice || 0) * item.quantity;\r\n  }\r\n  \r\n  return total;\r\n}\r\n\r\n/**\r\n * Calculate combo min price (sum of child products' min prices)\r\n */\r\nexport function calculateComboMinPrice(\r\n  comboItems: ComboItem[],\r\n  allProducts: Product[]\r\n): number {\r\n  let total = 0;\r\n  \r\n  for (const item of comboItems) {\r\n    const product = allProducts.find(p => p.systemId === item.productSystemId);\r\n    if (!product) continue;\r\n    \r\n    total += (product.minPrice || 0) * item.quantity;\r\n  }\r\n  \r\n  return total;\r\n}\r\n\r\n/**\r\n * Calculate combo prices by policy (sum of child products' prices per policy)\r\n * This returns the RAW sum without any discount applied\r\n */\r\nexport function calculateComboPricesByPolicy(\r\n  comboItems: ComboItem[],\r\n  allProducts: Product[]\r\n): Record<string, number> {\r\n  const pricesByPolicy: Record<string, number> = {};\r\n  \r\n  for (const item of comboItems) {\r\n    const product = allProducts.find(p => p.systemId === item.productSystemId);\r\n    if (!product || !product.prices) continue;\r\n    \r\n    for (const [policyId, price] of Object.entries(product.prices)) {\r\n      if (!pricesByPolicy[policyId]) {\r\n        pricesByPolicy[policyId] = 0;\r\n      }\r\n      pricesByPolicy[policyId] += (price || 0) * item.quantity;\r\n    }\r\n  }\r\n  \r\n  return pricesByPolicy;\r\n}\r\n\r\n/**\r\n * Calculate final combo prices by policy with discount applied\r\n * This returns the actual selling prices for the combo\r\n * \r\n * @param comboItems - List of combo items\r\n * @param allProducts - All products to lookup prices\r\n * @param comboPricingType - How to calculate price\r\n * @param comboDiscount - Discount value (% or fixed amount or fixed price)\r\n * @param defaultPolicyId - Default selling policy ID (used for fixed pricing)\r\n * @returns Final combo prices by policy\r\n */\r\nexport function calculateFinalComboPricesByPolicy(\r\n  comboItems: ComboItem[],\r\n  allProducts: Product[],\r\n  comboPricingType: ComboPricingType,\r\n  comboDiscount: number = 0,\r\n  defaultPolicyId?: string\r\n): Record<string, number> {\r\n  // Get raw sum prices first\r\n  const rawPricesByPolicy = calculateComboPricesByPolicy(comboItems, allProducts);\r\n  const finalPricesByPolicy: Record<string, number> = {};\r\n  \r\n  if (comboPricingType === 'fixed') {\r\n    // For fixed pricing, only policies that exist on child products should be auto-filled.\r\n    for (const policyId of Object.keys(rawPricesByPolicy)) {\r\n      finalPricesByPolicy[policyId] = comboDiscount; // comboDiscount IS the price in fixed mode\r\n    }\r\n    return finalPricesByPolicy;\r\n  }\r\n  \r\n  // For discount-based pricing, apply discount to each policy's sum\r\n  for (const [policyId, sumPrice] of Object.entries(rawPricesByPolicy)) {\r\n    if (comboPricingType === 'sum_discount_percent') {\r\n      const discountAmount = sumPrice * (comboDiscount / 100);\r\n      finalPricesByPolicy[policyId] = Math.round(sumPrice - discountAmount);\r\n    } else if (comboPricingType === 'sum_discount_amount') {\r\n      finalPricesByPolicy[policyId] = Math.max(0, sumPrice - comboDiscount);\r\n    } else {\r\n      // No discount, use raw sum\r\n      finalPricesByPolicy[policyId] = sumPrice;\r\n    }\r\n  }\r\n  \r\n  return finalPricesByPolicy;\r\n}\r\n\r\n/**\r\n * Get summary text for combo (e.g., \"3 s·∫£n ph·∫©m, t·ªìn kho: 15\")\r\n */\r\nexport function getComboSummary(\r\n  comboItems: ComboItem[],\r\n  allProducts: Product[],\r\n  branchSystemId?: SystemId\r\n): string {\r\n  const itemCount = comboItems?.length || 0;\r\n  \r\n  if (!branchSystemId) {\r\n    return `${itemCount} s·∫£n ph·∫©m`;\r\n  }\r\n  \r\n  const stock = calculateComboStock(comboItems, allProducts, branchSystemId);\r\n  return `${itemCount} s·∫£n ph·∫©m, t·ªìn kho: ${stock}`;\r\n}\r\n\r\n/**\r\n * Check if combo has sufficient stock for a quantity\r\n */\r\nexport function hasComboStock(\r\n  comboItems: ComboItem[],\r\n  allProducts: Product[],\r\n  branchSystemId: SystemId,\r\n  requiredQuantity: number\r\n): boolean {\r\n  const available = calculateComboStock(comboItems, allProducts, branchSystemId);\r\n  return available >= requiredQuantity;\r\n}\r\n\r\n/**\r\n * Get the limiting product(s) for combo stock\r\n * Returns the product(s) that have the lowest available combo quantity\r\n */\r\nexport function getComboBottleneckProducts(\r\n  comboItems: ComboItem[],\r\n  allProducts: Product[],\r\n  branchSystemId: SystemId\r\n): Array<{ product: Product; availableForCombo: number; itemQuantity: number }> {\r\n  if (!comboItems || comboItems.length === 0) return [];\r\n  \r\n  const comboStock = calculateComboStock(comboItems, allProducts, branchSystemId);\r\n  const bottlenecks: Array<{ product: Product; availableForCombo: number; itemQuantity: number }> = [];\r\n  \r\n  for (const item of comboItems) {\r\n    const product = allProducts.find(p => p.systemId === item.productSystemId);\r\n    if (!product) continue;\r\n    \r\n    const onHand = product.inventoryByBranch?.[branchSystemId] || 0;\r\n    const committed = product.committedByBranch?.[branchSystemId] || 0;\r\n    const available = onHand - committed;\r\n    const comboQuantityFromThisProduct = Math.floor(available / item.quantity);\r\n    \r\n    // This product is a bottleneck if it limits the combo quantity\r\n    if (comboQuantityFromThisProduct === comboStock) {\r\n      bottlenecks.push({\r\n        product,\r\n        availableForCombo: comboQuantityFromThisProduct,\r\n        itemQuantity: item.quantity,\r\n      });\r\n    }\r\n  }\r\n  \r\n  return bottlenecks;\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1095, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/stock-history/store.ts"],"sourcesContent":["import { create } from 'zustand';\r\nimport { formatDate, formatDateTime, formatDateTimeSeconds, formatDateCustom, parseDate, getCurrentDate } from '@/lib/date-utils';\r\nimport type { StockHistoryEntry } from './types';\r\nimport { asSystemId } from '../../lib/id-types';\r\nimport type { SystemId } from '../../lib/id-types';\r\n// REMOVED: import { data as initialData } from './data'; // Mock data no longer used - database is source of truth\r\n\r\n// API sync helpers\r\nasync function syncToAPI(action: 'create', data: any): Promise<boolean> {\r\n  try {\r\n    const response = await fetch('/api/inventory/stock-history', {\r\n      method: 'POST',\r\n      headers: { 'Content-Type': 'application/json' },\r\n      body: JSON.stringify(data),\r\n    });\r\n    \r\n    if (!response.ok) {\r\n      console.error(`[StockHistory API] ${action} failed:`, await response.text());\r\n      return false;\r\n    }\r\n    return true;\r\n  } catch (error) {\r\n    console.error(`[StockHistory API] ${action} error:`, error);\r\n    return false;\r\n  }\r\n}\r\n\r\n// ‚ú® Migration helper: Convert SKU to systemId for old data\r\nfunction migrateHistoryData(entries: StockHistoryEntry[]): StockHistoryEntry[] {\r\n  // Map SKU ‚Üí systemId from products\r\n  const skuToSystemId: Record<string, string> = {\r\n    'DV-WEB-01': 'SP00000001',\r\n    'DV-WEB-02': 'SP00000002',\r\n    'DV-WEB-03': 'SP00000003',\r\n    'DV-MKT-01': 'SP00000004',\r\n    'DV-MKT-02': 'SP00000005',\r\n    'DV-MKT-03': 'SP00000006',\r\n    'DV-SEO-01': 'SP00000007',\r\n    'DV-SEO-02': 'SP00000008',\r\n    'DV-IT-01': 'SP00000009',\r\n    'DV-DSN-01': 'SP00000010',\r\n    'SW-CRM-01': 'SP00000011',\r\n    'SW-ERP-01': 'SP00000012',\r\n    'SW-WIN-01': 'SP00000013',\r\n    'SW-OFF-01': 'SP00000014',\r\n    'SW-ADOBE-01': 'SP00000015',\r\n    'HW-SRV-01': 'SP00000016',\r\n    'HW-SRV-02': 'SP00000017',\r\n    'HW-PC-01': 'SP00000018',\r\n    'HW-PC-02': 'SP00000019',\r\n    'HW-LT-01': 'SP00000020',\r\n    'HW-NET-01': 'SP00000021',\r\n    'HW-NET-02': 'SP00000022',\r\n    'HW-CAM-01': 'SP00000023',\r\n    'MISC-HOST-01': 'SP00000024',\r\n    'MISC-HOST-02': 'SP00000025',\r\n    'MISC-SSL-01': 'SP00000026',\r\n    'MISC-DOMAIN-COM': 'SP00000027',\r\n    'MISC-DOMAIN-VN': 'SP00000028',\r\n    'MISC-PRINT-01': 'SP00000029',\r\n    'MISC-PRINT-02': 'SP00000030',\r\n  };\r\n  \r\n  return entries.map(entry => ({\r\n    ...entry,\r\n    productId: asSystemId(skuToSystemId[entry.productId as any] || entry.productId) // Convert or keep if already systemId\r\n  }));\r\n}\r\n\r\ninterface StockHistoryState {\r\n  entries: StockHistoryEntry[];\r\n  initialized: boolean;\r\n  addEntry: (entry: Omit<StockHistoryEntry, 'systemId'>) => void;\r\n  getHistoryForProduct: (productId: SystemId, branchSystemId?: 'all' | SystemId) => StockHistoryEntry[];\r\n  loadFromAPI: () => Promise<void>;\r\n}\r\n\r\nlet entryCounter = 0;\r\n\r\nexport const useStockHistoryStore = create<StockHistoryState>()(\r\n  (set, get) => ({\r\n      entries: [], // Database is source of truth\r\n      initialized: false,\r\n      \r\n      addEntry: (entry) => {\r\n        entryCounter++;\r\n        const newEntry: StockHistoryEntry = {\r\n            ...entry,\r\n            systemId: asSystemId(`HISTORY${String(Date.now()).slice(-6)}_${entryCounter}`),\r\n        };\r\n        set((state) => ({ entries: [...state.entries, newEntry] }));\r\n        // Sync to API\r\n        syncToAPI('create', newEntry).catch(console.error);\r\n      },\r\n      \r\n      getHistoryForProduct: (productId, branchSystemId = 'all') => {\r\n          const productHistory = get().entries.filter(e => e.productId === productId);\r\n          const sortedHistory = productHistory.sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime());\r\n\r\n          if (branchSystemId === 'all') {\r\n            return sortedHistory;\r\n          }\r\n          return sortedHistory.filter(e => e.branchSystemId === branchSystemId);\r\n        },\r\n      \r\n      loadFromAPI: async () => {\r\n        try {\r\n          // NOTE: Use React Query hooks for paginated data. This only loads initial batch.\r\n          const response = await fetch('/api/inventory/stock-history?limit=30');\r\n          if (!response.ok) return;\r\n          const json = await response.json();\r\n          const apiData = json.data || [];\r\n          if (apiData.length > 0) {\r\n            set({ entries: migrateHistoryData(apiData), initialized: true });\r\n          } else {\r\n            set({ initialized: true });\r\n          }\r\n        } catch (error) {\r\n          console.error('[StockHistory API] loadFromAPI error:', error);\r\n        }\r\n      },\r\n    })\r\n);\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1217, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/customers/lifecycle-utils.ts"],"sourcesContent":["import type { Customer, CustomerLifecycleStage } from './types';\r\nimport { formatDate, formatDateTime, formatDateTimeSeconds, formatDateCustom, getCurrentDate, getDaysDiff } from '@/lib/date-utils';\r\n/**\r\n * T·ª± ƒë·ªông t√≠nh to√°n giai ƒëo·∫°n v√≤ng ƒë·ªùi kh√°ch h√†ng d·ª±a tr√™n h√†nh vi\r\n */\r\nexport const calculateLifecycleStage = (customer: Customer): CustomerLifecycleStage => {\r\n  const totalOrders = customer.totalOrders || 0;\r\n  const totalSpent = customer.totalSpent || 0;\r\n  const lastPurchaseDate = customer.lastPurchaseDate;\r\n  \r\n  // N·∫øu ch∆∞a mua l·∫ßn n√†o\r\n  if (totalOrders === 0) {\r\n    return \"Kh√°ch ti·ªÅm nƒÉng\";\r\n  }\r\n  \r\n  // T√≠nh s·ªë ng√†y t·ª´ l·∫ßn mua cu·ªëi\r\n  const daysSinceLastPurchase = lastPurchaseDate \r\n    ? getDaysDiff(getCurrentDate(), new Date(lastPurchaseDate))\r\n    : Infinity;\r\n  \r\n  // Kh√°ch ƒë√£ m·∫•t (kh√¥ng mua > 365 ng√†y)\r\n  if (daysSinceLastPurchase > 365) {\r\n    return \"M·∫•t kh√°ch\";\r\n  }\r\n  \r\n  // Kh√¥ng ho·∫°t ƒë·ªông (kh√¥ng mua > 180 ng√†y)\r\n  if (daysSinceLastPurchase > 180) {\r\n    return \"Kh√¥ng ho·∫°t ƒë·ªông\";\r\n  }\r\n  \r\n  // Kh√°ch VIP: Top 10% spending (>= 50 tri·ªáu) v√† mua >= 5 l·∫ßn\r\n  if (totalSpent >= 50_000_000 && totalOrders >= 5) {\r\n    return \"Kh√°ch VIP\";\r\n  }\r\n  \r\n  // Kh√°ch th√¢n thi·∫øt: Mua >= 5 l·∫ßn\r\n  if (totalOrders >= 5) {\r\n    return \"Kh√°ch th√¢n thi·∫øt\";\r\n  }\r\n  \r\n  // Kh√°ch quay l·∫°i: Mua 2-4 l·∫ßn\r\n  if (totalOrders >= 2) {\r\n    return \"Kh√°ch quay l·∫°i\";\r\n  }\r\n  \r\n  // Kh√°ch m·ªõi: Mua l·∫ßn ƒë·∫ßu\r\n  return \"Kh√°ch m·ªõi\";\r\n};\r\n\r\n/**\r\n * L·∫•y m√†u badge cho lifecycle stage\r\n */\r\nexport const getLifecycleStageVariant = (stage?: CustomerLifecycleStage): \r\n  'default' | 'secondary' | 'success' | 'warning' | 'destructive' => {\r\n  switch (stage) {\r\n    case \"Kh√°ch VIP\":\r\n      return \"success\";\r\n    case \"Kh√°ch th√¢n thi·∫øt\":\r\n      return \"success\";\r\n    case \"Kh√°ch quay l·∫°i\":\r\n      return \"default\";\r\n    case \"Kh√°ch m·ªõi\":\r\n      return \"secondary\";\r\n    case \"Kh√°ch ti·ªÅm nƒÉng\":\r\n      return \"secondary\";\r\n    case \"Kh√¥ng ho·∫°t ƒë·ªông\":\r\n      return \"warning\";\r\n    case \"M·∫•t kh√°ch\":\r\n      return \"destructive\";\r\n    default:\r\n      return \"secondary\";\r\n  }\r\n};\r\n\r\n/**\r\n * C·∫≠p nh·∫≠t lifecycle stage cho t·∫•t c·∫£ customers (ch·∫°y batch)\r\n */\r\nexport const updateAllCustomerLifecycleStages = (customers: Customer[]): Customer[] => {\r\n  return customers.map(customer => ({\r\n    ...customer,\r\n    lifecycleStage: calculateLifecycleStage(customer)\r\n  }));\r\n};\r\n"],"names":[],"mappings":";;;;;;;;AACA;;AAIO,MAAM,0BAA0B,CAAC;IACtC,MAAM,cAAc,SAAS,WAAW,IAAI;IAC5C,MAAM,aAAa,SAAS,UAAU,IAAI;IAC1C,MAAM,mBAAmB,SAAS,gBAAgB;IAElD,uBAAuB;IACvB,IAAI,gBAAgB,GAAG;QACrB,OAAO;IACT;IAEA,+BAA+B;IAC/B,MAAM,wBAAwB,mBAC1B,IAAA,mIAAW,EAAC,IAAA,sIAAc,KAAI,IAAI,KAAK,qBACvC;IAEJ,sCAAsC;IACtC,IAAI,wBAAwB,KAAK;QAC/B,OAAO;IACT;IAEA,yCAAyC;IACzC,IAAI,wBAAwB,KAAK;QAC/B,OAAO;IACT;IAEA,4DAA4D;IAC5D,IAAI,cAAc,cAAc,eAAe,GAAG;QAChD,OAAO;IACT;IAEA,iCAAiC;IACjC,IAAI,eAAe,GAAG;QACpB,OAAO;IACT;IAEA,8BAA8B;IAC9B,IAAI,eAAe,GAAG;QACpB,OAAO;IACT;IAEA,yBAAyB;IACzB,OAAO;AACT;AAKO,MAAM,2BAA2B,CAAC;IAEvC,OAAQ;QACN,KAAK;YACH,OAAO;QACT,KAAK;YACH,OAAO;QACT,KAAK;YACH,OAAO;QACT,KAAK;YACH,OAAO;QACT,KAAK;YACH,OAAO;QACT,KAAK;YACH,OAAO;QACT,KAAK;YACH,OAAO;QACT;YACE,OAAO;IACX;AACF;AAKO,MAAM,mCAAmC,CAAC;IAC/C,OAAO,UAAU,GAAG,CAAC,CAAA,WAAY,CAAC;YAChC,GAAG,QAAQ;YACX,gBAAgB,wBAAwB;QAC1C,CAAC;AACH"}},
    {"offset": {"line": 1290, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/customers/credit-utils.ts"],"sourcesContent":["import type { Customer } from './types';\r\n\r\nexport type CreditAlertLevel = 'safe' | 'warning' | 'danger' | 'exceeded';\r\n\r\n/**\r\n * T√≠nh m·ª©c ƒë·ªô c·∫£nh b√°o c√¥ng n·ª£\r\n */\r\nexport const getCreditAlertLevel = (customer: Customer): CreditAlertLevel => {\r\n  const currentDebt = customer.currentDebt || 0;\r\n  const maxDebt = customer.maxDebt || 0;\r\n  \r\n  // N·∫øu kh√¥ng c√≥ h·∫°n m·ª©c ho·∫∑c h·∫°n m·ª©c = 0, kh√¥ng c·∫£nh b√°o\r\n  if (maxDebt === 0) return 'safe';\r\n  \r\n  const debtRatio = (currentDebt / maxDebt) * 100;\r\n  \r\n  if (debtRatio >= 100) return 'exceeded';  // V∆∞·ª£t h·∫°n m·ª©c\r\n  if (debtRatio >= 90) return 'danger';     // >= 90%\r\n  if (debtRatio >= 70) return 'warning';    // >= 70%\r\n  return 'safe';                             // < 70%\r\n};\r\n\r\n/**\r\n * L·∫•y variant Badge cho credit alert\r\n */\r\nexport const getCreditAlertBadgeVariant = (level: CreditAlertLevel): \r\n  'default' | 'secondary' | 'success' | 'warning' | 'destructive' => {\r\n  switch (level) {\r\n    case 'exceeded':\r\n    case 'danger':\r\n      return 'destructive';\r\n    case 'warning':\r\n      return 'warning';\r\n    case 'safe':\r\n      return 'success';\r\n    default:\r\n      return 'secondary';\r\n  }\r\n};\r\n\r\n/**\r\n * L·∫•y text cho credit alert\r\n */\r\nexport const getCreditAlertText = (level: CreditAlertLevel): string => {\r\n  switch (level) {\r\n    case 'exceeded':\r\n      return 'V∆∞·ª£t h·∫°n m·ª©c';\r\n    case 'danger':\r\n      return 'S·∫Øp v∆∞·ª£t h·∫°n';\r\n    case 'warning':\r\n      return 'C·∫ßn theo d√µi';\r\n    case 'safe':\r\n      return 'An to√†n';\r\n    default:\r\n      return '';\r\n  }\r\n};\r\n\r\n/**\r\n * Ki·ªÉm tra xem c√≥ th·ªÉ t·∫°o ƒë∆°n h√†ng kh√¥ng (d·ª±a v√†o c√¥ng n·ª£)\r\n */\r\nexport const canCreateOrder = (customer: Customer, orderAmount: number): {\r\n  allowed: boolean;\r\n  reason?: string;\r\n} => {\r\n  const currentDebt = customer.currentDebt || 0;\r\n  const maxDebt = customer.maxDebt || 0;\r\n  \r\n  // N·∫øu kh√¥ng cho ph√©p c√¥ng n·ª£ v√† c√≥ c√¥ng n·ª£ hi·ªán t·∫°i\r\n  if (!customer.allowCredit && currentDebt > 0) {\r\n    return {\r\n      allowed: false,\r\n      reason: 'Kh√°ch h√†ng kh√¥ng ƒë∆∞·ª£c ph√©p c√¥ng n·ª£ v√† c√≤n n·ª£ c≈©'\r\n    };\r\n  }\r\n  \r\n  // N·∫øu c√≥ h·∫°n m·ª©c c√¥ng n·ª£\r\n  if (maxDebt > 0) {\r\n    const newDebt = currentDebt + orderAmount;\r\n    if (newDebt > maxDebt) {\r\n      return {\r\n        allowed: false,\r\n        reason: `ƒê∆°n h√†ng n√†y s·∫Ω v∆∞·ª£t h·∫°n m·ª©c c√¥ng n·ª£ (${formatCurrency(newDebt)} / ${formatCurrency(maxDebt)})`\r\n      };\r\n    }\r\n  }\r\n  \r\n  return { allowed: true };\r\n};\r\n\r\n/**\r\n * L·∫•y danh s√°ch kh√°ch h√†ng c√≥ nguy c∆° c√¥ng n·ª£ cao\r\n */\r\nexport const getHighRiskDebtCustomers = (customers: Customer[]): Customer[] => {\r\n  return customers.filter(customer => {\r\n    const level = getCreditAlertLevel(customer);\r\n    return level === 'danger' || level === 'exceeded';\r\n  }).sort((a, b) => {\r\n    const ratioA = ((a.currentDebt || 0) / (a.maxDebt || 1)) * 100;\r\n    const ratioB = ((b.currentDebt || 0) / (b.maxDebt || 1)) * 100;\r\n    return ratioB - ratioA; // Sort by ratio descending\r\n  });\r\n};\r\n\r\n/**\r\n * Helper format currency\r\n */\r\nconst formatCurrency = (value: number): string => {\r\n  return new Intl.NumberFormat('vi-VN', { \r\n    style: 'currency', \r\n    currency: 'VND' \r\n  }).format(value);\r\n};\r\n"],"names":[],"mappings":";;;;;;;;;;;;AAOO,MAAM,sBAAsB,CAAC;IAClC,MAAM,cAAc,SAAS,WAAW,IAAI;IAC5C,MAAM,UAAU,SAAS,OAAO,IAAI;IAEpC,wDAAwD;IACxD,IAAI,YAAY,GAAG,OAAO;IAE1B,MAAM,YAAY,AAAC,cAAc,UAAW;IAE5C,IAAI,aAAa,KAAK,OAAO,YAAa,eAAe;IACzD,IAAI,aAAa,IAAI,OAAO,UAAc,SAAS;IACnD,IAAI,aAAa,IAAI,OAAO,WAAc,SAAS;IACnD,OAAO,QAAoC,QAAQ;AACrD;AAKO,MAAM,6BAA6B,CAAC;IAEzC,OAAQ;QACN,KAAK;QACL,KAAK;YACH,OAAO;QACT,KAAK;YACH,OAAO;QACT,KAAK;YACH,OAAO;QACT;YACE,OAAO;IACX;AACF;AAKO,MAAM,qBAAqB,CAAC;IACjC,OAAQ;QACN,KAAK;YACH,OAAO;QACT,KAAK;YACH,OAAO;QACT,KAAK;YACH,OAAO;QACT,KAAK;YACH,OAAO;QACT;YACE,OAAO;IACX;AACF;AAKO,MAAM,iBAAiB,CAAC,UAAoB;IAIjD,MAAM,cAAc,SAAS,WAAW,IAAI;IAC5C,MAAM,UAAU,SAAS,OAAO,IAAI;IAEpC,oDAAoD;IACpD,IAAI,CAAC,SAAS,WAAW,IAAI,cAAc,GAAG;QAC5C,OAAO;YACL,SAAS;YACT,QAAQ;QACV;IACF;IAEA,yBAAyB;IACzB,IAAI,UAAU,GAAG;QACf,MAAM,UAAU,cAAc;QAC9B,IAAI,UAAU,SAAS;YACrB,OAAO;gBACL,SAAS;gBACT,QAAQ,CAAC,sCAAsC,EAAE,eAAe,SAAS,GAAG,EAAE,eAAe,SAAS,CAAC,CAAC;YAC1G;QACF;IACF;IAEA,OAAO;QAAE,SAAS;IAAK;AACzB;AAKO,MAAM,2BAA2B,CAAC;IACvC,OAAO,UAAU,MAAM,CAAC,CAAA;QACtB,MAAM,QAAQ,oBAAoB;QAClC,OAAO,UAAU,YAAY,UAAU;IACzC,GAAG,IAAI,CAAC,CAAC,GAAG;QACV,MAAM,SAAS,AAAC,CAAC,EAAE,WAAW,IAAI,CAAC,IAAI,CAAC,EAAE,OAAO,IAAI,CAAC,IAAK;QAC3D,MAAM,SAAS,AAAC,CAAC,EAAE,WAAW,IAAI,CAAC,IAAI,CAAC,EAAE,OAAO,IAAI,CAAC,IAAK;QAC3D,OAAO,SAAS,QAAQ,2BAA2B;IACrD;AACF;AAEA;;CAEC,GACD,MAAM,iBAAiB,CAAC;IACtB,OAAO,IAAI,KAAK,YAAY,CAAC,SAAS;QACpC,OAAO;QACP,UAAU;IACZ,GAAG,MAAM,CAAC;AACZ"}},
    {"offset": {"line": 1386, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/customers/intelligence-utils.ts"],"sourcesContent":["import type { Customer } from './types';\r\nimport { formatDate, formatDateTime, formatDateTimeSeconds, formatDateCustom, getCurrentDate, getDaysDiff } from '@/lib/date-utils';\r\n// RFM Score types\r\nexport type RFMScore = {\r\n  recency: 1 | 2 | 3 | 4 | 5;      // 5 = Best (mua g·∫ßn ƒë√¢y)\r\n  frequency: 1 | 2 | 3 | 4 | 5;    // 5 = Best (mua th∆∞·ªùng xuy√™n)\r\n  monetary: 1 | 2 | 3 | 4 | 5;     // 5 = Best (chi ti√™u nhi·ªÅu)\r\n};\r\n\r\n// Customer Segment based on RFM\r\nexport type CustomerSegment = \r\n  | 'Champions'           // RFM: 5-5-5, 5-4-5, 4-5-5 - Kh√°ch h√†ng t·ªët nh·∫•t\r\n  | 'Loyal Customers'     // RFM: 4-4-4, 4-5-4, 5-4-4 - Kh√°ch th√¢n thi·∫øt\r\n  | 'Potential Loyalist'  // RFM: 4-3-*, 3-4-*, 5-3-* - Ti·ªÅm nƒÉng tr·ªü th√†nh th√¢n thi·∫øt\r\n  | 'New Customers'       // RFM: 5-1-*, 4-1-* - Kh√°ch m·ªõi\r\n  | 'Promising'           // RFM: 4-2-*, 3-3-* - ƒê·∫ßy h·ª©a h·∫πn\r\n  | 'Need Attention'      // RFM: 3-2-*, 2-3-* - C·∫ßn ch√∫ √Ω\r\n  | 'About To Sleep'      // RFM: 3-1-*, 2-2-* - S·∫Øp ng·ªß ƒë√¥ng\r\n  | 'At Risk'             // RFM: 2-5-*, 2-4-*, 1-3-* - C√≥ nguy c∆°\r\n  | 'Cannot Lose Them'    // RFM: 1-5-5, 1-4-5 - Kh√¥ng th·ªÉ m·∫•t\r\n  | 'Hibernating'         // RFM: 2-1-*, 1-2-* - Ng·ªß ƒë√¥ng\r\n  | 'Lost';               // RFM: 1-1-* - ƒê√£ m·∫•t\r\n\r\n/**\r\n * T√≠nh RFM scores cho m·ªôt kh√°ch h√†ng\r\n */\r\nexport const calculateRFMScores = (customer: Customer, allCustomers: Customer[]): RFMScore => {\r\n  // Recency: S·ªë ng√†y t·ª´ l·∫ßn mua cu·ªëi\r\n  const daysSinceLastPurchase = customer.lastPurchaseDate \r\n    ? getDaysDiff(getCurrentDate(), new Date(customer.lastPurchaseDate))\r\n    : 999999;\r\n  \r\n  // Frequency: T·ªïng s·ªë ƒë∆°n h√†ng\r\n  const frequency = customer.totalOrders || 0;\r\n  \r\n  // Monetary: T·ªïng chi ti√™u\r\n  const monetary = customer.totalSpent || 0;\r\n\r\n  // Calculate percentiles for scoring\r\n  const allRecencies = allCustomers.map(c => \r\n    c.lastPurchaseDate ? getDaysDiff(getCurrentDate(), new Date(c.lastPurchaseDate)) : 999999\r\n  ).sort((a, b) => a - b);\r\n  \r\n  const allFrequencies = allCustomers.map(c => c.totalOrders || 0).sort((a, b) => b - a);\r\n  const allMonetary = allCustomers.map(c => c.totalSpent || 0).sort((a, b) => b - a);\r\n\r\n  // Score Recency (lower is better, so invert)\r\n  const recencyScore = getScore(daysSinceLastPurchase, allRecencies, true) as RFMScore['recency'];\r\n  \r\n  // Score Frequency (higher is better)\r\n  const frequencyScore = getScore(frequency, allFrequencies, false) as RFMScore['frequency'];\r\n  \r\n  // Score Monetary (higher is better)\r\n  const monetaryScore = getScore(monetary, allMonetary, false) as RFMScore['monetary'];\r\n\r\n  return {\r\n    recency: recencyScore,\r\n    frequency: frequencyScore,\r\n    monetary: monetaryScore\r\n  };\r\n};\r\n\r\n/**\r\n * Helper: T√≠nh score 1-5 d·ª±a tr√™n percentile\r\n */\r\nconst getScore = (value: number, sortedValues: number[], invert: boolean): 1 | 2 | 3 | 4 | 5 => {\r\n  const index = sortedValues.indexOf(value);\r\n  if (index === -1) return 1;\r\n  \r\n  const percentile = (index / sortedValues.length) * 100;\r\n  \r\n  let score: number;\r\n  if (percentile >= 80) score = 5;\r\n  else if (percentile >= 60) score = 4;\r\n  else if (percentile >= 40) score = 3;\r\n  else if (percentile >= 20) score = 2;\r\n  else score = 1;\r\n  \r\n  // Invert for recency (lower days = better)\r\n  if (invert) {\r\n    score = 6 - score;\r\n  }\r\n  \r\n  return score as 1 | 2 | 3 | 4 | 5;\r\n};\r\n\r\n/**\r\n * Ph√¢n lo·∫°i segment d·ª±a tr√™n RFM scores\r\n */\r\nexport const getCustomerSegment = (rfm: RFMScore): CustomerSegment => {\r\n  const { recency: R, frequency: F, monetary: M } = rfm;\r\n  \r\n  // Champions: RFM 5-5-5, 5-4-5, 4-5-5, 5-5-4\r\n  if ((R >= 4 && F >= 4 && M >= 4) && (R === 5 || F === 5)) {\r\n    return 'Champions';\r\n  }\r\n  \r\n  // Loyal Customers: RFM 4-4-4, 4-5-4, 5-4-4, 4-4-5\r\n  if (R >= 4 && F >= 4 && M >= 4) {\r\n    return 'Loyal Customers';\r\n  }\r\n  \r\n  // Potential Loyalist: High frequency, good recency\r\n  if (R >= 3 && F >= 3 && M >= 3) {\r\n    return 'Potential Loyalist';\r\n  }\r\n  \r\n  // New Customers: High recency, low frequency\r\n  if (R >= 4 && F <= 2) {\r\n    return 'New Customers';\r\n  }\r\n  \r\n  // Promising: Good recency, moderate frequency\r\n  if (R >= 3 && F >= 2 && F <= 3) {\r\n    return 'Promising';\r\n  }\r\n  \r\n  // Need Attention: Moderate scores\r\n  if (R === 3 && F === 2) {\r\n    return 'Need Attention';\r\n  }\r\n  \r\n  // About To Sleep: Low frequency, moderate recency\r\n  if ((R === 3 || R === 2) && F <= 2) {\r\n    return 'About To Sleep';\r\n  }\r\n  \r\n  // Cannot Lose Them: Low recency but high value\r\n  if (R === 1 && F >= 4 && M >= 4) {\r\n    return 'Cannot Lose Them';\r\n  }\r\n  \r\n  // At Risk: Low recency, good history\r\n  if (R <= 2 && F >= 3) {\r\n    return 'At Risk';\r\n  }\r\n  \r\n  // Hibernating: Low recency and frequency\r\n  if (R <= 2 && F <= 2 && M >= 2) {\r\n    return 'Hibernating';\r\n  }\r\n  \r\n  // Lost: Lowest scores\r\n  return 'Lost';\r\n};\r\n\r\n/**\r\n * L·∫•y m√†u badge cho segment\r\n */\r\nexport const getSegmentBadgeVariant = (segment: CustomerSegment): \r\n  'default' | 'secondary' | 'success' | 'warning' | 'destructive' => {\r\n  switch (segment) {\r\n    case 'Champions':\r\n    case 'Loyal Customers':\r\n      return 'success';\r\n    case 'Potential Loyalist':\r\n    case 'Promising':\r\n      return 'default';\r\n    case 'New Customers':\r\n      return 'secondary';\r\n    case 'Need Attention':\r\n    case 'About To Sleep':\r\n      return 'warning';\r\n    case 'At Risk':\r\n    case 'Cannot Lose Them':\r\n    case 'Hibernating':\r\n    case 'Lost':\r\n      return 'destructive';\r\n    default:\r\n      return 'secondary';\r\n  }\r\n};\r\n\r\n/**\r\n * D·ªãch segment sang ti·∫øng Vi·ªát\r\n */\r\nexport const getSegmentLabel = (segment: CustomerSegment): string => {\r\n  const labels: Record<CustomerSegment, string> = {\r\n    'Champions': 'Xu·∫•t s·∫Øc',\r\n    'Loyal Customers': 'Trung th√†nh',\r\n    'Potential Loyalist': 'Ti·ªÅm nƒÉng cao',\r\n    'New Customers': 'Kh√°ch m·ªõi',\r\n    'Promising': 'H·ª©a h·∫πn',\r\n    'Need Attention': 'C·∫ßn quan t√¢m',\r\n    'About To Sleep': 'S·∫Øp ng·ªß ƒë√¥ng',\r\n    'At Risk': 'C√≥ nguy c∆°',\r\n    'Cannot Lose Them': 'Kh√¥ng th·ªÉ m·∫•t',\r\n    'Hibernating': 'Ng·ªß ƒë√¥ng',\r\n    'Lost': 'ƒê√£ m·∫•t'\r\n  };\r\n  return labels[segment];\r\n};\r\n\r\n/**\r\n * T√≠nh Customer Health Score (0-100)\r\n * D·ª±a tr√™n 4 y·∫øu t·ªë: Recency, Frequency, Monetary, Payment Behavior\r\n */\r\nexport const calculateHealthScore = (customer: Customer): number => {\r\n  let score = 0;\r\n  \r\n  // 1. Recency - Th·ªùi gian mua g·∫ßn nh·∫•t (30 points)\r\n  const daysSinceLastPurchase = customer.lastPurchaseDate \r\n    ? getDaysDiff(getCurrentDate(), new Date(customer.lastPurchaseDate))\r\n    : Infinity;\r\n    \r\n  if (daysSinceLastPurchase <= 7) score += 30;\r\n  else if (daysSinceLastPurchase <= 30) score += 25;\r\n  else if (daysSinceLastPurchase <= 60) score += 20;\r\n  else if (daysSinceLastPurchase <= 90) score += 15;\r\n  else if (daysSinceLastPurchase <= 180) score += 10;\r\n  else if (daysSinceLastPurchase <= 365) score += 5;\r\n  \r\n  // 2. Frequency - T·∫ßn su·∫•t mua (25 points)\r\n  const totalOrders = customer.totalOrders || 0;\r\n  if (totalOrders >= 20) score += 25;\r\n  else if (totalOrders >= 10) score += 20;\r\n  else if (totalOrders >= 5) score += 15;\r\n  else if (totalOrders >= 3) score += 10;\r\n  else if (totalOrders >= 1) score += 5;\r\n  \r\n  // 3. Monetary - T·ªïng chi ti√™u (30 points)\r\n  const totalSpent = customer.totalSpent || 0;\r\n  if (totalSpent >= 500_000_000) score += 30;\r\n  else if (totalSpent >= 200_000_000) score += 25;\r\n  else if (totalSpent >= 100_000_000) score += 20;\r\n  else if (totalSpent >= 50_000_000) score += 15;\r\n  else if (totalSpent >= 20_000_000) score += 10;\r\n  else if (totalSpent >= 5_000_000) score += 5;\r\n  \r\n  // 4. Payment Behavior - H√†nh vi thanh to√°n (15 points)\r\n  // D·ª±a tr√™n t·ª∑ l·ªá n·ª£ hi·ªán t·∫°i so v·ªõi h·∫°n m·ª©c\r\n  if (customer.maxDebt && customer.maxDebt > 0) {\r\n    const debtRatio = (customer.currentDebt || 0) / customer.maxDebt;\r\n    if (debtRatio <= 0.2) score += 15;\r\n    else if (debtRatio <= 0.4) score += 12;\r\n    else if (debtRatio <= 0.6) score += 8;\r\n    else if (debtRatio <= 0.8) score += 4;\r\n    // > 80% = 0 ƒëi·ªÉm\r\n  } else {\r\n    // Kh√¥ng c√≥ h·∫°n m·ª©c c√¥ng n·ª£ ‚Üí xem nh∆∞ thanh to√°n t·ªët\r\n    score += 15;\r\n  }\r\n  \r\n  return Math.min(100, score);\r\n};\r\n\r\n/**\r\n * L·∫•y health score level\r\n */\r\nexport const getHealthScoreLevel = (score: number): {\r\n  level: 'excellent' | 'good' | 'fair' | 'poor' | 'critical';\r\n  label: string;\r\n  variant: 'success' | 'default' | 'warning' | 'destructive';\r\n} => {\r\n  if (score >= 80) return { level: 'excellent', label: 'Xu·∫•t s·∫Øc', variant: 'success' };\r\n  if (score >= 60) return { level: 'good', label: 'T·ªët', variant: 'default' };\r\n  if (score >= 40) return { level: 'fair', label: 'Trung b√¨nh', variant: 'warning' };\r\n  if (score >= 20) return { level: 'poor', label: 'Y·∫øu', variant: 'destructive' };\r\n  return { level: 'critical', label: 'Nguy hi·ªÉm', variant: 'destructive' };\r\n};\r\n\r\n/**\r\n * D·ª± ƒëo√°n Churn Risk\r\n */\r\nexport const calculateChurnRisk = (customer: Customer): {\r\n  risk: 'low' | 'medium' | 'high';\r\n  label: string;\r\n  variant: 'success' | 'warning' | 'destructive';\r\n  reason: string;\r\n} => {\r\n  const daysSinceLastPurchase = customer.lastPurchaseDate \r\n    ? getDaysDiff(getCurrentDate(), new Date(customer.lastPurchaseDate))\r\n    : Infinity;\r\n  \r\n  const totalOrders = customer.totalOrders || 0;\r\n  \r\n  // N·∫øu kh√°ch m·ªõi (ch∆∞a c√≥ ƒë∆°n ho·∫∑c ch·ªâ 1 ƒë∆°n), d√πng default 30 ng√†y\r\n  // N·∫øu kh√°ch c≈©, t√≠nh d·ª±a tr√™n th·ªùi gian t·ª´ createdAt ƒë·∫øn lastPurchaseDate / s·ªë ƒë∆°n\r\n  let avgDaysBetweenOrders = 30; // Default\r\n  if (totalOrders > 1 && customer.createdAt && customer.lastPurchaseDate) {\r\n    const customerAge = getDaysDiff(new Date(customer.lastPurchaseDate), new Date(customer.createdAt));\r\n    avgDaysBetweenOrders = Math.max(7, customerAge / (totalOrders - 1)); // T·ªëi thi·ªÉu 7 ng√†y\r\n  }\r\n  \r\n  // Kh√°ch v·ª´a mua h√†ng g·∫ßn ƒë√¢y (< 7 ng√†y) = low risk\r\n  if (daysSinceLastPurchase <= 7) {\r\n    return {\r\n      risk: 'low',\r\n      label: 'Nguy c∆° th·∫•p',\r\n      variant: 'success',\r\n      reason: 'Kh√°ch h√†ng ƒëang ho·∫°t ƒë·ªông t·ªët'\r\n    };\r\n  }\r\n  \r\n  // High risk: Kh√¥ng mua > 2x th·ªùi gian trung b√¨nh ho·∫∑c > 365 ng√†y\r\n  if (daysSinceLastPurchase > avgDaysBetweenOrders * 2 || daysSinceLastPurchase > 365) {\r\n    return {\r\n      risk: 'high',\r\n      label: 'Nguy c∆° cao',\r\n      variant: 'destructive',\r\n      reason: `Kh√¥ng mua h√†ng ${Math.floor(daysSinceLastPurchase)} ng√†y, v∆∞·ª£t qu√° 2x chu k·ª≥ trung b√¨nh`\r\n    };\r\n  }\r\n  \r\n  // Medium risk: Kh√¥ng mua > 1.5x th·ªùi gian trung b√¨nh ho·∫∑c > 180 ng√†y\r\n  if (daysSinceLastPurchase > avgDaysBetweenOrders * 1.5 || daysSinceLastPurchase > 180) {\r\n    return {\r\n      risk: 'medium',\r\n      label: 'Nguy c∆° trung b√¨nh',\r\n      variant: 'warning',\r\n      reason: `Kh√¥ng mua h√†ng ${Math.floor(daysSinceLastPurchase)} ng√†y, ƒëang gi·∫£m t·∫ßn su·∫•t`\r\n    };\r\n  }\r\n  \r\n  // Low risk\r\n  return {\r\n    risk: 'low',\r\n    label: 'Nguy c∆° th·∫•p',\r\n    variant: 'success',\r\n    reason: 'Kh√°ch h√†ng ƒëang ho·∫°t ƒë·ªông t·ªët'\r\n  };\r\n};\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1644, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/customers/debt-tracking-utils.ts"],"sourcesContent":["import type { Customer, DebtStatus, DebtTransaction } from './types';\r\nimport { formatDate, formatDateTime, formatDateTimeSeconds, formatDateCustom, getCurrentDate, addDays, getDaysDiff, isDateBefore, toISODate } from '@/lib/date-utils';\r\n/**\r\n * T√≠nh ng√†y ƒë·∫øn h·∫°n d·ª±a tr√™n ng√†y ƒë∆°n h√†ng v√† payment terms\r\n */\r\nexport const calculateDueDate = (orderDate: string, paymentTermsDays: number): string => {\r\n  return toISODate(addDays(new Date(orderDate), paymentTermsDays));\r\n};\r\n\r\n/**\r\n * Parse payment terms string th√†nh s·ªë ng√†y\r\n * \"NET30\" ‚Üí 30, \"NET15\" ‚Üí 15, \"COD\" ‚Üí 0\r\n */\r\nexport const parsePaymentTerms = (paymentTerms?: string): number => {\r\n  if (!paymentTerms) return 0;\r\n  \r\n  const match = paymentTerms.match(/NET(\\d+)/i);\r\n  if (match) {\r\n    return parseInt(match[1], 10);\r\n  }\r\n  \r\n  if (paymentTerms.toUpperCase() === 'COD') {\r\n    return 0; // COD = thanh to√°n ngay\r\n  }\r\n  \r\n  return 30; // Default 30 ng√†y\r\n};\r\n\r\n/**\r\n * T√≠nh s·ªë ng√†y qu√° h·∫°n (n·∫øu > 0 th√¨ qu√° h·∫°n)\r\n */\r\nexport const calculateDaysOverdue = (dueDate: string): number => {\r\n  const days = getDaysDiff(getCurrentDate(), new Date(dueDate));\r\n  return days > 0 ? days : 0;\r\n};\r\n\r\n/**\r\n * T√≠nh s·ªë ng√†y c√≤n l·∫°i ƒë·∫øn h·∫°n (n·∫øu > 0 th√¨ ch∆∞a ƒë·∫øn h·∫°n)\r\n */\r\nexport const calculateDaysUntilDue = (dueDate: string): number => {\r\n  return getDaysDiff(new Date(dueDate), getCurrentDate());\r\n};\r\n\r\n/**\r\n * Ph√¢n lo·∫°i tr·∫°ng th√°i c√¥ng n·ª£ d·ª±a tr√™n ng√†y ƒë·∫øn h·∫°n\r\n */\r\nexport const getDebtStatus = (dueDate: string, hasDebt: boolean): DebtStatus | null => {\r\n  if (!hasDebt) return null;\r\n  \r\n  const daysUntilDue = calculateDaysUntilDue(dueDate);\r\n  \r\n  // Ch∆∞a ƒë·∫øn h·∫°n\r\n  if (daysUntilDue > 3) return \"Ch∆∞a ƒë·∫øn h·∫°n\";\r\n  \r\n  // S·∫Øp ƒë·∫øn h·∫°n (1-3 ng√†y)\r\n  if (daysUntilDue >= 1 && daysUntilDue <= 3) return \"S·∫Øp ƒë·∫øn h·∫°n\";\r\n  \r\n  // ƒê·∫øn h·∫°n h√¥m nay\r\n  if (daysUntilDue === 0) return \"ƒê·∫øn h·∫°n h√¥m nay\";\r\n  \r\n  // Qu√° h·∫°n\r\n  const daysOverdue = Math.abs(daysUntilDue);\r\n  \r\n  if (daysOverdue >= 1 && daysOverdue <= 7) return \"Qu√° h·∫°n 1-7 ng√†y\";\r\n  if (daysOverdue >= 8 && daysOverdue <= 15) return \"Qu√° h·∫°n 8-15 ng√†y\";\r\n  if (daysOverdue >= 16 && daysOverdue <= 30) return \"Qu√° h·∫°n 16-30 ng√†y\";\r\n  \r\n  return \"Qu√° h·∫°n > 30 ng√†y\";\r\n};\r\n\r\n/**\r\n * L·∫•y variant cho badge tr·∫°ng th√°i c√¥ng n·ª£\r\n */\r\nexport const getDebtStatusVariant = (status?: DebtStatus | null): \r\n  'default' | 'secondary' | 'success' | 'warning' | 'destructive' => {\r\n  if (!status) return 'secondary';\r\n  \r\n  switch (status) {\r\n    case \"Ch∆∞a ƒë·∫øn h·∫°n\":\r\n      return \"secondary\";\r\n    case \"S·∫Øp ƒë·∫øn h·∫°n\":\r\n      return \"default\";\r\n    case \"ƒê·∫øn h·∫°n h√¥m nay\":\r\n      return \"warning\";\r\n    case \"Qu√° h·∫°n 1-7 ng√†y\":\r\n      return \"warning\";\r\n    case \"Qu√° h·∫°n 8-15 ng√†y\":\r\n    case \"Qu√° h·∫°n 16-30 ng√†y\":\r\n    case \"Qu√° h·∫°n > 30 ng√†y\":\r\n      return \"destructive\";\r\n    default:\r\n      return \"secondary\";\r\n  }\r\n};\r\n\r\n/**\r\n * T√≠nh to√°n debt tracking info cho customer\r\n */\r\nexport const calculateDebtTrackingInfo = (customer: Customer): {\r\n  oldestDebtDueDate?: string;\r\n  maxDaysOverdue: number;\r\n  debtStatus?: DebtStatus | null;\r\n} => {\r\n  const debtTransactions = customer.debtTransactions || [];\r\n  const unpaidTransactions = debtTransactions.filter(t => !t.isPaid);\r\n  \r\n  if (unpaidTransactions.length === 0 || !customer.currentDebt || customer.currentDebt === 0) {\r\n    return {\r\n      maxDaysOverdue: 0,\r\n      debtStatus: null\r\n    };\r\n  }\r\n  \r\n  // T√¨m giao d·ªãch c√≥ dueDate s·ªõm nh·∫•t (n·ª£ l√¢u nh·∫•t)\r\n  const oldestTransaction = unpaidTransactions.reduce((oldest, current) => {\r\n    return isDateBefore(new Date(current.dueDate), new Date(oldest.dueDate)) ? current : oldest;\r\n  });\r\n  \r\n  const oldestDebtDueDate = oldestTransaction.dueDate;\r\n  const maxDaysOverdue = calculateDaysOverdue(oldestDebtDueDate);\r\n  const debtStatus = getDebtStatus(oldestDebtDueDate, true);\r\n  \r\n  return {\r\n    oldestDebtDueDate,\r\n    maxDaysOverdue,\r\n    debtStatus\r\n  };\r\n};\r\n\r\n/**\r\n * L·∫•y danh s√°ch kh√°ch h√†ng c√≥ n·ª£ qu√° h·∫°n, s·∫Øp x·∫øp theo m·ª©c ƒë·ªô ∆∞u ti√™n\r\n */\r\nexport const getOverdueDebtCustomers = (customers: Customer[]): Customer[] => {\r\n  return customers\r\n    .filter(c => {\r\n      const info = calculateDebtTrackingInfo(c);\r\n      return info.maxDaysOverdue > 0; // Ch·ªâ l·∫•y KH qu√° h·∫°n\r\n    })\r\n    .sort((a, b) => {\r\n      const infoA = calculateDebtTrackingInfo(a);\r\n      const infoB = calculateDebtTrackingInfo(b);\r\n      \r\n      // S·∫Øp x·∫øp theo s·ªë ng√†y qu√° h·∫°n (gi·∫£m d·∫ßn)\r\n      return (infoB.maxDaysOverdue || 0) - (infoA.maxDaysOverdue || 0);\r\n    });\r\n};\r\n\r\n/**\r\n * L·∫•y danh s√°ch kh√°ch h√†ng s·∫Øp ƒë·∫øn h·∫°n thanh to√°n (1-3 ng√†y)\r\n */\r\nexport const getDueSoonCustomers = (customers: Customer[]): Customer[] => {\r\n  return customers\r\n    .filter(c => {\r\n      const info = calculateDebtTrackingInfo(c);\r\n      if (!info.oldestDebtDueDate) return false;\r\n      \r\n      const daysUntil = calculateDaysUntilDue(info.oldestDebtDueDate);\r\n      return daysUntil >= 1 && daysUntil <= 3;\r\n    })\r\n    .sort((a, b) => {\r\n      const infoA = calculateDebtTrackingInfo(a);\r\n      const infoB = calculateDebtTrackingInfo(b);\r\n      \r\n      const daysA = infoA.oldestDebtDueDate ? calculateDaysUntilDue(infoA.oldestDebtDueDate) : 999;\r\n      const daysB = infoB.oldestDebtDueDate ? calculateDaysUntilDue(infoB.oldestDebtDueDate) : 999;\r\n      \r\n      return daysA - daysB; // S·∫Øp x·∫øp theo ng√†y ƒë·∫øn h·∫°n (tƒÉng d·∫ßn)\r\n    });\r\n};\r\n\r\n/**\r\n * T√≠nh t·ªïng c√¥ng n·ª£ qu√° h·∫°n\r\n */\r\nexport const calculateTotalOverdueDebt = (customers: Customer[]): number => {\r\n  return getOverdueDebtCustomers(customers).reduce((sum, c) => sum + (c.currentDebt || 0), 0);\r\n};\r\n\r\n/**\r\n * T√≠nh t·ªïng c√¥ng n·ª£ s·∫Øp ƒë·∫øn h·∫°n\r\n */\r\nexport const calculateTotalDueSoonDebt = (customers: Customer[]): number => {\r\n  return getDueSoonCustomers(customers).reduce((sum, c) => sum + (c.currentDebt || 0), 0);\r\n};\r\n\r\n/**\r\n * Format ng√†y hi·ªÉn th·ªã\r\n */\r\nexport const formatDebtDate = (dateString?: string): string => {\r\n  if (!dateString) return '-';\r\n  return formatDate(dateString);\r\n};\r\n\r\n/**\r\n * Helper format currency\r\n */\r\nexport const formatCurrency = (value?: number): string => {\r\n  if (typeof value !== 'number') return '0 ‚Ç´';\r\n  return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(value);\r\n};\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1798, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/customers/store.ts"],"sourcesContent":["import { create } from 'zustand';\r\nimport { createCrudStore, CrudState } from '../../lib/store-factory';\r\n// REMOVED: import { data as initialData } from './data'; // Mock data no longer used - database is source of truth\r\nimport type { Customer } from './types';\r\nimport { SystemId, BusinessId } from '../../lib/id-types';\r\nimport { calculateLifecycleStage } from './lifecycle-utils';\r\nimport { getHighRiskDebtCustomers } from './credit-utils';\r\nimport { \r\n  calculateRFMScores, \r\n  getCustomerSegment, \r\n  calculateHealthScore,\r\n  calculateChurnRisk \r\n} from './intelligence-utils';\r\nimport { getOverdueDebtCustomers, getDueSoonCustomers } from './debt-tracking-utils';\r\nimport Fuse from 'fuse.js';\r\nimport { getCurrentUserSystemId } from '../../contexts/auth-context';\r\nimport {\r\n  getCurrentUserInfo,\r\n  createCreatedEntry,\r\n  createUpdatedEntry,\r\n  createStatusChangedEntry,\r\n  appendHistoryEntry,\r\n  type HistoryEntry\r\n} from '../../lib/activity-history-helper';\r\n\r\nconst baseStore = createCrudStore<Customer>([], 'customers', {\r\n  businessIdField: 'id',\r\n  getCurrentUser: getCurrentUserSystemId, // Track who creates/updates\r\n  apiEndpoint: '/api/customers',\r\n});\r\n\r\n// ‚úÖ API Sync helpers\r\nconst API_ENDPOINT = '/api/customers';\r\n\r\nconst syncToApi = {\r\n  create: async (customer: Customer) => {\r\n    try {\r\n      const response = await fetch(API_ENDPOINT, {\r\n        method: 'POST',\r\n        credentials: 'include',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify(customer),\r\n      });\r\n      if (!response.ok) console.warn('[Customer API] Create sync failed');\r\n      else console.log('[Customer API] Created:', customer.systemId);\r\n    } catch (e) {\r\n      console.warn('[Customer API] Create sync error:', e);\r\n    }\r\n  },\r\n  update: async (systemId: SystemId, updates: Partial<Customer>) => {\r\n    try {\r\n      const response = await fetch(`${API_ENDPOINT}/${systemId}`, {\r\n        method: 'PATCH',\r\n        credentials: 'include',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify(updates),\r\n      });\r\n      if (!response.ok) console.warn('[Customer API] Update sync failed');\r\n      else console.log('[Customer API] Updated:', systemId);\r\n    } catch (e) {\r\n      console.warn('[Customer API] Update sync error:', e);\r\n    }\r\n  },\r\n  delete: async (systemId: SystemId, hard = false) => {\r\n    try {\r\n      const response = await fetch(`${API_ENDPOINT}/${systemId}`, {\r\n        method: 'DELETE',\r\n        credentials: 'include',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({ hard }),\r\n      });\r\n      if (!response.ok) console.warn('[Customer API] Delete sync failed');\r\n      else console.log('[Customer API] Deleted:', systemId);\r\n    } catch (e) {\r\n      console.warn('[Customer API] Delete sync error:', e);\r\n    }\r\n  },\r\n  restore: async (systemId: SystemId) => {\r\n    try {\r\n      const response = await fetch(`${API_ENDPOINT}/${systemId}/restore`, {\r\n        method: 'POST',\r\n        credentials: 'include',\r\n        headers: { 'Content-Type': 'application/json' },\r\n      });\r\n      if (!response.ok) console.warn('[Customer API] Restore sync failed');\r\n      else console.log('[Customer API] Restored:', systemId);\r\n    } catch (e) {\r\n      console.warn('[Customer API] Restore sync error:', e);\r\n    }\r\n  },\r\n};\r\n\r\n// ‚úÖ Wrap base store methods with API sync\r\nconst originalAdd = baseStore.getState().add;\r\nconst originalUpdate = baseStore.getState().update;\r\nconst originalRemove = baseStore.getState().remove;\r\nconst originalHardDelete = baseStore.getState().hardDelete;\r\nconst originalRestore = baseStore.getState().restore;\r\n\r\nbaseStore.setState({\r\n  add: (item: Omit<Customer, 'systemId'>) => {\r\n    const result = originalAdd(item);\r\n    syncToApi.create(result);\r\n    return result;\r\n  },\r\n  update: (systemId: SystemId, updates: Partial<Customer>) => {\r\n    originalUpdate(systemId, updates);\r\n    syncToApi.update(systemId, updates);\r\n  },\r\n  remove: (systemId: SystemId) => {\r\n    originalRemove(systemId);\r\n    syncToApi.delete(systemId, false);\r\n  },\r\n  hardDelete: (systemId: SystemId) => {\r\n    originalHardDelete(systemId);\r\n    syncToApi.delete(systemId, true);\r\n  },\r\n  restore: (systemId: SystemId) => {\r\n    originalRestore(systemId);\r\n    syncToApi.restore(systemId);\r\n  },\r\n});\r\n\r\n// Define enhanced interface\r\ninterface CustomerStoreState extends CrudState<Customer> {\r\n  searchCustomers: (query: string, page: number, limit?: number) => Promise<{ items: { value: string; label: string }[], hasNextPage: boolean }>;\r\n  updateDebt: (systemId: SystemId, amountChange: number) => void;\r\n  incrementOrderStats: (systemId: SystemId, orderValue: number) => void;\r\n  decrementOrderStats: (systemId: SystemId, orderValue: number) => void;\r\n  incrementReturnStats: (systemId: SystemId, quantity: number) => void;\r\n  incrementFailedDeliveryStats: (systemId: SystemId) => void;\r\n  addDebtTransaction: (systemId: SystemId, transaction: import('./types').DebtTransaction) => void;\r\n  addDebtReminder: (systemId: SystemId, reminder: import('./types').DebtReminder) => void;\r\n  updateDebtReminder: (systemId: SystemId, reminderId: SystemId, updates: Partial<import('./types').DebtReminder>) => void;\r\n  removeDebtReminder: (systemId: SystemId, reminderId: SystemId) => void;\r\n  updateDebtTransactionPayment: (systemId: SystemId, orderId: BusinessId, amountPaid: number) => void;\r\n  removeDebtTransaction: (systemId: SystemId, orderId: BusinessId) => void;\r\n  getHighRiskDebtCustomers: () => Customer[];\r\n  updateCustomerIntelligence: () => void; // Batch update RFM, health score, churn risk\r\n  getCustomersBySegment: (segment: string) => Customer[];\r\n  getOverdueDebtCustomers: () => Customer[];\r\n  getDueSoonCustomers: () => Customer[];\r\n    removeMany: (systemIds: SystemId[]) => void;\r\n    updateManyStatus: (systemIds: SystemId[], status: Customer['status']) => void;\r\n    restoreMany: (systemIds: SystemId[]) => void;\r\n}\r\n\r\n// Augmented methods\r\nconst augmentedMethods = {\r\n    searchCustomers: async (query: string, page: number, limit: number = 20) => {\r\n        return new Promise<{ items: { value: string; label: string }[], hasNextPage: boolean }>(resolve => {\r\n            setTimeout(() => {\r\n                const allCustomers = baseStore.getState().data;\r\n                \r\n                // Create fresh Fuse instance with current data (avoid stale data)\r\n                const fuse = new Fuse(allCustomers, {\r\n                    keys: ['name', 'id', 'phone'],\r\n                    threshold: 0.3,\r\n                });\r\n                \r\n                const results = query ? fuse.search(query).map(r => r.item) : allCustomers;\r\n                \r\n                const start = (page - 1) * limit;\r\n                const end = start + limit;\r\n                const paginatedItems = results.slice(start, end);\r\n\r\n                resolve({\r\n                    items: paginatedItems.map(c => ({ value: c.systemId, label: c.name })),\r\n                    hasNextPage: end < results.length,\r\n                });\r\n            }, 300);\r\n        });\r\n    },\r\n    updateDebt: (systemId: SystemId, amountChange: number) => {\r\n        baseStore.setState(state => ({\r\n            data: state.data.map(customer => {\r\n                if (customer.systemId === systemId) {\r\n                    const newDebt = (customer.currentDebt || 0) + amountChange;\r\n                    // Sync to API\r\n                    syncToApi.update(systemId, { currentDebt: newDebt });\r\n                    return {\r\n                        ...customer,\r\n                        currentDebt: newDebt,\r\n                    };\r\n                }\r\n                return customer;\r\n            })\r\n        }));\r\n    },\r\n    incrementOrderStats: (systemId: SystemId, orderValue: number) => {\r\n        const allCustomers = baseStore.getState().getActive();\r\n        \r\n        baseStore.setState(state => ({\r\n            data: state.data.map(customer => {\r\n                if (customer.systemId === systemId) {\r\n                    const updatedCustomer = {\r\n                        ...customer,\r\n                        totalOrders: (customer.totalOrders || 0) + 1,\r\n                        totalSpent: (customer.totalSpent || 0) + orderValue,\r\n                        lastPurchaseDate: new Date().toISOString().split('T')[0],\r\n                    };\r\n                    \r\n                    // Auto-update intelligence after order stats change\r\n                    const rfmScores = calculateRFMScores(updatedCustomer, allCustomers);\r\n                    const segment = getCustomerSegment(rfmScores);\r\n                    const healthScore = calculateHealthScore(updatedCustomer);\r\n                    const churnRisk = calculateChurnRisk(updatedCustomer).risk;\r\n                    const lifecycleStage = calculateLifecycleStage(updatedCustomer);\r\n                    \r\n                    return {\r\n                        ...updatedCustomer,\r\n                        rfmScores,\r\n                        segment,\r\n                        healthScore,\r\n                        churnRisk,\r\n                        lifecycleStage,\r\n                    };\r\n                }\r\n                return customer;\r\n            })\r\n        }));\r\n    },\r\n    decrementOrderStats: (systemId: SystemId, orderValue: number) => {\r\n        const allCustomers = baseStore.getState().getActive();\r\n        \r\n        baseStore.setState(state => ({\r\n            data: state.data.map(customer => {\r\n                if (customer.systemId === systemId) {\r\n                    const updatedCustomer = {\r\n                        ...customer,\r\n                        totalOrders: Math.max(0, (customer.totalOrders || 0) - 1),\r\n                        totalSpent: Math.max(0, (customer.totalSpent || 0) - orderValue),\r\n                    };\r\n                    \r\n                    // Auto-update intelligence after order stats change\r\n                    const rfmScores = calculateRFMScores(updatedCustomer, allCustomers);\r\n                    const segment = getCustomerSegment(rfmScores);\r\n                    const healthScore = calculateHealthScore(updatedCustomer);\r\n                    const churnRisk = calculateChurnRisk(updatedCustomer).risk;\r\n                    const lifecycleStage = calculateLifecycleStage(updatedCustomer);\r\n                    \r\n                    return {\r\n                        ...updatedCustomer,\r\n                        rfmScores,\r\n                        segment,\r\n                        healthScore,\r\n                        churnRisk,\r\n                        lifecycleStage,\r\n                    };\r\n                }\r\n                return customer;\r\n            })\r\n        }));\r\n    },\r\n    incrementReturnStats: (systemId: SystemId, quantity: number) => {\r\n        baseStore.setState(state => ({\r\n            data: state.data.map(customer => {\r\n                if (customer.systemId === systemId) {\r\n                    return {\r\n                        ...customer,\r\n                        totalQuantityReturned: (customer.totalQuantityReturned || 0) + quantity,\r\n                    };\r\n                }\r\n                return customer;\r\n            })\r\n        }));\r\n    },\r\n    incrementFailedDeliveryStats: (systemId: SystemId) => {\r\n        baseStore.setState(state => ({\r\n            data: state.data.map(customer => {\r\n                if (customer.systemId === systemId) {\r\n                    return {\r\n                        ...customer,\r\n                        failedDeliveries: (customer.failedDeliveries || 0) + 1,\r\n                    };\r\n                }\r\n                return customer;\r\n            })\r\n        }));\r\n    },\r\n    addDebtTransaction: (systemId: SystemId, transaction: import('./types').DebtTransaction) => {\r\n        baseStore.setState(state => ({\r\n            data: state.data.map(customer => {\r\n                if (customer.systemId === systemId) {\r\n                    const currentTransactions = customer.debtTransactions || [];\r\n                    // Avoid duplicates\r\n                    if (currentTransactions.some(t => t.orderId === transaction.orderId)) {\r\n                        return customer;\r\n                    }\r\n\r\n                    const outstandingAmount = Math.max(transaction.remainingAmount ?? transaction.amount ?? 0, 0);\r\n                    return {\r\n                        ...customer,\r\n                        currentDebt: Math.max(0, (customer.currentDebt || 0) + outstandingAmount),\r\n                        debtTransactions: [...currentTransactions, transaction],\r\n                    };\r\n                }\r\n                return customer;\r\n            })\r\n        }));\r\n    },\r\n    updateDebtTransactionPayment: (systemId: SystemId, orderId: BusinessId, amountPaid: number) => {\r\n        baseStore.setState(state => ({\r\n            data: state.data.map(customer => {\r\n                if (customer.systemId === systemId && customer.debtTransactions) {\r\n                    let debtDelta = 0;\r\n                    const updatedTransactions = customer.debtTransactions.map(t => {\r\n                        if (t.orderId !== orderId) {\r\n                            return t;\r\n                        }\r\n\r\n                        const currentPaid = t.paidAmount || 0;\r\n                        const currentRemaining = t.remainingAmount ?? Math.max(t.amount - currentPaid, 0);\r\n                        let appliedAmount = amountPaid;\r\n\r\n                        if (appliedAmount > 0) {\r\n                            appliedAmount = Math.min(appliedAmount, currentRemaining);\r\n                        } else if (appliedAmount < 0) {\r\n                            appliedAmount = Math.max(appliedAmount, -currentPaid);\r\n                        }\r\n\r\n                        const newPaidAmount = currentPaid + appliedAmount;\r\n                        const recalculatedRemaining = Math.max(t.amount - newPaidAmount, 0);\r\n                        debtDelta -= appliedAmount;\r\n\r\n                        return {\r\n                            ...t,\r\n                            paidAmount: newPaidAmount,\r\n                            remainingAmount: recalculatedRemaining,\r\n                            isPaid: recalculatedRemaining <= 0,\r\n                            paidDate: recalculatedRemaining <= 0 ? new Date().toISOString().split('T')[0] : t.paidDate,\r\n                        };\r\n                    });\r\n\r\n                    return {\r\n                        ...customer,\r\n                        currentDebt: Math.max(0, (customer.currentDebt || 0) + debtDelta),\r\n                        debtTransactions: updatedTransactions,\r\n                    };\r\n                }\r\n                return customer;\r\n            })\r\n        }));\r\n    },\r\n    removeDebtTransaction: (systemId: SystemId, orderId: BusinessId) => {\r\n        baseStore.setState(state => ({\r\n            data: state.data.map(customer => {\r\n                if (customer.systemId === systemId && customer.debtTransactions) {\r\n                    const transaction = customer.debtTransactions.find(t => t.orderId === orderId);\r\n                    const outstanding = transaction\r\n                        ? Math.max(transaction.remainingAmount ?? (transaction.amount - (transaction.paidAmount || 0)), 0)\r\n                        : 0;\r\n                    return {\r\n                        ...customer,\r\n                        currentDebt: Math.max(0, (customer.currentDebt || 0) - outstanding),\r\n                        debtTransactions: customer.debtTransactions.filter(t => t.orderId !== orderId),\r\n                    };\r\n                }\r\n                return customer;\r\n            })\r\n        }));\r\n    },\r\n    // Add debt reminder (3.3)\r\n    addDebtReminder: (systemId: SystemId, reminder: import('./types').DebtReminder) => {\r\n        baseStore.setState(state => ({\r\n            data: state.data.map(customer => {\r\n                if (customer.systemId === systemId) {\r\n                    const currentReminders = customer.debtReminders || [];\r\n                    return {\r\n                        ...customer,\r\n                        debtReminders: [...currentReminders, reminder],\r\n                    };\r\n                }\r\n                return customer;\r\n            })\r\n        }));\r\n    },\r\n    // Update debt reminder (3.3)\r\n    updateDebtReminder: (systemId: SystemId, reminderId: SystemId, updates: Partial<import('./types').DebtReminder>) => {\r\n        baseStore.setState(state => ({\r\n            data: state.data.map(customer => {\r\n                if (customer.systemId === systemId && customer.debtReminders) {\r\n                    return {\r\n                        ...customer,\r\n                        debtReminders: customer.debtReminders.map(r =>\r\n                            r.systemId === reminderId ? { ...r, ...updates } : r\r\n                        ),\r\n                    };\r\n                }\r\n                return customer;\r\n            })\r\n        }));\r\n    },\r\n    // Remove debt reminder (3.3)\r\n    removeDebtReminder: (systemId: SystemId, reminderId: SystemId) => {\r\n        baseStore.setState(state => ({\r\n            data: state.data.map(customer => {\r\n                if (customer.systemId === systemId && customer.debtReminders) {\r\n                    return {\r\n                        ...customer,\r\n                        debtReminders: customer.debtReminders.filter(r => r.systemId !== reminderId),\r\n                    };\r\n                }\r\n                return customer;\r\n            })\r\n        }));\r\n    },\r\n    // Override add to auto-calculate lifecycle stage and log activity\r\n    add: (customer: Omit<Customer, 'systemId'>) => {\r\n        const userInfo = getCurrentUserInfo();\r\n        const customerWithLifecycle = {\r\n            ...customer,\r\n            lifecycleStage: calculateLifecycleStage(customer as Customer)\r\n        };\r\n        const newCustomer = baseStore.getState().add(customerWithLifecycle);\r\n        \r\n        // Add activity history entry\r\n        const historyEntry = createCreatedEntry(\r\n            userInfo,\r\n            `${userInfo.name} ƒë√£ t·∫°o kh√°ch h√†ng ${newCustomer.name} (${newCustomer.id})`\r\n        );\r\n        baseStore.getState().update(newCustomer.systemId, {\r\n            ...newCustomer,\r\n            activityHistory: [historyEntry]\r\n        });\r\n        \r\n        return newCustomer;\r\n    },\r\n    // Override update to auto-calculate lifecycle stage and log activity\r\n    update: (systemId: SystemId, updatedCustomer: Customer) => {\r\n        console.log('[CustomerStore] update called:', { systemId, updatedCustomer });\r\n        \r\n        const userInfo = getCurrentUserInfo();\r\n        const existingCustomer = baseStore.getState().data.find(c => c.systemId === systemId);\r\n        const historyEntries: HistoryEntry[] = [];\r\n        \r\n        if (existingCustomer) {\r\n            // Track status changes\r\n            if (existingCustomer.status !== updatedCustomer.status) {\r\n                historyEntries.push(createStatusChangedEntry(\r\n                    userInfo,\r\n                    existingCustomer.status,\r\n                    updatedCustomer.status,\r\n                    `${userInfo.name} ƒë√£ ƒë·ªïi tr·∫°ng th√°i t·ª´ \"${existingCustomer.status}\" sang \"${updatedCustomer.status}\"`\r\n                ));\r\n            }\r\n            \r\n            // Track field changes\r\n            const fieldsToTrack: Array<{ key: keyof Customer; label: string }> = [\r\n                { key: 'name', label: 'T√™n kh√°ch h√†ng' },\r\n                { key: 'email', label: 'Email' },\r\n                { key: 'phone', label: 'S·ªë ƒëi·ªán tho·∫°i' },\r\n                { key: 'company', label: 'C√¥ng ty' },\r\n                { key: 'taxCode', label: 'M√£ s·ªë thu·∫ø' },\r\n                { key: 'representative', label: 'Ng∆∞·ªùi ƒë·∫°i di·ªán' },\r\n                { key: 'type', label: 'Lo·∫°i kh√°ch h√†ng' },\r\n                { key: 'customerGroup', label: 'Nh√≥m kh√°ch h√†ng' },\r\n                { key: 'lifecycleStage', label: 'Giai ƒëo·∫°n v√≤ng ƒë·ªùi' },\r\n                { key: 'maxDebt', label: 'H·∫°n m·ª©c c√¥ng n·ª£' },\r\n                { key: 'paymentTerms', label: 'ƒêi·ªÅu kho·∫£n thanh to√°n' },\r\n                { key: 'creditRating', label: 'X·∫øp h·∫°ng t√≠n d·ª•ng' },\r\n                { key: 'pricingLevel', label: 'M·ª©c gi√°' },\r\n                { key: 'defaultDiscount', label: 'Chi·∫øt kh·∫•u m·∫∑c ƒë·ªãnh' },\r\n                { key: 'accountManagerId', label: 'Nh√¢n vi√™n ph·ª• tr√°ch' },\r\n            ];\r\n            \r\n            const changes: string[] = [];\r\n            for (const field of fieldsToTrack) {\r\n                const oldVal = existingCustomer[field.key];\r\n                const newVal = updatedCustomer[field.key];\r\n                if (oldVal !== newVal && !(oldVal === undefined && newVal === undefined)) {\r\n                    // Skip if it's the status field (already tracked above)\r\n                    if (field.key === 'status') continue;\r\n                    const oldDisplay = oldVal !== undefined && oldVal !== null && oldVal !== '' ? String(oldVal) : '(tr·ªëng)';\r\n                    const newDisplay = newVal !== undefined && newVal !== null && newVal !== '' ? String(newVal) : '(tr·ªëng)';\r\n                    changes.push(`${field.label}: ${oldDisplay} ‚Üí ${newDisplay}`);\r\n                }\r\n            }\r\n            \r\n            if (changes.length > 0) {\r\n                historyEntries.push(createUpdatedEntry(\r\n                    userInfo,\r\n                    `${userInfo.name} ƒë√£ c·∫≠p nh·∫≠t: ${changes.join(', ')}`\r\n                ));\r\n            }\r\n        }\r\n        \r\n        const customerWithLifecycle = {\r\n            ...updatedCustomer,\r\n            lifecycleStage: calculateLifecycleStage(updatedCustomer),\r\n            activityHistory: appendHistoryEntry(existingCustomer?.activityHistory, ...historyEntries)\r\n        };\r\n        console.log('[CustomerStore] Calling baseStore.update with:', customerWithLifecycle);\r\n        \r\n        // Call the update function from baseStore directly\r\n        baseStore.getState().update(systemId, customerWithLifecycle);\r\n        \r\n        console.log('[CustomerStore] State after update:', baseStore.getState().data.find(c => c.systemId === systemId));\r\n    },\r\n    // Get customers with high debt risk\r\n    getHighRiskDebtCustomers: () => {\r\n        const activeCustomers = baseStore.getState().getActive();\r\n        return getHighRiskDebtCustomers(activeCustomers);\r\n    },\r\n    // Batch update customer intelligence (RFM, health score, churn risk)\r\n    updateCustomerIntelligence: () => {\r\n        const allCustomers = baseStore.getState().getActive();\r\n        \r\n        baseStore.setState(state => ({\r\n            data: state.data.map(customer => {\r\n                if (customer.isDeleted) return customer;\r\n                \r\n                // Calculate RFM\r\n                const rfmScores = calculateRFMScores(customer, allCustomers);\r\n                const segment = getCustomerSegment(rfmScores);\r\n                \r\n                // Calculate health score\r\n                const healthScore = calculateHealthScore(customer);\r\n                \r\n                // Calculate churn risk\r\n                const churnRisk = calculateChurnRisk(customer).risk;\r\n                \r\n                // Calculate lifecycle stage\r\n                const lifecycleStage = calculateLifecycleStage(customer);\r\n                \r\n                return {\r\n                    ...customer,\r\n                    rfmScores,\r\n                    segment,\r\n                    healthScore,\r\n                    churnRisk,\r\n                    lifecycleStage\r\n                };\r\n            })\r\n        }));\r\n    },\r\n    // Get customers by segment\r\n    getCustomersBySegment: (segment: string) => {\r\n        return baseStore.getState().getActive().filter(c => c.segment === segment);\r\n    },\r\n    // Get customers with overdue debt\r\n    getOverdueDebtCustomers: () => {\r\n        const activeCustomers = baseStore.getState().getActive();\r\n        return getOverdueDebtCustomers(activeCustomers);\r\n    },\r\n    // Get customers with debt due soon\r\n    getDueSoonCustomers: () => {\r\n        const activeCustomers = baseStore.getState().getActive();\r\n        return getDueSoonCustomers(activeCustomers);\r\n    },\r\n    removeMany: (systemIds: SystemId[]) => {\r\n        if (!systemIds.length) return;\r\n        const deletedAtTimestamp = new Date().toISOString();\r\n        baseStore.setState(state => ({\r\n            data: state.data.map(customer =>\r\n                systemIds.includes(customer.systemId)\r\n                    ? { ...customer, isDeleted: true, deletedAt: deletedAtTimestamp }\r\n                    : customer\r\n            )\r\n        }));\r\n    },\r\n    updateManyStatus: (systemIds: SystemId[], status: Customer['status']) => {\r\n        if (!systemIds.length) return;\r\n        baseStore.setState(state => ({\r\n            data: state.data.map(customer =>\r\n                systemIds.includes(customer.systemId)\r\n                    ? { ...customer, status }\r\n                    : customer\r\n            )\r\n        }));\r\n    },\r\n    restoreMany: (systemIds: SystemId[]) => {\r\n        if (!systemIds.length) return;\r\n        baseStore.setState(state => ({\r\n            data: state.data.map(customer =>\r\n                systemIds.includes(customer.systemId)\r\n                    ? { ...customer, isDeleted: false, deletedAt: null }\r\n                    : customer\r\n            )\r\n        }));\r\n    }\r\n};\r\n\r\ntype CustomerStoreSelector<T> = (state: CustomerStoreState) => T;\r\n\r\nlet cachedBaseState: CrudState<Customer> | null = null;\r\nlet cachedCombinedState: CustomerStoreState | null = null;\r\n\r\nconst getCombinedState = (state: CrudState<Customer>): CustomerStoreState => {\r\n    if (cachedBaseState !== state || !cachedCombinedState) {\r\n        cachedBaseState = state;\r\n        cachedCombinedState = { ...state, ...augmentedMethods } as CustomerStoreState;\r\n    }\r\n    return cachedCombinedState!;\r\n};\r\n\r\nconst boundStore = baseStore as unknown as {\r\n    <R>(selector: (state: CrudState<Customer>) => R, equalityFn?: (a: R, b: R) => boolean): R;\r\n    (): CustomerStoreState;\r\n};\r\n\r\nexport const useCustomerStore = <T = CustomerStoreState>(\r\n    selector?: CustomerStoreSelector<T>,\r\n    equalityFn?: (a: T, b: T) => boolean\r\n): T => {\r\n    if (selector) {\r\n        if (equalityFn) {\r\n            return boundStore((state) => selector(getCombinedState(state)), equalityFn);\r\n        }\r\n        return boundStore((state) => selector(getCombinedState(state)));\r\n    }\r\n    return boundStore((state) => getCombinedState(state) as unknown as T);\r\n};\r\n\r\nuseCustomerStore.getState = (): CustomerStoreState => {\r\n    return getCombinedState(baseStore.getState());\r\n};\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 2405, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/cashbook/store.ts"],"sourcesContent":["import { create } from 'zustand';\r\n// REMOVED: import { data as initialData } from './data'; // Mock data no longer used - database is source of truth\r\nimport type { CashAccount } from './types';\r\nimport { findNextAvailableBusinessId, generateSystemId, getMaxBusinessIdCounter, getMaxSystemIdCounter, type EntityType } from '../../lib/id-utils';\r\nimport { asBusinessId, asSystemId, type BusinessId, type SystemId } from '../../lib/id-types';\r\n\r\nconst CASH_ACCOUNT_ENTITY: EntityType = 'cash-accounts';\r\nconst SYSTEM_ID_PREFIX = 'ACCOUNT';\r\nconst BUSINESS_ID_PREFIX = 'TK';\r\nconst BUSINESS_ID_DIGITS = 6;\r\n\r\n// API sync helpers\r\nasync function syncToAPI(action: 'create' | 'update' | 'delete', data: any): Promise<boolean> {\r\n  try {\r\n    const endpoint = action === 'create' ? '/api/cash-accounts' : `/api/cash-accounts/${data.systemId}`;\r\n    const method = action === 'create' ? 'POST' : action === 'update' ? 'PATCH' : 'DELETE';\r\n    \r\n    const response = await fetch(endpoint, {\r\n      method,\r\n      headers: { 'Content-Type': 'application/json' },\r\n      body: action !== 'delete' ? JSON.stringify(data) : undefined,\r\n    });\r\n    \r\n    if (!response.ok) {\r\n      console.error(`[Cashbook API] ${action} failed:`, await response.text());\r\n      return false;\r\n    }\r\n    return true;\r\n  } catch (error) {\r\n    console.error(`[Cashbook API] ${action} error:`, error);\r\n    return false;\r\n  }\r\n}\r\n\r\nasync function fetchFromAPI(): Promise<CashAccount[]> {\r\n  try {\r\n    const response = await fetch('/api/cash-accounts?limit=50');\r\n    if (!response.ok) return [];\r\n    const json = await response.json();\r\n    return json.data || [];\r\n  } catch (error) {\r\n    console.error('[Cashbook API] fetch error:', error);\r\n    return [];\r\n  }\r\n}\r\n\r\ninterface CashbookState {\r\n  accounts: CashAccount[];\r\n  initialized: boolean;\r\n  getAccountById: (id: BusinessId) => CashAccount | undefined;\r\n  add: (item: Omit<CashAccount, 'systemId'>) => void;\r\n  update: (systemId: SystemId, item: CashAccount) => void;\r\n  remove: (systemId: SystemId) => void;\r\n  setDefault: (systemId: SystemId) => void;\r\n  loadFromAPI: () => Promise<void>;\r\n}\r\n\r\nconst getNextSystemId = (accounts: CashAccount[]): SystemId => {\r\n  const currentCounter = getMaxSystemIdCounter(accounts, SYSTEM_ID_PREFIX);\r\n  return asSystemId(generateSystemId(CASH_ACCOUNT_ENTITY, currentCounter + 1));\r\n};\r\n\r\nconst ensureBusinessId = (accounts: CashAccount[], provided?: BusinessId): BusinessId => {\r\n  if (provided && provided.trim()) {\r\n    return provided;\r\n  }\r\n\r\n  const existingIds = accounts.map(acc => acc.id as string);\r\n  const startCounter = getMaxBusinessIdCounter(accounts, BUSINESS_ID_PREFIX);\r\n  const { nextId } = findNextAvailableBusinessId(BUSINESS_ID_PREFIX, existingIds, startCounter, BUSINESS_ID_DIGITS);\r\n  return asBusinessId(nextId);\r\n};\r\n\r\nexport const useCashbookStore = create<CashbookState>()(\r\n  (set, get) => ({\r\n      accounts: [],\r\n      initialized: false,\r\n      getAccountById: (id) => get().accounts.find(a => a.id === id),\r\n      \r\n      add: (item) => {\r\n        const newAccount: CashAccount = {\r\n          ...item,\r\n          systemId: getNextSystemId(get().accounts),\r\n          id: ensureBusinessId(get().accounts, item.id),\r\n        };\r\n        set((state) => ({ accounts: [...state.accounts, newAccount] }));\r\n        // Sync to API\r\n        syncToAPI('create', newAccount).catch(console.error);\r\n      },\r\n      \r\n      update: (systemId, updatedItem) => {\r\n        set((state) => ({\r\n          accounts: state.accounts.map((acc) => (acc.systemId === systemId ? updatedItem : acc))\r\n        }));\r\n        // Sync to API\r\n        syncToAPI('update', updatedItem).catch(console.error);\r\n      },\r\n      \r\n      remove: (systemId) => {\r\n        set((state) => ({\r\n          accounts: state.accounts.filter(acc => acc.systemId !== systemId)\r\n        }));\r\n        // Sync to API\r\n        syncToAPI('delete', { systemId }).catch(console.error);\r\n      },\r\n      \r\n      setDefault: (systemId) => {\r\n        set((state) => {\r\n          const targetAccount = state.accounts.find(acc => acc.systemId === systemId);\r\n          if (!targetAccount) return state;\r\n\r\n          const updated = state.accounts.map(acc => ({\r\n            ...acc,\r\n            isDefault: (acc.type === targetAccount.type ? acc.systemId === systemId : acc.isDefault) ?? false\r\n          }));\r\n          \r\n          // Sync updated accounts to API\r\n          updated.forEach(acc => {\r\n            if (acc.type === targetAccount.type) {\r\n              syncToAPI('update', acc).catch(console.error);\r\n            }\r\n          });\r\n          \r\n          return { accounts: updated };\r\n        });\r\n      },\r\n      \r\n      loadFromAPI: async () => {\r\n        const apiData = await fetchFromAPI();\r\n        if (apiData.length > 0) {\r\n          set({ accounts: apiData, initialized: true });\r\n        } else {\r\n          set({ initialized: true });\r\n        }\r\n      },\r\n    })\r\n);\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 2537, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/finance/document-lookups.ts"],"sourcesContent":["import { useTargetGroupStore } from '@/features/settings/target-groups/store';\r\nimport { usePaymentMethodStore } from '@/features/settings/payments/methods/store';\r\nimport { useCashbookStore } from '@/features/cashbook/store';\r\nimport { useReceiptTypeStore } from '@/features/settings/receipt-types/store';\r\nimport { usePaymentTypeStore } from '@/features/settings/payments/types/store';\r\nimport type { TargetGroup } from '@/features/settings/target-groups/types';\r\nimport type { PaymentMethod } from '@/features/settings/payments/methods/types';\r\nimport type { CashAccount } from '@/features/cashbook/types';\r\nimport type { ReceiptType } from '@/features/settings/receipt-types/types';\r\nimport type { PaymentType } from '@/features/settings/payments/types/types';\r\nimport type { SystemId } from '@/lib/id-types';\r\n\r\nconst normalizeName = (value?: string | null) => (value ?? '').trim().toLowerCase();\r\n\r\nexport const DEFAULT_CUSTOMER_GROUP = 'kh√°ch h√†ng';\r\n\r\nexport const pickTargetGroup = (options?: {\r\n  systemId?: SystemId | undefined;\r\n  name?: string | undefined;\r\n  fallbackName?: string | undefined;\r\n}): TargetGroup | null => {\r\n  const groups = useTargetGroupStore.getState().data ?? [];\r\n  if (groups.length === 0) {\r\n    return null;\r\n  }\r\n\r\n  if (options?.systemId) {\r\n    const match = groups.find(group => group.systemId === options.systemId);\r\n    if (match) {\r\n      return match;\r\n    }\r\n  }\r\n\r\n  const lookupNames = [options?.name, options?.fallbackName, DEFAULT_CUSTOMER_GROUP].filter(Boolean) as string[];\r\n  for (const candidate of lookupNames) {\r\n    const normalized = normalizeName(candidate);\r\n    const match = groups.find(group => normalizeName(group.name) === normalized);\r\n    if (match) {\r\n      return match;\r\n    }\r\n  }\r\n\r\n  return groups[0] ?? null;\r\n};\r\n\r\nexport const pickPaymentMethod = (options?: {\r\n  systemId?: SystemId | undefined;\r\n  name?: string | undefined;\r\n}): PaymentMethod | null => {\r\n  const methods = usePaymentMethodStore.getState().data ?? [];\r\n  if (methods.length === 0) {\r\n    return null;\r\n  }\r\n\r\n  if (options?.systemId) {\r\n    const match = methods.find(method => method.systemId === options.systemId);\r\n    if (match) {\r\n      return match;\r\n    }\r\n  }\r\n\r\n  if (options?.name) {\r\n    const normalized = normalizeName(options.name);\r\n    const match = methods.find(method => normalizeName(method.name) === normalized);\r\n    if (match) {\r\n      return match;\r\n    }\r\n  }\r\n\r\n  return methods.find(method => method.isDefault) ?? methods[0] ?? null;\r\n};\r\n\r\nexport const pickAccount = (options: {\r\n  accountSystemId?: SystemId | undefined;\r\n  preferredType?: 'cash' | 'bank' | undefined;\r\n  branchSystemId?: SystemId | undefined;\r\n  paymentMethodName?: string | undefined;\r\n}): CashAccount | null => {\r\n  const { accounts } = useCashbookStore.getState();\r\n  if (!accounts || accounts.length === 0) {\r\n    return null;\r\n  }\r\n\r\n  if (options.accountSystemId) {\r\n    const match = accounts.find(account => account.systemId === options.accountSystemId);\r\n    if (match) {\r\n      return match;\r\n    }\r\n  }\r\n\r\n  let preferredType = options.preferredType;\r\n  if (!preferredType && options.paymentMethodName) {\r\n    const normalizedMethod = normalizeName(options.paymentMethodName);\r\n    preferredType = normalizedMethod === 'ti·ªÅn m·∫∑t' ? 'cash' : normalizedMethod === 'chuy·ªÉn kho·∫£n' ? 'bank' : undefined;\r\n  }\r\n\r\n  const candidates = preferredType ? accounts.filter(account => account.type === preferredType) : accounts;\r\n\r\n  if (candidates.length === 0) {\r\n    return accounts[0];\r\n  }\r\n\r\n  return (\r\n    candidates.find(account => account.branchSystemId && options.branchSystemId && account.branchSystemId === options.branchSystemId) ??\r\n    candidates.find(account => account.isDefault) ??\r\n    candidates[0]\r\n  );\r\n};\r\n\r\nexport const pickReceiptType = (options?: {\r\n  systemId?: SystemId | undefined;\r\n  name?: string | undefined;\r\n}): ReceiptType | null => {\r\n  const types = useReceiptTypeStore.getState().data ?? [];\r\n  if (types.length === 0) {\r\n    return null;\r\n  }\r\n\r\n  if (options?.systemId) {\r\n    const match = types.find(type => type.systemId === options.systemId);\r\n    if (match) {\r\n      return match;\r\n    }\r\n  }\r\n\r\n  if (options?.name) {\r\n    const normalized = normalizeName(options.name);\r\n    const match = types.find(type => normalizeName(type.name) === normalized);\r\n    if (match) {\r\n      return match;\r\n    }\r\n  }\r\n\r\n  return types[0] ?? null;\r\n};\r\n\r\nexport const pickPaymentType = (options?: {\r\n  systemId?: SystemId | undefined;\r\n  name?: string | undefined;\r\n}): PaymentType | null => {\r\n  const types = usePaymentTypeStore.getState().data ?? [];\r\n  if (types.length === 0) {\r\n    return null;\r\n  }\r\n\r\n  if (options?.systemId) {\r\n    const match = types.find(type => type.systemId === options.systemId);\r\n    if (match) {\r\n      return match;\r\n    }\r\n  }\r\n\r\n  if (options?.name) {\r\n    const normalized = normalizeName(options.name);\r\n    const match = types.find(type => normalizeName(type.name) === normalized);\r\n    if (match) {\r\n      return match;\r\n    }\r\n  }\r\n\r\n  return types[0] ?? null;\r\n};\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 2674, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/finance/document-helpers.ts"],"sourcesContent":["import { toISODateTime } from '@/lib/date-utils';\r\nimport { asBusinessId, type BusinessId, type SystemId } from '@/lib/id-types';\r\nimport { useReceiptStore, type ReceiptInput } from '@/features/receipts/store';\r\nimport type { Receipt } from '@/features/receipts/types';\r\nimport { usePaymentStore, type PaymentInput } from '@/features/payments/store';\r\nimport type { Payment } from '@/features/payments/types';\r\nimport { pickAccount, pickPaymentMethod, pickPaymentType, pickReceiptType, pickTargetGroup } from '@/features/finance/document-lookups';\r\n\r\nconst asBusinessIdOrUndefined = (value?: string | BusinessId | null) => {\r\n  if (!value) {\r\n    return undefined;\r\n  }\r\n  return typeof value === 'string' ? asBusinessId(value) : value;\r\n};\r\n\r\ninterface ReceiptDocumentOptions {\r\n  amount: number;\r\n  description: string;\r\n  customerName: string;\r\n  branchSystemId: SystemId;\r\n  branchName: string;\r\n  createdBy: SystemId;\r\n  customerSystemId?: SystemId;\r\n  paymentMethodSystemId?: SystemId;\r\n  paymentMethodName?: string;\r\n  accountSystemId?: SystemId;\r\n  accountPreference?: 'cash' | 'bank';\r\n  receiptTypeSystemId?: SystemId;\r\n  receiptTypeName?: string;\r\n  payerTargetGroupSystemId?: SystemId;\r\n  payerTargetGroupName?: string;\r\n  originalDocumentId?: string | BusinessId;\r\n  linkedOrderSystemId?: SystemId;\r\n  linkedSalesReturnSystemId?: SystemId;\r\n  linkedWarrantySystemId?: SystemId;\r\n  linkedComplaintSystemId?: SystemId;\r\n  category?: Receipt['category'];\r\n  affectsDebt?: boolean;\r\n  status?: Receipt['status'];\r\n  date?: string;\r\n}\r\n\r\ninterface PaymentDocumentOptions {\r\n  amount: number;\r\n  description: string;\r\n  recipientName: string;\r\n  branchSystemId: SystemId;\r\n  branchName: string;\r\n  createdBy: SystemId;\r\n  recipientSystemId?: SystemId;\r\n  customerSystemId?: SystemId;\r\n  customerName?: string;\r\n  paymentMethodSystemId?: SystemId;\r\n  paymentMethodName?: string;\r\n  accountSystemId?: SystemId;\r\n  accountPreference?: 'cash' | 'bank';\r\n  paymentTypeSystemId?: SystemId;\r\n  paymentTypeName?: string;\r\n  recipientTargetGroupSystemId?: SystemId;\r\n  recipientTargetGroupName?: string;\r\n  originalDocumentId?: string | BusinessId;\r\n  linkedOrderSystemId?: SystemId;\r\n  linkedSalesReturnSystemId?: SystemId;\r\n  linkedWarrantySystemId?: SystemId;\r\n  linkedComplaintSystemId?: SystemId;\r\n  category?: Payment['category'];\r\n  affectsDebt?: boolean;\r\n  status?: Payment['status'];\r\n  date?: string;\r\n}\r\n\r\nexport interface DocumentCreationResult<T> {\r\n  document: T | null;\r\n  error?: string;\r\n}\r\n\r\nexport const createReceiptDocument = (options: ReceiptDocumentOptions): DocumentCreationResult<Receipt> => {\r\n  if (!options.branchSystemId) {\r\n    return { document: null, error: 'Thi·∫øu m√£ chi nh√°nh khi t·∫°o phi·∫øu thu.' };\r\n  }\r\n\r\n  const targetGroup = pickTargetGroup({\r\n    systemId: options.payerTargetGroupSystemId,\r\n    name: options.payerTargetGroupName,\r\n  });\r\n  if (!targetGroup) {\r\n    return { document: null, error: 'Ch∆∞a c·∫•u h√¨nh nh√≥m ƒë·ªëi t∆∞·ª£ng (Target Group) cho phi·∫øu thu.' };\r\n  }\r\n\r\n  const paymentMethod = pickPaymentMethod({\r\n    systemId: options.paymentMethodSystemId,\r\n    name: options.paymentMethodName,\r\n  });\r\n  if (!paymentMethod) {\r\n    return { document: null, error: 'Ch∆∞a c·∫•u h√¨nh ph∆∞∆°ng th·ª©c thu ti·ªÅn.' };\r\n  }\r\n\r\n  const account = pickAccount({\r\n    accountSystemId: options.accountSystemId,\r\n    preferredType: options.accountPreference,\r\n    branchSystemId: options.branchSystemId,\r\n    paymentMethodName: paymentMethod.name,\r\n  });\r\n  if (!account) {\r\n    return { document: null, error: 'Ch∆∞a c·∫•u h√¨nh t√†i kho·∫£n qu·ªπ ph√π h·ª£p ƒë·ªÉ t·∫°o phi·∫øu thu.' };\r\n  }\r\n\r\n  const receiptType = pickReceiptType({\r\n    systemId: options.receiptTypeSystemId,\r\n    name: options.receiptTypeName,\r\n  });\r\n  if (!receiptType) {\r\n    return { document: null, error: 'Ch∆∞a c·∫•u h√¨nh lo·∫°i phi·∫øu thu.' };\r\n  }\r\n\r\n  const timestamp = options.date ?? toISODateTime(new Date());\r\n  const payload: ReceiptInput = {\r\n    date: timestamp,\r\n    amount: options.amount,\r\n    payerTypeSystemId: targetGroup.systemId,\r\n    payerTypeName: targetGroup.name,\r\n    payerName: options.customerName,\r\n    payerSystemId: options.customerSystemId,\r\n    description: options.description,\r\n    paymentMethodSystemId: paymentMethod.systemId,\r\n    paymentMethodName: paymentMethod.name,\r\n    accountSystemId: account.systemId,\r\n    paymentReceiptTypeSystemId: receiptType.systemId,\r\n    paymentReceiptTypeName: receiptType.name,\r\n    branchSystemId: options.branchSystemId,\r\n    branchName: options.branchName,\r\n    createdBy: options.createdBy,\r\n    createdAt: timestamp,\r\n    status: options.status ?? 'completed',\r\n    category: options.category,\r\n    originalDocumentId: asBusinessIdOrUndefined(options.originalDocumentId),\r\n    linkedOrderSystemId: options.linkedOrderSystemId,\r\n    linkedSalesReturnSystemId: options.linkedSalesReturnSystemId,\r\n    linkedWarrantySystemId: options.linkedWarrantySystemId,\r\n    linkedComplaintSystemId: options.linkedComplaintSystemId,\r\n    customerSystemId: options.customerSystemId,\r\n    customerName: options.customerName,\r\n    affectsDebt: options.affectsDebt ?? true,\r\n  };\r\n\r\n  const receipt = useReceiptStore.getState().add(payload);\r\n  return { document: receipt };\r\n};\r\n\r\nexport const createPaymentDocument = (options: PaymentDocumentOptions): DocumentCreationResult<Payment> => {\r\n  if (!options.branchSystemId) {\r\n    return { document: null, error: 'Thi·∫øu m√£ chi nh√°nh khi t·∫°o phi·∫øu chi.' };\r\n  }\r\n\r\n  const targetGroup = pickTargetGroup({\r\n    systemId: options.recipientTargetGroupSystemId,\r\n    name: options.recipientTargetGroupName,\r\n  });\r\n  if (!targetGroup) {\r\n    return { document: null, error: 'Ch∆∞a c·∫•u h√¨nh nh√≥m ƒë·ªëi t∆∞·ª£ng (Target Group) cho phi·∫øu chi.' };\r\n  }\r\n\r\n  const paymentMethod = pickPaymentMethod({\r\n    systemId: options.paymentMethodSystemId,\r\n    name: options.paymentMethodName,\r\n  });\r\n  if (!paymentMethod) {\r\n    return { document: null, error: 'Ch∆∞a c·∫•u h√¨nh ph∆∞∆°ng th·ª©c chi ti·ªÅn.' };\r\n  }\r\n\r\n  const account = pickAccount({\r\n    accountSystemId: options.accountSystemId,\r\n    preferredType: options.accountPreference,\r\n    branchSystemId: options.branchSystemId,\r\n    paymentMethodName: paymentMethod.name,\r\n  });\r\n  if (!account) {\r\n    return { document: null, error: 'Ch∆∞a c·∫•u h√¨nh t√†i kho·∫£n qu·ªπ ph√π h·ª£p ƒë·ªÉ t·∫°o phi·∫øu chi.' };\r\n  }\r\n\r\n  const paymentType = pickPaymentType({\r\n    systemId: options.paymentTypeSystemId,\r\n    name: options.paymentTypeName,\r\n  });\r\n  if (!paymentType) {\r\n    return { document: null, error: 'Ch∆∞a c·∫•u h√¨nh lo·∫°i phi·∫øu chi.' };\r\n  }\r\n\r\n  const timestamp = options.date ?? toISODateTime(new Date());\r\n  const payload: PaymentInput = {\r\n    date: timestamp,\r\n    amount: options.amount,\r\n    recipientTypeSystemId: targetGroup.systemId,\r\n    recipientTypeName: targetGroup.name,\r\n    recipientName: options.recipientName,\r\n    recipientSystemId: options.recipientSystemId,\r\n    description: options.description,\r\n    paymentMethodSystemId: paymentMethod.systemId,\r\n    paymentMethodName: paymentMethod.name,\r\n    accountSystemId: account.systemId,\r\n    paymentReceiptTypeSystemId: paymentType.systemId,\r\n    paymentReceiptTypeName: paymentType.name,\r\n    branchSystemId: options.branchSystemId,\r\n    branchName: options.branchName,\r\n    createdBy: options.createdBy,\r\n    createdAt: timestamp,\r\n    status: options.status ?? 'completed',\r\n    category: options.category,\r\n    originalDocumentId: asBusinessIdOrUndefined(options.originalDocumentId),\r\n    linkedOrderSystemId: options.linkedOrderSystemId,\r\n    linkedSalesReturnSystemId: options.linkedSalesReturnSystemId,\r\n    linkedWarrantySystemId: options.linkedWarrantySystemId,\r\n    linkedComplaintSystemId: options.linkedComplaintSystemId,\r\n    customerSystemId: options.customerSystemId,\r\n    customerName: options.customerName ?? options.recipientName,\r\n    affectsDebt: options.affectsDebt ?? true,\r\n  };\r\n\r\n  const payment = usePaymentStore.getState().add(payload);\r\n  return { document: payment };\r\n};\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 2866, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/receipts/store.ts"],"sourcesContent":["import { create } from 'zustand';\r\nimport { subscribeWithSelector } from 'zustand/middleware';\r\nimport type { Receipt } from './types';\r\nimport type { HistoryEntry } from '../../components/ActivityHistory';\r\nimport { \r\n  findNextAvailableBusinessId, \r\n  generateSystemId, \r\n  getMaxBusinessIdCounter, \r\n  getMaxSystemIdCounter,\r\n  extractCounterFromBusinessId,\r\n  type EntityType \r\n} from '@/lib/id-utils';\r\nimport { asSystemId, asBusinessId, type BusinessId, type SystemId } from '@/lib/id-types';\r\n// REMOVED: import { data as initialData } from './data'; // Mock data no longer used - database is source of truth\r\nimport { pickAccount, pickPaymentMethod, pickReceiptType, pickTargetGroup } from '@/features/finance/document-lookups';\r\nimport { useEmployeeStore } from '../employees/store';\r\nimport { getCurrentUserSystemId } from '../../contexts/auth-context';\r\n\r\n// API sync helpers\r\nasync function syncToAPI(action: 'create' | 'update' | 'delete', data: any): Promise<boolean> {\r\n  try {\r\n    const endpoint = action === 'create' ? '/api/receipts' : `/api/receipts/${data.systemId}`;\r\n    const method = action === 'create' ? 'POST' : action === 'update' ? 'PATCH' : 'DELETE';\r\n    \r\n    const response = await fetch(endpoint, {\r\n      method,\r\n      headers: { 'Content-Type': 'application/json' },\r\n      body: action !== 'delete' ? JSON.stringify(data) : undefined,\r\n    });\r\n    \r\n    if (!response.ok) {\r\n      console.error(`[Receipts API] ${action} failed:`, await response.text());\r\n      return false;\r\n    }\r\n    return true;\r\n  } catch (error) {\r\n    console.error(`[Receipts API] ${action} error:`, error);\r\n    return false;\r\n  }\r\n}\r\n\r\n// Helper to get current user info\r\nconst getCurrentUserInfo = () => {\r\n  const currentUserSystemId = getCurrentUserSystemId?.() || 'SYSTEM';\r\n  const employee = useEmployeeStore.getState().data.find(e => e.systemId === currentUserSystemId);\r\n  return {\r\n    systemId: currentUserSystemId,\r\n    name: employee?.fullName || 'H·ªá th·ªëng',\r\n    avatar: employee?.avatarUrl,\r\n  };\r\n};\r\n\r\n// Helper to create history entry\r\nconst createHistoryEntry = (\r\n  action: HistoryEntry['action'],\r\n  description: string,\r\n  metadata?: HistoryEntry['metadata']\r\n): HistoryEntry => ({\r\n  id: crypto.randomUUID(),\r\n  action,\r\n  timestamp: new Date(),\r\n  user: getCurrentUserInfo(),\r\n  description,\r\n  metadata,\r\n});\r\n\r\nconst SYSTEM_AUTHOR = asSystemId('SYSTEM');\r\nconst getCurrentReceiptAuthor = (): SystemId => {\r\n  const userId = getCurrentUserSystemId?.();\r\n  return userId ? asSystemId(userId) : SYSTEM_AUTHOR;\r\n};\r\n\r\nexport type ReceiptInput = Omit<Receipt, 'systemId' | 'id'> & { id?: BusinessId };\r\n\r\ninterface ReceiptStore {\r\n  data: Receipt[];\r\n  businessIdCounter: number;\r\n  systemIdCounter: number;\r\n  initialized: boolean;\r\n  add: (item: ReceiptInput) => Receipt;\r\n  addMultiple: (items: ReceiptInput[]) => void;\r\n  update: (systemId: SystemId, item: Receipt) => void;\r\n  remove: (systemId: SystemId) => void;\r\n  findById: (systemId: SystemId) => Receipt | undefined;\r\n  getActive: () => Receipt[];\r\n  cancel: (systemId: SystemId, reason?: string) => void;\r\n  loadFromAPI: () => Promise<void>;\r\n}\r\n\r\nconst RECEIPT_ENTITY: EntityType = 'receipts';\r\nconst SYSTEM_ID_PREFIX = 'RECEIPT';\r\nconst BUSINESS_ID_PREFIX = 'PT';\r\nconst BUSINESS_ID_DIGITS = 6;\r\n\r\nconst normalizeReceiptStatus = (status?: Receipt['status']): Receipt['status'] =>\r\n  status === 'cancelled' ? 'cancelled' : 'completed';\r\n\r\nconst ensureReceiptMetadata = (receipt: Receipt): Receipt => {\r\n  let mutated = false;\r\n  const updates: Partial<Receipt> = {};\r\n\r\n  const targetGroup = pickTargetGroup({\r\n    systemId: receipt.payerTypeSystemId,\r\n    name: receipt.payerTypeName,\r\n  });\r\n  if (targetGroup) {\r\n    if (receipt.payerTypeSystemId !== targetGroup.systemId) {\r\n      updates.payerTypeSystemId = targetGroup.systemId;\r\n      mutated = true;\r\n    }\r\n    if (receipt.payerTypeName !== targetGroup.name) {\r\n      updates.payerTypeName = targetGroup.name;\r\n      mutated = true;\r\n    }\r\n  }\r\n\r\n  const paymentMethod = pickPaymentMethod({\r\n    systemId: receipt.paymentMethodSystemId,\r\n    name: receipt.paymentMethodName,\r\n  });\r\n  if (paymentMethod) {\r\n    if (receipt.paymentMethodSystemId !== paymentMethod.systemId) {\r\n      updates.paymentMethodSystemId = paymentMethod.systemId;\r\n      mutated = true;\r\n    }\r\n    if (receipt.paymentMethodName !== paymentMethod.name) {\r\n      updates.paymentMethodName = paymentMethod.name;\r\n      mutated = true;\r\n    }\r\n  }\r\n\r\n  const account = pickAccount({\r\n    accountSystemId: receipt.accountSystemId,\r\n    branchSystemId: receipt.branchSystemId,\r\n    paymentMethodName: paymentMethod?.name ?? receipt.paymentMethodName,\r\n  });\r\n  if (account && receipt.accountSystemId !== account.systemId) {\r\n    updates.accountSystemId = account.systemId;\r\n    mutated = true;\r\n  }\r\n\r\n  const receiptType = pickReceiptType({\r\n    systemId: receipt.paymentReceiptTypeSystemId,\r\n    name: receipt.paymentReceiptTypeName,\r\n  });\r\n  if (receiptType) {\r\n    if (receipt.paymentReceiptTypeSystemId !== receiptType.systemId) {\r\n      updates.paymentReceiptTypeSystemId = receiptType.systemId;\r\n      mutated = true;\r\n    }\r\n    if (receipt.paymentReceiptTypeName !== receiptType.name) {\r\n      updates.paymentReceiptTypeName = receiptType.name;\r\n      mutated = true;\r\n    }\r\n  }\r\n\r\n  if (!receipt.customerName && receipt.payerName) {\r\n    updates.customerName = receipt.payerName;\r\n    mutated = true;\r\n  }\r\n\r\n  if (!receipt.customerSystemId && receipt.payerSystemId) {\r\n    updates.customerSystemId = receipt.payerSystemId;\r\n    mutated = true;\r\n  }\r\n\r\n  return mutated ? { ...receipt, ...updates } : receipt;\r\n};\r\n\r\nconst backfillReceiptMetadata = (receipts: Receipt[]): Receipt[] => {\r\n  let mutated = false;\r\n  const updated = receipts.map(receipt => {\r\n    const normalized = ensureReceiptMetadata(receipt);\r\n    if (normalized !== receipt) {\r\n      mutated = true;\r\n    }\r\n    return normalized;\r\n  });\r\n  return mutated ? updated : receipts;\r\n};\r\n\r\nconst initialReceipts: Receipt[] = []; // Database is source of truth\r\n\r\nlet systemIdCounter = getMaxSystemIdCounter(initialReceipts, SYSTEM_ID_PREFIX);\r\nlet businessIdCounter = getMaxBusinessIdCounter(initialReceipts, BUSINESS_ID_PREFIX);\r\n\r\nconst getNextSystemId = (): SystemId => {\r\n  systemIdCounter += 1;\r\n  return asSystemId(generateSystemId(RECEIPT_ENTITY, systemIdCounter));\r\n};\r\n\r\nconst ensureReceiptBusinessId = (receipts: Receipt[], provided?: BusinessId | string): BusinessId => {\r\n  if (provided && `${provided}`.trim().length > 0) {\r\n    const normalized = `${provided}`.trim().toUpperCase();\r\n    const parsedCounter = extractCounterFromBusinessId(normalized, BUSINESS_ID_PREFIX);\r\n    if (parsedCounter > businessIdCounter) {\r\n      businessIdCounter = parsedCounter;\r\n    }\r\n    return asBusinessId(normalized);\r\n  }\r\n\r\n  const existingIds = receipts.map(receipt => receipt.id as string).filter(Boolean);\r\n  const { nextId, updatedCounter } = findNextAvailableBusinessId(\r\n    BUSINESS_ID_PREFIX,\r\n    existingIds,\r\n    businessIdCounter,\r\n    BUSINESS_ID_DIGITS\r\n  );\r\n  businessIdCounter = updatedCounter;\r\n  return asBusinessId(nextId);\r\n};\r\n\r\nexport const useReceiptStore = create<ReceiptStore>()(\r\n  subscribeWithSelector(\r\n    (set, get) => ({\r\n      data: initialReceipts,\r\n      businessIdCounter,\r\n      systemIdCounter,\r\n      initialized: false,\r\n      \r\n      add: (item: ReceiptInput): Receipt => {\r\n        let createdReceipt: Receipt | null = null;\r\n        set(state => {\r\n          const systemId = getNextSystemId();\r\n          const id = ensureReceiptBusinessId(state.data, item.id);\r\n          const createdBy = item.createdBy ?? getCurrentReceiptAuthor();\r\n          \r\n          const newReceipt: Receipt = { \r\n            ...item, \r\n            systemId, \r\n            id,\r\n            createdBy,\r\n            createdAt: item.createdAt || new Date().toISOString(),\r\n            status: normalizeReceiptStatus(item.status),\r\n            orderAllocations: item.orderAllocations ?? [],\r\n          };\r\n\r\n          const normalizedReceipt = ensureReceiptMetadata(newReceipt);\r\n          createdReceipt = normalizedReceipt;\r\n\r\n          return { \r\n            data: [...state.data, normalizedReceipt],\r\n            businessIdCounter,\r\n            systemIdCounter\r\n          };\r\n        });\r\n        // Sync to API\r\n        if (createdReceipt) {\r\n          syncToAPI('create', createdReceipt).catch(console.error);\r\n        }\r\n        return createdReceipt!;\r\n      },\r\n      \r\n      addMultiple: (items: ReceiptInput[]) => {\r\n        const created: Receipt[] = [];\r\n        set(state => {\r\n          items.forEach(item => {\r\n            const context = [...state.data, ...created];\r\n            const systemId = getNextSystemId();\r\n            const id = ensureReceiptBusinessId(context, item.id);\r\n            const createdBy = item.createdBy ?? getCurrentReceiptAuthor();\r\n            \r\n            const newReceipt: Receipt = { \r\n              ...item, \r\n              systemId, \r\n              id,\r\n              createdBy,\r\n              createdAt: item.createdAt || new Date().toISOString(),\r\n              status: normalizeReceiptStatus(item.status),\r\n              orderAllocations: item.orderAllocations ?? [],\r\n            };\r\n            created.push(ensureReceiptMetadata(newReceipt));\r\n          });\r\n          \r\n          return { \r\n            data: [...state.data, ...created],\r\n            businessIdCounter,\r\n            systemIdCounter\r\n          };\r\n        });\r\n        // Sync all to API\r\n        created.forEach(receipt => {\r\n          syncToAPI('create', receipt).catch(console.error);\r\n        });\r\n      },\r\n      \r\n      update: (systemId: SystemId, item: Receipt) => {\r\n        const updated = { ...item, status: normalizeReceiptStatus(item.status), updatedAt: new Date().toISOString() };\r\n        set(state => ({\r\n          data: state.data.map(r => r.systemId === systemId ? updated : r),\r\n          businessIdCounter,\r\n          systemIdCounter\r\n        }));\r\n        // Sync to API\r\n        syncToAPI('update', updated).catch(console.error);\r\n      },\r\n      \r\n      remove: (systemId: SystemId) => {\r\n        set(state => ({\r\n          data: state.data.filter(r => r.systemId !== systemId),\r\n          businessIdCounter,\r\n          systemIdCounter\r\n        }));\r\n        // Sync to API\r\n        syncToAPI('delete', { systemId }).catch(console.error);\r\n      },\r\n      \r\n      findById: (systemId: SystemId) => {\r\n        return get().data.find(r => r.systemId === systemId);\r\n      },\r\n      \r\n      getActive: () => {\r\n        return get().data.filter(r => r.status !== 'cancelled');\r\n      },\r\n      \r\n      cancel: (systemId: SystemId, reason?: string) => {\r\n        const receipt = get().findById(systemId);\r\n        if (receipt && receipt.status !== 'cancelled') {\r\n          const historyEntry = createHistoryEntry(\r\n            'cancelled',\r\n            `ƒê√£ h·ªßy phi·∫øu thu${reason ? `: ${reason}` : ''}`,\r\n            { oldValue: 'Ho√†n th√†nh', newValue: 'ƒê√£ h·ªßy', note: reason }\r\n          );\r\n          \r\n          get().update(systemId, {\r\n            ...receipt,\r\n            status: 'cancelled',\r\n            cancelledAt: new Date().toISOString(),\r\n            activityHistory: [...(receipt.activityHistory || []), historyEntry],\r\n          });\r\n        }\r\n      },\r\n      \r\n      loadFromAPI: async () => {\r\n        try {\r\n          // NOTE: Use React Query hooks for paginated data. This only loads initial batch.\r\n          const response = await fetch('/api/receipts?limit=30');\r\n          if (!response.ok) return;\r\n          const json = await response.json();\r\n          const apiData = json.data || [];\r\n          if (apiData.length > 0) {\r\n            const normalized = backfillReceiptMetadata(apiData.map((receipt: Receipt) => ({\r\n              ...receipt,\r\n              status: normalizeReceiptStatus(receipt.status),\r\n            })));\r\n            const nextSystemCounter = getMaxSystemIdCounter(normalized, SYSTEM_ID_PREFIX);\r\n            const nextBusinessCounter = getMaxBusinessIdCounter(normalized, BUSINESS_ID_PREFIX);\r\n            systemIdCounter = nextSystemCounter;\r\n            businessIdCounter = nextBusinessCounter;\r\n            set({ \r\n              data: normalized, \r\n              systemIdCounter, \r\n              businessIdCounter,\r\n              initialized: true \r\n            });\r\n          } else {\r\n            set({ initialized: true });\r\n          }\r\n        } catch (error) {\r\n          console.error('[Receipts API] loadFromAPI error:', error);\r\n        }\r\n      },\r\n    })\r\n  )\r\n);\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 3194, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/payments/store.ts"],"sourcesContent":["import { create } from 'zustand';\r\nimport type { Payment } from './types';\r\nimport type { HistoryEntry } from '../../components/ActivityHistory';\r\n// REMOVED: import { data as initialData } from './data'; // Mock data no longer used - database is source of truth\r\nimport {\r\n  extractCounterFromBusinessId,\r\n  findNextAvailableBusinessId,\r\n  generateSystemId,\r\n  getMaxBusinessIdCounter,\r\n  getMaxSystemIdCounter,\r\n  type EntityType,\r\n} from '../../lib/id-utils';\r\nimport { asBusinessId, asSystemId, type BusinessId, type SystemId } from '../../lib/id-types';\r\nimport { pickAccount, pickPaymentMethod, pickPaymentType, pickTargetGroup } from '@/features/finance/document-lookups';\r\nimport { useEmployeeStore } from '../employees/store';\r\nimport { getCurrentUserSystemId } from '../../contexts/auth-context';\r\n\r\n// API sync helpers\r\nasync function syncToAPI(action: 'create' | 'update' | 'delete', data: any): Promise<boolean> {\r\n  try {\r\n    const endpoint = action === 'create' ? '/api/payments' : `/api/payments/${data.systemId}`;\r\n    const method = action === 'create' ? 'POST' : action === 'update' ? 'PATCH' : 'DELETE';\r\n    \r\n    const response = await fetch(endpoint, {\r\n      method,\r\n      headers: { 'Content-Type': 'application/json' },\r\n      body: action !== 'delete' ? JSON.stringify(data) : undefined,\r\n    });\r\n    \r\n    if (!response.ok) {\r\n      console.error(`[Payments API] ${action} failed:`, await response.text());\r\n      return false;\r\n    }\r\n    return true;\r\n  } catch (error) {\r\n    console.error(`[Payments API] ${action} error:`, error);\r\n    return false;\r\n  }\r\n}\r\n\r\n// Helper to get current user info\r\nconst getCurrentUserInfo = () => {\r\n  const currentUserSystemId = getCurrentUserSystemId?.() || 'SYSTEM';\r\n  const employee = useEmployeeStore.getState().data.find(e => e.systemId === currentUserSystemId);\r\n  return {\r\n    systemId: currentUserSystemId,\r\n    name: employee?.fullName || 'H·ªá th·ªëng',\r\n    avatar: employee?.avatarUrl,\r\n  };\r\n};\r\n\r\n// Helper to create history entry\r\nconst createHistoryEntry = (\r\n  action: HistoryEntry['action'],\r\n  description: string,\r\n  metadata?: HistoryEntry['metadata']\r\n): HistoryEntry => ({\r\n  id: crypto.randomUUID(),\r\n  action,\r\n  timestamp: new Date(),\r\n  user: getCurrentUserInfo(),\r\n  description,\r\n  metadata,\r\n});\r\n\r\nexport type PaymentInput = Omit<Payment, 'systemId' | 'id'> & { id?: BusinessId | string };\r\n\r\ninterface PaymentStore {\r\n  data: Payment[];\r\n  businessIdCounter: number;\r\n  systemIdCounter: number;\r\n  initialized: boolean;\r\n  add: (item: PaymentInput) => Payment;\r\n  addMultiple: (items: PaymentInput[]) => void;\r\n  update: (systemId: SystemId, item: Payment) => void;\r\n  remove: (systemId: SystemId) => void;\r\n  findById: (systemId: SystemId) => Payment | undefined;\r\n  getActive: () => Payment[];\r\n  cancel: (systemId: SystemId, reason?: string) => void;\r\n  loadFromAPI: () => Promise<void>;\r\n}\r\n\r\nconst PAYMENT_ENTITY: EntityType = 'payments';\r\nconst SYSTEM_ID_PREFIX = 'PAYMENT';\r\nconst BUSINESS_ID_PREFIX = 'PC';\r\nconst BUSINESS_ID_DIGITS = 6;\r\nconst PURCHASE_ORDER_SYSTEM_PREFIX = 'PURCHASE';\r\nconst PURCHASE_ORDER_BUSINESS_PREFIX = 'PO';\r\n\r\nconst normalizePaymentStatus = (status?: Payment['status']): Payment['status'] =>\r\n  status === 'cancelled' ? 'cancelled' : 'completed';\r\n\r\nconst normalizePayment = (payment: Payment): Payment => ({\r\n  ...payment,\r\n  status: normalizePaymentStatus(payment.status),\r\n});\r\n\r\nconst ensurePaymentMetadata = (payment: Payment): Payment => {\r\n  let mutated = false;\r\n  const updates: Partial<Payment> = {};\r\n\r\n  const targetGroup = pickTargetGroup({\r\n    systemId: payment.recipientTypeSystemId,\r\n    name: payment.recipientTypeName,\r\n  });\r\n  if (targetGroup) {\r\n    if (payment.recipientTypeSystemId !== targetGroup.systemId) {\r\n      updates.recipientTypeSystemId = targetGroup.systemId;\r\n      mutated = true;\r\n    }\r\n    if (payment.recipientTypeName !== targetGroup.name) {\r\n      updates.recipientTypeName = targetGroup.name;\r\n      mutated = true;\r\n    }\r\n  }\r\n\r\n  const paymentMethod = pickPaymentMethod({\r\n    systemId: payment.paymentMethodSystemId,\r\n    name: payment.paymentMethodName,\r\n  });\r\n  if (paymentMethod) {\r\n    if (payment.paymentMethodSystemId !== paymentMethod.systemId) {\r\n      updates.paymentMethodSystemId = paymentMethod.systemId;\r\n      mutated = true;\r\n    }\r\n    if (payment.paymentMethodName !== paymentMethod.name) {\r\n      updates.paymentMethodName = paymentMethod.name;\r\n      mutated = true;\r\n    }\r\n  }\r\n\r\n  const account = pickAccount({\r\n    accountSystemId: payment.accountSystemId,\r\n    branchSystemId: payment.branchSystemId,\r\n    paymentMethodName: paymentMethod?.name ?? payment.paymentMethodName,\r\n  });\r\n  if (account && payment.accountSystemId !== account.systemId) {\r\n    updates.accountSystemId = account.systemId;\r\n    mutated = true;\r\n  }\r\n\r\n  const paymentType = pickPaymentType({\r\n    systemId: payment.paymentReceiptTypeSystemId,\r\n    name: payment.paymentReceiptTypeName,\r\n  });\r\n  if (paymentType) {\r\n    if (payment.paymentReceiptTypeSystemId !== paymentType.systemId) {\r\n      updates.paymentReceiptTypeSystemId = paymentType.systemId;\r\n      mutated = true;\r\n    }\r\n    if (payment.paymentReceiptTypeName !== paymentType.name) {\r\n      updates.paymentReceiptTypeName = paymentType.name;\r\n      mutated = true;\r\n    }\r\n  }\r\n\r\n  const normalizedGroupName = targetGroup?.name?.trim().toLowerCase();\r\n  if (normalizedGroupName === 'kh√°ch h√†ng') {\r\n    if (!payment.customerName && payment.recipientName) {\r\n      updates.customerName = payment.recipientName;\r\n      mutated = true;\r\n    }\r\n    if (!payment.customerSystemId && payment.recipientSystemId) {\r\n      updates.customerSystemId = payment.recipientSystemId;\r\n      mutated = true;\r\n    }\r\n  }\r\n\r\n  return mutated ? { ...payment, ...updates } : payment;\r\n};\r\n\r\nconst backfillPaymentMetadata = (payments: Payment[]): Payment[] => {\r\n  let mutated = false;\r\n  const updated = payments.map(payment => {\r\n    const normalized = ensurePaymentMetadata(payment);\r\n    if (normalized !== payment) {\r\n      mutated = true;\r\n    }\r\n    return normalized;\r\n  });\r\n  return mutated ? updated : payments;\r\n};\r\n\r\nconst initialPayments: Payment[] = []; // Database is source of truth\r\n\r\nlet systemIdCounter = getMaxSystemIdCounter(initialPayments, SYSTEM_ID_PREFIX);\r\nlet businessIdCounter = getMaxBusinessIdCounter(initialPayments, BUSINESS_ID_PREFIX);\r\n\r\nconst getNextSystemId = (): SystemId => {\r\n  systemIdCounter += 1;\r\n  return asSystemId(generateSystemId(PAYMENT_ENTITY, systemIdCounter));\r\n};\r\n\r\nconst ensurePaymentBusinessId = (payments: Payment[], provided?: BusinessId | string): BusinessId => {\r\n  if (provided && `${provided}`.trim().length > 0) {\r\n    const normalized = `${provided}`.trim().toUpperCase();\r\n    const parsedCounter = extractCounterFromBusinessId(normalized, BUSINESS_ID_PREFIX);\r\n    if (parsedCounter > businessIdCounter) {\r\n      businessIdCounter = parsedCounter;\r\n    }\r\n    return asBusinessId(normalized);\r\n  }\r\n\r\n  const existingIds = payments.map(payment => payment.id as string).filter(Boolean);\r\n  const { nextId, updatedCounter } = findNextAvailableBusinessId(\r\n    BUSINESS_ID_PREFIX,\r\n    existingIds,\r\n    businessIdCounter,\r\n    BUSINESS_ID_DIGITS\r\n  );\r\n  businessIdCounter = updatedCounter;\r\n  return asBusinessId(nextId);\r\n};\r\n\r\nconst reconcileLinkedDocuments = (payment: Payment): Payment => {\r\n  if (!payment.originalDocumentId) {\r\n    return payment;\r\n  }\r\n\r\n  const normalizedDocId = payment.originalDocumentId.toUpperCase();\r\n  const nextPayment = { ...payment };\r\n\r\n  if (!nextPayment.purchaseOrderSystemId && normalizedDocId.startsWith(PURCHASE_ORDER_SYSTEM_PREFIX)) {\r\n    nextPayment.purchaseOrderSystemId = asSystemId(payment.originalDocumentId);\r\n  }\r\n\r\n  if (!nextPayment.purchaseOrderId && normalizedDocId.startsWith(PURCHASE_ORDER_BUSINESS_PREFIX)) {\r\n    nextPayment.purchaseOrderId = asBusinessId(payment.originalDocumentId);\r\n  }\r\n\r\n  return nextPayment;\r\n};\r\n\r\nconst buildPayment = (input: PaymentInput, existingPayments: Payment[]): Payment => {\r\n  const systemId = getNextSystemId();\r\n  const id = ensurePaymentBusinessId(existingPayments, input.id);\r\n  const basePayment: Payment = {\r\n    ...input,\r\n    systemId,\r\n    id,\r\n    createdAt: input.createdAt || new Date().toISOString(),\r\n    status: normalizePaymentStatus(input.status),\r\n  };\r\n\r\n  return reconcileLinkedDocuments(basePayment);\r\n};\r\n\r\nexport const usePaymentStore = create<PaymentStore>()(\r\n  (set, get) => ({\r\n      data: initialPayments,\r\n      businessIdCounter,\r\n      systemIdCounter,\r\n      initialized: false,\r\n      \r\n      add: (item) => {\r\n        let createdPayment: Payment | null = null;\r\n        set(state => {\r\n          const newPayment = buildPayment(item, state.data);\r\n          createdPayment = newPayment;\r\n          return {\r\n            data: [...state.data, newPayment],\r\n            businessIdCounter,\r\n            systemIdCounter,\r\n          };\r\n        });\r\n        // Sync to API\r\n        if (createdPayment) {\r\n          syncToAPI('create', createdPayment).catch(console.error);\r\n        }\r\n        return createdPayment!;\r\n      },\r\n      \r\n      addMultiple: (items) => {\r\n        const created: Payment[] = [];\r\n        set(state => {\r\n          items.forEach(item => {\r\n            const context = [...state.data, ...created];\r\n            const payment = buildPayment(item, context);\r\n            created.push(payment);\r\n          });\r\n\r\n          return {\r\n            data: [...state.data, ...created],\r\n            businessIdCounter,\r\n            systemIdCounter,\r\n          };\r\n        });\r\n        // Sync all to API\r\n        created.forEach(payment => {\r\n          syncToAPI('create', payment).catch(console.error);\r\n        });\r\n      },\r\n      \r\n      update: (systemId, item) => {\r\n        const updated = reconcileLinkedDocuments({\r\n          ...item,\r\n          systemId,\r\n          status: normalizePaymentStatus(item.status),\r\n          updatedAt: new Date().toISOString(),\r\n        });\r\n        set(state => ({\r\n          data: state.data.map(payment =>\r\n            payment.systemId === systemId ? updated : payment\r\n          ),\r\n          businessIdCounter,\r\n          systemIdCounter,\r\n        }));\r\n        // Sync to API\r\n        syncToAPI('update', updated).catch(console.error);\r\n      },\r\n      \r\n      remove: (systemId) => {\r\n        set(state => ({\r\n          data: state.data.filter(payment => payment.systemId !== systemId),\r\n          businessIdCounter,\r\n          systemIdCounter,\r\n        }));\r\n        // Sync to API\r\n        syncToAPI('delete', { systemId }).catch(console.error);\r\n      },\r\n      \r\n      findById: (systemId) => {\r\n        return get().data.find(payment => payment.systemId === systemId);\r\n      },\r\n      \r\n      getActive: () => {\r\n        return get().data.filter(payment => payment.status !== 'cancelled');\r\n      },\r\n      \r\n      cancel: (systemId: SystemId, reason?: string) => {\r\n        const payment = get().findById(systemId);\r\n        if (payment && payment.status !== 'cancelled') {\r\n          const historyEntry = createHistoryEntry(\r\n            'cancelled',\r\n            `ƒê√£ h·ªßy phi·∫øu chi${reason ? `: ${reason}` : ''}`,\r\n            { oldValue: 'Ho√†n th√†nh', newValue: 'ƒê√£ h·ªßy', note: reason }\r\n          );\r\n          \r\n          get().update(systemId, {\r\n            ...payment,\r\n            status: 'cancelled',\r\n            cancelledAt: new Date().toISOString(),\r\n            activityHistory: [...(payment.activityHistory || []), historyEntry],\r\n          });\r\n        }\r\n      },\r\n      \r\n      loadFromAPI: async () => {\r\n        try {\r\n          // NOTE: Use React Query hooks for paginated data. This only loads initial batch.\r\n          const response = await fetch('/api/payments?limit=30');\r\n          if (!response.ok) return;\r\n          const json = await response.json();\r\n          const apiData = json.data || [];\r\n          if (apiData.length > 0) {\r\n            const normalized = backfillPaymentMetadata(apiData.map(normalizePayment));\r\n            const nextSystemCounter = getMaxSystemIdCounter(normalized, SYSTEM_ID_PREFIX);\r\n            const nextBusinessCounter = getMaxBusinessIdCounter(normalized, BUSINESS_ID_PREFIX);\r\n            systemIdCounter = nextSystemCounter;\r\n            businessIdCounter = nextBusinessCounter;\r\n            set({ \r\n              data: normalized, \r\n              systemIdCounter, \r\n              businessIdCounter,\r\n              initialized: true \r\n            });\r\n          } else {\r\n            set({ initialized: true });\r\n          }\r\n        } catch (error) {\r\n          console.error('[Payments API] loadFromAPI error:', error);\r\n        }\r\n      },\r\n    })\r\n);\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 3527, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/sales-returns/store.ts"],"sourcesContent":["import { formatDate, formatDateTime, formatDateTimeSeconds, formatDateCustom, parseDate, getCurrentDate } from '@/lib/date-utils';\r\nimport { createCrudStore } from '../../lib/store-factory';\r\nimport type { SalesReturn, ReturnLineItem } from './types';\r\n// REMOVED: import { data as initialData } from './data'; // Mock data no longer used - database is source of truth\r\nimport { GHTKService, type GHTKCreateOrderParams } from '../settings/shipping/integrations/ghtk-service';\r\nimport { loadShippingConfig } from '../../lib/utils/shipping-config-migration';\r\nimport { toast } from 'sonner';\r\n\r\n// Other stores\r\nimport { useOrderStore } from '../orders/store';\r\nimport { useProductStore } from '../products/store';\r\nimport { useStockHistoryStore } from '../stock-history/store';\r\nimport { useCustomerStore } from '../customers/store';\r\nimport { createPaymentDocument, createReceiptDocument } from '../finance/document-helpers';\r\nimport { useShippingPartnerStore } from '../settings/shipping/store';\r\nimport { asBusinessId, asSystemId, type SystemId } from '../../lib/id-types';\r\nimport { isComboProduct } from '../products/combo-utils';\r\nimport { generateSystemId, getMaxSystemIdCounter } from '../../lib/id-utils';\r\n\r\n/**\r\n * ‚úÖ Helper: Expand combo return items to child products\r\n * When a combo is returned, we need to add stock back to child products\r\n */\r\nconst getReturnStockItems = (returnItems: ReturnLineItem[]) => {\r\n    const { findById } = useProductStore.getState();\r\n    const expandedItems: { productSystemId: SystemId; productName: string; quantity: number }[] = [];\r\n    \r\n    returnItems.forEach(item => {\r\n        const product = findById(item.productSystemId);\r\n        if (product && isComboProduct(product) && product.comboItems) {\r\n            // Combo ‚Üí expand to child products\r\n            product.comboItems.forEach(comboItem => {\r\n                const childProduct = findById(comboItem.productSystemId);\r\n                expandedItems.push({\r\n                    productSystemId: comboItem.productSystemId,\r\n                    productName: childProduct?.name || 'SP kh√¥ng x√°c ƒë·ªãnh',\r\n                    quantity: comboItem.quantity * item.returnQuantity\r\n                });\r\n            });\r\n        } else {\r\n            // Regular product\r\n            expandedItems.push({\r\n                productSystemId: asSystemId(item.productSystemId),\r\n                productName: item.productName,\r\n                quantity: item.returnQuantity\r\n            });\r\n        }\r\n    });\r\n    return expandedItems;\r\n};\r\n\r\nconst baseStore = createCrudStore<SalesReturn>([], 'sales-returns', {\r\n  apiEndpoint: '/api/sales-returns',\r\n});\r\n\r\nconst originalAdd = baseStore.getState().add;\r\n\r\nconst augmentedMethods = {\r\n  addWithSideEffects: (item: Omit<SalesReturn, 'systemId' | 'id'> & { creatorId: string }) => {\r\n    const orderSystemId = asSystemId(item.orderSystemId);\r\n    const orderBusinessId = asBusinessId(item.orderId);\r\n    const customerSystemId = asSystemId(item.customerSystemId);\r\n    const branchSystemId = asSystemId(item.branchSystemId);\r\n    const creatorSystemId = asSystemId(item.creatorSystemId ?? item.creatorId ?? 'SYSTEM');\r\n    const exchangeOrderSystemId = item.exchangeOrderSystemId ? asSystemId(item.exchangeOrderSystemId) : undefined;\r\n    const accountSystemId = item.accountSystemId ? asSystemId(item.accountSystemId) : undefined;\r\n    const paymentVoucherSystemId = item.paymentVoucherSystemId ? asSystemId(item.paymentVoucherSystemId) : undefined;\r\n    const paymentVoucherSystemIds = item.paymentVoucherSystemIds?.map(asSystemId);\r\n    const receiptVoucherSystemIds = item.receiptVoucherSystemIds?.map(asSystemId);\r\n\r\n    const formattedItems = item.items.map(lineItem => ({\r\n      ...lineItem,\r\n      productSystemId: asSystemId(lineItem.productSystemId),\r\n      productId: asBusinessId(lineItem.productId),\r\n    }));\r\n\r\n    const formattedPayments = item.payments?.map(payment => ({\r\n      ...payment,\r\n      accountSystemId: asSystemId(payment.accountSystemId),\r\n    }));\r\n\r\n    const formattedRefunds = item.refunds?.map(refund => ({\r\n      ...refund,\r\n      accountSystemId: asSystemId(refund.accountSystemId),\r\n    }));\r\n\r\n    const newItemData: Omit<SalesReturn, 'systemId'> = {\r\n      id: asBusinessId(''),\r\n      orderSystemId,\r\n      orderId: orderBusinessId,\r\n      customerSystemId,\r\n      customerName: item.customerName,\r\n      branchSystemId,\r\n      branchName: item.branchName,\r\n      returnDate: item.returnDate,\r\n      reason: item.reason,\r\n      note: item.note,\r\n      notes: item.notes,\r\n      reference: item.reference,\r\n      items: formattedItems,\r\n      totalReturnValue: item.totalReturnValue,\r\n      isReceived: item.isReceived,\r\n      exchangeItems: item.exchangeItems ?? [],\r\n      exchangeOrderSystemId,\r\n      subtotalNew: item.subtotalNew,\r\n      shippingFeeNew: item.shippingFeeNew,\r\n      discountNew: item.discountNew,\r\n      discountNewType: item.discountNewType,\r\n      grandTotalNew: item.grandTotalNew,\r\n      deliveryMethod: item.deliveryMethod,\r\n      shippingPartnerId: item.shippingPartnerId,\r\n      shippingServiceId: item.shippingServiceId,\r\n      shippingAddress: item.shippingAddress,\r\n      packageInfo: item.packageInfo,\r\n      configuration: item.configuration,\r\n      finalAmount: item.finalAmount,\r\n      refundMethod: item.refundMethod,\r\n      refundAmount: item.refundAmount,\r\n      accountSystemId,\r\n      refunds: formattedRefunds,\r\n      payments: formattedPayments,\r\n      paymentVoucherSystemId,\r\n      paymentVoucherSystemIds,\r\n      receiptVoucherSystemIds,\r\n      creatorSystemId,\r\n      creatorName: item.creatorName,\r\n    };\r\n\r\n    // --- Side Effects ---\r\n    const { update: updateOrder, findById: findOrderById, add: addOrder } = useOrderStore.getState();\r\n    const { updateInventory } = useProductStore.getState();\r\n    const { addEntry: addStockHistory } = useStockHistoryStore.getState();\r\n    const { updateDebt, incrementReturnStats } = useCustomerStore.getState();\r\n    const order = findOrderById(newItemData.orderSystemId);\r\n    if (!order) return { newReturn: null, newOrderSystemId: null };\r\n\r\n    // ‚úÖ IMPORTANT: Create the return FIRST to get IDs for exchange order\r\n    const newReturn = originalAdd(newItemData);\r\n    if (!newReturn) return { newReturn: null, newOrderSystemId: null };\r\n\r\n    // ‚úÖ Update customer return stats\r\n    const totalReturnQty = newItemData.items.reduce((sum, item) => sum + item.returnQuantity, 0);\r\n    if (totalReturnQty > 0) {\r\n        incrementReturnStats(newItemData.customerSystemId, totalReturnQty);\r\n    }\r\n\r\n    let newOrderSystemId: SystemId | undefined;\r\n\r\n    // Create a new sales order for the exchange items\r\n    if (newItemData.exchangeItems && newItemData.exchangeItems.length > 0) {\r\n        console.log('üîÑ [Sales Return] Creating exchange order...', {\r\n        exchangeItems: newItemData.exchangeItems,\r\n        finalAmount: newItemData.finalAmount,\r\n        payments: newItemData.payments,\r\n        });\r\n        \r\n      // ‚úÖ Calculate payments for exchange order based on sales return logic\r\n      const exchangeOrderPayments =\r\n        newItemData.finalAmount > 0 && newItemData.payments\r\n        ? newItemData.payments.map(p => ({\r\n          method: p.method,\r\n          accountSystemId: p.accountSystemId,\r\n          amount: p.amount,\r\n          }))\r\n        : [];\r\n        // If company refunded customer (finalAmount < 0)\r\n        // The exchange order will have COD = grandTotal (shipper collects on delivery)\r\n        // No payments array needed - will be handled by COD in shipping\r\n        \r\n        // ‚úÖ Determine status and packagings based on delivery method\r\n        let finalMainStatus: 'ƒê·∫∑t h√†ng' | 'ƒêang giao d·ªãch' = 'ƒê·∫∑t h√†ng';\r\n        let finalDeliveryStatus: string = 'Ch·ªù ƒë√≥ng g√≥i';\r\n        const packagings: any[] = [];\r\n        const now = formatDateCustom(getCurrentDate(), 'yyyy-MM-dd HH:mm');\r\n        \r\n        // ‚úÖ Helper to get next packaging systemId\r\n        const PACKAGING_SYSTEM_ID_PREFIX = 'PACKAGE';\r\n        const allOrders = useOrderStore.getState().data;\r\n        const allPackagings = allOrders.flatMap(o => o.packagings || []);\r\n        const maxPackagingCounter = getMaxSystemIdCounter(allPackagings, PACKAGING_SYSTEM_ID_PREFIX);\r\n        let packagingCounter = maxPackagingCounter;\r\n        const getNextPackagingSystemId = () => {\r\n            packagingCounter++;\r\n            return asSystemId(generateSystemId('packaging', packagingCounter));\r\n        };\r\n        \r\n        // Check if using shipping partner or pickup\r\n      const isPickup = newItemData.deliveryMethod === 'pickup';\r\n      const isShippingPartner = newItemData.shippingPartnerId && newItemData.shippingServiceId;\r\n        \r\n        if (isPickup) {\r\n            // Nh·∫≠n t·∫°i c·ª≠a h√†ng - T·∫°o packaging request ngay\r\n            finalMainStatus = 'ƒêang giao d·ªãch';\r\n            finalDeliveryStatus = 'Ch·ªù ƒë√≥ng g√≥i';\r\n            packagings.push({\r\n                systemId: getNextPackagingSystemId(), // ‚úÖ Use proper format PACKAGE000001\r\n                id: '',\r\n                requestDate: now,\r\n          requestingEmployeeId: creatorSystemId,\r\n          requestingEmployeeName: newItemData.creatorName,\r\n                status: 'Ch·ªù ƒë√≥ng g√≥i',\r\n                printStatus: 'Ch∆∞a in',\r\n                deliveryStatus: 'Ch·ªù ƒë√≥ng g√≥i',\r\n            });\r\n        } else if (isShippingPartner) {\r\n            // ƒê·∫©y qua h√£ng v·∫≠n chuy·ªÉn - T·∫°o packaging ƒë√£ ƒë√≥ng g√≥i v·ªõi tracking\r\n            finalMainStatus = 'ƒêang giao d·ªãch';\r\n            finalDeliveryStatus = 'Ch·ªù l·∫•y h√†ng';\r\n            \r\n            // Get partner info\r\n            const { data: partners } = useShippingPartnerStore.getState();\r\n            const partner = partners.find(p => p.systemId === newItemData.shippingPartnerId);\r\n            const service = partner?.services.find(s => s.id === newItemData.shippingServiceId);\r\n            \r\n            packagings.push({\r\n                systemId: getNextPackagingSystemId(), // ‚úÖ Use proper format PACKAGE000001\r\n                id: '',\r\n                requestDate: now,\r\n                confirmDate: now,\r\n              requestingEmployeeId: creatorSystemId,\r\n              requestingEmployeeName: newItemData.creatorName,\r\n              confirmingEmployeeId: creatorSystemId,\r\n              confirmingEmployeeName: newItemData.creatorName,\r\n                status: 'ƒê√£ ƒë√≥ng g√≥i',\r\n                deliveryStatus: 'Ch·ªù l·∫•y h√†ng',\r\n                printStatus: 'Ch∆∞a in',\r\n                deliveryMethod: 'D·ªãch v·ª• giao h√†ng',\r\n                carrier: partner?.name,\r\n                service: service?.name,\r\n              trackingCode: newItemData.packageInfo?.trackingCode || `VC${Date.now()}`,\r\n              shippingFeeToPartner: newItemData.shippingFeeNew,\r\n                codAmount: 0, // Will be calculated based on payments\r\n                payer: 'Ng∆∞·ªùi nh·∫≠n',\r\n              weight: newItemData.packageInfo?.weight,\r\n              dimensions: newItemData.packageInfo?.dimensions,\r\n            });\r\n        }\r\n        // else: deliver-later ‚Üí keep default 'ƒê·∫∑t h√†ng', 'Ch·ªù ƒë√≥ng g√≥i', no packagings\r\n        \r\n        const newOrderPayload = {\r\n            id: '', // ‚úÖ Empty string triggers auto-generation of business ID (DH...)\r\n            customerSystemId: order.customerSystemId,\r\n            customerName: order.customerName,\r\n            branchSystemId: order.branchSystemId, // ‚úÖ Use systemId only\r\n            branchName: order.branchName,\r\n            salespersonId: creatorSystemId,\r\n            salesperson: newItemData.creatorName,\r\n            orderDate: formatDateCustom(getCurrentDate(), 'yyyy-MM-dd HH:mm'),\r\n            lineItems: newItemData.exchangeItems,\r\n            subtotal: newItemData.subtotalNew,\r\n            shippingFee: newItemData.shippingFeeNew,\r\n            tax: 0,\r\n            // ‚úÖ IMPORTANT: grandTotal should be NET amount (after subtracting return value)\r\n            // grandTotal = subtotalNew + shippingFee - totalReturnValue\r\n            grandTotal: newItemData.finalAmount > 0 ? newItemData.finalAmount : newItemData.grandTotalNew,\r\n            // ‚úÖ Store return value info for display\r\n            linkedSalesReturnId: newReturn.id, // ‚úÖ Fixed: Use newReturn.id (business ID)\r\n            linkedSalesReturnSystemId: newReturn.systemId, // ‚úÖ Add systemId for linking\r\n            linkedSalesReturnValue: newItemData.totalReturnValue, // Value of returned items\r\n            payments: exchangeOrderPayments, // ‚úÖ Set payments based on sales return scenario\r\n            notes: `ƒê∆°n h√†ng ƒë·ªïi t·ª´ phi·∫øu tr·∫£ ${newReturn.id} c·ªßa ƒë∆°n h√†ng ${order.id}`, // ‚úÖ Fixed: Use newReturn.id\r\n            sourceSalesReturnId: newReturn.id, // ‚úÖ Fixed: Use newReturn.id\r\n            // ‚úÖ Pass shipping info from form\r\n            deliveryMethod: newItemData.deliveryMethod === 'pickup' ? 'Nh·∫≠n t·∫°i c·ª≠a h√†ng' : 'D·ªãch v·ª• giao h√†ng',\r\n            shippingPartnerId: newItemData.shippingPartnerId,\r\n            shippingServiceId: newItemData.shippingServiceId,\r\n            shippingAddress: newItemData.shippingAddress,\r\n            packageInfo: newItemData.packageInfo,\r\n            configuration: newItemData.configuration,\r\n            // ‚úÖ Add required status fields based on delivery method\r\n            status: finalMainStatus,\r\n            paymentStatus: exchangeOrderPayments.length > 0 ? \r\n              (exchangeOrderPayments.reduce((sum, p) => sum + p.amount, 0) >= newItemData.grandTotalNew ? 'Thanh to√°n to√†n b·ªô' : 'Thanh to√°n 1 ph·∫ßn') \r\n                : 'Ch∆∞a thanh to√°n' as const,\r\n            deliveryStatus: finalDeliveryStatus,\r\n            printStatus: 'Ch∆∞a in' as const,\r\n            stockOutStatus: 'Ch∆∞a xu·∫•t kho' as const,\r\n            returnStatus: 'Ch∆∞a tr·∫£ h√†ng' as const,\r\n            codAmount: 0, // Will be calculated by ShippingIntegration based on payments\r\n            packagings: packagings,\r\n        };\r\n        \r\n        console.log('üì¶ [Sales Return] New order payload:', newOrderPayload);\r\n        \r\n        const newOrder = addOrder(newOrderPayload as any);\r\n        \r\n        console.log('‚úÖ [Sales Return] New order created:', newOrder);\r\n        \r\n        if (newOrder) {\r\n          newOrderSystemId = asSystemId(newOrder.systemId);\r\n          // ‚úÖ Save exchange order systemId to sales return\r\n          (newItemData as SalesReturn).exchangeOrderSystemId = newOrderSystemId;\r\n            \r\n            console.log('üéâ [Sales Return] Exchange order systemId:', newOrderSystemId);\r\n        } else {\r\n            console.error('‚ùå [Sales Return] Failed to create exchange order!');\r\n        }\r\n    }\r\n\r\n    // Adjust customer debt if needed\r\n    const creditAmount = newItemData.totalReturnValue - newItemData.grandTotalNew - (newItemData.refundAmount || 0);\r\n    if (creditAmount > 0) {\r\n      updateDebt(newItemData.customerSystemId, -creditAmount);\r\n    }\r\n    \r\n    // ‚úÖ newReturn already created above, use it directly\r\n    // ‚úÖ NOW create vouchers with correct originalDocumentId\r\n    // Handle Financials AFTER creating the return\r\n    const finalAmount = newItemData.finalAmount;\r\n\r\n    if (finalAmount < 0 && newItemData.refunds && newItemData.refunds.length > 0) {\r\n      const createdVoucherIds: SystemId[] = [];\r\n\r\n      newItemData.refunds.forEach(refund => {\r\n        if (!refund.amount || refund.amount <= 0) {\r\n          return;\r\n        }\r\n\r\n        const { document, error } = createPaymentDocument({\r\n          amount: refund.amount,\r\n          description: `Ho√†n ti·ªÅn ƒë·ªïi/tr·∫£ h√†ng t·ª´ ƒë∆°n ${order.id} (Phi·∫øu: ${newReturn.id}) qua ${refund.method}`,\r\n          recipientName: newItemData.customerName,\r\n          recipientSystemId: newItemData.customerSystemId,\r\n          customerSystemId: newItemData.customerSystemId,\r\n          customerName: newItemData.customerName,\r\n          paymentMethodName: refund.method,\r\n          accountSystemId: refund.accountSystemId,\r\n          paymentTypeName: 'Ho√†n ti·ªÅn kh√°ch h√†ng',\r\n          branchSystemId: newReturn.branchSystemId,\r\n          branchName: newReturn.branchName,\r\n          createdBy: creatorSystemId,\r\n          originalDocumentId: newReturn.id,\r\n          linkedSalesReturnSystemId: newReturn.systemId,\r\n          linkedOrderSystemId: newReturn.orderSystemId,\r\n          category: 'complaint_refund',\r\n          affectsDebt: true, // ‚úÖ Ho√†n ti·ªÅn kh√°ch h√†ng ·∫£nh h∆∞·ªüng c√¥ng n·ª£ (gi·∫£m c√¥ng n·ª£)\r\n        });\r\n\r\n        if (error) {\r\n          console.error('[Sales Return] Failed to create payment voucher:', error);\r\n          toast.error(`Kh√¥ng th·ªÉ t·∫°o phi·∫øu chi ho√†n ti·ªÅn: ${error}`);\r\n          return;\r\n        }\r\n\r\n        if (document) {\r\n          createdVoucherIds.push(asSystemId(document.systemId));\r\n        }\r\n      });\r\n\r\n      if (createdVoucherIds.length > 0) {\r\n        baseStore.getState().update(newReturn.systemId, {\r\n          ...newReturn,\r\n          paymentVoucherSystemIds: createdVoucherIds,\r\n        });\r\n      }\r\n    } else if (finalAmount > 0 && newItemData.payments && newItemData.payments.length > 0) {\r\n      const createdVoucherIds: SystemId[] = [];\r\n\r\n      newItemData.payments.forEach(payment => {\r\n        if (!payment.amount || payment.amount <= 0) {\r\n          return;\r\n        }\r\n\r\n        const { document, error } = createReceiptDocument({\r\n          amount: payment.amount,\r\n          description: `Thu ti·ªÅn ch√™nh l·ªách ƒë·ªïi h√†ng t·ª´ ƒë∆°n ${order.id} (Phi·∫øu: ${newReturn.id})`,\r\n          customerName: newReturn.customerName,\r\n          customerSystemId: newItemData.customerSystemId,\r\n          paymentMethodName: payment.method,\r\n          accountSystemId: payment.accountSystemId,\r\n          receiptTypeName: 'Thanh to√°n cho ƒë∆°n h√†ng',\r\n          branchSystemId: newReturn.branchSystemId,\r\n          branchName: newReturn.branchName,\r\n          createdBy: creatorSystemId,\r\n          originalDocumentId: newReturn.id,\r\n          linkedSalesReturnSystemId: newReturn.systemId,\r\n          linkedOrderSystemId: newReturn.orderSystemId,\r\n          category: 'sale',\r\n          affectsDebt: false,\r\n        });\r\n\r\n        if (error) {\r\n          console.error('[Sales Return] Failed to create receipt voucher:', error);\r\n          toast.error(`Kh√¥ng th·ªÉ t·∫°o phi·∫øu thu ƒë·ªïi h√†ng: ${error}`);\r\n          return;\r\n        }\r\n\r\n        if (document) {\r\n          createdVoucherIds.push(asSystemId(document.systemId));\r\n        }\r\n      });\r\n\r\n      if (createdVoucherIds.length > 0) {\r\n        baseStore.getState().update(newReturn.systemId, {\r\n          ...newReturn,\r\n          receiptVoucherSystemIds: createdVoucherIds,\r\n        });\r\n      }\r\n    }\r\n\r\n    // ‚úÖ Update inventory for returned items ONLY if isReceived = true\r\n    // ‚úÖ For combo products, add stock to child products instead\r\n    if (newReturn.isReceived) {\r\n        console.log('‚úÖ [Sales Return] Updating inventory - items received');\r\n        \r\n        // Expand combo items to child products\r\n        const stockItems = getReturnStockItems(newReturn.items);\r\n        \r\n        stockItems.forEach(item => {\r\n          if (item.quantity > 0) {\r\n            const product = useProductStore.getState().findById(item.productSystemId);\r\n            const oldStock = product?.inventoryByBranch[newReturn.branchSystemId] || 0;\r\n            updateInventory(item.productSystemId, newReturn.branchSystemId, item.quantity); // Add stock back\r\n            addStockHistory({\r\n              productId: item.productSystemId,\r\n              date: getCurrentDate().toISOString(),\r\n              employeeName: newReturn.creatorName,\r\n              action: 'Nh·∫≠p h√†ng t·ª´ kh√°ch tr·∫£',\r\n              quantityChange: item.quantity,\r\n              newStockLevel: oldStock + item.quantity,\r\n              documentId: newReturn.id, // ‚úÖ Use business ID for document reference\r\n              branchSystemId: newReturn.branchSystemId,\r\n              branch: newReturn.branchName,\r\n            });\r\n          }\r\n        });\r\n    } else {\r\n        console.log('‚è∏Ô∏è [Sales Return] Inventory NOT updated - waiting for receipt confirmation');\r\n    }\r\n\r\n    // Update original order's return status\r\n    const previousReturnsForOrder = baseStore.getState().data.filter(r => r.orderSystemId === order.systemId);\r\n    const totalReturnedQty = previousReturnsForOrder.flatMap(r => r.items).reduce((sum, item) => sum + item.returnQuantity, 0);\r\n    const totalOrderedQty = order.lineItems.reduce((sum, item) => sum + item.quantity, 0);\r\n    const newReturnStatus = totalReturnedQty >= totalOrderedQty ? 'Tr·∫£ h√†ng to√†n b·ªô' : 'Tr·∫£ h√†ng m·ªôt ph·∫ßn';\r\n    updateOrder(order.systemId, { ...order, returnStatus: newReturnStatus });\r\n    \r\n    return { newReturn, newOrderSystemId };\r\n  },\r\n  \r\n  /**\r\n   * ‚úÖ Confirm receipt of returned items and update inventory\r\n   * Use this when isReceived was false initially and items are now received\r\n   * ‚úÖ For combo products, add stock to child products instead\r\n   */\r\n  confirmReceipt: (returnSystemId: SystemId) => {\r\n    const salesReturn = baseStore.getState().findById(returnSystemId);\r\n    if (!salesReturn) {\r\n      console.error('‚ùå [Sales Return] Return not found:', returnSystemId);\r\n      return { success: false, message: 'Kh√¥ng t√¨m th·∫•y phi·∫øu tr·∫£ h√†ng' };\r\n    }\r\n    \r\n    if (salesReturn.isReceived) {\r\n      console.warn('‚ö†Ô∏è [Sales Return] Already received:', returnSystemId);\r\n      return { success: false, message: 'H√†ng ƒë√£ ƒë∆∞·ª£c nh·∫≠n tr∆∞·ªõc ƒë√≥' };\r\n    }\r\n    \r\n    const { updateInventory } = useProductStore.getState();\r\n    const { addEntry: addStockHistory } = useStockHistoryStore.getState();\r\n    \r\n    // ‚úÖ Expand combo items to child products\r\n    const stockItems = getReturnStockItems(salesReturn.items);\r\n    \r\n    // Update inventory for all returned items (including expanded combo children)\r\n    stockItems.forEach(item => {\r\n      if (item.quantity > 0) {\r\n        const product = useProductStore.getState().findById(item.productSystemId);\r\n        const oldStock = product?.inventoryByBranch[salesReturn.branchSystemId] || 0;\r\n        updateInventory(item.productSystemId, salesReturn.branchSystemId, item.quantity);\r\n        addStockHistory({\r\n          productId: item.productSystemId,\r\n          date: getCurrentDate().toISOString(),\r\n          employeeName: salesReturn.creatorName,\r\n          action: 'Nh·∫≠p h√†ng t·ª´ kh√°ch tr·∫£ (x√°c nh·∫≠n)',\r\n          quantityChange: item.quantity,\r\n          newStockLevel: oldStock + item.quantity,\r\n          documentId: salesReturn.id,\r\n          branchSystemId: salesReturn.branchSystemId,\r\n          branch: salesReturn.branchName,\r\n        });\r\n      }\r\n    });\r\n    \r\n    // Update the return record\r\n    baseStore.getState().update(returnSystemId, {\r\n      ...salesReturn,\r\n      isReceived: true,\r\n    });\r\n    \r\n    console.log('‚úÖ [Sales Return] Receipt confirmed and inventory updated:', returnSystemId);\r\n    return { success: true, message: 'ƒê√£ x√°c nh·∫≠n nh·∫≠n h√†ng v√† c·∫≠p nh·∫≠t t·ªìn kho' };\r\n  },\r\n};\r\n\r\n// Export typed hook\r\nexport const useSalesReturnStore = (): any => {\r\n  const state = baseStore();\r\n  return {\r\n    ...state,\r\n    ...augmentedMethods,\r\n  };\r\n};\r\n\r\n// Export getState for non-hook usage\r\nuseSalesReturnStore.getState = (): any => {\r\n  const state = baseStore.getState();\r\n  return {\r\n    ...state,\r\n    ...augmentedMethods,\r\n  };\r\n};\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 4012, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/shipments/store.ts"],"sourcesContent":["/**\r\n * Shipment Store - Entity ri√™ng cho v·∫≠n ƒë∆°n\r\n * \r\n * ‚ö†Ô∏è ID Format theo ID-GOVERNANCE.md:\r\n * - SystemId: SHIPMENT000001\r\n * - BusinessId: VC000001\r\n * \r\n * Relationship: Shipment 1:1 Packaging (via packagingSystemId)\r\n */\r\n\r\nimport { create } from 'zustand';\r\nimport type { SystemId, BusinessId } from '../../lib/id-types';\r\nimport { asSystemId, asBusinessId } from '../../lib/id-types';\r\nimport { generateSystemId, generateBusinessId, getMaxSystemIdCounter, getMaxBusinessIdCounter } from '../../lib/id-utils';\r\nimport type { Shipment } from './types';\r\n\r\n// ========================================\r\n// CONSTANTS\r\n// ========================================\r\n\r\nconst SHIPMENT_SYSTEM_ID_PREFIX = 'SHIPMENT';\r\nconst SHIPMENT_BUSINESS_ID_PREFIX = 'VC';\r\n\r\n// ========================================\r\n// INITIAL SEED DATA\r\n// ========================================\r\n\r\nconst initialData: Shipment[] = [\r\n    {\r\n        systemId: asSystemId('SHIPMENT000001'),\r\n        id: asBusinessId('VC000001'),\r\n        packagingSystemId: asSystemId('PACKAGE000001'),\r\n        orderSystemId: asSystemId('ORDER000001'),\r\n        orderId: asBusinessId('DH000001'),\r\n        trackingCode: 'GHN000001',\r\n        carrier: 'GHN',\r\n        service: 'Chu·∫©n',\r\n        deliveryStatus: 'ƒê√£ giao h√†ng',\r\n        printStatus: 'ƒê√£ in',\r\n        reconciliationStatus: 'ƒê√£ ƒë·ªëi so√°t',\r\n        shippingFeeToPartner: 25000,\r\n        codAmount: 0,\r\n        payer: 'Ng∆∞·ªùi g·ª≠i',\r\n        createdAt: '2025-11-01 08:30',\r\n        dispatchedAt: '2025-11-02 08:00',\r\n        deliveredAt: '2025-11-05 15:30',\r\n    },\r\n    {\r\n        systemId: asSystemId('SHIPMENT000002'),\r\n        id: asBusinessId('VC000002'),\r\n        packagingSystemId: asSystemId('PACKAGE000002'),\r\n        orderSystemId: asSystemId('ORDER000002'),\r\n        orderId: asBusinessId('DH000002'),\r\n        trackingCode: 'JT000245',\r\n        carrier: 'J&T Express',\r\n        service: 'G√≥i chu·∫©n',\r\n        deliveryStatus: 'ƒêang giao h√†ng',\r\n        printStatus: 'ƒê√£ in',\r\n        reconciliationStatus: 'Ch∆∞a ƒë·ªëi so√°t',\r\n        shippingFeeToPartner: 30000,\r\n        codAmount: 5000000,\r\n        payer: 'Ng∆∞·ªùi nh·∫≠n',\r\n        createdAt: '2025-11-03 16:00',\r\n        dispatchedAt: '2025-11-04 09:00',\r\n    },\r\n    // Th√™m d·ªØ li·ªáu m·∫´u m·ªõi\r\n    {\r\n        systemId: asSystemId('SHIPMENT000003'),\r\n        id: asBusinessId('VC000003'),\r\n        packagingSystemId: asSystemId('PACKAGE000005'),\r\n        orderSystemId: asSystemId('ORDER000005'),\r\n        orderId: asBusinessId('DH000005'),\r\n        trackingCode: 'GHTK123456',\r\n        carrier: 'GHTK',\r\n        service: 'Nhanh',\r\n        deliveryStatus: 'ƒê√£ giao h√†ng',\r\n        printStatus: 'ƒê√£ in',\r\n        reconciliationStatus: 'Ch∆∞a ƒë·ªëi so√°t',\r\n        shippingFeeToPartner: 35000,\r\n        codAmount: 12500000,\r\n        payer: 'Ng∆∞·ªùi nh·∫≠n',\r\n        createdAt: '2025-11-08 10:00',\r\n        dispatchedAt: '2025-11-08 14:00',\r\n        deliveredAt: '2025-11-10 11:30',\r\n    },\r\n    {\r\n        systemId: asSystemId('SHIPMENT000004'),\r\n        id: asBusinessId('VC000004'),\r\n        packagingSystemId: asSystemId('PACKAGE000006'),\r\n        orderSystemId: asSystemId('ORDER000006'),\r\n        orderId: asBusinessId('DH000006'),\r\n        trackingCode: 'VTP789012',\r\n        carrier: 'Viettel Post',\r\n        service: 'Ti√™u chu·∫©n',\r\n        deliveryStatus: 'ƒêang giao h√†ng',\r\n        printStatus: 'ƒê√£ in',\r\n        reconciliationStatus: 'Ch∆∞a ƒë·ªëi so√°t',\r\n        shippingFeeToPartner: 28000,\r\n        codAmount: 8900000,\r\n        payer: 'Ng∆∞·ªùi nh·∫≠n',\r\n        createdAt: '2025-11-09 09:15',\r\n        dispatchedAt: '2025-11-09 15:30',\r\n    },\r\n    {\r\n        systemId: asSystemId('SHIPMENT000005'),\r\n        id: asBusinessId('VC000005'),\r\n        packagingSystemId: asSystemId('PACKAGE000007'),\r\n        orderSystemId: asSystemId('ORDER000007'),\r\n        orderId: asBusinessId('DH000007'),\r\n        trackingCode: 'GHN345678',\r\n        carrier: 'GHN',\r\n        service: 'Express',\r\n        deliveryStatus: 'ƒê√£ giao h√†ng',\r\n        printStatus: 'ƒê√£ in',\r\n        reconciliationStatus: 'Ch∆∞a ƒë·ªëi so√°t',\r\n        shippingFeeToPartner: 45000,\r\n        codAmount: 23800000,\r\n        payer: 'Ng∆∞·ªùi nh·∫≠n',\r\n        createdAt: '2025-11-07 08:00',\r\n        dispatchedAt: '2025-11-07 10:00',\r\n        deliveredAt: '2025-11-08 09:30',\r\n    },\r\n    {\r\n        systemId: asSystemId('SHIPMENT000006'),\r\n        id: asBusinessId('VC000006'),\r\n        packagingSystemId: asSystemId('PACKAGE000008'),\r\n        orderSystemId: asSystemId('ORDER000008'),\r\n        orderId: asBusinessId('DH000008'),\r\n        trackingCode: 'BEST567890',\r\n        carrier: 'Best Express',\r\n        service: 'Ti·∫øt ki·ªám',\r\n        deliveryStatus: 'Ch·ªù l·∫•y h√†ng',\r\n        printStatus: 'ƒê√£ in',\r\n        reconciliationStatus: 'Ch∆∞a ƒë·ªëi so√°t',\r\n        shippingFeeToPartner: 22000,\r\n        codAmount: 4500000,\r\n        payer: 'Ng∆∞·ªùi nh·∫≠n',\r\n        createdAt: '2025-11-10 07:30',\r\n    },\r\n    {\r\n        systemId: asSystemId('SHIPMENT000007'),\r\n        id: asBusinessId('VC000007'),\r\n        packagingSystemId: asSystemId('PACKAGE000009'),\r\n        orderSystemId: asSystemId('ORDER000009'),\r\n        orderId: asBusinessId('DH000009'),\r\n        trackingCode: 'NJV901234',\r\n        carrier: 'Ninja Van',\r\n        service: 'Standard',\r\n        deliveryStatus: 'ƒê√£ giao h√†ng',\r\n        printStatus: 'ƒê√£ in',\r\n        reconciliationStatus: 'ƒê√£ ƒë·ªëi so√°t',\r\n        shippingFeeToPartner: 32000,\r\n        codAmount: 15600000,\r\n        payer: 'Ng∆∞·ªùi g·ª≠i',\r\n        createdAt: '2025-11-05 11:00',\r\n        dispatchedAt: '2025-11-05 16:00',\r\n        deliveredAt: '2025-11-07 14:30',\r\n    },\r\n    {\r\n        systemId: asSystemId('SHIPMENT000008'),\r\n        id: asBusinessId('VC000008'),\r\n        packagingSystemId: asSystemId('PACKAGE000010'),\r\n        orderSystemId: asSystemId('ORDER000010'),\r\n        orderId: asBusinessId('DH000010'),\r\n        trackingCode: 'JT567891',\r\n        carrier: 'J&T Express',\r\n        service: 'Si√™u t·ªëc',\r\n        deliveryStatus: 'ƒêang giao h√†ng',\r\n        printStatus: 'ƒê√£ in',\r\n        reconciliationStatus: 'Ch∆∞a ƒë·ªëi so√°t',\r\n        shippingFeeToPartner: 55000,\r\n        codAmount: 31200000,\r\n        payer: 'Ng∆∞·ªùi nh·∫≠n',\r\n        createdAt: '2025-11-10 14:00',\r\n        dispatchedAt: '2025-11-10 16:30',\r\n    },\r\n];\r\n\r\n// ========================================\r\n// STORE INTERFACE\r\n// ========================================\r\n\r\nexport interface ShipmentStoreState {\r\n    data: Shipment[];\r\n    \r\n    // CRUD\r\n    findById: (systemId: string) => Shipment | undefined;\r\n    findByPackagingSystemId: (packagingSystemId: string) => Shipment | undefined;\r\n    findByTrackingCode: (trackingCode: string) => Shipment | undefined;\r\n    \r\n    // Actions\r\n    createShipment: (data: Omit<Shipment, 'systemId' | 'id'>) => Shipment;\r\n    updateShipment: (systemId: SystemId, updates: Partial<Shipment>) => void;\r\n    deleteShipment: (systemId: SystemId) => void;\r\n    \r\n    // Counters\r\n    getNextSystemId: () => SystemId;\r\n    getNextBusinessId: () => BusinessId;\r\n}\r\n\r\n// ========================================\r\n// HELPER FUNCTIONS\r\n// ========================================\r\n\r\nlet shipmentSystemIdCounter = 0;\r\nlet shipmentBusinessIdCounter = 0;\r\n\r\nfunction initCounters(shipments: Shipment[]) {\r\n    shipmentSystemIdCounter = getMaxSystemIdCounter(shipments, SHIPMENT_SYSTEM_ID_PREFIX);\r\n    shipmentBusinessIdCounter = getMaxBusinessIdCounter(shipments, SHIPMENT_BUSINESS_ID_PREFIX);\r\n}\r\n\r\nfunction getNextShipmentSystemId(): SystemId {\r\n    shipmentSystemIdCounter++;\r\n    return generateSystemId('shipments', shipmentSystemIdCounter) as SystemId;\r\n}\r\n\r\nfunction getNextShipmentBusinessId(): BusinessId {\r\n    shipmentBusinessIdCounter++;\r\n    return generateBusinessId('shipments', shipmentBusinessIdCounter) as BusinessId;\r\n}\r\n\r\n// Initialize counters\r\ninitCounters(initialData);\r\n\r\n// ========================================\r\n// STORE CREATION\r\n// ========================================\r\n\r\nexport const useShipmentStore = create<ShipmentStoreState>()(\r\n    (set, get) => ({\r\n            data: initialData,\r\n            \r\n            findById: (systemId: string) => {\r\n                return get().data.find(s => s.systemId === systemId);\r\n            },\r\n            \r\n            findByPackagingSystemId: (packagingSystemId: string) => {\r\n                return get().data.find(s => s.packagingSystemId === packagingSystemId);\r\n            },\r\n            \r\n            findByTrackingCode: (trackingCode: string) => {\r\n                return get().data.find(s => s.trackingCode === trackingCode);\r\n            },\r\n            \r\n            createShipment: (data: Omit<Shipment, 'systemId' | 'id'>) => {\r\n                const newShipment: Shipment = {\r\n                    systemId: getNextShipmentSystemId(),\r\n                    id: getNextShipmentBusinessId(),\r\n                    ...data,\r\n                };\r\n                \r\n                set(state => ({\r\n                    data: [...state.data, newShipment]\r\n                }));\r\n                \r\n                return newShipment;\r\n            },\r\n            \r\n            updateShipment: (systemId: SystemId, updates: Partial<Shipment>) => {\r\n                set(state => ({\r\n                    data: state.data.map(s => \r\n                        s.systemId === systemId \r\n                            ? { ...s, ...updates }\r\n                            : s\r\n                    )\r\n                }));\r\n            },\r\n            \r\n            deleteShipment: (systemId: SystemId) => {\r\n                set(state => ({\r\n                    data: state.data.filter(s => s.systemId !== systemId)\r\n                }));\r\n            },\r\n            \r\n            getNextSystemId: () => getNextShipmentSystemId(),\r\n            getNextBusinessId: () => getNextShipmentBusinessId(),\r\n        })\r\n);\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 4252, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/reconciliation/columns.tsx"],"sourcesContent":["import * as React from 'react';\r\nimport Link from 'next/link';\r\nimport { formatDate, formatDateTime, formatDateTimeSeconds, formatDateCustom, parseDate, getCurrentDate } from '@/lib/date-utils';\r\nimport type { ReconciliationItem } from './page';\r\nimport type { ColumnDef } from '../../components/data-table/types';\r\nimport { Checkbox } from '../../components/ui/checkbox';\r\nimport { Badge } from '../../components/ui/badge';\r\nconst formatCurrency = (value?: number) => {\r\n    if (typeof value !== 'number' || isNaN(value)) return '-';\r\n    return new Intl.NumberFormat('vi-VN').format(value);\r\n};\r\n\r\n\r\n\r\nexport const getColumns = (): ColumnDef<ReconciliationItem>[] => [\r\n    {\r\n      id: \"select\",\r\n      header: ({ isAllPageRowsSelected, isSomePageRowsSelected, onToggleAll }) => (\r\n        <Checkbox\r\n          checked={isAllPageRowsSelected ? true : isSomePageRowsSelected ? \"indeterminate\" : false}\r\n          onCheckedChange={(value) => onToggleAll?.(!!value)}\r\n          aria-label=\"Select all\"\r\n        />\r\n      ),\r\n      cell: ({ isSelected, onToggleSelect }) => (\r\n        <Checkbox\r\n          checked={isSelected}\r\n          onCheckedChange={onToggleSelect}\r\n          aria-label=\"Select row\"\r\n        />\r\n      ),\r\n      size: 60,\r\n      meta: { displayName: \"Ch·ªçn\", sticky: \"left\" },\r\n    },\r\n    { id: 'trackingCode', accessorKey: 'trackingCode', header: 'M√£ v·∫≠n ƒë∆°n', cell: ({ row }) => <span className=\"font-mono\">{row.trackingCode || '-'}</span>, meta: { displayName: 'M√£ v·∫≠n ƒë∆°n' } },\r\n    { id: 'orderId', accessorKey: 'orderId', header: 'M√£ ƒë∆°n h√†ng', cell: ({ row }) => <Link href={`/orders/${row.orderSystemId}`} className=\"text-primary hover:underline\">{row.orderId}</Link>, meta: { displayName: 'M√£ ƒë∆°n h√†ng' } },\r\n    { id: 'customerName', accessorKey: 'customerName', header: 'Kh√°ch h√†ng', cell: ({ row }) => row.customerName, meta: { displayName: 'Kh√°ch h√†ng' } },\r\n    { id: 'deliveredDate', accessorKey: 'deliveredDate', header: 'Ng√†y giao', cell: ({ row }) => formatDate(row.deliveredDate), meta: { displayName: 'Ng√†y giao' } },\r\n    { id: 'carrier', accessorKey: 'carrier', header: 'ƒê·ªëi t√°c v·∫≠n chuy·ªÉn', cell: ({ row }) => row.carrier || '-', meta: { displayName: 'ƒê·ªëi t√°c v·∫≠n chuy·ªÉn' } },\r\n    { id: 'codAmount', accessorKey: 'codAmount', header: 'Ti·ªÅn thu h·ªô', cell: ({ row }) => <span className=\"font-semibold\">{formatCurrency(row.codAmount)}</span>, meta: { displayName: 'Ti·ªÅn thu h·ªô (COD)' } },\r\n    { id: 'reconciliationStatus', accessorKey: 'reconciliationStatus', header: 'Tr·∫°ng th√°i ƒë·ªëi so√°t', cell: ({ row }) => <Badge variant=\"secondary\">{row.reconciliationStatus || 'Ch∆∞a ƒë·ªëi so√°t'}</Badge>, meta: { displayName: 'Tr·∫°ng th√°i ƒë·ªëi so√°t' } },\r\n];\r\n"],"names":[],"mappings":";;;;;AACA;AACA;AAGA;AACA;;;;;;AACA,MAAM,iBAAiB,CAAC;IACpB,IAAI,OAAO,UAAU,YAAY,MAAM,QAAQ,OAAO;IACtD,OAAO,IAAI,KAAK,YAAY,CAAC,SAAS,MAAM,CAAC;AACjD;AAIO,MAAM,aAAa,IAAuC;QAC7D;YACE,IAAI;YACJ,QAAQ,CAAC,EAAE,qBAAqB,EAAE,sBAAsB,EAAE,WAAW,EAAE,iBACrE,8OAAC,yIAAQ;oBACP,SAAS,wBAAwB,OAAO,yBAAyB,kBAAkB;oBACnF,iBAAiB,CAAC,QAAU,cAAc,CAAC,CAAC;oBAC5C,cAAW;;;;;;YAGf,MAAM,CAAC,EAAE,UAAU,EAAE,cAAc,EAAE,iBACnC,8OAAC,yIAAQ;oBACP,SAAS;oBACT,iBAAiB;oBACjB,cAAW;;;;;;YAGf,MAAM;YACN,MAAM;gBAAE,aAAa;gBAAQ,QAAQ;YAAO;QAC9C;QACA;YAAE,IAAI;YAAgB,aAAa;YAAgB,QAAQ;YAAc,MAAM,CAAC,EAAE,GAAG,EAAE,iBAAK,8OAAC;oBAAK,WAAU;8BAAa,IAAI,YAAY,IAAI;;;;;;YAAa,MAAM;gBAAE,aAAa;YAAa;QAAE;QAC9L;YAAE,IAAI;YAAW,aAAa;YAAW,QAAQ;YAAe,MAAM,CAAC,EAAE,GAAG,EAAE,iBAAK,8OAAC,uKAAI;oBAAC,MAAM,CAAC,QAAQ,EAAE,IAAI,aAAa,EAAE;oBAAE,WAAU;8BAAgC,IAAI,OAAO;;;;;;YAAU,MAAM;gBAAE,aAAa;YAAc;QAAE;QACnO;YAAE,IAAI;YAAgB,aAAa;YAAgB,QAAQ;YAAc,MAAM,CAAC,EAAE,GAAG,EAAE,GAAK,IAAI,YAAY;YAAE,MAAM;gBAAE,aAAa;YAAa;QAAE;QAClJ;YAAE,IAAI;YAAiB,aAAa;YAAiB,QAAQ;YAAa,MAAM,CAAC,EAAE,GAAG,EAAE,GAAK,IAAA,kIAAU,EAAC,IAAI,aAAa;YAAG,MAAM;gBAAE,aAAa;YAAY;QAAE;QAC/J;YAAE,IAAI;YAAW,aAAa;YAAW,QAAQ;YAAsB,MAAM,CAAC,EAAE,GAAG,EAAE,GAAK,IAAI,OAAO,IAAI;YAAK,MAAM;gBAAE,aAAa;YAAqB;QAAE;QAC1J;YAAE,IAAI;YAAa,aAAa;YAAa,QAAQ;YAAe,MAAM,CAAC,EAAE,GAAG,EAAE,iBAAK,8OAAC;oBAAK,WAAU;8BAAiB,eAAe,IAAI,SAAS;;;;;;YAAW,MAAM;gBAAE,aAAa;YAAoB;QAAE;QAC1M;YAAE,IAAI;YAAwB,aAAa;YAAwB,QAAQ;YAAuB,MAAM,CAAC,EAAE,GAAG,EAAE,iBAAK,8OAAC,mIAAK;oBAAC,SAAQ;8BAAa,IAAI,oBAAoB,IAAI;;;;;;YAA0B,MAAM;gBAAE,aAAa;YAAsB;QAAE;KACvP"}},
    {"offset": {"line": 4394, "column": 0}, "map": {"version":3,"sources":["file:///D:/hrm2/features/reconciliation/page.tsx"],"sourcesContent":["import * as React from 'react';\r\nimport { usePageHeader } from '../../contexts/page-header-context';\r\nimport { useOrderStore } from '../orders/store';\r\nimport { useAllOrders } from '../orders/hooks/use-all-orders';\r\nimport type { Order, Packaging } from '../orders/types';\r\nimport { ResponsiveDataTable } from '../../components/data-table/responsive-data-table';\r\nimport { getColumns } from './columns';\r\nimport { Card, CardContent, CardTitle } from '../../components/ui/card';\r\nimport { PageToolbar } from '../../components/layout/page-toolbar';\r\nimport { PageFilters } from '../../components/layout/page-filters';\r\nimport { Button } from '../../components/ui/button';\r\nimport { CheckCircle2, Download } from 'lucide-react';\r\nimport Fuse from 'fuse.js';\r\nimport { AlertDialog, AlertDialogAction, AlertDialogCancel, AlertDialogContent, AlertDialogDescription, AlertDialogFooter, AlertDialogHeader, AlertDialogTitle } from '../../components/ui/alert-dialog';\r\nimport { DataTableColumnCustomizer } from '../../components/data-table/data-table-column-toggle';\r\nimport { GenericExportDialogV2 } from '../../components/shared/generic-export-dialog-v2';\r\nimport { reconciliationConfig } from '../../lib/import-export/configs/reconciliation.config';\r\nimport { asSystemId } from '../../lib/id-types';\r\nimport { Badge } from '../../components/ui/badge';\r\nimport { formatDate } from '../../lib/date-utils';\r\nimport { useAuth } from '../../contexts/auth-context';\r\nimport { useBreakpoint } from '../../contexts/breakpoint-context';\r\nimport { ROUTES } from '../../lib/router';\r\nimport { useColumnVisibility } from '../../hooks/use-column-visibility';\r\n\r\nconst formatCurrency = (value?: number) => {\r\n    if (typeof value !== 'number' || isNaN(value)) return '-';\r\n    return new Intl.NumberFormat('vi-VN').format(value);\r\n};\r\n\r\nexport type ReconciliationItem = Packaging & {\r\n    orderSystemId: string;\r\n    orderId: string;\r\n    customerName: string;\r\n};\r\n\r\nexport function ReconciliationPage() {\r\n    const { confirmCodReconciliation } = useOrderStore();\r\n    const { data: allOrders = [] } = useAllOrders();\r\n    const { employee: authEmployee } = useAuth();\r\n    const { isMobile } = useBreakpoint();\r\n    const currentEmployeeSystemId = authEmployee?.systemId ?? 'SYSTEM';\r\n    const [rowSelection, setRowSelection] = React.useState<Record<string, boolean>>({});\r\n    const [isConfirmOpen, setIsConfirmOpen] = React.useState(false);\r\n    const [exportDialogOpen, setExportDialogOpen] = React.useState(false);\r\n    const [globalFilter, setGlobalFilter] = React.useState('');\r\n    const [pagination, setPagination] = React.useState({ pageIndex: 0, pageSize: 20 });\r\n    const [sorting, setSorting] = React.useState<{ id: string, desc: boolean }>({ id: 'createdAt', desc: true });\r\n    \r\n    // Get initial column visibility from columns\r\n    const cols = React.useMemo(() => getColumns(), []);\r\n    const defaultVisibility = React.useMemo(() => {\r\n        const initial: Record<string, boolean> = {};\r\n        cols.forEach(c => { if (c.id) initial[c.id] = true; });\r\n        return initial;\r\n    }, [cols]);\r\n    \r\n    // Use hook for column visibility (database-backed)\r\n    const [columnVisibility, setColumnVisibility] = useColumnVisibility('reconciliation', defaultVisibility);\r\n    \r\n    const [columnOrder, setColumnOrder] = React.useState<string[]>([]);\r\n    const [pinnedColumns, setPinnedColumns] = React.useState<string[]>([]);\r\n\r\n\r\n    const reconciliationList = React.useMemo<ReconciliationItem[]>(() => {\r\n        const items: ReconciliationItem[] = [];\r\n        allOrders.forEach(order => {\r\n            order.packagings.forEach(pkg => {\r\n                if (pkg.deliveryStatus === 'ƒê√£ giao h√†ng' && pkg.codAmount && pkg.codAmount > 0 && pkg.reconciliationStatus !== 'ƒê√£ ƒë·ªëi so√°t') {\r\n                    items.push({\r\n                        ...pkg,\r\n                        orderSystemId: order.systemId,\r\n                        orderId: order.id,\r\n                        customerName: order.customerName,\r\n                    });\r\n                }\r\n            });\r\n        });\r\n        return items;\r\n    }, [allOrders]);\r\n\r\n    const fuse = React.useMemo(() => new Fuse(reconciliationList, { \r\n        keys: ['trackingCode', 'orderId', 'customerName', 'carrier'],\r\n        threshold: 0.4 \r\n    }), [reconciliationList]);\r\n\r\n    const filteredData = React.useMemo(() => {\r\n        if (globalFilter) {\r\n            return fuse.search(globalFilter).map(result => result.item);\r\n        }\r\n        return reconciliationList;\r\n    }, [reconciliationList, globalFilter, fuse]);\r\n\r\n    const sortedData = React.useMemo(() => {\r\n        return [...filteredData].sort((a, b) => {\r\n            const aVal = (a as any)[sorting.id];\r\n            const bVal = (b as any)[sorting.id];\r\n            if (!aVal) return 1;\r\n            if (!bVal) return -1;\r\n            if (aVal < bVal) return sorting.desc ? 1 : -1;\r\n            if (aVal > bVal) return sorting.desc ? -1 : 1;\r\n            return 0;\r\n        });\r\n    }, [filteredData, sorting]);\r\n\r\n    const pageCount = Math.ceil(sortedData.length / pagination.pageSize);\r\n    const paginatedData = sortedData.slice(pagination.pageIndex * pagination.pageSize, (pagination.pageIndex + 1) * pagination.pageSize);\r\n\r\n    const allSelectedRows = React.useMemo(() =>\r\n        reconciliationList.filter(item => rowSelection[item.systemId]),\r\n    [reconciliationList, rowSelection]);\r\n\r\n    const handleConfirm = () => {\r\n        const selectedItems = reconciliationList.filter(item => rowSelection[item.systemId]);\r\n        if (selectedItems.length > 0) {\r\n            confirmCodReconciliation(selectedItems, currentEmployeeSystemId);\r\n            setRowSelection({});\r\n        }\r\n        setIsConfirmOpen(false);\r\n    };\r\n    \r\n    // Page header configuration\r\n    const pendingCount = reconciliationList.length;\r\n    const pendingCodTotal = React.useMemo(() =>\r\n        reconciliationList.reduce((total, item) => total + (item.codAmount ?? 0), 0),\r\n    [reconciliationList]);\r\n    const selectedCount = React.useMemo(() => Object.keys(rowSelection).length, [rowSelection]);\r\n\r\n    usePageHeader(React.useMemo(() => ({\r\n        title: 'ƒê·ªëi so√°t COD',\r\n        breadcrumb: [\r\n            { label: 'Trang ch·ªß', href: ROUTES.ROOT },\r\n            { label: 'ƒê·ªëi so√°t COD', href: ROUTES.INTERNAL.RECONCILIATION, isCurrent: true }\r\n        ],\r\n        showBackButton: false,\r\n        actions: [\r\n            <Button \r\n                key=\"confirm\"\r\n                size=\"sm\"\r\n                className=\"h-9 px-4\"\r\n                onClick={() => setIsConfirmOpen(true)}\r\n                disabled={selectedCount === 0}\r\n            >\r\n                <CheckCircle2 className=\"mr-2 h-4 w-4\" />\r\n                X√°c nh·∫≠n ƒë√£ nh·∫≠n ti·ªÅn ({selectedCount})\r\n            </Button>\r\n        ]\r\n    }), [pendingCount, pendingCodTotal, selectedCount]));\r\n    \r\n    const columns = React.useMemo(() => getColumns(), []);\r\n    \r\n    React.useEffect(() => {\r\n        const initialVisibility: Record<string, boolean> = {};\r\n        columns.forEach(c => {\r\n            if (c.id) {\r\n                initialVisibility[c.id] = true;\r\n            }\r\n        });\r\n        setColumnVisibility(initialVisibility);\r\n        setColumnOrder(columns.map(c => c.id).filter(Boolean) as string[]);\r\n        setPinnedColumns(['select']);\r\n    }, [columns]);\r\n\r\n\r\n    return (\r\n        <div className=\"h-full flex flex-col space-y-4\">\r\n            {/* PageToolbar - Desktop only */}\r\n            {!isMobile && (\r\n                <PageToolbar\r\n                    leftActions={\r\n                        <Button variant=\"outline\" size=\"sm\" onClick={() => setExportDialogOpen(true)}>\r\n                            <Download className=\"h-4 w-4 mr-2\" />\r\n                            Xu·∫•t Excel\r\n                        </Button>\r\n                    }\r\n                    rightActions={\r\n                        <DataTableColumnCustomizer\r\n                            columns={columns}\r\n                            columnVisibility={columnVisibility}\r\n                            setColumnVisibility={setColumnVisibility}\r\n                            columnOrder={columnOrder}\r\n                            setColumnOrder={setColumnOrder}\r\n                            pinnedColumns={pinnedColumns}\r\n                            setPinnedColumns={setPinnedColumns}\r\n                        />\r\n                    }\r\n                />\r\n            )}\r\n\r\n            {/* PageFilters */}\r\n            <PageFilters\r\n                searchValue={globalFilter}\r\n                onSearchChange={setGlobalFilter}\r\n                searchPlaceholder=\"T√¨m m√£ v·∫≠n ƒë∆°n, m√£ ƒë∆°n h√†ng...\"\r\n            />\r\n\r\n            <ResponsiveDataTable<ReconciliationItem>\r\n                className=\"flex-grow\"\r\n                columns={columns}\r\n                data={paginatedData}\r\n                rowCount={filteredData.length}\r\n                pageCount={pageCount}\r\n                pagination={pagination}\r\n                setPagination={setPagination}\r\n                sorting={sorting}\r\n                setSorting={setSorting}\r\n                rowSelection={rowSelection}\r\n                setRowSelection={setRowSelection}\r\n                allSelectedRows={allSelectedRows}\r\n                columnVisibility={columnVisibility}\r\n                setColumnVisibility={setColumnVisibility}\r\n                columnOrder={columnOrder}\r\n                setColumnOrder={setColumnOrder}\r\n                pinnedColumns={pinnedColumns}\r\n                setPinnedColumns={setPinnedColumns}\r\n                expanded={{}}\r\n                setExpanded={() => {}}\r\n                renderMobileCard={(item) => (\r\n                    <Card>\r\n                        <CardContent className=\"p-4 space-y-3\">\r\n                            <div className=\"flex justify-between items-start\">\r\n                                <div className=\"space-y-1\">\r\n                                    <CardTitle className=\"text-sm font-semibold\">{item.orderId}</CardTitle>\r\n                                    <div className=\"text-sm text-muted-foreground\">{item.customerName}</div>\r\n                                </div>\r\n                                <Badge variant=\"secondary\">{item.reconciliationStatus || 'Ch∆∞a ƒë·ªëi so√°t'}</Badge>\r\n                            </div>\r\n                            <div className=\"grid grid-cols-2 gap-2 text-sm\">\r\n                                <div>\r\n                                    <div className=\"text-muted-foreground\">M√£ v·∫≠n ƒë∆°n</div>\r\n                                    <div className=\"font-mono\">{item.trackingCode || '-'}</div>\r\n                                </div>\r\n                                <div>\r\n                                    <div className=\"text-muted-foreground\">ƒê·ªëi t√°c</div>\r\n                                    <div>{item.carrier || '-'}</div>\r\n                                </div>\r\n                                <div>\r\n                                    <div className=\"text-muted-foreground\">Ng√†y giao</div>\r\n                                    <div>{formatDate(item.deliveredDate)}</div>\r\n                                </div>\r\n                                <div>\r\n                                    <div className=\"text-muted-foreground\">Ti·ªÅn COD</div>\r\n                                    <div className=\"font-semibold\">{formatCurrency(item.codAmount)}</div>\r\n                                </div>\r\n                            </div>\r\n                        </CardContent>\r\n                    </Card>\r\n                )}\r\n            />\r\n             <AlertDialog open={isConfirmOpen} onOpenChange={setIsConfirmOpen}>\r\n                <AlertDialogContent>\r\n                    <AlertDialogHeader>\r\n                        <AlertDialogTitle>X√°c nh·∫≠n ƒë·ªëi so√°t?</AlertDialogTitle>\r\n                        <AlertDialogDescription>\r\n                            H√†nh ƒë·ªông n√†y s·∫Ω t·ª± ƒë·ªông t·∫°o phi·∫øu thu cho {allSelectedRows.length} v·∫≠n ƒë∆°n ƒë√£ ch·ªçn v√† ƒë√°nh d·∫•u ch√∫ng l√† \"ƒê√£ ƒë·ªëi so√°t\". B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ti·∫øp t·ª•c?\r\n                        </AlertDialogDescription>\r\n                    </AlertDialogHeader>\r\n                    <AlertDialogFooter>\r\n                        <AlertDialogCancel>H·ªßy</AlertDialogCancel>\r\n                        <AlertDialogAction onClick={handleConfirm}>X√°c nh·∫≠n</AlertDialogAction>\r\n                    </AlertDialogFooter>\r\n                </AlertDialogContent>\r\n            </AlertDialog>\r\n\r\n            {/* Export Dialog */}\r\n            <GenericExportDialogV2<ReconciliationItem>\r\n                open={exportDialogOpen}\r\n                onOpenChange={setExportDialogOpen}\r\n                config={reconciliationConfig}\r\n                allData={reconciliationList}\r\n                filteredData={filteredData}\r\n                currentPageData={paginatedData}\r\n                selectedData={allSelectedRows}\r\n                currentUser={{\r\n                    name: authEmployee?.fullName || 'H·ªá th·ªëng',\r\n                    systemId: authEmployee?.systemId || asSystemId('SYSTEM'),\r\n                }}\r\n            />\r\n        </div>\r\n    );\r\n}\r\n"],"names":[],"mappings":"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"}}]
}