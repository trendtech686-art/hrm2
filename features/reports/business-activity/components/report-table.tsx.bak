/**
 * Report Table Component
 * 
 * Bảng dữ liệu báo cáo với hàng tổng cộng và responsive
 */

import * as React from 'react';
import { ResponsiveDataTable } from '@/components/data-table/responsive-data-table.tsx';
import { Button } from '@/components/ui/button.tsx';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card.tsx';
import type { ColumnDef } from '@/components/data-table/types.ts';
import { Filter, Settings } from 'lucide-react';
import { cn } from '@/lib/utils.ts';

interface ReportTableProps<T> {
  data: T[];
  columns: ColumnDef<T>[];
  summary?: T; // Hàng tổng cộng
  title?: string;
  totalLabel?: string;
  
  // Pagination
  pagination: { pageIndex: number; pageSize: number };
  setPagination: (pagination: { pageIndex: number; pageSize: number }) => void;
  pageCount: number;
  totalRows: number;
  
  // Sorting
  sorting: { id: string; desc: boolean };
  setSorting: (sorting: { id: string; desc: boolean }) => void;
  
  // Column customization
  columnVisibility?: Record<string, boolean>;
  setColumnVisibility?: (visibility: Record<string, boolean>) => void;
  columnOrder?: string[];
  setColumnOrder?: (order: string[]) => void;
  pinnedColumns?: string[];
  setPinnedColumns?: (pinned: string[]) => void;
  
  // Mobile
  renderMobileCard?: (row: T) => React.ReactNode;
  
  // Actions
  showFilter?: boolean;
  onFilterClick?: () => void;
  filterLabel?: string;
}

// Format utilities
export const formatCurrency = (value?: number) => {
  if (typeof value !== 'number' || Number.isNaN(value)) return '0';
  return new Intl.NumberFormat('vi-VN').format(value);
};

export const formatPercent = (value?: number) => {
  if (typeof value !== 'number' || Number.isNaN(value)) return '0%';
  return `${value.toFixed(1)}%`;
};

export const formatNumber = (value?: number) => {
  if (typeof value !== 'number' || Number.isNaN(value)) return '0';
  return new Intl.NumberFormat('vi-VN').format(value);
};

export function ReportTable<T extends { systemId?: string }>({
  data,
  columns,
  summary,
  title,
  totalLabel = 'Tổng',
  pagination,
  setPagination,
  pageCount,
  totalRows,
  sorting,
  setSorting,
  columnVisibility,
  setColumnVisibility,
  columnOrder,
  setColumnOrder,
  pinnedColumns,
  setPinnedColumns,
  renderMobileCard,
  showFilter = true,
  onFilterClick,
  filterLabel,
}: ReportTableProps<T>) {
  
  // Combine summary row with data if exists
  const tableData = React.useMemo(() => {
    if (!summary) return data;
    
    // Add summary row at the beginning with special marker
    const summaryRow = { ...summary, _isSummary: true, systemId: '__summary__' } as T & { _isSummary: boolean };
    return [summaryRow, ...data];
  }, [data, summary]);
  
  // Custom row class for summary row
  const getRowClassName = (row: T & { _isSummary?: boolean }) => {
    if (row._isSummary) {
      return 'bg-muted/50 font-medium border-b-2';
    }
    return '';
  };
  
  // Modify columns to handle summary row
  const enhancedColumns = React.useMemo(() => {
    return columns.map((col, index) => ({
      ...col,
      cell: (props: { row: T & { _isSummary?: boolean } }) => {
        const row = props.row;
        
        // First column of summary row shows "Tổng"
        if (row._isSummary && index === 0) {
          return <span className="font-semibold">{totalLabel}</span>;
        }
        
        // Use original cell renderer
        if (typeof col.cell === 'function') {
          return col.cell(props);
        }
        
        return null;
      },
    }));
  }, [columns, totalLabel]);
  
  return (
    <Card>
      {(title || showFilter) && (
        <CardHeader className="py-3 px-4">
          <div className="flex items-center justify-between">
            {title && <CardTitle className="text-base">{title}</CardTitle>}
            
            {showFilter && onFilterClick && (
              <Button variant="outline" size="sm" onClick={onFilterClick}>
                <Filter className="h-4 w-4 mr-2" />
                {filterLabel || `Lọc kết quả (${totalRows})`}
              </Button>
            )}
          </div>
        </CardHeader>
      )}
      
      <CardContent className="p-0">
        <ResponsiveDataTable
          columns={enhancedColumns as ColumnDef<T>[]}
          data={tableData}
          rowCount={totalRows + (summary ? 1 : 0)}
          pageCount={pageCount}
          pagination={pagination}
          setPagination={setPagination}
          sorting={sorting}
          setSorting={setSorting}
          columnVisibility={columnVisibility || {}}
          setColumnVisibility={setColumnVisibility || (() => {})}
          columnOrder={columnOrder || []}
          setColumnOrder={setColumnOrder || (() => {})}
          pinnedColumns={pinnedColumns || []}
          setPinnedColumns={setPinnedColumns || (() => {})}
          renderMobileCard={renderMobileCard}
          getRowId={(row) => (row as T & { _isSummary?: boolean })._isSummary ? '__summary__' : (row.systemId || String(Math.random()))}
          rowClassName={getRowClassName as (row: T) => string}
        />
      </CardContent>
    </Card>
  );
}

export default ReportTable;
