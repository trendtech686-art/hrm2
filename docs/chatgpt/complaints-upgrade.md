# RÃ  soÃ¡t module Complaints (29/11/2025)

## 1. Kiáº¿n trÃºc & hiá»‡n tráº¡ng
- **Zustand store Ä‘Æ¡n lá»›p**: `features/complaints/store.ts` lÆ°u toÃ n bá»™ complaint, timeline, reminder flags trong `localStorage` (`persist` key `complaint-storage`). Má»i thao tÃ¡c (assign, verify, resolve, cancel, lá»c, thá»‘ng kÃª) diá»…n ra ngay trÃªn trÃ¬nh duyá»‡t vÃ  thao tÃºng trá»±c tiáº¿p state cá»§a cÃ¡c store khÃ¡c (products, payments, receipts, inventory-checks) thÃ´ng qua cÃ¡c helper import Ä‘á»™ng.
- **Trang danh sÃ¡ch náº·ng 1.2k dÃ²ng**: `features/complaints/page.tsx` gá»™p cáº£ Kanban + báº£ng, filter Ä‘a tráº¡ng thÃ¡i, virtual scroll, cáº¥u hÃ¬nh mÃ u, sync realtime (giáº£ láº­p) vÃ  mobile infinite scroll ngay trong component. Logic UI/state/phÃ¢n quyá»n chá»“ng chÃ©o khiáº¿n viá»‡c tÃ¡ch nhá» hay tÃ¡i sá»­ dá»¥ng gáº§n nhÆ° báº¥t kháº£ thi.
- **Trang chi tiáº¿t 1k dÃ²ng**: `features/complaints/detail-page.tsx` táº£i má»i store phá»¥ thuá»™c (`orders`, `employees`, `payments`, `products`, `cashbook`, â€¦), quáº£n lÃ½ 6 dialog (verification, compensation, inventory, template, confirm, image preview), Ä‘á»“ng thá»i nhÃºng tháº³ng cÃ¡c handler (cancel/reopen/verify) gá»i tá»›i store khÃ¡c mÃ  khÃ´ng cÃ³ service layer.
- **Flow bÃ¹ trá»« & inventory**: `features/complaints/compensation-payment-receipt-wizard.tsx` vÃ  `hooks/use-compensation-handlers.ts` vá»«a táº¡o phiáº¿u chi/thu (`usePaymentStore`, `useReceiptStore`), vá»«a cáº­p nháº­t cÃ¡c metadata vÃ o timeline Ä‘á»ƒ vá» sau hÃ m cancel (`handlers/*.ts`) tra ngÆ°á»£c ra vÃ  â€œhá»§y phiáº¿uâ€ báº±ng cÃ¡ch Ä‘á»•i status táº¡i client.
- **Public tracking + thÃ´ng bÃ¡o**: `features/complaints/public-tracking-page.tsx` cho phÃ©p khÃ¡ch truy cáº­p báº±ng `publicTrackingCode`, Ä‘á»c order/cashbook data tá»« cÃ¡c store cá»¥c bá»™ vÃ  thÃªm comment vÃ o timeline mÃ  khÃ´ng cÃ³ xÃ¡c thá»±c nÃ o. SLA (`sla-utils.ts`), notification (`notification-utils.ts`), reminder (`hooks/use-complaint-reminders.ts`), realtime polling (`use-realtime-updates.ts`) Ä‘á»u chá»‰ lÃ  cáº¥u hÃ¬nh `localStorage` + `setInterval`, khÃ´ng cÃ³ backend/webhook.

## 2. Äá»‘i chiáº¿u checklist
| Háº¡ng má»¥c | Tráº¡ng thÃ¡i | Nháº­n xÃ©t |
| --- | --- | --- |
| Types & Validation | âš ï¸ Má»™t pháº§n | `features/complaints/types.ts` Ä‘á»‹nh nghÄ©a Ä‘áº§y Ä‘á»§ type, inventory metadata, nhÆ°ng khÃ´ng cÃ³ schema Zod/Prisma dÃ¹ng chung, form chá»‰ kiá»ƒm tra thá»§ cÃ´ng trÆ°á»›c khi mutate store. |
| UI/UX | âš ï¸ Má»™t pháº§n | Kanban + báº£ng responsive, cÃ³ mÃ u SLA, public portal Ä‘áº¹p; tuy nhiÃªn file quÃ¡ dÃ i, thiáº¿u loading/error boundary thá»±c, public page dÃ¹ng chung store nÃªn refresh máº¥t dá»¯ liá»‡u. |
| Performance | âš ï¸ Má»™t pháº§n | CÃ³ virtual scroll nhÆ°ng má»i filter/search dÃ¹ng Fuse trÃªn toÃ n bá»™ dataset phÃ­a client; detail page import toÃ n bá»™ stores khiáº¿n bundle phÃ¬nh lá»›n, reminder cháº¡y `setInterval` má»—i phÃºt trÃªn má»i tab. |
| Database Ready | âŒ | KhÃ´ng cÃ³ báº£ng `Complaint`, `ComplaintTimeline`, `ComplaintProduct`, `ComplaintCompensation`, `ComplaintTracking`â€¦ Inventory/cashbook chá»‰ lÃ  reference ID lÆ°u trong timeline metadata. |
| API Ready | âŒ | KhÃ´ng cÃ³ route `/api/complaints`. Public tracking sá»­ dá»¥ng `window.location`, comment gá»­i tháº³ng vÃ o store. Realtime chá»‰ tÄƒng sá»‘ `complaints-version` trong `localStorage`. |
| LiÃªn káº¿t module | âš ï¸ Thiáº¿u | LiÃªn káº¿t Orders/Products/Cashbook/Inventory chá»‰ tá»“n táº¡i báº±ng cÃ¡ch import trá»±c tiáº¿p cÃ¡c store client (vÃ­ dá»¥ `compensation-payment-receipt-wizard.tsx`, `utils/payment-receipt-reversal.ts`). KhÃ´ng cÃ³ há»£p Ä‘á»“ng dá»¯ liá»‡u hay transaction phÃ­a server. |

## 3. Logic & liÃªn káº¿t Ä‘Ã¡ng chÃº Ã½
1. **BÃ¹ trá»« tÃ i chÃ­nh/pháº¡t nhÃ¢n viÃªn** (`compensation-payment-receipt-wizard.tsx`, `hooks/use-compensation-handlers.ts`): FE tá»± táº¡o phiáº¿u chi/thu, chá»n tÃ i khoáº£n quá»¹, phÆ°Æ¡ng thá»©c thanh toÃ¡n, rá»“i chÃ¨n ID phiáº¿u vÃ o metadata cá»§a action `verified-correct`. KhÃ´ng cÃ³ API hay cÆ¡ cháº¿ rollback transaction, nÃªn refresh trang lÃ  máº¥t toÃ n bá»™ chá»©ng tá»«.
2. **Äiá»u chá»‰nh tá»“n kho & hoÃ n tÃ¡c** (`handlers/cancel-handler.ts`, `utils/payment-receipt-reversal.ts`): Khi cancel hoáº·c reopen, FE lazy-load `useInventoryCheckStore`, `useProductStore`, `usePaymentStore`, `useReceiptStore` Ä‘á»ƒ Ä‘á»•i status thÃ nh `cancelled`. Viá»‡c dá»±a vÃ o metadata trong timeline Ä‘á»ƒ tÃ¬m phiáº¿u dá»… vá»¡ náº¿u user sá»­a timeline hoáº·c cÃ³ nhiá»u láº§n xÃ¡c minh.
3. **Public tracking & bÃ¬nh luáº­n khÃ¡ch** (`public-tracking-page.tsx`, `hooks/use-public-tracking.ts`): KhÃ¡ch chá»‰ cáº§n biáº¿t `publicTrackingCode` lÃ  cÃ³ thá»ƒ Ä‘á»c má»i thÃ´ng tin Ä‘Æ¡n hÃ ng, bÃ¹ trá»«, vÃ  thÃªm comment vÃ o timeline thÃ´ng qua `updateComplaint`. KhÃ´ng cÃ³ rate limit, captcha hay xÃ¡c thá»±c OTP.
4. **SLA/Reminder** (`sla-utils.ts`, `hooks/use-complaint-reminders.ts`, `notification-utils.ts`): ToÃ n bá»™ SLA target, reminder interval, notification setting lÆ°u trong `localStorage` cÃ¡ nhÃ¢n. Má»—i tab trÃ¬nh duyá»‡t cháº¡y `setInterval` 60 giÃ¢y Ä‘á»ƒ nháº¯c nhá»Ÿ â†’ vá»«a tá»‘n tÃ i nguyÃªn, vá»«a khÃ´ng thá»‘ng nháº¥t giá»¯a ngÆ°á»i dÃ¹ng.

## 4. Rá»§i ro & issue chÃ­nh
| Má»©c Ä‘á»™ | MÃ´ táº£ | Báº±ng chá»©ng |
| --- | --- | --- |
| ğŸ”´ Cao | Complaint data, timeline, compensation, inventory adjustments Ä‘á»u lÃ  state `Zustand` trÃªn trÃ¬nh duyá»‡t; khÃ´ng backend, khÃ´ng backup â‡’ refresh lÃ  máº¥t, Ä‘a ngÆ°á»i dÃ¹ng khÃ´ng Ä‘á»“ng bá»™. | `features/complaints/store.ts`, `features/complaints/detail-page.tsx` |
| ğŸ”´ Cao | FE tá»± táº¡o/huá»· phiáº¿u chi, phiáº¿u thu, phiáº¿u kiá»ƒm kÃª báº±ng cÃ¡ch trá»±c tiáº¿p gá»i `usePaymentStore`, `useReceiptStore`, `useInventoryCheckStore`. KhÃ´ng cÃ³ transaction hoáº·c quyá»n háº¡n â‡’ ngÆ°á»i dÃ¹ng cÃ³ thá»ƒ thao tÃºng tÃ i chÃ­nh/kho. | `features/complaints/compensation-payment-receipt-wizard.tsx`, `features/complaints/utils/payment-receipt-reversal.ts` |
| ğŸ”´ Cao | Public tracking khÃ´ng cÃ³ backend, khÃ¡ch cÃ³ thá»ƒ sá»­a timeline (comment) vÃ  Ä‘á»c dá»¯ liá»‡u ná»™i bá»™ náº¿u Ä‘oÃ¡n Ä‘Æ°á»£c `publicTrackingCode`. | `features/complaints/public-tracking-page.tsx`, `hooks/use-public-tracking.ts` |
| ğŸŸ  Trung bÃ¬nh | SLA, reminder, notification setting lÆ°u á»Ÿ `localStorage`; viá»‡c cáº£nh bÃ¡o quÃ¡ háº¡n hay gá»­i email/sms chá»‰ lÃ  `toast` FE nÃªn khÃ´ng Ä‘Ã¡p á»©ng SLA tháº­t. | `features/complaints/sla-utils.ts`, `hooks/use-complaint-reminders.ts`, `notification-utils.ts` |
| ğŸŸ  Trung bÃ¬nh | Timeline metadata lÃ  nÆ¡i duy nháº¥t giá»¯ ID phiáº¿u thu/chi/inventory; náº¿u ngÆ°á»i dÃ¹ng sá»­a timeline hoáº·c cÃ³ nhiá»u láº§n xÃ¡c minh, hÃ m cancel khÃ´ng cÃ²n tÃ¬m Ä‘Æ°á»£c chá»©ng tá»« Ä‘á»ƒ hoÃ n tÃ¡c. | `hooks/use-compensation-handlers.ts`, `utils/payment-receipt-reversal.ts` |
| ğŸŸ¡ Tháº¥p | Test hiá»‡n cÃ³ chá»‰ lÃ  guard kiá»ƒm tra method/label; khÃ´ng cÃ³ unit test cho workflow, wizard, reminder, public tracking. | `features/complaints/__tests__/complaint-store-guards.test.ts` |

## 5. Äá» xuáº¥t nÃ¢ng cáº¥p
1. **Thiáº¿t káº¿ domain & Prisma**: Táº¡o báº£ng `Complaints`, `ComplaintTimeline`, `ComplaintProductImpact`, `ComplaintInventoryAdjustment`, `ComplaintCompensation`, `ComplaintPublicTracking`. Chuáº©n hÃ³a dual ID + indexes theo `orderSystemId`, `customerSystemId`, `publicTrackingCode`.
2. **Service/API layer**: XÃ¢y Route Handler `/api/complaints` (list/filter/pagination/search/export) vÃ  sub-route `/api/complaints/{id}/timeline`, `/compensation`, `/inventory-adjustment`, `/tracking`. Táº¥t cáº£ thao tÃ¡c assign/verify/resolve pháº£i Ä‘i qua service cÃ³ transaction (PostgreSQL + Prisma) vÃ  emit event Ä‘á»ƒ Cashbook/Warehouse xá»­ lÃ½.
3. **State machine & timeline**: Chuáº©n hÃ³a state diagram (pending â†’ investigating â†’ verified â†’ resolved â†’ ended/cancelled) vá»›i guard rÃµ rÃ ng. Timeline lÆ°u á»Ÿ DB, metadata cÃ³ schema (JSONB) vÃ  version. Viáº¿t migrator Ä‘á»c dá»¯ liá»‡u local cÅ© Ä‘á»ƒ import vÃ o DB (náº¿u cáº§n).
4. **Finance & inventory integration**: TÃ¡ch `CompensationService` vÃ  `InventoryAdjustmentService` á»Ÿ backend. Khi xÃ¡c minh Ä‘Ãºng, service táº¡o phiáº¿u chi/thu qua API Cashbook, ghi `stock_ledger` hoáº·c táº¡o `inventory_check` thá»±c sá»±, tráº£ vá» ID cho timeline (khÃ´ng Ä‘á»ƒ FE tá»± táº¡o). Cancel/Reopen gá»i API Ä‘á»ƒ rollback.
5. **Public portal & notification**: Dá»±ng endpoint `GET /public/complaints/:trackingCode` tráº£ dá»¯ liá»‡u Ä‘Ã£ áº©n nháº¡y cáº£m, comment pháº£i qua OTP/email + rate limit. SLA/reminder cháº¡y báº±ng job worker (BullMQ/Temporal) + gá»­i thÃ´ng bÃ¡o tháº­t qua Notification Center.
6. **Quan sÃ¡t & test**: Viáº¿t unit test cho service (compensation, cancellation, tracking) vÃ  component test cho Kanban/table view. Bá»• sung audit log + metric (thá»i gian pháº£n há»“i, sá»‘ vá»¥ overdue) Ä‘á»ƒ Dashboard tiÃªu thá»¥.

## 6. Viá»‡c cáº§n lÃ m ngay
- NgÆ°ng nháº­p liá»‡u tháº­t trÃªn module Complaints; backup state `localStorage` (`complaint-storage`) Ä‘á»ƒ tham kháº£o khi viáº¿t migration.
- Soáº¡n Ä‘áº·c táº£ Prisma + API contract cho Complaints, bao gá»“m payload cho compensation/inventory/notification/public tracking, rá»“i sync vá»›i nhÃ³m Orders, Inventory, Cashbook Ä‘á»ƒ chá»‘t event bus.
- LÃªn káº¿ hoáº¡ch refactor FE: tÃ¡ch Kanban/table thÃ nh component nhá», chuyá»ƒn dá»¯ liá»‡u sang React Query gá»i API, giá»¯ `useComplaintStore` chá»‰ cho UI state (filters, selections).
- Æ¯u tiÃªn thiáº¿t káº¿ Public Tracking service (OTP + rate limit) vÃ  Notification worker Ä‘á»ƒ ká»‹p Ä‘Ã¡p á»©ng SLA customer service Ä‘Ã£ cam káº¿t (#12 trong báº£ng Æ°u tiÃªn).
